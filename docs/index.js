let e=class{constructor(e,t,i){this.owner=e,this.name=t,this.fn=i}unbind(){this.owner&&(this.owner.unbind(this.name,this.fn),this.owner=null,this.name=null,this.fn=null)}call(e,...t){this.fn&&this.fn.call(this.owner,arguments[0],arguments[1],arguments[2],arguments[3],arguments[4],arguments[5],arguments[6],arguments[7])}on(e,t){return this.owner.on(e,t)}};class t{constructor(){this._suspendEvents=!1,this._additionalEmitters=[],this._events={},Object.defineProperty(this,"_events",{enumerable:!1,configurable:!1,writable:!0,value:{}})}set suspendEvents(e){this._suspendEvents=!!e}get suspendEvents(){return this._suspendEvents}on(t,i){const s=this._events[t];return void 0===s?this._events[t]=[i]:-1===s.indexOf(i)&&s.push(i),new e(this,t,i)}once(e,t){const i=this.on(e,((e,s,r,n,a,o,l,h)=>{t.call(this,e,s,r,n,a,o,l,h),i.unbind()}));return i}emit(e,t,i,s,r,n,a,o,l){if(this._suspendEvents)return this;let h=this._events[e];if(h&&h.length){h=h.slice(0);for(let c=0;c<h.length;c++)if(h[c])try{h[c].call(this,t,i,s,r,n,a,o,l)}catch(t){console.info("%c%s %c(event error)","color: #06f",e,"color: #f00"),console.log(t.stack)}}if(this._additionalEmitters.length){this._additionalEmitters.slice().forEach((h=>{h.emit(e,t,i,s,r,n,a,o,l)}))}return this}unbind(e,t){if(e){const i=this._events[e];if(!i)return this;if(t){const s=i.indexOf(t);-1!==s&&(1===i.length?delete this._events[e]:i.splice(s,1))}else delete this._events[e]}else this._events={};return this}addEmitter(e){this._additionalEmitters.includes(e)||this._additionalEmitters.push(e)}removeEmitter(e){const t=this._additionalEmitters.indexOf(e);-1!==t&&this._additionalEmitters.splice(t,1)}}const i=(e,t)=>{if(!e||!t)return!1;const s=e.length;if(s!==t.length)return!1;for(let r=0;r<s;r++)if(e[r]instanceof Array&&t[r]instanceof Array){if(!i(e[r],t[r]))return!1}else if(e[r]!==t[r])return!1;return!0};class s extends t{constructor(e,t={}){if(super(),this._destroyed=!1,this._path="",this._keys=[],this._data={},this._pathsWithDuplicates=null,this._parent=null,this._parentPath="",this._parentField=null,this._parentKey=null,this._latestFn=null,this._silent=!1,this._pathsWithDuplicates=null,t.pathsWithDuplicates){this._pathsWithDuplicates={};for(let e=0;e<t.pathsWithDuplicates.length;e++)this._pathsWithDuplicates[t.pathsWithDuplicates[e]]=!0}this.patch(e),this._parent=t.parent||null,this._parentPath=t.parentPath||"",this._parentField=t.parentField||null,this._parentKey=t.parentKey||null,this._latestFn=t.latestFn||null,this._silent=!1;const i=function(e){return function(t,i,s,r){if(!this._parent)return;let n,a=this._parentKey;!a&&this._parentField instanceof Array&&(a=this._parentField.indexOf(this),-1===a)||(t=`${this._parentPath}.${a}.${t}`,this._silent&&(n=this._parent.silence()),this._parent.emit(`${t}:${e}`,i,s,r),this._parent.emit(`*:${e}`,t,i,s,r),this._silent&&this._parent.silenceRestore(n))}};this.on("*:set",i("set")),this.on("*:unset",i("unset")),this.on("*:insert",i("insert")),this.on("*:remove",i("remove")),this.on("*:move",i("move"))}static _splitPath(e){const t=s._splitPathsCache;let i=t[e];return i?i=i.slice():(i=e.split("."),t[e]=i),i}silence(){this._silent=!0;const e=this.history&&this.history.enabled;e&&(this.history.enabled=!1);const t=this.sync&&this.sync.enabled;return t&&(this.sync.enabled=!1),[e,t]}silenceRestore(e){this._silent=!1,e[0]&&(this.history.enabled=!0),e[1]&&(this.sync.enabled=!0)}_prepare(e,t,i,r=!1,n=!1){let a,o;const l=(e._path?`${e._path}.`:"")+t,h=typeof i;if(e._keys.push(t),"object"===h&&i instanceof Array){for(e._data[t]=i.slice(0),a=0;a<e._data[t].length;a++)"object"==typeof e._data[t][a]&&null!==e._data[t][a]?e._data[t][a]instanceof Array?e._data[t][a].slice(0):e._data[t][a]=new s(e._data[t][a],{parent:this,parentPath:l,parentField:e._data[t],parentKey:null}):(o=this.silence(),this.emit(`${l}.${a}:set`,e._data[t][a],null,n),this.emit("*:set",`${l}.${a}`,e._data[t][a],null,n),this.silenceRestore(o));r&&(o=this.silence()),this.emit(`${l}:set`,e._data[t],null,n),this.emit("*:set",l,e._data[t],null,n),r&&this.silenceRestore(o)}else if("object"===h&&i instanceof Object){for(a in"object"!=typeof e._data[t]&&(e._data[t]={_path:l,_keys:[],_data:{}}),i)"object"==typeof i[a]?this._prepare(e._data[t],a,i[a],!0,n):(o=this.silence(),e._data[t]._data[a]=i[a],e._data[t]._keys.push(a),this.emit(`${l}.${a}:set`,i[a],null,n),this.emit("*:set",`${l}.${a}`,i[a],null,n),this.silenceRestore(o));r&&(o=this.silence()),this.emit(`${l}:set`,i,void 0,n),this.emit("*:set",l,i,void 0,n),r&&this.silenceRestore(o)}else r&&(o=this.silence()),e._data[t]=i,this.emit(`${l}:set`,i,void 0,n),this.emit("*:set",l,i,void 0,n),r&&this.silenceRestore(o);return!0}set(e,t,r=!1,n=!1,a=!1){let o,l,h=s._splitPath(e);const c=h.length,d=h[c-1];let u,f,p=this,m="",g=this;for(o=0;o<c-1;o++)p instanceof Array?(p=p[h[o]],p instanceof s&&(e=h.slice(o+1).join("."),g=p)):(o<c&&"object"!=typeof p._data[h[o]]&&(p._data[h[o]]&&g.unset((p._path?`${p._path}.`:"")+h[o]),p._data[h[o]]={_path:e,_keys:[],_data:{}},p._keys.push(h[o])),o===c-1&&p._path&&(m=`${p._path}.${h[o]}`),p=p._data[h[o]]);if(p instanceof Array){const i=parseInt(d,10);return!(p[i]===t&&!a)&&(l=p[i],l=l instanceof s?l.json():g.json(l),p[i]=t,t instanceof s&&(t._parent=g,t._parentPath=m,t._parentField=p,t._parentKey=null),r&&(u=g.silence()),g.emit(`${e}:set`,t,l,n),g.emit("*:set",e,t,l,n),r&&g.silenceRestore(u),!0)}if(p._data&&!p._data.hasOwnProperty(d))return"object"==typeof t?g._prepare(p,d,t,!1,n):(p._data[d]=t,p._keys.push(d),r&&(u=g.silence()),g.emit(`${e}:set`,t,null,n),g.emit("*:set",e,t,null,n),r&&g.silenceRestore(u),!0);if("object"==typeof t&&t instanceof Array){if(i(t,p._data[d])&&!a)return!1;if(l=p._data[d],l instanceof s||(l=g.json(l)),p._data[d]&&p._data[d].length===t.length){for(u=g.silence(),0===t.length&&(p._data[d]=t),o=0;o<p._data[d].length;o++)p._data[d][o]instanceof s?p._data[d][o].patch(t[o],!0):p._data[d][o]!==t[o]&&(p._data[d][o]=t[o],g.emit(`${e}.${o}:set`,p._data[d][o],l&&l[o]||null,n),g.emit("*:set",`${e}.${o}`,p._data[d][o],l&&l[o]||null,n));g.silenceRestore(u)}else{for(p._data[d]=[],t.forEach((e=>{this._doInsert(p,d,e,void 0,!0)})),u=g.silence(),o=0;o<p._data[d].length;o++)g.emit(`${e}.${o}:set`,p._data[d][o],l&&l[o]||null,n),g.emit("*:set",`${e}.${o}`,p._data[d][o],l&&l[o]||null,n);g.silenceRestore(u)}return r&&(u=g.silence()),g.emit(`${e}:set`,t,l,n),g.emit("*:set",e,t,l,n),r&&g.silenceRestore(u),!0}if("object"==typeof t&&t instanceof Object){let i,a=!1;l=p._data[d],l instanceof s||(l=g.json(l)),h=Object.keys(t),p._data[d]&&p._data[d]._data||(p._data[d]?g.unset((p._path?`${p._path}.`:"")+d):a=!0,p._data[d]={_path:e,_keys:[],_data:{}});for(const s in p._data[d]._data)t.hasOwnProperty(s)?p._data[d]._data.hasOwnProperty(s)?g._equals(p._data[d]._data[s],t[s])||(i=g.set(`${e}.${s}`,t[s],!0),i&&(a=!0)):(i=g._prepare(p._data[d],s,t[s],!0,n),i&&(a=!0)):(i=g.unset(`${e}.${s}`,!0),i&&(a=!0));for(o=0;o<h.length;o++)void 0===t[h[o]]&&p._data[d]._data.hasOwnProperty(h[o])?(i=g.unset(`${e}.${h[o]}`,!0),i&&(a=!0)):"object"==typeof t[h[o]]?p._data[d]._data.hasOwnProperty(h[o])?(i=g.set(`${e}.${h[o]}`,t[h[o]],!0),i&&(a=!0)):(i=g._prepare(p._data[d],h[o],t[h[o]],!0,n),i&&(a=!0)):g._equals(p._data[d]._data[h[o]],t[h[o]])||("object"==typeof t[h[o]]?(i=g.set(`${p._data[d]._path}.${h[o]}`,t[h[o]],!0),i&&(a=!0)):p._data[d]._data[h[o]]!==t[h[o]]&&(a=!0,-1===p._data[d]._keys.indexOf(h[o])&&p._data[d]._keys.push(h[o]),p._data[d]._data[h[o]]=t[h[o]],u=g.silence(),g.emit(`${p._data[d]._path}.${h[o]}:set`,p._data[d]._data[h[o]],null,n),g.emit("*:set",`${p._data[d]._path}.${h[o]}`,p._data[d]._data[h[o]],null,n),g.silenceRestore(u)));if(a){r&&(u=g.silence());const e=g.json(p._data[d]);return g.emit(`${p._data[d]._path}:set`,e,l,n),g.emit("*:set",p._data[d]._path,e,l,n),r&&g.silenceRestore(u),!0}return!1}return f=!p.hasOwnProperty("_data")&&p.hasOwnProperty(d)?p:p._data,!(f[d]===t&&!a)&&(r&&(u=g.silence()),l=f[d],l instanceof s||(l=g.json(l)),f[d]=t,g.emit(`${e}:set`,t,l,n),g.emit("*:set",e,t,l,n),r&&g.silenceRestore(u),!0)}has(e){const t=s._splitPath(e);let i=this;for(let e=0,s=t.length;e<s;e++){if(null==i)return;i=i._data?i._data[t[e]]:i[t[e]]}return void 0!==i}get(e,t=!1){const i=s._splitPath(e);let r=this;for(let e=0;e<i.length;e++){if(null==r)return;r=r._data?r._data[i[e]]:r[i[e]]}return t?r:null==r?null:this.json(r)}getRaw(e){return this.get(e,!0)}_equals(e,t){return e===t||!!(e instanceof Array&&t instanceof Array&&i(e,t))}unset(e,t=!1,i=!1){let r;const n=s._splitPath(e),a=n[n.length-1];let o=this,l=this;for(r=0;r<n.length-1;r++)o instanceof Array?(o=o[n[r]],o instanceof s&&(e=n.slice(r+1).join("."),l=o)):o=o._data[n[r]];if(!o._data||!o._data.hasOwnProperty(a))return!1;let h,c=o._data[a];if(c instanceof s||(c=l.json(c)),o._data[a]&&o._data[a]._data)for(r=o._data[a]._keys.length-1;r>=0;r--)l.unset(`${e}.${o._data[a]._keys[r]}`,!0);return o._keys.splice(o._keys.indexOf(a),1),delete o._data[a],t&&(h=l.silence()),l.emit(`${e}:unset`,c,i),l.emit("*:unset",e,c,i),t&&l.silenceRestore(h),!0}remove(e,t,i=!1,r=!1){const n=s._splitPath(e),a=n[n.length-1];let o=this,l=this;for(let t=0;t<n.length-1;t++)if(o instanceof Array)o=o[parseInt(n[t],10)],o instanceof s&&(e=n.slice(t+1).join("."),l=o);else{if(!o._data||!o._data.hasOwnProperty(n[t]))return!1;o=o._data[n[t]]}if(!(o._data&&o._data.hasOwnProperty(a)&&o._data[a]instanceof Array))return!1;const h=o._data[a];if(h.length<t)return!1;let c,d=h[t];return d instanceof s?d._parent=null:d=l.json(d),h.splice(t,1),i&&(c=l.silence()),l.emit(`${e}:remove`,d,t,r),l.emit("*:remove",e,d,t,r),i&&l.silenceRestore(c),!0}removeValue(e,t,i=!1,r=!1){const n=s._splitPath(e),a=n[n.length-1];let o=this,l=this;for(let t=0;t<n.length-1;t++)if(o instanceof Array)o=o[parseInt(n[t],10)],o instanceof s&&(e=n.slice(t+1).join("."),l=o);else{if(!o._data||!o._data.hasOwnProperty(n[t]))return;o=o._data[n[t]]}if(!(o._data&&o._data.hasOwnProperty(a)&&o._data[a]instanceof Array))return;const h=o._data[a],c=h.indexOf(t);if(-1===c)return;if(h.length<c)return;let d;return(t=h[c])instanceof s?t._parent=null:t=l.json(t),h.splice(c,1),i&&(d=l.silence()),l.emit(`${e}:remove`,t,c,r),l.emit("*:remove",e,t,c,r),i&&l.silenceRestore(d),!0}insert(e,t,i,r=!1,n=!1){const a=s._splitPath(e),o=a[a.length-1];let l=this,h=this;for(let t=0;t<a.length-1;t++)if(l instanceof Array)l=l[parseInt(a[t],10)],l instanceof s&&(e=a.slice(t+1).join("."),h=l);else{if(!l._data||!l._data.hasOwnProperty(a[t]))return;l=l._data[a[t]]}if(!(l._data&&l._data.hasOwnProperty(o)&&l._data[o]instanceof Array))return;const c=l._data[o];let d;return t=h._doInsert(l,o,t,i),void 0===i&&(i=c.length-1),r&&(d=h.silence()),h.emit(`${e}:insert`,t,i,n),h.emit("*:insert",e,t,i,n),r&&h.silenceRestore(d),!0}_doInsert(e,t,i,r,n=!1){const a=e._data[t];"object"!=typeof i||i instanceof s||null===i||(i=i instanceof Array?i.slice(0):new s(i));const o=e._path?`${e._path}.${t}`:t;if(null===i||n||this._pathsWithDuplicates&&this._pathsWithDuplicates[o]||-1===a.indexOf(i))return void 0===r?a.push(i):a.splice(r,0,i),i instanceof s?(i._parent=this,i._parentPath=o,i._parentField=a,i._parentKey=null):i=this.json(i),i}move(e,t,i,r=!1,n=!1){const a=s._splitPath(e),o=a[a.length-1];let l=this,h=this;for(let t=0;t<a.length-1;t++)if(l instanceof Array)l=l[parseInt(a[t],10)],l instanceof s&&(e=a.slice(t+1).join("."),h=l);else{if(!l._data||!l._data.hasOwnProperty(a[t]))return;l=l._data[a[t]]}if(!(l._data&&l._data.hasOwnProperty(o)&&l._data[o]instanceof Array))return;const c=l._data[o];if(c.length<t||c.length<i||t===i)return;let d,u=c[t];return c.splice(t,1),-1===i&&(i=c.length),c.splice(i,0,u),u instanceof s||(u=h.json(u)),r&&(d=h.silence()),h.emit(`${e}:move`,u,i,t,n),h.emit("*:move",e,u,i,t,n),r&&h.silenceRestore(d),!0}patch(e,t=!1){if("object"==typeof e){for(const t in e)"object"!=typeof e[t]||this._data.hasOwnProperty(t)?this._data[t]!==e[t]&&this.set(t,e[t]):this._prepare(this,t,e[t]);if(t)for(const t in this._data)e.hasOwnProperty(t)||this.unset(t)}}json(e){let t,i,s={};const r=void 0===e?this:e;let n,a;if(r instanceof Object&&r._keys){n=r._keys.length;for(let e=0;e<n;e++){t=r._keys[e];const n=r._data[t],o=typeof n;if("object"===o&&n instanceof Array)for(s[t]=n.slice(0),a=s[t].length,i=0;i<a;i++)"object"==typeof s[t][i]&&(s[t][i]=this.json(s[t][i]));else s[t]="object"===o&&n instanceof Object?this.json(n):n}}else{if(null===r)return null;if("object"==typeof r&&r instanceof Array)for(s=r.slice(0),n=s.length,i=0;i<n;i++)s[i]=this.json(s[i]);else if("object"==typeof r)for(t in r)r.hasOwnProperty(t)&&(s[t]=r[t]);else s=r}return s}forEach(e,t,i=""){const s=t||this;for(let t=0;t<s._keys.length;t++){const r=s._keys[t],n=s._data[r],a=this.schema&&this.schema.has(i+r)&&this.schema.get(i+r).type.name.toLowerCase()||typeof n;"object"===a&&n instanceof Array?e(i+r,"array",n,r):"object"===a&&n instanceof Object?(e(i+r,"object",n,r),this.forEach(e,n,`${i+r}.`)):e(i+r,a,n,r)}}latest(){return this._latestFn?this._latestFn():this}destroy(){this._destroyed||(this._destroyed=!0,this.emit("destroy"),this.unbind())}set latestFn(e){this._latestFn=e}get latestFn(){return this._latestFn}}function r(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}s._splitPathsCache={};var n,a,o={exports:{}},l={};function h(){if(n)return l;n=1;var e=Symbol.for("react.element"),t=Symbol.for("react.portal"),i=Symbol.for("react.fragment"),s=Symbol.for("react.strict_mode"),r=Symbol.for("react.profiler"),a=Symbol.for("react.provider"),o=Symbol.for("react.context"),h=Symbol.for("react.forward_ref"),c=Symbol.for("react.suspense"),d=Symbol.for("react.memo"),u=Symbol.for("react.lazy"),f=Symbol.iterator;var p={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},m=Object.assign,g={};function v(e,t,i){this.props=e,this.context=t,this.refs=g,this.updater=i||p}function _(){}function b(e,t,i){this.props=e,this.context=t,this.refs=g,this.updater=i||p}v.prototype.isReactComponent={},v.prototype.setState=function(e,t){if("object"!=typeof e&&"function"!=typeof e&&null!=e)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,e,t,"setState")},v.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")},_.prototype=v.prototype;var y=b.prototype=new _;y.constructor=b,m(y,v.prototype),y.isPureReactComponent=!0;var x=Array.isArray,S=Object.prototype.hasOwnProperty,w={current:null},T={key:!0,ref:!0,__self:!0,__source:!0};function C(t,i,s){var r,n={},a=null,o=null;if(null!=i)for(r in void 0!==i.ref&&(o=i.ref),void 0!==i.key&&(a=""+i.key),i)S.call(i,r)&&!T.hasOwnProperty(r)&&(n[r]=i[r]);var l=arguments.length-2;if(1===l)n.children=s;else if(1<l){for(var h=Array(l),c=0;c<l;c++)h[c]=arguments[c+2];n.children=h}if(t&&t.defaultProps)for(r in l=t.defaultProps)void 0===n[r]&&(n[r]=l[r]);return{$$typeof:e,type:t,key:a,ref:o,props:n,_owner:w.current}}function E(t){return"object"==typeof t&&null!==t&&t.$$typeof===e}var A=/\/+/g;function P(e,t){return"object"==typeof e&&null!==e&&null!=e.key?function(e){var t={"=":"=0",":":"=2"};return"$"+e.replace(/[=:]/g,(function(e){return t[e]}))}(""+e.key):t.toString(36)}function D(i,s,r,n,a){var o=typeof i;"undefined"!==o&&"boolean"!==o||(i=null);var l=!1;if(null===i)l=!0;else switch(o){case"string":case"number":l=!0;break;case"object":switch(i.$$typeof){case e:case t:l=!0}}if(l)return a=a(l=i),i=""===n?"."+P(l,0):n,x(a)?(r="",null!=i&&(r=i.replace(A,"$&/")+"/"),D(a,s,r,"",(function(e){return e}))):null!=a&&(E(a)&&(a=function(t,i){return{$$typeof:e,type:t.type,key:i,ref:t.ref,props:t.props,_owner:t._owner}}(a,r+(!a.key||l&&l.key===a.key?"":(""+a.key).replace(A,"$&/")+"/")+i)),s.push(a)),1;if(l=0,n=""===n?".":n+":",x(i))for(var h=0;h<i.length;h++){var c=n+P(o=i[h],h);l+=D(o,s,r,c,a)}else if(c=function(e){return null===e||"object"!=typeof e?null:"function"==typeof(e=f&&e[f]||e["@@iterator"])?e:null}(i),"function"==typeof c)for(i=c.call(i),h=0;!(o=i.next()).done;)l+=D(o=o.value,s,r,c=n+P(o,h++),a);else if("object"===o)throw s=String(i),Error("Objects are not valid as a React child (found: "+("[object Object]"===s?"object with keys {"+Object.keys(i).join(", ")+"}":s)+"). If you meant to render a collection of children, use an array instead.");return l}function L(e,t,i){if(null==e)return e;var s=[],r=0;return D(e,s,"","",(function(e){return t.call(i,e,r++)})),s}function M(e){if(-1===e._status){var t=e._result;(t=t()).then((function(t){0!==e._status&&-1!==e._status||(e._status=1,e._result=t)}),(function(t){0!==e._status&&-1!==e._status||(e._status=2,e._result=t)})),-1===e._status&&(e._status=0,e._result=t)}if(1===e._status)return e._result.default;throw e._result}var I={current:null},R={transition:null},k={ReactCurrentDispatcher:I,ReactCurrentBatchConfig:R,ReactCurrentOwner:w};function O(){throw Error("act(...) is not supported in production builds of React.")}return l.Children={map:L,forEach:function(e,t,i){L(e,(function(){t.apply(this,arguments)}),i)},count:function(e){var t=0;return L(e,(function(){t++})),t},toArray:function(e){return L(e,(function(e){return e}))||[]},only:function(e){if(!E(e))throw Error("React.Children.only expected to receive a single React element child.");return e}},l.Component=v,l.Fragment=i,l.Profiler=r,l.PureComponent=b,l.StrictMode=s,l.Suspense=c,l.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=k,l.act=O,l.cloneElement=function(t,i,s){if(null==t)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+t+".");var r=m({},t.props),n=t.key,a=t.ref,o=t._owner;if(null!=i){if(void 0!==i.ref&&(a=i.ref,o=w.current),void 0!==i.key&&(n=""+i.key),t.type&&t.type.defaultProps)var l=t.type.defaultProps;for(h in i)S.call(i,h)&&!T.hasOwnProperty(h)&&(r[h]=void 0===i[h]&&void 0!==l?l[h]:i[h])}var h=arguments.length-2;if(1===h)r.children=s;else if(1<h){l=Array(h);for(var c=0;c<h;c++)l[c]=arguments[c+2];r.children=l}return{$$typeof:e,type:t.type,key:n,ref:a,props:r,_owner:o}},l.createContext=function(e){return(e={$$typeof:o,_currentValue:e,_currentValue2:e,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null}).Provider={$$typeof:a,_context:e},e.Consumer=e},l.createElement=C,l.createFactory=function(e){var t=C.bind(null,e);return t.type=e,t},l.createRef=function(){return{current:null}},l.forwardRef=function(e){return{$$typeof:h,render:e}},l.isValidElement=E,l.lazy=function(e){return{$$typeof:u,_payload:{_status:-1,_result:e},_init:M}},l.memo=function(e,t){return{$$typeof:d,type:e,compare:void 0===t?null:t}},l.startTransition=function(e){var t=R.transition;R.transition={};try{e()}finally{R.transition=t}},l.unstable_act=O,l.useCallback=function(e,t){return I.current.useCallback(e,t)},l.useContext=function(e){return I.current.useContext(e)},l.useDebugValue=function(){},l.useDeferredValue=function(e){return I.current.useDeferredValue(e)},l.useEffect=function(e,t){return I.current.useEffect(e,t)},l.useId=function(){return I.current.useId()},l.useImperativeHandle=function(e,t,i){return I.current.useImperativeHandle(e,t,i)},l.useInsertionEffect=function(e,t){return I.current.useInsertionEffect(e,t)},l.useLayoutEffect=function(e,t){return I.current.useLayoutEffect(e,t)},l.useMemo=function(e,t){return I.current.useMemo(e,t)},l.useReducer=function(e,t,i){return I.current.useReducer(e,t,i)},l.useRef=function(e){return I.current.useRef(e)},l.useState=function(e){return I.current.useState(e)},l.useSyncExternalStore=function(e,t,i){return I.current.useSyncExternalStore(e,t,i)},l.useTransition=function(){return I.current.useTransition()},l.version="18.3.1",l}function c(){return a||(a=1,o.exports=h()),o.exports}var d=c(),u=r(d);const f="pcui-collapsed",p="pcui-collapsible",m="pcui-disabled",g="pcui-error",v="flash",_="pcui-flex",b="pcui-focus",y="font-regular",x="font-bold",S="pcui-grid",w="pcui-hidden",T="pcui-multiple-values",C="pcui-not-flexible",E="pcui-readonly",A="pcui-resizable",P="pcui-scrollable",D=["flexDirection","flexGrow","flexBasis","flexShrink","flexWrap","alignItems","alignSelf","justifyContent","justifySelf"];let L=class e extends t{constructor(e={}){var t,i,s,r;if(super(),this._destroyed=!1,this._parent=null,this._eventsParent=[],this._flashTimeout=null,this._suppressChange=!1,this._onMouseOver=e=>{this.emit("hover",e)},this._onMouseOut=e=>{this.emit("hoverend",e)},"string"==typeof e.dom?this._dom=document.createElement(e.dom):e.dom instanceof Node?this._dom=e.dom:this._dom=document.createElement("div"),void 0!==e.id&&(this._dom.id=e.id),this._dom.ui=this,this._onClickEvt=this._onClick.bind(this),this._dom.addEventListener("click",this._onClickEvt),this._dom.addEventListener("mouseover",this._onMouseOver),this._dom.addEventListener("mouseout",this._onMouseOut),this._dom.classList.add("pcui-element",y),e.class){const t=Array.isArray(e.class)?e.class:[e.class];for(const e of t)this._dom.classList.add(e)}this.enabled=null===(t=e.enabled)||void 0===t||t,this._hiddenParents=!e.isRoot,this.hidden=null!==(i=e.hidden)&&void 0!==i&&i,this.readOnly=null!==(s=e.readOnly)&&void 0!==s&&s,this.ignoreParent=null!==(r=e.ignoreParent)&&void 0!==r&&r,void 0!==e.width&&(this.width=e.width),void 0!==e.height&&(this.height=e.height),void 0!==e.tabIndex&&(this.tabIndex=e.tabIndex);for(const t in e)void 0!==e[t]&&-1!==D.indexOf(t)&&(this[t]=e[t]);e.binding&&(this.binding=e.binding)}destroy(){if(this._destroyed)return;if(this._destroyed=!0,this.binding?this.binding=null:this.unlink(),this.parent){const e=this.parent;for(const e of this._eventsParent)e.unbind();this._eventsParent.length=0,e.remove&&!e._destroyed&&e.remove(this),this._parent=null,!e._destroyed&&this._dom&&this._dom.parentElement&&this._dom.parentElement.removeChild(this._dom)}const e=this._dom;e&&(e.removeEventListener("click",this._onClickEvt),e.removeEventListener("mouseover",this._onMouseOver),e.removeEventListener("mouseout",this._onMouseOut),delete e.ui,this._dom=null),this._flashTimeout&&window.clearTimeout(this._flashTimeout),this.emit("destroy",e,this),this.unbind()}link(e,t){this._binding&&this._binding.link(e,t)}unlink(){this._binding&&this._binding.unlink()}flash(){this._flashTimeout||(this.class.add(v),this._flashTimeout=window.setTimeout((()=>{this._flashTimeout=null,this.class.remove(v)}),200))}_onClick(e){this.enabled&&this.emit("click",e)}_onHiddenToRootChange(e){this.emit(e?"hideToRoot":"showToRoot")}_onEnabledChange(e){e?this.class.remove(m):this.class.add(m),this.emit(e?"enable":"disable")}_onParentDestroy(){this.destroy()}_onParentDisable(){this._ignoreParent||this._enabled&&this._onEnabledChange(!1)}_onParentEnable(){this._ignoreParent||this._enabled&&this._onEnabledChange(!0)}_onParentShowToRoot(){const e=this.hiddenToRoot;this._hiddenParents=!1,e!==this.hiddenToRoot&&this._onHiddenToRootChange(this.hiddenToRoot)}_onParentHideToRoot(){const e=this.hiddenToRoot;this._hiddenParents=!0,e!==this.hiddenToRoot&&this._onHiddenToRootChange(this.hiddenToRoot)}_onReadOnlyChange(e){e?this.class.add(E):this.class.remove(E),this.emit("readOnly",e)}_onParentReadOnlyChange(e){this._ignoreParent||(e?this._readOnly||this._onReadOnlyChange(!0):this._readOnly||this._onReadOnlyChange(!1))}static register(t,i,s){e.registry.set(t,{cls:i,defaultArguments:s})}static unregister(t){e.registry.delete(t)}static create(t,i){const s=e.registry.get(t);if(!s)return void console.error("Invalid type passed to Element.create:",t);return new(0,s.cls)(Object.assign(Object.assign({},s.defaultArguments),i))}set enabled(e){if(this._enabled===e)return;const t=this.enabled;this._enabled=e,t!==e&&this._onEnabledChange(e)}get enabled(){return this._ignoreParent?this._enabled:this._enabled&&(!this._parent||this._parent.enabled)}set ignoreParent(e){this._ignoreParent=e,this._onEnabledChange(this.enabled),this._onReadOnlyChange(this.readOnly)}get ignoreParent(){return this._ignoreParent}get dom(){return this._dom}set parent(e){if(e===this._parent)return;const t=this.enabled,i=this.readOnly,s=this.hiddenToRoot;if(this._parent){for(let e=0;e<this._eventsParent.length;e++)this._eventsParent[e].unbind();this._eventsParent.length=0}this._parent=e,this._parent?(this._eventsParent.push(this._parent.once("destroy",this._onParentDestroy.bind(this))),this._eventsParent.push(this._parent.on("disable",this._onParentDisable.bind(this))),this._eventsParent.push(this._parent.on("enable",this._onParentEnable.bind(this))),this._eventsParent.push(this._parent.on("readOnly",this._onParentReadOnlyChange.bind(this))),this._eventsParent.push(this._parent.on("showToRoot",this._onParentShowToRoot.bind(this))),this._eventsParent.push(this._parent.on("hideToRoot",this._onParentHideToRoot.bind(this))),this._hiddenParents=this._parent.hiddenToRoot):this._hiddenParents=!0,this.emit("parent",this._parent);const r=this.enabled;r!==t&&this._onEnabledChange(r);const n=this.readOnly;n!==i&&this._onReadOnlyChange(n);const a=this.hiddenToRoot;a!==s&&this._onHiddenToRootChange(a)}get parent(){return this._parent}set hidden(e){if(e===this._hidden)return;const t=this.hiddenToRoot;this._hidden=e,e?this.class.add(w):this.class.remove(w),this.emit(e?"hide":"show"),this.hiddenToRoot!==t&&this._onHiddenToRootChange(this.hiddenToRoot)}get hidden(){return this._hidden}get hiddenToRoot(){return this._hidden||this._hiddenParents}set readOnly(e){this._readOnly!==e&&(this._readOnly=e,this._onReadOnlyChange(e))}get readOnly(){return this._ignoreParent?this._readOnly:this._readOnly||!(!this._parent||!this._parent.readOnly)}set error(e){this._hasError!==e&&(this._hasError=e,e?this.class.add(g):this.class.remove(g))}get error(){return this._hasError}get style(){return this._dom.style}get class(){return this._dom.classList}set width(e){this.style.width="number"==typeof e?`${e}px`:e}get width(){return this._dom.clientWidth}set height(e){this.style.height="number"==typeof e?`${e}px`:e}get height(){return this._dom.clientHeight}set tabIndex(e){this._dom.tabIndex=e}get tabIndex(){return this._dom.tabIndex}set binding(e){if(this._binding===e)return;let t,i;this._binding&&(t=this._binding.observers,i=this._binding.paths,this.unlink(),this._binding.element=null,this._binding=null),this._binding=e,this._binding&&(this._binding.element=this,t&&i&&this.link(t,i))}get binding(){return this._binding}get destroyed(){return this._destroyed}set flexDirection(e){this.style.flexDirection=e}get flexDirection(){return this.style.flexDirection}set flexGrow(e){this.style.flexGrow=e}get flexGrow(){return this.style.flexGrow}set flexBasis(e){this.style.flexBasis=e}get flexBasis(){return this.style.flexBasis}set flexShrink(e){this.style.flexShrink=e}get flexShrink(){return this.style.flexShrink}set flexWrap(e){this.style.flexWrap=e}get flexWrap(){return this.style.flexWrap}set alignItems(e){this.style.alignItems=e}get alignItems(){return this.style.alignItems}set alignSelf(e){this.style.alignSelf=e}get alignSelf(){return this.style.alignSelf}set justifyContent(e){this.style.justifyContent=e}get justifyContent(){return this.style.justifyContent}set justifySelf(e){this.style.justifySelf=e}get justifySelf(){return this.style.justifySelf}set disabled(e){this.enabled=!e}get disabled(){return!this.enabled}set element(e){this._dom=e}get element(){return this.dom}set innerElement(e){this._domContent=e}get innerElement(){return this._domContent}};L.EVENT_ENABLE="enable",L.EVENT_DISABLE="disable",L.EVENT_HIDE="hide",L.EVENT_HIDE_TO_ROOT="hideToRoot",L.EVENT_SHOW="show",L.EVENT_SHOW_TO_ROOT="showToRoot",L.EVENT_READ_ONLY="readOnly",L.EVENT_PARENT="parent",L.EVENT_CLICK="click",L.EVENT_HOVER="hover",L.EVENT_HOVER_END="hoverend",L.EVENT_DESTROY="destroy",L.registry=new Map;let M=class extends d.Component{constructor(e){super(e),this.attachElement=(e,t)=>{if(!e)return;this.element=new this.elementClass(Object.assign(Object.assign({},this.props),{dom:e,content:t,parent:void 0}));const i=this.props.class;this.class=new Set(i?Array.isArray(i)?i.slice():[i]:void 0),this.onClick&&this.element.on("click",this.onClick),this.onRemove&&this.element.on("click:remove",this.onRemove),this.onChange&&this.element.on("change",this.onChange),this.props.parent&&(this.element.parent=this.props.parent),this.onAttach&&this.onAttach()},this.getPropertyDescriptor=(e,t)=>{let i;do{i=Object.getOwnPropertyDescriptor(e,t)}while(!i&&(e=Object.getPrototypeOf(e)));return i},this.elementClass=L,e.onClick&&(this.onClick=e.onClick),e.onRemove&&(this.onRemove=e.onRemove),e.onChange&&(this.onChange=e.onChange),e.link&&(this.link=e.link)}componentDidMount(){this.link&&this.element.link(this.link.observer,this.link.path)}componentDidUpdate(e){Object.keys(this.props).forEach((e=>{const t=this.getPropertyDescriptor(this.element,e);if(t&&t.set)"value"===e?(this.element._suppressChange=!0,this.element[e]=this.props[e],this.element._suppressChange=!1):this.element[e]=this.props[e];else if("class"===e){const t=this.props[e],i=new Set(t?Array.isArray(t)?t.slice():[t]:void 0);i.forEach((e=>{this.class.has(e)||(this.element.class.add(e),this.class.add(e))})),this.class.forEach((e=>{i.has(e)||(this.element.class.remove(e),this.class.delete(e))}))}})),e.link!==this.props.link&&this.props.link&&this.element.link(this.props.link.observer,this.props.link.path)}render(){return d.createElement("div",{ref:this.attachElement})}};let I=class extends L{constructor(e={}){super(Object.assign({dom:"button"},e)),this._onKeyDown=e=>{"Escape"===e.key?this.blur():"Enter"===e.key&&this._onClick(e)},this.class.add("pcui-button"),this._unsafe=e.unsafe,this.text=e.text,this.size=e.size,this.icon=e.icon,this.dom.addEventListener("keydown",this._onKeyDown)}destroy(){this._destroyed||(this.dom.removeEventListener("keydown",this._onKeyDown),super.destroy())}_onClick(e){this.blur(),this.readOnly||super._onClick(e)}focus(){this.dom.focus()}blur(){this.dom.blur()}set text(e){this._text!==e&&(this._text=e,this._unsafe?this.dom.innerHTML=e:this.dom.textContent=e)}get text(){return this._text}set icon(e){this._icon!==e&&e.match(/^E\d{0,4}$/)&&(this._icon=e,e?this.dom.setAttribute("data-icon",String.fromCodePoint(parseInt(e,16))):this.dom.removeAttribute("data-icon"))}get icon(){return this._icon}set size(e){this._size!==e&&(this._size&&(this.class.remove(`pcui-${this._size}`),this._size=null),this._size=e,this._size&&this.class.add(`pcui-${this._size}`))}get size(){return this._size}};L.register("button",I);const R=[null,"top","right","bottom","left"],k=`${A}-resizing`,O="pcui-container",F=`${O}-dragged`,B=`${F}-child`;let N=class extends L{constructor(e={}){var t;super(e),this._scrollable=!1,this._flex=!1,this._grid=!1,this._domResizeHandle=null,this._resizePointerId=null,this._resizeData=null,this._resizeHorizontally=!0,this._resizeMin=100,this._resizeMax=300,this._draggedStartIndex=-1,this._onScroll=e=>{this.emit("scroll",e)},this._onResizeStart=e=>{null===this._resizePointerId&&(e.preventDefault(),e.stopPropagation(),this._domResizeHandle.setPointerCapture(e.pointerId),this._resizePointerId=e.pointerId,this._resizeStart())},this._onResizeMove=e=>{this._resizePointerId===e.pointerId&&(e.preventDefault(),e.stopPropagation(),this._resizeMove(e.clientX,e.clientY))},this._onResizeEnd=e=>{this._resizePointerId===e.pointerId&&(e.preventDefault(),e.stopPropagation(),this._resizeEnd(),this._domResizeHandle.releasePointerCapture(e.pointerId),this._resizePointerId=null)},this.class.add(O),this.domContent=this._dom,e.scrollable&&(this.scrollable=!0),this.flex=!!e.flex;let i=!!e.grid;i&&this.flex&&(console.error('Invalid Container arguments: "grid" and "flex" cannot both be true.'),i=!1),this.grid=i,this.resizable=null!==(t=e.resizable)&&void 0!==t?t:null,void 0!==e.resizeMin&&(this.resizeMin=e.resizeMin),void 0!==e.resizeMax&&(this.resizeMax=e.resizeMax)}destroy(){this._destroyed||(this.domContent=null,this._domResizeHandle&&(this._domResizeHandle.removeEventListener("pointerdown",this._onResizeStart),this._domResizeHandle.removeEventListener("pointermove",this._onResizeMove),this._domResizeHandle.removeEventListener("pointerup",this._onResizeEnd)),super.destroy())}append(e){const t=this._getDomFromElement(e);this._domContent.appendChild(t),this._onAppendChild(e)}appendBefore(e,t){const i=this._getDomFromElement(e);this._domContent.appendChild(i);const s=t&&this._getDomFromElement(t);this._domContent.insertBefore(i,s),this._onAppendChild(e)}appendAfter(e,t){const i=this._getDomFromElement(e),s=t&&this._getDomFromElement(t),r=s?s.nextSibling:null;r?this._domContent.insertBefore(i,r):this._domContent.appendChild(i),this._onAppendChild(e)}prepend(e){const t=this._getDomFromElement(e),i=this._domContent.firstChild;i?this._domContent.insertBefore(t,i):this._domContent.appendChild(t),this._onAppendChild(e)}remove(e){if(e.parent!==this)return;const t=this._getDomFromElement(e);this._domContent.removeChild(t),this._onRemoveChild(e)}move(e,t){const i=Array.prototype.indexOf.call(this.dom.childNodes,e.dom);-1===i?this.appendBefore(e,this.dom.childNodes[t]):t!==i&&(this.remove(e),t<i?this.appendBefore(e,this.dom.childNodes[t]):this.appendAfter(e,this.dom.childNodes[t-1]))}clear(){let e=this._domContent.childNodes.length;for(;e--;){const t=this._domContent.childNodes[e];t.ui&&t.ui!==this&&t.ui.destroy()}this._domResizeHandle&&(this._domResizeHandle.removeEventListener("pointerdown",this._onResizeStart),this._domResizeHandle.removeEventListener("pointermove",this._onResizeMove),this._domResizeHandle.removeEventListener("pointerup",this._onResizeEnd),this._domResizeHandle=null),this._domContent.innerHTML="",this.resizable&&(this._createResizeHandle(),this._dom.appendChild(this._domResizeHandle))}_getDomFromElement(e){return e.dom?e.dom:e.element?e.element:e}_onAppendChild(e){e.parent=this,this.emit("append",e)}_onRemoveChild(e){e.parent=null,this.emit("remove",e)}_createResizeHandle(){const e=document.createElement("div");e.classList.add("pcui-resizable-handle"),e.ui=this,e.addEventListener("pointerdown",this._onResizeStart),e.addEventListener("pointermove",this._onResizeMove),e.addEventListener("pointerup",this._onResizeEnd),this._domResizeHandle=e}_resizeStart(){this.class.add(k)}_resizeMove(e,t){if(this._resizeData){if(this._resizeHorizontally){let t=this._resizeData.x-e;"right"===this._resizable&&(t=-t),this.width=4+Math.max(this._resizeMin,Math.min(this._resizeMax,this._resizeData.width+t))}else{let e=this._resizeData.y-t;"bottom"===this._resizable&&(e=-e),this.height=Math.max(this._resizeMin,Math.min(this._resizeMax,this._resizeData.height+e))}this.emit("resize")}else this._resizeData={x:e,y:t,width:this.dom.clientWidth,height:this.dom.clientHeight}}_resizeEnd(){this._resizeData=null,this.class.remove(k)}resize(e=0,t=0){this._resizeStart(),this._resizeMove(0,0),this._resizeMove(4-e,-t),this._resizeEnd()}_getDraggedChildIndex(e){for(let t=0;t<this.dom.childNodes.length;t++)if(this.dom.childNodes[t].ui===e)return t;return-1}_onChildDragStart(e,t){this.class.add(B),this._draggedStartIndex=this._getDraggedChildIndex(t),t.class.add(F),this.emit("child:dragstart",t,this._draggedStartIndex)}_onChildDragMove(e,t){const i=this.dom.getBoundingClientRect(),s=e.clientX<i.left||e.clientX>i.right||e.clientY<i.top||e.clientY>i.bottom,r=this._getDraggedChildIndex(t);if(s)return t.class.remove(F),void(this._draggedStartIndex!==r&&(this.remove(t),this._draggedStartIndex<r?this.appendBefore(t,this.dom.childNodes[this._draggedStartIndex]):this.appendAfter(t,this.dom.childNodes[this._draggedStartIndex-1])));t.class.add(F);const n=e.clientY-i.top;let a=null;for(let e=0;e<this.dom.childNodes.length;e++){const i=this.dom.childNodes[e].ui,s=i.dom.offsetTop;if(e<r){if(n<=s+i.header.height){a=e;break}}else if(e>r&&n+t.height>=s+i.height){a=e;break}}null!==a&&r!==a&&(this.remove(t),a<r?this.appendBefore(t,this.dom.childNodes[a]):this.appendAfter(t,this.dom.childNodes[a-1]))}_onChildDragEnd(e,t){this.class.remove(B),t.class.remove(F);const i=this._getDraggedChildIndex(t);this.emit("child:dragend",t,i,this._draggedStartIndex),this._draggedStartIndex=-1}forEachChild(e){for(let t=0;t<this.dom.childNodes.length;t++){const i=this.dom.childNodes[t].ui;if(i){if(!1===e(i,t))break}}}_buildDomNode(e){const t=Object.keys(e);let i;return t.includes("root")?(i=this._buildDomNode(e.root),e.children.forEach((e=>{const t=this._buildDomNode(e);null!==t&&i.append(t)}))):(i=e[t[0]],this[`_${t[0]}`]=i),i}buildDom(e){e.forEach((e=>{const t=this._buildDomNode(e);this.append(t)}))}set flex(e){e!==this._flex&&(this._flex=e,e?this.class.add(_):this.class.remove(_))}get flex(){return this._flex}set grid(e){e!==this._grid&&(this._grid=e,e?this.class.add(S):this.class.remove(S))}get grid(){return this._grid}set scrollable(e){this._scrollable!==e&&(this._scrollable=e,e?this.class.add(P):this.class.remove(P))}get scrollable(){return this._scrollable}set resizable(e){e!==this._resizable&&(-1!==R.indexOf(e)?(this._resizable&&this.class.remove(`${A}-${this._resizable}`),this._resizable=e,this._resizeHorizontally="right"===e||"left"===e,e?(this.class.add(A),this.class.add(`${A}-${e}`),this._domResizeHandle||this._createResizeHandle(),this._dom.appendChild(this._domResizeHandle)):(this.class.remove(A),this._domResizeHandle&&this._dom.removeChild(this._domResizeHandle))):console.error(`Invalid resizable value: must be one of ${R.join(",")}`))}get resizable(){return this._resizable}set resizeMin(e){this._resizeMin=Math.max(0,Math.min(e,this._resizeMax))}get resizeMin(){return this._resizeMin}set resizeMax(e){this._resizeMax=Math.max(this._resizeMin,e)}get resizeMax(){return this._resizeMax}set domContent(e){this._domContent!==e&&(this._domContent&&this._domContent.removeEventListener("scroll",this._onScroll),this._domContent=e,this._domContent&&this._domContent.addEventListener("scroll",this._onScroll))}get domContent(){return this._domContent}};N.EVENT_APPEND="append",N.EVENT_REMOVE="remove",N.EVENT_SCROLL="scroll",N.EVENT_RESIZE="resize",L.register("container",N);class z extends L{constructor(e={}){var t,i,s,r,n;super(e),this.blurOnEnter=!0,this.blurOnEscape=!0,this._onInputFocus=e=>{this.class.add(b),this.emit("focus",e),this._prevValue=this._domInput.value},this._onInputBlur=e=>{this.class.remove(b),this.emit("blur",e)},this._onInputKeyUp=e=>{"Escape"!==e.key&&this._onInputChange(e),this.emit("keyup",e)},this._onInputCtxMenu=e=>{this._domInput.select()},this._updateInputReadOnly=()=>{!this.enabled||this.readOnly?this._domInput.setAttribute("readonly","true"):this._domInput.removeAttribute("readonly")},this.class.add("pcui-input-element");let a=e.input;a||(a=document.createElement("input"),a.type="text"),a.ui=this,a.tabIndex=0,a.autocomplete="off",this._onInputKeyDownEvt=this._onInputKeyDown.bind(this),this._onInputChangeEvt=this._onInputChange.bind(this),a.addEventListener("change",this._onInputChangeEvt),a.addEventListener("keydown",this._onInputKeyDownEvt),a.addEventListener("focus",this._onInputFocus),a.addEventListener("blur",this._onInputBlur),a.addEventListener("contextmenu",this._onInputCtxMenu,!1),this.dom.appendChild(a),this._domInput=a,this._suspendInputChangeEvt=!1,void 0!==e.value&&(this._domInput.value=e.value),this.placeholder=null!==(t=e.placeholder)&&void 0!==t?t:"",this.renderChanges=null!==(i=e.renderChanges)&&void 0!==i&&i,this.blurOnEnter=null===(s=e.blurOnEnter)||void 0===s||s,this.blurOnEscape=null===(r=e.blurOnEscape)||void 0===r||r,this.keyChange=null!==(n=e.keyChange)&&void 0!==n&&n,this._prevValue=null,this.on("change",(()=>{this.renderChanges&&this.flash()})),this.on("disable",this._updateInputReadOnly),this.on("enable",this._updateInputReadOnly),this.on("readOnly",this._updateInputReadOnly),this._updateInputReadOnly()}destroy(){if(this._destroyed)return;const e=this._domInput;e.removeEventListener("change",this._onInputChangeEvt),e.removeEventListener("keydown",this._onInputKeyDownEvt),e.removeEventListener("focus",this._onInputFocus),e.removeEventListener("blur",this._onInputBlur),e.removeEventListener("keyup",this._onInputKeyUp),e.removeEventListener("contextmenu",this._onInputCtxMenu),super.destroy()}_onInputKeyDown(e){if("Enter"===e.key&&this.blurOnEnter)this._suspendInputChangeEvt=this.keyChange,this._domInput.blur(),this._suspendInputChangeEvt=!1;else if("Escape"===e.key){this._suspendInputChangeEvt=!0;const t=this._domInput.value;this._domInput.value=this._prevValue,this._suspendInputChangeEvt=!1,this.keyChange&&t!==this._prevValue&&this._onInputChange(e),this.blurOnEscape&&this._domInput.blur()}this.emit("keydown",e)}_onInputChange(e){}focus(e){this._domInput.focus(),e&&this._domInput.select()}blur(){this._domInput.blur()}set placeholder(e){e?this.dom.setAttribute("placeholder",e):this.dom.removeAttribute("placeholder")}get placeholder(){var e;return null!==(e=this.dom.getAttribute("placeholder"))&&void 0!==e?e:""}set keyChange(e){this._keyChange!==e&&(this._keyChange=e,e?this._domInput.addEventListener("keyup",this._onInputKeyUp):this._domInput.removeEventListener("keyup",this._onInputKeyUp))}get keyChange(){return this._keyChange}get input(){return this._domInput}set renderChanges(e){this._renderChanges=e}get renderChanges(){return this._renderChanges}}const U="pcui-numeric-input",V=`${U}-slider-control`,H=`${V}-active`,G=`${V}-hidden`,W=/,/g;let j=class extends z{constructor(e={}){var t,i,s,r;const n=Object.assign({},e);delete n.value,delete n.renderChanges,super(n),this._sliderUsed=!1,this._onSliderMouseWheel=e=>{this._updatePosition(e.deltaY,e.shiftKey)},this._onSliderMouseMove=e=>{this._updatePosition(e.movementX,e.shiftKey)},this._onSliderMouseDown=e=>{this._sliderControl.dom.requestPointerLock(),this._sliderMovement=0,this._sliderPrevValue=this.value,this._sliderUsed=!0,this.binding&&(this._historyCombine=this.binding.historyCombine,this._historyPostfix=this.binding.historyPostfix,this.binding.historyCombine=!0,this.binding.historyPostfix=`(${Date.now()})`),this.emit("slider:mousedown",e)},this._onSliderMouseUp=()=>{document.exitPointerLock(),this._sliderUsed&&(this._sliderUsed=!1,this.value=this._sliderPrevValue+this._sliderMovement,this.binding&&(this.binding.historyCombine=this._historyCombine,this.binding.historyPostfix=this._historyPostfix,this._historyCombine=!1,this._historyPostfix=null),this.focus(),this.emit("slider:mouseup"))},this._onPointerLockChange=()=>{this._isScrolling()?(this._sliderControl.dom.addEventListener("mousemove",this._onSliderMouseMove,!1),this._sliderControl.dom.addEventListener("wheel",this._onSliderMouseWheel,{passive:!0}),this._sliderControl.class.add(H)):(this._sliderControl.dom.removeEventListener("mousemove",this._onSliderMouseMove,!1),this._sliderControl.dom.removeEventListener("wheel",this._onSliderMouseWheel),this._sliderControl.class.remove(H))},this.class.add(U),this._min=null!==(t=e.min)&&void 0!==t?t:null,this._max=null!==(i=e.max)&&void 0!==i?i:null,this._allowNull=null!==(s=e.allowNull)&&void 0!==s&&s,this._precision=null!==(r=e.precision)&&void 0!==r?r:7,Number.isFinite(e.step)?this._step=e.step:e.precision?this._step=10/Math.pow(10,e.precision):this._step=1,Number.isFinite(e.stepPrecision)?this._stepPrecision=e.stepPrecision:this._stepPrecision=.1*this._step,this._oldValue=void 0,Number.isFinite(e.value)?this.value=e.value:this._allowNull||(this.value=0),this._historyCombine=!1,this._historyPostfix=null,this._sliderPrevValue=0,this.renderChanges=e.renderChanges,e.hideSlider||(this._sliderControl=new L,this._sliderControl.class.add(V),this.dom.append(this._sliderControl.dom),this._sliderControl.dom.addEventListener("mousedown",this._onSliderMouseDown),this._sliderControl.dom.addEventListener("mouseup",this._onSliderMouseUp),document.addEventListener("pointerlockchange",this._onPointerLockChange,!1))}destroy(){this.destroyed||(this._sliderControl&&(this._sliderControl.dom.removeEventListener("mousedown",this._onSliderMouseDown),this._sliderControl.dom.removeEventListener("mouseup",this._onSliderMouseUp),this._sliderControl.dom.removeEventListener("mousemove",this._onSliderMouseMove,!1),this._sliderControl.dom.removeEventListener("wheel",this._onSliderMouseWheel),document.removeEventListener("pointerlockchange",this._onPointerLockChange,!1)),super.destroy())}_updatePosition(e,t){this._sliderMovement+=e/100*(t?this._stepPrecision:this._step),this.value=this._sliderPrevValue+this._sliderMovement}_onInputChange(e){this.value=this._normalizeValue(this._domInput.value)}_onInputKeyDown(e){if(this.enabled&&!this.readOnly){if("ArrowUp"===e.key||"ArrowDown"===e.key){const t="ArrowDown"===e.key?-1:1;this.value+=(e.shiftKey?this._stepPrecision:this._step)*t}super._onInputKeyDown(e)}}_getPointerLockElementByShadowRoot(e){const t=e.shadowRoot;if(t){const e=t.pointerLockElement;return this._getPointerLockElementByShadowRoot(e)}return e===this._sliderControl.dom}_isScrolling(){return!!this._sliderControl&&(document.pointerLockElement&&document.pointerLockElement.shadowRoot?this._getPointerLockElementByShadowRoot(document.pointerLockElement):document.pointerLockElement===this._sliderControl.dom)}_normalizeValue(e){try{if("string"==typeof e){if("0"===e)return 0;if(null!==(e=(e=(e=e.replace(W,".")).replace(/\s/g,"")).match(/^[*/+\-0-9().]+$/))&&e[0].length<20){let t=e[0];["+","-","/","*"].forEach((e=>{const i=t.split(e);i.forEach(((e,t)=>{i[t]=i[t].replace(/^0+/,"")})),t=i.join(e)})),e=Function(`"use strict";return (${t})`)()}}if(null==e||""===e){if(this._allowNull)return null;e=0}if(e=Number(e),isNaN(e)){if(this._allowNull)return null;e=0}return null!==this.min&&e<this.min&&(e=this.min),null!==this.max&&e>this.max&&(e=this.max),null!==this.precision&&(e=parseFloat(Number(e).toFixed(this.precision))),e}catch(e){return this._allowNull?null:0}}_updateValue(e,t){const i=e!==this._oldValue||t;return this._oldValue=e,this._domInput.value=null===e?"":String(e),this.class.remove(T),i&&this.emit("change",e),i}set value(e){e=this._normalizeValue(e);const t=this.class.contains(T)&&null===e&&this._allowNull;this._updateValue(e,t)&&this.binding&&this.binding.setValue(e),this._sliderControl&&this._sliderControl.class.remove(G)}get value(){const e=this._domInput.value;return""!==e?parseFloat(e):null}set values(e){const t=e.map((e=>this._normalizeValue(e)));t.some((e=>e!==t[0]))?(this._updateValue(null),this.class.add(T),this._sliderControl&&this._sliderControl.class.add(G)):(this._updateValue(t[0]),this._sliderControl&&this._sliderControl.class.remove(G))}set min(e){this._min!==e&&(this._min=e,null!==this._min&&(this.value=this.value))}get min(){return this._min}set max(e){this._max!==e&&(this._max=e,null!==this._max&&(this.value=this.value))}get max(){return this._max}set precision(e){this._precision!==e&&(this._precision=e,null!==this._precision&&(this.value=this.value))}get precision(){return this._precision}set step(e){this._step=e}get step(){return this._step}};L.register("number",j,{renderChanges:!0});let q=class extends L{constructor(e={}){var t,i,s;super(Object.assign({dom:"span"},e)),this.class.add("pcui-label"),this._unsafe=null!==(t=e.unsafe)&&void 0!==t&&t,this.text=null!==(s=null!==(i=e.text)&&void 0!==i?i:e.value)&&void 0!==s?s:"",e.allowTextSelection&&this.class.add("pcui-default-mousedown"),e.nativeTooltip&&(this.dom.title=this.text),this.placeholder=e.placeholder,this.renderChanges=e.renderChanges,this.on("change",(()=>{this.renderChanges&&this.flash()}))}_updateText(e){return this.class.remove(T),this._text!==e&&(this._text=e,this._unsafe?this._dom.innerHTML=e:this._dom.textContent=e,this.emit("change",e),!0)}set text(e){null==e&&(e="");this._updateText(e)&&this._binding&&this._binding.setValue(e)}get text(){return this._text}set value(e){this.text=e}get value(){return this.text}set values(e){e.some((t=>t!==e[0]))?(this._updateText(""),this.class.add(T)):this._updateText(e[0])}set placeholder(e){e?this.dom.setAttribute("placeholder",e):this.dom.removeAttribute("placeholder")}get placeholder(){return this.dom.getAttribute("placeholder")}set renderChanges(e){this._renderChanges=e}get renderChanges(){return this._renderChanges}};L.register("label",q);const X="pcui-panel",K=`${X}-header`,Y=`${K}-title`,Q=`${X}-content`,J=`${X}-horizontal`,$=`${X}-sortable-icon`,Z=`${X}-remove`;let ee=class extends N{constructor(e={}){var t,i,s,r,n;const a=Object.assign(Object.assign({},e),{flex:!0});delete a.grid,delete a.flexDirection,delete a.scrollable,super(a),this._reflowTimeout=null,this._widthBeforeCollapse=null,this._heightBeforeCollapse=null,this._iconSort=null,this._btnRemove=null,this._onHeaderClick=e=>{this._collapsible&&(e.target!==this.header.dom&&e.target!==this._labelTitle.dom||(this.collapsed=!this.collapsed))},this._onDragStart=e=>{this.enabled&&!this.readOnly&&(e.stopPropagation(),e.preventDefault(),window.addEventListener("mouseup",this._onDragEndEvt),window.addEventListener("mouseleave",this._onDragEndEvt),window.addEventListener("mousemove",this._onDragMove),this.emit("dragstart"),this.parent&&this.parent._onChildDragStart&&this.parent._onChildDragStart(e,this))},this._onDragMove=e=>{this.emit("dragmove"),this.parent&&this.parent._onChildDragStart&&this.parent._onChildDragMove(e,this)},this.class.add(X),e.panelType&&this.class.add(`${X}-${e.panelType}`),this._suspendReflow=!0,this._initializeHeader(e),this._initializeContent(e),this.headerSize=null!==(t=e.headerSize)&&void 0!==t?t:32,this.collapsible=null!==(i=e.collapsible)&&void 0!==i&&i,this.collapsed=null!==(s=e.collapsed)&&void 0!==s&&s,this.collapseHorizontally=null!==(r=e.collapseHorizontally)&&void 0!==r&&r,this.sortable=null!==(n=e.sortable)&&void 0!==n&&n,this.removable=e.removable||!!e.onRemove||!1,this.domContent=this._containerContent.dom,this._suspendReflow=!1,this._reflow(),this._onDragEndEvt=this._onDragEnd.bind(this)}destroy(){this._destroyed||(this._reflowTimeout&&(cancelAnimationFrame(this._reflowTimeout),this._reflowTimeout=null),window.removeEventListener("mouseup",this._onDragEndEvt),window.removeEventListener("mouseleave",this._onDragEndEvt),window.removeEventListener("mousemove",this._onDragMove),super.destroy())}_initializeHeader(e){this._containerHeader=new N({flex:!0,flexDirection:"row",class:[K,x]}),this._labelTitle=new q({text:e.headerText,class:[Y,x]}),this._containerHeader.append(this._labelTitle),this._containerHeader.dom.addEventListener("click",this._onHeaderClick),this.append(this._containerHeader)}_onClickRemove(e){e.preventDefault(),e.stopPropagation(),this.emit("click:remove")}_initializeContent(e){this._containerContent=new N({class:Q,grid:e.grid,flex:e.flex,flexDirection:e.flexDirection,scrollable:e.scrollable,dom:e.content}),this.append(this._containerContent)}_reflow(){this._suspendReflow||(this._reflowTimeout&&(cancelAnimationFrame(this._reflowTimeout),this._reflowTimeout=null),!this.hidden&&this.collapsible&&(this.collapsed&&this.collapseHorizontally?this._containerHeader.style.top=-this.headerSize+"px":this._containerHeader.style.top="",this._reflowTimeout=requestAnimationFrame((()=>{this._reflowTimeout=null,this.collapsed?(this._widthBeforeCollapse||(this._widthBeforeCollapse=this.style.width),this._heightBeforeCollapse||(this._heightBeforeCollapse=this.style.height),this._collapseHorizontally?(this.height="",this.width=this.headerSize):this.height=this.headerSize,this.class.add(f)):(this.class.remove(f),this._collapseHorizontally?(this.height="",null!==this._widthBeforeCollapse&&(this.width=this._widthBeforeCollapse)):null!==this._heightBeforeCollapse&&(this.height=this._heightBeforeCollapse),this._widthBeforeCollapse=null,this._heightBeforeCollapse=null)}))))}_onDragEnd(e){window.removeEventListener("mouseup",this._onDragEndEvt),window.removeEventListener("mouseleave",this._onDragEndEvt),window.removeEventListener("mousemove",this._onDragMove),this._draggedChild===this&&(this._draggedChild=null),this.emit("dragend"),this.parent&&this.parent._onChildDragStart&&this.parent._onChildDragEnd(e,this)}set collapsible(e){e!==this._collapsible&&(this._collapsible=e,e?this.class.add(p):this.class.remove(p),this._reflow(),this.collapsed&&this.emit(e?"collapse":"expand"))}get collapsible(){return this._collapsible}set collapsed(e){this._collapsed!==e&&(this._collapsed=e,this._reflow(),this.collapsible&&this.emit(e?"collapse":"expand"))}get collapsed(){return this._collapsed}set sortable(e){this._sortable!==e&&(this._sortable=e,e?(this._iconSort=new q({class:$}),this._iconSort.dom.addEventListener("mousedown",this._onDragStart),this.header.prepend(this._iconSort)):this._iconSort&&(this._iconSort.destroy(),this._iconSort=null))}get sortable(){return this._sortable}set removable(e){this.removable!==e&&(e?(this._btnRemove=new I({icon:"E289",class:Z}),this._btnRemove.on("click",this._onClickRemove.bind(this)),this.header.append(this._btnRemove)):(this._btnRemove.destroy(),this._btnRemove=null))}get removable(){return!!this._btnRemove}set collapseHorizontally(e){this._collapseHorizontally!==e&&(this._collapseHorizontally=e,e?this.class.add(J):this.class.remove(J),this._reflow())}get collapseHorizontally(){return this._collapseHorizontally}get content(){return this._containerContent}get header(){return this._containerHeader}set headerText(e){this._labelTitle.text=e}get headerText(){return this._labelTitle.text}set headerSize(e){this._headerSize=e;const t=this._containerHeader.dom.style;t.height=`${Math.max(0,e)}px`,t.lineHeight=t.height,this._reflow()}get headerSize(){return this._headerSize}};ee.EVENT_COLLAPSE="collapse",ee.EVENT_EXPAND="expand",L.register("panel",ee);const te="pcui-boolean-input",ie=`${te}-ticked`,se=`${te}-toggle`;let re=class extends L{constructor(e={}){var t;super(Object.assign({tabIndex:0},e)),this._onKeyDown=e=>{"Escape"!==e.key?this.enabled&&!this.readOnly&&" "===e.key&&(e.stopPropagation(),e.preventDefault(),this.value=!this.value):this.blur()},this._onFocus=()=>{this.emit("focus")},this._onBlur=()=>{this.emit("blur")},"toggle"===e.type?this.class.add(se):this.class.add(te),this.class.add(C),this.dom.addEventListener("keydown",this._onKeyDown),this.dom.addEventListener("focus",this._onFocus),this.dom.addEventListener("blur",this._onBlur),this._value=null,void 0!==e.value&&(this.value=e.value),this.renderChanges=null!==(t=e.renderChanges)&&void 0!==t&&t}destroy(){this._destroyed||(this.dom.removeEventListener("keydown",this._onKeyDown),this.dom.removeEventListener("focus",this._onFocus),this.dom.removeEventListener("blur",this._onBlur),super.destroy())}_onClick(e){return this.enabled&&this.focus(),this.enabled&&!this.readOnly&&(this.value=!this.value),super._onClick(e)}_updateValue(e){return this.class.remove(T),e!==this.value&&(this._value=e,e?this.class.add(ie):this.class.remove(ie),this.renderChanges&&this.flash(),this.emit("change",e),!0)}focus(){this.dom.focus()}blur(){this.dom.blur()}set value(e){this._updateValue(e)&&this._binding&&this._binding.setValue(e)}get value(){return this._value}set values(e){e.some((t=>t!==e[0]))?(this._updateValue(null),this.class.add(T)):this._updateValue(e[0])}set renderChanges(e){this._renderChanges=e}get renderChanges(){return this._renderChanges}};L.register("boolean",re,{renderChanges:!0});class ne extends M{constructor(e={}){super(e),this.elementClass=re}render(){return super.render()}}ne.ctor=re;class ae extends M{constructor(e={}){super(e),this.elementClass=I}render(){return d.createElement("button",{ref:this.attachElement})}}function oe(e){const t=e[0]/255,i=e[1]/255,s=e[2]/255;let r,n;const a=Math.max(t,i,s),o=a-Math.min(t,i,s),l=e=>(a-e)/6/o+.5;if(0===o)return r=n=0,[r,n,a];n=o/a;const h=l(t),c=l(i),d=l(s);return t===a?r=d-c:i===a?r=1/3+h-d:s===a&&(r=2/3+c-h),r<0?r+=1:r>1&&(r-=1),[r,n,a]}function le(e){const t=e[0],i=e[1],s=e[2];let r,n,a;const o=Math.floor(6*t),l=6*t-o,h=s*(1-i),c=s*(1-l*i),d=s*(1-(1-l)*i);switch(o%6){case 0:r=s,n=d,a=h;break;case 1:r=c,n=s,a=h;break;case 2:r=h,n=s,a=d;break;case 3:r=h,n=c,a=s;break;case 4:r=d,n=h,a=s;break;case 5:r=s,n=h,a=c}return[Math.round(255*r),Math.round(255*n),Math.round(255*a)]}ae.ctor=I;const he="pcui-overlay",ce=`${he}-inner`,de=`${he}-clickable`,ue=`${he}-transparent`,fe=`${he}-content`;let pe=class extends N{constructor(e={}){var t,i;super(e),this._onPointerDown=e=>{this.clickable&&!this.domContent.contains(e.target)&&(document.body.blur(),requestAnimationFrame((()=>{this.hidden=!0})),e.preventDefault(),e.stopPropagation())},this.class.add(he),this._domClickableOverlay=document.createElement("div"),this._domClickableOverlay.ui=this,this._domClickableOverlay.classList.add(ce),this.dom.appendChild(this._domClickableOverlay),this.on("show",(()=>{document.body.addEventListener("pointerdown",this._onPointerDown,!0)})),this.on("hide",(()=>{document.body.removeEventListener("pointerdown",this._onPointerDown,!0)})),this.domContent=document.createElement("div"),this.domContent.ui=this,this.domContent.classList.add(fe),this.dom.appendChild(this.domContent),this.clickable=null!==(t=e.clickable)&&void 0!==t&&t,this.transparent=null!==(i=e.transparent)&&void 0!==i&&i}destroy(){this._destroyed||super.destroy()}position(e,t){const i=this._domClickableOverlay.getBoundingClientRect(),s=this.domContent.getBoundingClientRect();e=Math.max(0,Math.min(i.width-s.width,e)),t=Math.max(0,Math.min(i.height-s.height,t)),this.domContent.style.position="absolute",this.domContent.style.left=`${e}px`,this.domContent.style.top=`${t}px`}set clickable(e){e?this.class.add(de):this.class.remove(de)}get clickable(){return this.class.contains(de)}set transparent(e){e?this.class.add(ue):this.class.remove(ue)}get transparent(){return this.class.contains(ue)}};L.register("overlay",pe);let me=class extends z{constructor(e={}){super(e),this.class.add("pcui-text-input"),e.onValidate&&(this.onValidate=e.onValidate)}_onInputChange(e){if(!this._suspendInputChangeEvt){if(this.onValidate){const e=!this.onValidate(this.value);if(this.error=e,e)return}else this.error=!1;this.emit("change",this.value),this._binding&&this._binding.setValue(this.value)}}_updateValue(e){if(this.class.remove(T),e&&"object"==typeof e)if(Array.isArray(e)){let t=!1;for(let i=0;i<e.length;i++)if(e[i]&&"object"==typeof e[i]){t=!0;break}e=t?"[Not available]":e.map((e=>null===e?"null":e)).join(",")}else e="[Not available]";return e!==this.value&&(this._suspendInputChangeEvt=!0,this._domInput.value=null==e?"":String(e),this._suspendInputChangeEvt=!1,this.emit("change",e),!0)}set value(e){const t=this._updateValue(e);t&&(this.error=!1),t&&this._binding&&this._binding.setValue(e)}get value(){return this._domInput.value}set values(e){e.some((t=>t!==e[0]))?(this._updateValue(null),this.class.add(T)):this._updateValue(e[0])}};L.register("string",me,{renderChanges:!0});let ge=class extends L{constructor(e={}){var t,i,s;super(e),this._historyCombine=!1,this._historyPostfix=null,this._size=144,this._directInput=!0,this._colorHSV=[0,0,0],this._pickerChannels=[],this._channelsNumber=4,this._changing=!1,this._dragging=!1,this._callingCallback=!1,this._pickRectPointerId=null,this._pickHuePointerId=null,this._pickOpacityPointerId=null,this._evtColorPick=null,this._evtColorToPicker=null,this._evtColorPickStart=null,this._evtColorPickEnd=null,this._onKeyDown=e=>{"Escape"===e.key&&this.blur(),"Enter"===e.key&&this.enabled&&!this.readOnly&&(e.stopPropagation(),e.preventDefault())},this._onFocus=e=>{this.emit("focus")},this._onBlur=e=>{this.emit("blur")},this._pickRectPointerDown=e=>{null===this._pickRectPointerId&&(this._pickRect.setPointerCapture(e.pointerId),this._pickRectPointerId=e.pointerId,e.preventDefault(),e.stopPropagation(),this.emit("picker:color:start"),this._pickRectPointerMove(e))},this._pickRectPointerMove=e=>{if(this._pickRectPointerId!==e.pointerId)return;this._changing=!0;const t=this._pickRect.getBoundingClientRect(),i=Math.max(0,Math.min(this._size,Math.floor(e.clientX-t.left))),s=Math.max(0,Math.min(this._size,Math.floor(e.clientY-t.top)));this._colorHSV[1]=i/this._size,this._colorHSV[2]=1-s/this._size,this._directInput=!1;const r=le(this._colorHSV);for(let e=0;e<3;e++)this._pickerChannels[e].value=r[e];this._fieldHex.value=this._getHex(),this._directInput=!0,this._pickRectHandle.style.left=`${Math.max(4,Math.min(this._size-4,i))}px`,this._pickRectHandle.style.top=`${Math.max(4,Math.min(this._size-4,s))}px`,this._changing=!1},this._pickRectPointerUp=e=>{this._pickRectPointerId===e.pointerId&&(this.emit("picker:color:end"),this._pickRect.releasePointerCapture(e.pointerId),this._pickRectPointerId=null)},this._pickHuePointerDown=e=>{null===this._pickHuePointerId&&(this._pickHue.setPointerCapture(e.pointerId),this._pickHuePointerId=e.pointerId,e.preventDefault(),e.stopPropagation(),this.emit("picker:color:start"),this._pickHuePointerMove(e))},this._pickHuePointerMove=e=>{if(this._pickHuePointerId!==e.pointerId)return;this._changing=!0;const t=this._pickHue.getBoundingClientRect(),i=Math.max(0,Math.min(this._size,Math.floor(e.clientY-t.top)))/this._size,s=le([i,this._colorHSV[1],this._colorHSV[2]]);this._colorHSV[0]=i,this._directInput=!1;for(let e=0;e<3;e++)this._pickerChannels[e].value=s[e];this._fieldHex.value=this._getHex(),this._onChangeRgb(),this._directInput=!0,this._changing=!1},this._pickHuePointerUp=e=>{this._pickHuePointerId===e.pointerId&&(this.emit("picker:color:end"),this._pickHue.releasePointerCapture(e.pointerId),this._pickHuePointerId=null)},this._pickOpacityPointerDown=e=>{null===this._pickOpacityPointerId&&(this._pickOpacity.setPointerCapture(e.pointerId),this._pickOpacityPointerId=e.pointerId,e.preventDefault(),e.stopPropagation(),this.emit("picker:color:start"),this._pickOpacityPointerMove(e))},this._pickOpacityPointerMove=e=>{if(this._pickOpacityPointerId!==e.pointerId)return;this._changing=!0;const t=this._pickOpacity.getBoundingClientRect(),i=1-Math.max(0,Math.min(this._size,Math.floor(e.clientY-t.top)))/this._size;this._directInput=!1,this._pickerChannels[3].value=Math.max(0,Math.min(255,Math.round(255*i))),this._fieldHex.value=this._getHex(),this._directInput=!0,this._changing=!1},this._pickOpacityPointerUp=e=>{this._pickOpacityPointerId===e.pointerId&&(this.emit("picker:color:end"),this._pickOpacity.releasePointerCapture(e.pointerId),this._pickOpacityPointerId=null)},this.class.add("pcui-color-input",C),this._domColor=document.createElement("div"),this.dom.appendChild(this._domColor),this.dom.addEventListener("keydown",this._onKeyDown),this.dom.addEventListener("focus",this._onFocus),this.dom.addEventListener("blur",this._onBlur),this.dom.addEventListener("pointerdown",(e=>{this.enabled&&!this.readOnly&&this._overlay.hidden&&(this._openColorPicker(),e.stopPropagation(),e.preventDefault())})),this._value=null!==(t=e.value)&&void 0!==t?t:[0,0,255,1],this._channels=null!==(i=e.channels)&&void 0!==i?i:3,this._setValue(this._value),this.renderChanges=null!==(s=e.renderChanges)&&void 0!==s&&s,this.on("change",(()=>{this.renderChanges&&this.flash()})),this._overlay=new pe({class:"picker-color",clickable:!0,hidden:!0,transparent:!0}),this.dom.appendChild(this._overlay.dom),this._pickRect=document.createElement("div"),this._pickRect.classList.add("pick-rect"),this._overlay.append(this._pickRect),this._pickRect.addEventListener("pointerdown",this._pickRectPointerDown),this._pickRect.addEventListener("pointermove",this._pickRectPointerMove),this._pickRect.addEventListener("pointerup",this._pickRectPointerUp),this._pickRectWhite=document.createElement("div"),this._pickRectWhite.classList.add("white"),this._pickRect.appendChild(this._pickRectWhite),this._pickRectBlack=document.createElement("div"),this._pickRectBlack.classList.add("black"),this._pickRect.appendChild(this._pickRectBlack),this._pickRectHandle=document.createElement("div"),this._pickRectHandle.classList.add("handle"),this._pickRect.appendChild(this._pickRectHandle),this._pickHue=document.createElement("div"),this._pickHue.classList.add("pick-hue"),this._overlay.append(this._pickHue),this._pickHue.addEventListener("pointerdown",this._pickHuePointerDown),this._pickHue.addEventListener("pointermove",this._pickHuePointerMove),this._pickHue.addEventListener("pointerup",this._pickHuePointerUp),this._pickHueHandle=document.createElement("div"),this._pickHueHandle.classList.add("handle"),this._pickHue.appendChild(this._pickHueHandle),this._pickOpacity=document.createElement("div"),this._pickOpacity.classList.add("pick-opacity"),this._overlay.append(this._pickOpacity),this._pickOpacity.addEventListener("pointerdown",this._pickOpacityPointerDown),this._pickOpacity.addEventListener("pointermove",this._pickOpacityPointerMove),this._pickOpacity.addEventListener("pointerup",this._pickOpacityPointerUp),this._pickOpacityHandle=document.createElement("div"),this._pickOpacityHandle.classList.add("handle"),this._pickOpacity.appendChild(this._pickOpacityHandle),this._panelFields=document.createElement("div"),this._panelFields.classList.add("fields"),this._overlay.append(this._panelFields),this._overlay.on("hide",(()=>{this._evtColorPick.unbind(),this._evtColorPick=null,this._evtColorToPicker.unbind(),this._evtColorToPicker=null,this._evtColorPickStart.unbind(),this._evtColorPickStart=null,this._evtColorPickEnd.unbind(),this._evtColorPickEnd=null}));const r=e=>new j({class:["field",`field-${e}`],precision:0,step:1,min:0,max:255,placeholder:e}),n=r("r");n.on("change",(()=>{this._onChangeRgb()})),this._pickerChannels.push(n),this._panelFields.appendChild(n.dom);const a=r("g");a.on("change",(()=>{this._onChangeRgb()})),this._pickerChannels.push(a),this._panelFields.appendChild(a.dom);const o=r("b");o.on("change",(()=>{this._onChangeRgb()})),this._pickerChannels.push(o),this._panelFields.appendChild(o.dom);const l=r("a");l.on("change",(e=>{this._onChangeAlpha(e)})),this._pickerChannels.push(l),this._panelFields.appendChild(l.dom),this._fieldHex=new me({class:["field","field-hex"],placeholder:"#"}),this._fieldHex.on("change",(()=>{this._onChangeHex()})),this._panelFields.appendChild(this._fieldHex.dom)}destroy(){this._destroyed||(this.dom.removeEventListener("keydown",this._onKeyDown),this.dom.removeEventListener("focus",this._onFocus),this.dom.removeEventListener("blur",this._onBlur),this._pickRect.removeEventListener("pointerdown",this._pickRectPointerDown),this._pickRect.removeEventListener("pointermove",this._pickRectPointerMove),this._pickRect.removeEventListener("pointerup",this._pickRectPointerUp),this._pickHue.removeEventListener("pointerdown",this._pickHuePointerDown),this._pickHue.removeEventListener("pointermove",this._pickHuePointerMove),this._pickHue.removeEventListener("pointerup",this._pickHuePointerUp),this._pickOpacity.removeEventListener("pointerdown",this._pickOpacityPointerDown),this._pickOpacity.removeEventListener("pointermove",this._pickOpacityPointerMove),this._pickOpacity.removeEventListener("pointerup",this._pickOpacityPointerUp),super.destroy())}focus(){this.dom.focus()}blur(){this.dom.blur()}_setColorPickerPosition(e,t){this._overlay.position(e,t)}_setPickerColor(e){if(!this._changing&&!this._dragging){if(this._channelsNumber>=3){const t=oe(e);this._colorHSV[0]=t[0],this._colorHSV[1]=t[1],this._colorHSV[2]=t[2]}this._directInput=!1;for(let t=0;t<e.length;t++)this._pickerChannels[t].value=e[t];this._fieldHex.value=this._getHex(),this._directInput=!0}}_openColorPicker(){this._callPicker(this.value.map((e=>Math.floor(255*e)))),this._evtColorPick=this.on("picker:color",(e=>{this.value=e.map((e=>e/255))})),this._evtColorPickStart=this.on("picker:color:start",(()=>{this.binding?(this._historyCombine=this.binding.historyCombine,this._historyPostfix=this.binding.historyPostfix,this.binding.historyCombine=!0,this._binding.historyPostfix=`(${Date.now()})`):(this._historyCombine=!1,this._historyPostfix=null)})),this._evtColorPickEnd=this.on("picker:color:end",(()=>{this.binding&&(this.binding.historyCombine=this._historyCombine,this.binding.historyPostfix=this._historyPostfix)}));const e=this._overlay.dom.getBoundingClientRect(),t=this.dom.getBoundingClientRect();this._setColorPickerPosition(t.left-e.left,t.bottom-e.top+1),this._evtColorToPicker=this.on("change",(()=>{this._setPickerColor(this.value.map((e=>Math.floor(255*e))))}))}_callPicker(e){for(let t=0;t<4;t++)e.length-1<t?this._overlay.class.remove(`c-${t+1}`):this._overlay.class.add(`c-${t+1}`);if(this._channelsNumber=e.length,this._channelsNumber>=3){const t=oe(e);this._colorHSV[0]=t[0],this._colorHSV[1]=t[1],this._colorHSV[2]=t[2]}this._directInput=!1;for(let t=0;t<e.length;t++)this._pickerChannels[t].value=e[t];this._fieldHex.value=this._getHex(),this._directInput=!0,this._overlay.hidden=!1,this._fieldHex.dom.focus(),window.setTimeout((()=>{this._fieldHex.dom.focus()}),100)}_valueToColor(e){return e=Math.floor(255*e),Math.max(0,Math.min(e,255))}_setValue(e){const t=this._valueToColor(e[0]),i=this._valueToColor(e[1]),s=this._valueToColor(e[2]),r=e[3];1===this._channels?this._domColor.style.backgroundColor=`rgb(${t}, ${t}, ${t})`:3===this._channels?this._domColor.style.backgroundColor=`rgb(${t}, ${i}, ${s})`:4===this._channels&&(this._domColor.style.backgroundColor=`rgba(${t}, ${i}, ${s}, ${r})`)}_updateValue(e){let t=!1;for(let i=0;i<e.length;i++)this._value[i]!==e[i]&&(t=!0,this._value[i]=e[i]);return this.class.remove(T),t&&(this._setValue(e),this.emit("change",e)),t}_getHex(){let e="";for(let t=0;t<this._channelsNumber;t++)e+=`00${this._pickerChannels[t].value.toString(16)}`.slice(-2).toUpperCase();return e}_onChangeHex(){if(!this._directInput)return;this._changing=!0;const e=this._fieldHex.value.trim().toLowerCase();if(/^([0-9a-f]{2}){3,4}$/.test(e))for(let t=0;t<this._channelsNumber;t++)this._pickerChannels[t].value=parseInt(e.slice(2*t,2*t+2),16);this._changing=!1}_onChangeRgb(){const e=this._pickerChannels.map((e=>e.value||0)).slice(0,this._channelsNumber),t=oe(e);if(this._directInput){const i=e[0]+e[1]+e[2];765!==i&&0!==i&&(this._colorHSV[0]=t[0]),this._colorHSV[1]=t[1],this._colorHSV[2]=t[2],this._dragging=!0,this.emit("picker:color:start"),this._fieldHex.value=this._getHex()}if(this._pickHueHandle.style.top=`${Math.floor(this._size*this._colorHSV[0])}px`,this._pickRectHandle.style.left=`${Math.max(4,Math.min(this._size-4,this._size*this._colorHSV[1]))}px`,this._pickRectHandle.style.top=`${Math.max(4,Math.min(this._size-4,this._size*(1-this._colorHSV[2])))}px`,this._channelsNumber>=3){const t=le([this._colorHSV[0],1,1]).join(",");this._pickRect.style.backgroundColor=`rgb(${t})`,this._pickRectHandle.style.backgroundColor=`rgb(${e.slice(0,3).join(",")})`,this._pickHueHandle.style.backgroundColor=`rgb(${t})`}this.callCallback()}_onChangeAlpha(e){4===this._channelsNumber&&(this._pickOpacityHandle.style.top=`${Math.floor(this._size*(1-Math.max(0,Math.min(255,e))/255))}px`,this._pickOpacityHandle.style.backgroundColor=`rgb(${e}, ${e}, ${e})`,this.callCallback())}callbackHandle(){this._callingCallback=!1,this.emit("picker:color",this._pickerChannels.map((e=>e.value||0)).slice(0,this._channelsNumber))}callCallback(){this._callingCallback||(this._callingCallback=!0,window.setTimeout((()=>{this.callbackHandle()}),1e3/60))}set value(e){e=e||[0,0,0,0];this._updateValue(e)&&this._binding&&this._binding.setValue(e)}get value(){return this._value.slice(0,this._channels)}set values(e){let t=!1;const i=e[0];for(let s=1;s<e.length;s++)if(Array.isArray(i)){if(!i.equals(e[s])){t=!0;break}}else if(i!==e[s]){t=!0;break}t?(this.value=null,this.class.add(T)):this.value=e[0]}set channels(e){this._channels!==e&&(this._channels=Math.max(0,Math.min(e,4)),this._setValue(this.value))}get channels(){return this._channels}set renderChanges(e){this._renderChanges=e}get renderChanges(){return this._renderChanges}};L.register("rgb",ge),L.register("rgba",ge,{channels:4});class ve extends M{constructor(e){super(e),this.elementClass=ge}render(){return d.createElement("div",{ref:this.attachElement})}}ve.ctor=ge;class _e extends M{constructor(e={}){super(e),this.getParent=()=>this,this.elementClass=N}componentDidMount(){this.props.onResize&&this.element.on("resize",this.props.onResize)}render(){const e=Array.from(d.Children.toArray(this.props.children));let t;return 1===e.length?t=d.cloneElement(e[0],{parent:this.element}):e.length>0&&(t=e.map((e=>d.cloneElement(e,{parent:this.element})))),d.createElement("div",{ref:this.attachElement},t)}}_e.ctor=N;const be=(e,t)=>{if(0===e.length)return t.length;if(0===t.length)return e.length;if(e===t)return 0;const i=[];for(let e=0;e<=t.length;e++)i[e]=[e];for(let t=0;t<=e.length;t++)i[0][t]=t;for(let s=1;s<=t.length;s++)for(let r=1;r<=e.length;r++)t.charAt(s-1)===e.charAt(r-1)?i[s][r]=i[s-1][r-1]:i[s][r]=Math.min(i[s-1][r-1]+1,Math.min(i[s][r-1]+1,i[s-1][r]+1));return i[t.length][e.length]},ye=(e,t)=>{if(e===t)return e.length;let i=0;const s=new Set;for(let e=0;e<t.length;e++)s.add(t.charAt(e));for(let t=0;t<e.length;t++)s.has(e.charAt(t))&&i++;return i},xe=e=>{const t=[],i=e.replace(/([^A-Z])([A-Z][^A-Z])/g,"$1 $2").replace(/([A-Z0-9]{2,})/g," $1").split(/([\s\-_])/);for(let e=0;e<i.length;e++)i[e]=i[e].toLowerCase().trim(),i[e]&&"-"!==i[e]&&"_"!==i[e]&&t.push(i[e]);return t},Se=(e,t,i)=>{const s=[];for(const r of e){if(r.subFull!==1/0){s.push(r),r.edits===1/0&&(r.edits=0),r.sub===1/0&&(r.sub=r.subFull);continue}if(r.name===t||0===r.name.indexOf(t)){s.push(r),r.edits===1/0&&(r.edits=0),r.sub===1/0&&(r.sub=0);continue}if(ye(t,r.name)/t.length<i.containsCharsTolerance)continue;let e=1/0,n=1/0;for(let s=0;s<r.tokens.length;s++){if(r.tokens[s]===t){e=0,n=s;break}const a=be(t,r.tokens[s]);(n===1/0||a<e)&&-1!==r.tokens[s].indexOf(t)?(n=s,e=a):n===1/0&&a<e&&a/Math.max(t.length,r.tokens[s].length)<=i.editsDistanceTolerance&&(e=a)}e!==1/0&&(s.push(r),r.edits=r.edits===1/0?e:r.edits+e,r.sub=r.sub===1/0?n:r.sub+n)}return s},we=(e,t,i="",s={})=>{var r,n;if(!(i=i.toLowerCase().trim()))return[];const a=xe(i);if(!a.length)return[];s.containsCharsTolerance=null!==(r=s.containsCharsTolerance)&&void 0!==r?r:.5,s.editsDistanceTolerance=null!==(n=s.editsDistanceTolerance)&&void 0!==n?n:.5;let o=e.map((e=>{const s=e[t].toLowerCase().trim().indexOf(i);return{name:e[t],item:e,tokens:xe(e[t]),edits:1/0,subFull:-1!==s?s:1/0,sub:1/0}}));for(let e=0;e<a.length;e++)o=Se(o,a[e],s);o.sort(((e,t)=>e.subFull!==t.subFull?e.subFull-t.subFull:e.sub!==t.sub?e.sub-t.sub:e.edits!==t.edits?e.edits-t.edits:e.name.length-t.name.length));let l=o.map((e=>e.item));return s.hasOwnProperty("limitResults")&&l.length>s.limitResults&&(l=l.slice(0,s.limitResults)),l},Te="pcui-select-input",Ce=`${Te}-container-value`,Ee=`${Te}-multi`,Ae=`${Te}-disabled-value`,Pe=`${Te}-has-disabled-value`,De=`${Te}-value`,Le=`${Te}-icon`,Me=`${Te}-textinput`,Ie=`${Te}-list`,Re=`${Te}-tags`,ke=`${Te}-tags-empty`,Oe=`${Te}-tag`,Fe=`${Te}-tag-not-everywhere`,Be=`${Te}-shadow`,Ne=`${Te}-fit-height`,ze="pcui-selected",Ue=`${Te}-label-highlighted`,Ve=`${Te}-create-new`,He="pcui-open";let Ge=class extends L{constructor(e={}){var t,i,s,r;const n=new N({dom:e.dom});super(Object.assign(Object.assign({},e),{dom:n.dom})),this._timeoutLabelValueTabIndex=null,this._valueToText={},this._valueToLabel={},this._labelToValue=new Map,this._labelHighlighted=null,this._disabledOptions={},this._prefix="",this._onInputChange=e=>{this._suspendInputChange||this._lastInputValue!==e&&(this.open(),this._lastInputValue=e,this._filterOptions(e))},this._onInputKeyDown=e=>{if("Enter"===e.key&&this.enabled&&!this.readOnly){let t;if(e.stopPropagation(),e.preventDefault(),t=this._labelHighlighted&&this._labelToValue.has(this._labelHighlighted)?this._labelToValue.get(this._labelHighlighted):this._input.value,void 0!==t)return this.focus(),this.close(),void(this._valueToText[t]?this._onSelectValue(t):this._allowCreate&&(this._createFn?this._createFn(t):this._onSelectValue(t)))}this._onKeyDown(e)},this._onDocumentPointerDown=e=>{this.dom.contains(e.composedPath()[0])||this.close()},this._onKeyDown=e=>{if("Escape"!==e.key)if("Tab"!==e.key){if(this.enabled&&!this.readOnly)if("Enter"!==e.key||this._allowInput){if("ArrowUp"===e.key||"ArrowDown"===e.key)if(e.stopPropagation(),e.preventDefault(),(this._allowInput||this.multiSelect)&&this._containerOptions.hidden)this.open();else if(this._containerOptions.hidden){if(!this._options.length)return;let t=-1;for(let e=0;e<this._options.length;e++)if(this._options[e].v===this.value){t=e;break}"ArrowUp"===e.key?t--:"ArrowDown"===e.key&&t++,t>=0&&t<this._options.length&&this._onSelectValue(this._options[t].v)}else{if(!this._containerOptions.dom.childNodes.length)return;if(this._labelHighlighted){let t=this._labelHighlighted.dom;do{"ArrowUp"===e.key?t=t.previousSibling:"ArrowDown"===e.key&&(t=t.nextSibling)}while(t&&t.ui.hidden);t&&this._highlightLabel(t.ui)}else this._highlightLabel(this._containerOptions.dom.childNodes[0].ui)}}else this._labelHighlighted&&this._labelToValue.has(this._labelHighlighted)&&(this._onSelectValue(this._labelToValue.get(this._labelHighlighted)),this.close())}else this.close();else this.close()},this._onPointerDown=()=>{this._allowInput||this.focus()},this._onFocus=()=>{this.class.add(b),this.emit("focus"),this._input.hidden||this.open()},this._onBlur=()=>{this.class.remove(b),this.emit("blur")},this._onWheel=e=>{e.stopPropagation()},this._container=n,this._container.parent=this,this.class.add(Te),this._containerValue=new N({class:Ce}),this._container.append(this._containerValue),this._domShadow=document.createElement("div"),this._domShadow.classList.add(Be),this._containerValue.append(this._domShadow),this._allowInput=e.allowInput,this._allowInput&&this.class.add("pcui-select-input-allow-input"),this._allowCreate=e.allowCreate,this._createFn=e.createFn,this._createLabelText=e.createLabelText,this._labelValue=new q({class:De,tabIndex:0}),this._labelValue.on("click",(()=>{this.enabled&&!this.readOnly&&this.toggle()})),this._containerValue.append(this._labelValue),this._labelIcon=new q({class:Le,hidden:e.allowInput&&e.multiSelect}),this._containerValue.append(this._labelIcon),this._input=new me({class:Me,blurOnEnter:!1,keyChange:!0}),this._containerValue.append(this._input),this._lastInputValue="",this._suspendInputChange=!1,this._input.on("change",this._onInputChange),this._input.on("keydown",this._onInputKeyDown),this._input.on("focus",this._onFocus),this._input.on("blur",this._onBlur),e.placeholder&&(this.placeholder=e.placeholder),this._containerOptions=new N({class:Ie,hidden:!0}),this._containerValue.append(this._containerOptions),this._containerTags=new N({class:Re,flex:!0,flexDirection:"row",hidden:!0}),this._container.append(this._containerTags),e.multiSelect&&(this.class.add(Ee),this._containerTags.hidden=!1),this._labelValue.dom.addEventListener("keydown",this._onKeyDown),this._labelValue.dom.addEventListener("focus",this._onFocus),this._labelValue.dom.addEventListener("blur",this._onBlur),this._labelValue.dom.addEventListener("pointerdown",this._onPointerDown),this._containerOptions.dom.addEventListener("wheel",this._onWheel,{passive:!0}),this.on("hide",(()=>{this.close()})),this._type=null!==(t=e.type)&&void 0!==t?t:"string",this.invalidOptions=null!==(i=e.invalidOptions)&&void 0!==i?i:[],this.options=null!==(s=e.options)&&void 0!==s?s:[],this._optionsFn=e.optionsFn,this._allowNull=e.allowNull,this._values=null,void 0!==e.value?this.value=e.value:e.defaultValue?this.value=e.defaultValue:this.value=null,this._renderChanges=e.renderChanges,this.on("change",(()=>{this._updateInputFieldsVisibility(),this.renderChanges&&!this.multiSelect&&this._labelValue.flash()})),this._updateInputFieldsVisibility(!1),this._onSelect=e.onSelect,this.fallbackOrder=e.fallbackOrder,this.disabledOptions=e.disabledOptions,this._prefix=null!==(r=e.prefix)&&void 0!==r?r:""}destroy(){this._destroyed||(this._labelValue.dom.removeEventListener("keydown",this._onKeyDown),this._labelValue.dom.removeEventListener("pointerdown",this._onPointerDown),this._labelValue.dom.removeEventListener("focus",this._onFocus),this._labelValue.dom.removeEventListener("blur",this._onBlur),this._containerOptions.dom.removeEventListener("wheel",this._onWheel),window.removeEventListener("keydown",this._onKeyDown),document.removeEventListener("pointerdown",this._onDocumentPointerDown),this._timeoutLabelValueTabIndex&&(cancelAnimationFrame(this._timeoutLabelValueTabIndex),this._timeoutLabelValueTabIndex=null),super.destroy())}_initializeCreateLabel(){const e=new N({class:Ve,flex:!0,flexDirection:"row"}),t=new q({text:this._input.value,tabIndex:-1});e.append(t);let i=this._input.on("change",(i=>{t.destroyed||(t.text=i,this.invalidOptions&&-1!==this.invalidOptions.indexOf(i)?e.hidden||(e.hidden=!0,this._resizeShadow()):e.hidden&&(e.hidden=!1,this._resizeShadow()))}));e.on("click",(e=>{e.stopPropagation();const i=t.text;this.focus(),this.close(),this._createFn?this._createFn(i):i&&this._onSelectValue(i)})),t.on("destroy",(()=>{i.unbind(),i=null}));const s=new q({text:this._createLabelText});return e.append(s),this._containerOptions.append(e),e}_convertSingleValue(e){if(null===e&&this._allowNull)return e;if("string"===this._type)e=e?e.toString():"";else if("number"===this._type)e=e?parseInt(e,10):0;else if("boolean"===this._type)return!!e;return e}_convertValue(e){return null===e&&this._allowNull?e:this.multiSelect?Array.isArray(e)?e.map((e=>this._convertSingleValue(e))):e:this._convertSingleValue(e)}_onSelectValue(e){if(e=this._convertSingleValue(e),this.multiSelect)if(this._values){let t=!1;this._values.forEach((i=>{i?-1===i.indexOf(e)&&(i.push(e),t=!0):(i=[e],t=!0)})),t&&(this._onMultipleValuesChange(this._values),this.emit("change",this.value),this._binding&&this._binding.addValues([e]))}else this._value&&Array.isArray(this._value)?-1===this._value.indexOf(e)&&(this._value.push(e),this._addTag(e),this.emit("change",this.value),this._binding&&this._binding.addValues([e])):this.value=[e];else this.value=e}_highlightLabel(e){if(this._labelHighlighted!==e&&(this._labelHighlighted&&this._labelHighlighted.class.remove(Ue),this._labelHighlighted=e,this._labelHighlighted)){this._labelHighlighted.class.add(Ue);const e=this._labelHighlighted.dom.offsetTop,t=this._containerOptions.dom.scrollTop;e<t?this._containerOptions.dom.scrollTop=e:e+this._labelHighlighted.height>this._containerOptions.height+t&&(this._containerOptions.dom.scrollTop=e+this._labelHighlighted.height-this._containerOptions.height)}}_onValueChange(e){if(this.multiSelect){if(this._labelValue.value="",this._containerTags.clear(),this._containerTags.class.add(ke),e&&Array.isArray(e)){for(const t of e){this._addTag(t);const e=this._valueToLabel[String(t)];e&&e.class.add(ze)}for(const t in this._valueToLabel){const i=this._valueToLabel[t];-1!==e.indexOf(this._convertSingleValue(t))?i.class.add(ze):i.class.remove(ze)}}}else{this._labelValue.value=this._prefix+(this._valueToText[String(e)]||""),e=String(e);for(const t in this._valueToLabel){const i=this._valueToLabel[t];t===e?i.class.add(ze):i.class.remove(ze)}}}_onMultipleValuesChange(e){this._labelValue.value="",this._containerTags.clear(),this._containerTags.class.add(ke);const t={},i={};e.forEach((e=>{e&&e.forEach((e=>{t[e]?i[e]++:(t[e]=this._addTag(e),i[e]=1)}))}));for(const s in i)if(i[s]!==e.length){t[s].class.add(Fe);const e=this._valueToLabel[String(s)];e&&e.class.remove(ze)}}_addTag(e){const t=new N({flex:!0,flexDirection:"row",class:Oe});t.append(new q({text:this._valueToText[String(e)]||e}));const i=new I({size:"small",icon:"E132",tabIndex:-1});t.append(i),i.on("click",(()=>this._removeTag(t,String(e)))),this._containerTags.append(t),this._containerTags.class.remove(ke);const s=this._valueToLabel[String(e)];return s&&s.class.add(ze),t.value=e,t}_removeTag(e,t){e.destroy();const i=this._valueToLabel[String(t)];if(i&&i.class.remove(ze),this._values)this._values.forEach((e=>{if(!e)return;const i=e.indexOf(t);-1!==i&&e.splice(i,1)}));else if(this._value&&Array.isArray(this._value)){const e=this._value.indexOf(t);-1!==e&&this._value.splice(e,1)}this.emit("change",this.value),this._binding&&this._binding.removeValues([t])}_filterOptions(e){const t=this._containerOptions.dom;for(;t.firstChild;)t.removeChild(t.lastChild);if(e){we(this._options,"t",e).forEach((e=>{const i=this._valueToLabel[String(e.v)];t.appendChild(i.dom)}))}else for(const e of this._options){const i=this._valueToLabel[String(e.v)];t.appendChild(i.dom)}this._createLabelContainer&&t.appendChild(this._createLabelContainer.dom),t.firstChild&&this._highlightLabel(t.firstChild.ui),this._resizeShadow()}_resizeShadow(){this._domShadow.style.height=`${this._containerValue.height+this._containerOptions.height}px`}_updateInputFieldsVisibility(e){let t=!1,i=!1;this._allowInput&&(e?(t=!0,i=!0):t=this.multiSelect||!this._valueToLabel[this.value]),this._labelValue.hidden=t,this._labelIcon.hidden=t,this._input.hidden=!t,i&&this._input.focus(),this._labelValue.hidden||(this._labelValue.tabIndex=-1,this._timeoutLabelValueTabIndex||(this._timeoutLabelValueTabIndex=requestAnimationFrame((()=>{this._timeoutLabelValueTabIndex=null,this._labelValue.tabIndex=0}))))}focus(){this._input.hidden?this._labelValue.dom.focus():this._input.focus()}blur(){this._allowInput?this._input.blur():this._labelValue.dom.blur()}open(){if(!this._containerOptions.hidden||!this.enabled||this.readOnly)return;if(this._updateInputFieldsVisibility(!0),this._optionsFn&&(this.options=this._optionsFn()),0===this._containerOptions.dom.childNodes.length)return;this._containerOptions.forEachChild((e=>{e.hidden=!1,this._labelToValue.get(e)===this.value&&this._highlightLabel(e)})),this._labelHighlighted||this._highlightLabel(this._containerOptions.dom.childNodes[0].ui),this._containerOptions.hidden=!1,this.class.add(He),window.addEventListener("keydown",this._onKeyDown),document.addEventListener("pointerdown",this._onDocumentPointerDown);const e=(this._allowInput?this._input.dom:this._labelValue.dom).getBoundingClientRect();let t=e.bottom+this._containerOptions.height+25>=window.innerHeight;t&&e.top-this._containerOptions.height<0&&(t=!1,this._containerOptions.style.maxHeight=window.innerHeight-e.bottom-25+"px"),t?this.class.add(Ne):this.class.remove(Ne),this._resizeShadow()}close(){this._containerOptions.style.maxHeight="",this._highlightLabel(null),this._updateInputFieldsVisibility(!1),this._suspendInputChange=!0,this._input.value="",this._lastInputValue&&(this._lastInputValue="",this._filterOptions(null)),this._suspendInputChange=!1,this._containerOptions.hidden||(this._containerOptions.hidden=!0,this._domShadow.style.height="",this.class.remove(He),window.removeEventListener("keydown",this._onKeyDown),document.removeEventListener("pointerdown",this._onDocumentPointerDown))}toggle(){this._containerOptions.hidden?this.open():this.close()}unlink(){super.unlink(),this._containerOptions.hidden||this.close()}_updateValue(e){e!==this._value&&(this._value=e,this._onValueChange(e),this._suppressChange||this.emit("change",e),this._binding&&this._binding.setValue(e))}_updateDisabledValue(e){const t={};this._containerOptions.forEachChild((e=>{t[e.dom.id]=e,this._disabledOptions[e.dom.id]?(e.enabled=!1,e.text=this._disabledOptions[e.dom.id]):(e.enabled=!0,e.text=this._valueToText[e.dom.id]),e.class.remove(Ae)}));const i=this._disabledOptions[e]?e:null;let s=null;if(i){if(this._fallbackOrder)for(let t=0;t<this._fallbackOrder.length;t++)if(this._fallbackOrder[t]!==e){s=this._fallbackOrder[t];break}this.disabledValue=i,t[i].class.add(Ae)}else this._disabledValue?(s=this._disabledValue,this.disabledValue=null):(s=e,this.disabledValue=null);return s}set options(e){if(!this._options||JSON.stringify(this._options)!==JSON.stringify(e)){this._containerOptions.clear(),this._labelHighlighted=null,this._valueToText={},this._valueToLabel={},this._options=e;for(const e of this._options){if(this._valueToText[String(e.v)]=e.t,""===e.v)return;const t=new q({text:e.t,tabIndex:-1,id:String(e.v)});this._labelToValue.set(t,e.v),this._valueToLabel[String(e.v)]=t,t.on("click",(t=>{t.stopPropagation(),this._onSelectValue(e.v),this.close(),this._onSelect&&this._onSelect(this.value)})),this._containerOptions.append(t)}this._createLabelContainer=null,this._createLabelText&&(this._createLabelContainer=this._initializeCreateLabel()),this.multiSelect&&this._values?this._onMultipleValuesChange(this._values):this._onValueChange(this.value),this._lastInputValue&&this._filterOptions(this._lastInputValue)}}get options(){return this._options.slice()}set invalidOptions(e){this._invalidOptions=e||null}get invalidOptions(){return this._invalidOptions}set disabledValue(e){this._disabledValue=e,null!==this._disabledValue?this.class.add(Pe):this.class.remove(Pe)}set disabledOptions(e){if(JSON.stringify(this._disabledOptions)===JSON.stringify(e))return;this._disabledOptions=e||{};const t=this._updateDisabledValue(this._value);this._updateValue(t)}set fallbackOrder(e){this._fallbackOrder=e||null}get multiSelect(){return this.class.contains(Ee)}set value(e){this._values=null,this._suspendInputChange=!0,this._input.value="",this._lastInputValue&&(this._lastInputValue="",this._filterOptions(null)),this._suspendInputChange=!1,this.class.remove(T),e=this._convertValue(e),(!(this._value===e||this.multiSelect&&this._value&&this._value.equals(e))||null===e&&this._allowNull&&this.class.contains(T))&&(this.disabledValue=null,this._updateValue(e))}get value(){if(!this.multiSelect)return this._value;const e=[];return this._containerTags.dom.childNodes.forEach((t=>{e.push(t.ui.value)})),e}set values(e){e=e.map((e=>this._convertValue(e)));let t=!1;const i=e[0],s=this.multiSelect;this._values=null;for(let r=1;r<e.length;r++)if(!(e[r]===i||s&&e[r]&&e[r].equals(i))){t=!0;break}t?(this._labelValue.values=e,s?(this._values=e,this._value=null,this._onMultipleValuesChange(this._values),this.emit("change",this.value)):null!==this._value&&(this._value=null,this.emit("change",null)),this.class.add(T)):this.value=e[0]}set placeholder(e){this._input.placeholder=e}get placeholder(){return this._input.placeholder}set renderChanges(e){this._renderChanges=e}get renderChanges(){return this._renderChanges}};L.register("select",Ge,{renderChanges:!0}),L.register("multiselect",Ge,{multiSelect:!0,renderChanges:!0}),L.register("tags",Ge,{allowInput:!0,allowCreate:!0,multiSelect:!0,renderChanges:!0});let We=class extends N{constructor(e={}){var t,i,s,r;super(e),this._titleElement=new L,this._textElement=new L,this.class.add("pcui-infobox"),this.append(this._titleElement),this.append(this._textElement),this._unsafe=null!==(t=e.unsafe)&&void 0!==t&&t,this.icon=null!==(i=e.icon)&&void 0!==i?i:"",this.title=null!==(s=e.title)&&void 0!==s?s:"",this.text=null!==(r=e.text)&&void 0!==r?r:""}set icon(e){this._icon!==e&&(this._icon=e,e?this.dom.setAttribute("data-icon",String.fromCodePoint(parseInt(e,16))):this.dom.removeAttribute("data-icon"))}get icon(){return this._icon}set title(e){this._title!==e&&(this._title=e,this._unsafe?this._titleElement.dom.innerHTML=e:this._titleElement.dom.textContent=e)}get title(){return this._title}set text(e){this._text!==e&&(this._text=e,this._unsafe?this._textElement.dom.innerHTML=e:this._textElement.dom.textContent=e)}get text(){return this._text}};L.register("infobox",We);class je extends M{constructor(e){super(e),this.elementClass=We}render(){return d.createElement("span",{ref:this.attachElement})}}je.ctor=We;class qe extends M{constructor(e={}){super(e),this.elementClass=q}render(){return d.createElement("span",{ref:this.attachElement})}}qe.ctor=q;class Xe extends M{constructor(e){super(e),this.elementClass=j}render(){return super.render()}}Xe.ctor=j;class Ke extends M{constructor(e={}){super(e),this.elementClass=ee}componentDidMount(){this.attachElement(this.nodeElement,this.containerElement)}render(){let e=d.Children.toArray(this.props.children);return 1===e.length?e=d.cloneElement(e[0],{parent:this.element}):e.length>0&&(e=e.map((e=>d.cloneElement(e,{parent:this.element})))),d.createElement("div",{ref:e=>{this.nodeElement=e}},d.createElement("div",{ref:e=>{this.containerElement=e}},e))}}Ke.ctor=ee;class Ye extends M{constructor(e){super(e),this.elementClass=Ge,this.onSelect=e.onSelect,this.onAttach=this.onAttachFn.bind(this)}onAttachFn(){this.props.onSelect&&this.element.on("select",this.onSelect)}render(){return super.render()}}var Qe;Ye.ctor=Ge;const Je="pcui-slider",$e=`${Je}-container`,Ze=`${Je}-bar`,et=`${Je}-handle`,tt=`${Je}-active`,it=/Chrome\//.test(null===(Qe=globalThis.navigator)||void 0===Qe?void 0:Qe.userAgent);let st=class extends L{constructor(e={}){var t,i,s,r,n;super(e),this._historyCombine=!1,this._historyPostfix=null,this._cursorHandleOffset=0,this._pointerId=null,this._onPointerDown=e=>{"mouse"===e.pointerType&&0!==e.button||!this.enabled||this.readOnly||null!==this._pointerId||(e.stopPropagation(),this._domSlider.setPointerCapture(e.pointerId),this._pointerId=e.pointerId,this._onSlideStart(e.pageX))},this._onPointerMove=e=>{e.pointerId===this._pointerId&&(e.stopPropagation(),e.preventDefault(),this._onSlideMove(e.pageX))},this._onPointerUp=e=>{e.pointerId===this._pointerId&&null!==this._pointerId&&(e.stopPropagation(),this._domSlider.releasePointerCapture(e.pointerId),this._onSlideEnd(e.pageX),this._pointerId=null)},this._onKeyDown=e=>{if("Escape"===e.key)return void this.blur();if(!this.enabled||this.readOnly)return;if("ArrowLeft"!==e.key&&"ArrowRight"!==e.key)return;e.stopPropagation(),e.preventDefault();let t="ArrowLeft"===e.key?-1:1;e.shiftKey&&(t*=10),this.value+=t*this.step},this.class.add(Je);const a=new j({allowNull:e.allowNull,hideSlider:!0,min:e.min,max:e.max,keyChange:e.keyChange,placeholder:e.placeholder,precision:null!==(t=e.precision)&&void 0!==t?t:2,renderChanges:e.renderChanges,step:e.step});a.on("change",(e=>{this._onValueChange(e)})),a.on("focus",(()=>{this.emit("focus")})),a.on("blur",(()=>{this.emit("blur")})),a.parent=this,this.dom.appendChild(a.dom),this._numericInput=a,this._sliderMin=null!==(s=null!==(i=e.sliderMin)&&void 0!==i?i:e.min)&&void 0!==s?s:0,this._sliderMax=null!==(n=null!==(r=e.sliderMax)&&void 0!==r?r:e.max)&&void 0!==n?n:1,this._domSlider=document.createElement("div"),this._domSlider.classList.add($e),this.dom.appendChild(this._domSlider),this._domBar=document.createElement("div"),this._domBar.classList.add(Ze),this._domBar.ui=this,this._domSlider.appendChild(this._domBar),this._domHandle=document.createElement("div"),this._domHandle.ui=this,this._domHandle.tabIndex=0,this._domHandle.classList.add(et),this._domBar.appendChild(this._domHandle),this._domSlider.addEventListener("pointerdown",this._onPointerDown),this._domHandle.addEventListener("keydown",this._onKeyDown),void 0!==e.value&&(this.value=e.value),void 0!==e.values&&(this.values=e.values),0===this.value&&this._updateHandle(0)}destroy(){this._destroyed||(this._domSlider.removeEventListener("pointerdown",this._onPointerDown),this._domHandle.removeEventListener("keydown",this._onKeyDown),super.destroy())}_updateHandle(e){const t=100*Math.max(0,Math.min(1,((e||0)-this._sliderMin)/(this._sliderMax-this._sliderMin))),i=this._domHandle.getBoundingClientRect().width;this._domHandle.style.left=`calc(${t}% + ${i/2}px)`}_onValueChange(e){this._updateHandle(e),this._suppressChange||this.emit("change",e),this._binding&&this._binding.setValue(e)}_calculateCursorHandleOffset(e){const t=it?2:0,i=this._domHandle.getBoundingClientRect(),s=i.left-t,r=i.right;return this._cursorHandleOffset=e>=s&&e<=r?e-(s+(r-s)/2):0,this._cursorHandleOffset}_onSlideStart(e){this._domHandle.focus(),this._domSlider.addEventListener("pointermove",this._onPointerMove),this._domSlider.addEventListener("pointerup",this._onPointerUp),this.class.add(tt),this._calculateCursorHandleOffset(e)||this._onSlideMove(e),this.binding&&(this._historyCombine=this.binding.historyCombine,this._historyPostfix=this.binding.historyPostfix,this.binding.historyCombine=!0,this.binding.historyPostfix=`(${Date.now()})`)}_onSlideMove(e){const t=this._domBar.getBoundingClientRect();e-=this._cursorHandleOffset;let i=Math.max(0,Math.min(1,(e-t.left)/t.width))*(this._sliderMax-this._sliderMin)+this._sliderMin;i=parseFloat(i.toFixed(this.precision)),this.value=i}_onSlideEnd(e){this._calculateCursorHandleOffset(e)||this._onSlideMove(e),this.class.remove(tt),this._domSlider.removeEventListener("pointermove",this._onPointerMove),this._domSlider.removeEventListener("pointerup",this._onPointerUp),this.binding&&(this.binding.historyCombine=this._historyCombine,this.binding.historyPostfix=this._historyPostfix,this._historyCombine=!1,this._historyPostfix=null)}focus(){this._numericInput.focus()}blur(){this._domHandle.blur(),this._numericInput.blur()}set sliderMin(e){this._sliderMin!==e&&(this._sliderMin=e,this._updateHandle(this.value))}get sliderMin(){return this._sliderMin}set sliderMax(e){this._sliderMax!==e&&(this._sliderMax=e,this._updateHandle(this.value))}get sliderMax(){return this._sliderMax}set value(e){this._numericInput.value=e,this._numericInput.class.contains(T)?this.class.add(T):this.class.remove(T)}get value(){return this._numericInput.value}set values(e){this._numericInput.values=e,this._numericInput.class.contains(T)?this.class.add(T):this.class.remove(T)}set renderChanges(e){this._numericInput.renderChanges=e}get renderChanges(){return this._numericInput.renderChanges}set min(e){this._numericInput.min=e}get min(){return this._numericInput.min}set max(e){this._numericInput.max=e}get max(){return this._numericInput.max}set step(e){this._numericInput.step=e}get step(){return this._numericInput.step}set precision(e){this._numericInput.precision=e}get precision(){return this._numericInput.precision}set keyChange(e){this._numericInput.keyChange=e}get keyChange(){return this._numericInput.keyChange}set placeholder(e){this._numericInput.placeholder=e}get placeholder(){return this._numericInput.placeholder}};L.register("slider",st,{renderChanges:!0});class rt extends M{constructor(e){super(e),this.elementClass=st}render(){return super.render()}}rt.ctor=st;let nt=class e extends L{constructor(t={}){var i,s;if((null!==(i=t.type)&&void 0!==i?i:"small-thick")===e.TYPE_SMALL_THICK){const e=function(e,t){const i=t||document.createElementNS("http://www.w3.org/2000/svg","svg");return i.classList.add("spin"),i.setAttribute("width",e),i.setAttribute("height",e),i.setAttribute("viewBox","0 0 14 14"),i.setAttribute("fill","none"),i.innerHTML='<path d="M7 14C3.13871 14 0 10.8613 0 7C0 3.13871 3.13871 0 7 0C10.8613 0 14 3.13871 14 7C14 10.8613 10.8613 14 7 14ZM7 2.25806C4.38064 2.25806 2.25806 4.38064 2.25806 7C2.25806 9.61935 4.38064 11.7419 7 11.7419C9.61935 11.7419 11.7419 9.61935 11.7419 7C11.7419 4.38064 9.61935 2.25806 7 2.25806Z" fill="#773417"/><path class="pcui-spinner-highlight" d="M7 14V11.7419C9.61935 11.7419 11.7419 9.61935 11.7419 7H14C14 10.8613 10.8613 14 7 14Z" fill="#FF6600"/>',i}(null!==(s=t.size)&&void 0!==s?s:12,t.dom);t=Object.assign(Object.assign({},t),{dom:e})}super(t),this.class.add("pcui-spinner")}};nt.TYPE_SMALL_THICK="small-thick";class at extends M{constructor(e){super(e),this.elementClass=nt}render(){return d.createElement("svg",{ref:this.attachElement})}}at.ctor=nt;class ot extends M{constructor(e={}){super(e),this.elementClass=me,e.onValidate&&(this.onValidate=e.onValidate),this.onAttach=this.onAttachFn.bind(this)}onAttachFn(){this.onValidate&&(this.element.onValidate=this.onValidate)}render(){return super.render()}}ot.ctor=me;const lt="pcui-treeview-item",ht=`${lt}-icon`,ct=`${lt}-text`,dt=`${lt}-selected`,ut=`${lt}-open`,ft=`${lt}-contents`,pt=`${lt}-empty`,mt=`${lt}-rename`;let gt=class e extends N{constructor(e={}){var t,i,s,r,n;super(e),this.allowDrop=!0,this.allowDrag=!0,this.allowSelect=!0,this._numChildren=0,this._open=!1,this._onContentKeyDown=e=>{"INPUT"!==e.target.tagName&&this.allowSelect&&this._treeView&&this._treeView._onChildKeyDown(e,this)},this._onContentMouseDown=e=>{this._treeView&&this._treeView.allowDrag&&this.allowDrag&&(this._treeView._updateModifierKeys(e),e.stopPropagation())},this._onContentMouseUp=e=>{e.stopPropagation(),e.preventDefault(),window.removeEventListener("mouseup",this._onContentMouseUp),this._treeView&&this._treeView._onChildDragEnd(e,this)},this._onContentMouseOver=e=>{e.stopPropagation(),this._treeView&&this._treeView._onChildDragOver(e,this),this.emit("hover",e)},this._onContentDragStart=e=>{e.stopPropagation(),e.preventDefault(),this._treeView&&this._treeView.allowDrag&&(this.class.contains(mt)||(this._treeView._onChildDragStart(e,this),window.addEventListener("mouseup",this._onContentMouseUp)))},this._onContentClick=e=>{if(!this.allowSelect||0!==e.button)return;if("INPUT"===e.target.tagName)return;e.stopPropagation();const t=this._containerContents.dom.getBoundingClientRect();this._numChildren>0&&e.clientX-t.left<0?(this.open=!this.open,e.altKey&&this._dfs((e=>{e.open=this.open})),this.focus()):this._treeView&&this._treeView._onChildClick(e,this)},this._onContentDblClick=e=>{if(!this._treeView||!this._treeView.allowRenaming||0!==e.button)return;if("INPUT"===e.target.tagName)return;e.stopPropagation();const t=this._containerContents.dom.getBoundingClientRect();this.numChildren&&e.clientX-t.left<0||(this.allowSelect&&(this._treeView.deselect(),this._treeView._onChildClick(e,this)),this.rename())},this._onContentContextMenu=e=>{this._treeView&&this._treeView._onContextMenu&&this._treeView._onContextMenu(e,this)},this._onContentFocus=e=>{this.emit("focus")},this._onContentBlur=e=>{this.emit("blur")},this.class.add(lt,pt),this._containerContents=new N({class:ft,flex:!0,flexDirection:"row",tabIndex:0}),this.append(this._containerContents),this._containerContents.dom.draggable=!0,this._labelIcon=new q({class:ht}),this._containerContents.append(this._labelIcon),this.icon=null!==(t=e.icon)&&void 0!==t?t:"E360",this._labelText=new q({class:ct}),this._containerContents.append(this._labelText),this.allowSelect=null===(i=e.allowSelect)||void 0===i||i,this.allowDrop=null===(s=e.allowDrop)||void 0===s||s,this.allowDrag=null===(r=e.allowDrag)||void 0===r||r,e.text&&(this.text=e.text),e.selected&&(this.selected=e.selected),this._open=null!==(n=e.open)&&void 0!==n&&n;const a=this._containerContents.dom;a.addEventListener("focus",this._onContentFocus),a.addEventListener("blur",this._onContentBlur),a.addEventListener("keydown",this._onContentKeyDown),a.addEventListener("dragstart",this._onContentDragStart),a.addEventListener("mousedown",this._onContentMouseDown),a.addEventListener("mouseover",this._onContentMouseOver),a.addEventListener("click",this._onContentClick),a.addEventListener("dblclick",this._onContentDblClick),a.addEventListener("contextmenu",this._onContentContextMenu)}destroy(){if(this._destroyed)return;const e=this._containerContents.dom;e.removeEventListener("focus",this._onContentFocus),e.removeEventListener("blur",this._onContentBlur),e.removeEventListener("keydown",this._onContentKeyDown),e.removeEventListener("dragstart",this._onContentDragStart),e.removeEventListener("mousedown",this._onContentMouseDown),e.removeEventListener("mouseover",this._onContentMouseOver),e.removeEventListener("click",this._onContentClick),e.removeEventListener("dblclick",this._onContentDblClick),e.removeEventListener("contextmenu",this._onContentContextMenu),window.removeEventListener("mouseup",this._onContentMouseUp),super.destroy()}_onAppendChild(t){super._onAppendChild(t),t instanceof e&&(this._numChildren++,this.class.remove(pt),this._open&&this.class.add(ut),this._treeView&&this._treeView._onAppendTreeViewItem(t))}_onRemoveChild(t){t instanceof e&&(this._numChildren--,0===this._numChildren&&this.class.add(pt),this._treeView&&this._treeView._onRemoveTreeViewItem(t)),super._onRemoveChild(t)}_dfs(e){e(this);let t=this.firstChild;for(;t;)t._dfs(e),t=t.nextSibling}rename(){this.class.add(mt);const e=new me({renderChanges:!1,value:this.text,class:y});e.on("blur",(()=>{e.destroy()})),e.on("destroy",(()=>{this.class.remove(mt),this.focus()})),e.on("change",(t=>{(t=t.trim())&&(this.text=t,e.destroy())})),e.on("disable",(()=>{e.input.removeAttribute("readonly")})),this._containerContents.append(e),e.focus(!0)}focus(){this._containerContents.dom.focus()}blur(){this._containerContents.dom.blur()}set selected(e){e!==this.selected?e?(this._containerContents.class.add(dt),this.emit("select",this),this._treeView&&this._treeView._onChildSelected(this),this.focus()):(this._containerContents.class.remove(dt),this.blur(),this.emit("deselect",this),this._treeView&&this._treeView._onChildDeselected(this)):e&&this.focus()}get selected(){return this._containerContents.class.contains(dt)}set text(e){this._labelText.value!==e&&(this._labelText.value=e,this._treeView&&this._treeView._onChildRename(this,e))}get text(){return this._labelText.value}get textLabel(){return this._labelText}get iconLabel(){return this._labelIcon}set open(e){if(this._open!==e)if(this._open=e,e){if(!this.numChildren)return;this.class.add(ut),this.emit("open",this)}else this.class.remove(ut),this.emit("close",this)}get open(){return this._open}set parentsOpen(t){let i=this.parent;for(;i&&i instanceof e;)i.open=t,i=i.parent}get parentsOpen(){let t=this.parent;for(;t&&t instanceof e;){if(!t.open)return!1;t=t.parent}return!0}set treeView(e){this._treeView=e}get treeView(){return this._treeView}get numChildren(){return this._numChildren}get firstChild(){if(this._numChildren)for(const t of this.dom.childNodes)if(t.ui instanceof e)return t.ui;return null}get lastChild(){if(this._numChildren)for(let t=this.dom.childNodes.length-1;t>=0;t--)if(this.dom.childNodes[t].ui instanceof e)return this.dom.childNodes[t].ui;return null}get nextSibling(){let t=this.dom.nextSibling;for(;t&&!(t.ui instanceof e);)t=t.nextSibling;return t&&t.ui}get previousSibling(){let t=this.dom.previousSibling;for(;t&&!(t.ui instanceof e);)t=t.previousSibling;return t&&t.ui}set icon(e){this._icon!==e&&e.match(/^E\d{0,4}$/)&&(this._icon=e,e?this._labelIcon.dom.setAttribute("data-icon",String.fromCodePoint(parseInt(e,16))):this._labelIcon.dom.removeAttribute("data-icon"))}get icon(){return this._icon}};gt.EVENT_SELECT="select",gt.EVENT_DESELECT="deselect",gt.EVENT_OPEN="open",gt.EVENT_CLOSE="close";const vt="pcui-treeview",_t=`${vt}-item-dragged`,bt=`${vt}-drag-handle`,yt=`${vt}-filtering`,xt=`${yt}-result`,St="inside",wt="before",Tt="after";let Ct=class extends N{constructor(e={}){var t,i,s,r;super(e),this.allowReordering=!0,this.allowRenaming=!1,this._selectedItems=[],this._dragItems=[],this._dragging=!1,this._dragOverItem=null,this._dragArea=St,this._dragScroll=0,this._dragScrollInterval=null,this._pressedCtrl=!1,this._pressedShift=!1,this._filter=null,this._filterResults=[],this._updateModifierKeys=e=>{this._pressedCtrl=e.ctrlKey||e.metaKey,this._pressedShift=e.shiftKey},this._onMouseLeave=e=>{this._allowDrag&&this._dragging&&(this._dragOverItem=null,this._updateDragHandle())},this._onMouseMove=e=>{if(!this._dragging)return;const t=this.dom.getBoundingClientRect();this._dragScroll=0;let i=t.top,s=t.bottom;if(this._dragScrollElement!==this){const e=this._dragScrollElement.dom.getBoundingClientRect();i=Math.max(i+this._dragScrollElement.dom.scrollTop,e.top),s=Math.min(s+this._dragScrollElement.dom.scrollTop,e.bottom)}i=Math.max(0,i),s=Math.min(s,document.body.clientHeight),e.pageY<i+32&&this._dragScrollElement.dom.scrollTop>0?this._dragScroll=-1:e.pageY>s-32&&this._dragScrollElement.dom.scrollHeight>this._dragScrollElement.height+this._dragScrollElement.dom.scrollTop&&(this._dragScroll=1)},this._onDragMove=e=>{if(e.preventDefault(),e.stopPropagation(),!this._allowDrag||!this._dragOverItem)return;const t=this._dragHandle.dom.getBoundingClientRect(),i=Math.floor((e.clientY-t.top)/t.height*5),s=this._dragArea,r=this._dragOverItem;if(this._dragOverItem.parent===this){let e=!1;for(let t=0;t<this._dragItems.length;t++)if(this._dragItems[t].parent===this._dragOverItem){e=!0,this._dragOverItem=null;break}e||(this._dragArea=St)}else{let e=!1;for(let t=0;t<this._dragItems.length;t++)if(this._dragItems[t].dom.contains(this._dragOverItem.dom)){e=!0;break}if(e)this._dragOverItem=null;else if(this.allowReordering&&i<=1&&-1===this._dragItems.indexOf(this._dragOverItem.previousSibling))this._dragArea=wt;else if(this.allowReordering&&i>=4&&-1===this._dragItems.indexOf(this._dragOverItem.nextSibling)&&(0===this._dragOverItem.numChildren||!this._dragOverItem.open))this._dragArea=Tt;else{let e=!1;if(this.allowReordering&&this._dragOverItem.open)for(let t=0;t<this._dragItems.length;t++)if(this._dragItems[t].parent===this._dragOverItem){e=!0,this._dragArea=wt;break}e||(this._dragArea=St)}}s===this._dragArea&&r===this._dragOverItem||this._updateDragHandle()},this.class.add(vt),this._allowDrag=null===(t=e.allowDrag)||void 0===t||t,this.allowReordering=null===(i=e.allowReordering)||void 0===i||i,this.allowRenaming=null!==(s=e.allowRenaming)&&void 0!==s&&s,this._dragHandle=new L({class:bt,hidden:!0}),this._dragScrollElement=null!==(r=e.dragScrollElement)&&void 0!==r?r:this,this.append(this._dragHandle),this._onContextMenu=e.onContextMenu,this._onReparentFn=e.onReparent,this._wasDraggingAllowedBeforeFiltering=this._allowDrag,window.addEventListener("keydown",this._updateModifierKeys),window.addEventListener("keyup",this._updateModifierKeys),window.addEventListener("mousedown",this._updateModifierKeys),this.dom.addEventListener("mouseleave",this._onMouseLeave),this._dragHandle.dom.addEventListener("mousemove",this._onDragMove),this._dragHandle.on("destroy",(e=>{e.removeEventListener("mousemove",this._onDragMove)}))}destroy(){this._destroyed||(window.removeEventListener("keydown",this._updateModifierKeys),window.removeEventListener("keyup",this._updateModifierKeys),window.removeEventListener("mousedown",this._updateModifierKeys),window.removeEventListener("mousemove",this._onMouseMove),this.dom.removeEventListener("mouseleave",this._onMouseLeave),this._dragScrollInterval&&(window.clearInterval(this._dragScrollInterval),this._dragScrollInterval=null),super.destroy())}_findNextVisibleTreeItem(e){if(e.numChildren>0&&e.open)return e.firstChild;const t=e.nextSibling;if(t)return t;let i=e.parent;if(!(i instanceof gt))return null;let s=i.nextSibling;for(;!s&&(i=i.parent,i instanceof gt);)s=i.nextSibling;return s}_findLastVisibleChildTreeItem(e){if(!e.numChildren||!e.open)return null;let t=e.lastChild;for(;t&&t.numChildren&&t.open;)t=t.lastChild;return t}_findPreviousVisibleTreeItem(e){const t=e.previousSibling;if(t)return t.numChildren>0&&t.open?this._findLastVisibleChildTreeItem(t):t;const i=e.parent;return i instanceof gt?i:null}_getChildrenRange(e,t){const i=[];if(this._filterResults.length){const s=this.dom.querySelectorAll(`.${vt}-item.${xt}`);let r=-1,n=-1;for(let a=0;a<s.length;a++){const o=s[a].ui;if(o===e?r=a:o===t&&(n=a),-1!==r&&-1!==n){const e=r<n?n:r;for(let t=r<n?r:n;t<=e;t++)i.push(s[t].ui);break}}}else{let s=e;const r=e.dom.getBoundingClientRect(),n=t.dom.getBoundingClientRect();if(r.top<n.top)for(;s&&s!==t;)s=this._findNextVisibleTreeItem(s),s&&s!==t&&i.push(s);else for(;s&&s!==t;)s=this._findPreviousVisibleTreeItem(s),s&&s!==t&&i.push(s);i.push(t)}return i}_onAppendChild(e){super._onAppendChild(e),e instanceof gt&&this._onAppendTreeViewItem(e)}_onRemoveChild(e){e instanceof gt&&this._onRemoveTreeViewItem(e),super._onRemoveChild(e)}_onAppendTreeViewItem(e){e.treeView=this,this._filter&&this._searchItems([e],this._filter),e.forEachChild((e=>{e instanceof gt&&this._onAppendTreeViewItem(e)}))}_onRemoveTreeViewItem(e){e.selected=!1,e.forEachChild((e=>{e instanceof gt&&this._onRemoveTreeViewItem(e)}))}_onChildKeyDown(e,t){if(-1!==["Tab","ArrowLeft","ArrowRight","ArrowUp","ArrowDown"].indexOf(e.key))switch(e.preventDefault(),e.stopPropagation(),e.key){case"ArrowLeft":if(t.numChildren>0&&t.open)t.open=!1;else{const e=t.parent;e instanceof gt&&this._selectSingleItem(e)}break;case"ArrowRight":if(t.numChildren>0)if(t.open){const e=t.firstChild;e instanceof gt&&this._selectSingleItem(e)}else t.open=!0;break;case"ArrowDown":if(this._selectedItems.length){const e=this._findNextVisibleTreeItem(t);e&&(this._pressedShift||this._pressedCtrl?e.selected=!0:this._selectSingleItem(e))}break;case"ArrowUp":if(this._selectedItems.length){const e=this._findPreviousVisibleTreeItem(t);e&&(this._pressedShift||this._pressedCtrl?e.selected=!0:this._selectSingleItem(e))}}}_onChildClick(e,t){if(0===e.button&&t.allowSelect)if(this._pressedCtrl)t.selected=!t.selected;else if(this._pressedShift){if(!this._selectedItems.length||1===this._selectedItems.length&&this._selectedItems[0]===t)return void(t.selected=!0);const e=this._selectedItems[this._selectedItems.length-1];this._openHierarchy(e);this._getChildrenRange(e,t).forEach((e=>{e.allowSelect&&(e.selected=!0)}))}else this._selectSingleItem(t)}_traverseDepthFirst(e){function t(i){if(i&&i instanceof gt&&(e(i),i.numChildren))for(const e of i.dom.childNodes)t(e.ui)}for(const e of this.dom.childNodes)t(e.ui)}_getTreeOrder(){const e=new Map;let t=0;return this._traverseDepthFirst((i=>{e.set(i,t++)})),e}_getChildIndex(e,t){return Array.prototype.indexOf.call(t.dom.childNodes,e.dom)-1}_onChildDragStart(e,t){if(this.allowDrag&&!this._dragging){if(this._dragItems=[],-1!==this._selectedItems.indexOf(t)){const e=[];let t=-1;for(let i=0;i<this._selectedItems.length;i++){let s=this._selectedItems[i].parent,r=0,n=!1;for(;s&&s instanceof gt;){if(-1!==this._selectedItems.indexOf(s)){n=!0;break}r++,s=s.parent}if(!n){if(-1===t)t=r;else if(t!==r)return;e.push(this._selectedItems[i])}}this._dragItems=e}else t.class.add(_t),this._dragItems.push(t);this._dragItems.length&&(this._dragItems.forEach((e=>{e.class.add(_t)})),this.isDragging=!0,this.emit("dragstart",this._dragItems.slice()))}}_onChildDragEnd(e,t){if(!this.allowDrag||!this._dragging)return;this._dragItems.forEach((e=>e.class.remove(_t)));let i=!1;for(let e=0;e<this._dragItems.length;e++)if(this._dragItems[e].parent===this){i=!0;break}if(!i&&this._dragOverItem){if(this._dragItems.length>1){const e=this._getTreeOrder();this._dragItems.sort(((t,i)=>e.get(t)-e.get(i)))}if(this._dragItems.length){const e=[];if(this._onReparentFn){const t=[],i=e=>{let i=t.findIndex((t=>t.parent===e));return-1===i&&(t.push({parent:e,children:[...e.dom.childNodes]}),i=t.length-1),t[i].children};this._dragItems.forEach((t=>{if(t.parent===this._dragOverItem&&this._dragArea===St)return;e.push({item:t,oldParent:t.parent});const s=i(t.parent),r=s.indexOf(t.dom);s.splice(r,1)})),e.forEach(((t,s)=>{if(this._dragArea===wt){t.newParent=this._dragOverItem.parent;const e=i(this._dragOverItem.parent),s=e.indexOf(this._dragOverItem.dom);e.splice(s,0,t.item.dom),t.newChildIndex=s}else if(this._dragArea===St){t.newParent=this._dragOverItem;const e=i(this._dragOverItem);e.push(t.item.dom),t.newChildIndex=e.length-1}else if(this._dragArea===Tt){t.newParent=this._dragOverItem.parent;const r=i(this._dragOverItem.parent),n=s>0?e[s-1].item:this._dragOverItem,a=r.indexOf(n.dom);r.splice(a+1,0,t.item.dom),t.newChildIndex=a+1}t.newChildIndex--}))}else this._dragItems.forEach((t=>{t.parent===this._dragOverItem&&this._dragArea===St||(e.push({item:t,oldParent:t.parent}),t.parent.remove(t))})),e.forEach(((t,i)=>{this._dragArea===wt?(t.newParent=this._dragOverItem.parent,t.newParent.appendBefore(t.item,this._dragOverItem),t.newChildIndex=this._getChildIndex(t.item,t.newParent)):this._dragArea===St?(t.newParent=this._dragOverItem,t.newParent.append(t.item),t.newParent.open=!0,t.newChildIndex=this._getChildIndex(t.item,t.newParent)):this._dragArea===Tt&&(t.newParent=this._dragOverItem.parent,t.newParent.appendAfter(t.item,i>0?e[i-1].item:this._dragOverItem),t.newChildIndex=this._getChildIndex(t.item,t.newParent))}));e.length&&(this._onReparentFn&&this._onReparentFn(e),this.emit("reparent",e))}}this._dragItems=[],this.isDragging=!1,this.emit("dragend")}_onChildDragOver(e,t){this._allowDrag&&this._dragging&&(t.allowDrop&&-1===this._dragItems.indexOf(t)?this._dragOverItem=t:this._dragOverItem=null,this._updateDragHandle(),this._onDragMove(e))}_scrollWhileDragging(){this._dragging&&0!==this._dragScroll&&(this._dragScrollElement.dom.scrollTop+=8*this._dragScroll,this._dragOverItem=null,this._updateDragHandle())}_updateDragHandle(e,t){if(t||this._allowDrag&&this._dragging)if(e||(e=this._dragOverItem),e&&!e.hidden&&e.parentsOpen){const t=e._containerContents.dom.getBoundingClientRect();this._dragHandle.hidden=!1,this._dragHandle.class.remove(Tt,wt,St),this._dragHandle.class.add(this._dragArea);const i=t.top;let s=t.left,r=t.width;if(this.dom.parentElement){const e=this.dom.parentElement.getBoundingClientRect();s=Math.max(s,e.left),r=Math.min(r,this.dom.parentElement.clientWidth-s+e.left)}this._dragHandle.style.top=`${i}px`,this._dragHandle.style.left=`${s}px`,this._dragHandle.style.width=r-7+"px"}else this._dragHandle.hidden=!0}_openHierarchy(e){e.parentsOpen=!0}_selectSingleItem(e){let t=this._selectedItems.length,i=!1;for(;t--;)this._selectedItems[t]&&this._selectedItems[t]!==e&&(this._selectedItems[t].selected=!1,i=!0);e.selected=!!i||!e.selected}_onChildSelected(e){this._selectedItems.push(e),this._openHierarchy(e),this.emit("select",e)}_onChildDeselected(e){const t=this._selectedItems.indexOf(e);-1!==t&&(this._selectedItems.splice(t,1),this.emit("deselect",e))}_onChildRename(e,t){if(this._filter){e.class.remove(xt);const t=this._filterResults.indexOf(e);-1!==t&&this._filterResults.splice(t,1),this._searchItems([e],this._filter)}this.emit("rename",e,t)}_searchItems(e,t){const i=we(e,"text",t);i.length&&i.forEach((e=>{this._filterResults.push(e),e.class.add(xt)}))}_applyFilter(e){this._clearFilter(),this._wasDraggingAllowedBeforeFiltering=this._allowDrag,this._allowDrag=!1,this.class.add(yt);const t=[];this._traverseDepthFirst((e=>{t.push(e)})),this._searchItems(t,e)}_clearFilter(){this._filterResults.forEach((e=>{e.destroyed||e.class.remove(xt)})),this._filterResults.length=0,this.class.remove(yt),this._allowDrag=this._wasDraggingAllowedBeforeFiltering}showDragHandle(e){this._updateDragHandle(e,!0)}deselect(){let e=this._selectedItems.length;for(;e--;)this._selectedItems[e]&&(this._selectedItems[e].selected=!1)}clearTreeItems(){let e=this.dom.childNodes.length;for(;e--;){const t=this.dom.childNodes[e];if(!t)continue;const i=t.ui;i instanceof gt&&i.destroy()}this._selectedItems=[],this._dragItems=[],this._allowDrag=this._wasDraggingAllowedBeforeFiltering}set allowDrag(e){this._allowDrag=e,this._filter&&(this._wasDraggingAllowedBeforeFiltering=e)}get allowDrag(){return this._allowDrag}set isDragging(e){this._dragging!==e&&(e?(this._dragging=!0,this._updateDragHandle(),(this.scrollable||this._dragScrollElement!==this)&&(window.removeEventListener("mousemove",this._onMouseMove),window.addEventListener("mousemove",this._onMouseMove),this._dragScrollInterval||(this._dragScrollInterval=window.setInterval((()=>{this._scrollWhileDragging()}),1e3/60)))):(this._dragOverItem=null,this._updateDragHandle(),this._dragging=!1,window.removeEventListener("mousemove",this._onMouseMove),this._dragScrollInterval&&(window.clearInterval(this._dragScrollInterval),this._dragScrollInterval=null)))}get isDragging(){return this._dragging}get selected(){return this._selectedItems.slice()}set filter(e){this._filter!==e&&(this._filter=e,e?this._applyFilter(e):this._clearFilter())}get filter(){return this._filter}get pressedCtrl(){return this._pressedCtrl}get pressedShift(){return this._pressedShift}};Ct.EVENT_DRAGSTART="dragstart",Ct.EVENT_DRAGEND="dragend",Ct.EVENT_REPARENT="reparent",Ct.EVENT_SELECT="select",Ct.EVENT_DESELECT="deselect",Ct.EVENT_RENAME="rename";class Et extends M{constructor(e){super(e),this.element=new Ct(Object.assign({},e)),this.loadChildren(this.props.children,this.element)}loadChildren(e,t){e&&(Array.isArray(e)||(e=[e]),e.forEach((e=>{const i=new gt({text:e.props.text,icon:e.props.icon,open:!1});e.props.onSelect&&i.on("select",e.props.onSelect),e.props.onDeselect&&i.on("deselect",e.props.onDeselect),t.append(i),this.loadChildren(e.props.children,i)})))}componentDidUpdate(){this.parentElement.removeChild(this.element.dom),this.element=new Ct(Object.assign({},this.props)),this.loadChildren(this.props.children,this.element),this.parentElement.appendChild(this.element.dom)}parentElementRendered(e){e&&(this.parentElement=e,this.parentElement.appendChild(this.element.dom))}render(){return d.createElement("div",{ref:this.parentElementRendered.bind(this)})}}Et.ctor=Ct;class At extends M{constructor(e){super(e),this.elementClass=gt,this.onSelect=()=>{e.onSelect&&e.onSelect((()=>{this.element.selected=!1}))},e.onDeselect&&(this.onDeselect=e.onDeselect),this.onAttach=this.onAttachFn.bind(this)}onAttachFn(){this.props.onSelect&&this.element.on("select",this.onSelect),this.props.onDeselect&&this.element.on("deselect",this.onDeselect)}render(){return super.render()}}At.ctor=gt;let Pt=class extends L{constructor(e={}){var t,i,s;const r=Object.assign({},e);delete r.binding,super(r),this._inputs=[],this._applyingChange=!1,this._bindAllInputs=!1,this.class.add("pcui-vector-input");const n=Math.max(2,Math.min(4,null!==(t=e.dimensions)&&void 0!==t?t:3));for(let t=0;t<n;t++){const r=new j({min:e.min,max:e.max,precision:null!==(i=e.precision)&&void 0!==i?i:7,step:null!==(s=e.step)&&void 0!==s?s:1,stepPrecision:e.stepPrecision,renderChanges:e.renderChanges,placeholder:e.placeholder?Array.isArray(e.placeholder)?e.placeholder[t]:e.placeholder:null});r.on("slider:mousedown",(e=>{if(this._bindAllInputs=!!e.altKey,this._bindAllInputs){r.focus();for(let e=0;e<this._inputs.length;e++)this._inputs[e].class.add(b);this.binding&&(this.binding.historyCombine=!0)}})),r.on("slider:mouseup",(()=>{this._onInputChange(r),this._bindAllInputs=!1;for(let e=0;e<this._inputs.length;e++)this._inputs[e].class.remove(b);r.blur(),this.binding&&(this.binding.historyCombine=!1)})),r.on("change",(()=>{this._onInputChange(r)})),r.on("focus",(()=>{this.emit("focus")})),r.on("blur",(()=>{this.emit("blur")})),this.dom.appendChild(r.dom),r.parent=this,this._inputs.push(r)}e.binding&&(this.binding=e.binding),void 0!==e.value&&(this.value=e.value)}_onInputChange(e){if(this._applyingChange)return;const t=this._inputs.some((e=>e.class.contains(T)));if(t?this.class.add(T):this.class.remove(T),this._bindAllInputs){const t=Array(this._inputs.length).fill(e.value);this._updateValue(t)&&this._binding&&this._binding.setValue(t)}else this.emit("change",this.value)}_updateValue(e){return this.class.remove(T),JSON.stringify(this.value)!==JSON.stringify(e)&&(this._applyingChange=!0,this._inputs.forEach(((t,i)=>{const s=t.binding;let r=!1;s&&(r=s.applyingChange,s.applyingChange=!0),t.value=e&&void 0!==e[i]?e[i]:null,s&&(s.applyingChange=r)})),this.emit("change",this.value),this._applyingChange=!1,!0)}link(e,t){super.link(e,t),e=Array.isArray(e)?e:[e];if(1===(t=Array.isArray(t)?t:[t]).length||e.length!==t.length)for(let i=0;i<this._inputs.length;i++)this._inputs[i].link(e,`${t[0]}.${i}`);else for(let i=0;i<this._inputs.length;i++)this._inputs[i].link(e,t.map((e=>`${e}.${i}`)))}unlink(){super.unlink();for(const e of this._inputs)e.unlink()}focus(){this._inputs[0].focus()}blur(){for(const e of this._inputs)e.blur()}set value(e){if("string"==typeof e)try{if(e=JSON.parse(e),Array.isArray(e)&&e.some((e=>!Number.isFinite(e))))throw new Error("VectorInput value set to string which doesn't contain an array of numbers")}catch(t){console.error(t),e=[]}Array.isArray(e)||(e=[]);this._updateValue(e)&&this._binding&&this._binding.setValue(e)}get value(){return this._inputs.map((e=>e.value))}set values(e){e=this._inputs.map(((t,i)=>e.map((e=>e?e[i]:void 0)))),this._inputs.forEach(((t,i)=>{t.values=e[i]}))}set binding(e){super.binding=e;for(const t of this._inputs)t.binding=e?e.clone():null}get binding(){return super.binding}set placeholder(e){for(let t=0;t<this._inputs.length;t++)this._inputs[t].placeholder=e[t]||e||null}get placeholder(){return this._inputs.map((e=>e.placeholder))}get inputs(){return this._inputs.slice()}set renderChanges(e){for(const t of this._inputs)t.renderChanges=e}get renderChanges(){return this._inputs[0].renderChanges}set min(e){for(const t of this._inputs)t.min=e}get min(){return this._inputs[0].min}set max(e){for(const t of this._inputs)t.max=e}get max(){return this._inputs[0].max}set precision(e){for(const t of this._inputs)t.precision=e}get precision(){return this._inputs[0].precision}set step(e){for(const t of this._inputs)t.step=e}get step(){return this._inputs[0].step}};L.register("vec2",Pt,{dimensions:2,renderChanges:!0}),L.register("vec3",Pt,{dimensions:3,renderChanges:!0}),L.register("vec4",Pt,{dimensions:4,renderChanges:!0});class Dt extends M{constructor(e){super(e),this.elementClass=Pt}render(){return super.render()}}Dt.ctor=Pt;var Lt="2.7.3",Mt="03a9f12";function It(e,t){for(var i in t){var s=t[i];Array.isArray(s)?e[i]=It([],s):e[i]=s&&"object"==typeof s?It({},s):s}return e}var Rt={create:()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))},kt={delimiter:"/",join(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];for(var s=t[0],r=0;r<t.length-1;r++){var n=t[r],a=t[r+1];a[0]!==kt.delimiter?n&&a&&n[n.length-1]!==kt.delimiter&&a[0]!==kt.delimiter?s+=kt.delimiter+a:s+=a:s=a}return s},normalize(e){for(var t=e.startsWith(kt.delimiter),i=e.endsWith(kt.delimiter),s=e.split("/"),r="",n=[],a=0;a<s.length;a++)""!==s[a]&&"."!==s[a]&&(".."===s[a]&&n.length>0?n=n.slice(0,n.length-2):(a>0&&n.push(kt.delimiter),n.push(s[a])));return r=n.join(""),t||r[0]!==kt.delimiter||(r=r.slice(1)),i&&r[r.length-1]!==kt.delimiter&&(r+=kt.delimiter),r},split(e){var t=e.lastIndexOf(kt.delimiter);return-1!==t?[e.substring(0,t),e.substring(t+1)]:["",e]},getBasename:e=>kt.split(e)[1],getDirectory:e=>kt.split(e)[0],getExtension(e){var t=e.split("?")[0].split(".").pop();return t!==e?"."+t:""},isRelativePath:e=>"/"!==e.charAt(0)&&null===e.match(/:\/\//),extractPath(e){var t="",i=e.split("/"),s=0;if(i.length>1)if(kt.isRelativePath(e))if("."===i[0])for(s=0;s<i.length-1;++s)t+=0===s?i[s]:"/"+i[s];else if(".."===i[0])for(s=0;s<i.length-1;++s)t+=0===s?i[s]:"/"+i[s];else for(t=".",s=0;s<i.length-1;++s)t+="/"+i[s];else for(s=0;s<i.length-1;++s)t+=0===s?i[s]:"/"+i[s];return t}},Ot="undefined"!=typeof navigator?navigator.userAgent:"",Ft="undefined"!=typeof window?"browser":"undefined"!=typeof global?"node":"worker",Bt=/android/i.test(Ot)?"android":/ip(?:[ao]d|hone)/i.test(Ot)?"ios":/windows/i.test(Ot)?"windows":/mac os/i.test(Ot)?"osx":/linux/i.test(Ot)?"linux":/cros/i.test(Ot)?"cros":null,Nt="browser"!==Ft?null:/Chrome\/|Chromium\/|Edg.*\//.test(Ot)?"chrome":/Safari\//.test(Ot)?"safari":/Firefox\//.test(Ot)?"firefox":"other",zt=(()=>{var e=!1;try{var t=Object.defineProperty({},"passive",{get:function(){return e=!0,!1}});window.addEventListener("testpassive",null,t),window.removeEventListener("testpassive",null,t)}catch(e){}return e})(),Ut={name:Bt,browser:"browser"===Ft,worker:"worker"===Ft,android:"android"===Bt,passiveEvents:zt,browserName:Nt};class Vt{off(){this._removed||this.handler.offByHandle(this)}on(e,t,i){return void 0===i&&(i=this),this.handler._addCallback(e,t,i,!1)}once(e,t,i){return void 0===i&&(i=this),this.handler._addCallback(e,t,i,!0)}set removed(e){e&&(this._removed=!0)}get removed(){return this._removed}constructor(e,t,i,s,r=!1){this._removed=!1,this.handler=e,this.name=t,this.callback=i,this.scope=s,this._once=r}}class Ht{initEventHandler(){this._callbacks=new Map,this._callbackActive=new Map}_addCallback(e,t,i,s){if(this._callbacks.has(e)||this._callbacks.set(e,[]),this._callbackActive.has(e)){var r=this._callbackActive.get(e);r&&r===this._callbacks.get(e)&&this._callbackActive.set(e,r.slice())}var n=new Vt(this,e,t,i,s);return this._callbacks.get(e).push(n),n}on(e,t,i){return void 0===i&&(i=this),this._addCallback(e,t,i,!1)}once(e,t,i){return void 0===i&&(i=this),this._addCallback(e,t,i,!0)}off(e,t,i){if(e)this._callbackActive.has(e)&&this._callbackActive.get(e)===this._callbacks.get(e)&&this._callbackActive.set(e,this._callbackActive.get(e).slice());else for(var[s,r]of this._callbackActive)this._callbacks.has(s)&&this._callbacks.get(s)===r&&this._callbackActive.set(s,r.slice());if(e)if(t){var n=this._callbacks.get(e);if(!n)return this;for(var a=0;a<n.length;a++)n[a].callback===t&&(i&&n[a].scope!==i||(n[a].removed=!0,n.splice(a,1),a--));0===n.length&&this._callbacks.delete(e)}else{var o=this._callbacks.get(e);if(o){for(var l=0;l<o.length;l++)o[l].removed=!0;this._callbacks.delete(e)}}else{for(var h of this._callbacks.values())for(var c=0;c<h.length;c++)h[c].removed=!0;this._callbacks.clear()}return this}offByHandle(e){var t=e.name;e.removed=!0,this._callbackActive.has(t)&&this._callbackActive.get(t)===this._callbacks.get(t)&&this._callbackActive.set(t,this._callbackActive.get(t).slice());var i=this._callbacks.get(t);if(!i)return this;var s=i.indexOf(e);return-1!==s&&(i.splice(s,1),0===i.length&&this._callbacks.delete(t)),this}fire(e,t,i,s,r,n,a,o,l){if(!e)return this;var h,c=this._callbacks.get(e);if(!c)return this;this._callbackActive.has(e)?this._callbackActive.get(e)!==c&&(h=c.slice()):this._callbackActive.set(e,c);for(var d=0;(h||this._callbackActive.get(e))&&d<(h||this._callbackActive.get(e)).length;d++){var u=(h||this._callbackActive.get(e))[d];if(u.callback&&(u.callback.call(u.scope,t,i,s,r,n,a,o,l),u._once)){var f=this._callbacks.get(e),p=f?f.indexOf(u):-1;if(-1!==p){this._callbackActive.get(e)===f&&this._callbackActive.set(e,this._callbackActive.get(e).slice());var m=this._callbacks.get(e);if(!m)continue;m[p].removed=!0,m.splice(p,1),0===m.length&&this._callbacks.delete(e)}}}return h||this._callbackActive.delete(e),this}hasEvent(e){var t;return!!(null==(t=this._callbacks.get(e))?void 0:t.length)}constructor(){this._callbacks=new Map,this._callbackActive=new Map}}var Gt,Wt,jt;class qt{static loadScript(e,t){var i=document.createElement("script");i.setAttribute("src",e),i.onload=()=>{t(null)},i.onerror=()=>{t("Failed to load script='"+e+"'")},document.body.appendChild(i)}static loadWasm(e,t,i){var s=qt.wasmSupported()&&t.glueUrl&&t.wasmUrl?t.glueUrl:t.fallbackUrl;s?qt.loadScript(s,(s=>{if(s)i(s,null);else{var r=window[e];window[e]=void 0,r({locateFile:()=>t.wasmUrl,onAbort:()=>{i("wasm module aborted.")}}).then((e=>{i(null,e)}))}})):i("No supported wasm modules found.",null)}static getModule(e){return qt.modules.hasOwnProperty(e)||(qt.modules[e]={config:null,initializing:!1,instance:null,callbacks:[]}),qt.modules[e]}static initialize(e,t){if(!t.initializing){var i=t.config;(i.glueUrl||i.wasmUrl||i.fallbackUrl)&&(t.initializing=!0,qt.loadWasm(e,i,((s,r)=>{s?i.errorHandler?i.errorHandler(s):console.error("failed to initialize module="+e+" error="+s):(t.instance=r,t.callbacks.forEach((e=>{e(r)})))})))}}}qt.modules={},qt.wasmSupported=(Gt=()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){var e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){}return!1},jt=Wt={},()=>(jt===Wt&&(jt=Gt()),jt));class Xt{static setConfig(e,t){var i=qt.getModule(e);i.config=t,i.callbacks.length>0&&qt.initialize(e,i)}static getConfig(e){var t,i;return null==(i=qt.modules)||null==(t=i[e])?void 0:t.config}static getInstance(e,t){var i=qt.getModule(e);i.instance?t(i.instance):(i.callbacks.push(t),i.config&&qt.initialize(e,i))}}class Kt{get remainingBytes(){return this.dataView.byteLength-this.offset}reset(e){void 0===e&&(e=0),this.offset=e}skip(e){this.offset+=e}align(e){this.offset=this.offset+e-1&~(e-1)}_inc(e){return this.offset+=e,this.offset-e}readChar(){return String.fromCharCode(this.dataView.getUint8(this.offset++))}readChars(e){for(var t="",i=0;i<e;++i)t+=this.readChar();return t}readU8(){return this.dataView.getUint8(this.offset++)}readU16(){return this.dataView.getUint16(this._inc(2),!0)}readU32(){return this.dataView.getUint32(this._inc(4),!0)}readU64(){return this.readU32()+2**32*this.readU32()}readU32be(){return this.dataView.getUint32(this._inc(4),!1)}readArray(e){for(var t=0;t<e.length;++t)e[t]=this.readU8()}readLine(){for(var e=this.dataView,t="";!(this.offset>=e.byteLength);){var i=String.fromCharCode(this.readU8());if("\n"===i)break;t+=i}return t}constructor(e){this.offset=0,this.arraybuffer=e,this.dataView=new DataView(e)}}class Yt{_binarySearch(e){for(var t,i,s=0,r=this.items.length-1,n=e[this._sortBy];s<=r;)t=Math.floor((s+r)/2),(i=this.items[t][this._sortBy])<=n?s=t+1:i>n&&(r=t-1);return s}_doSort(e,t){var i=this._sortBy;return e[i]-t[i]}insert(e){var t=this._binarySearch(e);this.items.splice(t,0,e),this.length++,this.loopIndex>=t&&this.loopIndex++}append(e){this.items.push(e),this.length++}remove(e){var t=this.items.indexOf(e);t<0||(this.items.splice(t,1),this.length--,this.loopIndex>=t&&this.loopIndex--)}sort(){var e=this.loopIndex>=0?this.items[this.loopIndex]:null;this.items.sort(this._sortHandler),null!==e&&(this.loopIndex=this.items.indexOf(e))}constructor(e){this.items=[],this.length=0,this.loopIndex=-1,this._sortBy=e.sortBy,this._sortHandler=this._doSort.bind(this)}}class Qt extends Ht{add(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var s=!1,r=this._processArguments(t,!0);if(!r.length)return s;for(var n=0;n<r.length;n++)this._index[r[n]]||(s=!0,this._index[r[n]]=!0,this._list.push(r[n]),this.fire("add",r[n],this._parent));return s&&this.fire("change",this._parent),s}remove(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var s=!1;if(!this._list.length)return s;var r=this._processArguments(t,!0);if(!r.length)return s;for(var n=0;n<r.length;n++)this._index[r[n]]&&(s=!0,delete this._index[r[n]],this._list.splice(this._list.indexOf(r[n]),1),this.fire("remove",r[n],this._parent));return s&&this.fire("change",this._parent),s}clear(){if(this._list.length){var e=this._list.slice(0);this._list=[],this._index={};for(var t=0;t<e.length;t++)this.fire("remove",e[t],this._parent);this.fire("change",this._parent)}}has(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return!!this._list.length&&this._has(this._processArguments(t))}_has(e){if(!this._list.length||!e.length)return!1;for(var t=0;t<e.length;t++)if(1===e[t].length){if(this._index[e[t][0]])return!0}else{for(var i=!0,s=0;s<e[t].length;s++)if(!this._index[e[t][s]]){i=!1;break}if(i)return!0}return!1}list(){return this._list.slice(0)}_processArguments(e,t){var i=[],s=[];if(!e||!e.length)return i;for(var r=0;r<e.length;r++)if(e[r]instanceof Array){t||(s=[]);for(var n=0;n<e[r].length;n++)"string"==typeof e[r][n]&&(t?i.push(e[r][n]):s.push(e[r][n]));!t&&s.length&&i.push(s)}else"string"==typeof e[r]&&(t?i.push(e[r]):i.push([e[r]]));return i}get size(){return this._list.length}constructor(e){super(),this._index={},this._list=[],this._parent=e}}Qt.EVENT_ADD="add",Qt.EVENT_REMOVE="remove",Qt.EVENT_CHANGE="change";var Jt="undefined"!=typeof window&&window.performance&&window.performance.now?performance.now.bind(performance):Date.now,$t=/^(([^:/?#]+):)?(\/\/([^/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/;class Zt{toString(){var e="";return this.scheme&&(e+=this.scheme+":"),this.authority&&(e+="//"+this.authority),e+=this.path,this.query&&(e+="?"+this.query),this.fragment&&(e+="#"+this.fragment),e}getQuery(){var e={};if(this.query){var t=decodeURIComponent(this.query).split("&");for(var i of t){var s=i.split("=");e[s[0]]=s[1]}}return e}setQuery(e){var t="";for(var i in e)e.hasOwnProperty(i)&&(""!==t&&(t+="&"),t+=encodeURIComponent(i)+"="+encodeURIComponent(e[i]));this.query=t}constructor(e){var t=e.match($t);this.scheme=t[2],this.authority=t[4],this.path=t[5],this.query=t[7],this.fragment=t[9]}}class ei{static set(e,t){}static get(e){return ei._traceChannels.has(e)}}ei._traceChannels=new Set,ei.stack=!1;var ti={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,clamp:(e,t,i)=>e>=i?i:e<=t?t:e,intToBytes24:e=>[e>>16&255,e>>8&255,255&e],intToBytes32:e=>[e>>24&255,e>>16&255,e>>8&255,255&e],bytesToInt24:(e,t,i)=>(e.length&&(i=e[2],t=e[1],e=e[0]),e<<16|t<<8|i),bytesToInt32:(e,t,i,s)=>(e.length&&(s=e[3],i=e[2],t=e[1],e=e[0]),(e<<24|t<<16|i<<8|s)>>>0),lerp:(e,t,i)=>e+(t-e)*ti.clamp(i,0,1),lerpAngle:(e,t,i)=>(t-e>180&&(t-=360),t-e<-180&&(t+=360),ti.lerp(e,t,ti.clamp(i,0,1))),powerOfTwo:e=>0!==e&&!(e&e-1),nextPowerOfTwo:e=>(e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e),nearestPowerOfTwo:e=>Math.pow(2,Math.round(Math.log(e)/Math.log(2))),random(e,t){var i=t-e;return Math.random()*i+e},smoothstep:(e,t,i)=>i<=e?0:i>=t?1:(i=(i-e)/(t-e))*i*(3-2*i),smootherstep:(e,t,i)=>i<=e?0:i>=t?1:(i=(i-e)/(t-e))*i*i*(i*(6*i-15)+10),roundUp:(e,t)=>0===t?e:Math.ceil(e/t)*t,between(e,t,i,s){var r=Math.min(t,i),n=Math.max(t,i);return s?e>=r&&e<=n:e>r&&e<n}};class ii{clone(){return new(0,this.constructor)(this.r,this.g,this.b,this.a)}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this}equals(e){return this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a}set(e,t,i,s){return void 0===s&&(s=1),this.r=e,this.g=t,this.b=i,this.a=s,this}lerp(e,t,i){return this.r=e.r+i*(t.r-e.r),this.g=e.g+i*(t.g-e.g),this.b=e.b+i*(t.b-e.b),this.a=e.a+i*(t.a-e.a),this}linear(e){return void 0===e&&(e=this),this.r=Math.pow(e.r,2.2),this.g=Math.pow(e.g,2.2),this.b=Math.pow(e.b,2.2),this.a=e.a,this}gamma(e){return void 0===e&&(e=this),this.r=Math.pow(e.r,1/2.2),this.g=Math.pow(e.g,1/2.2),this.b=Math.pow(e.b,1/2.2),this.a=e.a,this}mulScalar(e){return this.r*=e,this.g*=e,this.b*=e,this}fromString(e){var t,i=parseInt(e.replace("#","0x"),16);return e.length>7?t=ti.intToBytes32(i):(t=ti.intToBytes24(i))[3]=255,this.set(t[0]/255,t[1]/255,t[2]/255,t[3]/255),this}fromArray(e,t){var i,s,r,n;return void 0===t&&(t=0),this.r=null!=(i=e[t])?i:this.r,this.g=null!=(s=e[t+1])?s:this.g,this.b=null!=(r=e[t+2])?r:this.b,this.a=null!=(n=e[t+3])?n:this.a,this}toString(e,t){var{r:i,g:s,b:r,a:n}=this;if(t||i>1||s>1||r>1)return i.toFixed(3)+", "+s.toFixed(3)+", "+r.toFixed(3)+", "+n.toFixed(3);var a="#"+((1<<24)+(Math.round(255*i)<<16)+(Math.round(255*s)<<8)+Math.round(255*r)).toString(16).slice(1);if(!0===e){var o=Math.round(255*n).toString(16);this.a<16/255?a+="0"+o:a+=o}return a}toArray(e,t,i){return void 0===e&&(e=[]),void 0===t&&(t=0),void 0===i&&(i=!0),e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,i&&(e[t+3]=this.a),e}constructor(e=0,t=0,i=0,s=1){var r,n=e.length;3===n||4===n?(this.r=e[0],this.g=e[1],this.b=e[2],this.a=null!=(r=e[3])?r:1):(this.r=e,this.g=t,this.b=i,this.a=s)}}ii.BLACK=Object.freeze(new ii(0,0,0,1)),ii.BLUE=Object.freeze(new ii(0,0,1,1)),ii.CYAN=Object.freeze(new ii(0,1,1,1)),ii.GRAY=Object.freeze(new ii(.5,.5,.5,1)),ii.GREEN=Object.freeze(new ii(0,1,0,1)),ii.MAGENTA=Object.freeze(new ii(1,0,1,1)),ii.RED=Object.freeze(new ii(1,0,0,1)),ii.WHITE=Object.freeze(new ii(1,1,1,1)),ii.YELLOW=Object.freeze(new ii(1,1,0,1));class si{evaluate(e,t){var i;void 0===t&&(t=!1),(t||e<this._left||e>=this._right)&&this._reset(e);var s=this._curve.type;if(5===s)i=this._p0;else{var r=0===this._recip?0:(e-this._left)*this._recip;i=0===s?ti.lerp(this._p0,this._p1,r):1===s?ti.lerp(this._p0,this._p1,r*r*(3-2*r)):this._evaluateHermite(this._p0,this._p1,this._m0,this._m1,r)}return i}_reset(e){var t=this._curve.keys,i=t.length;if(i)if(e<t[0][0])this._left=-1/0,this._right=t[0][0],this._recip=0,this._p0=this._p1=t[0][1],this._m0=this._m1=0;else if(e>=t[i-1][0])this._left=t[i-1][0],this._right=1/0,this._recip=0,this._p0=this._p1=t[i-1][1],this._m0=this._m1=0;else{for(var s=0;e>=t[s+1][0];)s++;this._left=t[s][0],this._right=t[s+1][0];var r=1/(this._right-this._left);this._recip=isFinite(r)?r:0,this._p0=t[s][1],this._p1=t[s+1][1],4===this._curve.type&&this._calcTangents(t,s)}else this._left=-1/0,this._right=1/0,this._recip=0,this._p0=this._p1=this._m0=this._m1=0}_calcTangents(e,t){var i,s,r=e[t],n=e[t+1];if(i=0===t?[e[0][0]+(e[0][0]-e[1][0]),e[0][1]+(e[0][1]-e[1][1])]:e[t-1],s=t===e.length-2?[e[t+1][0]+(e[t+1][0]-e[t][0]),e[t+1][1]+(e[t+1][1]-e[t][1])]:e[t+2],4===this._curve.type){var a=2*(n[0]-r[0])/(n[0]-i[0]),o=2*(n[0]-r[0])/(s[0]-r[0]);this._m0=this._curve.tension*(isFinite(a)?a:0)*(n[1]-i[1]),this._m1=this._curve.tension*(isFinite(o)?o:0)*(s[1]-r[1])}else{var l=(n[0]-r[0])/(r[0]-i[0]),h=(n[0]-r[0])/(s[0]-n[0]),c=r[1]+(i[1]-r[1])*(isFinite(l)?l:0),d=n[1]+(s[1]-n[1])*(isFinite(h)?h:0),u=this._curve.tension;this._m0=u*(n[1]-c),this._m1=u*(d-r[1])}}_evaluateHermite(e,t,i,s,r){var n=r*r,a=r+r,o=1-r,l=o*o;return e*((1+a)*l)+i*(r*l)+t*(n*(3-a))+s*(n*(r-1))}constructor(e,t=0){this._left=-1/0,this._right=1/0,this._recip=0,this._p0=0,this._p1=0,this._m0=0,this._m1=0,this._curve=e,this._reset(t)}}class ri{get length(){return this.keys.length}add(e,t){for(var i=this.keys,s=i.length,r=0;r<s&&!(i[r][0]>e);r++);var n=[e,t];return this.keys.splice(r,0,n),n}get(e){return this.keys[e]}sort(){this.keys.sort(((e,t)=>e[0]-t[0]))}value(e){return this._eval.evaluate(e,!0)}closest(e){for(var t=this.keys,i=t.length,s=2,r=null,n=0;n<i;n++){var a=Math.abs(e-t[n][0]);if(!(s>=a))break;s=a,r=t[n]}return r}clone(){var e=new this.constructor;return e.keys=this.keys.map((e=>[...e])),e.type=this.type,e.tension=this.tension,e}quantize(e){e=Math.max(e,2);var t=new Float32Array(e),i=1/(e-1);t[0]=this._eval.evaluate(0,!0);for(var s=1;s<e;s++)t[s]=this._eval.evaluate(i*s);return t}quantizeClamped(e,t,i){for(var s=this.quantize(e),r=0;r<s.length;++r)s[r]=Math.min(i,Math.max(t,s[r]));return s}constructor(e){if(this.keys=[],this.type=1,this.tension=.5,this._eval=new si(this),e)for(var t=0;t<e.length-1;t+=2)this.keys.push([e[t],e[t+1]]);this.sort()}}class ni{get length(){return this.curves.length}set type(e){this._type=e;for(var t=0;t<this.curves.length;t++)this.curves[t].type=e}get type(){return this._type}get(e){return this.curves[e]}value(e,t){void 0===t&&(t=[]);var i=this.curves.length;t.length=i;for(var s=0;s<i;s++)t[s]=this.curves[s].value(e);return t}clone(){var e=new this.constructor;e.curves=[];for(var t=0;t<this.curves.length;t++)e.curves.push(this.curves[t].clone());return e._type=this._type,e}quantize(e){e=Math.max(e,2);for(var t=this.curves.length,i=new Float32Array(e*t),s=1/(e-1),r=0;r<t;r++)for(var n=new si(this.curves[r]),a=0;a<e;a++)i[a*t+r]=n.evaluate(s*a);return i}quantizeClamped(e,t,i){for(var s=this.quantize(e),r=0;r<s.length;++r)s[r]=Math.min(i,Math.max(t,s[r]));return s}constructor(...e){if(this.curves=[],this._type=1,e.length>1)for(var t=0;t<e.length;t++)this.curves.push(new ri(e[t]));else if(0===e.length)this.curves.push(new ri);else{var i=e[0];if("number"==typeof i)for(var s=0;s<i;s++)this.curves.push(new ri);else for(var r=0;r<i.length;r++)this.curves.push(new ri(i[r]))}}}var ai=new Float32Array(1),oi=new Int32Array(ai.buffer);class li{static float2Half(e){ai[0]=e;var t=oi[0],i=t>>16&32768,s=t>>12&2047,r=t>>23&255;return r<103?i:r>142?(i|=31744,i|=(255===r?0:1)&&8388607&t):r<113?i|=((s|=2048)>>114-r)+(s>>113-r&1):(i|=r-112<<10|s>>1,i+=1&s)}static float2RGBA8(e,t){ai[0]=e;var i=oi[0];t.r=(i>>24&255)/255,t.g=(i>>16&255)/255,t.b=(i>>8&255)/255,t.a=(255&i)/255}}class hi{add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}add2(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addScaled(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}clone(){return new(0,this.constructor)(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}cross(e,t){var i=e.x,s=e.y,r=e.z,n=t.x,a=t.y,o=t.z;return this.x=s*o-a*r,this.y=r*n-o*i,this.z=i*a-n*s,this}distance(e){var t=this.x-e.x,i=this.y-e.y,s=this.z-e.z;return Math.sqrt(t*t+i*i+s*s)}div(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}div2(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this.z=e.z/t.z,this}divScalar(e){return this.x/=e,this.y/=e,this.z/=e,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}equals(e){return this.x===e.x&&this.y===e.y&&this.z===e.z}equalsApprox(e,t){return void 0===t&&(t=1e-6),Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}lerp(e,t,i){return this.x=e.x+i*(t.x-e.x),this.y=e.y+i*(t.y-e.y),this.z=e.z+i*(t.z-e.z),this}mul(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}mul2(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}mulScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}normalize(e){void 0===e&&(e=this);var t=e.x*e.x+e.y*e.y+e.z*e.z;if(t>0){var i=1/Math.sqrt(t);this.x=e.x*i,this.y=e.y*i,this.z=e.z*i}return this}floor(e){return void 0===e&&(e=this),this.x=Math.floor(e.x),this.y=Math.floor(e.y),this.z=Math.floor(e.z),this}ceil(e){return void 0===e&&(e=this),this.x=Math.ceil(e.x),this.y=Math.ceil(e.y),this.z=Math.ceil(e.z),this}round(e){return void 0===e&&(e=this),this.x=Math.round(e.x),this.y=Math.round(e.y),this.z=Math.round(e.z),this}min(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),this}max(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),this}project(e){var t=(this.x*e.x+this.y*e.y+this.z*e.z)/(e.x*e.x+e.y*e.y+e.z*e.z);return this.x=e.x*t,this.y=e.y*t,this.z=e.z*t,this}set(e,t,i){return this.x=e,this.y=t,this.z=i,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}sub2(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}fromArray(e,t){var i,s,r;return void 0===t&&(t=0),this.x=null!=(i=e[t])?i:this.x,this.y=null!=(s=e[t+1])?s:this.y,this.z=null!=(r=e[t+2])?r:this.z,this}toString(){return"["+this.x+", "+this.y+", "+this.z+"]"}toArray(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e}constructor(e=0,t=0,i=0){3===e.length?(this.x=e[0],this.y=e[1],this.z=e[2]):(this.x=e,this.y=t,this.z=i)}}hi.ZERO=Object.freeze(new hi(0,0,0)),hi.HALF=Object.freeze(new hi(.5,.5,.5)),hi.ONE=Object.freeze(new hi(1,1,1)),hi.UP=Object.freeze(new hi(0,1,0)),hi.DOWN=Object.freeze(new hi(0,-1,0)),hi.RIGHT=Object.freeze(new hi(1,0,0)),hi.LEFT=Object.freeze(new hi(-1,0,0)),hi.FORWARD=Object.freeze(new hi(0,0,-1)),hi.BACK=Object.freeze(new hi(0,0,1));class ci{clone(){return(new(0,this.constructor)).copy(this)}copy(e){var t=e.data,i=this.data;return i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[4]=t[4],i[5]=t[5],i[6]=t[6],i[7]=t[7],i[8]=t[8],this}set(e){var t=this.data;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],this}getX(e){return void 0===e&&(e=new hi),e.set(this.data[0],this.data[1],this.data[2])}getY(e){return void 0===e&&(e=new hi),e.set(this.data[3],this.data[4],this.data[5])}getZ(e){return void 0===e&&(e=new hi),e.set(this.data[6],this.data[7],this.data[8])}equals(e){var t=this.data,i=e.data;return t[0]===i[0]&&t[1]===i[1]&&t[2]===i[2]&&t[3]===i[3]&&t[4]===i[4]&&t[5]===i[5]&&t[6]===i[6]&&t[7]===i[7]&&t[8]===i[8]}isIdentity(){var e=this.data;return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&1===e[4]&&0===e[5]&&0===e[6]&&0===e[7]&&1===e[8]}setIdentity(){var e=this.data;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,this}toString(){return"["+this.data.join(", ")+"]"}transpose(e){void 0===e&&(e=this);var t,i=e.data,s=this.data;i===s?(t=i[1],s[1]=i[3],s[3]=t,t=i[2],s[2]=i[6],s[6]=t,t=i[5],s[5]=i[7],s[7]=t):(s[0]=i[0],s[1]=i[3],s[2]=i[6],s[3]=i[1],s[4]=i[4],s[5]=i[7],s[6]=i[2],s[7]=i[5],s[8]=i[8]);return this}setFromMat4(e){var t=e.data,i=this.data;return i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[4],i[4]=t[5],i[5]=t[6],i[6]=t[8],i[7]=t[9],i[8]=t[10],this}setFromQuat(e){var t=e.x,i=e.y,s=e.z,r=e.w,n=t+t,a=i+i,o=s+s,l=t*n,h=t*a,c=t*o,d=i*a,u=i*o,f=s*o,p=r*n,m=r*a,g=r*o,v=this.data;return v[0]=1-(d+f),v[1]=h+g,v[2]=c-m,v[3]=h-g,v[4]=1-(l+f),v[5]=u+p,v[6]=c+m,v[7]=u-p,v[8]=1-(l+d),this}invertMat4(e){var t=e.data,i=t[0],s=t[1],r=t[2],n=t[4],a=t[5],o=t[6],l=t[8],h=t[9],c=t[10],d=c*a-o*h,u=-c*s+r*h,f=o*s-r*a,p=-c*n+o*l,m=c*i-r*l,g=-o*i+r*n,v=h*n-a*l,_=-h*i+s*l,b=a*i-s*n,y=i*d+s*p+r*v;if(0===y)this.setIdentity();else{var x=1/y,S=this.data;S[0]=d*x,S[1]=u*x,S[2]=f*x,S[3]=p*x,S[4]=m*x,S[5]=g*x,S[6]=v*x,S[7]=_*x,S[8]=b*x}return this}transformVector(e,t){void 0===t&&(t=new hi);var i=this.data,{x:s,y:r,z:n}=e;return t.x=s*i[0]+r*i[3]+n*i[6],t.y=s*i[1]+r*i[4]+n*i[7],t.z=s*i[2]+r*i[5]+n*i[8],t}constructor(){this.data=new Float32Array(9),this.data[0]=this.data[4]=this.data[8]=1}}ci.IDENTITY=Object.freeze(new ci),ci.ZERO=Object.freeze((new ci).set([0,0,0,0,0,0,0,0,0]));class di{add(e){return this.x+=e.x,this.y+=e.y,this}add2(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}addScalar(e){return this.x+=e,this.y+=e,this}addScaled(e,t){return this.x+=e.x*t,this.y+=e.y*t,this}clone(){return new(0,this.constructor)(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}cross(e){return this.x*e.y-this.y*e.x}distance(e){var t=this.x-e.x,i=this.y-e.y;return Math.sqrt(t*t+i*i)}div(e){return this.x/=e.x,this.y/=e.y,this}div2(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this}divScalar(e){return this.x/=e,this.y/=e,this}dot(e){return this.x*e.x+this.y*e.y}equals(e){return this.x===e.x&&this.y===e.y}equalsApprox(e,t){return void 0===t&&(t=1e-6),Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSq(){return this.x*this.x+this.y*this.y}lerp(e,t,i){return this.x=e.x+i*(t.x-e.x),this.y=e.y+i*(t.y-e.y),this}mul(e){return this.x*=e.x,this.y*=e.y,this}mul2(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this}mulScalar(e){return this.x*=e,this.y*=e,this}normalize(e){void 0===e&&(e=this);var t=e.x*e.x+e.y*e.y;if(t>0){var i=1/Math.sqrt(t);this.x=e.x*i,this.y=e.y*i}return this}rotate(e){var t=Math.atan2(this.x,this.y)+e*ti.DEG_TO_RAD,i=Math.sqrt(this.x*this.x+this.y*this.y);return this.x=Math.sin(t)*i,this.y=Math.cos(t)*i,this}angle(){return Math.atan2(this.x,this.y)*ti.RAD_TO_DEG}angleTo(e){return Math.atan2(this.x*e.y+this.y*e.x,this.x*e.x+this.y*e.y)*ti.RAD_TO_DEG}floor(e){return void 0===e&&(e=this),this.x=Math.floor(e.x),this.y=Math.floor(e.y),this}ceil(e){return void 0===e&&(e=this),this.x=Math.ceil(e.x),this.y=Math.ceil(e.y),this}round(e){return void 0===e&&(e=this),this.x=Math.round(e.x),this.y=Math.round(e.y),this}min(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),this}max(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),this}set(e,t){return this.x=e,this.y=t,this}sub(e){return this.x-=e.x,this.y-=e.y,this}sub2(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}subScalar(e){return this.x-=e,this.y-=e,this}fromArray(e,t){var i,s;return void 0===t&&(t=0),this.x=null!=(i=e[t])?i:this.x,this.y=null!=(s=e[t+1])?s:this.y,this}toString(){return"["+this.x+", "+this.y+"]"}toArray(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e}static angleRad(e,t){return Math.atan2(e.x*t.y-e.y*t.x,e.x*t.x+e.y*t.y)}constructor(e=0,t=0){2===e.length?(this.x=e[0],this.y=e[1]):(this.x=e,this.y=t)}}di.ZERO=Object.freeze(new di(0,0)),di.HALF=Object.freeze(new di(.5,.5)),di.ONE=Object.freeze(new di(1,1)),di.UP=Object.freeze(new di(0,1)),di.DOWN=Object.freeze(new di(0,-1)),di.RIGHT=Object.freeze(new di(1,0)),di.LEFT=Object.freeze(new di(-1,0));class ui{add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}add2(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addScaled(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this}clone(){return new(0,this.constructor)(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}div(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this}div2(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this.z=e.z/t.z,this.w=e.w/t.w,this}divScalar(e){return this.x/=e,this.y/=e,this.z/=e,this.w/=e,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}equals(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}equalsApprox(e,t){return void 0===t&&(t=1e-6),Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t&&Math.abs(this.w-e.w)<t}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}lerp(e,t,i){return this.x=e.x+i*(t.x-e.x),this.y=e.y+i*(t.y-e.y),this.z=e.z+i*(t.z-e.z),this.w=e.w+i*(t.w-e.w),this}mul(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}mul2(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this.w=e.w*t.w,this}mulScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}normalize(e){void 0===e&&(e=this);var t=e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w;if(t>0){var i=1/Math.sqrt(t);this.x=e.x*i,this.y=e.y*i,this.z=e.z*i,this.w=e.w*i}return this}floor(e){return void 0===e&&(e=this),this.x=Math.floor(e.x),this.y=Math.floor(e.y),this.z=Math.floor(e.z),this.w=Math.floor(e.w),this}ceil(e){return void 0===e&&(e=this),this.x=Math.ceil(e.x),this.y=Math.ceil(e.y),this.z=Math.ceil(e.z),this.w=Math.ceil(e.w),this}round(e){return void 0===e&&(e=this),this.x=Math.round(e.x),this.y=Math.round(e.y),this.z=Math.round(e.z),this.w=Math.round(e.w),this}min(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),e.w<this.w&&(this.w=e.w),this}max(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),e.w>this.w&&(this.w=e.w),this}set(e,t,i,s){return this.x=e,this.y=t,this.z=i,this.w=s,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}sub2(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}fromArray(e,t){var i,s,r,n;return void 0===t&&(t=0),this.x=null!=(i=e[t])?i:this.x,this.y=null!=(s=e[t+1])?s:this.y,this.z=null!=(r=e[t+2])?r:this.z,this.w=null!=(n=e[t+3])?n:this.w,this}toString(){return"["+this.x+", "+this.y+", "+this.z+", "+this.w+"]"}toArray(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e}constructor(e=0,t=0,i=0,s=0){4===e.length?(this.x=e[0],this.y=e[1],this.z=e[2],this.w=e[3]):(this.x=e,this.y=t,this.z=i,this.w=s)}}ui.ZERO=Object.freeze(new ui(0,0,0,0)),ui.HALF=Object.freeze(new ui(.5,.5,.5,.5)),ui.ONE=Object.freeze(new ui(1,1,1,1));var fi=new di,pi=new hi,mi=new hi,gi=new hi,vi=new hi;class _i{static _getPerspectiveHalfSize(e,t,i,s,r){r?(e.x=s*Math.tan(t*Math.PI/360),e.y=e.x/i):(e.y=s*Math.tan(t*Math.PI/360),e.x=e.y*i)}add2(e,t){var i=e.data,s=t.data,r=this.data;return r[0]=i[0]+s[0],r[1]=i[1]+s[1],r[2]=i[2]+s[2],r[3]=i[3]+s[3],r[4]=i[4]+s[4],r[5]=i[5]+s[5],r[6]=i[6]+s[6],r[7]=i[7]+s[7],r[8]=i[8]+s[8],r[9]=i[9]+s[9],r[10]=i[10]+s[10],r[11]=i[11]+s[11],r[12]=i[12]+s[12],r[13]=i[13]+s[13],r[14]=i[14]+s[14],r[15]=i[15]+s[15],this}add(e){return this.add2(this,e)}clone(){return(new(0,this.constructor)).copy(this)}copy(e){var t=e.data,i=this.data;return i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[4]=t[4],i[5]=t[5],i[6]=t[6],i[7]=t[7],i[8]=t[8],i[9]=t[9],i[10]=t[10],i[11]=t[11],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15],this}equals(e){var t=this.data,i=e.data;return t[0]===i[0]&&t[1]===i[1]&&t[2]===i[2]&&t[3]===i[3]&&t[4]===i[4]&&t[5]===i[5]&&t[6]===i[6]&&t[7]===i[7]&&t[8]===i[8]&&t[9]===i[9]&&t[10]===i[10]&&t[11]===i[11]&&t[12]===i[12]&&t[13]===i[13]&&t[14]===i[14]&&t[15]===i[15]}isIdentity(){var e=this.data;return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&1===e[5]&&0===e[6]&&0===e[7]&&0===e[8]&&0===e[9]&&1===e[10]&&0===e[11]&&0===e[12]&&0===e[13]&&0===e[14]&&1===e[15]}mul2(e,t){var i,s,r,n,a=e.data,o=t.data,l=this.data,h=a[0],c=a[1],d=a[2],u=a[3],f=a[4],p=a[5],m=a[6],g=a[7],v=a[8],_=a[9],b=a[10],y=a[11],x=a[12],S=a[13],w=a[14],T=a[15];return i=o[0],s=o[1],r=o[2],n=o[3],l[0]=h*i+f*s+v*r+x*n,l[1]=c*i+p*s+_*r+S*n,l[2]=d*i+m*s+b*r+w*n,l[3]=u*i+g*s+y*r+T*n,i=o[4],s=o[5],r=o[6],n=o[7],l[4]=h*i+f*s+v*r+x*n,l[5]=c*i+p*s+_*r+S*n,l[6]=d*i+m*s+b*r+w*n,l[7]=u*i+g*s+y*r+T*n,i=o[8],s=o[9],r=o[10],n=o[11],l[8]=h*i+f*s+v*r+x*n,l[9]=c*i+p*s+_*r+S*n,l[10]=d*i+m*s+b*r+w*n,l[11]=u*i+g*s+y*r+T*n,i=o[12],s=o[13],r=o[14],n=o[15],l[12]=h*i+f*s+v*r+x*n,l[13]=c*i+p*s+_*r+S*n,l[14]=d*i+m*s+b*r+w*n,l[15]=u*i+g*s+y*r+T*n,this}mulAffine2(e,t){var i,s,r,n=e.data,a=t.data,o=this.data,l=n[0],h=n[1],c=n[2],d=n[4],u=n[5],f=n[6],p=n[8],m=n[9],g=n[10],v=n[12],_=n[13],b=n[14];return i=a[0],s=a[1],r=a[2],o[0]=l*i+d*s+p*r,o[1]=h*i+u*s+m*r,o[2]=c*i+f*s+g*r,o[3]=0,i=a[4],s=a[5],r=a[6],o[4]=l*i+d*s+p*r,o[5]=h*i+u*s+m*r,o[6]=c*i+f*s+g*r,o[7]=0,i=a[8],s=a[9],r=a[10],o[8]=l*i+d*s+p*r,o[9]=h*i+u*s+m*r,o[10]=c*i+f*s+g*r,o[11]=0,i=a[12],s=a[13],r=a[14],o[12]=l*i+d*s+p*r+v,o[13]=h*i+u*s+m*r+_,o[14]=c*i+f*s+g*r+b,o[15]=1,this}mul(e){return this.mul2(this,e)}transformPoint(e,t){void 0===t&&(t=new hi);var i=this.data,{x:s,y:r,z:n}=e;return t.x=s*i[0]+r*i[4]+n*i[8]+i[12],t.y=s*i[1]+r*i[5]+n*i[9]+i[13],t.z=s*i[2]+r*i[6]+n*i[10]+i[14],t}transformVector(e,t){void 0===t&&(t=new hi);var i=this.data,{x:s,y:r,z:n}=e;return t.x=s*i[0]+r*i[4]+n*i[8],t.y=s*i[1]+r*i[5]+n*i[9],t.z=s*i[2]+r*i[6]+n*i[10],t}transformVec4(e,t){void 0===t&&(t=new ui);var i=this.data,{x:s,y:r,z:n,w:a}=e;return t.x=s*i[0]+r*i[4]+n*i[8]+a*i[12],t.y=s*i[1]+r*i[5]+n*i[9]+a*i[13],t.z=s*i[2]+r*i[6]+n*i[10]+a*i[14],t.w=s*i[3]+r*i[7]+n*i[11]+a*i[15],t}setLookAt(e,t,i){gi.sub2(e,t).normalize(),mi.copy(i).normalize(),pi.cross(mi,gi).normalize(),mi.cross(gi,pi);var s=this.data;return s[0]=pi.x,s[1]=pi.y,s[2]=pi.z,s[3]=0,s[4]=mi.x,s[5]=mi.y,s[6]=mi.z,s[7]=0,s[8]=gi.x,s[9]=gi.y,s[10]=gi.z,s[11]=0,s[12]=e.x,s[13]=e.y,s[14]=e.z,s[15]=1,this}setFrustum(e,t,i,s,r,n){var a=2*r,o=t-e,l=s-i,h=n-r,c=this.data;return c[0]=a/o,c[1]=0,c[2]=0,c[3]=0,c[4]=0,c[5]=a/l,c[6]=0,c[7]=0,c[8]=(t+e)/o,c[9]=(s+i)/l,c[10]=(-n-r)/h,c[11]=-1,c[12]=0,c[13]=0,c[14]=-a*n/h,c[15]=0,this}setPerspective(e,t,i,s,r){return _i._getPerspectiveHalfSize(fi,e,t,i,r),this.setFrustum(-fi.x,fi.x,-fi.y,fi.y,i,s)}setOrtho(e,t,i,s,r,n){var a=this.data;return a[0]=2/(t-e),a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/(s-i),a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=-2/(n-r),a[11]=0,a[12]=-(t+e)/(t-e),a[13]=-(s+i)/(s-i),a[14]=-(n+r)/(n-r),a[15]=1,this}setFromAxisAngle(e,t){t*=ti.DEG_TO_RAD;var{x:i,y:s,z:r}=e,n=Math.cos(t),a=Math.sin(t),o=1-n,l=o*i,h=o*s,c=this.data;return c[0]=l*i+n,c[1]=l*s+a*r,c[2]=l*r-a*s,c[3]=0,c[4]=l*s-a*r,c[5]=h*s+n,c[6]=h*r+a*i,c[7]=0,c[8]=l*r+a*s,c[9]=h*r-i*a,c[10]=o*r*r+n,c[11]=0,c[12]=0,c[13]=0,c[14]=0,c[15]=1,this}setTranslate(e,t,i){var s=this.data;return s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=1,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=e,s[13]=t,s[14]=i,s[15]=1,this}setScale(e,t,i){var s=this.data;return s[0]=e,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=t,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=i,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,this}setViewport(e,t,i,s){var r=this.data;return r[0]=.5*i,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=.5*s,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=.5,r[11]=0,r[12]=e+.5*i,r[13]=t+.5*s,r[14]=.5,r[15]=1,this}setReflection(e,t){var i=e.x,s=e.y,r=e.z,n=this.data;return n[0]=1-2*i*i,n[1]=-2*i*s,n[2]=-2*i*r,n[3]=0,n[4]=-2*i*s,n[5]=1-2*s*s,n[6]=-2*s*r,n[7]=0,n[8]=-2*i*r,n[9]=-2*s*r,n[10]=1-2*r*r,n[11]=0,n[12]=-2*i*t,n[13]=-2*s*t,n[14]=-2*r*t,n[15]=1,this}invert(e){void 0===e&&(e=this);var t=e.data,i=t[0],s=t[1],r=t[2],n=t[3],a=t[4],o=t[5],l=t[6],h=t[7],c=t[8],d=t[9],u=t[10],f=t[11],p=t[12],m=t[13],g=t[14],v=t[15],_=i*o-s*a,b=i*l-r*a,y=i*h-n*a,x=s*l-r*o,S=s*h-n*o,w=r*h-n*l,T=c*m-d*p,C=c*g-u*p,E=c*v-f*p,A=d*g-u*m,P=d*v-f*m,D=u*v-f*g,L=_*D-b*P+y*A+x*E-S*C+w*T;if(0===L)this.setIdentity();else{var M=1/L,I=this.data;I[0]=(o*D-l*P+h*A)*M,I[1]=(-s*D+r*P-n*A)*M,I[2]=(m*w-g*S+v*x)*M,I[3]=(-d*w+u*S-f*x)*M,I[4]=(-a*D+l*E-h*C)*M,I[5]=(i*D-r*E+n*C)*M,I[6]=(-p*w+g*y-v*b)*M,I[7]=(c*w-u*y+f*b)*M,I[8]=(a*P-o*E+h*T)*M,I[9]=(-i*P+s*E-n*T)*M,I[10]=(p*S-m*y+v*_)*M,I[11]=(-c*S+d*y-f*_)*M,I[12]=(-a*A+o*C-l*T)*M,I[13]=(i*A-s*C+r*T)*M,I[14]=(-p*x+m*b-g*_)*M,I[15]=(c*x-d*b+u*_)*M}return this}set(e){var t=this.data;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],this}setIdentity(){var e=this.data;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}setTRS(e,t,i){var s=t.x,r=t.y,n=t.z,a=t.w,o=i.x,l=i.y,h=i.z,c=s+s,d=r+r,u=n+n,f=s*c,p=s*d,m=s*u,g=r*d,v=r*u,_=n*u,b=a*c,y=a*d,x=a*u,S=this.data;return S[0]=(1-(g+_))*o,S[1]=(p+x)*o,S[2]=(m-y)*o,S[3]=0,S[4]=(p-x)*l,S[5]=(1-(f+_))*l,S[6]=(v+b)*l,S[7]=0,S[8]=(m+y)*h,S[9]=(v-b)*h,S[10]=(1-(f+g))*h,S[11]=0,S[12]=e.x,S[13]=e.y,S[14]=e.z,S[15]=1,this}transpose(e){void 0===e&&(e=this);var t,i=e.data,s=this.data;i===s?(t=i[1],s[1]=i[4],s[4]=t,t=i[2],s[2]=i[8],s[8]=t,t=i[3],s[3]=i[12],s[12]=t,t=i[6],s[6]=i[9],s[9]=t,t=i[7],s[7]=i[13],s[13]=t,t=i[11],s[11]=i[14],s[14]=t):(s[0]=i[0],s[1]=i[4],s[2]=i[8],s[3]=i[12],s[4]=i[1],s[5]=i[5],s[6]=i[9],s[7]=i[13],s[8]=i[2],s[9]=i[6],s[10]=i[10],s[11]=i[14],s[12]=i[3],s[13]=i[7],s[14]=i[11],s[15]=i[15]);return this}getTranslation(e){return void 0===e&&(e=new hi),e.set(this.data[12],this.data[13],this.data[14])}getX(e){return void 0===e&&(e=new hi),e.set(this.data[0],this.data[1],this.data[2])}getY(e){return void 0===e&&(e=new hi),e.set(this.data[4],this.data[5],this.data[6])}getZ(e){return void 0===e&&(e=new hi),e.set(this.data[8],this.data[9],this.data[10])}getScale(e){return void 0===e&&(e=new hi),this.getX(pi),this.getY(mi),this.getZ(gi),e.set(pi.length(),mi.length(),gi.length()),e}get scaleSign(){return this.getX(pi),this.getY(mi),this.getZ(gi),pi.cross(pi,mi),pi.dot(gi)<0?-1:1}setFromEulerAngles(e,t,i){e*=ti.DEG_TO_RAD,t*=ti.DEG_TO_RAD,i*=ti.DEG_TO_RAD;var s=Math.sin(-e),r=Math.cos(-e),n=Math.sin(-t),a=Math.cos(-t),o=Math.sin(-i),l=Math.cos(-i),h=this.data;return h[0]=a*l,h[1]=-a*o,h[2]=n,h[3]=0,h[4]=r*o+l*s*n,h[5]=r*l-s*n*o,h[6]=-a*s,h[7]=0,h[8]=s*o-r*l*n,h[9]=l*s+r*n*o,h[10]=r*a,h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,this}getEulerAngles(e){void 0===e&&(e=new hi),this.getScale(vi);var t=vi.x,i=vi.y,s=vi.z;if(0===t||0===i||0===s)return e.set(0,0,0);var r,n,a=this.data,o=Math.asin(-a[2]/t),l=.5*Math.PI;return o<l?o>-l?(r=Math.atan2(a[6]/i,a[10]/s),n=Math.atan2(a[1]/t,a[0]/t)):(n=0,r=-Math.atan2(a[4]/i,a[5]/i)):(n=0,r=Math.atan2(a[4]/i,a[5]/i)),e.set(r,o,n).mulScalar(ti.RAD_TO_DEG)}toString(){return"["+this.data.join(", ")+"]"}constructor(){this.data=new Float32Array(16),this.data[0]=this.data[5]=this.data[10]=this.data[15]=1}}_i.IDENTITY=Object.freeze(new _i),_i.ZERO=Object.freeze((new _i).set([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]));class bi{clone(){return new(0,this.constructor)(this.x,this.y,this.z,this.w)}conjugate(e){return void 0===e&&(e=this),this.x=-1*e.x,this.y=-1*e.y,this.z=-1*e.z,this.w=e.w,this}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}equals(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}equalsApprox(e,t){return void 0===t&&(t=1e-6),Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t&&Math.abs(this.w-e.w)<t}getAxisAngle(e){var t=2*Math.acos(this.w),i=Math.sin(t/2);return 0!==i?(e.x=this.x/i,e.y=this.y/i,e.z=this.z/i,(e.x<0||e.y<0||e.z<0)&&(e.x*=-1,e.y*=-1,e.z*=-1,t*=-1)):(e.x=1,e.y=0,e.z=0),t*ti.RAD_TO_DEG}getEulerAngles(e){var t,i,s;void 0===e&&(e=new hi);var r=this.x,n=this.y,a=this.z,o=this.w,l=2*(o*n-r*a);return l<=-.99999?(t=2*Math.atan2(r,o),i=-Math.PI/2,s=0):l>=.99999?(t=2*Math.atan2(r,o),i=Math.PI/2,s=0):(t=Math.atan2(2*(o*r+n*a),1-2*(r*r+n*n)),i=Math.asin(l),s=Math.atan2(2*(o*a+r*n),1-2*(n*n+a*a))),e.set(t,i,s).mulScalar(ti.RAD_TO_DEG)}invert(e){return void 0===e&&(e=this),this.conjugate(e).normalize()}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}mul(e){var t=this.x,i=this.y,s=this.z,r=this.w,n=e.x,a=e.y,o=e.z,l=e.w;return this.x=r*n+t*l+i*o-s*a,this.y=r*a+i*l+s*n-t*o,this.z=r*o+s*l+t*a-i*n,this.w=r*l-t*n-i*a-s*o,this}mulScalar(e,t){return void 0===t&&(t=this),this.x=t.x*e,this.y=t.y*e,this.z=t.z*e,this.w=t.w*e,this}mul2(e,t){var i=e.x,s=e.y,r=e.z,n=e.w,a=t.x,o=t.y,l=t.z,h=t.w;return this.x=n*a+i*h+s*l-r*o,this.y=n*o+s*h+r*a-i*l,this.z=n*l+r*h+i*o-s*a,this.w=n*h-i*a-s*o-r*l,this}normalize(e){void 0===e&&(e=this);var t=e.length();return 0===t?(this.x=this.y=this.z=0,this.w=1):(t=1/t,this.x=e.x*t,this.y=e.y*t,this.z=e.z*t,this.w=e.w*t),this}set(e,t,i,s){return this.x=e,this.y=t,this.z=i,this.w=s,this}setFromAxisAngle(e,t){t*=.5*ti.DEG_TO_RAD;var i=Math.sin(t),s=Math.cos(t);return this.x=i*e.x,this.y=i*e.y,this.z=i*e.z,this.w=s,this}setFromEulerAngles(e,t,i){if(e instanceof hi){var s=e;e=s.x,t=s.y,i=s.z}var r=.5*ti.DEG_TO_RAD;e*=r,t*=r,i*=r;var n=Math.sin(e),a=Math.cos(e),o=Math.sin(t),l=Math.cos(t),h=Math.sin(i),c=Math.cos(i);return this.x=n*l*c-a*o*h,this.y=a*o*c+n*l*h,this.z=a*l*h-n*o*c,this.w=a*l*c+n*o*h,this}setFromMat4(e){var t,i=e.data,s=i[0],r=i[1],n=i[2],a=i[4],o=i[5],l=i[6],h=i[8],c=i[9],d=i[10];return 0===(t=s*s+r*r+n*n)?this.set(0,0,0,1):(s*=t=1/Math.sqrt(t),r*=t,n*=t,0===(t=a*a+o*o+l*l)?this.set(0,0,0,1):(a*=t=1/Math.sqrt(t),o*=t,l*=t,0===(t=h*h+c*c+d*d)?this.set(0,0,0,1):(h*=t=1/Math.sqrt(t),c*=t,(d*=t)<0?s>o?this.set(1+s-o-d,r+a,h+n,l-c):this.set(r+a,1-s+o-d,l+c,h-n):s<-o?this.set(h+n,l+c,1-s-o+d,r-a):this.set(l-c,h-n,r-a,1+s+o+d),this.mulScalar(1/this.length()))))}setFromDirections(e,t){var i=1+e.dot(t);return i<Number.EPSILON?Math.abs(e.x)>Math.abs(e.y)?(this.x=-e.z,this.y=0,this.z=e.x,this.w=0):(this.x=0,this.y=-e.z,this.z=e.y,this.w=0):(this.x=e.y*t.z-e.z*t.y,this.y=e.z*t.x-e.x*t.z,this.z=e.x*t.y-e.y*t.x,this.w=i),this.normalize()}slerp(e,t,i){var s=e.x,r=e.y,n=e.z,a=e.w,o=t.x,l=t.y,h=t.z,c=t.w,d=a*c+s*o+r*l+n*h;if(d<0&&(c=-c,o=-o,l=-l,h=-h,d=-d),Math.abs(d)>=1)return this.w=a,this.x=s,this.y=r,this.z=n,this;var u=Math.acos(d),f=Math.sqrt(1-d*d);if(Math.abs(f)<.001)return this.w=.5*a+.5*c,this.x=.5*s+.5*o,this.y=.5*r+.5*l,this.z=.5*n+.5*h,this;var p=Math.sin((1-i)*u)/f,m=Math.sin(i*u)/f;return this.w=a*p+c*m,this.x=s*p+o*m,this.y=r*p+l*m,this.z=n*p+h*m,this}transformVector(e,t){void 0===t&&(t=new hi);var i=e.x,s=e.y,r=e.z,n=this.x,a=this.y,o=this.z,l=this.w,h=l*i+a*r-o*s,c=l*s+o*i-n*r,d=l*r+n*s-a*i,u=-n*i-a*s-o*r;return t.x=h*l+u*-n+c*-o-d*-a,t.y=c*l+u*-a+d*-n-h*-o,t.z=d*l+u*-o+h*-a-c*-n,t}toString(){return"["+this.x+", "+this.y+", "+this.z+", "+this.w+"]"}constructor(e=0,t=0,i=0,s=1){4===e.length?(this.x=e[0],this.y=e[1],this.z=e[2],this.w=e[3]):(this.x=e,this.y=t,this.z=i,this.w=s)}}bi.IDENTITY=Object.freeze(new bi(0,0,0,1)),bi.ZERO=Object.freeze(new bi(0,0,0,0));var yi=new hi,xi=new hi,Si=new hi,wi=new hi,Ti=new hi;class Ci{add(e){var t=this.center,i=t.x,s=t.y,r=t.z,n=this.halfExtents,a=n.x,o=n.y,l=n.z,h=i-a,c=i+a,d=s-o,u=s+o,f=r-l,p=r+l,m=e.center,g=m.x,v=m.y,_=m.z,b=e.halfExtents,y=b.x,x=b.y,S=b.z,w=g-y,T=g+y,C=v-x,E=v+x,A=_-S,P=_+S;w<h&&(h=w),T>c&&(c=T),C<d&&(d=C),E>u&&(u=E),A<f&&(f=A),P>p&&(p=P),t.x=.5*(h+c),t.y=.5*(d+u),t.z=.5*(f+p),n.x=.5*(c-h),n.y=.5*(u-d),n.z=.5*(p-f)}copy(e){this.center.copy(e.center),this.halfExtents.copy(e.halfExtents)}clone(){return new Ci(this.center,this.halfExtents)}intersects(e){var t=this.getMax(),i=this.getMin(),s=e.getMax(),r=e.getMin();return i.x<=s.x&&t.x>=r.x&&i.y<=s.y&&t.y>=r.y&&i.z<=s.z&&t.z>=r.z}_intersectsRay(e,t){var i=yi.copy(this.getMin()).sub(e.origin),s=xi.copy(this.getMax()).sub(e.origin),r=e.direction;0===r.x?(i.x=i.x<0?-Number.MAX_VALUE:Number.MAX_VALUE,s.x=s.x<0?-Number.MAX_VALUE:Number.MAX_VALUE):(i.x/=r.x,s.x/=r.x),0===r.y?(i.y=i.y<0?-Number.MAX_VALUE:Number.MAX_VALUE,s.y=s.y<0?-Number.MAX_VALUE:Number.MAX_VALUE):(i.y/=r.y,s.y/=r.y),0===r.z?(i.z=i.z<0?-Number.MAX_VALUE:Number.MAX_VALUE,s.z=s.z<0?-Number.MAX_VALUE:Number.MAX_VALUE):(i.z/=r.z,s.z/=r.z);var n=Si.set(Math.min(i.x,s.x),Math.min(i.y,s.y),Math.min(i.z,s.z)),a=wi.set(Math.max(i.x,s.x),Math.max(i.y,s.y),Math.max(i.z,s.z)),o=Math.min(Math.min(a.x,a.y),a.z),l=Math.max(Math.max(n.x,n.y),n.z),h=o>=l&&l>=0;return h&&t.copy(e.direction).mulScalar(l).add(e.origin),h}_fastIntersectsRay(e){var t=yi,i=xi,s=Si,r=wi,n=Ti,a=e.direction;return t.sub2(e.origin,this.center),r.set(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z)),s.mul2(t,a),!(r.x>this.halfExtents.x&&s.x>=0)&&(!(r.y>this.halfExtents.y&&s.y>=0)&&(!(r.z>this.halfExtents.z&&s.z>=0)&&(n.set(Math.abs(a.x),Math.abs(a.y),Math.abs(a.z)),i.cross(a,t),i.set(Math.abs(i.x),Math.abs(i.y),Math.abs(i.z)),!(i.x>this.halfExtents.y*n.z+this.halfExtents.z*n.y)&&(!(i.y>this.halfExtents.x*n.z+this.halfExtents.z*n.x)&&!(i.z>this.halfExtents.x*n.y+this.halfExtents.y*n.x)))))}intersectsRay(e,t){return t?this._intersectsRay(e,t):this._fastIntersectsRay(e)}setMinMax(e,t){this.center.add2(t,e).mulScalar(.5),this.halfExtents.sub2(t,e).mulScalar(.5)}getMin(){return this._min.copy(this.center).sub(this.halfExtents)}getMax(){return this._max.copy(this.center).add(this.halfExtents)}containsPoint(e){var t=this.getMin(),i=this.getMax();return!(e.x<t.x||e.x>i.x||e.y<t.y||e.y>i.y||e.z<t.z||e.z>i.z)}setFromTransformedAabb(e,t,i){void 0===i&&(i=!1);var s=e.center,r=e.halfExtents,n=t.data,a=n[0],o=n[4],l=n[8],h=n[1],c=n[5],d=n[9],u=n[2],f=n[6],p=n[10];if(i){var m=a*a+o*o+l*l;if(m>0){var g=1/Math.sqrt(m);a*=g,o*=g,l*=g}if((m=h*h+c*c+d*d)>0){var v=1/Math.sqrt(m);h*=v,c*=v,d*=v}if((m=u*u+f*f+p*p)>0){var _=1/Math.sqrt(m);u*=_,f*=_,p*=_}}this.center.set(n[12]+a*s.x+o*s.y+l*s.z,n[13]+h*s.x+c*s.y+d*s.z,n[14]+u*s.x+f*s.y+p*s.z),this.halfExtents.set(Math.abs(a)*r.x+Math.abs(o)*r.y+Math.abs(l)*r.z,Math.abs(h)*r.x+Math.abs(c)*r.y+Math.abs(d)*r.z,Math.abs(u)*r.x+Math.abs(f)*r.y+Math.abs(p)*r.z)}static computeMinMax(e,t,i,s){if(void 0===s&&(s=e.length/3),s>0){for(var r=e[0],n=e[1],a=e[2],o=r,l=n,h=a,c=3*s,d=3;d<c;d+=3){var u=e[d],f=e[d+1],p=e[d+2];u<r&&(r=u),f<n&&(n=f),p<a&&(a=p),u>o&&(o=u),f>l&&(l=f),p>h&&(h=p)}t.set(r,n,a),i.set(o,l,h)}}compute(e,t){Ci.computeMinMax(e,yi,xi,t),this.setMinMax(yi,xi)}intersectsBoundingSphere(e){return this._distanceToBoundingSphereSq(e)<=e.radius*e.radius}_distanceToBoundingSphereSq(e){for(var t=this.getMin(),i=this.getMax(),s=0,r=["x","y","z"],n=0;n<3;++n){var a=0,o=e.center[r[n]],l=t[r[n]],h=i[r[n]],c=0;o<l&&(a+=(c=l-o)*c),o>h&&(a+=(c=o-h)*c),s+=a}return s}_expand(e,t){yi.add2(this.getMin(),e),xi.add2(this.getMax(),t),this.setMinMax(yi,xi)}constructor(e,t){this.center=new hi,this.halfExtents=new hi(.5,.5,.5),this._min=new hi,this._max=new hi,e&&this.center.copy(e),t&&this.halfExtents.copy(t)}}var Ei=new hi,Ai=new hi;class Pi{containsPoint(e){var t=Ei.sub2(e,this.center).lengthSq(),i=this.radius;return t<i*i}intersectsRay(e,t){var i=Ei.copy(e.origin).sub(this.center),s=i.dot(Ai.copy(e.direction).normalize()),r=i.dot(i)-this.radius*this.radius;if(r>0&&s>0)return!1;var n=s*s-r;if(n<0)return!1;var a=Math.abs(-s-Math.sqrt(n));return t&&t.copy(e.direction).mulScalar(a).add(e.origin),!0}intersectsBoundingSphere(e){Ei.sub2(e.center,this.center);var t=e.radius+this.radius;return Ei.lengthSq()<=t*t}constructor(e=new hi,t=.5){this.center=e,this.radius=t}}class Di{clone(){return(new(0,this.constructor)).copy(this)}copy(e){return this.normal.copy(e.normal),this.distance=e.distance,this}intersectsLine(e,t,i){var s=this.distance,r=this.normal.dot(e)+s,n=r/(r-(this.normal.dot(t)+s)),a=n>=0&&n<=1;return a&&i&&i.lerp(e,t,n),a}intersectsRay(e,t){var i=this.normal.dot(e.direction);if(0===i)return!1;var s=-(this.normal.dot(e.origin)+this.distance)/i;return s>=0&&t&&t.copy(e.direction).mulScalar(s).add(e.origin),s>=0}normalize(){var e=1/this.normal.length();return this.normal.mulScalar(e),this.distance*=e,this}set(e,t,i,s){return this.normal.set(e,t,i),this.distance=s,this}setFromPointNormal(e,t){return this.normal.copy(t),this.distance=-this.normal.dot(e),this}constructor(e=hi.UP,t=0){this.normal=new hi,this.normal.copy(e),this.distance=t}}class Li{clone(){return(new(0,this.constructor)).copy(this)}copy(e){for(var t=0;t<6;t++)this.planes[t].copy(e.planes[t]);return this}setFromMat4(e){var[t,i,s,r,n,a,o,l,h,c,d,u,f,p,m,g]=e.data,v=this.planes;v[0].set(r-t,l-n,u-h,g-f).normalize(),v[1].set(r+t,l+n,u+h,g+f).normalize(),v[2].set(r+i,l+a,u+c,g+p).normalize(),v[3].set(r-i,l-a,u-c,g-p).normalize(),v[4].set(r-s,l-o,u-d,g-m).normalize(),v[5].set(r+s,l+o,u+d,g+m).normalize()}containsPoint(e){for(var t=0;t<6;t++){var{normal:i,distance:s}=this.planes[t];if(i.dot(e)+s<=0)return!1}return!0}containsSphere(e){for(var{center:t,radius:i}=e,s=0,r=0;r<6;r++){var{normal:n,distance:a}=this.planes[r],o=n.dot(t)+a;if(o<=-i)return 0;o>i&&s++}return 6===s?2:1}constructor(){this.planes=[];for(var e=0;e<6;e++)this.planes[e]=new Di}}class Mi{set(e,t){return this.origin.copy(e),this.direction.copy(t),this}copy(e){return this.set(e.origin,e.direction)}clone(){return new this.constructor(this.origin,this.direction)}constructor(e,t){this.origin=new hi,this.direction=hi.FORWARD.clone(),e&&this.origin.copy(e),t&&this.direction.copy(t)}}var Ii=10,Ri=12,ki=14,Oi=15,Fi=16,Bi=17,Ni=18,zi=20,Ui=24,Vi=25,Hi=37,Gi=49,Wi=69,ji=new Map([[0,{name:"A8",size:1,ldr:!0}],[52,{name:"R8",size:1,ldr:!0}],[1,{name:"L8",size:1,ldr:!0}],[2,{name:"LA8",size:2,ldr:!0}],[53,{name:"RG8",size:2,ldr:!0}],[3,{name:"RGB565",size:2,ldr:!0}],[4,{name:"RGBA5551",size:2,ldr:!0}],[5,{name:"RGBA4",size:2,ldr:!0}],[6,{name:"RGB8",size:4,ldr:!0}],[7,{name:"RGBA8",size:4,ldr:!0,srgbFormat:zi}],[50,{name:"R16F",size:2}],[51,{name:"RG16F",size:4}],[11,{name:"RGB16F",size:8}],[Ri,{name:"RGBA16F",size:8}],[13,{name:"RGB32F",size:16}],[ki,{name:"RGBA32F",size:16}],[Oi,{name:"R32F",size:4}],[Fi,{name:"DEPTH",size:4}],[Wi,{name:"DEPTH16",size:2}],[Bi,{name:"DEPTHSTENCIL",size:4}],[Ni,{name:"111110F",size:4}],[19,{name:"SRGB8",size:4,ldr:!0,srgb:!0}],[zi,{name:"SRGBA8",size:4,ldr:!0,srgb:!0}],[31,{name:"BGRA8",size:4,ldr:!0}],[64,{name:"SBGRA8",size:4,ldr:!0,srgb:!0}],[8,{name:"DXT1",blockSize:8,ldr:!0,srgbFormat:54}],[9,{name:"DXT3",blockSize:16,ldr:!0,srgbFormat:55}],[Ii,{name:"DXT5",blockSize:16,ldr:!0,srgbFormat:56}],[21,{name:"ETC1",blockSize:8,ldr:!0}],[22,{name:"ETC2_RGB",blockSize:8,ldr:!0,srgbFormat:61}],[23,{name:"ETC2_RGBA",blockSize:16,ldr:!0,srgbFormat:62}],[Ui,{name:"PVRTC_2BPP_RGB_1",ldr:!0,blockSize:8}],[Vi,{name:"PVRTC_2BPP_RGBA_1",ldr:!0,blockSize:8}],[26,{name:"PVRTC_4BPP_RGB_1",ldr:!0,blockSize:8}],[27,{name:"PVRTC_4BPP_RGBA_1",ldr:!0,blockSize:8}],[28,{name:"ASTC_4x4",blockSize:16,ldr:!0,srgbFormat:63}],[29,{name:"ATC_RGB",blockSize:8,ldr:!0}],[30,{name:"ATC_RGBA",blockSize:16,ldr:!0}],[65,{name:"BC6H_RGBF",blockSize:16}],[66,{name:"BC6H_RGBUF",blockSize:16}],[67,{name:"BC7_RGBA",blockSize:16,ldr:!0,srgbFormat:68}],[54,{name:"DXT1_SRGB",blockSize:8,ldr:!0,srgb:!0}],[55,{name:"DXT3_SRGBA",blockSize:16,ldr:!0,srgb:!0}],[56,{name:"DXT5_SRGBA",blockSize:16,ldr:!0,srgb:!0}],[61,{name:"ETC2_SRGB",blockSize:8,ldr:!0,srgb:!0}],[62,{name:"ETC2_SRGBA",blockSize:16,ldr:!0,srgb:!0}],[63,{name:"ASTC_4x4_SRGB",blockSize:16,ldr:!0,srgb:!0}],[68,{name:"BC7_SRGBA",blockSize:16,ldr:!0,srgb:!0}],[32,{name:"R8I",size:1,isInt:!0}],[33,{name:"R8U",size:1,isInt:!0}],[34,{name:"R16I",size:2,isInt:!0}],[35,{name:"R16U",size:2,isInt:!0}],[36,{name:"R32I",size:4,isInt:!0}],[Hi,{name:"R32U",size:4,isInt:!0}],[38,{name:"RG8I",size:2,isInt:!0}],[39,{name:"RG8U",size:2,isInt:!0}],[40,{name:"RG16I",size:4,isInt:!0}],[41,{name:"RG16U",size:4,isInt:!0}],[42,{name:"RG32I",size:8,isInt:!0}],[43,{name:"RG32U",size:8,isInt:!0}],[44,{name:"RGBA8I",size:4,isInt:!0}],[45,{name:"RGBA8U",size:4,isInt:!0}],[46,{name:"RGBA16I",size:8,isInt:!0}],[47,{name:"RGBA16U",size:8,isInt:!0}],[48,{name:"RGBA32I",size:16,isInt:!0}],[Gi,{name:"RGBA32U",size:16,isInt:!0}]]),qi=e=>{var t;return void 0!==(null==(t=ji.get(e))?void 0:t.blockSize)},Xi=e=>{var t;return!0===(null==(t=ji.get(e))?void 0:t.srgb)},Ki=e=>{var t;return!0===(null==(t=ji.get(e))?void 0:t.isInt)},Yi=e=>{var t;return(null==(t=ji.get(e))?void 0:t.srgbFormat)||e},Qi=e=>{switch(e){case Oi:case 13:case ki:return Float32Array;case 36:case 42:case 48:return Int32Array;case Hi:case 43:case Gi:return Uint32Array;case 34:case 40:case 46:return Int16Array;case 53:case 35:case 41:case 47:case 3:case 4:case 5:case 50:case 51:case 11:case Ri:return Uint16Array;case 32:case 38:case 44:return Int8Array;default:return Uint8Array}},Ji="POSITION",$i="NORMAL",Zi="TANGENT",es="BLENDWEIGHT",ts="BLENDINDICES",is="COLOR",ss="TEXCOORD",rs="TEXCOORD0",ns="TEXCOORD1",as="TEXCOORD2",os="TEXCOORD3",ls="TEXCOORD4",hs="TEXCOORD5",cs="TEXCOORD6",ds="TEXCOORD7",us="ATTR8",fs="ATTR9",ps="ATTR12",ms="ATTR13",gs="ATTR14",vs="ATTR15",_s="default",bs="rgbm",ys="rgbe",xs="rgbp",Ss="swizzleGGGR",ws="2d",Ts="2d-array",Cs="cube",Es="cube-array",As="3d",Ps="cube",Ds="equirect",Ls="glsl",Ms="wgsl",Is=14,Rs=26,ks=27,Os=28,Fs=29,Bs=30,Ns=33,zs=36,Us=["bool","int","float","vec2","vec3","vec4","ivec2","ivec3","ivec4","bvec2","bvec3","bvec4","mat2","mat3","mat4","sampler2D","samplerCube","","sampler2DShadow","samplerCubeShadow","sampler3D","","","","","sampler2DArray","uint","uvec2","uvec3","uvec4","","","","","","","","","","","","","isampler2D","usampler2D","isamplerCube","usamplerCube","isampler3D","usampler3D","isampler2DArray","usampler2DArray"],Vs=[["bool"],["i32"],["f32"],["vec2f","vec2<f32>"],["vec3f","vec3<f32>"],["vec4f","vec4<f32>"],["vec2i","vec2<i32>"],["vec3i","vec3<i32>"],["vec4i","vec4<i32>"],["vec2<bool>"],["vec3<bool>"],["vec4<bool>"],["mat2x2f","mat2x2<f32>"],["mat3x3f","mat3x3<f32>"],["mat4x4f","mat4x4<f32>"],["texture_2d<f32>"],["texture_cube<f32>"],["array<f32>"],["texture_depth_2d"],["texture_depth_cube"],["texture_3d<f32>"],["array<vec2<f32>>"],["array<vec3<f32>>"],["array<vec4<f32>>"],["array<mat4x4<f32>>"],["texture_2d_array<f32>"],["u32"],["vec2u","vec2<u32>"],["vec3u","vec3<u32>"],["vec4u","vec4<u32>"],["array<i32>"],["array<u32>"],["array<bool>"],["array<vec2i>","array<vec2<i32>>"],["array<vec2u>","array<vec2<u32>>"],["array<vec2b>","array<vec2<bool>>"],["array<vec3i>","array<vec3<i32>>"],["array<vec3u>","array<vec3<u32>>"],["array<vec3b>","array<vec3<bool>>"],["array<vec4i>","array<vec4<i32>>"],["array<vec4u>","array<vec4<u32>>"],["array<vec4b>","array<vec4<bool>>"],["texture_2d<i32>"],["texture_2d<u32>"],["texture_cube<i32>"],["texture_cube<u32>"],["texture_3d<i32>"],["texture_3d<u32>"],["texture_2d_array<i32>"],["texture_2d_array<u32>"]],Hs=new Map;Vs.forEach(((e,t)=>{e.forEach((e=>Hs.set(e,t)))}));var Gs="webgl2",Ws="webgpu",js="null",qs="ldr_srgb",Xs=["view","mesh","mesh_ub"],Ks="default",Ys="_unused_float_uniform",Qs=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Uint16Array],Js=[1,1,2,2,4,4,4,2],$s=[Uint8Array,Uint16Array,Uint32Array],Zs=[1,2,4],er={};er[Ji]=0,er[$i]=1,er[es]=2,er[ts]=3,er[is]=4,er[rs]=5,er[ns]=6,er[as]=7,er[os]=8,er[ls]=9,er[hs]=10,er[cs]=11,er[ds]=12,er[Zi]=13,er.ATTR0=0,er.ATTR1=1,er.ATTR2=2,er.ATTR3=3,er.ATTR4=4,er.ATTR5=5,er.ATTR6=6,er.ATTR7=7,er[us]=8,er[fs]=9,er.ATTR10=10,er.ATTR11=11,er[ps]=12,er[ms]=13,er[gs]=14,er[vs]=15;var tr="1.65",ir=0;class sr{constructor(e,t){this.slot=-1,this.scopeId=null,this.name=e,this.visibility=t}}class rr extends sr{}class nr extends sr{constructor(e,t,i=!1){super(e,t),this.format="",this.readOnly=i}}class ar extends sr{constructor(e,t,i=ws,s=0,r=!0,n=null){super(e,t),this.textureDimension=i,this.sampleType=s,this.hasSampler=r,this.samplerName=null!=n?n:e+"_sampler"}}class or extends sr{constructor(e,t=7,i=ws,s=!0,r=!1){super(e,4),this.format=t,this.textureDimension=i,this.write=s,this.read=r}}class lr{destroy(){this.impl.destroy()}getTexture(e){var t=this.textureFormatsMap.get(e);return void 0!==t?this.textureFormats[t]:null}getStorageTexture(e){var t=this.storageTextureFormatsMap.get(e);return void 0!==t?this.storageTextureFormats[t]:null}loseContext(){}constructor(e,t){this.uniformBufferFormats=[],this.textureFormats=[],this.storageTextureFormats=[],this.storageBufferFormats=[],this.id=ir++;var i=0;t.forEach((e=>{e.slot=i++,e instanceof ar&&e.hasSampler&&i++,e instanceof rr?this.uniformBufferFormats.push(e):e instanceof ar?this.textureFormats.push(e):e instanceof or?this.storageTextureFormats.push(e):e instanceof nr&&this.storageBufferFormats.push(e)})),this.device=e;var s=e.scope;this.bufferFormatsMap=new Map,this.uniformBufferFormats.forEach(((e,t)=>this.bufferFormatsMap.set(e.name,t))),this.textureFormatsMap=new Map,this.textureFormats.forEach(((e,t)=>{this.textureFormatsMap.set(e.name,t),e.scopeId=s.resolve(e.name)})),this.storageTextureFormatsMap=new Map,this.storageTextureFormats.forEach(((e,t)=>{this.storageTextureFormatsMap.set(e.name,t),e.scopeId=s.resolve(e.name)})),this.storageBufferFormatsMap=new Map,this.storageBufferFormats.forEach(((e,t)=>{this.storageBufferFormatsMap.set(e.name,t),e.scopeId=s.resolve(e.name)})),this.impl=e.createBindGroupFormatImpl(this)}}class hr{get(e,t){return this._cache.has(e)||(this._cache.set(e,t()),e.on("destroy",(()=>{this.remove(e)})),e.on("devicelost",(()=>{var t,i;null==(i=this._cache.get(e))||null==(t=i.loseContext)||t.call(i,e)}))),this._cache.get(e)}remove(e){var t,i;null==(i=this._cache.get(e))||null==(t=i.destroy)||t.call(i,e),this._cache.delete(e)}constructor(){this._cache=new Map}}class cr{static calcLevelDimension(e,t){return Math.max(e>>t,1)}static calcMipLevelsCount(e,t,i){return void 0===i&&(i=1),1+Math.floor(Math.log2(Math.max(e,t,i)))}static calcLevelGpuSize(e,t,i,s){var r,n,a,o=ji.get(s),l=null!=(n=null==(r=ji.get(s))?void 0:r.size)?n:0;if(l>0)return e*t*i*l;var h=null!=(a=o.blockSize)?a:0,c=Math.floor((e+3)/4),d=Math.floor((t+3)/4),u=Math.floor((i+3)/4);return s!==Ui&&s!==Vi||(c=Math.max(Math.floor(c/2),1)),c*d*u*h}static calcGpuSize(e,t,i,s,r,n){for(var a=0;a+=cr.calcLevelGpuSize(e,t,i,s),r&&(1!==e||1!==t||1!==i);)e=Math.max(e>>1,1),t=Math.max(t>>1,1),i=Math.max(i>>1,1);return a*(n?6:1)}}var dr=0;class ur{destroy(){var e=this.device;if(e){var t=e.textures.indexOf(this);-1!==t&&e.textures.splice(t,1),e.scope.removeValue(this),this.impl.destroy(e),this.adjustVramSizeTracking(e._vram,-this._gpuSize),this._levels=null,this.device=null}}recreateImpl(e){var t;void 0===e&&(e=!0);var{device:i}=this;null==(t=this.impl)||t.destroy(i),this.impl=null,this.impl=i.createTextureImpl(this),this.dirtyAll(),e&&this.upload()}resize(e,t,i){void 0===i&&(i=1);var s=this.device;this.adjustVramSizeTracking(s._vram,-this._gpuSize),this.impl.destroy(s),this._width=Math.floor(e),this._height=Math.floor(t),this._depth=Math.floor(i),this._updateNumLevel(),this.impl=s.createTextureImpl(this),this.dirtyAll()}loseContext(){this.impl.loseContext(),this.dirtyAll()}adjustVramSizeTracking(e,t){e.tex+=t}propertyChanged(e){this.impl.propertyChanged(e),this.renderVersionDirty=this.device.renderVersion}_updateNumLevel(){var e=this.mipmaps?cr.calcMipLevelsCount(this.width,this.height):1,t=this._numLevelsRequested;this._numLevels=Math.min(null!=t?t:e,e),this._mipmaps=this._numLevels>1}get lockedMode(){return this._lockedMode}set minFilter(e){this._minFilter!==e&&(Ki(this._format)||(this._minFilter=e,this.propertyChanged(1)))}get minFilter(){return this._minFilter}set magFilter(e){this._magFilter!==e&&(Ki(this._format)||(this._magFilter=e,this.propertyChanged(2)))}get magFilter(){return this._magFilter}set addressU(e){this._addressU!==e&&(this._addressU=e,this.propertyChanged(4))}get addressU(){return this._addressU}set addressV(e){this._addressV!==e&&(this._addressV=e,this.propertyChanged(8))}get addressV(){return this._addressV}set addressW(e){this._volume&&e!==this._addressW&&(this._addressW=e,this.propertyChanged(16))}get addressW(){return this._addressW}set compareOnRead(e){this._compareOnRead!==e&&(this._compareOnRead=e,this.propertyChanged(32))}get compareOnRead(){return this._compareOnRead}set compareFunc(e){this._compareFunc!==e&&(this._compareFunc=e,this.propertyChanged(64))}get compareFunc(){return this._compareFunc}set anisotropy(e){this._anisotropy!==e&&(this._anisotropy=e,this.propertyChanged(128))}get anisotropy(){return this._anisotropy}set mipmaps(e){this._mipmaps!==e&&(this.device.isWebGPU||Ki(this._format)||(this._mipmaps=e),e&&(this._needsMipmapsUpload=!0))}get mipmaps(){return this._mipmaps}get numLevels(){return this._numLevels}get storage(){return this._storage}get width(){return this._width}get height(){return this._height}get depth(){return this._depth}get format(){return this._format}get cubemap(){return this._cubemap}get gpuSize(){var e=this.pot&&this._mipmaps&&!(this._compressed&&1===this._levels.length);return cr.calcGpuSize(this._width,this._height,this._depth,this._format,e,this._cubemap)}get array(){return this._arrayLength>0}get arrayLength(){return this._arrayLength}get volume(){return this._volume}set type(e){this._type!==e&&(this._type=e,this.device._shadersDirty=!0)}get type(){return this._type}set srgb(e){if(e!==Xi(this.format))if(e){var t=Yi(this.format);this._format!==t&&(this._format=t,this.recreateImpl(),this.device._shadersDirty=!0)}else{var i=(e=>{for(var[t,i]of ji)if(i.srgbFormat===e)return t;return e})(this.format);this._format!==i&&(this._format=i,this.recreateImpl(),this.device._shadersDirty=!0)}}get srgb(){return Xi(this.format)}set flipY(e){this._flipY!==e&&(this._flipY=e,this._needsUpload=!0)}get flipY(){return this._flipY}set premultiplyAlpha(e){this._premultiplyAlpha!==e&&(this._premultiplyAlpha=e,this._needsUpload=!0)}get premultiplyAlpha(){return this._premultiplyAlpha}get pot(){return ti.powerOfTwo(this._width)&&ti.powerOfTwo(this._height)}get encoding(){switch(this.type){case bs:return"rgbm";case ys:return"rgbe";case xs:return"rgbp"}return e=this.format,(null==(t=ji.get(e))?void 0:t.ldr)&&!(null==t?void 0:t.srgb)?"srgb":"linear";var e,t}dirtyAll(){this._levelsUpdated=this._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0],this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,this._mipmapsUploaded=!1,this.propertyChanged(255)}lock(e){var t,i,s;void 0===e&&(e={}),null!=(t=e).level||(t.level=0),null!=(i=e).face||(i.face=0),null!=(s=e).mode||(s.mode=2),this._lockedMode=e.mode,this._lockedLevel=e.level;var r=this.cubemap?this._levels[e.face]:this._levels;if(null===r[e.level]){var n=Math.max(1,this._width>>e.level),a=Math.max(1,this._height>>e.level),o=Math.max(1,this._depth>>e.level),l=new ArrayBuffer(cr.calcLevelGpuSize(n,a,o,this._format));r[e.level]=new(Qi(this._format))(l)}return r[e.level]}setSource(e,t){void 0===t&&(t=0);var i,s,r=!1;if(this._cubemap){if(e[0]){i=e[0].width||0,s=e[0].height||0;for(var n=0;n<6;n++){var a=e[n];if(!a||a.width!==i||a.height!==s||!this.device._isBrowserInterface(a)){r=!0;break}}}else r=!0;if(!r)for(var o=0;o<6;o++)this._levels[t][o]!==e[o]&&(this._levelsUpdated[t][o]=!0)}else this.device._isBrowserInterface(e)||(r=!0),r||(e!==this._levels[t]&&(this._levelsUpdated[t]=!0),e instanceof HTMLVideoElement?(i=e.videoWidth,s=e.videoHeight):(i=e.width,s=e.height));if(r)if(this._width=4,this._height=4,this._cubemap)for(var l=0;l<6;l++)this._levels[t][l]=null,this._levelsUpdated[t][l]=!0;else this._levels[t]=null,this._levelsUpdated[t]=!0;else 0===t&&(this._width=i,this._height=s),this._levels[t]=e;this._invalid===r&&r||(this._invalid=r,this.upload())}getSource(e){return void 0===e&&(e=0),this._levels[e]}unlock(){2===this._lockedMode&&this.upload(),this._lockedLevel=-1,this._lockedMode=0}upload(){this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,null==this.impl.uploadImmediate||this.impl.uploadImmediate.call(this.impl,this.device,this)}read(e,t,i,s,r){return void 0===r&&(r={}),null==this.impl.read?void 0:this.impl.read.call(this.impl,e,t,i,s,r)}constructor(e,t={}){var i,s,r,n,a,o,l,h,c,d,u,f,p,m,g,v,_,b,y,x;this._gpuSize=0,this.id=dr++,this._invalid=!1,this._lockedLevel=-1,this._lockedMode=0,this.renderVersionDirty=0,this._storage=!1,this._numLevels=0,this.device=e,this.name=null!=(i=t.name)?i:"",this._width=Math.floor(null!=(s=t.width)?s:4),this._height=Math.floor(null!=(r=t.height)?r:4),this._format=null!=(n=t.format)?n:7,this._compressed=qi(this._format),this._integerFormat=Ki(this._format),this._integerFormat&&(t.minFilter=0,t.magFilter=0),this._volume=null!=(a=t.volume)&&a,this._depth=Math.floor(null!=(o=t.depth)?o:1),this._arrayLength=Math.floor(null!=(l=t.arrayLength)?l:0),this._storage=null!=(h=t.storage)&&h,this._cubemap=null!=(c=t.cubemap)&&c,this._flipY=null!=(d=t.flipY)&&d,this._premultiplyAlpha=null!=(u=t.premultiplyAlpha)&&u,this._mipmaps=null==(f=t.mipmaps)||f,this._numLevelsRequested=t.numLevels,void 0!==t.numLevels&&(this._numLevels=t.numLevels),this._updateNumLevel(),this._minFilter=null!=(p=t.minFilter)?p:5,this._magFilter=null!=(m=t.magFilter)?m:1,this._anisotropy=null!=(g=t.anisotropy)?g:1,this._addressU=null!=(v=t.addressU)?v:0,this._addressV=null!=(_=t.addressV)?_:0,this._addressW=null!=(b=t.addressW)?b:0,this._compareOnRead=null!=(y=t.compareOnRead)&&y,this._compareFunc=null!=(x=t.compareFunc)?x:1,this._type=t.hasOwnProperty("type")?t.type:_s,this.projection="none",this._cubemap?this.projection=Ps:t.projection&&t.projection!==Ps&&(this.projection=t.projection),this._levels=t.levels;var S=!!t.levels;this._levels||(this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null]),this.recreateImpl(S),e.textures.push(this)}}var fr={white:[255,255,255,255],gray:[128,128,128,255],black:[0,0,0,255],normal:[128,128,255,255],pink:[255,128,255,255]};class pr{destroy(){this.map.forEach((e=>{e.destroy()}))}constructor(){this.map=new Map}}var mr=new hr,gr=(e,t)=>{var i=mr.get(e,(()=>new pr));if(!i.map.has(t)){var s=new ur(e,{name:"built-in-texture-"+t,width:1,height:1,format:7}),r=s.lock(),n=fr[t];r.set(n),s.unlock(),i.map.set(t,s)}return i.map.get(t)},vr=0;class _r{constructor(){this.offsets=[]}}class br{destroy(){this.impl.destroy(),this.impl=null,this.format=null,this.defaultUniformBuffer=null}setUniformBuffer(e,t){var i=this.format.bufferFormatsMap.get(e);this.uniformBuffers[i]!==t&&(this.uniformBuffers[i]=t,this.dirty=!0)}setStorageBuffer(e,t){var i=this.format.storageBufferFormatsMap.get(e);this.storageBuffers[i]!==t&&(this.storageBuffers[i]=t,this.dirty=!0)}setTexture(e,t){var i=this.format.textureFormatsMap.get(e);this.textures[i]!==t?(this.textures[i]=t,this.dirty=!0):this.renderVersionUpdated<t.renderVersionDirty&&(this.dirty=!0)}setStorageTexture(e,t){var i=this.format.storageTextureFormatsMap.get(e);this.storageTextures[i]!==t?(this.storageTextures[i]=t,this.dirty=!0):this.renderVersionUpdated<t.renderVersionDirty&&(this.dirty=!0)}updateUniformBuffers(){for(var e=0;e<this.uniformBuffers.length;e++)this.uniformBuffers[e].update()}update(){for(var{textureFormats:e,storageTextureFormats:t,storageBufferFormats:i}=this.format,s=0;s<e.length;s++){var r=e[s],n=r.scopeId.value;n||("uSceneDepthMap"===r.name&&(n=gr(this.device,"white")),"uSceneColorMap"===r.name&&(n=gr(this.device,"pink")),n||(n=gr(this.device,"pink"))),this.setTexture(r.name,n)}for(var a=0;a<t.length;a++){var o=t[a],l=o.scopeId.value;this.setStorageTexture(o.name,l)}for(var h=0;h<i.length;h++){var c=i[h],d=c.scopeId.value;this.setStorageBuffer(c.name,d)}this.uniformBufferOffsets.length=this.uniformBuffers.length;for(var u=0;u<this.uniformBuffers.length;u++){var f=this.uniformBuffers[u];this.uniformBufferOffsets[u]=f.offset,this.renderVersionUpdated<f.renderVersionDirty&&(this.dirty=!0)}this.dirty&&(this.dirty=!1,this.renderVersionUpdated=this.device.renderVersion,this.impl.update(this))}constructor(e,t,i){this.renderVersionUpdated=-1,this.uniformBufferOffsets=[],this.id=vr++,this.device=e,this.format=t,this.dirty=!0,this.impl=e.createBindGroupImpl(this),this.textures=[],this.storageTextures=[],this.storageBuffers=[],this.uniformBuffers=[],this.defaultUniformBuffer=i,i&&this.setUniformBuffer(Ks,i)}}var yr={set:(e,t,i,s)=>(void 0===s&&(s=1),e&~(s<<i)|t<<i),get:(e,t,i)=>(void 0===i&&(i=1),e>>t&i),all(e,t,i){void 0===i&&(i=1);var s=i<<t;return(e&s)===s},any:(e,t,i)=>(void 0===i&&(i=1),!!(e&i<<t))},xr=15;class Sr{set blend(e){this.target0=yr.set(this.target0,e?1:0,26)}get blend(){return yr.all(this.target0,26)}setColorBlend(e,t,i){this.target0=yr.set(this.target0,e,0,7),this.target0=yr.set(this.target0,t,3,xr),this.target0=yr.set(this.target0,i,7,xr)}setAlphaBlend(e,t,i){this.target0=yr.set(this.target0,e,11,7),this.target0=yr.set(this.target0,t,14,xr),this.target0=yr.set(this.target0,i,18,xr)}setColorWrite(e,t,i,s){this.redWrite=e,this.greenWrite=t,this.blueWrite=i,this.alphaWrite=s}get colorOp(){return yr.get(this.target0,0,7)}get colorSrcFactor(){return yr.get(this.target0,3,xr)}get colorDstFactor(){return yr.get(this.target0,7,xr)}get alphaOp(){return yr.get(this.target0,11,7)}get alphaSrcFactor(){return yr.get(this.target0,14,xr)}get alphaDstFactor(){return yr.get(this.target0,18,xr)}set redWrite(e){this.target0=yr.set(this.target0,e?1:0,22)}get redWrite(){return yr.all(this.target0,22)}set greenWrite(e){this.target0=yr.set(this.target0,e?1:0,23)}get greenWrite(){return yr.all(this.target0,23)}set blueWrite(e){this.target0=yr.set(this.target0,e?1:0,24)}get blueWrite(){return yr.all(this.target0,24)}set alphaWrite(e){this.target0=yr.set(this.target0,e?1:0,25)}get alphaWrite(){return yr.all(this.target0,25)}get allWrite(){return yr.get(this.target0,22,15)}copy(e){return this.target0=e.target0,this}clone(){return(new this.constructor).copy(this)}get key(){return this.target0}equals(e){return this.target0===e.target0}constructor(e=!1,t=0,i=1,s=0,r,n,a,o=!0,l=!0,h=!0,c=!0){this.target0=0,this.setColorBlend(t,i,s),this.setAlphaBlend(null!=r?r:t,null!=n?n:i,null!=a?a:s),this.setColorWrite(o,l,h,c),this.blend=e}}Sr.NOBLEND=Object.freeze(new Sr),Sr.NOWRITE=Object.freeze(new Sr(void 0,void 0,void 0,void 0,void 0,void 0,void 0,!1,!1,!1,!1)),Sr.ALPHABLEND=Object.freeze(new Sr(!0,0,6,8)),Sr.ADDBLEND=Object.freeze(new Sr(!0,0,1,1));class wr{get(e){var t=this.map.get(e);return void 0===t&&(t=this.id++,this.map.set(e,t)),t}constructor(){this.map=new Map,this.id=0}}var Tr=new wr;class Cr{set test(e){this.func=e?3:7,this.updateKey()}get test(){return 7!==this.func}set write(e){this.data=yr.set(this.data,e?1:0,3),this.updateKey()}get write(){return yr.all(this.data,3)}set func(e){this.data=yr.set(this.data,e,0,7),this.updateKey()}get func(){return yr.get(this.data,0,7)}set depthBias(e){this._depthBias=e,this.updateKey()}get depthBias(){return this._depthBias}set depthBiasSlope(e){this._depthBiasSlope=e,this.updateKey()}get depthBiasSlope(){return this._depthBiasSlope}copy(e){return this.data=e.data,this._depthBias=e._depthBias,this._depthBiasSlope=e._depthBiasSlope,this.key=e.key,this}clone(){return(new this.constructor).copy(this)}updateKey(){var{data:e,_depthBias:t,_depthBiasSlope:i}=this,s=e+"-"+t+"-"+i;this.key=Tr.get(s)}equals(e){return this.key===e.key}constructor(e=3,t=!0){this.data=0,this._depthBias=0,this._depthBiasSlope=0,this.key=0,this.func=e,this.write=t}}Cr.DEFAULT=Object.freeze(new Cr),Cr.NODEPTH=Object.freeze(new Cr(7,!1)),Cr.WRITEDEPTH=Object.freeze(new Cr(7,!0));class Er{equals(e){return this.globalId===e.globalId&&this.revision===e.revision}copy(e){this.globalId=e.globalId,this.revision=e.revision}reset(){this.globalId=0,this.revision=0}constructor(){this.globalId=0,this.revision=0}}var Ar=0;class Pr{increment(){this.version.revision++}constructor(){Ar++,this.version=new Er,this.version.globalId=Ar}}class Dr{toJSON(e){}setValue(e){this.value=e,this.versionObject.increment()}getValue(){return this.value}constructor(e){this.name=e,this.value=null,this.versionObject=new Pr}}class Lr{resolve(e){return this.variables.has(e)||this.variables.set(e,new Dr(e)),this.variables.get(e)}removeValue(e){for(var t in this.variables){var i=this.variables[t];i.value===e&&(i.value=null)}}constructor(e){this.name=e,this.variables=new Map}}var Mr=0;class Ir{destroy(){var e=this.device,t=e.buffers.indexOf(this);-1!==t&&e.buffers.splice(t,1),this.impl.initialized&&(this.impl.destroy(e),this.adjustVramSizeTracking(e._vram,-this.storage.byteLength))}adjustVramSizeTracking(e,t){e.vb+=t}loseContext(){this.impl.loseContext()}getFormat(){return this.format}getUsage(){return this.usage}getNumVertices(){return this.numVertices}lock(){return this.storage}unlock(){this.impl.unlock(this)}setData(e){return e.byteLength===this.numBytes&&(this.storage=e,this.unlock(),!0)}constructor(e,t,i,s){var r;this.usage=0,this.usage=null!=(r=null==s?void 0:s.usage)?r:0,this.device=e,this.format=t,this.numVertices=i,this.id=Mr++,this.impl=e.createVertexBufferImpl(this,t,s),this.numBytes=t.verticesByteSize?t.verticesByteSize:t.size*i,this.adjustVramSizeTracking(e._vram,this.numBytes);var n=null==s?void 0:s.data;n?this.setData(n):this.storage=new ArrayBuffer(this.numBytes),this.device.buffers.push(this)}}function Rr(e){if(null==e)return 0;for(var t=0,i=0,s=e.length;i<s;i++)t=(t<<5)-t+e.charCodeAt(i),t|=0;return t}function kr(e){for(var t=2166136261,i=0;i<e.length;i++)t^=e[i],t*=16777619;return t>>>0}var Or=new wr,Fr=[2,4,8,12,16],Br=new hr;class Nr{get elements(){return this._elements}static getDefaultInstancingFormat(e){return Br.get(e,(()=>new Nr(e,[{semantic:ps,components:4,type:6},{semantic:ms,components:4,type:6},{semantic:gs,components:4,type:6},{semantic:vs,components:4,type:6}])))}static isElementValid(e,t){var i=t.components*Js[t.type];return!(e.isWebGPU&&!Fr.includes(i))}update(){this._evaluateHash()}_evaluateHash(){for(var e=[],t=[],i=this._elements.length,s=0;s<i;s++){var{name:r,dataType:n,numComponents:a,normalize:o,offset:l,stride:h,size:c,asInt:d}=this._elements[s],u=r+n+a+o+d;e.push(u);var f=u+l+h+c;t.push(f)}e.sort();var p=e.join();this.batchingHash=Rr(p),this.shaderProcessingHashString=p,this.renderingHashString=t.join("_"),this.renderingHash=Or.get(this.renderingHashString)}constructor(e,t,i){this.device=e,this._elements=[],this.hasUv0=!1,this.hasUv1=!1,this.hasColor=!1,this.hasTangents=!1,this.verticesByteSize=0,this.vertexCount=i,this.interleaved=void 0===i,this.instancing=!1,this.size=t.reduce(((e,t)=>e+4*Math.ceil(t.components*Js[t.type]/4)),0);for(var s,r=0,n=0,a=t.length;n<a;n++){var o,l=t[n];s=l.components*Js[l.type],i&&(r=ti.roundUp(r,s));var h,c=null!=(o=l.asInt)&&o,d=!c&&(null!=(h=l.normalize)&&h),u={name:l.semantic,offset:i?r:l.hasOwnProperty("offset")?l.offset:r,stride:i?s:l.hasOwnProperty("stride")?l.stride:this.size,dataType:l.type,numComponents:l.components,normalize:d,size:s,asInt:c};this._elements.push(u),r+=i?s*i:4*Math.ceil(s/4),l.semantic===rs?this.hasUv0=!0:l.semantic===ns?this.hasUv1=!0:l.semantic===is?this.hasColor=!0:l.semantic===Zi&&(this.hasTangents=!0)}i&&(this.verticesByteSize=r),this._evaluateHash()}}var zr=new wr;class Ur{set func(e){this._func=e,this._dirty=!0}get func(){return this._func}set ref(e){this._ref=e,this._dirty=!0}get ref(){return this._ref}set fail(e){this._fail=e,this._dirty=!0}get fail(){return this._fail}set zfail(e){this._zfail=e,this._dirty=!0}get zfail(){return this._zfail}set zpass(e){this._zpass=e,this._dirty=!0}get zpass(){return this._zpass}set readMask(e){this._readMask=e,this._dirty=!0}get readMask(){return this._readMask}set writeMask(e){this._writeMask=e,this._dirty=!0}get writeMask(){return this._writeMask}_evalKey(){var{_func:e,_ref:t,_fail:i,_zfail:s,_zpass:r,_readMask:n,_writeMask:a}=this,o=e+","+t+","+i+","+s+","+r+","+n+","+a;this._key=zr.get(o),this._dirty=!1}get key(){return this._dirty&&this._evalKey(),this._key}copy(e){return this._func=e._func,this._ref=e._ref,this._readMask=e._readMask,this._writeMask=e._writeMask,this._fail=e._fail,this._zfail=e._zfail,this._zpass=e._zpass,this._dirty=e._dirty,this._key=e._key,this}clone(){return(new this.constructor).copy(this)}constructor(e={}){var t,i,s,r,n,a,o;this._dirty=!0,this._func=null!=(t=e.func)?t:7,this._ref=null!=(i=e.ref)?i:0,this._readMask=null!=(s=e.readMask)?s:255,this._writeMask=null!=(r=e.writeMask)?r:255,this._fail=null!=(n=e.fail)?n:0,this._zfail=null!=(a=e.zfail)?a:0,this._zpass=null!=(o=e.zpass)?o:0,this._evalKey()}}function Vr(){return Vr=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var s in i)Object.prototype.hasOwnProperty.call(i,s)&&(e[s]=i[s])}return e},Vr.apply(this,arguments)}Ur.DEFAULT=Object.freeze(new Ur);class Hr extends Ht{postInit(){var e=new Nr(this,[{semantic:Ji,components:2,type:6}]),t=new Float32Array([-1,-1,1,-1,-1,1,1,1]);this.quadVertexBuffer=new Ir(this,e,4,{data:t})}initCapsDefines(){var{capsDefines:e}=this;e.clear(),this.textureFloatFilterable&&e.set("CAPS_TEXTURE_FLOAT_FILTERABLE",""),this.textureFloatRenderable&&e.set("CAPS_TEXTURE_FLOAT_RENDERABLE","")}destroy(){var e,t,i;this.fire("destroy"),null==(e=this.quadVertexBuffer)||e.destroy(),this.quadVertexBuffer=null,null==(t=this.dynamicBuffers)||t.destroy(),this.dynamicBuffers=null,null==(i=this.gpuProfiler)||i.destroy(),this.gpuProfiler=null}onDestroyShader(e){this.fire("destroy:shader",e);var t=this.shaders.indexOf(e);-1!==t&&this.shaders.splice(t,1)}postDestroy(){this.scope=null,this.canvas=null}loseContext(){var e;for(var t of(this.contextLost=!0,this.backBufferSize.set(-1,-1),this.textures))t.loseContext();for(var i of this.buffers)i.loseContext();for(var s of this.targets)s.loseContext();null==(e=this.gpuProfiler)||e.loseContext()}restoreContext(){var e,t;for(var i of(this.contextLost=!1,this.initializeRenderState(),this.initializeContextCaches(),this.buffers))i.unlock();null==(t=this.gpuProfiler)||null==(e=t.restoreContext)||e.call(t)}toJSON(e){}initializeContextCaches(){this.indexBuffer=null,this.vertexBuffers=[],this.shader=null,this.shaderValid=void 0,this.shaderAsyncCompile=!1,this.renderTarget=null}initializeRenderState(){this.blendState=new Sr,this.depthState=new Cr,this.cullMode=1,this.vx=this.vy=this.vw=this.vh=0,this.sx=this.sy=this.sw=this.sh=0,this.blendColor=new ii(0,0,0,0)}setStencilState(e,t){}setBlendState(e){}setBlendColor(e,t,i,s){}setDepthState(e){}setCullMode(e){}setRenderTarget(e){this.renderTarget=e}setIndexBuffer(e){this.indexBuffer=e}setVertexBuffer(e){e&&this.vertexBuffers.push(e)}clearVertexBuffer(){this.vertexBuffers.length=0}clearIndexBuffer(){this.indexBuffer=null}getRenderTarget(){return this.renderTarget}initRenderTarget(e){e.initialized||(e.init(),this.targets.add(e))}_isBrowserInterface(e){return this._isImageBrowserInterface(e)||this._isImageCanvasInterface(e)||this._isImageVideoInterface(e)}_isImageBrowserInterface(e){return"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement}_isImageCanvasInterface(e){return"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement}_isImageVideoInterface(e){return"undefined"!=typeof HTMLVideoElement&&e instanceof HTMLVideoElement}resizeCanvas(e,t){var i=Math.min(this._maxPixelRatio,Ut.browser?window.devicePixelRatio:1),s=Math.floor(e*i),r=Math.floor(t*i);s===this.canvas.width&&r===this.canvas.height||this.setResolution(s,r)}setResolution(e,t){this.canvas.width=e,this.canvas.height=t,this.fire(Hr.EVENT_RESIZE,e,t)}updateClientRect(){if(Ut.worker)this.clientRect.width=this.canvas.width,this.clientRect.height=this.canvas.height;else{var e=this.canvas.getBoundingClientRect();this.clientRect.width=e.width,this.clientRect.height=e.height}}get width(){return this.canvas.width}get height(){return this.canvas.height}set fullscreen(e){}get fullscreen(){return!1}set maxPixelRatio(e){this._maxPixelRatio=e}get maxPixelRatio(){return this._maxPixelRatio}get deviceType(){return this._deviceType}startRenderPass(e){}endRenderPass(e){}startComputePass(e){}endComputePass(){}frameStart(){this.renderPassIndex=0,this.renderVersion++}frameEnd(){}computeDispatch(e,t){}getRenderableHdrFormat(e,t,i){void 0===e&&(e=[Ni,Ri,ki]),void 0===t&&(t=!0),void 0===i&&(i=1);for(var s=0;s<e.length;s++){var r=e[s];switch(r){case Ni:if(this.textureRG11B10Renderable)return r;break;case Ri:if(this.textureHalfFloatRenderable)return r;break;case ki:if(this.isWebGPU&&i>1)continue;if(this.textureFloatRenderable&&(!t||this.textureFloatFilterable))return r}}}validateAttributes(e,t,i){}constructor(e,t){var i,s,r,n,a,o;super(),this.backBuffer=null,this.backBufferSize=new di,this.backBufferAntialias=!1,this.isWebGPU=!1,this.isWebGL2=!1,this.isHdr=!1,this.maxColorAttachments=1,this.maxSamples=1,this.supportsCompute=!1,this.supportsStorageTextureRead=!1,this.renderTarget=null,this.shaders=[],this.textures=[],this.targets=new Set,this.renderVersion=0,this.insideRenderPass=!1,this.supportsUniformBuffers=!1,this.supportsClipDistances=!1,this.textureRG11B10Renderable=!1,this.textureFloatFilterable=!1,this.blendState=new Sr,this.depthState=new Cr,this.stencilEnabled=!1,this.stencilFront=new Ur,this.stencilBack=new Ur,this.defaultClearOptions={color:[0,0,0,1],depth:1,stencil:0,flags:3},this.clientRect={width:0,height:0},this._shadersDirty=!1,this.capsDefines=new Map,this.canvas=e,"setAttribute"in e&&e.setAttribute("data-engine","PlayCanvas "+Lt),this.initOptions=Vr({},t),null!=(i=this.initOptions).alpha||(i.alpha=!0),null!=(s=this.initOptions).depth||(s.depth=!0),null!=(r=this.initOptions).stencil||(r.stencil=!0),null!=(n=this.initOptions).antialias||(n.antialias=!0),null!=(a=this.initOptions).powerPreference||(a.powerPreference="high-performance"),null!=(o=this.initOptions).displayFormat||(o.displayFormat="ldr"),this._maxPixelRatio=Ut.browser?Math.min(1,window.devicePixelRatio):1,this.buffers=[],this._vram={tex:0,vb:0,ib:0,ub:0,sb:0},this._shaderStats={vsCompiled:0,fsCompiled:0,linked:0,materialShaders:0,compileTime:0},this.initializeContextCaches(),this._drawCallsPerFrame=0,this._shaderSwitchesPerFrame=0,this._primsPerFrame=[];for(var l=0;l<=6;l++)this._primsPerFrame[l]=0;this._renderTargetCreationTime=0,this.scope=new Lr("Device"),this.textureBias=this.scope.resolve("textureBias"),this.textureBias.setValue(0)}}Hr.EVENT_RESIZE="resizecanvas";var Gr=0;class Wr{destroy(){var e=this._device;e&&(e.targets.delete(this),e.renderTarget===this&&e.setRenderTarget(null),this.destroyFrameBuffers())}destroyFrameBuffers(){var e=this._device;e&&this.impl.destroy(e)}destroyTextureBuffers(){var e,t;null==(e=this._depthBuffer)||e.destroy(),this._depthBuffer=null,null==(t=this._colorBuffers)||t.forEach((e=>{e.destroy()})),this._colorBuffers=null,this._colorBuffer=null}resize(e,t){if(this.width!==e||this.height!==t){var i,s;if(this.mipLevel>0)return;var r=this._device;this.destroyFrameBuffers(),r.renderTarget===this&&r.setRenderTarget(null),null==(i=this._depthBuffer)||i.resize(e,t),null==(s=this._colorBuffers)||s.forEach((i=>{i.resize(e,t)})),this.validateMrt(),this.impl=r.createRenderTargetImpl(this)}}validateMrt(){}init(){this.impl.init(this._device,this)}get initialized(){return this.impl.initialized}get device(){return this._device}loseContext(){this.impl.loseContext()}resolve(e,t){void 0===e&&(e=!0),void 0===t&&(t=!!this._depthBuffer),this._device&&this._samples>1&&this.impl.resolve(this._device,this,e,t)}copy(e,t,i){if(!this._device){if(!e._device)return!1;this._device=e._device}return this._device.copyRenderTarget(e,this,t,i)}get samples(){return this._samples}get depth(){return this._depth}get stencil(){return this._stencil}get colorBuffer(){return this._colorBuffer}getColorBuffer(e){var t;return null==(t=this._colorBuffers)?void 0:t[e]}get depthBuffer(){return this._depthBuffer}get face(){return this._face}get mipLevel(){return this._mipLevel}get mipmaps(){return this._mipmaps}get width(){var e,t,i=(null==(e=this._colorBuffer)?void 0:e.width)||(null==(t=this._depthBuffer)?void 0:t.width)||this._device.width;return this._mipLevel>0&&(i=cr.calcLevelDimension(i,this._mipLevel)),i}get height(){var e,t,i=(null==(e=this._colorBuffer)?void 0:e.height)||(null==(t=this._depthBuffer)?void 0:t.height)||this._device.height;return this._mipLevel>0&&(i=cr.calcLevelDimension(i,this._mipLevel)),i}isColorBufferSrgb(e){if(void 0===e&&(e=0),this.device.backBuffer===this)return Xi(this.device.backBufferFormat);var t=this.getColorBuffer(e);return!!t&&Xi(t.format)}constructor(e={}){var t,i,s,r,n,a;this.id=Gr++;var o=null!=(a=null!=(n=null!=(r=null==(t=e.colorBuffer)?void 0:t.device)?r:null==(i=e.colorBuffers)?void 0:i[0].device)?n:null==(s=e.depthBuffer)?void 0:s.device)?a:e.graphicsDevice;this._device=o;var l,h,c,d,u,f,p,{maxSamples:m}=this._device;if(this._samples=Math.min(null!=(l=e.samples)?l:1,m),o.isWebGPU&&(this._samples=this._samples>1?m:1),this._colorBuffer=e.colorBuffer,e.colorBuffer&&(this._colorBuffers=[e.colorBuffer]),this._depthBuffer=e.depthBuffer,this._face=null!=(h=e.face)?h:0,this._depthBuffer){var g=this._depthBuffer._format;g===Fi||g===Wi?(this._depth=!0,this._stencil=!1):g===Bi?(this._depth=!0,this._stencil=!0):g===Oi&&this._depthBuffer.device.isWebGPU&&this._samples>1?(this._depth=!0,this._stencil=!1):(this._depth=!1,this._stencil=!1)}else{var v,_;this._depth=null==(v=e.depth)||v,this._stencil=null!=(_=e.stencil)&&_}(e.colorBuffers&&(this._colorBuffers||(this._colorBuffers=[...e.colorBuffers],this._colorBuffer=e.colorBuffers[0])),this.autoResolve=null==(c=e.autoResolve)||c,this.name=e.name,this.name)||(this.name=null==(d=this._colorBuffer)?void 0:d.name);this.name||(this.name=null==(u=this._depthBuffer)?void 0:u.name);this.name||(this.name="Untitled"),this.flipY=null!=(f=e.flipY)&&f,this._mipLevel=null!=(p=e.mipLevel)?p:0,this._mipLevel>0&&this._depth&&(this._mipLevel=0),this._mipmaps=void 0===e.mipLevel,this.validateMrt(),this.impl=o.createRenderTargetImpl(this)}}class jr{update(e){this.destroy();var t=e.device,i=this.createDescriptor(t,e);this.bindGroup=t.wgpu.createBindGroup(i)}destroy(){this.bindGroup=null}createDescriptor(e,t){var i=[],s=t.format,r=t.format.uniformBufferFormats;t.uniformBuffers.forEach(((e,t)=>{var s=r[t].slot,n=e.persistent?e.impl.buffer:e.allocation.gpuBuffer.buffer;i.push({binding:s,resource:{buffer:n,offset:0,size:e.format.byteSize}})}));var n=t.format.textureFormats;t.textures.forEach(((t,r)=>{var a=t.impl,o=s.textureFormats[r],l=n[r].slot,h=a.getView(e);if(i.push({binding:l,resource:h}),o.hasSampler){var c=a.getSampler(e,o.sampleType);i.push({binding:l+1,resource:c})}}));var a=t.format.storageTextureFormats;t.storageTextures.forEach(((t,s)=>{var r=t.impl,n=a[s].slot,o=r.getView(e);i.push({binding:n,resource:o})}));var o=t.format.storageBufferFormats;return t.storageBuffers.forEach(((e,t)=>{var s=e.impl.buffer,r=o[t].slot;i.push({binding:r,resource:{buffer:s}})})),{layout:t.format.impl.bindGroupLayout,entries:i}}}class qr{static shaderStage(e){var t=0;return 1&e&&(t|=GPUShaderStage.VERTEX),2&e&&(t|=GPUShaderStage.FRAGMENT),4&e&&(t|=GPUShaderStage.COMPUTE),t}}var Xr=[];Xr[0]="",Xr[1]="",Xr[2]="",Xr[52]="r8unorm",Xr[53]="rg8unorm",Xr[3]="",Xr[4]="",Xr[5]="",Xr[6]="rgba8unorm",Xr[7]="rgba8unorm",Xr[8]="bc1-rgba-unorm",Xr[9]="bc2-rgba-unorm",Xr[10]="bc3-rgba-unorm",Xr[11]="",Xr[12]="rgba16float",Xr[50]="r16float",Xr[51]="rg16float",Xr[13]="",Xr[14]="rgba32float",Xr[15]="r32float",Xr[16]="depth32float",Xr[69]="depth16unorm",Xr[17]="depth24plus-stencil8",Xr[18]="rg11b10ufloat",Xr[19]="",Xr[20]="rgba8unorm-srgb",Xr[21]="",Xr[22]="etc2-rgb8unorm",Xr[23]="etc2-rgba8unorm",Xr[24]="",Xr[25]="",Xr[26]="",Xr[27]="",Xr[28]="astc-4x4-unorm",Xr[29]="",Xr[30]="",Xr[31]="bgra8unorm",Xr[64]="bgra8unorm-srgb",Xr[32]="r8sint",Xr[33]="r8uint",Xr[34]="r16sint",Xr[35]="r16uint",Xr[36]="r32sint",Xr[37]="r32uint",Xr[38]="rg8sint",Xr[39]="rg8uint",Xr[40]="rg16sint",Xr[41]="rg16uint",Xr[42]="rg32sint",Xr[43]="rg32uint",Xr[44]="rgba8sint",Xr[45]="rgba8uint",Xr[46]="rgba16sint",Xr[47]="rgba16uint",Xr[48]="rgba32sint",Xr[49]="rgba32uint",Xr[65]="bc6h-rgb-float",Xr[66]="bc6h-rgb-ufloat",Xr[67]="bc7-rgba-unorm",Xr[54]="bc1-rgba-unorm-srgb",Xr[55]="bc2-rgba-unorm-srgb",Xr[56]="bc3-rgba-unorm-srgb",Xr[61]="etc2-rgb8unorm-srgb",Xr[62]="etc2-rgba8unorm-srgb",Xr[68]="bc7-rgba-unorm-srgb",Xr[63]="astc-4x4-unorm-srgb";var Kr=[];Kr[0]="filtering",Kr[1]="non-filtering",Kr[2]="comparison",Kr[3]="comparison",Kr[4]="comparison";var Yr=[];Yr[0]="float",Yr[1]="unfilterable-float",Yr[2]="depth",Yr[3]="sint",Yr[4]="uint";var Qr=new wr;class Jr{destroy(){this.bindGroupLayout=null}loseContext(){}createDescriptor(e){var t=[],i="";return e.uniformBufferFormats.forEach((e=>{var s=qr.shaderStage(e.visibility);i+="#"+e.slot+"U:"+s,t.push({binding:e.slot,visibility:s,buffer:{type:"uniform",hasDynamicOffset:!0}})})),e.textureFormats.forEach((e=>{var s=qr.shaderStage(e.visibility),r=e.sampleType,n=e.textureDimension,a=!1,o=Yr[r];if(i+="#"+e.slot+"T:"+s+"-"+o+"-"+n+"-"+a,t.push({binding:e.slot,visibility:s,texture:{sampleType:o,viewDimension:n,multisampled:a}}),e.hasSampler){var l=Kr[r];i+="#"+(e.slot+1)+"S:"+s+"-"+l,t.push({binding:e.slot+1,visibility:s,sampler:{type:l}})}})),e.storageTextureFormats.forEach((e=>{var{format:s,textureDimension:r}=e,{read:n,write:a}=e;i+="#"+e.slot+"ST:"+s+"-"+r+"-"+(n?"r1":"r0")+"-"+(a?"w1":"w0"),t.push({binding:e.slot,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:n?a?"read-write":"read-only":"write-only",format:Xr[s],viewDimension:r}})})),e.storageBufferFormats.forEach((e=>{var s=e.readOnly,r=qr.shaderStage(e.visibility);i+="#"+e.slot+"SB:"+r+"-"+(s?"ro":"rw"),t.push({binding:e.slot,visibility:r,buffer:{type:s?"read-only-storage":"storage"}})})),{key:i,desc:{entries:t}}}constructor(e){var t=e.device,{key:i,desc:s}=this.createDescriptor(e);this.key=Qr.get(i),this.bindGroupLayout=t.wgpu.createBindGroupLayout(s)}}class $r{destroy(e){this.buffer&&(this.buffer.destroy(),this.buffer=null)}get initialized(){return!!this.buffer}loseContext(){}allocate(e,t){this.buffer=e.wgpu.createBuffer({size:t,usage:this.usageFlags})}unlock(e,t){var i,s=e.wgpu;if(!this.buffer){var r=t.byteLength+3&-4;this.usageFlags|=GPUBufferUsage.COPY_DST,this.allocate(e,r)}var n,a=null!=(i=t.byteOffset)?i:0,o=new Uint8Array(null!=(n=t.buffer)?n:t,a,t.byteLength),l=new Uint8Array(this.buffer.size);l.set(o),s.queue.writeBuffer(this.buffer,0,l,0,l.length)}read(e,t,i,s){return e.readStorageBuffer(this,t,i,s)}write(e,t,i,s,r){e.writeStorageBuffer(this,t,i,s,r)}clear(e,t,i){e.clearStorageBuffer(this,t,i)}constructor(e=0){this.buffer=null,this.usageFlags=0,this.usageFlags=e}}class Zr extends $r{unlock(e){var t=e.device;super.unlock(t,e.storage)}constructor(e,t){super(16|((null==t?void 0:t.storage)?128:0)),this.format=null,this.format=1===e.format?"uint16":"uint32"}}var en={equals(e,t){if(e.length!==t.length)return!1;for(var i=0;i<e.length;i++)if(e[i]!==t[i])return!1;return!0}},tn=[];tn[0]="sint8",tn[1]="uint8",tn[2]="sint16",tn[3]="uint16",tn[4]="sint32",tn[5]="uint32",tn[6]="float32",tn[7]="float16";var sn=[];sn[0]="snorm8",sn[1]="unorm8",sn[2]="snorm16",sn[3]="unorm16",sn[4]="sint32",sn[5]="uint32",sn[6]="float32",sn[7]="float16";class rn{get(e,t){void 0===t&&(t=null);var i=this.getKey(e,t),s=this.cache.get(i);return s||(s=this.create(e,t),this.cache.set(i,s)),s}getKey(e,t){return void 0===t&&(t=null),(null==e?void 0:e.renderingHashString)+"-"+(null==t?void 0:t.renderingHashString)}create(e,t){var i=[],s=e=>{for(var t=e.interleaved,s=e.instancing?"instance":"vertex",r=[],n=e.elements.length,a=0;a<n;a++){var o=e.elements[a],l=er[o.name],h=o.normalize?sn:tn;r.push({shaderLocation:l,offset:t?o.offset:0,format:h[o.dataType]+(o.numComponents>1?"x"+o.numComponents:"")}),t&&a!==n-1||(i.push({attributes:r,arrayStride:o.stride,stepMode:s}),r=[])}};return e&&s(e),t&&s(t),i}constructor(){this.cache=new Map}}class nn{getPipelineLayout(e){var t=[];e.forEach((e=>{t.push(e.bindGroupLayout)}));var i={bindGroupLayouts:t};return this.device.wgpu.createPipelineLayout(i)}constructor(e){this.device=e}}var an=["point-list","line-list",void 0,"line-strip","triangle-list","triangle-strip",void 0],on=["add","subtract","reverse-subtract","min","max"],ln=["zero","one","src","one-minus-src","dst","one-minus-dst","src-alpha","src-alpha-saturated","one-minus-src-alpha","dst-alpha","one-minus-dst-alpha","constant","one-minus-constant"],hn=["never","less","equal","less-equal","greater","not-equal","greater-equal","always"],cn=["none","back","front"],dn=["keep","zero","replace","increment-clamp","increment-wrap","decrement-clamp","decrement-wrap","invert"],un=["","uint16","uint32"];class fn{}class pn extends nn{get(e,t,i,s,r,n,a,o,l,h,c,d,u){var f,p,m,g=e.type;s&&3!==g&&5!==g&&(s=void 0);var v,_,b,y,x,S=this.lookupHashes;S[0]=g,S[1]=r.id,S[2]=h,S[3]=l.key,S[4]=o.key,S[5]=null!=(v=null==t?void 0:t.renderingHash)?v:0,S[6]=null!=(_=null==i?void 0:i.renderingHash)?_:0,S[7]=n.impl.key,S[8]=null!=(b=null==(f=a[0])?void 0:f.key)?b:0,S[9]=null!=(y=null==(p=a[1])?void 0:p.key)?y:0,S[10]=null!=(x=null==(m=a[2])?void 0:m.key)?x:0,S[11]=c?d.key:0,S[12]=c?u.key:0,S[13]=null!=s?s:0;var w=kr(S),T=this.cache.get(w);if(T)for(var C=0;C<T.length;C++){var E=T[C];if(en.equals(E.hashes,S))return E.pipeline}var A=an[g],P=this.getPipelineLayout(a),D=this.vertexBufferLayout.get(t,i),L=new fn;return L.hashes=new Uint32Array(S),L.pipeline=this.create(A,s,r,n,P,o,l,D,h,c,d,u),T?T.push(L):T=[L],this.cache.set(w,T),L.pipeline}getBlend(e){var t;return e.blend&&(t={color:{operation:on[e.colorOp],srcFactor:ln[e.colorSrcFactor],dstFactor:ln[e.colorDstFactor]},alpha:{operation:on[e.alphaOp],srcFactor:ln[e.alphaSrcFactor],dstFactor:ln[e.alphaDstFactor]}}),t}getDepthStencil(e,t,i,s,r){var n,{depth:a,stencil:o}=t;return(a||o)&&(n={format:t.impl.depthAttachment.format},a?(n.depthWriteEnabled=e.write,n.depthCompare=hn[e.func],n.depthBias=e.depthBias,n.depthBiasSlopeScale=e.depthBiasSlope):(n.depthWriteEnabled=!1,n.depthCompare="always"),o&&i&&(n.stencilReadMas=s.readMask,n.stencilWriteMask=s.writeMask,n.stencilFront={compare:hn[s.func],failOp:dn[s.fail],passOp:dn[s.zpass],depthFailOp:dn[s.zfail]},n.stencilBack={compare:hn[r.func],failOp:dn[r.fail],passOp:dn[r.zpass],depthFailOp:dn[r.zfail]})),n}create(e,t,i,s,r,n,a,o,l,h,c,d){var u=this.device.wgpu,f=i.impl,p={vertex:{module:f.getVertexShaderModule(),entryPoint:f.vertexEntryPoint,buffers:o},primitive:{topology:e,frontFace:"ccw",cullMode:cn[l]},depthStencil:this.getDepthStencil(a,s,h,c,d),multisample:{count:s.samples},layout:r};t&&(p.primitive.stripIndexFormat=un[t]),p.fragment={module:f.getFragmentShaderModule(),entryPoint:f.fragmentEntryPoint,targets:[]};var m=s.impl.colorAttachments;if(m.length>0){var g=0;n.redWrite&&(g|=GPUColorWrite.RED),n.greenWrite&&(g|=GPUColorWrite.GREEN),n.blueWrite&&(g|=GPUColorWrite.BLUE),n.alphaWrite&&(g|=GPUColorWrite.ALPHA);var v=this.getBlend(n);m.forEach((e=>{p.fragment.targets.push({format:e.format,writeMask:g,blend:v})}))}return u.createRenderPipeline(p)}constructor(e){super(e),this.lookupHashes=new Uint32Array(14),this.vertexBufferLayout=new rn,this.cache=new Map}}class mn extends nn{get(e,t){var i=this.getPipelineLayout([t.impl]);return this.create(e,i)}create(e,t){var i=this.device.wgpu,s=e.impl,r={compute:{module:s.getComputeShaderModule(),entryPoint:s.computeEntryPoint},layout:t};return i.createComputePipeline(r)}}class gn{incRefCount(){this._refCount++}decRefCount(){this._refCount--}get refCount(){return this._refCount}constructor(){this._refCount=0}}class vn extends gn{constructor(e){super(),this.object=e,this.incRefCount()}}class _n{destroy(){this.cache.forEach((e=>{var t;null==(t=e.object)||t.destroy()})),this.cache.clear()}clear(){this.cache.clear()}get(e){var t=this.cache.get(e);return t?(t.incRefCount(),t.object):null}set(e,t){this.cache.set(e,new vn(t))}release(e){var t,i=this.cache.get(e);i&&(i.decRefCount(),0===i.refCount&&(this.cache.delete(e),null==(t=i.object)||t.destroy()))}constructor(){this.cache=new Map}}class bn extends _n{loseContext(e){this.clear()}}var yn=new hr,xn=e=>yn.get(e,(()=>new bn)),Sn=new wr;class wn{destroy(){var e;null==(e=this.multisampledBuffer)||e.destroy(),this.multisampledBuffer=null}}class Tn{destroy(e){var t;this.depthTextureInternal&&(null==(t=this.depthTexture)||t.destroy(),this.depthTexture=null);this.multisampledDepthBuffer&&(this.multisampledDepthBuffer=null,xn(e).release(this.multisampledDepthBufferKey))}constructor(e){this.depthTexture=null,this.depthTextureInternal=!1,this.multisampledDepthBuffer=null,this.format=e,this.hasStencil="depth24plus-stencil8"===e}}class Cn{destroy(e){var t;this.initialized=!1,this.assignedColorTexture=null,this.colorAttachments.forEach((e=>{e.destroy()})),this.colorAttachments.length=0,null==(t=this.depthAttachment)||t.destroy(e),this.depthAttachment=null}updateKey(){var e=this.renderTarget.samples+":"+(this.depthAttachment?this.depthAttachment.format:"nodepth");this.colorAttachments.forEach((t=>{e+=":"+t.format})),this.key=Sn.get(e)}assignColorTexture(e,t){this.assignedColorTexture=t;var i=t.createView({format:e.backBufferViewFormat}),s=this.renderPassDescriptor.colorAttachments[0];this.renderTarget.samples>1?s.resolveTarget=i:s.view=i,this.setColorAttachment(0,void 0,e.backBufferViewFormat),this.updateKey()}setColorAttachment(e,t,i){this.colorAttachments[e]||(this.colorAttachments[e]=new wn),t&&(this.colorAttachments[e].multisampledBuffer=t),i&&(this.colorAttachments[e].format=i)}init(e,t){var i,s,r=e.wgpu;this.initDepthStencil(e,r,t),t._colorBuffers&&t._colorBuffers.forEach(((e,t)=>{this.setColorAttachment(t,void 0,e.impl.format)})),this.renderPassDescriptor.colorAttachments=[];for(var n=this.isBackbuffer?1:null!=(s=null==(i=t._colorBuffers)?void 0:i.length)?s:0,a=0;a<n;++a){var o,l=this.initColor(e,r,t,a),h=0===a&&(null==(o=this.colorAttachments[0])?void 0:o.format);(l.view||h)&&this.renderPassDescriptor.colorAttachments.push(l)}this.updateKey(),this.initialized=!0}initDepthStencil(e,t,i){var{samples:s,width:r,height:n,depth:a,depthBuffer:o}=i;if(a||o){var l;if(o)if(this.depthAttachment=new Tn(o.impl.format),s>1){var h="depth24plus-stencil8";this.depthAttachment.format=h,this.depthAttachment.hasStencil=!0;var c=o.id+":"+r+":"+n+":"+s+":"+h,d=xn(e),u=d.get(c);if(!u){var f={size:[r,n,1],dimension:"2d",sampleCount:s,format:h,usage:GPUTextureUsage.RENDER_ATTACHMENT|(h!==o.impl.format?GPUTextureUsage.TEXTURE_BINDING:0)};u=t.createTexture(f),d.set(c,u)}this.depthAttachment.multisampledDepthBuffer=u,this.depthAttachment.multisampledDepthBufferKey=c,l=u.createView()}else{var p=o.impl.gpuTexture;this.depthAttachment.depthTexture=p,l=p.createView()}else{this.depthAttachment=new Tn("depth24plus-stencil8");var m={size:[r,n,1],dimension:"2d",sampleCount:s,format:this.depthAttachment.format,usage:GPUTextureUsage.RENDER_ATTACHMENT};m.usage|=s>1?GPUTextureUsage.TEXTURE_BINDING:GPUTextureUsage.COPY_SRC;var g=t.createTexture(m);this.depthAttachment.depthTexture=g,this.depthAttachment.depthTextureInternal=!0,l=g.createView()}this.renderPassDescriptor.depthStencilAttachment={view:l}}}initColor(e,t,i,s){var r={},{samples:n,width:a,height:o,mipLevel:l}=i,h=i.getColorBuffer(s),c=null;if(h){c=h.cubemap?h.impl.createView({dimension:"2d",baseArrayLayer:i.face,arrayLayerCount:1,mipLevelCount:1,baseMipLevel:l}):h.impl.createView({mipLevelCount:1,baseMipLevel:l})}if(n>1){var d={size:[a,o,1],dimension:"2d",sampleCount:n,format:this.isBackbuffer?e.backBufferViewFormat:h.impl.format,usage:GPUTextureUsage.RENDER_ATTACHMENT},u=t.createTexture(d);this.setColorAttachment(s,u,d.format),r.view=u.createView(),r.resolveTarget=c}else r.view=c;return r}setupForRenderPass(e,t){for(var i,s,r=null!=(s=null==(i=this.renderPassDescriptor.colorAttachments)?void 0:i.length)?s:0,n=0;n<r;++n){var a=this.renderPassDescriptor.colorAttachments[n],o=e.colorArrayOps[n],l=t.isColorBufferSrgb(n);a.clearValue=l?o.clearValueLinear:o.clearValue,a.loadOp=o.clear?"clear":"load",a.storeOp=o.store?"store":"discard"}var h=this.renderPassDescriptor.depthStencilAttachment;h&&(h.depthClearValue=e.depthStencilOps.clearDepthValue,h.depthLoadOp=e.depthStencilOps.clearDepth?"clear":"load",h.depthStoreOp=e.depthStencilOps.storeDepth?"store":"discard",h.depthReadOnly=!1,this.depthAttachment.hasStencil&&(h.stencilClearValue=e.depthStencilOps.clearStencilValue,h.stencilLoadOp=e.depthStencilOps.clearStencil?"clear":"load",h.stencilStoreOp=e.depthStencilOps.storeStencil?"store":"discard",h.stencilReadOnly=!1))}loseContext(){this.initialized=!1}resolve(e,t,i,s){}constructor(e){this.initialized=!1,this.colorAttachments=[],this.depthAttachment=null,this.assignedColorTexture=null,this.renderPassDescriptor={},this.isBackbuffer=!1,this.renderTarget=e}}var En=[];En[2]=1,En[3]=2,En[4]=3,En[5]=4,En[1]=1,En[6]=2,En[7]=3,En[8]=4,En[0]=1,En[9]=2,En[10]=3,En[11]=4,En[12]=8,En[13]=12,En[14]=16,En[26]=1,En[27]=2,En[28]=3,En[29]=4;class An{get isArrayType(){return this.count>0}calculateOffset(e){var t=this.byteSize<=8?this.byteSize:16;this.count&&(t=16),e=ti.roundUp(e,t),this.offset=e/4}constructor(e,t,i=0){if(this.shortName=e,this.name=i?e+"[0]":e,this.type=t,this.numComponents=En[t],this.updateType=t,i>0)switch(t){case 2:this.updateType=17;break;case 1:this.updateType=Bs;break;case Rs:this.updateType=31;break;case 0:this.updateType=32;break;case 3:this.updateType=21;break;case 6:this.updateType=Ns;break;case ks:this.updateType=34;break;case 9:this.updateType=35;break;case 4:this.updateType=22;break;case 7:this.updateType=zs;break;case Os:this.updateType=37;break;case 10:this.updateType=38;break;case 5:this.updateType=23;break;case 8:this.updateType=39;break;case Fs:this.updateType=40;break;case 11:this.updateType=41;break;case Is:this.updateType=24}this.count=i;var s=this.numComponents;i&&(s=ti.roundUp(s,4)),this.byteSize=4*s,i&&(this.byteSize*=i)}}class Pn{get(e){return this.map.get(e)}constructor(e,t){this.byteSize=0,this.map=new Map,this.scope=e.scope,this.uniforms=t;for(var i=0,s=0;s<t.length;s++){var r=t[s];r.calculateOffset(i),i=4*r.offset+r.byteSize,r.scopeId=this.scope.resolve(r.name),this.map.set(r.name,r)}this.byteSize=ti.roundUp(i,16)}}var Dn=/[ \t]*(\battribute\b|\bvarying\b|\buniform\b)/g,Ln=/(\battribute\b|\bvarying\b|\bout\b|\buniform\b)[ \t]*([^;]+)(;+)/g,Mn="@@@",In=/([\w-]+)\[(.*?)\]/,Rn=new Set(["highp","mediump","lowp"]),kn=new Set(["sampler2DShadow","samplerCubeShadow","sampler2DArrayShadow"]),On={sampler2D:ws,sampler3D:As,samplerCube:Cs,samplerCubeShadow:Cs,sampler2DShadow:ws,sampler2DArray:Ts,sampler2DArrayShadow:Ts,isampler2D:ws,usampler2D:ws,isampler3D:As,usampler3D:As,isamplerCube:Cs,usamplerCube:Cs,isampler2DArray:Ts,usampler2DArray:Ts},Fn={[ws]:"texture2D",[Cs]:"textureCube",[As]:"texture3D",[Ts]:"texture2DArray"};let Bn=class{constructor(e,t){this.line=e;var i=e.trim().split(/\s+/);if(Rn.has(i[0])&&(this.precision=i.shift()),this.type=i.shift(),e.includes(","),e.includes("[")){var s=i.join(" "),r=In.exec(s);this.name=r[1],this.arraySize=Number(r[2]),isNaN(this.arraySize)&&(t.failed=!0)}else this.name=i.shift(),this.arraySize=0;this.isSampler=-1!==this.type.indexOf("sampler"),this.isSignedInt=-1!==this.type.indexOf("isampler"),this.isUnsignedInt=-1!==this.type.indexOf("usampler")}};class Nn{static run(e,t,i){var s=new Map,r=Nn.extract(t.vshader),n=Nn.extract(t.fshader),a=new Map,o=Nn.processAttributes(r.attributes,t.attributes,a,t.processingOptions),l=Nn.processVaryings(r.varyings,s,!0),h=Nn.processVaryings(n.varyings,s,!1),c=Nn.processOuts(n.outs),d=r.uniforms.concat(n.uniforms),u=Array.from(new Set(d)).map((e=>new Bn(e,i))),f=Nn.processUniforms(e,u,t.processingOptions,i),p=o+"\n"+l+"\n"+f.code,m=r.src.replace(Mn,p),g=h+"\n"+c+"\n"+f.code;return{vshader:m,fshader:n.src.replace(Mn,g),attributes:a,meshUniformBufferFormat:f.meshUniformBufferFormat,meshBindGroupFormat:f.meshBindGroupFormat}}static extract(e){for(var t,i=[],s=[],r=[],n=[],a=Mn+"\n";null!==(t=Dn.exec(e));){var o=t[1];switch(o){case"attribute":case"varying":case"uniform":case"out":Ln.lastIndex=t.index;var l=Ln.exec(e);"attribute"===o?i.push(l[2]):"varying"===o?s.push(l[2]):"out"===o?r.push(l[2]):"uniform"===o&&n.push(l[2]),e=Nn.cutOut(e,t.index,Ln.lastIndex,a),Dn.lastIndex=t.index+a.length,a=""}}return{src:e,attributes:i,varyings:s,outs:r,uniforms:n}}static processUniforms(e,t,i,s){var r=[],n=[];t.forEach((e=>{e.isSampler?r.push(e):n.push(e)}));var a=[];n.forEach((e=>{if(!i.hasUniform(e.name)){var t=Us.indexOf(e.type),s=new An(e.name,t,e.arraySize);a.push(s)}})),0===a.length&&a.push(new An(Ys,2));var o=a.length?new Pn(e,a):null,l=[];r.forEach((e=>{if(!i.hasTexture(e.name)){var t=0;e.isSignedInt?t=3:e.isUnsignedInt?t=4:("highp"===e.precision&&(t=1),kn.has(e.type)&&(t=2));var s=On[e.type];l.push(new ar(e.name,3,s,t))}}));var h=new lr(e,l),c="";return i.uniformFormats.forEach(((e,t)=>{e&&(c+=Nn.getUniformShaderDeclaration(e,t,0))})),o&&(c+=Nn.getUniformShaderDeclaration(o,2,0)),i.bindGroupFormats.forEach(((e,t)=>{e&&(c+=Nn.getTexturesShaderDeclaration(e,t))})),{code:c+=Nn.getTexturesShaderDeclaration(h,1),meshUniformBufferFormat:o,meshBindGroupFormat:h}}static processVaryings(e,t,i){var s="",r=i?"out":"in";return e.forEach(((e,n)=>{var a=Nn.splitToWords(e),o=a.slice(0,-1).join(" "),l=a[a.length-1];i?t.set(l,n):n=t.get(l),s+="layout(location = "+n+") "+r+" "+o+" "+l+";\n"})),s}static processOuts(e){var t="";return e.forEach(((e,i)=>{t+="layout(location = "+i+") out "+e+";\n"})),t}static getTypeCount(e){var t=e.substring(e.length-1),i=parseInt(t,10);return isNaN(i)?1:i}static processAttributes(e,t,i,s){var r="";return e.forEach((e=>{var n=Nn.splitToWords(e),a=n[0],o=n[1];if(t.hasOwnProperty(o)){var l,h=t[o],c=er[h];i.set(c,o);var d=s.getVertexElement(h);if(d){var u=d.dataType;if(6!==u&&7!==u&&!d.normalize&&!d.asInt){var f=Nn.getTypeCount(a),p="_private_"+o;l="vec"+f+" "+o+" = vec"+f+"("+p+");\n",o=p;var m=0===u||2===u||4===u;a=1===f?m?"int":"uint":m?"ivec"+f:"uvec"+f}}r+="layout(location = "+c+") in "+a+" "+o+";\n",l&&(r+=l)}})),r}static splitToWords(e){return(e=e.replace(/\s+/g," ").trim()).split(" ")}static cutOut(e,t,i,s){return e.substring(0,t)+s+e.substring(i)}static getUniformShaderDeclaration(e,t,i){var s="layout(set = "+t+", binding = "+i+", std140) uniform ub_"+Xs[t]+" {\n";return e.uniforms.forEach((e=>{var t=Us[e.type];s+="    "+t+" "+e.shortName+(e.count?"["+e.count+"]":"")+";\n"})),s+"};\n"}static getTexturesShaderDeclaration(e,t){var i="";return e.textureFormats.forEach((e=>{var s=Fn[e.textureDimension],r="texture2DArray"===s,n=4===e.sampleType?"u":3===e.sampleType?"i":"";s=""+n+s;var a="",o="";r&&(a="_texture",o="#define "+e.name+" "+n+"sampler2DArray("+e.name+a+", "+e.name+"_sampler)\n"),i+="layout(set = "+t+", binding = "+e.slot+") uniform "+s+" "+e.name+a+";\n",e.hasSampler&&(i+="layout(set = "+t+", binding = "+(e.slot+1)+") uniform sampler "+e.name+"_sampler;\n"),i+=o})),i}}var zn=/^[ \t]*(attribute|varying|uniform)[\t ]+/gm,Un=/^[ \t]*(attribute|varying|uniform)[ \t]*([^;]+)(;+)/gm,Vn=/^[ \t]*var\s*(<[^>]+>)?\s*[\w\d_]+\s*:\s*(texture_.*|storage_texture_.*|storage.*|external_texture|array<.*>|sampler|sampler_comparison).*;\s*$/gm,Hn=/(?:@interpolate\([^)]*\)\s*)?([\w]+)\s*:/,Gn="@@@",Wn=/(@vertex|@fragment)\s*fn\s+\w+\s*\(\s*(\w+)\s*:[\s\S]*?\{/,jn={f32:0,i32:3,u32:4},qn={f32:"WrappedF32",i32:"WrappedI32",u32:"WrappedU32",vec2f:"WrappedVec2F",vec2i:"WrappedVec2I",vec2u:"WrappedVec2U"},Xn=e=>(e=e.replace(/\s+/g," ").trim()).split(/[\s:]+/),Kn=/array<([^,]+),\s*([^>]+)>/;class Yn{constructor(e,t){this.ubName=null,this.arraySize=0,this.line=e;var i=Xn(e);if(i.length<2)t.failed=!0;else if(this.name=i[0],this.type=i.slice(1).join(" "),this.type.includes("array<")){var s=Kn.exec(this.type);this.type=s[1].trim(),this.arraySize=Number(s[2]),isNaN(this.arraySize)&&(t.failed=!0)}}}var Qn=/^\s*var\s+([\w\d_]+)\s*:\s*array<([\w\d_<>]+),\s*(\d+)>;\s*$/,Jn=/^\s*var\s+([\w\d_]+)\s*:\s*texture_(\w+)<([a-zA-Z0-9_,<>]*)>;\s*$/,$n=/^\s*var\s+([\w\d_]+)\s*:\s*(texture_storage_2d|texture_storage_2d_array)<([\w\d_]+),\s*(\w+)>\s*;\s*$/,Zn=/^\s*var\s*<storage,\s*(read|write)?>\s*([\w\d_]+)\s*:\s*(.*)\s*;\s*$/,ea=/^\s*var\s+([\w\d_]+)\s*:\s*texture_external;\s*$/,ta=/^\s*var\s+([\w\d_]+)\s*:\s*(sampler|sampler_comparison)\s*;\s*$/;class ia{constructor(e,t){this.originalLine=e,this.line=e,this.isTexture=!1,this.isSampler=!1,this.isStorageTexture=!1,this.isStorageBuffer=!1,this.isExternalTexture=!1,this.arraySize=0,this.type="",this.matchedElements=[];var i=e.match(Qn);i&&(this.name=i[1],this.arraySize=parseInt(i[3],10),this.line="var "+this.name+" : "+i[2]+";",this.matchedElements.push(...i),isNaN(this.arraySize)&&(t.failed=!0));var s=this.line.match(Jn);s&&(this.name=s[1],this.type=s[2],this.textureFormat=s[3],this.isTexture=!0,this.matchedElements.push(...s),this.textureDimension=((e,t)=>{if(t){if("2d"===e)return Ts;if("cube"===e)return Es}else switch(e){case"1d":return"1d";case"2d":return ws;case"3d":return As;case"cube":return Cs}})(this.type,this.arraySize>0),this.sampleType=jn[this.textureFormat]);var r=this.line.match($n);r&&(this.isStorageTexture=!0,this.name=r[1],this.textureType=r[2],this.format=r[3],this.access=r[4],this.matchedElements.push(...r));var n=this.line.match(Zn);n&&(this.isStorageBuffer=!0,this.accessMode=n[1]||"none",this.name=n[2],this.type=n[3],this.matchedElements.push(...n));var a=this.line.match(ea);a&&(this.name=a[1],this.isExternalTexture=!0,this.matchedElements.push(...n));var o=this.line.match(ta);o&&(this.name=o[1],this.samplerType=o[2],this.isSampler=!0,this.matchedElements.push(...o)),0===this.matchedElements.length&&(t.failed=!0)}}class sa{static run(e,t,i){var s=new Map,r=sa.extract(t.vshader),n=sa.extract(t.fshader),a=new Map,o=sa.processAttributes(r.attributes,t.attributes,a,t.processingOptions),l=sa.processVaryings(r.varyings,s,!0),h=sa.processVaryings(n.varyings,s,!1),c=r.uniforms.concat(n.uniforms),d=Array.from(new Set(c)).map((e=>new Yn(e,i))),u=sa.processUniforms(e,d,t.processingOptions,i);r.src=sa.renameUniformAccess(r.src,d),n.src=sa.renameUniformAccess(n.src,d);var f=r.resources.concat(n.resources),p=Array.from(new Set(f)).map((e=>new ia(e,i))),m=sa.processResources(e,p,t.processingOptions,i),g=sa.generateFragmentOutputStruct(n.src,e.maxColorAttachments);r.src=sa.copyInputs(r.src,i),n.src=sa.copyInputs(n.src,i);var v=o+"\n"+l+"\n"+u.code+"\n"+m.code+"\n",_=r.src.replace(Gn,v),b=h+"\n"+g+"\n"+u.code+"\n"+m.code+"\n";return{vshader:_,fshader:n.src.replace(Gn,b),attributes:a,meshUniformBufferFormat:u.meshUniformBufferFormat,meshBindGroupFormat:m.meshBindGroupFormat}}static extract(e){for(var t,i=[],s=[],r=[],n=[],a=Gn+"\n";null!==(t=zn.exec(e));){var o=t[1];Un.lastIndex=t.index;var l=Un.exec(e);"attribute"===o?i.push(l[2]):"varying"===o?s.push(l[2]):"uniform"===o&&r.push(l[2]),e=sa.cutOut(e,t.index,Un.lastIndex,a),zn.lastIndex=t.index+a.length,a=""}for(;null!==(t=Vn.exec(e));)n.push(t[0]),e=sa.cutOut(e,t.index,Vn.lastIndex,a),Vn.lastIndex=t.index+a.length,a="";return{src:e,attributes:i,varyings:s,uniforms:r,resources:n}}static processUniforms(e,t,i,s){var r=[];t.forEach((e=>{if(i.hasUniform(e.name))e.ubName="ub_view";else{e.ubName="ub_mesh_ub";var t=Hs.get(e.type),s=new An(e.name,t,e.arraySize);r.push(s)}})),0===r.length&&r.push(new An(Ys,2));var n=new Pn(e,r),a="";return i.uniformFormats.forEach(((e,t)=>{e&&(a+=sa.getUniformShaderDeclaration(e,t,0))})),n&&(a+=sa.getUniformShaderDeclaration(n,2,0)),{code:a,meshUniformBufferFormat:n}}static renameUniformAccess(e,t){return t.forEach((t=>{var i="uniform."+t.name,s=t.ubName+"."+t.name,r=new RegExp("\\b"+i+"\\b","g");e=e.replace(r,s)})),e}static processResources(e,t,i,s){for(var r=[],n=0;n<t.length;n++){var a=t[n];if(a.isTexture){var o=t[n+1],l=null==o?void 0:o.isSampler,h=a.sampleType,c=a.textureDimension;r.push(new ar(a.name,3,c,h,l,l?o.name:null)),l&&n++}if(a.isStorageBuffer){var d="read_write"!==a.accessMode,u=new nr(a.name,3,d);u.format=a.type,r.push(u)}}var f=new lr(e,r),p="";return i.bindGroupFormats.forEach(((e,t)=>{e&&(p+=sa.getTextureShaderDeclaration(e,t,1))})),{code:p+=sa.getTextureShaderDeclaration(f,1,0),meshBindGroupFormat:f}}static getUniformShaderDeclaration(e,t,i){var s=Xs[t],r="struct_ub_"+s,n="struct "+r+" {\n";return e.uniforms.forEach((e=>{var t=Vs[e.type][0];e.count>0?(qn.hasOwnProperty(t)&&(t=qn[t]),n+="    "+e.shortName+": array<"+t+", "+e.count+">,\n"):n+="    "+e.shortName+": "+t+",\n"})),n+="};\n",n+="@group("+t+") @binding("+i+") var<uniform> ub_"+s+" : "+r+";\n\n"}static getTextureShaderDeclaration(e,t,i){var s="",r=i;return e.textureFormats.forEach((e=>{var i=((e,t)=>{var i=0===t?"f32":3===t?"i32":"u32";switch(e){case"1d":return"texture_1d<"+i+">";case ws:return"texture_2d<"+i+">";case As:return"texture_3d<"+i+">";case Cs:return"texture_cube<"+i+">";case Ts:return"texture_2d_array<"+i+">";case Es:return"texture_cube_array<"+i+">"}})(e.textureDimension,e.sampleType);s+="@group("+t+") @binding("+r+") var "+e.name+": "+i+";\n",r++,e.hasSampler&&(s+="@group("+t+") @binding("+r+") var "+e.samplerName+": sampler;\n",r++)})),e.storageBufferFormats.forEach((e=>{var i=e.readOnly?"read":"read_write";s+="@group("+t+") @binding("+r+") var<storage, "+i+"> "+e.name+" : "+e.format+";\n",r++})),s}static processVaryings(e,t,i){var s="",r="",n="";return e.forEach(((e,a)=>{var o=e.match(Hn);if(o){var l=o[1];i?t.set(l,a):a=t.get(l),s+="    @location("+a+") "+e+",\n",i||(r+="    var<private> "+e+";\n",n+="    "+l+" = input."+l+";\n")}})),i?s+="    @builtin(position) position : vec4f,\n":(s+="    @builtin(position) position : vec4f,\n",s+="    @builtin(front_facing) frontFacing : bool,\n",s+="    @builtin(sample_index) sampleIndex : u32\n"),"\n            struct "+(i?"VertexOutput":"FragmentInput")+" {\n                "+s+"\n            };\n            "+(i?"":"\n            var<private> pcPosition: vec4f;\n            var<private> pcFrontFacing: bool;\n            var<private> pcSampleIndex: u32;\n            "+r+"\n            \n            // function to copy inputs (varyings) to private global variables\n            fn _pcCopyInputs(input: FragmentInput) {\n                "+n+"\n                pcPosition = input.position;\n                pcFrontFacing = input.frontFacing;\n                pcSampleIndex = input.sampleIndex;\n            }\n        ")+"\n        "}static generateFragmentOutputStruct(e,t){for(var i="struct FragmentOutput {\n",s=0;s<t;s++)i+="    @location("+s+") color"+(s>0?s:"")+" : vec4f,\n";return-1!==e.search(/\.fragDepth\s*=/)&&(i+="    @builtin(frag_depth) fragDepth : f32\n"),i+"};\n"}static floatAttributeToInt(e,t){return{f32:t?"i32":"u32",vec2f:t?"vec2i":"vec2u",vec3f:t?"vec3i":"vec3u",vec4f:t?"vec4i":"vec4u"}[{f32:"f32","vec2<f32>":"vec2f","vec3<f32>":"vec3f","vec4<f32>":"vec4f"}[e]||e]||null}static processAttributes(e,t,i,s){void 0===t&&(t={});var r="",n="",a="";return e.forEach((e=>{var o=Xn(e),l=o[0],h=o[1],c=h;if(t.hasOwnProperty(l)){var d=t[l],u=er[d];i.set(u,l);var f=s.getVertexElement(d);if(f){var p=f.dataType;if(6!==p&&7!==p&&!f.normalize&&!f.asInt){var m=0===p||2===p||4===p;h=sa.floatAttributeToInt(h,m)}}r+="    @location("+u+") "+l+": "+h+",\n",n+="    var<private> "+e+";\n",a+="    "+l+" = "+c+"(input."+l+");\n"}})),"\n            struct VertexInput {\n                "+r+"\n                @builtin(vertex_index) vertexIndex : u32,       // built-in vertex index\n                @builtin(instance_index) instanceIndex : u32    // built-in instance index\n            };\n\n            "+n+"\n            var<private> pcVertexIndex: u32;\n            var<private> pcInstanceIndex: u32;\n\n            fn _pcCopyInputs(input: VertexInput) {\n                "+a+"\n                pcVertexIndex = input.vertexIndex;\n                pcInstanceIndex = input.instanceIndex;\n            }\n        "}static copyInputs(e,t){var i=e.match(Wn);if(!i||!i[2])return e;var s=i[2],r=i.index+i[0].length-1;return e.slice(0,r+1)+("\n    _pcCopyInputs("+s+");")+e.slice(r+1)}static cutOut(e,t,i,s){return e.substring(0,t)+s+e.substring(i)}}class ra{destroy(e){this._vertexCode=null,this._fragmentCode=null}createShaderModule(e,t){return this.shader.device.wgpu.createShaderModule({code:e})}getVertexShaderModule(){return this.createShaderModule(this._vertexCode,"Vertex")}getFragmentShaderModule(){return this.createShaderModule(this._fragmentCode,"Fragment")}getComputeShaderModule(){return this.createShaderModule(this._computeCode,"Compute")}processGLSL(){var e=this.shader,t=Nn.run(e.device,e.definition,e);this._vertexCode=this.transpile(t.vshader,"vertex",e.definition.vshader),this._fragmentCode=this.transpile(t.fshader,"fragment",e.definition.fshader),this._vertexCode&&this._fragmentCode?e.ready=!0:e.failed=!0,e.meshUniformBufferFormat=t.meshUniformBufferFormat,e.meshBindGroupFormat=t.meshBindGroupFormat,e.attributes=t.attributes}processWGSL(){var e=this.shader,t=sa.run(e.device,e.definition,e);this._vertexCode=t.vshader,this._fragmentCode=t.fshader,e.meshUniformBufferFormat=t.meshUniformBufferFormat,e.meshBindGroupFormat=t.meshBindGroupFormat,e.attributes=t.attributes}transpile(e,t,i){try{var s=this.shader.device.glslang.compileGLSL(e,t);return this.shader.device.twgsl.convertSpirV2WGSL(s)}catch(s){console.error("Failed to transpile webgl "+t+" shader ["+this.shader.label+"] to WebGPU while rendering "+void 0+", error:\n ["+s.stack+"]",{processed:e,original:i,shader:this.shader,error:s,stack:s.stack})}}get vertexCode(){return this._vertexCode}get fragmentCode(){return this._fragmentCode}loseContext(){}restoreContext(e,t){}constructor(e){this._vertexCode=null,this._fragmentCode=null,this._computeCode=null,this.vertexEntryPoint="main",this.fragmentEntryPoint="main",this.computeEntryPoint="main",this.shader=e;var t=e.definition;if(t.shaderLanguage===Ms){var i,s,r;if(t.cshader)this._computeCode=null!=(i=t.cshader)?i:null,this.computeUniformBufferFormats=t.computeUniformBufferFormats,this.computeBindGroupFormat=t.computeBindGroupFormat;else if(this.vertexEntryPoint="vertexMain",this.fragmentEntryPoint="fragmentMain",t.processingOptions)this.processWGSL();else this._vertexCode=null!=(s=t.vshader)?s:null,this._fragmentCode=null!=(r=t.fshader)?r:null,e.meshUniformBufferFormat=t.meshUniformBufferFormat,e.meshBindGroupFormat=t.meshBindGroupFormat;e.ready=!0}else t.processingOptions&&this.processGLSL()}}var na=[];na[0]="repeat",na[1]="clamp-to-edge",na[2]="mirror-repeat";var aa=[];aa[0]={level:"nearest",mip:"nearest"},aa[1]={level:"linear",mip:"nearest"},aa[2]={level:"nearest",mip:"nearest"},aa[3]={level:"nearest",mip:"linear"},aa[4]={level:"linear",mip:"nearest"},aa[5]={level:"linear",mip:"linear"};class oa{create(e){var t,i=this.texture,s=e.wgpu,r=i.numLevels;this.desc={size:{width:i.width,height:i.height,depthOrArrayLayers:i.cubemap?6:i.array?i.arrayLength:1},format:this.format,mipLevelCount:r,sampleCount:1,dimension:i.volume?"3d":"2d",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC|(qi(i.format)?0:GPUTextureUsage.RENDER_ATTACHMENT)|(i.storage?GPUTextureUsage.STORAGE_BINDING:0)},this.gpuTexture=s.createTexture(this.desc),this.texture.format===Bi&&(t={format:"depth24plus",aspect:"depth-only"}),this.view=this.createView(t)}destroy(e){}propertyChanged(e){this.samplers.length=0}getView(e){return this.uploadImmediate(e,this.texture),this.view}createView(e){var t,i,s,r,n,a,o,l=null!=e?e:{},h=this.desc,c=this.texture,d={format:null!=(t=l.format)?t:h.format,dimension:null!=(i=l.dimension)?i:c.cubemap?"cube":c.volume?"3d":c.array?"2d-array":"2d",aspect:null!=(s=l.aspect)?s:"all",baseMipLevel:null!=(r=l.baseMipLevel)?r:0,mipLevelCount:null!=(n=l.mipLevelCount)?n:h.mipLevelCount,baseArrayLayer:null!=(a=l.baseArrayLayer)?a:0,arrayLayerCount:null!=(o=l.arrayLayerCount)?o:h.depthOrArrayLayers};return this.gpuTexture.createView(d)}getSampler(e,t){var i=this.samplers[t];if(!i){var s=this.texture,r={addressModeU:na[s.addressU],addressModeV:na[s.addressV],addressModeW:na[s.addressW]};if(!t&&s.compareOnRead&&(t=2),2===t||3===t||4===t)r.compare="less",r.magFilter="linear",r.minFilter="linear";else if(1===t)r.magFilter="nearest",r.minFilter="nearest",r.mipmapFilter="nearest";else{!e.textureFloatFilterable&&(s.format===ki||s.format===Ri)||this.texture.format===Bi||Ki(this.texture.format)?(r.magFilter="nearest",r.minFilter="nearest",r.mipmapFilter="nearest"):(r.magFilter=aa[s.magFilter].level,r.minFilter=aa[s.minFilter].level,r.mipmapFilter=aa[s.minFilter].mip)}var n="linear"===r.minFilter&&"linear"===r.magFilter&&"linear"===r.mipmapFilter;r.maxAnisotropy=n?ti.clamp(Math.round(s._anisotropy),1,e.maxTextureAnisotropy):1,i=e.wgpu.createSampler(r),this.samplers[t]=i}return i}loseContext(){}uploadImmediate(e,t){(t._needsUpload||t._needsMipmapsUpload)&&(this.uploadData(e),t._needsUpload=!1,t._needsMipmapsUpload=!1)}uploadData(e){var t=this.texture;if(t._levels){for(var i=!1,s=!1,r=t.numLevels,n=0;n<r;n++){var a=t._levels[n];if(a)if(t.cubemap)for(var o=0;o<6;o++){var l=a[o];l?this.isExternalImage(l)?(this.uploadExternalImage(e,l,n,o),i=!0):ArrayBuffer.isView(l)&&(this.uploadTypedArrayData(e,l,n,o),i=!0):s=!0}else if(t._volume);else if(t.array)if(t.arrayLength===a.length)for(var h=0;h<t._arrayLength;h++){var c=a[h];this.isExternalImage(c)?(this.uploadExternalImage(e,c,n,h),i=!0):ArrayBuffer.isView(c)&&(this.uploadTypedArrayData(e,c,n,h),i=!0)}else s=!0;else this.isExternalImage(a)?(this.uploadExternalImage(e,a,n,0),i=!0):ArrayBuffer.isView(a)&&(this.uploadTypedArrayData(e,a,n,0),i=!0);else s=!0}i&&s&&t.mipmaps&&!qi(t.format)&&!Ki(t.format)&&e.mipmapRenderer.generate(this),t._gpuSize&&t.adjustVramSizeTracking(e._vram,-t._gpuSize),t._gpuSize=t.gpuSize,t.adjustVramSizeTracking(e._vram,t._gpuSize)}}isExternalImage(e){return e instanceof ImageBitmap||e instanceof HTMLVideoElement||e instanceof HTMLCanvasElement||e instanceof OffscreenCanvas}uploadExternalImage(e,t,i,s){var r={source:t,origin:[0,0],flipY:!1},n={texture:this.gpuTexture,mipLevel:i,origin:[0,0,s],aspect:"all"},a={width:this.desc.size.width,height:this.desc.size.height,depthOrArrayLayers:1};e.submit(),t instanceof HTMLCanvasElement&&t.getContext("2d"),e.wgpu.queue.copyExternalImageToTexture(r,n,a)}uploadTypedArrayData(e,t,i,s){var r=this.texture,n=e.wgpu,a={texture:this.gpuTexture,origin:[0,0,s],mipLevel:i},o=cr.calcLevelDimension(r.width,i),l=cr.calcLevelDimension(r.height,i);cr.calcLevelGpuSize(o,l,1,r.format);var h,c,d=ji.get(r.format);if(d.size)h={offset:0,bytesPerRow:d.size*o,rowsPerImage:l},c={width:o,height:l};else if(d.blockSize){var u=e=>Math.floor((e+3)/4);h={offset:0,bytesPerRow:d.blockSize*u(o),rowsPerImage:u(l)},c={width:Math.max(4,o),height:Math.max(4,l)}}e.submit(),n.queue.writeTexture(a,t,h,c)}read(e,t,i,s,r){var n,a,o,l,h=null!=(n=r.mipLevel)?n:0,c=null!=(a=r.face)?a:0,d=null!=(o=r.data)?o:null,u=null!=(l=r.immediate)&&l,f=this.texture,p=i*ji.get(f.format).size,m=ti.roundUp(p,256),g=m*s,v=f.device,_=v.createBufferImpl(9);_.allocate(v,g);var b={texture:this.gpuTexture,mipLevel:h,origin:[e,t,c]},y={buffer:_.buffer,offset:0,bytesPerRow:m},x={width:i,height:s,depthOrArrayLayers:1};return v.getCommandEncoder().copyTextureToBuffer(b,y,x),v.readBuffer(_,g,null,u).then((e=>{for(var t,i=(null==d?void 0:d.constructor)===Uint8Array?d:new Uint8Array(null!=(t=null==d?void 0:d.buffer)?t:s*p),r=0;r<s;r++){var n=r*m,a=r*p,o=e.subarray(n,n+p);i.set(o,a)}return null!=d?d:i}))}constructor(e){this.samplers=[],this.texture=e,this.format=Xr[e.format],this.create(e.device)}}class la extends $r{unlock(e){var t=e.device;super.unlock(t,e.storageInt32.buffer)}constructor(e){super(64)}}class ha extends $r{unlock(e){var t=e.device;super.unlock(t,e.storage)}constructor(e,t,i){super(32|((null==i?void 0:i.storage)?128:0))}}var ca=/[ \t]*#(ifn?def|if|endif|else|elif|define|undef|extension|include)/g,da=/define[ \t]+([^\n]+)\r?(?:\n|$)/g,ua=/extension[ \t]+([\w-]+)[ \t]*:[ \t]*(enable|require)/g,fa=/undef[ \t]+([^\n]+)\r?(?:\n|$)/g,pa=/(ifdef|ifndef|if)[ \t]*([^\r\n]+)\r?\n/g,ma=/(endif|else|elif)(?:[ \t]+([^\r\n]*))?\r?\n?/g,ga=/\{?[\w-]+\}?/,va=/(!|\s)?defined\(([\w-]+)\)/,_a=/([a-z_]\w*)\s*(==|!=|<|<=|>|>=)\s*([\w"']+)/i,ba=/[+\-]/g,ya=/include[ \t]+"([\w-]+)(?:\s*,\s*([\w-]+))?"\r?(?:\n|$)/g,xa=/\{i\}/g,Sa=/(pcFragColor[1-8])\b/g;class wa{static run(e,t,i){void 0===t&&(t=new Map),void 0===i&&(i={}),wa.sourceName=i.sourceName,e=(e=this.stripComments(e)).split(/\r?\n/).map((e=>e.trimEnd())).join("\n");var s=new Map,r=new Map;if(null===(e=this._preprocess(e,s,r,t,i.stripDefines)))return null;var n=new Map;return s.forEach(((e,t)=>{Number.isInteger(parseFloat(e))&&!e.includes(".")&&n.set(t,e)})),e=this.stripComments(e),e=this.stripUnusedColorAttachments(e,i),e=this.RemoveEmptyLines(e),e=this.processArraySize(e,n),e=this.injectDefines(e,r)}static stripUnusedColorAttachments(e,t){if(t.stripUnusedColorAttachments){var i=new Map,s=e.match(Sa);if(null==s||s.forEach((e=>{var t,s=parseInt(e.charAt(e.length-1),10);i.set(s,(null!=(t=i.get(s))?t:0)+1)})),Array.from(i.values()).some((e=>1===e))){for(var r=e.split("\n"),n=[],a=0;a<r.length;a++){var o=r[a].match(Sa);if(o){var l=parseInt(o[0].charAt(o[0].length-1),10);if(l>0&&1===i.get(l))continue}n.push(r[a])}e=n.join("\n")}}return e}static stripComments(e){return e.replace(/\/\*[\s\S]*?\*\/|([^\\:]|^)\/\/.*$/gm,"$1")}static processArraySize(e,t){return null!==e&&t.forEach(((t,i)=>{e=e.replace(new RegExp("\\["+i+"\\]","g"),"["+t+"]")})),e}static injectDefines(e,t){if(null!==e&&t.size>0){var i=e.split("\n");t.forEach(((e,t)=>{for(var s=new RegExp(t,"g"),r=0;r<i.length;r++)i[r].includes("#")||(i[r]=i[r].replace(s,e))})),e=i.join("\n")}return e}static RemoveEmptyLines(e){return null!==e&&(e=(e=e.split(/\r?\n/).map((e=>""===e.trim()?"":e)).join("\n")).replace(/(\n\n){3,}/g,"\n\n")),e}static _preprocess(e,t,i,s,r){void 0===t&&(t=new Map);for(var n,a=e,o=[],l=!1;null!==(n=ca.exec(e))&&!l;){var h=n[1];switch(h){case"define":da.lastIndex=n.index;var c=da.exec(e);l||(l=null===c);var d=c[1];ga.lastIndex=c.index;var u=ga.exec(d)[0],f=d.substring(u.length).trim();""===f&&(f="true");var p=r;if(wa._keep(o)){var m=u.startsWith("{")&&u.endsWith("}");m&&(p=!0),m?i.set(u,f):t.set(u,f),p&&(e=e.substring(0,c.index-1)+e.substring(da.lastIndex),ca.lastIndex=c.index-1)}p||(ca.lastIndex=c.index+c[0].length);break;case"undef":fa.lastIndex=n.index;var g=fa.exec(e),v=g[1].trim();wa._keep(o)&&(t.delete(v),r&&(e=e.substring(0,g.index-1)+e.substring(fa.lastIndex),ca.lastIndex=g.index-1)),r||(ca.lastIndex=g.index+g[0].length);break;case"extension":ua.lastIndex=n.index;var _=ua.exec(e);if(l||(l=null===_),_){var b=_[1];wa._keep(o)&&t.set(b,"true")}ca.lastIndex=_.index+_[0].length;break;case"ifdef":case"ifndef":case"if":pa.lastIndex=n.index;var y=pa.exec(e),x=y[2],S=wa.evaluate(x,t);l||(l=S.error);var w=S.result;"ifndef"===h&&(w=!w),o.push({anyKeep:w,keep:w,start:n.index,end:pa.lastIndex}),ca.lastIndex=y.index+y[0].length;break;case"endif":case"else":case"elif":ma.lastIndex=n.index;var T=ma.exec(e),C=o.pop();if(!C){console.error('Shader preprocessing encountered "#'+T[1]+'" without a preceding #if #ifdef #ifndef while preprocessing '+wa.sourceName+" on line:\n "+e.substring(n.index,n.index+100)+"...",{source:a}),l=!0;continue}var E=C.keep?e.substring(C.end,n.index):"";e=e.substring(0,C.start)+E+e.substring(ma.lastIndex),ca.lastIndex=C.start+E.length;var A=T[1];if("else"===A||"elif"===A){var P=!1;if(!C.anyKeep)if("else"===A)P=!C.keep;else{var D=wa.evaluate(T[2],t);P=D.result,l||(l=D.error)}o.push({anyKeep:C.anyKeep||P,keep:P,start:ca.lastIndex,end:ca.lastIndex})}break;case"include":var L;ya.lastIndex=n.index;var M=ya.exec(e);if(l||(l=null===M),!M){l=!0;continue}var I=M[1].trim(),R=null==(L=M[2])?void 0:L.trim();if(wa._keep(o)){var k=null==s?void 0:s.get(I);if(void 0===k){console.error('Include "'+I+'" not resolved while preprocessing '+wa.sourceName,{source:a}),l=!0;continue}if(k=this.stripComments(k),R){var O=t.get(R),F=parseFloat(O);if(Number.isInteger(F)){for(var B="",N=0;N<F;N++)B+=k.replace(xa,String(N));k=B}else console.error('Include Count identifier "'+R+'" not resolved while preprocessing '+wa.sourceName+" on line:\n "+e.substring(n.index,n.index+100)+"...",{source:a}),l=!0}e=e.substring(0,M.index-1)+k+e.substring(ya.lastIndex),ca.lastIndex=M.index-1}}}return o.length>0&&(console.error("Shader preprocessing reached the end of the file without encountering the necessary #endif to close a preceding #if, #ifdef, or #ifndef block. "+wa.sourceName),l=!0),l?(console.error("Failed to preprocess shader: ",{source:a}),null):e}static _keep(e){for(var t=0;t<e.length;t++)if(!e[t].keep)return!1;return!0}static evaluateAtomicExpression(e,t){var i=!1;e=e.trim();var s=!1,r=va.exec(e);if(r){s="!"===r[1],e=r[2].trim();var n=t.has(e);return{result:s?!n:n,error:i}}var a=_a.exec(e);if(a){var o,l,h=null!=(o=t.get(a[1].trim()))?o:a[1].trim(),c=null!=(l=t.get(a[3].trim()))?l:a[3].trim(),d=!1;switch(a[2].trim()){case"==":d=h===c;break;case"!=":d=h!==c;break;case"<":d=h<c;break;case"<=":d=h<=c;break;case">":d=h>c;break;case">=":d=h>=c;break;default:i=!0}return{result:d,error:i}}return{result:t.has(e),error:i}}static evaluate(e,t){var i=null===ba.exec(e),s=e.split("||");for(var r of s){var n=r.split("&&"),a=!0;for(var o of n){var{result:l,error:h}=wa.evaluateAtomicExpression(o.trim(),t);if(!l||h){a=!1;break}}if(a)return{result:!0,error:!i}}return{result:!1,error:!i}}}var Ta="\n#ifndef outType_0\n#define outType_0 vec4\n#endif\nlayout(location = 0) out highp outType_0 pcFragColor0;\n#if COLOR_ATTACHMENT_1\nlayout(location = 1) out highp outType_1 pcFragColor1;\n#endif\n#if COLOR_ATTACHMENT_2\nlayout(location = 2) out highp outType_2 pcFragColor2;\n#endif\n#if COLOR_ATTACHMENT_3\nlayout(location = 3) out highp outType_3 pcFragColor3;\n#endif\n#if COLOR_ATTACHMENT_4\nlayout(location = 4) out highp outType_4 pcFragColor4;\n#endif\n#if COLOR_ATTACHMENT_5\nlayout(location = 5) out highp outType_5 pcFragColor5;\n#endif\n#if COLOR_ATTACHMENT_6\nlayout(location = 6) out highp outType_6 pcFragColor6;\n#endif\n#if COLOR_ATTACHMENT_7\nlayout(location = 7) out highp outType_7 pcFragColor7;\n#endif\n#define gl_FragColor pcFragColor0\n#define varying in\n#define texture2D texture\n#define texture2DBias texture\n#define textureCube texture\n#define texture2DProj textureProj\n#define texture2DLod textureLod\n#define texture2DProjLod textureProjLod\n#define textureCubeLod textureLod\n#define texture2DGrad textureGrad\n#define texture2DProjGrad textureProjGrad\n#define textureCubeGrad textureGrad\n#define utexture2D texture\n#define itexture2D texture\n#define texture2DLodEXT texture2DLodEXT_is_no_longer_supported_use_texture2DLod_instead\n#define texture2DProjLodEXT texture2DProjLodEXT_is_no_longer_supported_use_texture2DProjLod\n#define textureCubeLodEXT textureCubeLodEXT_is_no_longer_supported_use_textureCubeLod_instead\n#define texture2DGradEXT texture2DGradEXT_is_no_longer_supported_use_texture2DGrad_instead\n#define texture2DProjGradEXT texture2DProjGradEXT_is_no_longer_supported_use_texture2DProjGrad_instead\n#define textureCubeGradEXT textureCubeGradEXT_is_no_longer_supported_use_textureCubeGrad_instead\n#define textureShadow(res, uv) textureGrad(res, uv, vec2(1, 1), vec2(1, 1))\n#define SHADOWMAP_PASS(name) name\n#define SHADOWMAP_ACCEPT(name) sampler2DShadow name\n#define TEXTURE_PASS(name) name\n#define TEXTURE_ACCEPT(name) sampler2D name\n#define TEXTURE_ACCEPT_HIGHP(name) highp sampler2D name\n#define GL2\n",Ca="\n#define attribute in\n#define varying out\n#define texture2D texture\n#define utexture2D texture\n#define itexture2D texture\n#define GL2\n#define VERTEXSHADER\n#define TEXTURE_PASS(name) name\n#define TEXTURE_ACCEPT(name) sampler2D name\n#define TEXTURE_ACCEPT_HIGHP(name) highp sampler2D name\n",Ea="\n#extension GL_EXT_samplerless_texture_functions : require\n#ifndef outType_0\n#define outType_0 vec4\n#endif\n#ifndef outType_1\n#define outType_1 vec4\n#endif\n#ifndef outType_2\n#define outType_2 vec4\n#endif\n#ifndef outType_3\n#define outType_3 vec4\n#endif\n#ifndef outType_4\n#define outType_4 vec4\n#endif\n#ifndef outType_5\n#define outType_5 vec4\n#endif\n#ifndef outType_6\n#define outType_6 vec4\n#endif\n#ifndef outType_7\n#define outType_7 vec4\n#endif\nlayout(location = 0) out highp outType_0 pcFragColor0;\nlayout(location = 1) out highp outType_1 pcFragColor1;\nlayout(location = 2) out highp outType_2 pcFragColor2;\nlayout(location = 3) out highp outType_3 pcFragColor3;\nlayout(location = 4) out highp outType_4 pcFragColor4;\nlayout(location = 5) out highp outType_5 pcFragColor5;\nlayout(location = 6) out highp outType_6 pcFragColor6;\nlayout(location = 7) out highp outType_7 pcFragColor7;\n#define gl_FragColor pcFragColor0\n#define texture2D(res, uv) texture(sampler2D(res, res ## _sampler), uv)\n#define texture2DBias(res, uv, bias) texture(sampler2D(res, res ## _sampler), uv, bias)\n#define texture2DLod(res, uv, lod) textureLod(sampler2D(res, res ## _sampler), uv, lod)\n#define textureCube(res, uv) texture(samplerCube(res, res ## _sampler), uv)\n#define textureCubeLod(res, uv, lod) textureLod(samplerCube(res, res ## _sampler), uv, lod)\n#define textureShadow(res, uv) textureLod(sampler2DShadow(res, res ## _sampler), uv, 0.0)\n#define itexture2D(res, uv) texture(isampler2D(res, res ## _sampler), uv)\n#define utexture2D(res, uv) texture(usampler2D(res, res ## _sampler), uv)\n#define texture2DLodEXT texture2DLodEXT_is_no_longer_supported_use_texture2DLod_instead\n#define texture2DProjLodEXT texture2DProjLodEXT_is_no_longer_supported_use_texture2DProjLod\n#define textureCubeLodEXT textureCubeLodEXT_is_no_longer_supported_use_textureCubeLod_instead\n#define texture2DGradEXT texture2DGradEXT_is_no_longer_supported_use_texture2DGrad_instead\n#define texture2DProjGradEXT texture2DProjGradEXT_is_no_longer_supported_use_texture2DProjGrad_instead\n#define textureCubeGradEXT textureCubeGradEXT_is_no_longer_supported_use_textureCubeGrad_instead\n#define SHADOWMAP_PASS(name) name, name ## _sampler\n#define SHADOWMAP_ACCEPT(name) texture2D name, sampler name ## _sampler\n#define TEXTURE_PASS(name) name, name ## _sampler\n#define TEXTURE_ACCEPT(name) texture2D name, sampler name ## _sampler\n#define TEXTURE_ACCEPT_HIGHP TEXTURE_ACCEPT\n#define GL2\n#define WEBGPU\n",Aa="\n#extension GL_EXT_samplerless_texture_functions : require\n#define texture2D(res, uv) texture(sampler2D(res, res ## _sampler), uv)\n#define itexture2D(res, uv) texture(isampler2D(res, res ## _sampler), uv)\n#define utexture2D(res, uv) texture(usampler2D(res, res ## _sampler), uv)\n#define TEXTURE_PASS(name) name, name ## _sampler\n#define TEXTURE_ACCEPT(name) texture2D name, sampler name ## _sampler\n#define TEXTURE_ACCEPT_HIGHP TEXTURE_ACCEPT\n#define GL2\n#define WEBGPU\n#define VERTEXSHADER\n#define gl_VertexID gl_VertexIndex\n#define gl_InstanceID gl_InstanceIndex\n",Pa="\nvec2 getGrabScreenPos(vec4 clipPos) {\n\tvec2 uv = (clipPos.xy / clipPos.w) * 0.5 + 0.5;\n\t#ifdef WEBGPU\n\t\tuv.y = 1.0 - uv.y;\n\t#endif\n\treturn uv;\n}\nvec2 getImageEffectUV(vec2 uv) {\n\t#ifdef WEBGPU\n\t\tuv.y = 1.0 - uv.y;\n\t#endif\n\treturn uv;\n}\n",Da="\nfn getGrabScreenPos(clipPos: vec4<f32>) -> vec2<f32> {\n\tvar uv: vec2<f32> = (clipPos.xy / clipPos.w) * 0.5 + vec2<f32>(0.5);\n\tuv.y = 1.0 - uv.y;\n\treturn uv;\n}\nfn getImageEffectUV(uv: vec2<f32>) -> vec2<f32> {\n\tvar modifiedUV: vec2<f32> = uv;\n\tmodifiedUV.y = 1.0 - modifiedUV.y;\n\treturn modifiedUV;\n}\nstruct WrappedF32 { @size(16) element: f32 }\nstruct WrappedI32 { @size(16) element: i32 }\nstruct WrappedU32 { @size(16) element: u32 }\nstruct WrappedVec2F { @size(16) element: vec2f }\nstruct WrappedVec2I { @size(16) element: vec2i }\nstruct WrappedVec2U { @size(16) element: vec2u }\n",La={vertex_position:Ji,vertex_normal:$i,vertex_tangent:Zi,vertex_texCoord0:rs,vertex_texCoord1:ns,vertex_texCoord2:as,vertex_texCoord3:os,vertex_texCoord4:ls,vertex_texCoord5:hs,vertex_texCoord6:cs,vertex_texCoord7:ds,vertex_color:is,vertex_boneIndices:ts,vertex_boneWeights:es};class Ma{static createDefinition(e,t){var i,s,r,n,a=(t,i,s,r)=>{var n=e.isWebGPU?t:i,a="";if(!s){var o,l=null!=(o=r.fragmentOutputTypes)?o:"vec4";Array.isArray(l)||(l=[l]);for(var h=0;h<e.maxColorAttachments;h++){var c;a+="#define COLOR_ATTACHMENT_"+h+"\n",a+="#define outType_"+h+" "+(null!=(c=l[h])?c:"vec4")+"\n"}}return a+n},o=null!=(i=t.name)?i:"Untitled",l=Ma.getDefinesCode(e,t.vertexDefines),h=Ma.getDefinesCode(e,t.fragmentDefines);return t.shaderLanguage===Ms?(s="\n                \n#define VERTEXSHADER\n\n                "+Da+"\n                "+l+"\n                "+t.vertexCode+"\n            ",r="\n                \n\n                "+Da+"\n                "+h+"\n                "+t.fragmentCode+"\n            "):(s=Ma.versionCode(e)+a(Aa,Ca,!0,t)+l+Ma.precisionCode(e)+"\n                "+Pa+"\n                "+Ma.getShaderNameCode(o)+"\n                "+t.vertexCode,r=(t.fragmentPreamble||"")+Ma.versionCode(e)+a(Ea,Ta,!1,t)+h+Ma.precisionCode(e)+"\n                "+Pa+"\n                "+Ma.getShaderNameCode(o)+"\n                "+(t.fragmentCode||Ma.dummyFragmentCode())),{name:o,shaderLanguage:null!=(n=t.shaderLanguage)?n:Ls,attributes:t.attributes,vshader:s,vincludes:t.vertexIncludes,fincludes:t.fragmentIncludes,fshader:r,useTransformFeedback:t.useTransformFeedback,meshUniformBufferFormat:t.meshUniformBufferFormat,meshBindGroupFormat:t.meshBindGroupFormat}}static getDefinesCode(e,t){var i="";return e.capsDefines.forEach(((e,t)=>{i+="#define "+t+" "+e+"\n"})),i+="\n",null==t||t.forEach(((e,t)=>{i+="#define "+t+" "+e+"\n"})),i+="\n"}static getShaderNameCode(e){return"#define SHADER_NAME "+e+"\n"}static dummyFragmentCode(){return"void main(void) {gl_FragColor = vec4(0.0);}"}static versionCode(e){return e.isWebGPU?"#version 450\n":"#version 300 es\n"}static precisionCode(e,t){t&&"highp"!==t&&"mediump"!==t&&"lowp"!==t&&(t=null),t&&("highp"===t&&"highp"!==e.maxPrecision&&(t="mediump"),"mediump"===t&&"lowp"===e.maxPrecision&&(t="lowp"));var i=t||e.precision;return"\n            precision "+i+" float;\n            precision "+i+" int;\n            precision "+i+" usampler2D;\n            precision "+i+" isampler2D;\n            precision "+i+" sampler2DShadow;\n            precision "+i+" samplerCubeShadow;\n            precision "+i+" sampler2DArray;\n        "}static collectAttributes(e){for(var t={},i=0,s=e.indexOf("attribute");s>=0&&!(s>0&&"/"===e[s-1]);){var r=!1;if(s>0){var n=e.lastIndexOf("\n",s);n=-1!==n?n+1:0,e.substring(n,s).includes("#")&&(r=!0)}if(!r){var a=e.indexOf(";",s),o=e.lastIndexOf(" ",a),l=e.substring(o+1,a);if(t[l]);else{var h=La[l];void 0!==h?t[l]=h:(t[l]="ATTR"+i,i++)}}s=e.indexOf("attribute",s+1)}return t}}var Ia=0;class Ra{init(){this.ready=!1,this.failed=!1}get label(){return"Shader Id "+this.id+" ("+(this.definition.shaderLanguage===Ms?"WGSL":"GLSL")+") "+this.name}destroy(){this.device.onDestroyShader(this),this.impl.destroy(this)}loseContext(){this.init(),this.impl.loseContext()}restoreContext(){this.impl.restoreContext(this.device,this)}constructor(e,t){if(this.attributes=new Map,this.id=Ia++,this.device=e,this.definition=t,this.name=t.name||"Untitled",this.init(),t.cshader);else{var i,s=t.shaderLanguage===Ms;if(t.vshader=wa.run(t.vshader,t.vincludes,{sourceName:"vertex shader for "+this.label,stripDefines:s}),t.shaderLanguage===Ls)null!=(i=t).attributes||(i.attributes=Ma.collectAttributes(t.vshader));var r=e.isWebGL2&&("osx"===Ut.name||"ios"===Ut.name);if(t.fshader=wa.run(t.fshader,t.fincludes,{stripUnusedColorAttachments:r,stripDefines:s,sourceName:"fragment shader for "+this.label}),!t.vshader||!t.fshader)return void(this.failed=!0)}this.impl=e.createShaderImpl(this)}}class ka{}class Oa{}class Fa{destroy(){this.gpuBuffers.forEach((e=>{e.destroy(this.device)})),this.gpuBuffers=null,this.stagingBuffers.forEach((e=>{e.destroy(this.device)})),this.stagingBuffers=null,this.usedBuffers=null,this.activeBuffer=null}alloc(e,t){if(this.activeBuffer){var i=ti.roundUp(this.activeBuffer.size,this.bufferAlignment);this.bufferSize-i<t&&this.scheduleSubmit()}if(!this.activeBuffer){var s=this.gpuBuffers.pop();s||(s=this.createBuffer(this.device,this.bufferSize,!1));var r=this.stagingBuffers.pop();r||(r=this.createBuffer(this.device,this.bufferSize,!0)),this.activeBuffer=new ka,this.activeBuffer.stagingBuffer=r,this.activeBuffer.gpuBuffer=s,this.activeBuffer.offset=0,this.activeBuffer.size=0}var n=this.activeBuffer,a=ti.roundUp(n.size,this.bufferAlignment);e.gpuBuffer=n.gpuBuffer,e.offset=a,e.storage=n.stagingBuffer.alloc(a,t),n.size=a+t}scheduleSubmit(){this.activeBuffer&&(this.usedBuffers.push(this.activeBuffer),this.activeBuffer=null)}submit(){this.scheduleSubmit()}constructor(e,t,i){this.gpuBuffers=[],this.stagingBuffers=[],this.usedBuffers=[],this.activeBuffer=null,this.device=e,this.bufferSize=t,this.bufferAlignment=i}}var Ba=[];Ba[2]=function(e,t,i){e.storageFloat32[i]=t},Ba[3]=(e,t,i)=>{var s=e.storageFloat32;s[i]=t[0],s[i+1]=t[1]},Ba[4]=(e,t,i)=>{var s=e.storageFloat32;s[i]=t[0],s[i+1]=t[1],s[i+2]=t[2]},Ba[5]=(e,t,i)=>{var s=e.storageFloat32;s[i]=t[0],s[i+1]=t[1],s[i+2]=t[2],s[i+3]=t[3]},Ba[1]=function(e,t,i){e.storageInt32[i]=t},Ba[6]=function(e,t,i){var s=e.storageInt32;s[i]=t[0],s[i+1]=t[1]},Ba[7]=function(e,t,i){var s=e.storageInt32;s[i]=t[0],s[i+1]=t[1],s[i+2]=t[2]},Ba[8]=function(e,t,i){var s=e.storageInt32;s[i]=t[0],s[i+1]=t[1],s[i+2]=t[2],s[i+3]=t[3]},Ba[12]=(e,t,i)=>{var s=e.storageFloat32;s[i]=t[0],s[i+1]=t[1],s[i+4]=t[2],s[i+5]=t[3],s[i+8]=t[4],s[i+9]=t[5]},Ba[13]=(e,t,i)=>{var s=e.storageFloat32;s[i]=t[0],s[i+1]=t[1],s[i+2]=t[2],s[i+4]=t[3],s[i+5]=t[4],s[i+6]=t[5],s[i+8]=t[6],s[i+9]=t[7],s[i+10]=t[8]},Ba[17]=function(e,t,i,s){for(var r=e.storageFloat32,n=0;n<s;n++)r[i+4*n]=t[n]},Ba[21]=(e,t,i,s)=>{for(var r=e.storageFloat32,n=0;n<s;n++)r[i+4*n]=t[2*n],r[i+4*n+1]=t[2*n+1]},Ba[22]=(e,t,i,s)=>{for(var r=e.storageFloat32,n=0;n<s;n++)r[i+4*n]=t[3*n],r[i+4*n+1]=t[3*n+1],r[i+4*n+2]=t[3*n+2]},Ba[26]=(e,t,i,s)=>{e.storageUint32[i]=t},Ba[27]=(e,t,i,s)=>{var r=e.storageUint32;r[i]=t[0],r[i+1]=t[1]},Ba[28]=(e,t,i,s)=>{var r=e.storageUint32;r[i]=t[0],r[i+1]=t[1],r[i+2]=t[2]},Ba[29]=(e,t,i,s)=>{var r=e.storageUint32;r[i]=t[0],r[i+1]=t[1],r[i+2]=t[2],r[i+3]=t[3]},Ba[30]=function(e,t,i,s){for(var r=e.storageInt32,n=0;n<s;n++)r[i+4*n]=t[n]},Ba[32]=Ba[30],Ba[31]=function(e,t,i,s){for(var r=e.storageUint32,n=0;n<s;n++)r[i+4*n]=t[n]},Ba[33]=(e,t,i,s)=>{for(var r=e.storageInt32,n=0;n<s;n++)r[i+4*n]=t[2*n],r[i+4*n+1]=t[2*n+1]},Ba[35]=Ba[33],Ba[34]=(e,t,i,s)=>{for(var r=e.storageUint32,n=0;n<s;n++)r[i+4*n]=t[2*n],r[i+4*n+1]=t[2*n+1]},Ba[36]=(e,t,i,s)=>{for(var r=e.storageInt32,n=0;n<s;n++)r[i+4*n]=t[3*n],r[i+4*n+1]=t[3*n+1],r[i+4*n+2]=t[3*n+2]},Ba[38]=Ba[36],Ba[37]=(e,t,i,s)=>{for(var r=e.storageUint32,n=0;n<s;n++)r[i+4*n]=t[3*n],r[i+4*n+1]=t[3*n+1],r[i+4*n+2]=t[3*n+2]};class Na{destroy(){if(this.persistent){var e=this.device;this.impl.destroy(e),e._vram.ub-=this.format.byteSize}}get offset(){return this.persistent?0:this.allocation.offset}assignStorage(e){this.storageInt32=e,this.storageUint32=new Uint32Array(e.buffer,e.byteOffset,e.byteLength/4),this.storageFloat32=new Float32Array(e.buffer,e.byteOffset,e.byteLength/4)}loseContext(){var e;null==(e=this.impl)||e.loseContext()}setUniform(e,t){var i=e.offset;if(null!=t){var s=Ba[e.updateType];s?s(this,t,i,e.count):this.storageFloat32.set(t,i)}}set(e,t){var i=this.format.map.get(e);i&&this.setUniform(i,t)}startUpdate(e){if(!this.persistent){var t=this.allocation,i=t.gpuBuffer;this.device.dynamicBuffers.alloc(t,this.format.byteSize),this.assignStorage(t.storage),e&&(e.bindGroup=t.gpuBuffer.getBindGroup(this),e.offsets[0]=t.offset),i!==t.gpuBuffer&&(this.renderVersionDirty=this.device.renderVersion)}}endUpdate(){this.persistent?this.impl.unlock(this):(this.storageFloat32=null,this.storageInt32=null)}update(e){this.startUpdate(e);for(var t=this.format.uniforms,i=0;i<t.length;i++){var s=t[i].scopeId.value;this.setUniform(t[i],s)}this.endUpdate()}constructor(e,t,i=!0){if(this.renderVersionDirty=0,this.device=e,this.format=t,this.persistent=i,i){this.impl=e.createUniformBufferImpl(this);var s=new ArrayBuffer(t.byteSize);this.assignStorage(new Int32Array(s)),e._vram.ub+=this.format.byteSize}else this.allocation=new Oa}}var za={type:5,base:0,count:4,indexed:!1};class Ua{destroy(){this.shader.destroy(),this.shader=null,this.uniformBuffer.destroy(),this.uniformBuffer=null}clear(e,t,i,s){var r,n=null!=(r=(i=i||s).flags)?r:s.flags;if(0!==n){var{uniformBuffer:a,dynamicBindGroup:o}=this;if(a.startUpdate(o),e.setBindGroup(2,o.bindGroup,o.offsets),e.setBindGroup(1,e.emptyBindGroup),1&n&&(t.colorBuffer||t.impl.assignedColorTexture)){var l,h=null!=(l=i.color)?l:s.color;this.colorData.set(h),e.setBlendState(Sr.NOBLEND)}else e.setBlendState(Sr.NOWRITE);if(a.set("color",this.colorData),2&n&&t.depth){var c,d=null!=(c=i.depth)?c:s.depth;a.set("depth",d),e.setDepthState(Cr.WRITEDEPTH)}else a.set("depth",1),e.setDepthState(Cr.NODEPTH);a.endUpdate(),e.setCullMode(0),e.setShader(this.shader),e.draw(za)}}constructor(e){var t="\n\n            struct ub_mesh {\n                color : vec4f,\n                depth: f32\n            }\n\n            @group(2) @binding(0) var<uniform> ubMesh : ub_mesh;\n\n            var<private> pos : array<vec2f, 4> = array<vec2f, 4>(\n                vec2(-1.0, 1.0), vec2(1.0, 1.0),\n                vec2(-1.0, -1.0), vec2(1.0, -1.0)\n            );\n\n            struct VertexOutput {\n                @builtin(position) position : vec4f\n            }\n\n            @vertex\n            fn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {\n                var output : VertexOutput;\n                output.position = vec4(pos[vertexIndex], ubMesh.depth, 1.0);\n                return output;\n            }\n\n            @fragment\n            fn fragmentMain() -> @location(0) vec4f {\n                return ubMesh.color;\n            }\n        ";this.shader=new Ra(e,{name:"WebGPUClearRendererShader",shaderLanguage:Ms,vshader:t,fshader:t}),this.uniformBuffer=new Na(e,new Pn(e,[new An("color",5),new An("depth",2)]),!1),this.dynamicBindGroup=new _r,this.colorData=new Float32Array(4)}}class Va{destroy(){this.shader.destroy(),this.shader=null}generate(e){var t=e.desc;if(!(t.mipLevelCount<=1||e.texture.volume)){for(var i=this.device,s=i.wgpu,r=this.shader.impl,n=s.createRenderPipeline({layout:"auto",vertex:{module:r.getVertexShaderModule(),entryPoint:r.vertexEntryPoint},fragment:{module:r.getFragmentShaderModule(),entryPoint:r.fragmentEntryPoint,targets:[{format:t.format}]},primitive:{topology:"triangle-strip"}}),a=e.texture,o=a.cubemap?6:a.array?a.arrayLength:1,l=[],h=0;h<o;h++)l.push(e.createView({dimension:"2d",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:h}));for(var c=i.getCommandEncoder(),d=1;d<t.mipLevelCount;d++)for(var u=0;u<o;u++){var f=e.createView({dimension:"2d",baseMipLevel:d,mipLevelCount:1,baseArrayLayer:u}),p=c.beginRenderPass({colorAttachments:[{view:f,loadOp:"clear",storeOp:"store"}]}),m=s.createBindGroup({layout:n.getBindGroupLayout(0),entries:[{binding:0,resource:this.minSampler},{binding:1,resource:l[u]}]});p.setPipeline(n),p.setBindGroup(0,m),p.draw(4),p.end(),l[u]=f}i.pipeline=null}}constructor(e){this.device=e;var t="\n \n            var<private> pos : array<vec2f, 4> = array<vec2f, 4>(\n                vec2(-1.0, 1.0), vec2(1.0, 1.0),\n                vec2(-1.0, -1.0), vec2(1.0, -1.0)\n            );\n\n            struct VertexOutput {\n                @builtin(position) position : vec4f,\n                @location(0) texCoord : vec2f\n            };\n\n            @vertex\n            fn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {\n              var output : VertexOutput;\n              output.texCoord = pos[vertexIndex] * vec2f(0.5, -0.5) + vec2f(0.5);\n              output.position = vec4f(pos[vertexIndex], 0, 1);\n              return output;\n            }\n\n            @group(0) @binding(0) var imgSampler : sampler;\n            @group(0) @binding(1) var img : texture_2d<f32>;\n\n            @fragment\n            fn fragmentMain(@location(0) texCoord : vec2f) -> @location(0) vec4f {\n              return textureSample(img, imgSampler, texCoord);\n            }\n        ";this.shader=new Ra(e,{name:"WebGPUMipmapRendererShader",shaderLanguage:Ms,vshader:t,fshader:t}),this.minSampler=e.wgpu.createSampler({minFilter:"linear"})}}class Ha{getBindGroup(e){var t=e.format.byteSize,i=this.bindGroupCache.get(t);return i||((i=new br(this.device,this.bindGroupFormat,e)).update(),this.bindGroupCache.set(t,i)),i}constructor(e){this.bindGroupCache=new Map,this.device=e,this.bindGroupFormat=new lr(this.device,[new rr(Ks,3)])}}class Ga extends Ha{destroy(e){e._vram.ub-=this.buffer.size,this.buffer.destroy(),this.buffer=null}onAvailable(){this.mappedRange=this.buffer.getMappedRange()}alloc(e,t){return new Int32Array(this.mappedRange,e,t/4)}constructor(e,t,i){super(e),this.buffer=null,this.mappedRange=null,this.buffer=e.wgpu.createBuffer({size:t,usage:i?GPUBufferUsage.MAP_WRITE|GPUBufferUsage.COPY_SRC:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:i}),i&&this.onAvailable(),e._vram.ub+=t}}class Wa extends Fa{createBuffer(e,t,i){return new Ga(e,t,i)}submit(){super.submit();var e=this.usedBuffers.length;if(e){for(var t=this.device,i=this.gpuBuffers,s=t.wgpu.createCommandEncoder(),r=e-1;r>=0;r--){var n=this.usedBuffers[r],{stagingBuffer:a,gpuBuffer:o,offset:l,size:h}=n,c=a.buffer;c.unmap(),s.copyBufferToBuffer(c,l,o.buffer,l,h),i.push(o)}var d=s.finish();t.addCommandBuffer(d,!0);for(var u=0;u<e;u++){var f=this.usedBuffers[u].stagingBuffer;this.pendingStagingBuffers.push(f)}this.usedBuffers.length=0}}onCommandBuffersSubmitted(){var e=this.pendingStagingBuffers.length;if(e){for(var t,i=function(e){var i=t.pendingStagingBuffers[e];i.buffer.mapAsync(GPUMapMode.WRITE).then((()=>{t.stagingBuffers&&(i.onAvailable(),t.stagingBuffers.push(i))}))},s=0;s<e;s++)t=this,i(s);this.pendingStagingBuffers.length=0}}constructor(...e){super(...e),this.pendingStagingBuffers=[]}}class ja{loseContext(){this.pastFrameAllocations.clear()}set enabled(e){this._enableRequest=e}get enabled(){return this._enableRequest}processEnableRequest(){this._enableRequest!==this._enabled&&(this._enabled=this._enableRequest,this._enabled||(this._frameTime=0))}request(e){this.pastFrameAllocations.set(e,this.frameAllocations),this.frameAllocations=[]}report(e,t){t&&(this.pastFrameAllocations.get(e),t.length>0&&(this._frameTime=t[0]),ei.get("GpuTimings")),this.pastFrameAllocations.delete(e)}getSlot(e){var t=this.frameAllocations.length;return this.frameAllocations.push(e),t}get slotCount(){return this.frameAllocations.length}constructor(){this.frameAllocations=[],this.pastFrameAllocations=new Map,this._enabled=!1,this._enableRequest=!1,this._frameTime=0}}class qa{destroy(){var e,t;null==(e=this.querySet)||e.destroy(),this.querySet=null,null==(t=this.queryBuffer)||t.destroy(),this.queryBuffer=null,this.activeStagingBuffer=null,this.stagingBuffers.forEach((e=>{e.destroy()})),this.stagingBuffers=null}getStagingBuffer(){var e=this.stagingBuffers.pop();return e||(e=this.device.wgpu.createBuffer({size:this.queryBuffer.size,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ})),e}resolve(e){var t=this.device.getCommandEncoder();t.resolveQuerySet(this.querySet,0,e,this.queryBuffer,0);var i=this.getStagingBuffer();this.activeStagingBuffer=i,t.copyBufferToBuffer(this.queryBuffer,0,i,0,this.bytesPerSlot*e)}request(e,t){var i=this.activeStagingBuffer;return this.activeStagingBuffer=null,i.mapAsync(GPUMapMode.READ).then((()=>{for(var s,r=new BigInt64Array(i.getMappedRange()),n=[],a=0;a<e;a++)n.push(1e-6*Number(r[2*a+1]-r[2*a]));return i.unmap(),null==(s=this.stagingBuffers)||s.push(i),{renderVersion:t,timings:n}}))}constructor(e,t,i){this.stagingBuffers=[],this.activeStagingBuffer=null,this.device=e,this.capacity=i,this.bytesPerSlot=t?8:4;var s=e.wgpu;this.querySet=s.createQuerySet({type:t?"timestamp":"occlusion",count:i}),this.queryBuffer=s.createBuffer({size:this.bytesPerSlot*i,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST})}}class Xa extends ja{destroy(){var e;null==(e=this.timestampQueriesSet)||e.destroy(),this.timestampQueriesSet=null}frameStart(){this.processEnableRequest()}frameEnd(){var e;this._enabled&&(null==(e=this.timestampQueriesSet)||e.resolve(2*this.slotCount))}request(){if(this._enabled){var e,t=this.device.renderVersion;null==(e=this.timestampQueriesSet)||e.request(this.slotCount,t).then((e=>{this.report(e.renderVersion,e.timings)})),super.request(t)}}constructor(e){super(),this.device=e,this.timestampQueriesSet=e.supportsTimestampQuery?new qa(e,!0,512):null}}class Ka{destroy(){this.shader.destroy(),this.shader=null,this.pipelineCache=null}getPipeline(e){var t=this.pipelineCache.get(e);return t||(t=this.createPipeline(e),this.pipelineCache.set(e,t)),t}createPipeline(e){var t=this.shader.impl;return this.device.wgpu.createRenderPipeline({layout:"auto",vertex:{module:t.getVertexShaderModule(),entryPoint:t.vertexEntryPoint},fragment:{module:t.getFragmentShaderModule(),entryPoint:t.fragmentEntryPoint,targets:[{format:e}]},primitive:{topology:"triangle-strip"}})}resolveDepth(e,t,i){for(var s=this.device,r=s.wgpu,n=this.getPipeline(i.format),a=t.depthOrArrayLayers,o=0;o<a;o++){var l=t.createView({dimension:"2d",aspect:"depth-only",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:o}),h=i.createView({dimension:"2d",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:o}),c=e.beginRenderPass({colorAttachments:[{view:h,loadOp:"clear",storeOp:"store"}]}),d=r.createBindGroup({layout:n.getBindGroupLayout(0),entries:[{binding:0,resource:l}]});c.setPipeline(n),c.setBindGroup(0,d),c.draw(4),c.end()}s.pipeline=null}constructor(e){this.pipelineCache=new Map,this.device=e;var t="\n \n            var<private> pos : array<vec2f, 4> = array<vec2f, 4>(\n                vec2(-1.0, 1.0), vec2(1.0, 1.0), vec2(-1.0, -1.0), vec2(1.0, -1.0)\n            );\n\n            struct VertexOutput {\n                @builtin(position) position : vec4f,\n            };\n\n            @vertex\n            fn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {\n              var output : VertexOutput;\n              output.position = vec4f(pos[vertexIndex], 0, 1);\n              return output;\n            }\n\n            @group(0) @binding(0) var img : texture_depth_multisampled_2d;\n\n            @fragment\n            fn fragmentMain(@builtin(position) fragColor: vec4f) -> @location(0) vec4f {\n                // load th depth value from sample index 0\n                var depth = textureLoad(img, vec2i(fragColor.xy), 0u);\n                return vec4f(depth, 0.0, 0.0, 0.0);\n            }\n        ";this.shader=new Ra(e,{name:"WebGPUResolverDepthShader",shaderLanguage:Ms,vshader:t,fshader:t})}}class Ya{destroy(){this.uniformBuffers.forEach((e=>e.destroy())),this.uniformBuffers.length=0,this.bindGroup.destroy(),this.bindGroup=null}updateBindGroup(){var{bindGroup:e}=this;e.updateUniformBuffers(),e.update()}dispatch(e,t,i){var s=this.compute.device;s.setBindGroup(0,this.bindGroup);var r=s.passEncoder;r.setPipeline(this.pipeline),r.dispatchWorkgroups(e,t,i)}constructor(e){this.uniformBuffers=[],this.bindGroup=null,this.compute=e;var{device:t,shader:i}=e,{computeBindGroupFormat:s,computeUniformBufferFormats:r}=i.impl;if(this.bindGroup=new br(t,s),r)for(var n in r)if(r.hasOwnProperty(n)){var a=new Na(t,r[n],!0);this.uniformBuffers.push(a),this.bindGroup.setUniformBuffer(n,a)}this.pipeline=t.computePipeline.get(i,s)}}function Qa(e,t,i,s,r,n,a){try{var o=e[n](a),l=o.value}catch(e){return void i(e)}o.done?t(l):Promise.resolve(l).then(s,r)}function Ja(e){return function(){var t=this,i=arguments;return new Promise((function(s,r){var n=e.apply(t,i);function a(e){Qa(n,s,r,a,o,"next",e)}function o(e){Qa(n,s,r,a,o,"throw",e)}a(void 0)}))}}var $a=new Map;class Za extends Hr{destroy(){this.clearRenderer.destroy(),this.clearRenderer=null,this.mipmapRenderer.destroy(),this.mipmapRenderer=null,this.resolver.destroy(),this.resolver=null,super.destroy()}initDeviceCaps(){var e,t=null==(e=this.wgpu)?void 0:e.limits;this.limits=t,this.precision="highp",this.maxPrecision="highp",this.maxSamples=4,this.maxTextures=16,this.maxTextureSize=t.maxTextureDimension2D,this.maxCubeMapSize=t.maxTextureDimension2D,this.maxVolumeSize=t.maxTextureDimension3D,this.maxColorAttachments=t.maxColorAttachments,this.maxPixelRatio=1,this.maxAnisotropy=16,this.fragmentUniformsCount=t.maxUniformBufferBindingSize/16,this.vertexUniformsCount=t.maxUniformBufferBindingSize/16,this.supportsUniformBuffers=!0,this.supportsAreaLights=!0,this.supportsGpuParticles=!0,this.supportsCompute=!0,this.textureFloatRenderable=!0,this.textureHalfFloatRenderable=!0,this.supportsImageBitmap=!0,this.samples=this.backBufferAntialias?4:1;var i=navigator.gpu.wgslLanguageFeatures;this.supportsStorageTextureRead=null==i?void 0:i.has("readonly_and_readwrite_storage_textures"),this.initCapsDefines()}initWebGpu(e,t){var i=this;return Ja((function*(){if(!window.navigator.gpu)throw new Error("Unable to retrieve GPU. Ensure you are using a browser that supports WebGPU rendering.");var s=e=>new URL(e,window.location.href).toString(),r=yield Promise.all([import(""+s(t)).then((e=>twgsl(t.replace(".js",".wasm")))),import(""+s(e)).then((e=>e.default()))]);return i.twgsl=r[0],i.glslang=r[1],i.createDevice()}))()}createDevice(){var e=this;return Ja((function*(){var t,i,s={powerPreference:"default"!==e.initOptions.powerPreference?e.initOptions.powerPreference:void 0};e.gpuAdapter=yield window.navigator.gpu.requestAdapter(s);var r=[],n=t=>{var i=e.gpuAdapter.features.has(t);return i&&r.push(t),i};e.textureFloatFilterable=n("float32-filterable"),e.textureFloatBlendable=n("float32-blendable"),e.extCompressedTextureS3TC=n("texture-compression-bc"),e.extCompressedTextureETC=n("texture-compression-etc2"),e.extCompressedTextureASTC=n("texture-compression-astc"),e.supportsTimestampQuery=n("timestamp-query"),e.supportsDepthClip=n("depth-clip-control"),e.supportsDepth32Stencil=n("depth32float-stencil8"),e.supportsIndirectFirstInstance=n("indirect-first-instance"),e.supportsShaderF16=n("shader-f16"),e.supportsStorageRGBA8=n("bgra8unorm-storage"),e.textureRG11B10Renderable=n("rg11b10ufloat-renderable"),e.supportsClipDistances=n("clip-distances");var a=null==(t=e.gpuAdapter)?void 0:t.limits,o={};if(a)for(var l in a)"minSubgroupSize"!==l&&"maxSubgroupSize"!==l&&(o[l]=a[l]);var h={requiredFeatures:r,requiredLimits:o,defaultQueue:{label:"Default Queue"}};e.wgpu=yield e.gpuAdapter.requestDevice(h),null==(i=e.wgpu.lost)||i.then(e.handleDeviceLost.bind(e)),e.initDeviceCaps(),e.gpuContext=e.canvas.getContext("webgpu");var c="standard",d=navigator.gpu.getPreferredCanvasFormat(),u=e.initOptions.displayFormat;if(e.backBufferFormat="rgba8unorm"===d?u===qs?zi:7:u===qs?64:31,e.backBufferViewFormat=u===qs?d+"-srgb":d,"hdr"===u&&e.textureFloatFilterable){var f=window.matchMedia("(dynamic-range: high)");(null==f?void 0:f.matches)&&(e.backBufferFormat=Ri,e.backBufferViewFormat="rgba16float",d="rgba16float",e.isHdr=!0,c="extended")}return e.canvasConfig={device:e.wgpu,colorSpace:"srgb",alphaMode:e.initOptions.alpha?"premultiplied":"opaque",format:d,toneMapping:{mode:c},usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC|GPUTextureUsage.COPY_DST,viewFormats:u===qs?[e.backBufferViewFormat]:[]},e.gpuContext.configure(e.canvasConfig),e.createBackbuffer(),e.clearRenderer=new Ua(e),e.mipmapRenderer=new Va(e),e.resolver=new Ka(e),e.postInit(),e}))()}handleDeviceLost(e){var t=this,i=()=>super.loseContext,s=()=>super.restoreContext;return Ja((function*(){"destroyed"!==e.reason&&(i().call(t),yield t.createDevice(),s().call(t))}))()}postInit(){super.postInit(),this.initializeRenderState(),this.setupPassEncoderDefaults(),this.gpuProfiler=new Xa(this),this.dynamicBuffers=new Wa(this,102400,this.limits.minUniformBufferOffsetAlignment),this.emptyBindGroup=new br(this,new lr(this,[])),this.emptyBindGroup.update()}createBackbuffer(){this.supportsStencil=this.initOptions.stencil,this.backBuffer=new Wr({name:"WebgpuFramebuffer",graphicsDevice:this,depth:this.initOptions.depth,stencil:this.supportsStencil,samples:this.samples}),this.backBuffer.impl.isBackbuffer=!0}frameStart(){super.frameStart(),this.gpuProfiler.frameStart(),this.submit();var e=this.gpuContext.getCurrentTexture();this.backBufferSize.x===e.width&&this.backBufferSize.y===e.height||(this.backBufferSize.set(e.width,e.height),this.backBuffer.destroy(),this.backBuffer=null,this.createBackbuffer());var t=this.backBuffer,i=t.impl;i.setColorAttachment(0,void 0,this.backBufferViewFormat),this.initRenderTarget(t),i.assignColorTexture(this,e)}frameEnd(){super.frameEnd(),this.gpuProfiler.frameEnd(),this.submit(),this.contextLost||this.gpuProfiler.request()}createBufferImpl(e){return new $r(e)}createUniformBufferImpl(e){return new la(e)}createVertexBufferImpl(e,t,i){return new ha(e,t,i)}createIndexBufferImpl(e,t){return new Zr(e,t)}createShaderImpl(e){return new ra(e)}createTextureImpl(e){return new oa(e)}createRenderTargetImpl(e){return new Cn(e)}createBindGroupFormatImpl(e){return new Jr(e)}createBindGroupImpl(e){return new jr}createComputeImpl(e){return new Ya(e)}setBindGroup(e,t,i){this.passEncoder&&(this.passEncoder.setBindGroup(e,t.impl.bindGroup,null!=i?i:t.uniformBufferOffsets),this.bindGroupFormats[e]=t.format.impl)}submitVertexBuffer(e,t){var i=e.format,{interleaved:s,elements:r}=i,n=r.length,a=e.impl.buffer;if(s)return this.passEncoder.setVertexBuffer(t,a),1;for(var o=0;o<n;o++)this.passEncoder.setVertexBuffer(t+o,a,r[o].offset);return n}validateVBLocations(e,t){var i=e=>{for(var{elements:t}=e.format,i=0;i<t.length;i++){var s=t[i].name,r=er[s];$a.has(r),$a.set(r,s)}};i(e),i(t),$a.clear()}draw(e,t,i){if(void 0===t&&(t=1),this.shader.ready&&!this.shader.failed){var s=this.passEncoder,r=this.vertexBuffers[0],n=this.vertexBuffers[1];if(r){var a=this.submitVertexBuffer(r,0);n&&this.submitVertexBuffer(n,a)}var o=this.indexBuffer,l=this.renderPipeline.get(e,null==r?void 0:r.format,null==n?void 0:n.format,null==o?void 0:o.format,this.shader,this.renderTarget,this.bindGroupFormats,this.blendState,this.depthState,this.cullMode,this.stencilEnabled,this.stencilFront,this.stencilBack);this.pipeline!==l&&(this.pipeline=l,s.setPipeline(l)),o?(s.setIndexBuffer(o.impl.buffer,o.impl.format),s.drawIndexed(e.count,t,e.base,0,0)):s.draw(e.count,t,e.base,0)}this.vertexBuffers.length=0,this.indexBuffer=null}setShader(e,t){e!==this.shader&&(this.shader=e)}setBlendState(e){this.blendState.copy(e)}setDepthState(e){this.depthState.copy(e)}setStencilState(e,t){if(e||t){this.stencilEnabled=!0,this.stencilFront.copy(null!=e?e:Ur.DEFAULT),this.stencilBack.copy(null!=t?t:Ur.DEFAULT);var i=this.stencilFront.ref;this.stencilRef!==i&&(this.stencilRef=i,this.passEncoder.setStencilReference(i))}else this.stencilEnabled=!1}setBlendColor(e,t,i,s){var r=this.blendColor;e===r.r&&t===r.g&&i===r.b&&s===r.a||(r.set(e,t,i,s),this.passEncoder.setBlendConstant(r))}setCullMode(e){this.cullMode=e}setAlphaToCoverage(e){}initializeContextCaches(){super.initializeContextCaches()}setupPassEncoderDefaults(){this.pipeline=null,this.stencilRef=0,this.blendColor.set(0,0,0,0)}_uploadDirtyTextures(){this.textures.forEach((e=>{(e._needsUpload||e._needsMipmaps)&&e.upload()}))}setupTimeStampWrites(e,t){if(this.gpuProfiler._enabled&&this.gpuProfiler.timestampQueriesSet){var i=this.gpuProfiler.getSlot(t);(e=null!=e?e:{}).timestampWrites={querySet:this.gpuProfiler.timestampQueriesSet.querySet,beginningOfPassWriteIndex:2*i,endOfPassWriteIndex:2*i+1}}return e}startRenderPass(e){this._uploadDirtyTextures();var t=e.renderTarget||this.backBuffer;this.renderTarget=t;var i=t.impl;t!==this.backBuffer&&this.initRenderTarget(t),i.setupForRenderPass(e,t);var s=i.renderPassDescriptor;this.setupTimeStampWrites(s,e.name);var r=this.getCommandEncoder();this.passEncoder=r.beginRenderPass(s),this.passEncoder.label=e.name+"-PassEncoder RT:"+t.name,this.setupPassEncoderDefaults();var{width:n,height:a}=t;this.setViewport(0,0,n,a),this.setScissor(0,0,n,a),this.insideRenderPass=!0}endRenderPass(e){this.passEncoder.end(),this.passEncoder=null,this.insideRenderPass=!1,this.bindGroupFormats.length=0;var t=this.renderTarget;if(t&&t.depthBuffer&&e.depthStencilOps.resolveDepth&&e.samples>1&&t.autoResolve){var i=t.impl.depthAttachment,s=t.depthBuffer.impl.gpuTexture;i&&s&&this.resolver.resolveDepth(this.commandEncoder,i.multisampledDepthBuffer,s)}for(var r=0;r<e.colorArrayOps.length;r++){e.colorArrayOps[r].genMipmaps&&this.mipmapRenderer.generate(e.renderTarget._colorBuffers[r].impl)}}startComputePass(e){this.pipeline=null;var t=this.setupTimeStampWrites(void 0,e),i=this.getCommandEncoder();this.passEncoder=i.beginComputePass(t),this.insideRenderPass=!0}endComputePass(){this.passEncoder.end(),this.passEncoder=null,this.insideRenderPass=!1,this.bindGroupFormats.length=0}computeDispatch(e,t){void 0===t&&(t="Unnamed"),this.startComputePass(t);for(var i=0;i<e.length;i++){var s=e[i];s.applyParameters(),s.impl.updateBindGroup()}for(var r=0;r<e.length;r++){var n=e[r];n.impl.dispatch(n.countX,n.countY,n.countZ)}this.endComputePass()}getCommandEncoder(){var e=this.commandEncoder;return e||(e=this.wgpu.createCommandEncoder(),this.commandEncoder=e),e}endCommandEncoder(){var{commandEncoder:e}=this;if(e){var t=e.finish();this.addCommandBuffer(t),this.commandEncoder=null}}addCommandBuffer(e,t){void 0===t&&(t=!1),t?this.commandBuffers.unshift(e):this.commandBuffers.push(e)}submit(){this.endCommandEncoder(),this.commandBuffers.length>0&&(this.dynamicBuffers.submit(),this.wgpu.queue.submit(this.commandBuffers),this.commandBuffers.length=0,this.dynamicBuffers.onCommandBuffersSubmitted())}clear(e){e.flags&&this.clearRenderer.clear(this,this.renderTarget,e,this.defaultClearOptions)}setViewport(e,t,i,s){this.passEncoder&&(this.renderTarget.flipY||(t=this.renderTarget.height-t-s),this.vx=e,this.vy=t,this.vw=i,this.vh=s,this.passEncoder.setViewport(e,t,i,s,0,1))}setScissor(e,t,i,s){this.passEncoder&&(this.renderTarget.flipY||(t=this.renderTarget.height-t-s),this.sx=e,this.sy=t,this.sw=i,this.sh=s,this.passEncoder.setScissorRect(e,t,i,s))}clearStorageBuffer(e,t,i){void 0===t&&(t=0),void 0===i&&(i=e.byteSize),this.getCommandEncoder().clearBuffer(e.buffer,t,i)}readStorageBuffer(e,t,i,s,r){void 0===t&&(t=0),void 0===i&&(i=e.byteSize-t),void 0===s&&(s=null),void 0===r&&(r=!1);var n=this.createBufferImpl(9);n.allocate(this,i);var a=n.buffer;return this.getCommandEncoder().copyBufferToBuffer(e.buffer,t,a,0,i),this.readBuffer(n,i,s,r)}readBuffer(e,t,i,s){void 0===i&&(i=null),void 0===s&&(s=!1);var r=e.buffer;return new Promise(((n,a)=>{var o=()=>{null==r||r.mapAsync(GPUMapMode.READ).then((()=>{null!=i||(i=new Uint8Array(t));var s=r.getMappedRange(0,t),a=i.constructor;i.set(new a(s)),r.unmap(),e.destroy(this),n(i)}))};s?(this.submit(),o()):setTimeout((()=>{o()}))}))}writeStorageBuffer(e,t,i,s,r){void 0===t&&(t=0),void 0===s&&(s=0),this.wgpu.queue.writeBuffer(e.buffer,t,i,s,r)}copyRenderTarget(e,t,i,s){var r={width:e?e.width:t.width,height:e?e.height:t.height,depthOrArrayLayers:1},n=this.getCommandEncoder();if(i){var a={texture:e?e.colorBuffer.impl.gpuTexture:this.backBuffer.impl.assignedColorTexture,mipLevel:0},o={texture:t?t.colorBuffer.impl.gpuTexture:this.backBuffer.impl.assignedColorTexture,mipLevel:0};n.copyTextureToTexture(a,o,r)}if(s){var l=(e||this.renderTarget).impl.depthAttachment.depthTexture;if(e.samples>1){var h=t.colorBuffer.impl.gpuTexture;this.resolver.resolveDepth(n,l,h)}else{var c={texture:l,mipLevel:0},d={texture:t?t.depthBuffer.impl.gpuTexture:this.renderTarget.impl.depthAttachment.depthTexture,mipLevel:0};n.copyTextureToTexture(c,d,r)}}return!0}constructor(e,t={}){var i,s;super(e,t),this.renderPipeline=new pn(this),this.computePipeline=new mn(this),this.bindGroupFormats=[],this.commandEncoder=null,this.commandBuffers=[],(t=this.initOptions).alpha=null==(i=t.alpha)||i,this.backBufferAntialias=null!=(s=t.antialias)&&s,this.isWebGPU=!0,this._deviceType=Ws,this.scope.resolve(Ys).setValue(0)}}class eo{destroy(e){this.bufferId&&(e.gl.deleteBuffer(this.bufferId),this.bufferId=null)}get initialized(){return!!this.bufferId}loseContext(){this.bufferId=null}unlock(e,t,i,s){var r=e.gl;if(this.bufferId)r.bindBuffer(i,this.bufferId),r.bufferSubData(i,0,s);else{var n;switch(t){case 0:n=r.STATIC_DRAW;break;case 1:n=r.DYNAMIC_DRAW;break;case 2:n=r.STREAM_DRAW;break;case 3:n=r.DYNAMIC_COPY}this.bufferId=r.createBuffer(),r.bindBuffer(i,this.bufferId),r.bufferData(i,s,n)}}constructor(){this.bufferId=null}}class to extends eo{destroy(e){super.destroy(e),e.unbindVertexArray()}loseContext(){super.loseContext(),this.vao=null}unlock(e){var t=e.device;super.unlock(t,e.usage,t.gl.ARRAY_BUFFER,e.storage)}constructor(...e){super(...e),this.vao=null}}class io extends eo{unlock(e){var t=e.device;super.unlock(t,e.usage,t.gl.ELEMENT_ARRAY_BUFFER,e.storage)}constructor(e){super();var t=e.device.gl,i=e.format;0===i?this.glFormat=t.UNSIGNED_BYTE:1===i?this.glFormat=t.UNSIGNED_SHORT:2===i&&(this.glFormat=t.UNSIGNED_INT)}}class so{constructor(e,t,i,s){if(this.locationId=s,this.scopeId=e.scope.resolve(t),this.version=new Er,"[0]"===t.substring(t.length-3))switch(i){case 2:i=17;break;case 1:i=Bs;break;case Rs:i=31;break;case 0:i=32;break;case 3:i=21;break;case 6:i=Ns;break;case ks:i=34;break;case 9:i=35;break;case 4:i=22;break;case 7:i=zs;break;case Os:i=37;break;case 10:i=38;break;case 5:i=23;break;case 8:i=39;break;case Fs:i=40;break;case 11:i=41}this.dataType=i,this.value=[null,null,null,null],this.array=[]}}var ro=new Set(["gl_VertexID","gl_InstanceID","gl_DrawID","gl_BaseVertex","gl_BaseInstance"]);class no{destroy(e){this.map.forEach((t=>{e.gl.deleteShader(t)}))}loseContext(e){this.map.clear()}constructor(){this.map=new Map}}var ao=new hr,oo=new hr;class lo{destroy(e){this.glProgram&&(e.device.gl.deleteProgram(this.glProgram),this.glProgram=null)}init(){this.uniforms=[],this.samplers=[],this.attributes=[],this.glProgram=null,this.glVertexShader=null,this.glFragmentShader=null}loseContext(){this.init()}restoreContext(e,t){this.compile(e,t),this.link(e,t)}compile(e,t){var i=t.definition;this.glVertexShader=this._compileShaderSource(e,i.vshader,!0),this.glFragmentShader=this._compileShaderSource(e,i.fshader,!1)}link(e,t){if(!this.glProgram){var i=e.gl;if(!i.isContextLost()){var s=i.createProgram();this.glProgram=s,i.attachShader(s,this.glVertexShader),i.attachShader(s,this.glFragmentShader);var r=t.definition,n=r.attributes;if(r.useTransformFeedback){var a=[];for(var o in n)n.hasOwnProperty(o)&&a.push("out_"+o);i.transformFeedbackVaryings(s,a,i.INTERLEAVED_ATTRIBS)}for(var l in n)if(n.hasOwnProperty(l)){var h=n[l],c=er[h];i.bindAttribLocation(s,c,l)}i.linkProgram(s)}}}_compileShaderSource(e,t,i){var s=e.gl;if(s.isContextLost())return null;var r=(i?ao:oo).get(e,(()=>new no)),n=r.map.get(t);return n||(n=s.createShader(i?s.VERTEX_SHADER:s.FRAGMENT_SHADER),s.shaderSource(n,t),s.compileShader(n),r.map.set(t,n)),n}finalize(e,t){var i=e.gl;if(i.isContextLost())return!0;var s=this.glProgram,r=t.definition;if(!i.getProgramParameter(s,i.LINK_STATUS)){if(!this._isCompiled(e,t,this.glVertexShader,r.vshader,"vertex"))return!1;if(!this._isCompiled(e,t,this.glFragmentShader,r.fshader,"fragment"))return!1;var n="Failed to link shader program. Error: "+i.getProgramInfoLog(s);return console.error(n),!1}var a=i.getProgramParameter(s,i.ACTIVE_ATTRIBUTES);t.attributes.clear();for(var o=0;o<a;o++){var l=i.getActiveAttrib(s,o),h=i.getAttribLocation(s,l.name);ro.has(l.name)||(void 0===r.attributes[l.name]?(console.error('Vertex shader attribute "'+l.name+'" is not mapped to a semantic in shader definition, shader ['+t.label+"]",t),t.failed=!0):t.attributes.set(h,l.name))}for(var c=e._samplerTypes,d=i.getProgramParameter(s,i.ACTIVE_UNIFORMS),u=0;u<d;u++){var f=i.getActiveUniform(s,u),p=i.getUniformLocation(s,f.name),m=new so(e,f.name,e.pcUniformType[f.type],p);c.has(f.type)?this.samplers.push(m):this.uniforms.push(m)}return t.ready=!0,!0}_isCompiled(e,t,i,s,r){var n=e.gl;if(!n.getShaderParameter(i,n.COMPILE_STATUS)){var a=n.getShaderInfoLog(i),[o,l]=this._processError(s,a),h="Failed to compile "+r+" shader:\n\n"+a+"\n"+o+" while rendering "+void 0;return console.error(h),!1}return!0}isLinked(e){var{extParallelShaderCompile:t}=e;return!t||e.gl.getProgramParameter(this.glProgram,t.COMPLETION_STATUS_KHR)}_processError(e,t){var i={},s="";if(e){var r=e.split("\n"),n=0,a=r.length;if(t&&t.startsWith("ERROR:")){var o=t.match(/^ERROR:\s(\d+):(\d+):\s*(.+)/);o&&(i.message=o[3],i.line=parseInt(o[2],10),n=Math.max(0,i.line-6),a=Math.min(r.length,i.line+5))}for(var l=n;l<a;l++){s+=""+(l+1===i.line?"> ":"  ")+(l+1)+":\t"+r[l]+"\n"}i.source=e}return[s,i]}constructor(e){this.compileDuration=0,this.init(),this.compile(e.device,e),this.link(e.device,e),e.device.shaders.push(e)}}function ho(e,t){var i=e.width,s=e.height;if(i>t||s>t){var r=t/Math.max(i,s),n=Math.floor(i*r),a=Math.floor(s*r),o=document.createElement("canvas");return o.width=n,o.height=a,o.getContext("2d").drawImage(e,0,0,i,s,0,0,n,a),o}return e}class co{destroy(e){if(this._glTexture){for(var t=0;t<e.textureUnits.length;t++)for(var i=e.textureUnits[t],s=0;s<i.length;s++)i[s]===this._glTexture&&(i[s]=null);e.gl.deleteTexture(this._glTexture),this._glTexture=null}}loseContext(){this._glTexture=null}propertyChanged(e){this.dirtyParameterFlags|=e}initialize(e,t){var i=e.gl;switch(this._glTexture=i.createTexture(),this._glTarget=t._cubemap?i.TEXTURE_CUBE_MAP:t._volume?i.TEXTURE_3D:t.array?i.TEXTURE_2D_ARRAY:i.TEXTURE_2D,t._format){case 0:this._glFormat=i.ALPHA,this._glInternalFormat=i.ALPHA,this._glPixelType=i.UNSIGNED_BYTE;break;case 1:this._glFormat=i.LUMINANCE,this._glInternalFormat=i.LUMINANCE,this._glPixelType=i.UNSIGNED_BYTE;break;case 2:this._glFormat=i.LUMINANCE_ALPHA,this._glInternalFormat=i.LUMINANCE_ALPHA,this._glPixelType=i.UNSIGNED_BYTE;break;case 52:this._glFormat=i.RED,this._glInternalFormat=i.R8,this._glPixelType=i.UNSIGNED_BYTE;break;case 53:this._glFormat=i.RG,this._glInternalFormat=i.RG8,this._glPixelType=i.UNSIGNED_BYTE;break;case 3:this._glFormat=i.RGB,this._glInternalFormat=i.RGB565,this._glPixelType=i.UNSIGNED_SHORT_5_6_5;break;case 4:this._glFormat=i.RGBA,this._glInternalFormat=i.RGB5_A1,this._glPixelType=i.UNSIGNED_SHORT_5_5_5_1;break;case 5:this._glFormat=i.RGBA,this._glInternalFormat=i.RGBA4,this._glPixelType=i.UNSIGNED_SHORT_4_4_4_4;break;case 6:this._glFormat=i.RGB,this._glInternalFormat=i.RGB8,this._glPixelType=i.UNSIGNED_BYTE;break;case 7:this._glFormat=i.RGBA,this._glInternalFormat=i.RGBA8,this._glPixelType=i.UNSIGNED_BYTE;break;case 31:case 64:break;case 8:this._glFormat=i.RGB,this._glInternalFormat=e.extCompressedTextureS3TC.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case 9:this._glFormat=i.RGBA,this._glInternalFormat=e.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case Ii:this._glFormat=i.RGBA,this._glInternalFormat=e.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case 21:this._glFormat=i.RGB,this._glInternalFormat=e.extCompressedTextureETC1.COMPRESSED_RGB_ETC1_WEBGL;break;case Ui:this._glFormat=i.RGB,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;break;case Vi:this._glFormat=i.RGBA,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;break;case 26:this._glFormat=i.RGB,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;break;case 27:this._glFormat=i.RGBA,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;break;case 22:this._glFormat=i.RGB,this._glInternalFormat=e.extCompressedTextureETC.COMPRESSED_RGB8_ETC2;break;case 23:this._glFormat=i.RGBA,this._glInternalFormat=e.extCompressedTextureETC.COMPRESSED_RGBA8_ETC2_EAC;break;case 28:this._glFormat=i.RGBA,this._glInternalFormat=e.extCompressedTextureASTC.COMPRESSED_RGBA_ASTC_4x4_KHR;break;case 29:this._glFormat=i.RGB,this._glInternalFormat=e.extCompressedTextureATC.COMPRESSED_RGB_ATC_WEBGL;break;case 30:this._glFormat=i.RGBA,this._glInternalFormat=e.extCompressedTextureATC.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL;break;case 65:this._glFormat=i.RGB,this._glInternalFormat=e.extTextureCompressionBPTC.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT;break;case 66:this._glFormat=i.RGB,this._glInternalFormat=e.extTextureCompressionBPTC.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT;break;case 67:this._glFormat=i.RGBA,this._glInternalFormat=e.extTextureCompressionBPTC.COMPRESSED_RGBA_BPTC_UNORM_EXT;break;case 54:this._glFormat=i.SRGB,this._glInternalFormat=e.extCompressedTextureS3TC_SRGB.COMPRESSED_SRGB_S3TC_DXT1_EXT;break;case 55:this._glFormat=i.SRGB_ALPHA,this._glInternalFormat=e.extCompressedTextureS3TC_SRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;break;case 56:this._glFormat=i.SRGB_ALPHA,this._glInternalFormat=e.extCompressedTextureS3TC_SRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;break;case 61:this._glFormat=i.SRGB,this._glInternalFormat=e.extCompressedTextureETC.COMPRESSED_SRGB8_ETC2;break;case 62:this._glFormat=i.SRGB_ALPHA,this._glInternalFormat=e.extCompressedTextureETC.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;break;case 63:this._glFormat=i.SRGB_ALPHA,this._glInternalFormat=e.extCompressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 68:this._glFormat=i.RGBA,this._glInternalFormat=e.extTextureCompressionBPTC.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 50:this._glFormat=i.RED,this._glInternalFormat=i.R16F,this._glPixelType=i.HALF_FLOAT;break;case 51:this._glFormat=i.RG,this._glInternalFormat=i.RG16F,this._glPixelType=i.HALF_FLOAT;break;case 11:this._glFormat=i.RGB,this._glInternalFormat=i.RGB16F,this._glPixelType=i.HALF_FLOAT;break;case Ri:this._glFormat=i.RGBA,this._glInternalFormat=i.RGBA16F,this._glPixelType=i.HALF_FLOAT;break;case 13:this._glFormat=i.RGB,this._glInternalFormat=i.RGB32F,this._glPixelType=i.FLOAT;break;case ki:this._glFormat=i.RGBA,this._glInternalFormat=i.RGBA32F,this._glPixelType=i.FLOAT;break;case Oi:this._glFormat=i.RED,this._glInternalFormat=i.R32F,this._glPixelType=i.FLOAT;break;case Fi:this._glFormat=i.DEPTH_COMPONENT,this._glInternalFormat=i.DEPTH_COMPONENT32F,this._glPixelType=i.FLOAT;break;case Wi:this._glFormat=i.DEPTH_COMPONENT,this._glInternalFormat=i.DEPTH_COMPONENT16,this._glPixelType=i.UNSIGNED_SHORT;break;case Bi:this._glFormat=i.DEPTH_STENCIL,this._glInternalFormat=i.DEPTH24_STENCIL8,this._glPixelType=i.UNSIGNED_INT_24_8;break;case Ni:this._glFormat=i.RGB,this._glInternalFormat=i.R11F_G11F_B10F,this._glPixelType=i.UNSIGNED_INT_10F_11F_11F_REV;break;case 19:this._glFormat=i.RGB,this._glInternalFormat=i.SRGB8,this._glPixelType=i.UNSIGNED_BYTE;break;case zi:this._glFormat=i.RGBA,this._glInternalFormat=i.SRGB8_ALPHA8,this._glPixelType=i.UNSIGNED_BYTE;break;case 32:this._glFormat=i.RED_INTEGER,this._glInternalFormat=i.R8I,this._glPixelType=i.BYTE;break;case 33:this._glFormat=i.RED_INTEGER,this._glInternalFormat=i.R8UI,this._glPixelType=i.UNSIGNED_BYTE;break;case 34:this._glFormat=i.RED_INTEGER,this._glInternalFormat=i.R16I,this._glPixelType=i.SHORT;break;case 35:this._glFormat=i.RED_INTEGER,this._glInternalFormat=i.R16UI,this._glPixelType=i.UNSIGNED_SHORT;break;case 36:this._glFormat=i.RED_INTEGER,this._glInternalFormat=i.R32I,this._glPixelType=i.INT;break;case Hi:this._glFormat=i.RED_INTEGER,this._glInternalFormat=i.R32UI,this._glPixelType=i.UNSIGNED_INT;break;case 38:this._glFormat=i.RG_INTEGER,this._glInternalFormat=i.RG8I,this._glPixelType=i.BYTE;break;case 39:this._glFormat=i.RG_INTEGER,this._glInternalFormat=i.RG8UI,this._glPixelType=i.UNSIGNED_BYTE;break;case 40:this._glFormat=i.RG_INTEGER,this._glInternalFormat=i.RG16I,this._glPixelType=i.SHORT;break;case 41:this._glFormat=i.RG_INTEGER,this._glInternalFormat=i.RG16UI,this._glPixelType=i.UNSIGNED_SHORT;break;case 42:this._glFormat=i.RG_INTEGER,this._glInternalFormat=i.RG32I,this._glPixelType=i.INT;break;case 43:this._glFormat=i.RG_INTEGER,this._glInternalFormat=i.RG32UI,this._glPixelType=i.UNSIGNED_INT;break;case 44:this._glFormat=i.RGBA_INTEGER,this._glInternalFormat=i.RGBA8I,this._glPixelType=i.BYTE;break;case 45:this._glFormat=i.RGBA_INTEGER,this._glInternalFormat=i.RGBA8UI,this._glPixelType=i.UNSIGNED_BYTE;break;case 46:this._glFormat=i.RGBA_INTEGER,this._glInternalFormat=i.RGBA16I,this._glPixelType=i.SHORT;break;case 47:this._glFormat=i.RGBA_INTEGER,this._glInternalFormat=i.RGBA16UI,this._glPixelType=i.UNSIGNED_SHORT;break;case 48:this._glFormat=i.RGBA_INTEGER,this._glInternalFormat=i.RGBA32I,this._glPixelType=i.INT;break;case Gi:this._glFormat=i.RGBA_INTEGER,this._glInternalFormat=i.RGBA32UI,this._glPixelType=i.UNSIGNED_INT}this._glCreated=!1}upload(e,t){var i=e.gl;if(t._needsUpload||!(t._needsMipmapsUpload&&t._mipmapsUploaded||!t.pot)){var s,r,n=0,a=t.numLevels;for(t.array&&i.texStorage3D(i.TEXTURE_2D_ARRAY,a,this._glInternalFormat,t._width,t._height,t._arrayLength);t._levels[n]||0===n;)if(t._needsUpload||0!==n){if(n&&(!t._needsMipmapsUpload||!t._mipmaps))break;if(s=t._levels[n],r=1/Math.pow(2,n),1===n&&!t._compressed&&!t._integerFormat&&t._levels.length<a&&(i.generateMipmap(this._glTarget),t._mipmapsUploaded=!0),t._cubemap){var o=void 0;if(e._isBrowserInterface(s[0])){for(o=0;o<6;o++)if(t._levelsUpdated[0][o]){var l=s[o];e._isImageBrowserInterface(l)&&(l.width>e.maxCubeMapSize||l.height>e.maxCubeMapSize)&&(l=ho(l,e.maxCubeMapSize),0===n&&(t._width=l.width,t._height=l.height)),e.setUnpackFlipY(!1),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated?i.texSubImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+o,n,0,0,this._glFormat,this._glPixelType,l):i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+o,n,this._glInternalFormat,this._glFormat,this._glPixelType,l)}}else for(r=1/Math.pow(2,n),o=0;o<6;o++)if(t._levelsUpdated[0][o]){var h=s[o];t._compressed?this._glCreated&&h?i.compressedTexSubImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+o,n,0,0,Math.max(t._width*r,1),Math.max(t._height*r,1),this._glInternalFormat,h):i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+o,n,this._glInternalFormat,Math.max(t._width*r,1),Math.max(t._height*r,1),0,h):(e.setUnpackFlipY(!1),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated&&h?i.texSubImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+o,n,0,0,Math.max(t._width*r,1),Math.max(t._height*r,1),this._glFormat,this._glPixelType,h):i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+o,n,this._glInternalFormat,Math.max(t._width*r,1),Math.max(t._height*r,1),0,this._glFormat,this._glPixelType,h))}}else if(t._volume)t._compressed?i.compressedTexImage3D(i.TEXTURE_3D,n,this._glInternalFormat,Math.max(t._width*r,1),Math.max(t._height*r,1),Math.max(t._depth*r,1),0,s):(e.setUnpackFlipY(!1),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),i.texImage3D(i.TEXTURE_3D,n,this._glInternalFormat,Math.max(t._width*r,1),Math.max(t._height*r,1),Math.max(t._depth*r,1),0,this._glFormat,this._glPixelType,s));else if(t.array&&"object"==typeof s){if(t._arrayLength===s.length)if(t._compressed)for(var c=0;c<t._arrayLength;c++)i.compressedTexSubImage3D(i.TEXTURE_2D_ARRAY,n,0,0,c,Math.max(Math.floor(t._width*r),1),Math.max(Math.floor(t._height*r),1),1,this._glInternalFormat,s[c]);else for(var d=0;d<t._arrayLength;d++)i.texSubImage3D(i.TEXTURE_2D_ARRAY,n,0,0,d,Math.max(Math.floor(t._width*r),1),Math.max(Math.floor(t._height*r),1),1,this._glFormat,this._glPixelType,s[d])}else{if(e._isBrowserInterface(s)){e._isImageBrowserInterface(s)&&(s.width>e.maxTextureSize||s.height>e.maxTextureSize)&&(s=ho(s,e.maxTextureSize),0===n&&(t._width=s.width,t._height=s.height));var u=s.width||s.videoWidth,f=s.height||s.videoHeight;e.setUnpackFlipY(t._flipY),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated&&t._width===u&&t._height===f&&!e._isImageVideoInterface(s)?i.texSubImage2D(i.TEXTURE_2D,n,0,0,this._glFormat,this._glPixelType,s):(i.texImage2D(i.TEXTURE_2D,n,this._glInternalFormat,this._glFormat,this._glPixelType,s),0===n&&(t._width=u,t._height=f))}else r=1/Math.pow(2,n),t._compressed?this._glCreated&&s?i.compressedTexSubImage2D(i.TEXTURE_2D,n,0,0,Math.max(Math.floor(t._width*r),1),Math.max(Math.floor(t._height*r),1),this._glInternalFormat,s):i.compressedTexImage2D(i.TEXTURE_2D,n,this._glInternalFormat,Math.max(Math.floor(t._width*r),1),Math.max(Math.floor(t._height*r),1),0,s):(e.setUnpackFlipY(!1),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated&&s?i.texSubImage2D(i.TEXTURE_2D,n,0,0,Math.max(t._width*r,1),Math.max(t._height*r,1),this._glFormat,this._glPixelType,s):i.texImage2D(i.TEXTURE_2D,n,this._glInternalFormat,Math.max(t._width*r,1),Math.max(t._height*r,1),0,this._glFormat,this._glPixelType,s));t._mipmapsUploaded=0!==n}n++}else n++;if(t._needsUpload)if(t._cubemap)for(var p=0;p<6;p++)t._levelsUpdated[0][p]=!1;else t._levelsUpdated[0]=!1;!t._compressed&&!t._integerFormat&&t._mipmaps&&t._needsMipmapsUpload&&1===t._levels.length&&(i.generateMipmap(this._glTarget),t._mipmapsUploaded=!0),t._gpuSize&&t.adjustVramSizeTracking(e._vram,-t._gpuSize),t._gpuSize=t.gpuSize,t.adjustVramSizeTracking(e._vram,t._gpuSize),this._glCreated=!0}}read(e,t,i,s,r){var n=this.texture;return n.device.readTextureAsync(n,e,t,i,s,r)}constructor(e){this._glTexture=null,this.dirtyParameterFlags=0,this.texture=e}}class uo{destroy(e){this.msaaFB&&(e.deleteRenderbuffer(this.msaaFB),this.msaaFB=null),this.resolveFB&&(e.deleteRenderbuffer(this.resolveFB),this.resolveFB=null)}constructor(e,t){this.msaaFB=e,this.resolveFB=t}}class fo{destroy(e){var t,i=e.gl;this._isInitialized=!1,this._glFrameBuffer&&(this._glFrameBuffer!==this.suppliedColorFramebuffer&&i.deleteFramebuffer(this._glFrameBuffer),this._glFrameBuffer=null),this._glDepthBuffer&&(i.deleteRenderbuffer(this._glDepthBuffer),this._glDepthBuffer=null),this._glResolveFrameBuffer&&(this._glResolveFrameBuffer!==this.suppliedColorFramebuffer&&i.deleteFramebuffer(this._glResolveFrameBuffer),this._glResolveFrameBuffer=null),this._glMsaaColorBuffers.forEach((e=>{i.deleteRenderbuffer(e)})),this._glMsaaColorBuffers.length=0,null==(t=this.colorMrtFramebuffers)||t.forEach((e=>{e.destroy(i)})),this.colorMrtFramebuffers=null,this._glMsaaDepthBuffer&&(this._glMsaaDepthBuffer=null,this.msaaDepthBufferKey&&xn(e).release(this.msaaDepthBufferKey)),this.suppliedColorFramebuffer=void 0}get initialized(){return this._isInitialized}init(e,t){var i=e.gl;this._isInitialized=!0;var s=[];if(void 0!==this.suppliedColorFramebuffer)this._glFrameBuffer=this.suppliedColorFramebuffer;else{var r,n;this._glFrameBuffer=i.createFramebuffer(),e.setFramebuffer(this._glFrameBuffer);for(var a=null!=(n=null==(r=t._colorBuffers)?void 0:r.length)?n:0,o=i.COLOR_ATTACHMENT0,l=0;l<a;++l){var h=t.getColorBuffer(l);h&&(h.impl._glTexture||(h._width=Math.min(h.width,e.maxRenderBufferSize),h._height=Math.min(h.height,e.maxRenderBufferSize),e.setTexture(h,0)),i.framebufferTexture2D(i.FRAMEBUFFER,o+l,h._cubemap?i.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:i.TEXTURE_2D,h.impl._glTexture,t.mipLevel),s.push(o+l))}i.drawBuffers(s);var c=t._depthBuffer;if(c||t._depth){var d=t._stencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;if(c)c.impl._glTexture||(c._width=Math.min(c.width,e.maxRenderBufferSize),c._height=Math.min(c.height,e.maxRenderBufferSize),e.setTexture(c,0)),i.framebufferTexture2D(i.FRAMEBUFFER,d,c._cubemap?i.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:i.TEXTURE_2D,t._depthBuffer.impl._glTexture,t.mipLevel);else if(!(t._samples>1)){this._glDepthBuffer||(this._glDepthBuffer=i.createRenderbuffer());var u=t._stencil?i.DEPTH24_STENCIL8:i.DEPTH_COMPONENT32F;i.bindRenderbuffer(i.RENDERBUFFER,this._glDepthBuffer),i.renderbufferStorage(i.RENDERBUFFER,u,t.width,t.height),i.framebufferRenderbuffer(i.FRAMEBUFFER,d,i.RENDERBUFFER,this._glDepthBuffer),i.bindRenderbuffer(i.RENDERBUFFER,null)}}}if(t._samples>1){var f,p;this._glResolveFrameBuffer=this._glFrameBuffer,this._glFrameBuffer=i.createFramebuffer(),e.setFramebuffer(this._glFrameBuffer);var m=null!=(p=null==(f=t._colorBuffers)?void 0:f.length)?p:0;if(void 0!==this.suppliedColorFramebuffer){var g=i.createRenderbuffer();this._glMsaaColorBuffers.push(g);var v=7===e.backBufferFormat?i.RGBA8:i.RGB8;i.bindRenderbuffer(i.RENDERBUFFER,g),i.renderbufferStorageMultisample(i.RENDERBUFFER,t._samples,v,t.width,t.height),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.RENDERBUFFER,g)}else for(var _=0;_<m;++_){var b=t.getColorBuffer(_);if(b){var y=i.createRenderbuffer();this._glMsaaColorBuffers.push(y),i.bindRenderbuffer(i.RENDERBUFFER,y),i.renderbufferStorageMultisample(i.RENDERBUFFER,t._samples,b.impl._glInternalFormat,t.width,t.height),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+_,i.RENDERBUFFER,y)}}if(t._depth){var x,S=t._stencil?i.DEPTH24_STENCIL8:i.DEPTH_COMPONENT32F,w=t._stencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT,T=t._depthBuffer;T&&(x=T.id+":"+t.width+":"+t.height+":"+t._samples+":"+S+":"+w,this._glMsaaDepthBuffer=xn(e).get(x)),this._glMsaaDepthBuffer||(this._glMsaaDepthBuffer=i.createRenderbuffer(),i.bindRenderbuffer(i.RENDERBUFFER,this._glMsaaDepthBuffer),i.renderbufferStorageMultisample(i.RENDERBUFFER,t._samples,S,t.width,t.height),this._glMsaaDepthBuffer.destroy=function(){i.deleteRenderbuffer(this)},T&&xn(e).set(x,this._glMsaaDepthBuffer)),this.msaaDepthBufferKey=x,i.framebufferRenderbuffer(i.FRAMEBUFFER,w,i.RENDERBUFFER,this._glMsaaDepthBuffer)}m>1&&(this._createMsaaMrtFramebuffers(e,t,m),e.setFramebuffer(this._glFrameBuffer),i.drawBuffers(s))}}_createMsaaMrtFramebuffers(e,t,i){var s=e.gl;this.colorMrtFramebuffers=[];for(var r=0;r<i;++r){var n=t.getColorBuffer(r),a=s.createFramebuffer();e.setFramebuffer(a);var o=this._glMsaaColorBuffers[r];s.bindRenderbuffer(s.RENDERBUFFER,o),s.renderbufferStorageMultisample(s.RENDERBUFFER,t._samples,n.impl._glInternalFormat,t.width,t.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.RENDERBUFFER,o),s.drawBuffers([s.COLOR_ATTACHMENT0]);var l=s.createFramebuffer();e.setFramebuffer(l),s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,n._cubemap?s.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:s.TEXTURE_2D,n.impl._glTexture,0),this.colorMrtFramebuffers[r]=new uo(a,l)}}_checkFbo(e,t,i){var s=e.gl;s.checkFramebufferStatus(s.FRAMEBUFFER)}loseContext(){this._glFrameBuffer=null,this._glDepthBuffer=null,this._glResolveFrameBuffer=null,this._glMsaaColorBuffers.length=0,this._glMsaaDepthBuffer=null,this.msaaDepthBufferKey=void 0,this.colorMrtFramebuffers=null,this.suppliedColorFramebuffer=void 0,this._isInitialized=!1}internalResolve(e,t,i,s,r){e.setScissor(0,0,s.width,s.height);var n=e.gl;n.bindFramebuffer(n.READ_FRAMEBUFFER,t),n.bindFramebuffer(n.DRAW_FRAMEBUFFER,i),n.blitFramebuffer(0,0,s.width,s.height,0,0,s.width,s.height,r,n.NEAREST)}resolve(e,t,i,s){var r=e.gl;if(this.colorMrtFramebuffers){if(i)for(var n=0;n<this.colorMrtFramebuffers.length;n++){var a=this.colorMrtFramebuffers[n];this.internalResolve(e,a.msaaFB,a.resolveFB,t,r.COLOR_BUFFER_BIT)}s&&this.internalResolve(e,this._glFrameBuffer,this._glResolveFrameBuffer,t,r.DEPTH_BUFFER_BIT)}else this.internalResolve(e,this._glFrameBuffer,this._glResolveFrameBuffer,t,(i?r.COLOR_BUFFER_BIT:0)|(s?r.DEPTH_BUFFER_BIT:0));r.bindFramebuffer(r.FRAMEBUFFER,this._glFrameBuffer)}constructor(){this._glFrameBuffer=null,this._glDepthBuffer=null,this._glResolveFrameBuffer=null,this.colorMrtFramebuffers=null,this._glMsaaColorBuffers=[],this._glMsaaDepthBuffer=null,this._isInitialized=!1}}class po{destroy(e){this.queries.forEach((t=>e.deleteQuery(t))),this.queries=null}constructor(){this.queries=[]}}class mo extends ja{destroy(){this.freeQueries.forEach((e=>this.device.gl.deleteQuery(e))),this.frameQueries.forEach((e=>this.device.gl.deleteQuery(e))),this.previousFrameQueries.forEach((e=>e.destroy(this.device.gl))),this.freeQueries=null,this.frameQueries=null,this.previousFrameQueries=null}loseContext(){super.loseContext(),this.freeQueries=[],this.frameQueries=[],this.previousFrameQueries=[]}restoreContext(){this.ext=this.device.extDisjointTimerQuery}getQuery(){var e;return null!=(e=this.freeQueries.pop())?e:this.device.gl.createQuery()}start(e){if(this.ext){var t=this.getSlot(e),i=this.getQuery();return this.frameQueries[t]=i,this.device.gl.beginQuery(this.ext.TIME_ELAPSED_EXT,i),t}}end(e){void 0!==e&&this.device.gl.endQuery(this.ext.TIME_ELAPSED_EXT)}frameStart(){this.processEnableRequest(),this._enabled&&(this.frameGPUMarkerSlot=this.start("GpuFrame"))}frameEnd(){this._enabled&&this.end(this.frameGPUMarkerSlot)}request(){if(this._enabled){var e=this.ext,t=this.device.gl,i=this.device.renderVersion,s=this.frameQueries;if(s.length>0){this.frameQueries=[];var r=new po;r.queries=s,r.renderVersion=i,this.previousFrameQueries.push(r)}if(this.previousFrameQueries.length>0){var n=this.previousFrameQueries[0],a=n.queries,o=a[a.length-1],l=t.getQueryParameter(o,t.QUERY_RESULT_AVAILABLE),h=t.getParameter(e.GPU_DISJOINT_EXT);if(l&&!h){this.previousFrameQueries.shift();var c=this.timings;c.length=0;for(var d=0;d<a.length;d++){var u=a[d],f=t.getQueryParameter(u,t.QUERY_RESULT);c[d]=1e-6*f,this.freeQueries.push(u)}this.report(n.renderVersion,c)}h&&(this.previousFrameQueries.forEach((e=>{this.report(e.renderVersion,null),e.destroy(t)})),this.previousFrameQueries.length=0)}super.request(i)}}constructor(e){super(),this.freeQueries=[],this.frameQueries=[],this.previousFrameQueries=[],this.timings=[],this.device=e,this.ext=e.extDisjointTimerQuery}}function go(e,t,i,s,r,n,a){try{var o=e[n](a),l=o.value}catch(e){return void i(e)}o.done?t(l):Promise.resolve(l).then(s,r)}var vo=[];class _o extends Hr{postInit(){super.postInit(),this.gpuProfiler=new mo(this)}destroy(){super.destroy();var e=this.gl;this.feedback&&e.deleteTransformFeedback(this.feedback),this.clearVertexArrayObjectCache(),this.canvas.removeEventListener("webglcontextlost",this._contextLostHandler,!1),this.canvas.removeEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this._contextLostHandler=null,this._contextRestoredHandler=null,this.gl=null,super.postDestroy()}createBackbuffer(e){this.supportsStencil=this.initOptions.stencil,this.backBuffer=new Wr({name:"WebglFramebuffer",graphicsDevice:this,depth:this.initOptions.depth,stencil:this.supportsStencil,samples:this.samples}),this.backBuffer.impl.suppliedColorFramebuffer=e}updateBackbufferFormat(e){var t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,e);var i=this.gl.getParameter(this.gl.ALPHA_BITS);this.backBufferFormat=i?7:6}updateBackbuffer(){var e=this.canvas.width!==this.backBufferSize.x||this.canvas.height!==this.backBufferSize.y;(this._defaultFramebufferChanged||e)&&(this._defaultFramebufferChanged&&this.updateBackbufferFormat(this._defaultFramebuffer),this._defaultFramebufferChanged=!1,this.backBufferSize.set(this.canvas.width,this.canvas.height),this.backBuffer.destroy(),this.createBackbuffer(this._defaultFramebuffer))}createVertexBufferImpl(e,t){return new to}createIndexBufferImpl(e){return new io(e)}createShaderImpl(e){return new lo(e)}createTextureImpl(e){return new co(e)}createRenderTargetImpl(e){return new fo}getPrecision(){var e=this.gl,t="highp";if(e.getShaderPrecisionFormat){var i=e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT),s=e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT),r=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT),n=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT);if(i&&s&&r&&n){var a=i.precision>0&&r.precision>0,o=s.precision>0&&n.precision>0;a||(t=o?"mediump":"lowp")}}return t}getExtension(){for(var e=0;e<arguments.length;e++)if(-1!==this.supportedExtensions.indexOf(arguments[e]))return this.gl.getExtension(arguments[e]);return null}get extDisjointTimerQuery(){return this._extDisjointTimerQuery||(this._extDisjointTimerQuery=this.getExtension("EXT_disjoint_timer_query_webgl2","EXT_disjoint_timer_query")),this._extDisjointTimerQuery}initializeExtensions(){var e,t=this.gl;this.supportedExtensions=null!=(e=t.getSupportedExtensions())?e:[],this._extDisjointTimerQuery=null,this.textureRG11B10Renderable=!0,this.extColorBufferFloat=this.getExtension("EXT_color_buffer_float"),this.textureFloatRenderable=!!this.extColorBufferFloat,this.extColorBufferHalfFloat=this.getExtension("EXT_color_buffer_half_float"),this.textureHalfFloatRenderable=!!this.extColorBufferHalfFloat||!!this.extColorBufferFloat,this.extDebugRendererInfo=this.getExtension("WEBGL_debug_renderer_info"),this.extTextureFloatLinear=this.getExtension("OES_texture_float_linear"),this.textureFloatFilterable=!!this.extTextureFloatLinear,this.extFloatBlend=this.getExtension("EXT_float_blend"),this.extTextureFilterAnisotropic=this.getExtension("EXT_texture_filter_anisotropic","WEBKIT_EXT_texture_filter_anisotropic"),this.extParallelShaderCompile=this.getExtension("KHR_parallel_shader_compile"),this.extCompressedTextureETC1=this.getExtension("WEBGL_compressed_texture_etc1"),this.extCompressedTextureETC=this.getExtension("WEBGL_compressed_texture_etc"),this.extCompressedTexturePVRTC=this.getExtension("WEBGL_compressed_texture_pvrtc","WEBKIT_WEBGL_compressed_texture_pvrtc"),this.extCompressedTextureS3TC=this.getExtension("WEBGL_compressed_texture_s3tc","WEBKIT_WEBGL_compressed_texture_s3tc"),this.extCompressedTextureS3TC_SRGB=this.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this.extCompressedTextureATC=this.getExtension("WEBGL_compressed_texture_atc"),this.extCompressedTextureASTC=this.getExtension("WEBGL_compressed_texture_astc"),this.extTextureCompressionBPTC=this.getExtension("EXT_texture_compression_bptc")}initializeCapabilities(){var e,t=this.gl,i="undefined"!=typeof navigator?navigator.userAgent:"";this.maxPrecision=this.precision=this.getPrecision();var s,r,n=t.getContextAttributes();this.supportsMsaa=null!=(s=null==n?void 0:n.antialias)&&s,this.supportsStencil=null!=(r=null==n?void 0:n.stencil)&&r,this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.maxCubeMapSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this.maxRenderBufferSize=t.getParameter(t.MAX_RENDERBUFFER_SIZE),this.maxTextures=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this.maxCombinedTextures=t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this.maxVertexTextures=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this.vertexUniformsCount=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),this.fragmentUniformsCount=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),this.maxColorAttachments=t.getParameter(t.MAX_COLOR_ATTACHMENTS),this.maxVolumeSize=t.getParameter(t.MAX_3D_TEXTURE_SIZE),e=this.extDebugRendererInfo,this.unmaskedRenderer=e?t.getParameter(e.UNMASKED_RENDERER_WEBGL):"",this.unmaskedVendor=e?t.getParameter(e.UNMASKED_VENDOR_WEBGL):"";this.supportsGpuParticles=!("ARM"===this.unmaskedVendor&&i.match(/SM-[a-zA-Z0-9]+/)||this.unmaskedRenderer.match(/\bMali-G52+/)),e=this.extTextureFilterAnisotropic,this.maxAnisotropy=e?t.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1;var a=!this.forceDisableMultisampling;this.maxSamples=a?t.getParameter(t.MAX_SAMPLES):1,this.maxSamples=Math.min(this.maxSamples,4),this.samples=a&&this.backBufferAntialias?this.maxSamples:1,this.supportsAreaLights=!Ut.android,this.maxTextures<=8&&(this.supportsAreaLights=!1),this.initCapsDefines()}initializeRenderState(){super.initializeRenderState();var e=this.gl;e.disable(e.BLEND),e.blendFunc(e.ONE,e.ZERO),e.blendEquation(e.FUNC_ADD),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0),e.enable(e.CULL_FACE),this.cullFace=e.BACK,e.cullFace(e.BACK),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.depthMask(!0),this.stencil=!1,e.disable(e.STENCIL_TEST),this.stencilFuncFront=this.stencilFuncBack=7,this.stencilRefFront=this.stencilRefBack=0,this.stencilMaskFront=this.stencilMaskBack=255,e.stencilFunc(e.ALWAYS,0,255),this.stencilFailFront=this.stencilFailBack=0,this.stencilZfailFront=this.stencilZfailBack=0,this.stencilZpassFront=this.stencilZpassBack=0,this.stencilWriteMaskFront=255,this.stencilWriteMaskBack=255,e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.stencilMask(255),this.alphaToCoverage=!1,this.raster=!0,e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.RASTERIZER_DISCARD),this.depthBiasEnabled=!1,e.disable(e.POLYGON_OFFSET_FILL),this.clearDepth=1,e.clearDepth(1),this.clearColor=new ii(0,0,0,0),e.clearColor(0,0,0,0),this.clearStencil=0,e.clearStencil(0),e.hint(e.FRAGMENT_SHADER_DERIVATIVE_HINT,e.NICEST),e.enable(e.SCISSOR_TEST),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,e.NONE),this.unpackFlipY=!1,e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),this.unpackPremultiplyAlpha=!1,e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),e.pixelStorei(e.UNPACK_ALIGNMENT,1)}initTextureUnits(e){void 0===e&&(e=16),this.textureUnits=[];for(var t=0;t<e;t++)this.textureUnits.push([null,null,null])}initializeContextCaches(){super.initializeContextCaches(),this._vaoMap=new Map,this.boundVao=null,this.activeFramebuffer=null,this.feedback=null,this.transformFeedbackBuffer=null,this.textureUnit=0,this.initTextureUnits(this.maxCombinedTextures)}loseContext(){for(var e of(super.loseContext(),this.shaders))e.loseContext()}restoreContext(){for(var e of(this.initializeExtensions(),this.initializeCapabilities(),super.restoreContext(),this.shaders))e.restoreContext()}setViewport(e,t,i,s){this.vx===e&&this.vy===t&&this.vw===i&&this.vh===s||(this.gl.viewport(e,t,i,s),this.vx=e,this.vy=t,this.vw=i,this.vh=s)}setScissor(e,t,i,s){this.sx===e&&this.sy===t&&this.sw===i&&this.sh===s||(this.gl.scissor(e,t,i,s),this.sx=e,this.sy=t,this.sw=i,this.sh=s)}setFramebuffer(e){if(this.activeFramebuffer!==e){var t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,e),this.activeFramebuffer=e}}copyRenderTarget(e,t,i,s){var r,n,a=this.gl;if(e===this.backBuffer&&(e=null),i)if(t){if(e){if(!e._colorBuffer||!t._colorBuffer)return!1;if(e._colorBuffer._format!==t._colorBuffer._format)return!1}}else if(!e._colorBuffer)return!1;if(s&&e&&!e._depth){if(!e._depthBuffer||!t._depthBuffer)return!1;if(e._depthBuffer._format!==t._depthBuffer._format)return!1}var o=this.renderTarget;this.renderTarget=t,this.updateBegin();var l=e?e.impl._glFrameBuffer:null==(r=this.backBuffer)?void 0:r.impl._glFrameBuffer,h=t?t.impl._glFrameBuffer:null==(n=this.backBuffer)?void 0:n.impl._glFrameBuffer;a.bindFramebuffer(a.READ_FRAMEBUFFER,l),a.bindFramebuffer(a.DRAW_FRAMEBUFFER,h);var c=e?e.width:t?t.width:this.width,d=e?e.height:t?t.height:this.height;return a.blitFramebuffer(0,0,c,d,0,0,c,d,(i?a.COLOR_BUFFER_BIT:0)|(s?a.DEPTH_BUFFER_BIT:0),a.NEAREST),this.renderTarget=o,a.bindFramebuffer(a.FRAMEBUFFER,o?o.impl._glFrameBuffer:null),!0}frameStart(){super.frameStart(),this.updateBackbuffer(),this.gpuProfiler.frameStart()}frameEnd(){super.frameEnd(),this.gpuProfiler.frameEnd(),this.gpuProfiler.request()}startRenderPass(e){var t,i=null!=(t=e.renderTarget)?t:this.backBuffer;this.renderTarget=i,this.updateBegin();var{width:s,height:r}=i;this.setViewport(0,0,s,r),this.setScissor(0,0,s,r);var n=e.colorOps,a=e.depthStencilOps;if((null==n?void 0:n.clear)||a.clearDepth||a.clearStencil){var o=0,l={};(null==n?void 0:n.clear)&&(o|=1,l.color=[n.clearValue.r,n.clearValue.g,n.clearValue.b,n.clearValue.a]),a.clearDepth&&(o|=2,l.depth=a.clearDepthValue),a.clearStencil&&(o|=4,l.stencil=a.clearStencilValue),l.flags=o,this.clear(l)}this.insideRenderPass=!0}endRenderPass(e){this.unbindVertexArray();var t=this.renderTarget,i=e.colorArrayOps.length;if(t){var s;vo.length=0;for(var r=this.gl,n=0;n<i;n++){var a=e.colorArrayOps[n];a.store||a.resolve||vo.push(r.COLOR_ATTACHMENT0+n)}t!==this.backBuffer&&(e.depthStencilOps.storeDepth||vo.push(r.DEPTH_ATTACHMENT),e.depthStencilOps.storeStencil||vo.push(r.STENCIL_ATTACHMENT)),vo.length>0&&e.fullSizeClearRect&&r.invalidateFramebuffer(r.DRAW_FRAMEBUFFER,vo),i&&(null==(s=e.colorOps)?void 0:s.resolve)&&e.samples>1&&t.autoResolve&&t.resolve(!0,!1),t.depthBuffer&&e.depthStencilOps.resolveDepth&&e.samples>1&&t.autoResolve&&t.resolve(!1,!0);for(var o=0;o<i;o++){if(e.colorArrayOps[o].genMipmaps){var l=t._colorBuffers[o];l&&l.impl._glTexture&&l.mipmaps&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(l),this.gl.generateMipmap(l.impl._glTarget))}}}this.insideRenderPass=!1}set defaultFramebuffer(e){this._defaultFramebuffer!==e&&(this._defaultFramebuffer=e,this._defaultFramebufferChanged=!0)}get defaultFramebuffer(){return this._defaultFramebuffer}updateBegin(){if(this.boundVao=null,this._tempEnableSafariTextureUnitWorkaround)for(var e=0;e<this.textureUnits.length;++e)for(var t=0;t<3;++t)this.textureUnits[e][t]=null;var i,s=null!=(i=this.renderTarget)?i:this.backBuffer,r=s.impl;r.initialized||this.initRenderTarget(s),this.setFramebuffer(r._glFrameBuffer)}updateEnd(){this.unbindVertexArray();var e=this.renderTarget;if(e&&e!==this.backBuffer){e._samples>1&&e.autoResolve&&e.resolve();var t=e._colorBuffer;t&&t.impl._glTexture&&t.mipmaps&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(t),this.gl.generateMipmap(t.impl._glTarget))}}setUnpackFlipY(e){if(this.unpackFlipY!==e){this.unpackFlipY=e;var t=this.gl;t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,e)}}setUnpackPremultiplyAlpha(e){if(this.unpackPremultiplyAlpha!==e){this.unpackPremultiplyAlpha=e;var t=this.gl;t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e)}}activeTexture(e){this.textureUnit!==e&&(this.gl.activeTexture(this.gl.TEXTURE0+e),this.textureUnit=e)}bindTexture(e){var t=e.impl,i=t._glTarget,s=t._glTexture,r=this.textureUnit,n=this.targetToSlot[i];this.textureUnits[r][n]!==s&&(this.gl.bindTexture(i,s),this.textureUnits[r][n]=s)}bindTextureOnUnit(e,t){var i=e.impl,s=i._glTarget,r=i._glTexture,n=this.targetToSlot[s];this.textureUnits[t][n]!==r&&(this.activeTexture(t),this.gl.bindTexture(s,r),this.textureUnits[t][n]=r)}setTextureParameters(e){var t=this.gl,i=e.impl.dirtyParameterFlags,s=e.impl._glTarget;if(1&i){var r=e._minFilter;(!e._mipmaps||e._compressed&&1===e._levels.length)&&(2===r||3===r?r=0:4!==r&&5!==r||(r=1)),t.texParameteri(s,t.TEXTURE_MIN_FILTER,this.glFilter[r])}if(2&i&&t.texParameteri(s,t.TEXTURE_MAG_FILTER,this.glFilter[e._magFilter]),4&i&&t.texParameteri(s,t.TEXTURE_WRAP_S,this.glAddress[e._addressU]),8&i&&t.texParameteri(s,t.TEXTURE_WRAP_T,this.glAddress[e._addressV]),16&i&&t.texParameteri(s,t.TEXTURE_WRAP_R,this.glAddress[e._addressW]),32&i&&t.texParameteri(s,t.TEXTURE_COMPARE_MODE,e._compareOnRead?t.COMPARE_REF_TO_TEXTURE:t.NONE),64&i&&t.texParameteri(s,t.TEXTURE_COMPARE_FUNC,this.glComparison[e._compareFunc]),128&i){var n=this.extTextureFilterAnisotropic;n&&t.texParameterf(s,n.TEXTURE_MAX_ANISOTROPY_EXT,ti.clamp(Math.round(e._anisotropy),1,this.maxAnisotropy))}}setTexture(e,t){var i=e.impl;i._glTexture||i.initialize(this,e),i.dirtyParameterFlags>0||e._needsUpload||e._needsMipmapsUpload?(this.activeTexture(t),this.bindTexture(e),i.dirtyParameterFlags&&(this.setTextureParameters(e),i.dirtyParameterFlags=0),(e._needsUpload||e._needsMipmapsUpload)&&(i.upload(this,e),e._needsUpload=!1,e._needsMipmapsUpload=!1)):this.bindTextureOnUnit(e,t)}createVertexArray(e){var t,i,s=e.length>1;if(s){t="";for(var r=0;r<e.length;r++){var n=e[r];t+=n.id+n.format.renderingHash}i=this._vaoMap.get(t)}if(!i){var a=this.gl;i=a.createVertexArray(),a.bindVertexArray(i),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null);for(var o=0;o<e.length;o++){var l=e[o];a.bindBuffer(a.ARRAY_BUFFER,l.impl.bufferId);for(var h=l.format.elements,c=0;c<h.length;c++){var d=h[c],u=er[d.name];d.asInt?a.vertexAttribIPointer(u,d.numComponents,this.glType[d.dataType],d.stride,d.offset):a.vertexAttribPointer(u,d.numComponents,this.glType[d.dataType],d.normalize,d.stride,d.offset),a.enableVertexAttribArray(u),l.format.instancing&&a.vertexAttribDivisor(u,1)}}a.bindVertexArray(null),a.bindBuffer(a.ARRAY_BUFFER,null),s&&this._vaoMap.set(t,i)}return i}unbindVertexArray(){this.boundVao&&(this.boundVao=null,this.gl.bindVertexArray(null))}setBuffers(){var e,t=this.gl;if(1===this.vertexBuffers.length){var i=this.vertexBuffers[0];i.impl.vao||(i.impl.vao=this.createVertexArray(this.vertexBuffers)),e=i.impl.vao}else e=this.createVertexArray(this.vertexBuffers);this.boundVao!==e&&(this.boundVao=e,t.bindVertexArray(e)),this.clearVertexBuffer();var s=this.indexBuffer?this.indexBuffer.impl.bufferId:null;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,s)}draw(e,t,i){var s=this.gl;if(this.activateShader(this),this.shaderValid){var r,n,a,o,l,h,c,d,u=this.shader;if(u){var f=u.impl.samplers,p=u.impl.uniforms;i||this.setBuffers();for(var m=0,g=0,v=f.length;g<v;g++){if(!(n=(r=f[g]).scopeId.value)){var _=r.scopeId.name;"uSceneDepthMap"===_&&(n=gr(this,"white")),"uSceneColorMap"===_&&(n=gr(this,"pink")),n||(n=gr(this,"pink"))}if(n instanceof ur)a=n,this.setTexture(a,m),r.slot!==m&&(s.uniform1i(r.locationId,m),r.slot=m),m++;else{r.array.length=0,o=n.length;for(var b=0;b<o;b++)a=n[b],this.setTexture(a,m),r.array[b]=m,m++;s.uniform1iv(r.locationId,r.array)}}for(var y=0,x=p.length;y<x;y++)h=(l=p[y]).scopeId,c=l.version,d=h.versionObject.version,c.globalId===d.globalId&&c.revision===d.revision||(c.globalId=d.globalId,c.revision=d.revision,null!==h.value&&this.commitFunction[l.dataType](l,h.value));this.transformFeedbackBuffer&&(s.bindBufferBase(s.TRANSFORM_FEEDBACK_BUFFER,0,this.transformFeedbackBuffer.impl.bufferId),s.beginTransformFeedback(s.POINTS));var S=this.glPrimitive[e.type],w=e.count;if(e.indexed){var T=this.indexBuffer,C=T.impl.glFormat,E=e.base*T.bytesPerIndex;t>0?s.drawElementsInstanced(S,w,C,E,t):s.drawElements(S,w,C,E)}else{var A=e.base;t>0?s.drawArraysInstanced(S,A,w,t):s.drawArrays(S,A,w)}this.transformFeedbackBuffer&&(s.endTransformFeedback(),s.bindBufferBase(s.TRANSFORM_FEEDBACK_BUFFER,0,null)),this._drawCallsPerFrame++}}}clear(e){var t,i=this.defaultClearOptions,s=null!=(t=(e=e||i).flags)?t:i.flags;if(0!==s){var r=this.gl;if(1&s){var n,a=null!=(n=e.color)?n:i.color,o=a[0],l=a[1],h=a[2],c=a[3],d=this.clearColor;o===d.r&&l===d.g&&h===d.b&&c===d.a||(this.gl.clearColor(o,l,h,c),this.clearColor.set(o,l,h,c)),this.setBlendState(Sr.NOBLEND)}if(2&s){var u,f=null!=(u=e.depth)?u:i.depth;f!==this.clearDepth&&(this.gl.clearDepth(f),this.clearDepth=f),this.setDepthState(Cr.WRITEDEPTH)}if(4&s){var p,m=null!=(p=e.stencil)?p:i.stencil;m!==this.clearStencil&&(this.gl.clearStencil(m),this.clearStencil=m),r.stencilMask(255),this.stencilWriteMaskFront=255,this.stencilWriteMaskBack=255}r.clear(this.glClearFlag[s])}}submit(){this.gl.flush()}readPixels(e,t,i,s,r){var n=this.gl;n.readPixels(e,t,i,s,n.RGBA,n.UNSIGNED_BYTE,r)}readPixelsAsync(e,t,i,s,r){var n,a=this;return(n=function*(){var n,o,l,h,c,d,u=a.gl,f=null==(n=a.renderTarget.colorBuffer)?void 0:n.impl,p=null!=(o=null==f?void 0:f._glFormat)?o:u.RGBA,m=null!=(l=null==f?void 0:f._glPixelType)?l:u.UNSIGNED_BYTE,g=u.createBuffer();return u.bindBuffer(u.PIXEL_PACK_BUFFER,g),u.bufferData(u.PIXEL_PACK_BUFFER,r.byteLength,u.STREAM_READ),u.readPixels(e,t,i,s,p,m,0),u.bindBuffer(u.PIXEL_PACK_BUFFER,null),yield(h=0,c=20,d=u.fenceSync(u.SYNC_GPU_COMMANDS_COMPLETE,0),a.submit(),new Promise(((e,t)=>{!function i(){var s=u.clientWaitSync(d,h,0);s===u.WAIT_FAILED?(u.deleteSync(d),t(new Error("webgl clientWaitSync sync failed"))):s===u.TIMEOUT_EXPIRED?setTimeout(i,c):(u.deleteSync(d),e())}()}))),u.bindBuffer(u.PIXEL_PACK_BUFFER,g),u.getBufferSubData(u.PIXEL_PACK_BUFFER,0,r),u.bindBuffer(u.PIXEL_PACK_BUFFER,null),u.deleteBuffer(g),r},function(){var e=this,t=arguments;return new Promise((function(i,s){var r=n.apply(e,t);function a(e){go(r,i,s,a,o,"next",e)}function o(e){go(r,i,s,a,o,"throw",e)}a(void 0)}))})()}readTextureAsync(e,t,i,s,r,n){var a,o,l,h=null!=(a=n.face)?a:0,c=null!=(o=n.renderTarget)?o:new Wr({colorBuffer:e,depth:!1,face:h}),d=new ArrayBuffer(cr.calcLevelGpuSize(s,r,1,e._format)),u=null!=(l=n.data)?l:new(Qi(e._format))(d);return this.setRenderTarget(c),this.initRenderTarget(c),new Promise(((e,a)=>{this.readPixelsAsync(t,i,s,r,u).then((t=>{n.renderTarget||c.destroy(),e(t)})).catch(a)}))}setAlphaToCoverage(e){this.alphaToCoverage!==e&&(this.alphaToCoverage=e,e?this.gl.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE):this.gl.disable(this.gl.SAMPLE_ALPHA_TO_COVERAGE))}setTransformFeedbackBuffer(e){if(this.transformFeedbackBuffer!==e){this.transformFeedbackBuffer=e;var t=this.gl;e?(this.feedback||(this.feedback=t.createTransformFeedback()),t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,this.feedback)):t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,null)}}setRaster(e){this.raster!==e&&(this.raster=e,e?this.gl.disable(this.gl.RASTERIZER_DISCARD):this.gl.enable(this.gl.RASTERIZER_DISCARD))}setStencilTest(e){if(this.stencil!==e){var t=this.gl;e?t.enable(t.STENCIL_TEST):t.disable(t.STENCIL_TEST),this.stencil=e}}setStencilFunc(e,t,i){this.stencilFuncFront===e&&this.stencilRefFront===t&&this.stencilMaskFront===i&&this.stencilFuncBack===e&&this.stencilRefBack===t&&this.stencilMaskBack===i||(this.gl.stencilFunc(this.glComparison[e],t,i),this.stencilFuncFront=this.stencilFuncBack=e,this.stencilRefFront=this.stencilRefBack=t,this.stencilMaskFront=this.stencilMaskBack=i)}setStencilFuncFront(e,t,i){if(this.stencilFuncFront!==e||this.stencilRefFront!==t||this.stencilMaskFront!==i){var s=this.gl;s.stencilFuncSeparate(s.FRONT,this.glComparison[e],t,i),this.stencilFuncFront=e,this.stencilRefFront=t,this.stencilMaskFront=i}}setStencilFuncBack(e,t,i){if(this.stencilFuncBack!==e||this.stencilRefBack!==t||this.stencilMaskBack!==i){var s=this.gl;s.stencilFuncSeparate(s.BACK,this.glComparison[e],t,i),this.stencilFuncBack=e,this.stencilRefBack=t,this.stencilMaskBack=i}}setStencilOperation(e,t,i,s){this.stencilFailFront===e&&this.stencilZfailFront===t&&this.stencilZpassFront===i&&this.stencilFailBack===e&&this.stencilZfailBack===t&&this.stencilZpassBack===i||(this.gl.stencilOp(this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[i]),this.stencilFailFront=this.stencilFailBack=e,this.stencilZfailFront=this.stencilZfailBack=t,this.stencilZpassFront=this.stencilZpassBack=i),this.stencilWriteMaskFront===s&&this.stencilWriteMaskBack===s||(this.gl.stencilMask(s),this.stencilWriteMaskFront=s,this.stencilWriteMaskBack=s)}setStencilOperationFront(e,t,i,s){this.stencilFailFront===e&&this.stencilZfailFront===t&&this.stencilZpassFront===i||(this.gl.stencilOpSeparate(this.gl.FRONT,this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[i]),this.stencilFailFront=e,this.stencilZfailFront=t,this.stencilZpassFront=i),this.stencilWriteMaskFront!==s&&(this.gl.stencilMaskSeparate(this.gl.FRONT,s),this.stencilWriteMaskFront=s)}setStencilOperationBack(e,t,i,s){this.stencilFailBack===e&&this.stencilZfailBack===t&&this.stencilZpassBack===i||(this.gl.stencilOpSeparate(this.gl.BACK,this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[i]),this.stencilFailBack=e,this.stencilZfailBack=t,this.stencilZpassBack=i),this.stencilWriteMaskBack!==s&&(this.gl.stencilMaskSeparate(this.gl.BACK,s),this.stencilWriteMaskBack=s)}setBlendState(e){var t=this.blendState;if(!t.equals(e)){var i=this.gl,{blend:s,colorOp:r,alphaOp:n,colorSrcFactor:a,colorDstFactor:o,alphaSrcFactor:l,alphaDstFactor:h}=e;if(t.blend!==s&&(s?i.enable(i.BLEND):i.disable(i.BLEND)),t.colorOp!==r||t.alphaOp!==n){var c=this.glBlendEquation;i.blendEquationSeparate(c[r],c[n])}t.colorSrcFactor===a&&t.colorDstFactor===o&&t.alphaSrcFactor===l&&t.alphaDstFactor===h||i.blendFuncSeparate(this.glBlendFunctionColor[a],this.glBlendFunctionColor[o],this.glBlendFunctionAlpha[l],this.glBlendFunctionAlpha[h]),t.allWrite!==e.allWrite&&this.gl.colorMask(e.redWrite,e.greenWrite,e.blueWrite,e.alphaWrite),t.copy(e)}}setBlendColor(e,t,i,s){var r=this.blendColor;e===r.r&&t===r.g&&i===r.b&&s===r.a||(this.gl.blendColor(e,t,i,s),r.set(e,t,i,s))}setStencilState(e,t){e||t?(this.setStencilTest(!0),e===t?(this.setStencilFunc(e.func,e.ref,e.readMask),this.setStencilOperation(e.fail,e.zfail,e.zpass,e.writeMask)):(null!=e||(e=Ur.DEFAULT),this.setStencilFuncFront(e.func,e.ref,e.readMask),this.setStencilOperationFront(e.fail,e.zfail,e.zpass,e.writeMask),null!=t||(t=Ur.DEFAULT),this.setStencilFuncBack(t.func,t.ref,t.readMask),this.setStencilOperationBack(t.fail,t.zfail,t.zpass,t.writeMask))):this.setStencilTest(!1)}setDepthState(e){var t=this.depthState;if(!t.equals(e)){var i=this.gl,s=e.write;t.write!==s&&i.depthMask(s);var{func:r,test:n}=e;!n&&s&&(n=!0,r=7),t.func!==r&&i.depthFunc(this.glComparison[r]),t.test!==n&&(n?i.enable(i.DEPTH_TEST):i.disable(i.DEPTH_TEST));var{depthBias:a,depthBiasSlope:o}=e;a||o?(this.depthBiasEnabled||(this.depthBiasEnabled=!0,this.gl.enable(this.gl.POLYGON_OFFSET_FILL)),i.polygonOffset(o,a)):this.depthBiasEnabled&&(this.depthBiasEnabled=!1,this.gl.disable(this.gl.POLYGON_OFFSET_FILL)),t.copy(e)}}setCullMode(e){if(this.cullMode!==e){if(0===e)this.gl.disable(this.gl.CULL_FACE);else{0===this.cullMode&&this.gl.enable(this.gl.CULL_FACE);var t=this.glCull[e];this.cullFace!==t&&(this.gl.cullFace(t),this.cullFace=t)}this.cullMode=e}}setShader(e,t){void 0===t&&(t=!1),e!==this.shader&&(this.shader=e,this.shaderAsyncCompile=t,this.shaderValid=void 0)}activateShader(e){var{shader:t}=this,{impl:i}=t;void 0===this.shaderValid&&(t.failed?this.shaderValid=!1:t.ready||(this.shaderAsyncCompile?i.isLinked(e)?i.finalize(this,t)||(t.failed=!0,this.shaderValid=!1):this.shaderValid=!1:i.finalize(this,t)||(t.failed=!0,this.shaderValid=!1))),void 0===this.shaderValid&&(this.gl.useProgram(i.glProgram),this.shaderValid=!0)}clearVertexArrayObjectCache(){var e=this.gl;this._vaoMap.forEach(((t,i,s)=>{e.deleteVertexArray(t)})),this._vaoMap.clear()}set fullscreen(e){e?this.gl.canvas.requestFullscreen():document.exitFullscreen()}get fullscreen(){return!!document.fullscreenElement}constructor(e,t={}){super(e,t),this._defaultFramebuffer=null,this._defaultFramebufferChanged=!1,t=this.initOptions,this.updateClientRect(),this.initTextureUnits(),this.contextLost=!1,this._contextLostHandler=e=>{e.preventDefault(),this.loseContext(),this.fire("devicelost")},this._contextRestoredHandler=()=>{this.restoreContext(),this.fire("devicerestored")};var i,s,r="undefined"!=typeof navigator&&navigator.userAgent;if(this.forceDisableMultisampling=r&&r.includes("AppleWebKit")&&(r.includes("15.4")||r.includes("15_4")),this.forceDisableMultisampling&&(t.antialias=!1),"firefox"===Ut.browserName){var n=("undefined"!=typeof navigator?navigator.userAgent:"").match(/Firefox\/(\d+(\.\d+)*)/),a=n?n[1]:null;if(a){var o=parseFloat(a);("windows"===Ut.name&&(o>=120||115===o)||"android"===Ut.name&&o>=132)&&(t.antialias=!1)}}this.backBufferAntialias=null!=(i=t.antialias)&&i,t.antialias=!1;var l=null!=(s=t.gl)?s:e.getContext("webgl2",t);if(!l)throw new Error("WebGL not supported");this.gl=l,this.isWebGL2=!0,this._deviceType=Gs,this.updateBackbufferFormat(null);var h,c,d,u,f,p="chrome"===Ut.browserName,m="safari"===Ut.browserName,g=Ut.browser&&-1!==navigator.appVersion.indexOf("Mac");this._tempEnableSafariTextureUnitWorkaround=m,this._tempMacChromeBlitFramebufferWorkaround=g&&p&&!t.alpha,e.addEventListener("webglcontextlost",this._contextLostHandler,!1),e.addEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),this.initializeContextCaches(),this.createBackbuffer(null),this.supportsImageBitmap=!m&&"undefined"!=typeof ImageBitmap,this._samplerTypes=new Set([l.SAMPLER_2D,l.SAMPLER_CUBE,l.UNSIGNED_INT_SAMPLER_2D,l.INT_SAMPLER_2D,l.SAMPLER_2D_SHADOW,l.SAMPLER_CUBE_SHADOW,l.SAMPLER_3D,l.INT_SAMPLER_3D,l.UNSIGNED_INT_SAMPLER_3D,l.SAMPLER_2D_ARRAY,l.INT_SAMPLER_2D_ARRAY,l.UNSIGNED_INT_SAMPLER_2D_ARRAY]),this.glAddress=[l.REPEAT,l.CLAMP_TO_EDGE,l.MIRRORED_REPEAT],this.glBlendEquation=[l.FUNC_ADD,l.FUNC_SUBTRACT,l.FUNC_REVERSE_SUBTRACT,l.MIN,l.MAX],this.glBlendFunctionColor=[l.ZERO,l.ONE,l.SRC_COLOR,l.ONE_MINUS_SRC_COLOR,l.DST_COLOR,l.ONE_MINUS_DST_COLOR,l.SRC_ALPHA,l.SRC_ALPHA_SATURATE,l.ONE_MINUS_SRC_ALPHA,l.DST_ALPHA,l.ONE_MINUS_DST_ALPHA,l.CONSTANT_COLOR,l.ONE_MINUS_CONSTANT_COLOR],this.glBlendFunctionAlpha=[l.ZERO,l.ONE,l.SRC_COLOR,l.ONE_MINUS_SRC_COLOR,l.DST_COLOR,l.ONE_MINUS_DST_COLOR,l.SRC_ALPHA,l.SRC_ALPHA_SATURATE,l.ONE_MINUS_SRC_ALPHA,l.DST_ALPHA,l.ONE_MINUS_DST_ALPHA,l.CONSTANT_ALPHA,l.ONE_MINUS_CONSTANT_ALPHA],this.glComparison=[l.NEVER,l.LESS,l.EQUAL,l.LEQUAL,l.GREATER,l.NOTEQUAL,l.GEQUAL,l.ALWAYS],this.glStencilOp=[l.KEEP,l.ZERO,l.REPLACE,l.INCR,l.INCR_WRAP,l.DECR,l.DECR_WRAP,l.INVERT],this.glClearFlag=[0,l.COLOR_BUFFER_BIT,l.DEPTH_BUFFER_BIT,l.COLOR_BUFFER_BIT|l.DEPTH_BUFFER_BIT,l.STENCIL_BUFFER_BIT,l.STENCIL_BUFFER_BIT|l.COLOR_BUFFER_BIT,l.STENCIL_BUFFER_BIT|l.DEPTH_BUFFER_BIT,l.STENCIL_BUFFER_BIT|l.COLOR_BUFFER_BIT|l.DEPTH_BUFFER_BIT],this.glCull=[0,l.BACK,l.FRONT,l.FRONT_AND_BACK],this.glFilter=[l.NEAREST,l.LINEAR,l.NEAREST_MIPMAP_NEAREST,l.NEAREST_MIPMAP_LINEAR,l.LINEAR_MIPMAP_NEAREST,l.LINEAR_MIPMAP_LINEAR],this.glPrimitive=[l.POINTS,l.LINES,l.LINE_LOOP,l.LINE_STRIP,l.TRIANGLES,l.TRIANGLE_STRIP,l.TRIANGLE_FAN],this.glType=[l.BYTE,l.UNSIGNED_BYTE,l.SHORT,l.UNSIGNED_SHORT,l.INT,l.UNSIGNED_INT,l.FLOAT,l.HALF_FLOAT],this.pcUniformType={},this.pcUniformType[l.BOOL]=0,this.pcUniformType[l.INT]=1,this.pcUniformType[l.FLOAT]=2,this.pcUniformType[l.FLOAT_VEC2]=3,this.pcUniformType[l.FLOAT_VEC3]=4,this.pcUniformType[l.FLOAT_VEC4]=5,this.pcUniformType[l.INT_VEC2]=6,this.pcUniformType[l.INT_VEC3]=7,this.pcUniformType[l.INT_VEC4]=8,this.pcUniformType[l.BOOL_VEC2]=9,this.pcUniformType[l.BOOL_VEC3]=10,this.pcUniformType[l.BOOL_VEC4]=11,this.pcUniformType[l.FLOAT_MAT2]=12,this.pcUniformType[l.FLOAT_MAT3]=13,this.pcUniformType[l.FLOAT_MAT4]=Is,this.pcUniformType[l.SAMPLER_2D]=15,this.pcUniformType[l.SAMPLER_CUBE]=16,this.pcUniformType[l.UNSIGNED_INT]=Rs,this.pcUniformType[l.UNSIGNED_INT_VEC2]=ks,this.pcUniformType[l.UNSIGNED_INT_VEC3]=Os,this.pcUniformType[l.UNSIGNED_INT_VEC4]=Fs,this.pcUniformType[l.SAMPLER_2D_SHADOW]=18,this.pcUniformType[l.SAMPLER_CUBE_SHADOW]=19,this.pcUniformType[l.SAMPLER_2D_ARRAY]=25,this.pcUniformType[l.SAMPLER_3D]=20,this.pcUniformType[l.INT_SAMPLER_2D]=42,this.pcUniformType[l.UNSIGNED_INT_SAMPLER_2D]=43,this.pcUniformType[l.INT_SAMPLER_CUBE]=44,this.pcUniformType[l.UNSIGNED_INT_SAMPLER_2D]=45,this.pcUniformType[l.INT_SAMPLER_3D]=46,this.pcUniformType[l.UNSIGNED_INT_SAMPLER_3D]=47,this.pcUniformType[l.INT_SAMPLER_2D_ARRAY]=48,this.pcUniformType[l.UNSIGNED_INT_SAMPLER_2D_ARRAY]=49,this.targetToSlot={},this.targetToSlot[l.TEXTURE_2D]=0,this.targetToSlot[l.TEXTURE_CUBE_MAP]=1,this.targetToSlot[l.TEXTURE_3D]=2,this.commitFunction=[],this.commitFunction[0]=function(e,t){e.value!==t&&(l.uniform1i(e.locationId,t),e.value=t)},this.commitFunction[1]=this.commitFunction[0],this.commitFunction[2]=function(e,t){e.value!==t&&(l.uniform1f(e.locationId,t),e.value=t)},this.commitFunction[3]=function(e,t){f=e.value,h=t[0],c=t[1],f[0]===h&&f[1]===c||(l.uniform2fv(e.locationId,t),f[0]=h,f[1]=c)},this.commitFunction[4]=function(e,t){f=e.value,h=t[0],c=t[1],d=t[2],f[0]===h&&f[1]===c&&f[2]===d||(l.uniform3fv(e.locationId,t),f[0]=h,f[1]=c,f[2]=d)},this.commitFunction[5]=function(e,t){f=e.value,h=t[0],c=t[1],d=t[2],u=t[3],f[0]===h&&f[1]===c&&f[2]===d&&f[3]===u||(l.uniform4fv(e.locationId,t),f[0]=h,f[1]=c,f[2]=d,f[3]=u)},this.commitFunction[6]=function(e,t){f=e.value,h=t[0],c=t[1],f[0]===h&&f[1]===c||(l.uniform2iv(e.locationId,t),f[0]=h,f[1]=c)},this.commitFunction[9]=this.commitFunction[6],this.commitFunction[7]=function(e,t){f=e.value,h=t[0],c=t[1],d=t[2],f[0]===h&&f[1]===c&&f[2]===d||(l.uniform3iv(e.locationId,t),f[0]=h,f[1]=c,f[2]=d)},this.commitFunction[10]=this.commitFunction[7],this.commitFunction[8]=function(e,t){f=e.value,h=t[0],c=t[1],d=t[2],u=t[3],f[0]===h&&f[1]===c&&f[2]===d&&f[3]===u||(l.uniform4iv(e.locationId,t),f[0]=h,f[1]=c,f[2]=d,f[3]=u)},this.commitFunction[11]=this.commitFunction[8],this.commitFunction[12]=function(e,t){l.uniformMatrix2fv(e.locationId,!1,t)},this.commitFunction[13]=function(e,t){l.uniformMatrix3fv(e.locationId,!1,t)},this.commitFunction[14]=function(e,t){l.uniformMatrix4fv(e.locationId,!1,t)},this.commitFunction[17]=function(e,t){l.uniform1fv(e.locationId,t)},this.commitFunction[21]=function(e,t){l.uniform2fv(e.locationId,t)},this.commitFunction[22]=function(e,t){l.uniform3fv(e.locationId,t)},this.commitFunction[23]=function(e,t){l.uniform4fv(e.locationId,t)},this.commitFunction[26]=function(e,t){e.value!==t&&(l.uniform1ui(e.locationId,t),e.value=t)},this.commitFunction[27]=function(e,t){f=e.value,h=t[0],c=t[1],f[0]===h&&f[1]===c||(l.uniform2uiv(e.locationId,t),f[0]=h,f[1]=c)},this.commitFunction[28]=function(e,t){f=e.value,h=t[0],c=t[1],d=t[2],f[0]===h&&f[1]===c&&f[2]===d||(l.uniform3uiv(e.locationId,t),f[0]=h,f[1]=c,f[2]=d)},this.commitFunction[29]=function(e,t){f=e.value,h=t[0],c=t[1],d=t[2],u=t[3],f[0]===h&&f[1]===c&&f[2]===d&&f[3]===u||(l.uniform4uiv(e.locationId,t),f[0]=h,f[1]=c,f[2]=d,f[3]=u)},this.commitFunction[30]=function(e,t){l.uniform1iv(e.locationId,t)},this.commitFunction[31]=function(e,t){l.uniform1uiv(e.locationId,t)},this.commitFunction[32]=this.commitFunction[30],this.commitFunction[33]=function(e,t){l.uniform2iv(e.locationId,t)},this.commitFunction[34]=function(e,t){l.uniform2uiv(e.locationId,t)},this.commitFunction[35]=this.commitFunction[33],this.commitFunction[36]=function(e,t){l.uniform3iv(e.locationId,t)},this.commitFunction[37]=function(e,t){l.uniform3uiv(e.locationId,t)},this.commitFunction[38]=this.commitFunction[36],this.commitFunction[39]=function(e,t){l.uniform4iv(e.locationId,t)},this.commitFunction[40]=function(e,t){l.uniform4uiv(e.locationId,t)},this.commitFunction[41]=this.commitFunction[39],this.commitFunction[24]=function(e,t){l.uniformMatrix4fv(e.locationId,!1,t)},this.constantTexSource=this.scope.resolve("source"),this.postInit()}}class bo{unlock(e){}}class yo{destroy(e){}init(e,t){}loseContext(){}resolve(e,t,i,s){}}class xo{destroy(e){}loseContext(){}restoreContext(e,t){}}class So{destroy(e){}propertyChanged(e){}loseContext(){}}class wo{destroy(e){}unlock(e){}}class To extends Hr{destroy(){super.destroy()}initDeviceCaps(){this.disableParticleSystem=!0,this.precision="highp",this.maxPrecision="highp",this.maxSamples=4,this.maxTextures=16,this.maxTextureSize=4096,this.maxCubeMapSize=4096,this.maxVolumeSize=4096,this.maxColorAttachments=8,this.maxPixelRatio=1,this.maxAnisotropy=16,this.supportsUniformBuffers=!1,this.supportsAreaLights=!0,this.supportsGpuParticles=!1,this.textureFloatRenderable=!0,this.textureHalfFloatRenderable=!0,this.supportsImageBitmap=!1}postInit(){super.postInit()}frameStart(){super.frameStart()}frameEnd(){super.frameEnd()}updateBegin(){}updateEnd(){}readPixels(e,t,i,s,r){}createVertexBufferImpl(e,t){return new wo(e,t)}createIndexBufferImpl(e){return new bo(e)}createShaderImpl(e){return new xo(e)}createTextureImpl(e){return new So(e)}createRenderTargetImpl(e){return new yo(e)}draw(e,t,i){}setShader(e,t){}setBlendState(e){}setDepthState(e){}setStencilState(e,t){}setBlendColor(e,t,i,s){}setCullMode(e){}setAlphaToCoverage(e){}initializeContextCaches(){super.initializeContextCaches()}clear(e){}setViewport(e,t,i,s){}setScissor(e,t,i,s){}copyRenderTarget(e,t,i,s){return!0}constructor(e,t={}){super(e,t),t=this.initOptions,this.isNull=!0,this._deviceType=js,this.samples=1,this.backBuffer=new Wr({name:"Framebuffer",graphicsDevice:this,depth:this.initOptions.depth,stencil:this.supportsStencil,samples:this.samples}),this.initDeviceCaps()}}var Co=0;class Eo{destroy(){var e=this.device,t=e.buffers.indexOf(this);-1!==t&&e.buffers.splice(t,1),this.device.indexBuffer===this&&(this.device.indexBuffer=null),this.impl.initialized&&(this.impl.destroy(e),this.adjustVramSizeTracking(e._vram,-this.storage.byteLength))}adjustVramSizeTracking(e,t){e.ib+=t}loseContext(){this.impl.loseContext()}getFormat(){return this.format}getNumIndices(){return this.numIndices}lock(){return this.storage}unlock(){this.impl.unlock(this)}setData(e){return e.byteLength===this.numBytes&&(this.storage=e,this.unlock(),!0)}_lockTypedArray(){var e=this.lock();return 2===this.format?new Uint32Array(e):1===this.format?new Uint16Array(e):new Uint8Array(e)}writeData(e,t){var i=this._lockTypedArray();if(e.length>t)if(ArrayBuffer.isView(e))e=e.subarray(0,t),i.set(e);else for(var s=0;s<t;s++)i[s]=e[s];else i.set(e);this.unlock()}readData(e){var t=this._lockTypedArray(),i=this.numIndices;if(ArrayBuffer.isView(e))e.set(t);else{e.length=0;for(var s=0;s<i;s++)e[s]=t[s]}return i}constructor(e,t,i,s=0,r,n){this.device=e,this.format=t,this.numIndices=i,this.usage=s,this.id=Co++,this.impl=e.createIndexBufferImpl(this,n);var a=Zs[t];this.bytesPerIndex=a,this.numBytes=this.numIndices*a,r?this.setData(r):this.storage=new ArrayBuffer(this.numBytes),this.adjustVramSizeTracking(e._vram,this.numBytes),this.device.buffers.push(this)}}class Ao{constructor(){this.clearValue=new ii(0,0,0,1),this.clearValueLinear=new ii(0,0,0,1),this.clear=!1,this.store=!1,this.resolve=!0,this.genMipmaps=!1}}class Po{constructor(){this.clearDepthValue=1,this.clearStencilValue=0,this.clearDepth=!1,this.clearStencil=!1,this.storeDepth=!1,this.resolveDepth=!1,this.storeStencil=!1}}class Do{get colorOps(){return this.colorArrayOps[0]}set name(e){this._name=e}get name(){return this._name||(this._name=this.constructor.name),this._name}set scaleX(e){this._options.scaleX=e}get scaleX(){return this._options.scaleX}set scaleY(e){this._options.scaleY=e}get scaleY(){return this._options.scaleY}set options(e){var t,i;(this._options=e,e)&&(this.scaleX=null!=(t=this.scaleX)?t:1,this.scaleY=null!=(i=this.scaleY)?i:1)}get options(){return this._options}init(e,t){void 0===e&&(e=null),this.options=t,this.renderTarget=e,this.samples=Math.max(this.renderTarget?this.renderTarget.samples:this.device.samples,1),this.allocateAttachments(),this.postInit()}allocateAttachments(){var e,t,i=this.renderTarget;this.depthStencilOps=new Po,(null==i?void 0:i.depthBuffer)&&(this.depthStencilOps.storeDepth=!0);var s=i?null!=(t=null==(e=i._colorBuffers)?void 0:e.length)?t:0:1;this.colorArrayOps.length=0;for(var r=0;r<s;r++){var n,a,o,l=new Ao;this.colorArrayOps[r]=l,1===this.samples&&(l.store=!0,l.resolve=!1);var h=null==(a=this.renderTarget)||null==(n=a._colorBuffers)?void 0:n[r];if((null==(o=this.renderTarget)?void 0:o.mipmaps)&&(null==h?void 0:h.mipmaps)){var c=Ki(h._format);l.genMipmaps=!c}}}destroy(){}postInit(){}frameUpdate(){if(this._options&&this.renderTarget){var e,t=null!=(e=this._options.resizeSource)?e:this.device.backBuffer,i=Math.floor(t.width*this.scaleX),s=Math.floor(t.height*this.scaleY);this.renderTarget.resize(i,s)}}before(){}execute(){}after(){}onEnable(){}onDisable(){}set enabled(e){this._enabled!==e&&(this._enabled=e,e?this.onEnable():this.onDisable())}get enabled(){return this._enabled}setClearColor(e){for(var t=this.colorArrayOps.length,i=0;i<t;i++){var s=this.colorArrayOps[i];e&&(s.clearValue.copy(e),s.clearValueLinear.linear(e)),s.clear=!!e}}setClearDepth(e){e&&(this.depthStencilOps.clearDepthValue=e),this.depthStencilOps.clearDepth=void 0!==e}setClearStencil(e){e&&(this.depthStencilOps.clearStencilValue=e),this.depthStencilOps.clearStencil=void 0!==e}render(){if(this.enabled){var e=this.device,t=void 0!==this.renderTarget;this.before(),this.executeEnabled&&(t&&!this._skipStart&&e.startRenderPass(this),this.execute(),t&&!this._skipEnd&&e.endRenderPass(this)),this.after(),e.renderPassIndex++}}constructor(e){this._enabled=!0,this._skipStart=!1,this._skipEnd=!1,this.executeEnabled=!0,this.samples=0,this.colorArrayOps=[],this.requiresCubemaps=!0,this.fullSizeClearRect=!0,this.beforePasses=[],this.afterPasses=[],this.device=e}}function Lo(e){this.array[this.index]=e}function Mo(e,t){this.array[this.index]=e,this.array[this.index+1]=t}function Io(e,t,i){this.array[this.index]=e,this.array[this.index+1]=t,this.array[this.index+2]=i}function Ro(e,t,i,s){this.array[this.index]=e,this.array[this.index+1]=t,this.array[this.index+2]=i,this.array[this.index+3]=s}function ko(e,t,i){this.array[e]=t[i]}function Oo(e,t,i){this.array[e]=t[i],this.array[e+1]=t[i+1]}function Fo(e,t,i){this.array[e]=t[i],this.array[e+1]=t[i+1],this.array[e+2]=t[i+2]}function Bo(e,t,i){this.array[e]=t[i],this.array[e+1]=t[i+1],this.array[e+2]=t[i+2],this.array[e+3]=t[i+3]}function No(e,t,i){t[i]=this.array[e]}function zo(e,t,i){t[i]=this.array[e],t[i+1]=this.array[e+1]}function Uo(e,t,i){t[i]=this.array[e],t[i+1]=this.array[e+1],t[i+2]=this.array[e+2]}function Vo(e,t,i){t[i]=this.array[e],t[i+1]=this.array[e+1],t[i+2]=this.array[e+2],t[i+3]=this.array[e+3]}class Ho{get(e){return this.array[this.index+e]}set(e,t,i,s){}getToArray(e,t,i){}setFromArray(e,t,i){}constructor(e,t,i){switch(this.index=0,this.numComponents=t.numComponents,i.interleaved?this.array=new Qs[t.dataType](e,t.offset):this.array=new Qs[t.dataType](e,t.offset,i.vertexCount*t.numComponents),this.stride=t.stride/this.array.constructor.BYTES_PER_ELEMENT,t.numComponents){case 1:this.set=Lo,this.getToArray=No,this.setFromArray=ko;break;case 2:this.set=Mo,this.getToArray=zo,this.setFromArray=Oo;break;case 3:this.set=Io,this.getToArray=Uo,this.setFromArray=Fo;break;case 4:this.set=Ro,this.getToArray=Vo,this.setFromArray=Bo}}}class Go{next(e){void 0===e&&(e=1);for(var t=0,i=this.accessors,s=this.accessors.length;t<s;){var r=i[t++];r.index+=e*r.stride}}end(){this.vertexBuffer.unlock()}writeData(e,t,i){var s=this.element[e];if(s){i>this.vertexBuffer.numVertices&&(i=this.vertexBuffer.numVertices);var r=s.numComponents;if(this.vertexBuffer.getFormat().interleaved)for(var n=0,a=0;a<i;a++)s.setFromArray(n,t,a*r),n+=s.stride;else if(t.length>i*r){var o=i*r;if(ArrayBuffer.isView(t))t=t.subarray(0,o),s.array.set(t);else for(var l=0;l<o;l++)s.array[l]=t[l]}else s.array.set(t)}}readData(e,t){var i=this.element[e],s=0;if(i){var r;s=this.vertexBuffer.numVertices;var n=i.numComponents;if(this.vertexBuffer.getFormat().interleaved){Array.isArray(t)&&(t.length=0),i.index=0;var a=0;for(r=0;r<s;r++)i.getToArray(a,t,r*n),a+=i.stride}else if(ArrayBuffer.isView(t))t.set(i.array);else{t.length=0;var o=s*n;for(r=0;r<o;r++)t[r]=i.array[r]}}return s}constructor(e){this.vertexBuffer=e,this.vertexFormatSize=e.getFormat().size,this.buffer=this.vertexBuffer.lock(),this.accessors=[],this.element={};for(var t=this.vertexBuffer.getFormat(),i=0;i<t.elements.length;i++){var s=t.elements[i];this.accessors[i]=new Ho(this.buffer,s,t),this.element[s.name]=this.accessors[i]}}}var Wo=new class{constructor(e,t){this.key=null,this.element=null,this.event=null,t&&(this.key=t.keyCode,this.element=t.target,this.event=t)}};function jo(e){return Wo.key=e.keyCode,Wo.element=e.target,Wo.event=e,Wo}function qo(e){return"string"==typeof e?e.toUpperCase().charCodeAt(0):e}var Xo={9:"Tab",13:"Enter",16:"Shift",17:"Control",18:"Alt",27:"Escape",37:"Left",38:"Up",39:"Right",40:"Down",46:"Delete",91:"Win"};class Ko extends Ht{attach(e){this._element&&this.detach(),this._element=e,this._element.addEventListener("keydown",this._keyDownHandler,!1),this._element.addEventListener("keypress",this._keyPressHandler,!1),this._element.addEventListener("keyup",this._keyUpHandler,!1),document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1),window.addEventListener("blur",this._windowBlurHandler,!1)}detach(){this._element&&(this._element.removeEventListener("keydown",this._keyDownHandler),this._element.removeEventListener("keypress",this._keyPressHandler),this._element.removeEventListener("keyup",this._keyUpHandler),this._element=null,document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),window.removeEventListener("blur",this._windowBlurHandler,!1))}toKeyIdentifier(e){e=qo(e);var t=Xo[e.toString()];if(t)return t;for(var i=e.toString(16).toUpperCase(),s=i.length,r=0;r<4-s;r++)i="0"+i;return"U+"+i}_handleKeyDown(e){var t=e.keyCode||e.charCode;if(void 0!==t){var i=this.toKeyIdentifier(t);this._keymap[i]=!0,this.fire("keydown",jo(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation()}}_handleKeyUp(e){var t=e.keyCode||e.charCode;if(void 0!==t){var i=this.toKeyIdentifier(t);delete this._keymap[i],this.fire("keyup",jo(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation()}}_handleKeyPress(e){this.fire("keypress",jo(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation()}_handleVisibilityChange(){"hidden"===document.visibilityState&&this._handleWindowBlur()}_handleWindowBlur(){this._keymap={},this._lastmap={}}update(){for(var e in this._lastmap)delete this._lastmap[e];for(var t in this._keymap)this._keymap.hasOwnProperty(t)&&(this._lastmap[t]=this._keymap[t])}isPressed(e){var t=qo(e),i=this.toKeyIdentifier(t);return!!this._keymap[i]}wasPressed(e){var t=qo(e),i=this.toKeyIdentifier(t);return!!this._keymap[i]&&!this._lastmap[i]}wasReleased(e){var t=qo(e),i=this.toKeyIdentifier(t);return!this._keymap[i]&&!!this._lastmap[i]}constructor(e,t={}){super(),this._element=null,this._keymap={},this._lastmap={},this._keyDownHandler=this._handleKeyDown.bind(this),this._keyUpHandler=this._handleKeyUp.bind(this),this._keyPressHandler=this._handleKeyPress.bind(this),this._visibilityChangeHandler=this._handleVisibilityChange.bind(this),this._windowBlurHandler=this._handleWindowBlur.bind(this),e&&this.attach(e),this.preventDefault=t.preventDefault||!1,this.stopPropagation=t.stopPropagation||!1}}function Yo(){return!!(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement)}Ko.EVENT_KEYDOWN="keydown",Ko.EVENT_KEYUP="keyup";class Qo{constructor(e,t){this.x=0,this.y=0,this.dx=0,this.dy=0,this.button=-1,this.wheelDelta=0,this.ctrlKey=!1,this.altKey=!1,this.shiftKey=!1,this.metaKey=!1;var i,s,r,n,a={x:0,y:0};if(t){if(t instanceof Qo)throw Error("Expected MouseEvent");a=e._getTargetCoords(t)}else t={};if(a)this.x=a.x,this.y=a.y;else{if(!Yo())return;this.x=0,this.y=0}"wheel"===t.type&&(t.deltaY>0?this.wheelDelta=1:t.deltaY<0&&(this.wheelDelta=-1)),Yo()?(this.dx=t.movementX||t.webkitMovementX||t.mozMovementX||0,this.dy=t.movementY||t.webkitMovementY||t.mozMovementY||0):(this.dx=this.x-e._lastX,this.dy=this.y-e._lastY),"mousedown"!==t.type&&"mouseup"!==t.type||(this.button=t.button),this.buttons=e._buttons.slice(0),this.element=t.target,this.ctrlKey=null!=(i=t.ctrlKey)&&i,this.altKey=null!=(s=t.altKey)&&s,this.shiftKey=null!=(r=t.shiftKey)&&r,this.metaKey=null!=(n=t.metaKey)&&n,this.event=t}}class Jo extends Ht{static isPointerLocked(){return Yo()}attach(e){if(this._target=e,!this._attached){this._attached=!0;var t=!!Ut.passiveEvents&&{passive:!1};window.addEventListener("mouseup",this._upHandler,t),window.addEventListener("mousedown",this._downHandler,t),window.addEventListener("mousemove",this._moveHandler,t),window.addEventListener("wheel",this._wheelHandler,t)}}detach(){if(this._attached){this._attached=!1,this._target=null;var e=!!Ut.passiveEvents&&{passive:!1};window.removeEventListener("mouseup",this._upHandler,e),window.removeEventListener("mousedown",this._downHandler,e),window.removeEventListener("mousemove",this._moveHandler,e),window.removeEventListener("wheel",this._wheelHandler,e)}}disableContextMenu(){this._target&&this._target.addEventListener("contextmenu",this._contextMenuHandler)}enableContextMenu(){this._target&&this._target.removeEventListener("contextmenu",this._contextMenuHandler)}enablePointerLock(e,t){if(document.body.requestPointerLock){var i=()=>{e(),document.removeEventListener("pointerlockchange",i)},s=()=>{t(),document.removeEventListener("pointerlockerror",s)};e&&document.addEventListener("pointerlockchange",i,!1),t&&document.addEventListener("pointerlockerror",s,!1),document.body.requestPointerLock()}else t&&t()}disablePointerLock(e){if(document.exitPointerLock){var t=()=>{e(),document.removeEventListener("pointerlockchange",t)};e&&document.addEventListener("pointerlockchange",t,!1),document.exitPointerLock()}}update(){this._lastbuttons[0]=this._buttons[0],this._lastbuttons[1]=this._buttons[1],this._lastbuttons[2]=this._buttons[2]}isPressed(e){return this._buttons[e]}wasPressed(e){return this._buttons[e]&&!this._lastbuttons[e]}wasReleased(e){return!this._buttons[e]&&this._lastbuttons[e]}_handleUp(e){this._buttons[e.button]=!1;var t=new Qo(this,e);t.event&&this.fire("mouseup",t)}_handleDown(e){this._buttons[e.button]=!0;var t=new Qo(this,e);t.event&&this.fire("mousedown",t)}_handleMove(e){var t=new Qo(this,e);t.event&&(this.fire("mousemove",t),this._lastX=t.x,this._lastY=t.y)}_handleWheel(e){var t=new Qo(this,e);t.event&&this.fire("mousewheel",t)}_getTargetCoords(e){var t=this._target.getBoundingClientRect(),i=Math.floor(t.left),s=Math.floor(t.top);return e.clientX<i||e.clientX>=i+this._target.clientWidth||e.clientY<s||e.clientY>=s+this._target.clientHeight?null:{x:e.clientX-i,y:e.clientY-s}}constructor(e){super(),this._lastX=0,this._lastY=0,this._buttons=[!1,!1,!1],this._lastbuttons=[!1,!1,!1],this._target=null,this._attached=!1,this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._contextMenuHandler=e=>{e.preventDefault()},this.attach(e)}}Jo.EVENT_MOUSEMOVE="mousemove",Jo.EVENT_MOUSEDOWN="mousedown",Jo.EVENT_MOUSEUP="mouseup",Jo.EVENT_MOUSEWHEEL="mousewheel";class $o{constructor(e){var t=function(e){for(var t=0,i=0,s=e.target;!(s instanceof HTMLElement)&&s;)s=s.parentNode;for(;s;)t+=s.offsetLeft-s.scrollLeft,i+=s.offsetTop-s.scrollTop,s=s.offsetParent;return{x:e.pageX-t,y:e.pageY-i}}(e);this.id=e.identifier,this.x=t.x,this.y=t.y,this.target=e.target,this.touch=e}}class Zo{getTouchById(e,t){return t.find((t=>t.id===e))||null}constructor(e,t){this.touches=[],this.changedTouches=[],this.element=t.target,this.event=t,this.touches=Array.from(t.touches).map((e=>new $o(e))),this.changedTouches=Array.from(t.changedTouches).map((e=>new $o(e)))}}class el extends Ht{attach(e){this._element&&this.detach(),this._element=e,this._element.addEventListener("touchstart",this._startHandler,!1),this._element.addEventListener("touchend",this._endHandler,!1),this._element.addEventListener("touchmove",this._moveHandler,!1),this._element.addEventListener("touchcancel",this._cancelHandler,!1)}detach(){this._element&&(this._element.removeEventListener("touchstart",this._startHandler,!1),this._element.removeEventListener("touchend",this._endHandler,!1),this._element.removeEventListener("touchmove",this._moveHandler,!1),this._element.removeEventListener("touchcancel",this._cancelHandler,!1)),this._element=null}_handleTouchStart(e){this.fire("touchstart",new Zo(this,e))}_handleTouchEnd(e){this.fire("touchend",new Zo(this,e))}_handleTouchMove(e){e.preventDefault(),this.fire("touchmove",new Zo(this,e))}_handleTouchCancel(e){this.fire("touchcancel",new Zo(this,e))}constructor(e){super(),this._element=null,this._startHandler=this._handleTouchStart.bind(this),this._endHandler=this._handleTouchEnd.bind(this),this._moveHandler=this._handleTouchMove.bind(this),this._cancelHandler=this._handleTouchCancel.bind(this),this.attach(e)}}el.EVENT_TOUCHSTART="touchstart",el.EVENT_TOUCHEND="touchend",el.EVENT_TOUCHMOVE="touchmove",el.EVENT_TOUCHCANCEL="touchcancel";class tl{get(e,t,i){return"function"==typeof t&&(i=t,t={}),this.request("GET",e,t,i)}post(e,t,i,s){return"function"==typeof i&&(s=i,i={}),i.postdata=t,this.request("POST",e,i,s)}put(e,t,i,s){return"function"==typeof i&&(s=i,i={}),i.postdata=t,this.request("PUT",e,i,s)}del(e,t,i){return"function"==typeof t&&(i=t,t={}),this.request("DELETE",e,t,i)}request(e,t,i,s){var r,n,a,o=!1;if("function"==typeof i&&(s=i,i={}),i.retry&&(i=Object.assign({retries:0,maxRetries:5},i)),i.callback=s,null==i.async&&(i.async=!0),null==i.headers&&(i.headers={}),null!=i.postdata)if(i.postdata instanceof Document)a=i.postdata;else if(i.postdata instanceof FormData)a=i.postdata;else if(i.postdata instanceof Object){var l=i.headers["Content-Type"];switch(void 0===l&&(i.headers["Content-Type"]=tl.ContentType.FORM_URLENCODED,l=i.headers["Content-Type"]),l){case tl.ContentType.FORM_URLENCODED:a="";var h=!0;for(var c in i.postdata){if(i.postdata.hasOwnProperty(c))h?h=!1:a+="&",a+=encodeURIComponent(c)+"="+encodeURIComponent(i.postdata[c])}break;default:case tl.ContentType.JSON:null==l&&(i.headers["Content-Type"]=tl.ContentType.JSON),a=JSON.stringify(i.postdata)}}else a=i.postdata;if(!1===i.cache){var d=Jt();(r=new Zt(t)).query?r.query=r.query+"&ts="+d:r.query="ts="+d,t=r.toString()}i.query&&(n=It((r=new Zt(t)).getQuery(),i.query),r.setQuery(n),t=r.toString());var u=new XMLHttpRequest;for(var f in u.open(e,t,i.async),u.withCredentials=void 0!==i.withCredentials&&i.withCredentials,u.responseType=i.responseType||this._guessResponseType(t),i.headers)i.headers.hasOwnProperty(f)&&u.setRequestHeader(f,i.headers[f]);u.onreadystatechange=()=>{this._onReadyStateChange(e,t,i,u)},u.onerror=()=>{this._onError(e,t,i,u),o=!0};try{u.send(a)}catch(e){o||i.error(u.status,u,e)}return u}_guessResponseType(e){var t=new Zt(e),i=kt.getExtension(t.path).toLowerCase();return tl.binaryExtensions.indexOf(i)>=0?tl.ResponseType.ARRAY_BUFFER:".json"===i?tl.ResponseType.JSON:".xml"===i?tl.ResponseType.DOCUMENT:tl.ResponseType.TEXT}_isBinaryContentType(e){return[tl.ContentType.BASIS,tl.ContentType.BIN,tl.ContentType.DDS,tl.ContentType.GLB,tl.ContentType.MP3,tl.ContentType.MP4,tl.ContentType.OGG,tl.ContentType.OPUS,tl.ContentType.WAV].indexOf(e)>=0}_isBinaryResponseType(e){return e===tl.ResponseType.ARRAY_BUFFER||e===tl.ResponseType.BLOB||e===tl.ResponseType.JSON}_onReadyStateChange(e,t,i,s){if(4===s.readyState)switch(s.status){case 0:s.responseURL&&s.responseURL.startsWith("file:///")?this._onSuccess(e,t,i,s):this._onError(e,t,i,s);break;case 200:case 201:case 206:case 304:this._onSuccess(e,t,i,s);break;default:this._onError(e,t,i,s)}}_onSuccess(e,t,i,s){var r,n,a=s.getResponseHeader("Content-Type");a&&(n=a.split(";")[0].trim());try{r=this._isBinaryContentType(n)||this._isBinaryResponseType(s.responseType)?s.response:n===tl.ContentType.JSON||t.split("?")[0].endsWith(".json")?JSON.parse(s.responseText):s.responseType===tl.ResponseType.DOCUMENT||n===tl.ContentType.XML?s.responseXML:s.responseText,i.callback(null,r)}catch(e){i.callback(e)}}_onError(e,t,i,s){if(!i.retrying)if(i.retry&&i.retries<i.maxRetries){i.retries++,i.retrying=!0;var r=ti.clamp(Math.pow(2,i.retries)*tl.retryDelay,0,i.maxRetryDelay||5e3);console.log(e+": "+t+" - Error "+s.status+". Retrying in "+r+" ms"),setTimeout((()=>{i.retrying=!1,this.request(e,t,i,i.callback)}),r)}else i.callback(0===s.status?"Network error":s.status,null)}}tl.ContentType={AAC:"audio/aac",BASIS:"image/basis",BIN:"application/octet-stream",DDS:"image/dds",FORM_URLENCODED:"application/x-www-form-urlencoded",GIF:"image/gif",GLB:"model/gltf-binary",JPEG:"image/jpeg",JSON:"application/json",MP3:"audio/mpeg",MP4:"audio/mp4",OGG:"audio/ogg",OPUS:'audio/ogg; codecs="opus"',PNG:"image/png",TEXT:"text/plain",WAV:"audio/x-wav",XML:"application/xml"},tl.ResponseType={TEXT:"text",ARRAY_BUFFER:"arraybuffer",BLOB:"blob",DOCUMENT:"document",JSON:"json"},tl.binaryExtensions=[".model",".wav",".ogg",".mp3",".mp4",".m4a",".aac",".dds",".basis",".glb",".opus"],tl.retryDelay=100;var il=new tl,sl=0,rl=1,nl=2,al=3,ol=4,ll=5,hl=6,cl=7,dl=8,ul=9,fl=10,pl={[sl]:"SUBTRACTIVE",[rl]:"ADDITIVE",[nl]:"NORMAL",[al]:"NONE",[ol]:"PREMULTIPLIED",[ll]:"MULTIPLICATIVE",[hl]:"ADDITIVEALPHA",[cl]:"MULTIPLICATIVE2X",[dl]:"SCREEN",[ul]:"MIN",[fl]:"MAX"},ml="none",gl=0,vl=2,_l={[gl]:"NONE",[vl]:"SCHLICK"},bl=0,yl=1,xl=2,Sl={[bl]:"DIRECTIONAL",[yl]:"OMNI",[xl]:"SPOT"},wl=100,Tl=0,Cl=1,El=2,Al=3,Pl={[Tl]:"PUNCTUAL",[Cl]:"RECT",[El]:"DISK",[Al]:"SPHERE"},Dl=0,Ll=1,Ml={[Dl]:"LINEAR",[Ll]:"INVERSESQUARED"},Il=new Map([[5,{name:"PCF1_32F",kind:"PCF1",format:Fi,pcf:!0}],[0,{name:"PCF3_32F",kind:"PCF3",format:Fi,pcf:!0}],[4,{name:"PCF5_32F",kind:"PCF5",format:Fi,pcf:!0}],[7,{name:"PCF1_16F",kind:"PCF1",format:Wi,pcf:!0}],[8,{name:"PCF3_16F",kind:"PCF3",format:Wi,pcf:!0}],[9,{name:"PCF5_16F",kind:"PCF5",format:Wi,pcf:!0}],[2,{name:"VSM_16F",kind:"VSM",format:Ri,vsm:!0}],[3,{name:"VSM_32F",kind:"VSM",format:ki,vsm:!0}],[6,{name:"PCSS_32F",kind:"PCSS",format:Oi,pcss:!0}]]),Rl=0,kl=1,Ol={[Rl]:"NONE",[kl]:"BOX"},Fl=0,Bl=1,Nl={[Fl]:"NONE",[Bl]:"SRGB"},zl=["LINEAR","FILMIC","HEJL","ACES","ACES2","NEUTRAL","NONE"],Ul=0,Vl=1,Hl=2,Gl={[Ul]:"NONE",[Vl]:"AO",[Hl]:"GLOSSDEPENDENT"},Wl="none",jl="envAtlas",ql="envAtlasHQ",Xl="cubeMap",Kl="sphereMap",Yl={[Wl]:"NONE",[jl]:"ENVATLAS",[ql]:"ENVATLASHQ",[Xl]:"CUBEMAP",[Kl]:"SPHEREMAP"},Ql="ambientSH",Jl="envAtlas",$l="constant",Zl={[Ql]:"AMBIENTSH",[Jl]:"ENVALATLAS",[$l]:"CONSTANT"},eh=1024,th=2048,ih=8192,sh=16384,rh=0,nh=1,ah=2,oh={[rh]:"SIMPLE",[nh]:"SLICED",[ah]:"TILED"},lh="infinite",hh="dome",ch="none",dh="bayer8",uh="bluenoise",fh="ignnoise",ph={[ch]:"NONE",[dh]:"BAYER8",[uh]:"BLUENOISE",[fh]:"IGNNOISE"},mh="prerender",gh="postrender";class vh{hasUniform(e){for(var t=0;t<this.uniformFormats.length;t++){var i=this.uniformFormats[t];if(null==i?void 0:i.get(e))return!0}return!1}hasTexture(e){for(var t=0;t<this.bindGroupFormats.length;t++){var i=this.bindGroupFormats[t];if(null==i?void 0:i.getTexture(e))return!0}return!1}getVertexElement(e){var t;return null==(t=this.vertexFormat)?void 0:t.elements.find((t=>t.name===e))}generateKey(e){var t,i=JSON.stringify(this.uniformFormats)+JSON.stringify(this.bindGroupFormats);e.isWebGPU&&(i+=null==(t=this.vertexFormat)?void 0:t.shaderProcessingHashString);return i}constructor(e,t,i){this.uniformFormats=[],this.bindGroupFormats=[],this.uniformFormats[0]=e,this.bindGroupFormats[0]=t,this.vertexFormat=i}}var _h={alphaTestPS:"\nuniform float alpha_ref;\nvoid alphaTest(float a) {\n\tif (a < alpha_ref) discard;\n}\n",ambientPS:'\n#ifdef LIT_AMBIENT_SOURCE == AMBIENTSH\n\tuniform vec3 ambientSH[9];\n#endif\n#if LIT_AMBIENT_SOURCE == ENVALATLAS\n\t#include "envAtlasPS"\n\t#ifndef ENV_ATLAS\n\t#define ENV_ATLAS\n\tuniform sampler2D texture_envAtlas;\n\t#endif\n#endif\nvoid addAmbient(vec3 worldNormal) {\n\t#ifdef LIT_AMBIENT_SOURCE == AMBIENTSH\n\t\tvec3 n = cubeMapRotate(worldNormal);\n\t\tvec3 color =\n\t\t\tambientSH[0] +\n\t\t\tambientSH[1] * n.x +\n\t\t\tambientSH[2] * n.y +\n\t\t\tambientSH[3] * n.z +\n\t\t\tambientSH[4] * n.x * n.z +\n\t\t\tambientSH[5] * n.z * n.y +\n\t\t\tambientSH[6] * n.y * n.x +\n\t\t\tambientSH[7] * (3.0 * n.z * n.z - 1.0) +\n\t\t\tambientSH[8] * (n.x * n.x - n.y * n.y);\n\t\tdDiffuseLight += processEnvironment(max(color, vec3(0.0)));\n\t#endif\n\t#if LIT_AMBIENT_SOURCE == ENVALATLAS\n\t\tvec3 dir = normalize(cubeMapRotate(worldNormal) * vec3(-1.0, 1.0, 1.0));\n\t\tvec2 uv = mapUv(toSphericalUv(dir), vec4(128.0, 256.0 + 128.0, 64.0, 32.0) / atlasSize);\n\t\tvec4 raw = texture2D(texture_envAtlas, uv);\n\t\tvec3 linear = {ambientDecode}(raw);\n\t\tdDiffuseLight += processEnvironment(linear);\n\t#endif\n\t#if LIT_AMBIENT_SOURCE == CONSTANT\n\t\tdDiffuseLight += light_globalAmbient;\n\t#endif\n}\n',aoPS:'\n#if defined(STD_AO_TEXTURE) || defined(STD_AO_VERTEX)\n\tuniform float material_aoIntensity;\n#endif\n#ifdef STD_AODETAIL_TEXTURE\n\t#include "detailModesPS"\n#endif\nvoid getAO() {\n\tdAo = 1.0;\n\t#ifdef STD_AO_TEXTURE\n\t\tfloat aoBase = texture2DBias({STD_AO_TEXTURE_NAME}, {STD_AO_TEXTURE_UV}, textureBias).{STD_AO_TEXTURE_CHANNEL};\n\t\t#ifdef STD_AODETAIL_TEXTURE\n\t\t\tfloat aoDetail = texture2DBias({STD_AODETAIL_TEXTURE_NAME}, {STD_AODETAIL_TEXTURE_UV}, textureBias).{STD_AODETAIL_TEXTURE_CHANNEL};\n\t\t\taoBase = detailMode_{STD_AODETAIL_DETAILMODE}(vec3(aoBase), vec3(aoDetail)).r;\n\t\t#endif\n\t\tdAo *= aoBase;\n\t#endif\n\t#ifdef STD_AO_VERTEX\n\t\tdAo *= saturate(vVertexColor.{STD_AO_VERTEX_CHANNEL});\n\t#endif\n\t#if defined(STD_AO_TEXTURE) || defined(STD_AO_VERTEX)\n\t\tdAo = mix(1.0, dAo, material_aoIntensity);\n\t#endif\n}\n',aoDiffuseOccPS:"\nvoid occludeDiffuse(float ao) {\n\tdDiffuseLight *= ao;\n}\n",aoSpecOccPS:"\n#if LIT_OCCLUDE_SPECULAR != NONE\n\t#ifdef LIT_OCCLUDE_SPECULAR_FLOAT\n\t\tuniform float material_occludeSpecularIntensity;\n\t#endif\n#endif\nvoid occludeSpecular(float gloss, float ao, vec3 worldNormal, vec3 viewDir) {\n\t#if LIT_OCCLUDE_SPECULAR == AO\n\t\t#ifdef LIT_OCCLUDE_SPECULAR_FLOAT\n\t\t\tfloat specOcc = mix(1.0, ao, material_occludeSpecularIntensity);\n\t\t#else\n\t\t\tfloat specOcc = ao;\n\t\t#endif\n\t#endif\n\t#if LIT_OCCLUDE_SPECULAR == GLOSSDEPENDENT\n\t\tfloat specPow = exp2(gloss * 11.0);\n\t\tfloat specOcc = saturate(pow(dot(worldNormal, viewDir) + ao, 0.01*specPow) - 1.0 + ao);\n\t\t#ifdef LIT_OCCLUDE_SPECULAR_FLOAT\n\t\t\tspecOcc = mix(1.0, specOcc, material_occludeSpecularIntensity);\n\t\t#endif\n\t#endif\n\t#if LIT_OCCLUDE_SPECULAR != NONE\n\t\tdSpecularLight *= specOcc;\n\t\tdReflection *= specOcc;\n\t\t#ifdef LIT_SHEEN\n\t\t\tsSpecularLight *= specOcc;\n\t\t\tsReflection *= specOcc;\n\t\t#endif\n\t#endif\n}\n",basePS:"\nuniform vec3 view_position;\nuniform vec3 light_globalAmbient;\nfloat square(float x) {\n\treturn x*x;\n}\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec3 saturate(vec3 x) {\n\treturn clamp(x, vec3(0.0), vec3(1.0));\n}\n",baseNineSlicedPS:"\n#define NINESLICED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\nvec2 nineSlicedUv;\n",baseNineSlicedTiledPS:"\n#define NINESLICED\n#define NINESLICETILED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\nvec2 nineSlicedUv;\n",bayerPS:"\nfloat bayer2(vec2 p) {\n\treturn mod(2.0 * p.y + p.x + 1.0, 4.0);\n}\nfloat bayer4(vec2 p) {\n\tvec2 p1 = mod(p, 2.0);\n\tvec2 p2 = floor(0.5 * mod(p, 4.0));\n\treturn 4.0 * bayer2(p1) + bayer2(p2);\n}\nfloat bayer8(vec2 p) {\n\tvec2 p1 = mod(p, 2.0);\n\tvec2 p2 = floor(0.5 * mod(p, 4.0));\n\tvec2 p4 = floor(0.25 * mod(p, 8.0));\n\treturn 4.0 * (4.0 * bayer2(p1) + bayer2(p2)) + bayer2(p4);\n}\n",blurVSMPS:"\nvarying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\n#ifdef GAUSS\nuniform float weight[SAMPLES];\n#endif\nvoid main(void) {\n\tvec3 moments = vec3(0.0);\n\tvec2 uv = vUv0 - pixelOffset * (float(SAMPLES) * 0.5);\n\tfor (int i=0; i<SAMPLES; i++) {\n\t\tvec4 c = texture2D(source, uv + pixelOffset * float(i));\n\t\t#ifdef GAUSS\n\t\tmoments += c.xyz * weight[i];\n\t\t#else\n\t\tmoments += c.xyz;\n\t\t#endif\n\t}\n\t#ifndef GAUSS\n\tmoments /= float(SAMPLES);\n\t#endif\n\tgl_FragColor = vec4(moments.x, moments.y, moments.z, 1.0);\n}\n",clearCoatPS:"\n#ifdef STD_CLEARCOAT_CONSTANT\nuniform float material_clearCoat;\n#endif\nvoid getClearCoat() {\n\tccSpecularity = 1.0;\n\t#ifdef STD_CLEARCOAT_CONSTANT\n\tccSpecularity *= material_clearCoat;\n\t#endif\n\t#ifdef STD_CLEARCOAT_TEXTURE\n\tccSpecularity *= texture2DBias({STD_CLEARCOAT_TEXTURE_NAME}, {STD_CLEARCOAT_TEXTURE_UV}, textureBias).{STD_CLEARCOAT_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_CLEARCOAT_VERTEX\n\tccSpecularity *= saturate(vVertexColor.{STD_CLEARCOAT_VERTEX_CHANNEL});\n\t#endif\n}\n",clearCoatGlossPS:"\n#ifdef STD_CLEARCOATGLOSS_CONSTANT\nuniform float material_clearCoatGloss;\n#endif\nvoid getClearCoatGlossiness() {\n\tccGlossiness = 1.0;\n\t#ifdef STD_CLEARCOATGLOSS_CONSTANT\n\tccGlossiness *= material_clearCoatGloss;\n\t#endif\n\t#ifdef STD_CLEARCOATGLOSS_TEXTURE\n\tccGlossiness *= texture2DBias({STD_CLEARCOATGLOSS_TEXTURE_NAME}, {STD_CLEARCOATGLOSS_TEXTURE_UV}, textureBias).{STD_CLEARCOATGLOSS_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_CLEARCOATGLOSS_VERTEX\n\tccGlossiness *= saturate(vVertexColor.{STD_CLEARCOATGLOSS_VERTEX_CHANNEL});\n\t#endif\n\t#ifdef STD_CLEARCOATGLOSS_INVERT\n\tccGlossiness = 1.0 - ccGlossiness;\n\t#endif\n\tccGlossiness += 0.0000001;\n}\n",clearCoatNormalPS:"\n#ifdef STD_CLEARCOATNORMAL_TEXTURE\nuniform float material_clearCoatBumpiness;\n#endif\nvoid getClearCoatNormal() {\n#ifdef STD_CLEARCOATNORMAL_TEXTURE\n\tvec3 normalMap = {STD_CLEARCOATNORMAL_TEXTURE_DECODE}(texture2DBias({STD_CLEARCOATNORMAL_TEXTURE_NAME}, {STD_CLEARCOATNORMAL_TEXTURE_UV}, textureBias));\n\tnormalMap = mix(vec3(0.0, 0.0, 1.0), normalMap, material_clearCoatBumpiness);\n\tccNormalW = normalize(dTBN * normalMap);\n#else\n\tccNormalW = dVertexNormalW;\n#endif\n}\n",clusteredLightCookiesPS:"\nvec3 _getCookieClustered(TEXTURE_ACCEPT(tex), vec2 uv, float intensity, vec4 cookieChannel) {\n\tvec4 pixel = mix(vec4(1.0), texture2DLod(tex, uv, 0.0), intensity);\n\tbool isRgb = dot(cookieChannel.rgb, vec3(1.0)) == 3.0;\n\treturn isRgb ? pixel.rgb : vec3(dot(pixel, cookieChannel));\n}\nvec3 getCookie2DClustered(TEXTURE_ACCEPT(tex), mat4 transform, vec3 worldPosition, float intensity, vec4 cookieChannel) {\n\tvec4 projPos = transform * vec4(worldPosition, 1.0);\n\treturn _getCookieClustered(TEXTURE_PASS(tex), projPos.xy / projPos.w, intensity, cookieChannel);\n}\nvec3 getCookieCubeClustered(TEXTURE_ACCEPT(tex), vec3 dir, float intensity, vec4 cookieChannel, float shadowTextureResolution, float shadowEdgePixels, vec3 omniAtlasViewport) {\n\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);\n\treturn _getCookieClustered(TEXTURE_PASS(tex), uv, intensity, cookieChannel);\n}\n",clusteredLightShadowsPS:"\nvec3 _getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n\tvec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n\tprojPos.xyz /= projPos.w;\n\treturn projPos.xyz;\n}\nvec3 getShadowCoordPerspZbufferNormalOffset(mat4 shadowMatrix, vec4 shadowParams, vec3 normal) {\n\tvec3 wPos = vPositionW + normal * shadowParams.y;\n\treturn _getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);\n}\nvec3 normalOffsetPointShadow(vec4 shadowParams, vec3 lightPos, inout vec3 lightDir, vec3 lightDirNorm, vec3 normal) {\n\tfloat distScale = length(lightDir);\n\tvec3 wPos = vPositionW + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;\n\tvec3 dir = wPos - lightPos;\n\treturn dir;\n}\n#if defined(CLUSTER_SHADOW_TYPE_PCF1)\nfloat getShadowOmniClusteredPCF1(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {\n\tfloat shadowTextureResolution = shadowParams.x;\n\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n\tfloat shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n\treturn textureShadow(shadowMap, vec3(uv, shadowZ));\n}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF3)\nfloat getShadowOmniClusteredPCF3(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {\n\tfloat shadowTextureResolution = shadowParams.x;\n\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n\tfloat shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n\tvec3 shadowCoord = vec3(uv, shadowZ);\n\treturn getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);\n}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF5)\nfloat getShadowOmniClusteredPCF5(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {\n\tfloat shadowTextureResolution = shadowParams.x;\n\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n\tfloat shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n\tvec3 shadowCoord = vec3(uv, shadowZ);\n\treturn getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);\n}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF1)\nfloat getShadowSpotClusteredPCF1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn textureShadow(shadowMap, shadowCoord);\n}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF3)\nfloat getShadowSpotClusteredPCF3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn getShadowSpotPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);\n}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF5)\nfloat getShadowSpotClusteredPCF5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);\n}\n#endif\n",clusteredLightUtilsPS:"\nvec2 getCubemapFaceCoordinates(const vec3 dir, out float faceIndex, out vec2 tileOffset)\n{\n\tvec3 vAbs = abs(dir);\n\tfloat ma;\n\tvec2 uv;\n\tif (vAbs.z >= vAbs.x && vAbs.z >= vAbs.y) {\n\t\tfaceIndex = dir.z < 0.0 ? 5.0 : 4.0;\n\t\tma = 0.5 / vAbs.z;\n\t\tuv = vec2(dir.z < 0.0 ? -dir.x : dir.x, -dir.y);\n\t\ttileOffset.x = 2.0;\n\t\ttileOffset.y = dir.z < 0.0 ? 1.0 : 0.0;\n\t} else if(vAbs.y >= vAbs.x) {\n\t\tfaceIndex = dir.y < 0.0 ? 3.0 : 2.0;\n\t\tma = 0.5 / vAbs.y;\n\t\tuv = vec2(dir.x, dir.y < 0.0 ? -dir.z : dir.z);\n\t\ttileOffset.x = 1.0;\n\t\ttileOffset.y = dir.y < 0.0 ? 1.0 : 0.0;\n\t} else {\n\t\tfaceIndex = dir.x < 0.0 ? 1.0 : 0.0;\n\t\tma = 0.5 / vAbs.x;\n\t\tuv = vec2(dir.x < 0.0 ? dir.z : -dir.z, -dir.y);\n\t\ttileOffset.x = 0.0;\n\t\ttileOffset.y = dir.x < 0.0 ? 1.0 : 0.0;\n\t}\n\treturn uv * ma + 0.5;\n}\nvec2 getCubemapAtlasCoordinates(const vec3 omniAtlasViewport, float shadowEdgePixels, float shadowTextureResolution, const vec3 dir) {\n\tfloat faceIndex;\n\tvec2 tileOffset;\n\tvec2 uv = getCubemapFaceCoordinates(dir, faceIndex, tileOffset);\n\tfloat atlasFaceSize = omniAtlasViewport.z;\n\tfloat tileSize = shadowTextureResolution * atlasFaceSize;\n\tfloat offset = shadowEdgePixels / tileSize;\n\tuv = uv * vec2(1.0 - offset * 2.0) + vec2(offset * 1.0);\n\tuv *= atlasFaceSize;\n\tuv += tileOffset * atlasFaceSize;\n\tuv += omniAtlasViewport.xy;\n\treturn uv;\n}\n",clusteredLightPS:'\n#include "lightBufferDefinesPS"\n#include "clusteredLightUtilsPS"\n#ifdef CLUSTER_COOKIES\n\t#include "clusteredLightCookiesPS"\n#endif\n#ifdef CLUSTER_SHADOWS\n\t#include "clusteredLightShadowsPS"\n#endif\nuniform highp sampler2D clusterWorldTexture;\nuniform highp sampler2D lightsTexture;\n#ifdef CLUSTER_SHADOWS\n\tuniform sampler2DShadow shadowAtlasTexture;\n#endif\n#ifdef CLUSTER_COOKIES\n\tuniform sampler2D cookieAtlasTexture;\n#endif\nuniform int clusterMaxCells;\nuniform float clusterSkip;\nuniform vec3 clusterCellsCountByBoundsSize;\nuniform vec3 clusterTextureSize;\nuniform vec3 clusterBoundsMin;\nuniform vec3 clusterBoundsDelta;\nuniform vec3 clusterCellsDot;\nuniform vec3 clusterCellsMax;\nuniform vec2 shadowAtlasParams;\nstruct ClusterLightData {\n\tuint flags;\n\tvec3 halfWidth;\n\tbool isSpot;\n\tvec3 halfHeight;\n\tint lightIndex;\n\tvec3 position;\n\tuint shape;\n\tvec3 direction;\n\tbool falloffModeLinear;\n\tvec3 color;\n\tfloat shadowIntensity;\n\tvec3 omniAtlasViewport;\n\tfloat range;\n\tvec4 cookieChannelMask;\n\tfloat biasesData;\n\tfloat shadowBias;\n\tfloat shadowNormalBias;\n\tfloat anglesData;\n\tfloat innerConeAngleCos;\n\tfloat outerConeAngleCos;\n\tfloat cookieIntensity;\n\tbool isDynamic;\n\tbool isLightmapped;\n};\nmat4 lightProjectionMatrix;\nvec4 sampleLightTextureF(const ClusterLightData clusterLightData, int index) {\n\treturn texelFetch(lightsTexture, ivec2(index, clusterLightData.lightIndex), 0);\n}\nvoid decodeClusterLightCore(inout ClusterLightData clusterLightData, float lightIndex) {\n\tclusterLightData.lightIndex = int(lightIndex);\n\tvec4 halfData = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_COLOR_ANGLES_BIAS);\n\tclusterLightData.anglesData = halfData.z;\n\tclusterLightData.biasesData = halfData.w;\n\tvec2 colorRG = unpackHalf2x16(floatBitsToUint(halfData.x));\n\tvec2 colorB_ = unpackHalf2x16(floatBitsToUint(halfData.y));\n\tclusterLightData.color = vec3(colorRG, colorB_.x) * {LIGHT_COLOR_DIVIDER};\n\tvec4 lightPosRange = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_POSITION_RANGE);\n\tclusterLightData.position = lightPosRange.xyz;\n\tclusterLightData.range = lightPosRange.w;\n\tvec4 lightDir_Flags = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_DIRECTION_FLAGS);\n\tclusterLightData.direction = lightDir_Flags.xyz;\n\tclusterLightData.flags = floatBitsToUint(lightDir_Flags.w);\n\tclusterLightData.isSpot = (clusterLightData.flags & (1u << 30u)) != 0u;\n\tclusterLightData.shape = (clusterLightData.flags >> 28u) & 0x3u;\n\tclusterLightData.falloffModeLinear = (clusterLightData.flags & (1u << 27u)) == 0u;\n\tclusterLightData.shadowIntensity = float((clusterLightData.flags >> 0u) & 0xFFu) / 255.0;\n\tclusterLightData.cookieIntensity = float((clusterLightData.flags >> 8u) & 0xFFu) / 255.0;\n\tclusterLightData.isDynamic = (clusterLightData.flags & (1u << 22u)) != 0u;\n\tclusterLightData.isLightmapped = (clusterLightData.flags & (1u << 21u)) != 0u;\n}\nvoid decodeClusterLightSpot(inout ClusterLightData clusterLightData) {\n\tvec2 angles = unpackHalf2x16(floatBitsToUint(clusterLightData.anglesData));\n\tclusterLightData.innerConeAngleCos = angles.x;\n\tclusterLightData.outerConeAngleCos = angles.y;\n}\nvoid decodeClusterLightOmniAtlasViewport(inout ClusterLightData clusterLightData) {\n\tclusterLightData.omniAtlasViewport = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_PROJ_MAT_0).xyz;\n}\nvoid decodeClusterLightAreaData(inout ClusterLightData clusterLightData) {\n\tclusterLightData.halfWidth = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_AREA_DATA_WIDTH).xyz;\n\tclusterLightData.halfHeight = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_AREA_DATA_HEIGHT).xyz;\n}\nvoid decodeClusterLightProjectionMatrixData(inout ClusterLightData clusterLightData) {\n\t\n\tvec4 m0 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_PROJ_MAT_0);\n\tvec4 m1 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_PROJ_MAT_1);\n\tvec4 m2 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_PROJ_MAT_2);\n\tvec4 m3 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_PROJ_MAT_3);\n\tlightProjectionMatrix = mat4(m0, m1, m2, m3);\n}\nvoid decodeClusterLightShadowData(inout ClusterLightData clusterLightData) {\n\t\n\tvec2 biases = unpackHalf2x16(floatBitsToUint(clusterLightData.biasesData));\n\tclusterLightData.shadowBias = biases.x;\n\tclusterLightData.shadowNormalBias = biases.y;\n}\nvoid decodeClusterLightCookieData(inout ClusterLightData clusterLightData) {\n\tuint cookieFlags = (clusterLightData.flags >> 23u) & 0x0Fu;\n\tclusterLightData.cookieChannelMask = vec4(uvec4(cookieFlags) & uvec4(1u, 2u, 4u, 8u));\n\tclusterLightData.cookieChannelMask = step(1.0, clusterLightData.cookieChannelMask);\n}\nvoid evaluateLight(\n\tClusterLightData light, \n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tvec3 reflectionDir,\n#if defined(LIT_CLEARCOAT)\n\tvec3 clearcoatReflectionDir,\n#endif\n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 geometricNormal, \n\tmat3 tbn, \n#if defined(LIT_IRIDESCENCE)\n\tvec3 iridescenceFresnel,\n#endif\n\tvec3 clearcoat_worldNormal,\n\tfloat clearcoat_gloss,\n\tfloat sheen_gloss,\n\tfloat iridescence_intensity\n) {\n\tvec3 cookieAttenuation = vec3(1.0);\n\tfloat diffuseAttenuation = 1.0;\n\tfloat falloffAttenuation = 1.0;\n\tvec3 lightDirW;\n\tvec3 lightDirNormW;\n\tevalOmniLight(light.position, lightDirW, lightDirNormW);\n\t#ifdef CLUSTER_AREALIGHTS\n\tif (light.shape != {LIGHTSHAPE_PUNCTUAL}) {\n\t\tdecodeClusterLightAreaData(light);\n\t\tif (light.shape == {LIGHTSHAPE_RECT}) {\n\t\t\tcalcRectLightValues(light.position, light.halfWidth, light.halfHeight);\n\t\t} else if (light.shape == {LIGHTSHAPE_DISK}) {\n\t\t\tcalcDiskLightValues(light.position, light.halfWidth, light.halfHeight);\n\t\t} else {\n\t\t\tcalcSphereLightValues(light.position, light.halfWidth, light.halfHeight);\n\t\t}\n\t\tfalloffAttenuation = getFalloffWindow(light.range, lightDirW);\n\t} else\n\t#endif\n\t{\n\t\tif (light.falloffModeLinear)\n\t\t\tfalloffAttenuation = getFalloffLinear(light.range, lightDirW);\n\t\telse\n\t\t\tfalloffAttenuation = getFalloffInvSquared(light.range, lightDirW);\n\t}\n\tif (falloffAttenuation > 0.00001) {\n\t\t#ifdef CLUSTER_AREALIGHTS\n\t\tif (light.shape != {LIGHTSHAPE_PUNCTUAL}) {\n\t\t\tif (light.shape == {LIGHTSHAPE_RECT}) {\n\t\t\t\tdiffuseAttenuation = getRectLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;\n\t\t\t} else if (light.shape == {LIGHTSHAPE_DISK}) {\n\t\t\t\tdiffuseAttenuation = getDiskLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;\n\t\t\t} else {\n\t\t\t\tdiffuseAttenuation = getSphereLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;\n\t\t\t}\n\t\t} else\n\t\t#endif\n\t\t{\n\t\t\tfalloffAttenuation *= getLightDiffuse(worldNormal, viewDir, lightDirNormW); \n\t\t}\n\t\tif (light.isSpot) {\n\t\t\tdecodeClusterLightSpot(light);\n\t\t\tfalloffAttenuation *= getSpotEffect(light.direction, light.innerConeAngleCos, light.outerConeAngleCos, lightDirNormW);\n\t\t}\n\t\t#if defined(CLUSTER_COOKIES) || defined(CLUSTER_SHADOWS)\n\t\tif (falloffAttenuation > 0.00001) {\n\t\t\tif (light.shadowIntensity > 0.0 || light.cookieIntensity > 0.0) {\n\t\t\t\tif (light.isSpot) {\n\t\t\t\t\tdecodeClusterLightProjectionMatrixData(light);\n\t\t\t\t} else {\n\t\t\t\t\tdecodeClusterLightOmniAtlasViewport(light);\n\t\t\t\t}\n\t\t\t\tfloat shadowTextureResolution = shadowAtlasParams.x;\n\t\t\t\tfloat shadowEdgePixels = shadowAtlasParams.y;\n\t\t\t\t#ifdef CLUSTER_COOKIES\n\t\t\t\tif (light.cookieIntensity > 0.0) {\n\t\t\t\t\tdecodeClusterLightCookieData(light);\n\t\t\t\t\tif (light.isSpot) {\n\t\t\t\t\t\tcookieAttenuation = getCookie2DClustered(TEXTURE_PASS(cookieAtlasTexture), lightProjectionMatrix, vPositionW, light.cookieIntensity, light.cookieChannelMask);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tcookieAttenuation = getCookieCubeClustered(TEXTURE_PASS(cookieAtlasTexture), lightDirW, light.cookieIntensity, light.cookieChannelMask, shadowTextureResolution, shadowEdgePixels, light.omniAtlasViewport);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t#endif\n\t\t\t\t#ifdef CLUSTER_SHADOWS\n\t\t\t\tif (light.shadowIntensity > 0.0) {\n\t\t\t\t\tdecodeClusterLightShadowData(light);\n\t\t\t\t\tvec4 shadowParams = vec4(shadowTextureResolution, light.shadowNormalBias, light.shadowBias, 1.0 / light.range);\n\t\t\t\t\tif (light.isSpot) {\n\t\t\t\t\t\tvec3 shadowCoord = getShadowCoordPerspZbufferNormalOffset(lightProjectionMatrix, shadowParams, geometricNormal);\n\t\t\t\t\t\t\n\t\t\t\t\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\t\t\t\t\t\t\tfloat shadow = getShadowSpotClusteredPCF1(SHADOWMAP_PASS(shadowAtlasTexture), shadowCoord, shadowParams);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF3)\n\t\t\t\t\t\t\tfloat shadow = getShadowSpotClusteredPCF3(SHADOWMAP_PASS(shadowAtlasTexture), shadowCoord, shadowParams);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF5)\n\t\t\t\t\t\t\tfloat shadow = getShadowSpotClusteredPCF5(SHADOWMAP_PASS(shadowAtlasTexture), shadowCoord, shadowParams);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCSS)\n\t\t\t\t\t\t\tfloat shadow = getShadowSpotClusteredPCSS(SHADOWMAP_PASS(shadowAtlasTexture), shadowCoord, shadowParams);\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\tfalloffAttenuation *= mix(1.0, shadow, light.shadowIntensity);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tvec3 dir = normalOffsetPointShadow(shadowParams, light.position, lightDirW, lightDirNormW, geometricNormal);\n\t\t\t\t\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\t\t\t\t\t\t\tfloat shadow = getShadowOmniClusteredPCF1(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF3)\n\t\t\t\t\t\t\tfloat shadow = getShadowOmniClusteredPCF3(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF5)\n\t\t\t\t\t\t\tfloat shadow = getShadowOmniClusteredPCF5(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\tfalloffAttenuation *= mix(1.0, shadow, light.shadowIntensity);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t#endif\n\t\t\t}\n\t\t}\n\t\t#endif\n\t\t#ifdef CLUSTER_AREALIGHTS\n\t\tif (light.shape != {LIGHTSHAPE_PUNCTUAL}) {\n\t\t\t{\n\t\t\t\tvec3 areaDiffuse = (diffuseAttenuation * falloffAttenuation) * light.color * cookieAttenuation;\n\t\t\t\t#if defined(LIT_SPECULAR)\n\t\t\t\t\tareaDiffuse = mix(areaDiffuse, vec3(0), dLTCSpecFres);\n\t\t\t\t#endif\n\t\t\t\tdDiffuseLight += areaDiffuse;\n\t\t\t}\n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\tfloat areaLightSpecular;\n\t\t\t\tif (light.shape == {LIGHTSHAPE_RECT}) {\n\t\t\t\t\tareaLightSpecular = getRectLightSpecular(worldNormal, viewDir);\n\t\t\t\t} else if (light.shape == {LIGHTSHAPE_DISK}) {\n\t\t\t\t\tareaLightSpecular = getDiskLightSpecular(worldNormal, viewDir);\n\t\t\t\t} else {\n\t\t\t\t\tareaLightSpecular = getSphereLightSpecular(worldNormal, viewDir);\n\t\t\t\t}\n\t\t\t\tdSpecularLight += dLTCSpecFres * areaLightSpecular * falloffAttenuation * light.color * cookieAttenuation;\n\t\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\t\tfloat areaLightSpecularCC;\n\t\t\t\t\tif (light.shape == {LIGHTSHAPE_RECT}) {\n\t\t\t\t\t\tareaLightSpecularCC = getRectLightSpecular(clearcoat_worldNormal, viewDir);\n\t\t\t\t\t} else if (light.shape == {LIGHTSHAPE_DISK}) {\n\t\t\t\t\t\tareaLightSpecularCC = getDiskLightSpecular(clearcoat_worldNormal, viewDir);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tareaLightSpecularCC = getSphereLightSpecular(clearcoat_worldNormal, viewDir);\n\t\t\t\t\t}\n\t\t\t\t\tccSpecularLight += ccLTCSpecFres * areaLightSpecularCC * falloffAttenuation * light.color  * cookieAttenuation;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t} else\n\t\t#endif\n\t\t{\n\t\t\t{\n\t\t\t\tvec3 punctualDiffuse = falloffAttenuation * light.color * cookieAttenuation;\n\t\t\t\t#if defined(CLUSTER_AREALIGHTS)\n\t\t\t\t#if defined(LIT_SPECULAR)\n\t\t\t\t\tpunctualDiffuse = mix(punctualDiffuse, vec3(0), specularity);\n\t\t\t\t#endif\n\t\t\t\t#endif\n\t\t\t\tdDiffuseLight += punctualDiffuse;\n\t\t\t}\n   \n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\tvec3 halfDir = normalize(-lightDirNormW + viewDir);\n\t\t\t\t\n\t\t\t\t#ifdef LIT_SPECULAR_FRESNEL\n\t\t\t\t\tdSpecularLight += \n\t\t\t\t\t\tgetLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, lightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * \n\t\t\t\t\t\tgetFresnel(\n\t\t\t\t\t\t\tdot(viewDir, halfDir), \n\t\t\t\t\t\t\tgloss, \n\t\t\t\t\t\t\tspecularity\n\t\t\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\t\t, iridescenceFresnel,\n\t\t\t\t\t\t\tiridescence_intensity\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t);\n\t\t\t\t#else\n\t\t\t\t\tdSpecularLight += getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, lightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * specularity;\n\t\t\t\t#endif\n\t\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\t\t#ifdef LIT_SPECULAR_FRESNEL\n\t\t\t\t\t\tccSpecularLight += getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, lightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * getFresnelCC(dot(viewDir, halfDir));\n\t\t\t\t\t#else\n\t\t\t\t\t\tccSpecularLight += getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, lightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation; \n\t\t\t\t\t#endif\n\t\t\t\t#endif\n\t\t\t\t#ifdef LIT_SHEEN\n\t\t\t\t\tsSpecularLight += getLightSpecularSheen(halfDir, worldNormal, viewDir, lightDirNormW, sheen_gloss) * falloffAttenuation * light.color * cookieAttenuation;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t}\n\t}\n\tdAtten = falloffAttenuation;\n\tdLightDirNormW = lightDirNormW;\n}\nvoid evaluateClusterLight(\n\tfloat lightIndex, \n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tvec3 reflectionDir, \n#if defined(LIT_CLEARCOAT)\n\tvec3 clearcoatReflectionDir,\n#endif\n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 geometricNormal, \n\tmat3 tbn, \n#if defined(LIT_IRIDESCENCE)\n\tvec3 iridescenceFresnel,\n#endif\n\tvec3 clearcoat_worldNormal,\n\tfloat clearcoat_gloss,\n\tfloat sheen_gloss,\n\tfloat iridescence_intensity\n) {\n\tClusterLightData clusterLightData;\n\tdecodeClusterLightCore(clusterLightData, lightIndex);\n\t#ifdef CLUSTER_MESH_DYNAMIC_LIGHTS\n\t\tbool acceptLightMask = clusterLightData.isDynamic;\n\t#else\n\t\tbool acceptLightMask = clusterLightData.isLightmapped;\n\t#endif\n\tif (acceptLightMask)\n\t\tevaluateLight(\n\t\t\tclusterLightData, \n\t\t\tworldNormal, \n\t\t\tviewDir, \n\t\t\treflectionDir, \n#if defined(LIT_CLEARCOAT)\n\t\t\tclearcoatReflectionDir, \n#endif\n\t\t\tgloss, \n\t\t\tspecularity, \n\t\t\tgeometricNormal, \n\t\t\ttbn, \n#if defined(LIT_IRIDESCENCE)\n\t\t\tiridescenceFresnel,\n#endif\n\t\t\tclearcoat_worldNormal,\n\t\t\tclearcoat_gloss,\n\t\t\tsheen_gloss,\n\t\t\tiridescence_intensity\n\t\t);\n}\nvoid addClusteredLights(\n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tvec3 reflectionDir, \n#if defined(LIT_CLEARCOAT)\n\tvec3 clearcoatReflectionDir,\n#endif\n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 geometricNormal, \n\tmat3 tbn, \n#if defined(LIT_IRIDESCENCE)\n\tvec3 iridescenceFresnel,\n#endif\n\tvec3 clearcoat_worldNormal,\n\tfloat clearcoat_gloss,\n\tfloat sheen_gloss,\n\tfloat iridescence_intensity\n) {\n\tif (clusterSkip > 0.5)\n\t\treturn;\n\tvec3 cellCoords = floor((vPositionW - clusterBoundsMin) * clusterCellsCountByBoundsSize);\n\tif (!(any(lessThan(cellCoords, vec3(0.0))) || any(greaterThanEqual(cellCoords, clusterCellsMax)))) {\n\t\tfloat cellIndex = dot(clusterCellsDot, cellCoords);\n\t\tfloat clusterV = floor(cellIndex * clusterTextureSize.y);\n\t\tfloat clusterU = cellIndex - (clusterV * clusterTextureSize.x);\n\t\tfor (int lightCellIndex = 0; lightCellIndex < clusterMaxCells; lightCellIndex++) {\n\t\t\tfloat lightIndex = texelFetch(clusterWorldTexture, ivec2(int(clusterU) + lightCellIndex, clusterV), 0).x;\n\t\t\tif (lightIndex <= 0.0)\n\t\t\t\t\treturn;\n\t\t\tevaluateClusterLight(\n\t\t\t\tlightIndex * 255.0, \n\t\t\t\tworldNormal, \n\t\t\t\tviewDir, \n\t\t\t\treflectionDir,\n#if defined(LIT_CLEARCOAT)\n\t\t\t\tclearcoatReflectionDir,\n#endif\n\t\t\t\tgloss, \n\t\t\t\tspecularity, \n\t\t\t\tgeometricNormal, \n\t\t\t\ttbn, \n#if defined(LIT_IRIDESCENCE)\n\t\t\t\tiridescenceFresnel,\n#endif\n\t\t\t\tclearcoat_worldNormal,\n\t\t\t\tclearcoat_gloss,\n\t\t\t\tsheen_gloss,\n\t\t\t\tiridescence_intensity\n\t\t\t); \n\t\t}\n\t}\n}\n',combinePS:"\nvec3 combineColor(vec3 albedo, vec3 sheenSpecularity, float clearcoatSpecularity) {\n\tvec3 ret = vec3(0);\n#ifdef LIT_OLD_AMBIENT\n\tret += (dDiffuseLight - light_globalAmbient) * albedo + material_ambient * light_globalAmbient;\n#else\n\tret += albedo * dDiffuseLight;\n#endif\n#ifdef LIT_SPECULAR\n\tret += dSpecularLight;\n#endif\n#ifdef LIT_REFLECTIONS\n\tret += dReflection.rgb * dReflection.a;\n#endif\n#ifdef LIT_SHEEN\n\tfloat sheenScaling = 1.0 - max(max(sheenSpecularity.r, sheenSpecularity.g), sheenSpecularity.b) * 0.157;\n\tret = ret * sheenScaling + (sSpecularLight + sReflection.rgb) * sheenSpecularity;\n#endif\n#ifdef LIT_CLEARCOAT\n\tfloat clearCoatScaling = 1.0 - ccFresnel * clearcoatSpecularity;\n\tret = ret * clearCoatScaling + (ccSpecularLight + ccReflection.rgb) * clearcoatSpecularity;\n#endif\n\treturn ret;\n}\n",cookieBlit2DPS:"\n\tvarying vec2 uv0;\n\tuniform sampler2D blitTexture;\n\tvoid main(void) {\n\t\tgl_FragColor = texture2D(blitTexture, uv0);\n\t}\n",cookieBlitCubePS:"\n\tvarying vec2 uv0;\n\tuniform samplerCube blitTexture;\n\tuniform mat4 invViewProj;\n\tvoid main(void) {\n\t\tvec4 projPos = vec4(uv0 * 2.0 - 1.0, 0.5, 1.0);\n\t\tvec4 worldPos = invViewProj * projPos;\n\t\tgl_FragColor = textureCube(blitTexture, worldPos.xyz);\n\t}\n",cookieBlitVS:"\n\tattribute vec2 vertex_position;\n\tvarying vec2 uv0;\n\tvoid main(void) {\n\t\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\t\tuv0 = vertex_position.xy * 0.5 + 0.5;\n\t\t#ifndef WEBGPU\n\t\t\tuv0.y = 1.0 - uv0.y;\n\t\t#endif\n\t}\n",cookiePS:"\nvec4 getCookie2D(sampler2D tex, mat4 transform, float intensity) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\treturn mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DClip(sampler2D tex, mat4 transform, float intensity) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tif (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n\treturn mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tprojPos.xy += cookieOffset;\n\tvec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n\treturn mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookie2DClipXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tprojPos.xy += cookieOffset;\n\tif (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n\tvec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n\treturn mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookieCube(samplerCube tex, mat4 transform, float intensity) {\n\treturn mix(vec4(1.0), textureCube(tex, dLightDirNormW * mat3(transform)), intensity);\n}\n",cubeMapProjectPS:"\n#if LIT_CUBEMAP_PROJECTION == BOX\n\tuniform vec3 envBoxMin;\n\tuniform vec3 envBoxMax;\n#endif\nvec3 cubeMapProject(vec3 nrdir) {\n\t#if LIT_CUBEMAP_PROJECTION == NONE\n\t\treturn cubeMapRotate(nrdir);\n\t#endif\n\t#if LIT_CUBEMAP_PROJECTION == BOX\n\t\tnrdir = cubeMapRotate(nrdir);\n\t\tvec3 rbmax = (envBoxMax - vPositionW) / nrdir;\n\t\tvec3 rbmin = (envBoxMin - vPositionW) / nrdir;\n\t\tvec3 rbminmax;\n\t\trbminmax.x = nrdir.x>0.0? rbmax.x : rbmin.x;\n\t\trbminmax.y = nrdir.y>0.0? rbmax.y : rbmin.y;\n\t\trbminmax.z = nrdir.z>0.0? rbmax.z : rbmin.z;\n\t\tfloat fa = min(min(rbminmax.x, rbminmax.y), rbminmax.z);\n\t\tvec3 posonbox = vPositionW + nrdir * fa;\n\t\tvec3 envBoxPos = (envBoxMin + envBoxMax) * 0.5;\n\t\treturn normalize(posonbox - envBoxPos);\n\t#endif\n}\n",cubeMapRotatePS:"\n#ifdef CUBEMAP_ROTATION\nuniform mat3 cubeMapRotationMatrix;\n#endif\nvec3 cubeMapRotate(vec3 refDir) {\n#ifdef CUBEMAP_ROTATION\n\treturn refDir * cubeMapRotationMatrix;\n#else\n\treturn refDir;\n#endif\n}\n",debugOutputPS:"\n#ifdef DEBUG_ALBEDO_PASS\ngl_FragColor = vec4(gammaCorrectOutput(dAlbedo), 1.0);\n#endif\n#ifdef DEBUG_UV0_PASS\ngl_FragColor = vec4(litArgs_albedo , 1.0);\n#endif\n#ifdef DEBUG_WORLD_NORMAL_PASS\ngl_FragColor = vec4(litArgs_worldNormal * 0.5 + 0.5, 1.0);\n#endif\n#ifdef DEBUG_OPACITY_PASS\ngl_FragColor = vec4(vec3(litArgs_opacity) , 1.0);\n#endif\n#ifdef DEBUG_SPECULARITY_PASS\ngl_FragColor = vec4(litArgs_specularity, 1.0);\n#endif\n#ifdef DEBUG_GLOSS_PASS\ngl_FragColor = vec4(vec3(litArgs_gloss) , 1.0);\n#endif\n#ifdef DEBUG_METALNESS_PASS\ngl_FragColor = vec4(vec3(litArgs_metalness) , 1.0);\n#endif\n#ifdef DEBUG_AO_PASS\ngl_FragColor = vec4(vec3(litArgs_ao) , 1.0);\n#endif\n#ifdef DEBUG_EMISSION_PASS\ngl_FragColor = vec4(gammaCorrectOutput(litArgs_emission), 1.0);\n#endif\n",debugProcessFrontendPS:"\n#ifdef DEBUG_LIGHTING_PASS\nlitArgs_albedo = vec3(0.5);\n#endif\n#ifdef DEBUG_UV0_PASS\n#ifdef VARYING_VUV0\nlitArgs_albedo = vec3(vUv0, 0);\n#else\nlitArgs_albedo = vec3(0);\n#endif\n#endif\n",detailModesPS:"\n#ifndef _DETAILMODES_INCLUDED_\n#define _DETAILMODES_INCLUDED_\nvec3 detailMode_mul(vec3 c1, vec3 c2) {\n\treturn c1 * c2;\n}\nvec3 detailMode_add(vec3 c1, vec3 c2) {\n\treturn c1 + c2;\n}\nvec3 detailMode_screen(vec3 c1, vec3 c2) {\n\treturn 1.0 - (1.0 - c1)*(1.0 - c2);\n}\nvec3 detailMode_overlay(vec3 c1, vec3 c2) {\n\treturn mix(1.0 - 2.0*(1.0 - c1)*(1.0 - c2), 2.0*c1*c2, step(c1, vec3(0.5)));\n}\nvec3 detailMode_min(vec3 c1, vec3 c2) {\n\treturn min(c1, c2);\n}\nvec3 detailMode_max(vec3 c1, vec3 c2) {\n\treturn max(c1, c2);\n}\n#endif\n",diffusePS:'\nuniform vec3 material_diffuse;\n#ifdef STD_DIFFUSEDETAIL_TEXTURE\n\t#include "detailModesPS"\n#endif\nvoid getAlbedo() {\n\tdAlbedo = material_diffuse.rgb;\n\t#ifdef STD_DIFFUSE_TEXTURE\n\t\tvec3 albedoTexture = {STD_DIFFUSE_TEXTURE_DECODE}(texture2DBias({STD_DIFFUSE_TEXTURE_NAME}, {STD_DIFFUSE_TEXTURE_UV}, textureBias)).{STD_DIFFUSE_TEXTURE_CHANNEL};\n\t\t#ifdef STD_DIFFUSEDETAIL_TEXTURE\n\t\t\tvec3 albedoDetail = {STD_DIFFUSEDETAIL_TEXTURE_DECODE}(texture2DBias({STD_DIFFUSEDETAIL_TEXTURE_NAME}, {STD_DIFFUSEDETAIL_TEXTURE_UV}, textureBias)).{STD_DIFFUSEDETAIL_TEXTURE_CHANNEL};\n\t\t\talbedoTexture = detailMode_{STD_DIFFUSEDETAIL_DETAILMODE}(albedoTexture, albedoDetail);\n\t\t#endif\n\t\tdAlbedo *= albedoTexture;\n\t#endif\n\t#ifdef STD_DIFFUSE_VERTEX\n\t\tdAlbedo *= gammaCorrectInput(saturate(vVertexColor.{STD_DIFFUSE_VERTEX_CHANNEL}));\n\t#endif\n}\n',decodePS:"\n#ifndef _DECODE_INCLUDED_\n#define _DECODE_INCLUDED_\nvec3 decodeLinear(vec4 raw) {\n\treturn raw.rgb;\n}\nfloat decodeGamma(float raw) {\n\treturn pow(raw, 2.2);\n}\nvec3 decodeGamma(vec3 raw) {\n\treturn pow(raw, vec3(2.2));\n}\nvec3 decodeGamma(vec4 raw) {\n\treturn pow(raw.xyz, vec3(2.2));\n}\nvec3 decodeRGBM(vec4 raw) {\n\tvec3 color = (8.0 * raw.a) * raw.rgb;\n\treturn color * color;\n}\nvec3 decodeRGBP(vec4 raw) {\n\tvec3 color = raw.rgb * (-raw.a * 7.0 + 8.0);\n\treturn color * color;\n}\nvec3 decodeRGBE(vec4 raw) {\n\tif (raw.a == 0.0) {\n\t\treturn vec3(0.0, 0.0, 0.0);\n\t} else {\n\t\treturn raw.xyz * pow(2.0, raw.w * 255.0 - 128.0);\n\t}\n}\nvec4 passThrough(vec4 raw) {\n\treturn raw;\n}\nvec3 unpackNormalXYZ(vec4 nmap) {\n\treturn nmap.xyz * 2.0 - 1.0;\n}\nvec3 unpackNormalXY(vec4 nmap) {\n\tvec3 normal;\n\tnormal.xy = nmap.wy * 2.0 - 1.0;\n\tnormal.z = sqrt(1.0 - clamp(dot(normal.xy, normal.xy), 0.0, 1.0));\n\treturn normal;\n}\n#endif\n",emissivePS:"\nuniform vec3 material_emissive;\nuniform float material_emissiveIntensity;\nvoid getEmission() {\n\tdEmission = material_emissive * material_emissiveIntensity;\n\t#ifdef STD_EMISSIVE_TEXTURE\n\tdEmission *= {STD_EMISSIVE_TEXTURE_DECODE}(texture2DBias({STD_EMISSIVE_TEXTURE_NAME}, {STD_EMISSIVE_TEXTURE_UV}, textureBias)).{STD_EMISSIVE_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_EMISSIVE_VERTEX\n\tdEmission *= gammaCorrectInput(saturate(vVertexColor.{STD_EMISSIVE_VERTEX_CHANNEL}));\n\t#endif\n}\n",encodePS:"\nvec4 encodeLinear(vec3 source) {\n\treturn vec4(source, 1.0);\n}\nvec4 encodeGamma(vec3 source) {\n\treturn vec4(pow(source + 0.0000001, vec3(1.0 / 2.2)), 1.0);\n}\nvec4 encodeRGBM(vec3 source) {\n\tvec4 result;\n\tresult.rgb = pow(source.rgb, vec3(0.5));\n\tresult.rgb *= 1.0 / 8.0;\n\tresult.a = saturate( max( max( result.r, result.g ), max( result.b, 1.0 / 255.0 ) ) );\n\tresult.a = ceil(result.a * 255.0) / 255.0;\n\tresult.rgb /= result.a;\n\treturn result;\n}\nvec4 encodeRGBP(vec3 source) {\n\tvec3 gamma = pow(source, vec3(0.5));\n\tfloat maxVal = min(8.0, max(1.0, max(gamma.x, max(gamma.y, gamma.z))));\n\tfloat v = 1.0 - ((maxVal - 1.0) / 7.0);\n\tv = ceil(v * 255.0) / 255.0;\n\treturn vec4(gamma / (-v * 7.0 + 8.0), v);\t\n}\nvec4 encodeRGBE(vec3 source) {\n\tfloat maxVal = max(source.x, max(source.y, source.z));\n\tif (maxVal < 1e-32) {\n\t\treturn vec4(0, 0, 0, 0);\n\t} else {\n\t\tfloat e = ceil(log2(maxVal));\n\t\treturn vec4(source / pow(2.0, e), (e + 128.0) / 255.0);\n\t}\n}\n",endPS:"\n\tgl_FragColor.rgb = combineColor(litArgs_albedo, litArgs_sheen_specularity, litArgs_clearcoat_specularity);\n\tgl_FragColor.rgb += litArgs_emission;\n\tgl_FragColor.rgb = addFog(gl_FragColor.rgb);\n\tgl_FragColor.rgb = toneMap(gl_FragColor.rgb);\n\tgl_FragColor.rgb = gammaCorrectOutput(gl_FragColor.rgb);\n",envAtlasPS:"\n#ifndef _ENVATLAS_INCLUDED_\n#define _ENVATLAS_INCLUDED_\nconst float atlasSize = 512.0;\nconst float seamSize = 1.0 / atlasSize;\nvec2 mapUv(vec2 uv, vec4 rect) {\n\treturn vec2(mix(rect.x + seamSize, rect.x + rect.z - seamSize, uv.x),\n\t\t\t\tmix(rect.y + seamSize, rect.y + rect.w - seamSize, uv.y));\n}\nvec2 mapRoughnessUv(vec2 uv, float level) {\n\tfloat t = 1.0 / exp2(level);\n\treturn mapUv(uv, vec4(0, 1.0 - t, t, t * 0.5));\n}\nvec2 mapShinyUv(vec2 uv, float level) {\n\tfloat t = 1.0 / exp2(level);\n\treturn mapUv(uv, vec4(1.0 - t, 1.0 - t, t, t * 0.5));\n}\n#endif\n",envProcPS:"\n#ifdef LIT_SKYBOX_INTENSITY\n\tuniform float skyboxIntensity;\n#endif\nvec3 processEnvironment(vec3 color) {\n\t#ifdef LIT_SKYBOX_INTENSITY\n\t\treturn color * skyboxIntensity;\n\t#else\n\t\treturn color;\n\t#endif\n}\n",falloffInvSquaredPS:"\nfloat getFalloffWindow(float lightRadius, vec3 lightDir) {\n\tfloat sqrDist = dot(lightDir, lightDir);\n\tfloat invRadius = 1.0 / lightRadius;\n\treturn square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n}\nfloat getFalloffInvSquared(float lightRadius, vec3 lightDir) {\n\tfloat sqrDist = dot(lightDir, lightDir);\n\tfloat falloff = 1.0 / (sqrDist + 1.0);\n\tfloat invRadius = 1.0 / lightRadius;\n\tfalloff *= 16.0;\n\tfalloff *= square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n\treturn falloff;\n}\n",falloffLinearPS:"\nfloat getFalloffLinear(float lightRadius, vec3 lightDir) {\n\tfloat d = length(lightDir);\n\treturn max(((lightRadius - d) / lightRadius), 0.0);\n}\n",floatAsUintPS:"\n#ifndef FLOAT_AS_UINT\n#define FLOAT_AS_UINT\nvec4 float2uint(float value) {\n\tuint intBits = floatBitsToUint(value);\n\treturn vec4(\n\t\tfloat((intBits >> 24u) & 0xFFu) / 255.0,\n\t\tfloat((intBits >> 16u) & 0xFFu) / 255.0,\n\t\tfloat((intBits >> 8u) & 0xFFu) / 255.0,\n\t\tfloat(intBits & 0xFFu) / 255.0\n\t);\n}\nfloat uint2float(vec4 value) {\n\tuint intBits = \n\t\t(uint(value.r * 255.0) << 24u) |\n\t\t(uint(value.g * 255.0) << 16u) |\n\t\t(uint(value.b * 255.0) << 8u) |\n\t\tuint(value.a * 255.0);\n\treturn uintBitsToFloat(intBits);\n}\nvec4 float2vec4(float value) {\n\t#if defined(CAPS_TEXTURE_FLOAT_RENDERABLE)\n\t\treturn vec4(value, 1.0, 1.0, 1.0);\n\t#else\n\t\treturn float2uint(value);\n\t#endif\n}\n#endif\n",fogPS:"\nfloat dBlendModeFogFactor = 1.0;\n#if (FOG != NONE)\n\tuniform vec3 fog_color;\n\t#if (FOG == LINEAR)\n\t\tuniform float fog_start;\n\t\tuniform float fog_end;\n\t#else\n\t\tuniform float fog_density;\n\t#endif\n#endif\nfloat getFogFactor() {\n\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\tfloat fogFactor = 0.0;\n\t#if (FOG == LINEAR)\n\t\tfogFactor = (fog_end - depth) / (fog_end - fog_start);\n\t#elif (FOG == EXP)\n\t\tfogFactor = exp(-depth * fog_density);\n\t#elif (FOG == EXP2)\n\t\tfogFactor = exp(-depth * depth * fog_density * fog_density);\n\t#endif\n\treturn clamp(fogFactor, 0.0, 1.0);\n}\nvec3 addFog(vec3 color) {\n\t#if (FOG != NONE)\n\t\treturn mix(fog_color * dBlendModeFogFactor, color, getFogFactor());\n\t#endif\n\treturn color;\n}\n",fresnelSchlickPS:"\nvec3 getFresnel(\n\t\tfloat cosTheta, \n\t\tfloat gloss, \n\t\tvec3 specularity\n#if defined(LIT_IRIDESCENCE)\n\t\t, vec3 iridescenceFresnel, \n\t\tfloat iridescenceIntensity\n#endif\n\t) {\n\tfloat fresnel = pow(1.0 - max(cosTheta, 0.0), 5.0);\n\tfloat glossSq = gloss * gloss;\n\tvec3 ret = specularity + (max(vec3(glossSq), specularity) - specularity) * fresnel;\n#if defined(LIT_IRIDESCENCE)\n\treturn mix(ret, iridescenceFresnel, iridescenceIntensity);\n#else\n\treturn ret;\n#endif\t\n}\nfloat getFresnelCC(float cosTheta) {\n\tfloat fresnel = pow(1.0 - max(cosTheta, 0.0), 5.0);\n\treturn 0.04 + (1.0 - 0.04) * fresnel;\n}\n",fullscreenQuadPS:"\nvarying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n\tgl_FragColor = texture2D(source, vUv0);\n}\n",fullscreenQuadVS:"\nattribute vec2 vertex_position;\nvarying vec2 vUv0;\nvoid main(void)\n{\n\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\tvUv0 = vertex_position.xy*0.5+0.5;\n}\n",gammaPS:'\n#include "decodePS"\n#if (GAMMA == SRGB)\n\tfloat gammaCorrectInput(float color) {\n\t\treturn decodeGamma(color);\n\t}\n\tvec3 gammaCorrectInput(vec3 color) {\n\t\treturn decodeGamma(color);\n\t}\n\tvec4 gammaCorrectInput(vec4 color) {\n\t\treturn vec4(decodeGamma(color.xyz), color.w);\n\t}\n\tvec3 gammaCorrectOutput(vec3 color) {\n\t\treturn pow(color + 0.0000001, vec3(1.0 / 2.2));\n\t}\n#else\n\tfloat gammaCorrectInput(float color) {\n\t\treturn color;\n\t}\n\tvec3 gammaCorrectInput(vec3 color) {\n\t\treturn color;\n\t}\n\tvec4 gammaCorrectInput(vec4 color) {\n\t\treturn color;\n\t}\n\tvec3 gammaCorrectOutput(vec3 color) {\n\t\treturn color;\n\t}\n#endif\n',gles3PS:Ta,gles3VS:Ca,glossPS:"\n#ifdef STD_GLOSS_CONSTANT\nuniform float material_gloss;\n#endif\nvoid getGlossiness() {\n\tdGlossiness = 1.0;\n\t#ifdef STD_GLOSS_CONSTANT\n\tdGlossiness *= material_gloss;\n\t#endif\n\t#ifdef STD_GLOSS_TEXTURE\n\tdGlossiness *= texture2DBias({STD_GLOSS_TEXTURE_NAME}, {STD_GLOSS_TEXTURE_UV}, textureBias).{STD_GLOSS_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_GLOSS_VERTEX\n\tdGlossiness *= saturate(vVertexColor.{STD_GLOSS_VERTEX_CHANNEL});\n\t#endif\n\t#ifdef STD_GLOSS_INVERT\n\tdGlossiness = 1.0 - dGlossiness;\n\t#endif\n\tdGlossiness += 0.0000001;\n}\n",gsplatCenterVS:"\nuniform mat4 matrix_model;\nuniform mat4 matrix_view;\nuniform mat4 matrix_projection;\nbool initCenter(vec3 modelCenter, out SplatCenter center) {\n\tmat4 modelView = matrix_view * matrix_model;\n\tvec4 centerView = modelView * vec4(modelCenter, 1.0);\n\tif (centerView.z > 0.0) {\n\t\treturn false;\n\t}\n\tvec4 centerProj = matrix_projection * centerView;\n#if WEBGPU\n\tcenterProj.z = clamp(centerProj.z, 0, abs(centerProj.w));\n#else\n\tcenterProj.z = clamp(centerProj.z, -abs(centerProj.w), abs(centerProj.w));\n#endif\n\tcenter.view = centerView.xyz / centerView.w;\n\tcenter.proj = centerProj;\n\tcenter.projMat00 = matrix_projection[0][0];\n\tcenter.modelView = modelView;\n\treturn true;\n}\n",gsplatCornerVS:"\nuniform vec2 viewport;\nuniform vec4 camera_params;\nbool initCorner(SplatSource source, SplatCenter center, out SplatCorner corner) {\n\tvec3 covA, covB;\n\treadCovariance(source, covA, covB);\n\tmat3 Vrk = mat3(\n\t\tcovA.x, covA.y, covA.z, \n\t\tcovA.y, covB.x, covB.y,\n\t\tcovA.z, covB.y, covB.z\n\t);\n\tfloat focal = viewport.x * center.projMat00;\n\tvec3 v = camera_params.w == 1.0 ? vec3(0.0, 0.0, 1.0) : center.view.xyz;\n\tfloat J1 = focal / v.z;\n\tvec2 J2 = -J1 / v.z * v.xy;\n\tmat3 J = mat3(\n\t\tJ1, 0.0, J2.x, \n\t\t0.0, J1, J2.y, \n\t\t0.0, 0.0, 0.0\n\t);\n\tmat3 W = transpose(mat3(center.modelView));\n\tmat3 T = W * J;\n\tmat3 cov = transpose(T) * Vrk * T;\n\t#if GSPLAT_AA\n\t\tfloat detOrig = cov[0][0] * cov[1][1] - cov[0][1] * cov[0][1];\n\t\tfloat detBlur = (cov[0][0] + 0.3) * (cov[1][1] + 0.3) - cov[0][1] * cov[0][1];\n\t\tcorner.aaFactor = sqrt(max(detOrig / detBlur, 0.0));\n\t#endif\n\tfloat diagonal1 = cov[0][0] + 0.3;\n\tfloat offDiagonal = cov[0][1];\n\tfloat diagonal2 = cov[1][1] + 0.3;\n\tfloat mid = 0.5 * (diagonal1 + diagonal2);\n\tfloat radius = length(vec2((diagonal1 - diagonal2) / 2.0, offDiagonal));\n\tfloat lambda1 = mid + radius;\n\tfloat lambda2 = max(mid - radius, 0.1);\n\tfloat l1 = 2.0 * min(sqrt(2.0 * lambda1), 1024.0);\n\tfloat l2 = 2.0 * min(sqrt(2.0 * lambda2), 1024.0);\n\tif (l1 < 2.0 && l2 < 2.0) {\n\t\treturn false;\n\t}\n\tvec2 c = center.proj.ww / viewport;\n\tif (any(greaterThan(abs(center.proj.xy) - vec2(max(l1, l2)) * c, center.proj.ww))) {\n\t\treturn false;\n\t}\n\tvec2 diagonalVector = normalize(vec2(offDiagonal, lambda1 - diagonal1));\n\tvec2 v1 = l1 * diagonalVector;\n\tvec2 v2 = l2 * vec2(diagonalVector.y, -diagonalVector.x);\n\tcorner.offset = (source.cornerUV.x * v1 + source.cornerUV.y * v2) * c;\n\tcorner.uv = source.cornerUV;\n\treturn true;\n}\n",gsplatColorVS:"\nuniform mediump sampler2D splatColor;\nvec4 readColor(in SplatSource source) {\n\treturn texelFetch(splatColor, source.uv, 0);\n}\n",gsplatCommonVS:'\nstruct SplatSource {\n\tuint order;\n\tuint id;\n\tivec2 uv;\n\tvec2 cornerUV;\n};\nstruct SplatCenter {\n\tvec3 view;\n\tvec4 proj;\n\tmat4 modelView;\n\tfloat projMat00;\n};\nstruct SplatCorner {\n\tvec2 offset;\n\tvec2 uv;\n\t#if GSPLAT_AA\n\t\tfloat aaFactor;\n\t#endif\n};\n#if SH_BANDS > 0\n\t#if SH_BANDS == 1\n\t\t#define SH_COEFFS 3\n\t#elif SH_BANDS == 2\n\t\t#define SH_COEFFS 8\n\t#elif SH_BANDS == 3\n\t\t#define SH_COEFFS 15\n\t#endif\n#endif\n#if GSPLAT_COMPRESSED_DATA == true\n\t#include "gsplatCompressedDataVS"\n\t#include "gsplatCompressedSHVS"\n#elif GSPLAT_SOGS_DATA == true\n\t#include "gsplatSogsDataVS"\n\t#include "gsplatSogsColorVS"\n\t#include "gsplatSogsSHVS"\n#else\n\t#include "gsplatDataVS"\n\t#include "gsplatColorVS"\n\t#include "gsplatSHVS"\n#endif\n#include "gsplatSourceVS"\n#include "gsplatCenterVS"\n#include "gsplatCornerVS"\n#include "gsplatOutputVS"\nvoid clipCorner(inout SplatCorner corner, float alpha) {\n\tfloat clip = min(1.0, sqrt(-log(1.0 / 255.0 / alpha)) / 2.0);\n\tcorner.offset *= clip;\n\tcorner.uv *= clip;\n}\n#if SH_BANDS > 0\n#define SH_C1 0.4886025119029199f\n#if SH_BANDS > 1\n\t#define SH_C2_0 1.0925484305920792f\n\t#define SH_C2_1 -1.0925484305920792f\n\t#define SH_C2_2 0.31539156525252005f\n\t#define SH_C2_3 -1.0925484305920792f\n\t#define SH_C2_4 0.5462742152960396f\n#endif\n#if SH_BANDS > 2\n\t#define SH_C3_0 -0.5900435899266435f\n\t#define SH_C3_1 2.890611442640554f\n\t#define SH_C3_2 -0.4570457994644658f\n\t#define SH_C3_3 0.3731763325901154f\n\t#define SH_C3_4 -0.4570457994644658f\n\t#define SH_C3_5 1.445305721320277f\n\t#define SH_C3_6 -0.5900435899266435f\n#endif\nvec3 evalSH(in SplatSource source, in vec3 dir) {\n\tvec3 sh[SH_COEFFS];\n\tfloat scale;\n\treadSHData(source, sh, scale);\n\tfloat x = dir.x;\n\tfloat y = dir.y;\n\tfloat z = dir.z;\n\tvec3 result = SH_C1 * (-sh[0] * y + sh[1] * z - sh[2] * x);\n#if SH_BANDS > 1\n\tfloat xx = x * x;\n\tfloat yy = y * y;\n\tfloat zz = z * z;\n\tfloat xy = x * y;\n\tfloat yz = y * z;\n\tfloat xz = x * z;\n\tresult +=\n\t\tsh[3] * (SH_C2_0 * xy) *  +\n\t\tsh[4] * (SH_C2_1 * yz) +\n\t\tsh[5] * (SH_C2_2 * (2.0 * zz - xx - yy)) +\n\t\tsh[6] * (SH_C2_3 * xz) +\n\t\tsh[7] * (SH_C2_4 * (xx - yy));\n#endif\n#if SH_BANDS > 2\n\tresult +=\n\t\tsh[8]  * (SH_C3_0 * y * (3.0 * xx - yy)) +\n\t\tsh[9]  * (SH_C3_1 * xy * z) +\n\t\tsh[10] * (SH_C3_2 * y * (4.0 * zz - xx - yy)) +\n\t\tsh[11] * (SH_C3_3 * z * (2.0 * zz - 3.0 * xx - 3.0 * yy)) +\n\t\tsh[12] * (SH_C3_4 * x * (4.0 * zz - xx - yy)) +\n\t\tsh[13] * (SH_C3_5 * z * (xx - yy)) +\n\t\tsh[14] * (SH_C3_6 * x * (xx - 3.0 * yy));\n#endif\n\treturn result * scale;\n}\n#endif\n',gsplatCompressedDataVS:"\nuniform highp usampler2D packedTexture;\nuniform highp sampler2D chunkTexture;\nvec4 chunkDataA;\nvec4 chunkDataB;\nvec4 chunkDataC;\nvec4 chunkDataD;\nvec4 chunkDataE;\nuvec4 packedData;\nvec3 unpack111011(uint bits) {\n\treturn vec3(\n\t\tfloat(bits >> 21u) / 2047.0,\n\t\tfloat((bits >> 11u) & 0x3ffu) / 1023.0,\n\t\tfloat(bits & 0x7ffu) / 2047.0\n\t);\n}\nvec4 unpack8888(uint bits) {\n\treturn vec4(\n\t\tfloat(bits >> 24u) / 255.0,\n\t\tfloat((bits >> 16u) & 0xffu) / 255.0,\n\t\tfloat((bits >> 8u) & 0xffu) / 255.0,\n\t\tfloat(bits & 0xffu) / 255.0\n\t);\n}\nconst float norm = 1.0 / (sqrt(2.0) * 0.5);\nvec4 unpackRotation(uint bits) {\n\tfloat a = (float((bits >> 20u) & 0x3ffu) / 1023.0 - 0.5) * norm;\n\tfloat b = (float((bits >> 10u) & 0x3ffu) / 1023.0 - 0.5) * norm;\n\tfloat c = (float(bits & 0x3ffu) / 1023.0 - 0.5) * norm;\n\tfloat m = sqrt(1.0 - (a * a + b * b + c * c));\n\tuint mode = bits >> 30u;\n\tif (mode == 0u) return vec4(m, a, b, c);\n\tif (mode == 1u) return vec4(a, m, b, c);\n\tif (mode == 2u) return vec4(a, b, m, c);\n\treturn vec4(a, b, c, m);\n}\nmat3 quatToMat3(vec4 R) {\n\tfloat x = R.x;\n\tfloat y = R.y;\n\tfloat z = R.z;\n\tfloat w = R.w;\n\treturn mat3(\n\t\t1.0 - 2.0 * (z * z + w * w),\n\t\t\t  2.0 * (y * z + x * w),\n\t\t\t  2.0 * (y * w - x * z),\n\t\t\t  2.0 * (y * z - x * w),\n\t\t1.0 - 2.0 * (y * y + w * w),\n\t\t\t  2.0 * (z * w + x * y),\n\t\t\t  2.0 * (y * w + x * z),\n\t\t\t  2.0 * (z * w - x * y),\n\t\t1.0 - 2.0 * (y * y + z * z)\n\t);\n}\nvec3 readCenter(SplatSource source) {\n\tuint w = uint(textureSize(chunkTexture, 0).x) / 5u;\n\tuint chunkId = source.id / 256u;\n\tivec2 chunkUV = ivec2((chunkId % w) * 5u, chunkId / w);\n\tchunkDataA = texelFetch(chunkTexture, chunkUV, 0);\n\tchunkDataB = texelFetch(chunkTexture, chunkUV + ivec2(1, 0), 0);\n\tchunkDataC = texelFetch(chunkTexture, chunkUV + ivec2(2, 0), 0);\n\tchunkDataD = texelFetch(chunkTexture, chunkUV + ivec2(3, 0), 0);\n\tchunkDataE = texelFetch(chunkTexture, chunkUV + ivec2(4, 0), 0);\n\tpackedData = texelFetch(packedTexture, source.uv, 0);\n\treturn mix(chunkDataA.xyz, vec3(chunkDataA.w, chunkDataB.xy), unpack111011(packedData.x));\n}\nvec4 readColor(in SplatSource source) {\n\tvec4 r = unpack8888(packedData.w);\n\treturn vec4(mix(chunkDataD.xyz, vec3(chunkDataD.w, chunkDataE.xy), r.rgb), r.w);\n}\nvec4 getRotation() {\n\treturn unpackRotation(packedData.y);\n}\nvec3 getScale() {\n\treturn exp(mix(vec3(chunkDataB.zw, chunkDataC.x), chunkDataC.yzw, unpack111011(packedData.z)));\n}\nvoid readCovariance(in SplatSource source, out vec3 covA, out vec3 covB) {\n\tmat3 rot = quatToMat3(getRotation());\n\tvec3 scale = getScale();\n\tmat3 M = transpose(mat3(\n\t\tscale.x * rot[0],\n\t\tscale.y * rot[1],\n\t\tscale.z * rot[2]\n\t));\n\tcovA = vec3(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));\n\tcovB = vec3(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));\n}\n",gsplatCompressedSHVS:"\n#if SH_BANDS > 0\nuniform highp usampler2D shTexture0;\nuniform highp usampler2D shTexture1;\nuniform highp usampler2D shTexture2;\nvec4 unpack8888s(in uint bits) {\n\treturn vec4((uvec4(bits) >> uvec4(0u, 8u, 16u, 24u)) & 0xffu) * (8.0 / 255.0) - 4.0;\n}\nvoid readSHData(in SplatSource source, out vec3 sh[15], out float scale) {\n\tuvec4 shData0 = texelFetch(shTexture0, source.uv, 0);\n\tuvec4 shData1 = texelFetch(shTexture1, source.uv, 0);\n\tuvec4 shData2 = texelFetch(shTexture2, source.uv, 0);\n\tvec4 r0 = unpack8888s(shData0.x);\n\tvec4 r1 = unpack8888s(shData0.y);\n\tvec4 r2 = unpack8888s(shData0.z);\n\tvec4 r3 = unpack8888s(shData0.w);\n\tvec4 g0 = unpack8888s(shData1.x);\n\tvec4 g1 = unpack8888s(shData1.y);\n\tvec4 g2 = unpack8888s(shData1.z);\n\tvec4 g3 = unpack8888s(shData1.w);\n\tvec4 b0 = unpack8888s(shData2.x);\n\tvec4 b1 = unpack8888s(shData2.y);\n\tvec4 b2 = unpack8888s(shData2.z);\n\tvec4 b3 = unpack8888s(shData2.w);\n\tsh[0] =  vec3(r0.x, g0.x, b0.x);\n\tsh[1] =  vec3(r0.y, g0.y, b0.y);\n\tsh[2] =  vec3(r0.z, g0.z, b0.z);\n\tsh[3] =  vec3(r0.w, g0.w, b0.w);\n\tsh[4] =  vec3(r1.x, g1.x, b1.x);\n\tsh[5] =  vec3(r1.y, g1.y, b1.y);\n\tsh[6] =  vec3(r1.z, g1.z, b1.z);\n\tsh[7] =  vec3(r1.w, g1.w, b1.w);\n\tsh[8] =  vec3(r2.x, g2.x, b2.x);\n\tsh[9] =  vec3(r2.y, g2.y, b2.y);\n\tsh[10] = vec3(r2.z, g2.z, b2.z);\n\tsh[11] = vec3(r2.w, g2.w, b2.w);\n\tsh[12] = vec3(r3.x, g3.x, b3.x);\n\tsh[13] = vec3(r3.y, g3.y, b3.y);\n\tsh[14] = vec3(r3.z, g3.z, b3.z);\n\tscale = 1.0;\n}\n#endif\n",gsplatSogsColorVS:"\nuniform mediump sampler2D sh0;\nuniform mediump sampler2D opacities;\nuniform vec3 sh0_mins;\nuniform vec3 sh0_maxs;\nuniform float opacities_mins;\nuniform float opacities_maxs;\nfloat SH_C0 = 0.28209479177387814;\nvec4 readColor(in SplatSource source) {\n\tvec3 clr = mix(sh0_mins, sh0_maxs, texelFetch(sh0, source.uv, 0).xyz);\n\tfloat opacity = mix(opacities_mins, opacities_maxs, texelFetch(opacities, source.uv, 0).x);\n\treturn vec4(vec3(0.5) + clr * SH_C0, 1.0 / (1.0 + exp(opacity * -1.0)));\n}\n",gsplatSogsDataVS:"\nuniform highp sampler2D means_u;\nuniform highp sampler2D means_l;\nuniform highp sampler2D quats;\nuniform highp sampler2D scales;\nuniform vec3 means_mins;\nuniform vec3 means_maxs;\nuniform vec3 quats_mins;\nuniform vec3 quats_maxs;\nuniform vec3 scales_mins;\nuniform vec3 scales_maxs;\nvec3 readCenter(SplatSource source) {\n\tvec3 u = texelFetch(means_u, source.uv, 0).xyz;\n\tvec3 l = texelFetch(means_l, source.uv, 0).xyz;\n\tvec3 n = (l * 255.0 + u * 255.0 * 256.0) / 65535.0;\n\tvec3 v = mix(means_mins, means_maxs, n);\n\treturn sign(v) * (exp(abs(v)) - 1.0);\n}\nmat3 quatToMat3(vec3 R) {\n\tfloat x = R.x;\n\tfloat y = R.y;\n\tfloat z = R.z;\n\tfloat w2 = clamp(1.0 - (x*x + y*y + z*z), 0.0, 1.0);\n\tfloat w  = sqrt(w2);\n\treturn mat3(\n\t\t1.0 - 2.0 * (z * z + w2),\n\t\t\t  2.0 * (y * z + x * w),\n\t\t\t  2.0 * (y * w - x * z),\n\t\t\t  2.0 * (y * z - x * w),\n\t\t1.0 - 2.0 * (y * y + w2),\n\t\t\t  2.0 * (z * w + x * y),\n\t\t\t  2.0 * (y * w + x * z),\n\t\t\t  2.0 * (z * w - x * y),\n\t\t1.0 - 2.0 * (y * y + z * z)\n\t);\n}\nvoid readCovariance(in SplatSource source, out vec3 covA, out vec3 covB) {\n\tvec3 quat = mix(quats_mins, quats_maxs, texelFetch(quats, source.uv, 0).xyz);\n\tmat3 rot = quatToMat3(quat);\n\tvec3 scale = exp(mix(scales_mins, scales_maxs, texelFetch(scales, source.uv, 0).xyz));\n\tmat3 M = transpose(mat3(\n\t\tscale.x * rot[0],\n\t\tscale.y * rot[1],\n\t\tscale.z * rot[2]\n\t));\n\tcovA = vec3(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));\n\tcovB = vec3(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));\n}\n",gsplatSogsSHVS:"\nuniform highp sampler2D sh_labels_u;\nuniform highp sampler2D sh_labels_l;\nuniform highp sampler2D sh_centroids;\nuniform float shN_mins;\nuniform float shN_maxs;\nvoid readSHData(in SplatSource source, out vec3 sh[15], out float scale) {\n\tint tu = int(texelFetch(sh_labels_u, source.uv, 0).x * 255.0 * 256.0);\n\tint tl = int(texelFetch(sh_labels_l, source.uv, 0).x * 255.0);\n\tint n = tu + tl;\n\tint u = (n % 64) * 15;\n\tint v = n / 64;\n\tfor (int i = 0; i < 15; i++) {\n\t\tsh[i] = mix(vec3(shN_mins), vec3(shN_maxs), texelFetch(sh_centroids, ivec2(u + i, v), 0).xyz);\n\t}\n\tscale = 1.0;\n}\n",gsplatDataVS:"\nuniform highp usampler2D transformA;\nuniform highp sampler2D transformB;\nuint tAw;\nvec3 readCenter(SplatSource source) {\n\tuvec4 tA = texelFetch(transformA, source.uv, 0);\n\ttAw = tA.w;\n\treturn uintBitsToFloat(tA.xyz);\n}\nmat3 quatToMat3(vec4 R) {\n\tfloat x = R.w;\n\tfloat y = R.x;\n\tfloat z = R.y;\n\tfloat w = R.z;\n\treturn mat3(\n\t\t1.0 - 2.0 * (z * z + w * w),\n\t\t\t  2.0 * (y * z + x * w),\n\t\t\t  2.0 * (y * w - x * z),\n\t\t\t  2.0 * (y * z - x * w),\n\t\t1.0 - 2.0 * (y * y + w * w),\n\t\t\t  2.0 * (z * w + x * y),\n\t\t\t  2.0 * (y * w + x * z),\n\t\t\t  2.0 * (z * w - x * y),\n\t\t1.0 - 2.0 * (y * y + z * z)\n\t);\n}\nvec4 unpackRotation(vec3 packed) {\n\treturn vec4(packed.xyz, sqrt(max(0.0, 1.0 - dot(packed, packed))));\n}\nvoid readCovariance(in SplatSource source, out vec3 covA, out vec3 covB) {\n\tvec4 tB = texelFetch(transformB, source.uv, 0);\n\tmat3 rot = quatToMat3(unpackRotation(vec3(unpackHalf2x16(tAw), tB.w)));\n\tvec3 scale = tB.xyz;\n\t\n\tmat3 M = transpose(mat3(\n\t\tscale.x * rot[0],\n\t\tscale.y * rot[1],\n\t\tscale.z * rot[2]\n\t));\n\tcovA = vec3(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));\n\tcovB = vec3(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));\n}\n",gsplatOutputVS:'\n#include "tonemappingPS"\n#include "decodePS"\n#include "gammaPS"\nvec3 prepareOutputFromGamma(vec3 gammaColor) {\n\t#if TONEMAP == NONE\n\t\t#if GAMMA == NONE\n\t\t\treturn decodeGamma(gammaColor);\n\t\t#else\n\t\t\treturn gammaColor;\n\t\t#endif\n\t#else\n\t\treturn gammaCorrectOutput(toneMap(decodeGamma(gammaColor)));\n\t#endif\n}\n',gsplatPS:'\n#ifndef DITHER_NONE\n\t#include "bayerPS"\n\t#include "opacityDitherPS"\n\tvarying float id;\n#endif\n#ifdef PICK_PASS\n\t#include "pickPS"\n#endif\n#if defined(SHADOW_PASS) || defined(PICK_PASS) || defined(PREPASS_PASS)\n\tuniform float alphaClip;\n#endif\n#ifdef PREPASS_PASS\n\tvarying float vLinearDepth;\n\t#include "floatAsUintPS"\n#endif\nvarying mediump vec2 gaussianUV;\nvarying mediump vec4 gaussianColor;\nvoid main(void) {\n\tmediump float A = dot(gaussianUV, gaussianUV);\n\tif (A > 1.0) {\n\t\tdiscard;\n\t}\n\tmediump float alpha = exp(-A * 4.0) * gaussianColor.a;\n\t#if defined(SHADOW_PASS) || defined(PICK_PASS) || defined(PREPASS_PASS)\n\t\tif (alpha < alphaClip) {\n\t\t\tdiscard;\n\t\t}\n\t#endif\n\t#ifdef PICK_PASS\n\t\tgl_FragColor = getPickOutput();\n\t#elif SHADOW_PASS\n\t\tgl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n\t#elif PREPASS_PASS\n\t\tgl_FragColor = float2vec4(vLinearDepth);\n\t#else\n\t\tif (alpha < 1.0 / 255.0) {\n\t\t\tdiscard;\n\t\t}\n\t\t#ifndef DITHER_NONE\n\t\t\topacityDither(alpha, id * 0.013);\n\t\t#endif\n\t\tgl_FragColor = vec4(gaussianColor.xyz * alpha, alpha);\n\t#endif\n}\n',gsplatSHVS:"\n#if SH_BANDS > 0\nvec3 unpack111011s(uint bits) {\n\treturn vec3((uvec3(bits) >> uvec3(21u, 11u, 0u)) & uvec3(0x7ffu, 0x3ffu, 0x7ffu)) / vec3(2047.0, 1023.0, 2047.0) * 2.0 - 1.0;\n}\nvoid fetchScale(in uvec4 t, out float scale, out vec3 a, out vec3 b, out vec3 c) {\n\tscale = uintBitsToFloat(t.x);\n\ta = unpack111011s(t.y);\n\tb = unpack111011s(t.z);\n\tc = unpack111011s(t.w);\n}\nvoid fetch(in uvec4 t, out vec3 a, out vec3 b, out vec3 c, out vec3 d) {\n\ta = unpack111011s(t.x);\n\tb = unpack111011s(t.y);\n\tc = unpack111011s(t.z);\n\td = unpack111011s(t.w);\n}\nvoid fetch(in uint t, out vec3 a) {\n\ta = unpack111011s(t);\n}\n#if SH_BANDS == 1\n\tuniform highp usampler2D splatSH_1to3;\n\tvoid readSHData(in SplatSource source, out vec3 sh[3], out float scale) {\n\t\tfetchScale(texelFetch(splatSH_1to3, source.uv, 0), scale, sh[0], sh[1], sh[2]);\n\t}\n#elif SH_BANDS == 2\n\tuniform highp usampler2D splatSH_1to3;\n\tuniform highp usampler2D splatSH_4to7;\n\tuniform highp usampler2D splatSH_8to11;\n\tvoid readSHData(in SplatSource source, out vec3 sh[8], out float scale) {\n\t\tfetchScale(texelFetch(splatSH_1to3, source.uv, 0), scale, sh[0], sh[1], sh[2]);\n\t\tfetch(texelFetch(splatSH_4to7, source.uv, 0), sh[3], sh[4], sh[5], sh[6]);\n\t\tfetch(texelFetch(splatSH_8to11, source.uv, 0).x, sh[7]);\n\t}\n#else\n\tuniform highp usampler2D splatSH_1to3;\n\tuniform highp usampler2D splatSH_4to7;\n\tuniform highp usampler2D splatSH_8to11;\n\tuniform highp usampler2D splatSH_12to15;\n\tvoid readSHData(in SplatSource source, out vec3 sh[15], out float scale) {\n\t\tfetchScale(texelFetch(splatSH_1to3, source.uv, 0), scale, sh[0], sh[1], sh[2]);\n\t\tfetch(texelFetch(splatSH_4to7, source.uv, 0), sh[3], sh[4], sh[5], sh[6]);\n\t\tfetch(texelFetch(splatSH_8to11, source.uv, 0), sh[7], sh[8], sh[9], sh[10]);\n\t\tfetch(texelFetch(splatSH_12to15, source.uv, 0), sh[11], sh[12], sh[13], sh[14]);\n\t}\n#endif\n#endif\n",gsplatSourceVS:"\nattribute vec3 vertex_position;\nattribute uint vertex_id_attrib;\nuniform uint numSplats;\nuniform highp usampler2D splatOrder;\nbool initSource(out SplatSource source) {\n\tuint w = uint(textureSize(splatOrder, 0).x);\n\tsource.order = vertex_id_attrib + uint(vertex_position.z);\n\tif (source.order >= numSplats) {\n\t\treturn false;\n\t}\n\tivec2 orderUV = ivec2(source.order % w, source.order / w);\n\tsource.id = texelFetch(splatOrder, orderUV, 0).r;\n\tsource.uv = ivec2(source.id % w, source.id / w);\n\tsource.cornerUV = vertex_position.xy;\n\treturn true;\n}\n",gsplatVS:'\n#include "gsplatCommonVS"\nvarying mediump vec2 gaussianUV;\nvarying mediump vec4 gaussianColor;\n#ifndef DITHER_NONE\n\tvarying float id;\n#endif\nmediump vec4 discardVec = vec4(0.0, 0.0, 2.0, 1.0);\n#ifdef PREPASS_PASS\n\tvarying float vLinearDepth;\n#endif\nvoid main(void) {\n\tSplatSource source;\n\tif (!initSource(source)) {\n\t\tgl_Position = discardVec;\n\t\treturn;\n\t}\n\tvec3 modelCenter = readCenter(source);\n\tSplatCenter center;\n\tif (!initCenter(modelCenter, center)) {\n\t\tgl_Position = discardVec;\n\t\treturn;\n\t}\n\tSplatCorner corner;\n\tif (!initCorner(source, center, corner)) {\n\t\tgl_Position = discardVec;\n\t\treturn;\n\t}\n\tvec4 clr = readColor(source);\n\t#if GSPLAT_AA\n\t\tclr.a *= corner.aaFactor;\n\t#endif\n\t#if SH_BANDS > 0\n\t\tvec3 dir = normalize(center.view * mat3(center.modelView));\n\t\tclr.xyz += evalSH(source, dir);\n\t#endif\n\tclipCorner(corner, clr.w);\n\tgl_Position = center.proj + vec4(corner.offset, 0, 0);\n\tgaussianUV = corner.uv;\n\tgaussianColor = vec4(prepareOutputFromGamma(max(clr.xyz, 0.0)), clr.w);\n\t#ifndef DITHER_NONE\n\t\tid = float(source.id);\n\t#endif\n\t#ifdef PREPASS_PASS\n\t\tvLinearDepth = -center.view.z;\n\t#endif\n}\n',immediateLinePS:'\n\t\t#include "gammaPS"\n\t\tvarying vec4 color;\n\t\tvoid main(void) {\n\t\t\tgl_FragColor = vec4(gammaCorrectOutput(decodeGamma(color.rgb)), color.a);\n\t\t}\n',immediateLineVS:"\n\tattribute vec4 vertex_position;\n\tattribute vec4 vertex_color;\n\tuniform mat4 matrix_model;\n\tuniform mat4 matrix_viewProjection;\n\tvarying vec4 color;\n\tvoid main(void) {\n\t\tcolor = vertex_color;\n\t\tgl_Position = matrix_viewProjection * matrix_model * vertex_position;\n\t}\n",iridescenceDiffractionPS:"\nuniform float material_iridescenceRefractionIndex;\n#ifndef PI\n#define PI 3.14159265\n#endif\nfloat iridescence_iorToFresnel(float transmittedIor, float incidentIor) {\n\treturn pow((transmittedIor - incidentIor) / (transmittedIor + incidentIor), 2.0);\n}\nvec3 iridescence_iorToFresnel(vec3 transmittedIor, float incidentIor) {\n\treturn pow((transmittedIor - vec3(incidentIor)) / (transmittedIor + vec3(incidentIor)), vec3(2.0));\n}\nvec3 iridescence_fresnelToIor(vec3 f0) {\n\tvec3 sqrtF0 = sqrt(f0);\n\treturn (vec3(1.0) + sqrtF0) / (vec3(1.0) - sqrtF0);\n}\nvec3 iridescence_sensitivity(float opd, vec3 shift) {\n\tfloat phase = 2.0 * PI * opd * 1.0e-9;\n\tconst vec3 val = vec3(5.4856e-13, 4.4201e-13, 5.2481e-13);\n\tconst vec3 pos = vec3(1.6810e+06, 1.7953e+06, 2.2084e+06);\n\tconst vec3 var = vec3(4.3278e+09, 9.3046e+09, 6.6121e+09);\n\tvec3 xyz = val * sqrt(2.0 * PI * var) * cos(pos * phase + shift) * exp(-pow(phase, 2.0) * var);\n\txyz.x += 9.7470e-14 * sqrt(2.0 * PI * 4.5282e+09) * cos(2.2399e+06 * phase + shift[0]) * exp(-4.5282e+09 * pow(phase, 2.0));\n\txyz /= vec3(1.0685e-07);\n\tconst mat3 XYZ_TO_REC709 = mat3(\n\t\t3.2404542, -0.9692660,  0.0556434,\n\t   -1.5371385,  1.8760108, -0.2040259,\n\t   -0.4985314,  0.0415560,  1.0572252\n\t);\n\treturn XYZ_TO_REC709 * xyz;\n}\nfloat iridescence_fresnel(float cosTheta, float f0) {\n\tfloat x = clamp(1.0 - cosTheta, 0.0, 1.0);\n\tfloat x2 = x * x;\n\tfloat x5 = x * x2 * x2;\n\treturn f0 + (1.0 - f0) * x5;\n} \nvec3 iridescence_fresnel(float cosTheta, vec3 f0) {\n\tfloat x = clamp(1.0 - cosTheta, 0.0, 1.0);\n\tfloat x2 = x * x;\n\tfloat x5 = x * x2 * x2; \n\treturn f0 + (vec3(1.0) - f0) * x5;\n}\nvec3 calcIridescence(float outsideIor, float cosTheta, vec3 base_f0, float iridescenceThickness) {\n\tfloat iridescenceIor = mix(outsideIor, material_iridescenceRefractionIndex, smoothstep(0.0, 0.03, iridescenceThickness));\n\tfloat sinTheta2Sq = pow(outsideIor / iridescenceIor, 2.0) * (1.0 - pow(cosTheta, 2.0));\n\tfloat cosTheta2Sq = 1.0 - sinTheta2Sq;\n\tif (cosTheta2Sq < 0.0) {\n\t\treturn vec3(1.0);\n\t}\n\tfloat cosTheta2 = sqrt(cosTheta2Sq);\n\tfloat r0 = iridescence_iorToFresnel(iridescenceIor, outsideIor);\n\tfloat r12 = iridescence_fresnel(cosTheta, r0);\n\tfloat r21 = r12;\n\tfloat t121 = 1.0 - r12;\n\tfloat phi12 = iridescenceIor < outsideIor ? PI : 0.0;\n\tfloat phi21 = PI - phi12;\n\tvec3 baseIor = iridescence_fresnelToIor(base_f0 + vec3(0.0001));\n\tvec3 r1 = iridescence_iorToFresnel(baseIor, iridescenceIor);\n\tvec3 r23 = iridescence_fresnel(cosTheta2, r1);\n\tvec3 phi23 = vec3(0.0);\n\tif (baseIor[0] < iridescenceIor) phi23[0] = PI;\n\tif (baseIor[1] < iridescenceIor) phi23[1] = PI;\n\tif (baseIor[2] < iridescenceIor) phi23[2] = PI;\n\tfloat opd = 2.0 * iridescenceIor * iridescenceThickness * cosTheta2;\n\tvec3 phi = vec3(phi21) + phi23; \n\tvec3 r123Sq = clamp(r12 * r23, 1e-5, 0.9999);\n\tvec3 r123 = sqrt(r123Sq);\n\tvec3 rs = pow(t121, 2.0) * r23 / (1.0 - r123Sq);\n\tvec3 c0 = r12 + rs;\n\tvec3 i = c0;\n\tvec3 cm = rs - t121;\n\tfor (int m = 1; m <= 2; m++) {\n\t\tcm *= r123;\n\t\tvec3 sm = 2.0 * iridescence_sensitivity(float(m) * opd, float(m) * phi);\n\t\ti += cm * sm;\n\t}\n\treturn max(i, vec3(0.0));\n}\nvec3 getIridescence(float cosTheta, vec3 specularity, float iridescenceThickness) {\n\treturn calcIridescence(1.0, cosTheta, specularity, iridescenceThickness);\n}\n",iridescencePS:"\n#ifdef STD_IRIDESCENCE_CONSTANT\nuniform float material_iridescence;\n#endif\nvoid getIridescence() {\n\tfloat iridescence = 1.0;\n\t#ifdef STD_IRIDESCENCE_CONSTANT\n\tiridescence *= material_iridescence;\n\t#endif\n\t#ifdef STD_IRIDESCENCE_TEXTURE\n\tiridescence *= texture2DBias({STD_IRIDESCENCE_TEXTURE_NAME}, {STD_IRIDESCENCE_TEXTURE_UV}, textureBias).{STD_IRIDESCENCE_TEXTURE_CHANNEL};\n\t#endif\n\tdIridescence = iridescence; \n}\n",iridescenceThicknessPS:"\nuniform float material_iridescenceThicknessMax;\n#ifdef STD_IRIDESCENCETHICKNESS_TEXTURE\nuniform float material_iridescenceThicknessMin;\n#endif\nvoid getIridescenceThickness() {\n\t#ifdef STD_IRIDESCENCETHICKNESS_TEXTURE\n\t\tfloat blend = texture2DBias({STD_IRIDESCENCETHICKNESS_TEXTURE_NAME}, {STD_IRIDESCENCETHICKNESS_TEXTURE_UV}, textureBias).{STD_IRIDESCENCETHICKNESS_TEXTURE_CHANNEL};\n\t\tfloat iridescenceThickness = mix(material_iridescenceThicknessMin, material_iridescenceThicknessMax, blend);\n\t#else\n\t\tfloat iridescenceThickness = material_iridescenceThicknessMax;\n\t#endif\n\tdIridescenceThickness = iridescenceThickness; \n}\n",iorPS:"\n#ifdef STD_IOR_CONSTANT\nuniform float material_refractionIndex;\n#endif\nvoid getIor() {\n#ifdef STD_IOR_CONSTANT\n\tdIor = material_refractionIndex;\n#else\n\tdIor = 1.0 / 1.5;\n#endif\n}\n",lightBufferDefinesPS:"",lightDeclarationPS:"\n#if defined(LIGHT{i})\n\tuniform vec3 light{i}_color;\n\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\tuniform vec3 light{i}_direction;\n\t#else\n\t\t#define LIT_CODE_LIGHTS_POINT\n\t\tuniform vec3 light{i}_position;\n\t\tuniform float light{i}_radius;\n\t\t#if LIGHT{i}TYPE == SPOT\n\t\t\t#define LIT_CODE_LIGHTS_SPOT\n\t\t\tuniform vec3 light{i}_direction;\n\t\t\tuniform float light{i}_innerConeAngle;\n\t\t\tuniform float light{i}_outerConeAngle;\n\t\t#endif\n\t#endif\n\t#if LIGHT{i}SHAPE != PUNCTUAL\n\t\t#define LIT_CODE_FALLOFF_SQUARED\n\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\tuniform vec3 light{i}_position;\n\t\t#endif\n\t\tuniform vec3 light{i}_halfWidth;\n\t\tuniform vec3 light{i}_halfHeight;\n\t#else\n\t\t#if LIGHT{i}FALLOFF == LINEAR\n\t\t\t#define LIT_CODE_FALLOFF_LINEAR\n\t\t#endif\n\t\t#if LIGHT{i}FALLOFF == INVERSESQUARED\n\t\t\t#define LIT_CODE_FALLOFF_SQUARED\n\t\t#endif\n\t#endif\n\t#if defined(LIGHT{i}CASTSHADOW)\n\t\tuniform mat4 light{i}_shadowMatrix;\n\t\tuniform float light{i}_shadowIntensity;\n\t\tuniform vec4 light{i}_shadowParams;\n\t\t#if LIGHT{i}SHADOWTYPE == PCSS_32F\n\t\t\tuniform float light{i}_shadowSearchArea;\n\t\t\tuniform vec4 light{i}_cameraParams;\n\t\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\t\tuniform vec4 light{i}_softShadowParams;\n\t\t\t#endif\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\tuniform mat4 light{i}_shadowMatrixPalette[4];\n\t\t\tuniform vec4 light{i}_shadowCascadeDistances;\n\t\t\tuniform int light{i}_shadowCascadeCount;\n\t\t\tuniform float light{i}_shadowCascadeBlend;\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == OMNI\n\t\t\t#if defined(LIGHT{i}SHADOW_PCF)\n\t\t\t\tuniform samplerCubeShadow light{i}_shadowMap;\n\t\t\t#else\n\t\t\t\tuniform samplerCube light{i}_shadowMap;\n\t\t\t#endif\n\t\t#else\n\t\t\t#if defined(LIGHT{i}SHADOW_PCF)\n\t\t\t\tuniform sampler2DShadow light{i}_shadowMap;\n\t\t\t#else\n\t\t\t\tuniform sampler2D light{i}_shadowMap;\n\t\t\t#endif\n\t\t#endif\n\t#endif\n\t#if defined(LIGHT{i}COOKIE)\n\t\t#define LIT_CODE_COOKIE\n\t\t#if LIGHT{i}TYPE == OMNI\n\t\t\tuniform samplerCube light{i}_cookie;\n\t\t\tuniform float light{i}_cookieIntensity;\n\t\t\t#if !defined(LIGHT{i}CASTSHADOW)\n\t\t\t\tuniform mat4 light{i}_shadowMatrix;\n\t\t\t#endif\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == SPOT\n\t\t\tuniform sampler2D light{i}_cookie;\n\t\t\tuniform float light{i}_cookieIntensity;\n\t\t\t#if !defined(LIGHT{i}CASTSHADOW)\n\t\t\t\tuniform mat4 light{i}_shadowMatrix;\n\t\t\t#endif\n\t\t\t#if defined(LIGHT{i}COOKIE_TRANSFORM)\n\t\t\t\tuniform vec4 light{i}_cookieMatrix;\n\t\t\t\tuniform vec2 light{i}_cookieOffset;\n\t\t\t#endif\n\t\t#endif\n\t#endif\n#endif\n",lightDiffuseLambertPS:"\nfloat getLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm) {\n\treturn max(dot(worldNormal, -lightDirNorm), 0.0);\n}\n",lightDirPointPS:"\nvoid evalOmniLight(vec3 lightPosW, out vec3 lightDirW, out vec3 lightDirNormW) {\n\tlightDirW = vPositionW - lightPosW;\n\tlightDirNormW = normalize(lightDirW);\n}\n",lightEvaluationPS:"\n#if defined(LIGHT{i})\n\tevaluateLight{i}(\n\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\tiridescenceFresnel\n\t\t#endif\n\t);\n#endif\n",lightFunctionLightPS:"\n#if defined(LIGHT{i})\nvoid evaluateLight{i}(\n\t#if defined(LIT_IRIDESCENCE)\n\t\tvec3 iridescenceFresnel\n\t#endif\n) {\n\tvec3 lightColor = light{i}_color;\n\t#if LIGHT{i}TYPE == DIRECTIONAL && !defined(LIT_SHADOW_CATCHER)\n\t\tif (all(equal(lightColor, vec3(0.0)))) {\n\t\t\treturn;\n\t\t}\n\t#endif\n\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\tdLightDirNormW = light{i}_direction;\n\t\tdAtten = 1.0;\n\t#else\n\t\t\n\t\tvec3 lightDirW;\n\t\tevalOmniLight(light{i}_position, lightDirW, dLightDirNormW);\n\t\t#if defined(LIGHT{i}COOKIE)\n\t\t\t#if LIGHT{i}TYPE == SPOT\n\t\t\t\t#ifdef LIGHT{i}COOKIE_FALLOFF\n\t\t\t\t\t#ifdef LIGHT{i}COOKIE_TRANSFORM\n\t\t\t\t\t\tvec3 cookieAttenuation = getCookie2DXform(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity, light{i}_cookieMatrix, light{i}_cookieOffset).{LIGHT{i}COOKIE_CHANNEL};\n\t\t\t\t\t#else\n\t\t\t\t\t\tvec3 cookieAttenuation = getCookie2D(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};\n\t\t\t\t\t#endif\n\t\t\t\t#else\n\t\t\t\t\t#ifdef LIGHT{i}COOKIE_TRANSFORM\n\t\t\t\t\t\tvec3 cookieAttenuation = getCookie2DClipXform(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity, light{i}_cookieMatrix, light{i}_cookieOffset).{LIGHT{i}COOKIE_CHANNEL};\n\t\t\t\t\t#else\n\t\t\t\t\t\tvec3 cookieAttenuation = getCookie2DClip(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};\n\t\t\t\t\t#endif\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#if LIGHT{i}TYPE == OMNI\n\t\t\t\tvec3 cookieAttenuation = getCookieCube(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};\n\t\t\t#endif\n\t\t\tlightColor *= cookieAttenuation;\n\t\t#endif\n\t\t#if LIGHT{i}SHAPE == PUNCTUAL\n\t\t\t#if LIGHT{i}FALLOFF == LINEAR\n\t\t\t\tdAtten = getFalloffLinear(light{i}_radius, lightDirW);\n\t\t\t#else\n\t\t\t\tdAtten = getFalloffInvSquared(light{i}_radius, lightDirW);\n\t\t\t#endif\n\t\t#else\n\t\t\tdAtten = getFalloffWindow(light{i}_radius, lightDirW);\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == SPOT\n\t\t\t#if !defined(LIGHT{i}COOKIE) || defined(LIGHT{i}COOKIE_FALLOFF)\n\t\t\t\tdAtten *= getSpotEffect(light{i}_direction, light{i}_innerConeAngle, light{i}_outerConeAngle, dLightDirNormW);\n\t\t\t#endif\n\t\t#endif\n\t#endif\n\tif (dAtten < 0.00001) {\n\t\treturn;\n\t}\n\t#if LIGHT{i}SHAPE != PUNCTUAL\n\t\t#if LIGHT{i}SHAPE == RECT\n\t\t\tcalcRectLightValues(light{i}_position, light{i}_halfWidth, light{i}_halfHeight);\n\t\t#elif LIGHT{i}SHAPE == DISK\n\t\t\tcalcDiskLightValues(light{i}_position, light{i}_halfWidth, light{i}_halfHeight);\n\t\t#elif LIGHT{i}SHAPE == SPHERE\n\t\t\tcalcSphereLightValues(light{i}_position, light{i}_halfWidth, light{i}_halfHeight);\n\t\t#endif\n\t#endif\n\t#if LIGHT{i}SHAPE != PUNCTUAL\n\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\tfloat attenDiffuse = getLightDiffuse(litArgs_worldNormal, dViewDirW, dLightDirNormW);\n\t\t#else\n\t\t\t#if LIGHT{i}SHAPE == RECT\n\t\t\t\tfloat attenDiffuse = getRectLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;\n\t\t\t#elif LIGHT{i}SHAPE == DISK\n\t\t\t\tfloat attenDiffuse = getDiskLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;\n\t\t\t#elif LIGHT{i}SHAPE == SPHERE\n\t\t\t\tfloat attenDiffuse = getSphereLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;\n\t\t\t#endif\n\t\t#endif\n\t#else\n\t\tdAtten *= getLightDiffuse(litArgs_worldNormal, vec3(0.0), dLightDirNormW);\n\t#endif\n\t#ifdef LIGHT{i}CASTSHADOW\n\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\tfloat shadow = getShadow{i}(vec3(0.0));\n\t\t#else\n\t\t\tfloat shadow = getShadow{i}(lightDirW);\n\t\t#endif\n\t\tshadow = mix(1.0, shadow, light{i}_shadowIntensity);\n\t\tdAtten *= shadow;\n\t\t#if defined(LIT_SHADOW_CATCHER) && LIGHT{i}TYPE == DIRECTIONAL\n\t\t\tdShadowCatcher *= shadow;\n\t\t#endif\t\t\t\n\t#endif\n\t#if LIGHT{i}SHAPE != PUNCTUAL\n\t\t#ifdef LIT_SPECULAR\n\t\t\tdDiffuseLight += ((attenDiffuse * dAtten) * lightColor) * (1.0 - dLTCSpecFres);\n\t\t#else\n\t\t\tdDiffuseLight += (attenDiffuse * dAtten) * lightColor;\n\t\t#endif\t\t\t\t\t\t\n\t#else\n\t\t#if defined(AREA_LIGHTS) && defined(LIT_SPECULAR)\n\t\t\tdDiffuseLight += (dAtten * lightColor) * (1.0 - litArgs_specularity);\n\t\t#else\n\t\t\tdDiffuseLight += dAtten * lightColor;\n\t\t#endif\n\t#endif\n\t#ifdef LIGHT{i}AFFECT_SPECULARITY\n\t\t#if LIGHT{i}SHAPE != PUNCTUAL\n\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\t#if LIGHT{i}SHAPE == RECT\n\t\t\t\t\tccSpecularLight += ccLTCSpecFres * getRectLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor;\n\t\t\t\t#elif LIGHT{i}SHAPE == DISK\n\t\t\t\t\tccSpecularLight += ccLTCSpecFres * getDiskLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor;\n\t\t\t\t#elif LIGHT{i}SHAPE == SPHERE\n\t\t\t\t\tccSpecularLight += ccLTCSpecFres * getSphereLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\t#if LIGHT{i}SHAPE == RECT\n\t\t\t\t\tdSpecularLight += dLTCSpecFres * getRectLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor;\n\t\t\t\t#elif LIGHT{i}SHAPE == DISK\n\t\t\t\t\tdSpecularLight += dLTCSpecFres * getDiskLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor;\n\t\t\t\t#elif LIGHT{i}SHAPE == SPHERE\n\t\t\t\t\tdSpecularLight += dLTCSpecFres * getSphereLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t#else\n\t\t\t#if LIGHT{i}TYPE == DIRECTIONAL && LIT_FRESNEL_MODEL != NONE\n\t\t\t\t#define LIGHT{i}FRESNEL\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\tvec3 halfDirW = normalize(-dLightDirNormW + dViewDirW);\n\t\t\t#endif\n\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\tvec3 lightspecularCC = getLightSpecular(halfDirW, ccReflDirW, litArgs_clearcoat_worldNormal, dViewDirW, dLightDirNormW, litArgs_clearcoat_gloss, dTBN) * dAtten * lightColor;\n\t\t\t\t#ifdef LIGHT{i}FRESNEL\n\t\t\t\t\tlightspecularCC *= getFresnelCC(dot(dViewDirW, halfDirW));\n\t\t\t\t#endif\n\t\t\t\tccSpecularLight += lightspecularCC;\n\t\t\t#endif\n\t\t\t#ifdef LIT_SHEEN\n\t\t\t\tsSpecularLight += getLightSpecularSheen(halfDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_sheen_gloss) * dAtten * lightColor;\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\tvec3 lightSpecular = getLightSpecular(halfDirW, dReflDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_gloss, dTBN) * dAtten * lightColor;\n\t\t\t\t#ifdef LIGHT{i}FRESNEL\n\t\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\tlightSpecular *= getFresnel(dot(dViewDirW, halfDirW), litArgs_gloss, litArgs_specularity, iridescenceFresnel, litArgs_iridescence_intensity);\n\t\t\t\t\t#else\n\t\t\t\t\t\tlightSpecular *= getFresnel(dot(dViewDirW, halfDirW), litArgs_gloss, litArgs_specularity);\n\t\t\t\t\t#endif\n\t\t\t\t#else\n\t\t\t\t\tlightSpecular *= litArgs_specularity;\n\t\t\t\t#endif\n\t\t\t\t\n\t\t\t\tdSpecularLight += lightSpecular;\n\t\t\t#endif\n\t\t#endif\n\t#endif\n}\n#endif\n",lightFunctionShadowPS:"\n#ifdef LIGHT{i}CASTSHADOW\n\tvec3 getShadowSampleCoord{i}(mat4 shadowTransform, vec4 shadowParams, vec3 worldPosition, vec3 lightPos, inout vec3 lightDir, vec3 lightDirNorm, vec3 normal) {\n\t\tvec3 surfacePosition = worldPosition;\n\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_POINT\n\t\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET\n\t\t\t\tfloat distScale = length(lightDir);\n\t\t\t\tsurfacePosition = surfacePosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;\n\t\t\t\tlightDir = surfacePosition - lightPos;\n\t\t\t\treturn lightDir;\n\t\t\t#endif\n\t\t#else\n\t\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_SOURCE_ZBUFFER\n\t\t\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET\n\t\t\t\t\tsurfacePosition = surfacePosition + normal * shadowParams.y;\n\t\t\t\t#endif\n\t\t\t#else\n\t\t\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET\n\t\t\t\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_ORTHO\n\t\t\t\t\t\tfloat distScale = 1.0;\n\t\t\t\t\t#else\n\t\t\t\t\t\tfloat distScale = abs(dot(vPositionW - lightPos, lightDirNorm));\n\t\t\t\t\t#endif\n\t\t\t\t\tsurfacePosition = surfacePosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\tvec4 positionInShadowSpace = shadowTransform * vec4(surfacePosition, 1.0);\n\t\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_ORTHO\n\t\t\t\tpositionInShadowSpace.z = saturate(positionInShadowSpace.z) - 0.0001;\n\t\t\t#else\n\t\t\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_SOURCE_ZBUFFER\n\t\t\t\t\tpositionInShadowSpace.xyz /= positionInShadowSpace.w;\n\t\t\t\t#else\n\t\t\t\t\tpositionInShadowSpace.xy /= positionInShadowSpace.w;\n\t\t\t\t\tpositionInShadowSpace.z = length(lightDir) * shadowParams.w;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\tsurfacePosition = positionInShadowSpace.xyz;\n\t\t#endif\n\t\treturn surfacePosition;\n\t}\n\tfloat getShadow{i}(vec3 lightDirW) {\n\t\t#ifdef LIGHT{i}_SHADOW_CASCADES\n\t\t\tint cascadeIndex = getShadowCascadeIndex(light{i}_shadowCascadeDistances, light{i}_shadowCascadeCount);\n\t\t\t#ifdef LIGHT{i}_SHADOW_CASCADE_BLEND\n\t\t\t\tcascadeIndex = ditherShadowCascadeIndex(cascadeIndex, light{i}_shadowCascadeDistances, light{i}_shadowCascadeCount, light{i}_shadowCascadeBlend);\n\t\t\t#endif\n\t\t\tmat4 shadowMatrix = light{i}_shadowMatrixPalette[cascadeIndex];\n\t\t#else\n\t\t\tmat4 shadowMatrix = light{i}_shadowMatrix;\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\tvec3 shadowCoord = getShadowSampleCoord{i}(shadowMatrix, light{i}_shadowParams, vPositionW, vec3(0.0), lightDirW, dLightDirNormW, dVertexNormalW);\n\t\t#else\n\t\t\tvec3 shadowCoord = getShadowSampleCoord{i}(shadowMatrix, light{i}_shadowParams, vPositionW, light{i}_position, lightDirW, dLightDirNormW, dVertexNormalW);\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\tshadowCoord = fadeShadow(shadowCoord, light{i}_shadowCascadeDistances);\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\t#if LIGHT{i}SHADOWTYPE == VSM_16F\n\t\t\t\treturn getShadowVSM16(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, 5.54);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == VSM_32F\n\t\t\t\treturn getShadowVSM32(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, 15.0);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCSS_32F\n\t\t\t\t#if LIGHT{i}SHAPE != PUNCTUAL\n\t\t\t\t\tvec2 shadowSearchArea = vec2(length(light{i}_halfWidth), length(light{i}_halfHeight)) * light{i}_shadowSearchArea;\n\t\t\t\t\treturn getShadowPCSS(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, light{i}_cameraParams, shadowSearchArea, lightDirW);\n\t\t\t\t#else\n\t\t\t\t\treturn getShadowPCSS(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, light{i}_cameraParams, light{i}_softShadowParams, lightDirW);\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F\n\t\t\t\treturn getShadowPCF1x1(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F\n\t\t\t\treturn getShadowPCF3x3(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF5_16F || LIGHT{i}SHADOWTYPE == PCF5_32F\n\t\t\t\treturn getShadowPCF5x5(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);\n\t\t\t#endif\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == SPOT\n\t\t\t#if LIGHT{i}SHADOWTYPE == VSM_16F\n\t\t\t\treturn getShadowSpotVSM16(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, 5.54, lightDirW);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == VSM_32F\n\t\t\t\treturn getShadowSpotVSM32(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, 15.0, lightDirW);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCSS_32F\n\t\t\t\t#if LIGHT{i}SHAPE != PUNCTUAL\n\t\t\t\t\tvec2 shadowSearchArea = vec2(length(light{i}_halfWidth), length(light{i}_halfHeight)) * light{i}_shadowSearchArea;\n\t\t\t\t#else\n\t\t\t\t\tvec2 shadowSearchArea = vec2(light{i}_shadowSearchArea);\n\t\t\t\t#endif\n\t\t\t\treturn getShadowSpotPCSS(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, light{i}_cameraParams, shadowSearchArea, lightDirW);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F\n\t\t\t\treturn getShadowSpotPCF1x1(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F\n\t\t\t\treturn getShadowSpotPCF3x3(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF5_16F || LIGHT{i}SHADOWTYPE == PCF5_32F\n\t\t\t\treturn getShadowSpotPCF5x5(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);\n\t\t\t#endif\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == OMNI\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCSS_32F\n\t\t\t\t#if LIGHT{i}SHAPE != PUNCTUAL\n\t\t\t\t\tvec2 shadowSearchArea = vec2(length(light{i}_halfWidth), length(light{i}_halfHeight)) * light{i}_shadowSearchArea;\n\t\t\t\t#else\n\t\t\t\t\tvec2 shadowSearchArea = vec2(light{i}_shadowSearchArea);\n\t\t\t\t#endif\n\t\t\t\treturn getShadowOmniPCSS(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, light{i}_cameraParams, shadowSearchArea, lightDirW);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F\n\t\t\t\treturn getShadowOmniPCF1x1(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, lightDirW);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F\n\t\t\t\treturn getShadowOmniPCF3x3(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, lightDirW);\n\t\t\t#endif\n\t\t#endif\n\t}\n#endif\n",lightingPS:'\n#ifdef LIT_CLUSTERED_LIGHTS\n\t#define LIT_CODE_FALLOFF_LINEAR\n\t#define LIT_CODE_FALLOFF_SQUARED\n\t#define LIT_CODE_LIGHTS_POINT\n\t#define LIT_CODE_LIGHTS_SPOT\n#endif\n#ifdef AREA_LIGHTS\n\tuniform highp sampler2D areaLightsLutTex1;\n\tuniform highp sampler2D areaLightsLutTex2;\n#endif\n#ifdef LIT_LIGHTING\n\t#include "lightDiffuseLambertPS"\n\t#if defined(AREA_LIGHTS) || defined(LIT_CLUSTERED_AREA_LIGHTS)\n\t\t#include "ltcPS"\n\t#endif\n#endif\n#ifdef SHADOW_DIRECTIONAL\n\t#include "shadowCascadesPS"\n#endif\n#if defined(SHADOW_KIND_PCF1)\n\t#include "shadowPCF1PS"\n#endif\n#if defined(SHADOW_KIND_PCF3)\n\t#include "shadowPCF3PS"\n#endif\n#if defined(SHADOW_KIND_PCF5)\n\t#include "shadowPCF5PS"\n#endif\n#if defined(SHADOW_KIND_PCSS)\n\t#include "linearizeDepthPS"\n\t#include "shadowPCSSPS"\n\t#include "shadowSoftPS"\n#endif\n#if defined(SHADOW_KIND_VSM)\n\t#include "shadowEVSMPS"\n#endif\n#ifdef LIT_CODE_FALLOFF_LINEAR\n\t#include "falloffLinearPS"\n#endif\n#ifdef LIT_CODE_FALLOFF_SQUARED\n\t#include "falloffInvSquaredPS"\n#endif\n#ifdef LIT_CODE_LIGHTS_POINT\n\t#include "lightDirPointPS"\n#endif\n#ifdef LIT_CODE_LIGHTS_SPOT\n\t#include "spotPS"\n#endif\n#ifdef LIT_CODE_COOKIE\n\t#include "cookiePS"\n#endif\n#ifdef LIT_CLUSTERED_LIGHTS\n\t#include "clusteredLightPS"\n#endif\n#ifdef LIGHT_COUNT > 0\n\t#include "lightFunctionShadowPS, LIGHT_COUNT"\n\t#include "lightFunctionLightPS, LIGHT_COUNT"\n#endif\n',lightmapAddPS:"\nvoid addLightMap(\n\tvec3 lightmap, \n\tvec3 dir, \n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tvec3 reflectionDir, \n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 vertexNormal, \n\tmat3 tbn\n#if defined(LIT_IRIDESCENCE)\n\tvec3 iridescenceFresnel, \n\tfloat iridescenceIntensity\n#endif\n) {\n\t#if defined(LIT_SPECULAR) && defined(LIT_DIR_LIGHTMAP)\n\t\tif (dot(dir, dir) < 0.0001) {\n\t\t\t\tdDiffuseLight += lightmap;\n\t\t} else {\n\t\t\tfloat vlight = saturate(dot(dir, -vertexNormal));\n\t\t\tfloat flight = saturate(dot(dir, -worldNormal));\n\t\t\tfloat nlight = (flight / max(vlight, 0.01)) * 0.5;\n\t\t\tdDiffuseLight += lightmap * nlight * 2.0;\n\t\t\tvec3 halfDir = normalize(-dir + viewDir);\n\t\t\tvec3 specularLight = lightmap * getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, dir, gloss, tbn);\n\t\t\t#ifdef LIT_SPECULAR_FRESNEL\n\t\t\t\tspecularLight *= \n\t\t\t\t\tgetFresnel(dot(viewDir, halfDir), \n\t\t\t\t\tgloss, \n\t\t\t\t\tspecularity\n\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t, iridescenceFresnel,\n\t\t\t\t\tiridescenceIntensity\n\t\t\t\t#endif\n\t\t\t\t\t);\n\t\t\t#endif\n\t\t\tdSpecularLight += specularLight;\n\t\t}\n\t#else\n\t\tdDiffuseLight += lightmap;\n\t#endif\n}\n",lightmapPS:"\n#ifdef STD_LIGHTMAP_DIR\n\tvec3 dLightmapDir;\n\tuniform sampler2D texture_dirLightMap;\n#endif\nvoid getLightMap() {\n\tdLightmap = vec3(1.0);\n\t#ifdef STD_LIGHT_TEXTURE\n\t\tdLightmap *= {STD_LIGHT_TEXTURE_DECODE}(texture2DBias({STD_LIGHT_TEXTURE_NAME}, {STD_LIGHT_TEXTURE_UV}, textureBias)).{STD_LIGHT_TEXTURE_CHANNEL};\n\t\t#ifdef STD_LIGHTMAP_DIR\n\t\t\tvec3 dir = texture2DBias(texture_dirLightMap, {STD_LIGHT_TEXTURE_UV}, textureBias).xyz * 2.0 - 1.0;\n\t\t\tfloat dirDot = dot(dir, dir);\n\t\t\tdLightmapDir = (dirDot > 0.001) ? dir / sqrt(dirDot) : vec3(0.0);\n\t\t#endif\n\t#endif\n\t#ifdef STD_LIGHT_VERTEX\n\t\tdLightmap *= saturate(vVertexColor.{STD_LIGHT_VERTEX_CHANNEL});\n\t#endif\n}\n",lightSpecularAnisoGGXPS:"\nfloat calcLightSpecular(float gloss, vec3 worldNormal, vec3 viewDir, vec3 h, vec3 lightDirNorm, mat3 tbn) {\n\tfloat PI = 3.141592653589793;\n\tfloat roughness = max((1.0 - gloss) * (1.0 - gloss), 0.001);\n\tfloat anisotropy = material_anisotropy * roughness;\n \n\tfloat at = max((roughness + anisotropy), roughness / 4.0);\n\tfloat ab = max((roughness - anisotropy), roughness / 4.0);\n\tfloat NoH = dot(worldNormal, h);\n\tfloat ToH = dot(tbn[0], h);\n\tfloat BoH = dot(tbn[1], h);\n\tfloat a2 = at * ab;\n\tvec3 v = vec3(ab * ToH, at * BoH, a2 * NoH);\n\tfloat v2 = dot(v, v);\n\tfloat w2 = a2 / v2;\n\tfloat D = a2 * w2 * w2 * (1.0 / PI);\n\tfloat ToV = dot(tbn[0], viewDir);\n\tfloat BoV = dot(tbn[1], viewDir);\n\tfloat ToL = dot(tbn[0], -lightDirNorm);\n\tfloat BoL = dot(tbn[1], -lightDirNorm);\n\tfloat NoV = dot(worldNormal, viewDir);\n\tfloat NoL = dot(worldNormal, -lightDirNorm);\n\tfloat lambdaV = NoL * length(vec3(at * ToV, ab * BoV, NoV));\n\tfloat lambdaL = NoV * length(vec3(at * ToL, ab * BoL, NoL));\n\tfloat G = 0.5 / (lambdaV + lambdaL);\n\treturn D * G;\n}\nfloat getLightSpecular(vec3 h, vec3 reflDir, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float gloss, mat3 tbn) {\n\treturn calcLightSpecular(gloss, worldNormal, viewDir, h, lightDirNorm, tbn);\n}\n",lightSpecularBlinnPS:"\nfloat calcLightSpecular(float gloss, vec3 worldNormal, vec3 h) {\n\tfloat nh = max( dot( h, worldNormal ), 0.0 );\n\tfloat specPow = exp2(gloss * 11.0);\n\tspecPow = max(specPow, 0.0001);\n\treturn pow(nh, specPow) * (specPow + 2.0) / 8.0;\n}\nfloat getLightSpecular(vec3 h, vec3 reflDir, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float gloss, mat3 tbn) {\n\treturn calcLightSpecular(gloss, worldNormal, h);\n}\n",lightSheenPS:"\nfloat sheenD(vec3 normal, vec3 h, float roughness) {\n\tconst float PI = 3.141592653589793;\n\tfloat invR = 1.0 / (roughness * roughness);\n\tfloat cos2h = max(dot(normal, h), 0.0);\n\tcos2h *= cos2h;\n\tfloat sin2h = max(1.0 - cos2h, 0.0078125);\n\treturn (2.0 + invR) * pow(sin2h, invR * 0.5) / (2.0 * PI);\n}\nfloat sheenV(vec3 normal, vec3 viewDir, vec3 light) {\n\tfloat NoV = max(dot(normal, viewDir), 0.000001);\n\tfloat NoL = max(dot(normal, light), 0.000001);\n\treturn 1.0 / (4.0 * (NoL + NoV - NoL * NoV));\n}\nfloat getLightSpecularSheen(vec3 h, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float sheenGloss) {\n\tfloat D = sheenD(worldNormal, h, sheenGloss);\n\tfloat V = sheenV(worldNormal, viewDir, -lightDirNorm);\n\treturn D * V;\n}\n",linearizeDepthPS:"\n#ifndef LINEARIZE_DEPTH\n#define LINEARIZE_DEPTH\nfloat linearizeDepth(float z, vec4 cameraParams) {\n\tif (cameraParams.w == 0.0)\n\t\treturn (cameraParams.z * cameraParams.y) / (cameraParams.y + z * (cameraParams.z - cameraParams.y));\n\telse\n\t\treturn cameraParams.z + z * (cameraParams.y - cameraParams.z);\n}\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\nfloat linearizeDepth(float z) {\n\treturn linearizeDepth(z, camera_params);\n}\n#endif\n",litForwardBackendPS:'\nvoid evaluateBackend() {\n\t#ifdef LIT_SSAO\n\t\tlitArgs_ao *= texture2DLod(ssaoTexture, gl_FragCoord.xy * ssaoTextureSizeInv, 0.0).r;\n\t#endif\n\t#ifdef LIT_NEEDS_NORMAL\n\t\t#ifdef LIT_SPECULAR\n\t\t\tgetReflDir(litArgs_worldNormal, dViewDirW, litArgs_gloss, dTBN);\n\t\t#endif\n\t\t#ifdef LIT_CLEARCOAT\n\t\t\tccReflDirW = normalize(-reflect(dViewDirW, litArgs_clearcoat_worldNormal));\n\t\t#endif\n\t#endif\n\t#ifdef LIT_SPECULAR_OR_REFLECTION\n\t\t#ifdef LIT_METALNESS\n\t\t\tfloat f0 = 1.0 / litArgs_ior;\n\t\t\tf0 = (f0 - 1.0) / (f0 + 1.0);\n\t\t\tf0 *= f0;\n\t\t\tlitArgs_specularity = getSpecularModulate(litArgs_specularity, litArgs_albedo, litArgs_metalness, f0);\n\t\t\tlitArgs_albedo = getAlbedoModulate(litArgs_albedo, litArgs_metalness);\n\t\t#endif\n\t\t#ifdef LIT_IRIDESCENCE\n\t\t\tvec3 iridescenceFresnel = getIridescence(saturate(dot(dViewDirW, litArgs_worldNormal)), litArgs_specularity, litArgs_iridescence_thickness);\n\t\t#endif\n\t#endif\n\t#ifdef LIT_ADD_AMBIENT\n\t\taddAmbient(litArgs_worldNormal);\n\t\t#ifdef LIT_SPECULAR\n\t\t\tdDiffuseLight = dDiffuseLight * (1.0 - litArgs_specularity);\n\t\t#endif\n\t\t#ifdef LIT_SEPARATE_AMBIENT\n\t\t\tvec3 dAmbientLight = dDiffuseLight;\n\t\t\tdDiffuseLight = vec3(0);\n\t\t#endif\n\t#endif\n\t#ifndef LIT_OLD_AMBIENT\n\t\tdDiffuseLight *= material_ambient;\n\t#endif\n\t#ifdef LIT_AO\n\t\t#ifndef LIT_OCCLUDE_DIRECT\n\t\t\toccludeDiffuse(litArgs_ao);\n\t\t#endif\n\t#endif\n\t#ifdef LIT_LIGHTMAP\n\t\taddLightMap(\n\t\t\tlitArgs_lightmap, \n\t\t\tlitArgs_lightmapDir, \n\t\t\tlitArgs_worldNormal, \n\t\t\tdViewDirW, \n\t\t\tdReflDirW, \n\t\t\tlitArgs_gloss, \n\t\t\tlitArgs_specularity, \n\t\t\tdVertexNormalW,\n\t\t\tdTBN\n\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t, iridescenceFresnel,\n\t\t\tlitArgs_iridescence_intensity\n\t\t#endif\n\t\t);\n\t#endif\n\t#ifdef LIT_LIGHTING || LIT_REFLECTIONS\n\t\t#ifdef LIT_REFLECTIONS\n\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\taddReflectionCC(ccReflDirW, litArgs_clearcoat_gloss);\n\t\t\t\n\t\t\t\t#ifdef LIT_SPECULAR_FRESNEL\n\t\t\t\t\tccFresnel = getFresnelCC(dot(dViewDirW, litArgs_clearcoat_worldNormal));\n\t\t\t\t\tccReflection.rgb *= ccFresnel;\n\t\t\t\t#else\n\t\t\t\t\tccFresnel = 0.0;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULARITY_FACTOR\n\t\t\t\tccReflection.rgb *= litArgs_specularityFactor;\n\t\t\t#endif\n\t\t\t#ifdef LIT_SHEEN\n\t\t\t\taddReflectionSheen(litArgs_worldNormal, dViewDirW, litArgs_sheen_gloss);\n\t\t\t#endif\n\t\t\taddReflection(dReflDirW, litArgs_gloss);\n\t\t\t#ifdef LIT_FRESNEL_MODEL\n\t\t\t\tdReflection.rgb *= getFresnel(\n\t\t\t\t\tdot(dViewDirW, litArgs_worldNormal), \n\t\t\t\t\tlitArgs_gloss, \n\t\t\t\t\tlitArgs_specularity\n\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t, iridescenceFresnel,\n\t\t\t\t\tlitArgs_iridescence_intensity\n\t\t\t\t#endif\n\t\t\t\t\t);\n\t\t\t#else\n\t\t\t\tdReflection.rgb *= litArgs_specularity;\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULARITY_FACTOR\n\t\t\t\tdReflection.rgb *= litArgs_specularityFactor;\n\t\t\t#endif\n\t\t#endif\n\t\t#ifdef AREA_LIGHTS\n\t\t\tdSpecularLight *= litArgs_specularity;\n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\tcalcLTCLightValues(litArgs_gloss, litArgs_worldNormal, dViewDirW, litArgs_specularity, litArgs_clearcoat_gloss, litArgs_clearcoat_worldNormal, litArgs_clearcoat_specularity);\n\t\t\t#endif\n\t\t#endif\n\t\t\n\t\t#include "lightEvaluationPS, LIGHT_COUNT"\n\t\t#ifdef LIT_CLUSTERED_LIGHTS\n\t\t\taddClusteredLights(litArgs_worldNormal, dViewDirW, dReflDirW,\n\t\t\t\t#if defined(LIT_CLEARCOAT)\n\t\t\t\t\t\tccReflDirW,\n\t\t\t\t#endif\n\t\t\t\t\t\tlitArgs_gloss, litArgs_specularity, dVertexNormalW, dTBN, \n\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\tiridescenceFresnel,\n\t\t\t\t#endif\n\t\t\t\t\t\tlitArgs_clearcoat_worldNormal, litArgs_clearcoat_gloss, litArgs_sheen_gloss, litArgs_iridescence_intensity\n\t\t\t);\n\t\t#endif\n\t\t#ifdef AREA_LIGHTS\n\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\tlitArgs_clearcoat_specularity = 1.0;\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\tlitArgs_specularity = vec3(1);\n\t\t\t#endif\n\t\t#endif\n\t\t#ifdef LIT_REFRACTION\n\t\t\taddRefraction(\n\t\t\t\tlitArgs_worldNormal, \n\t\t\t\tdViewDirW, \n\t\t\t\tlitArgs_thickness, \n\t\t\t\tlitArgs_gloss, \n\t\t\t\tlitArgs_specularity, \n\t\t\t\tlitArgs_albedo, \n\t\t\t\tlitArgs_transmission,\n\t\t\t\tlitArgs_ior,\n\t\t\t\tlitArgs_dispersion\n\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t, iridescenceFresnel, \n\t\t\t\t\tlitArgs_iridescence_intensity\n\t\t\t\t#endif\n\t\t\t);\n\t\t#endif\n\t#endif\n\t#ifdef LIT_AO\n\t\t#ifdef LIT_OCCLUDE_DIRECT\n\t\t\toccludeDiffuse(litArgs_ao);\n\t\t#endif\n\t\t#if LIT_OCCLUDE_SPECULAR != NONE\n\t\t\toccludeSpecular(litArgs_gloss, litArgs_ao, litArgs_worldNormal, dViewDirW);\n\t\t#endif\n\t#endif\n\t#ifdef LIT_SPECULARITY_FACTOR\n\t\tdSpecularLight *= litArgs_specularityFactor;\n\t#endif\n\t#if !defined(LIT_OPACITY_FADES_SPECULAR)\n\t\t#if LIT_BLEND_TYPE == NORMAL || LIT_BLEND_TYPE == PREMULTIPLIED\n\t\t\tfloat specLum = dot((dSpecularLight + dReflection.rgb * dReflection.a), vec3( 0.2126, 0.7152, 0.0722 ));\n\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\tspecLum += dot(ccSpecularLight * litArgs_clearcoat_specularity + ccReflection.rgb * litArgs_clearcoat_specularity, vec3( 0.2126, 0.7152, 0.0722 ));\n\t\t\t#endif\n\t\t\tlitArgs_opacity = clamp(litArgs_opacity + gammaCorrectInput(specLum), 0.0, 1.0);\n\t\t#endif\n\t\tlitArgs_opacity *= material_alphaFade;\n\t#endif\n\t#include "endPS"\n\t#include "outputAlphaPS"\n\t#ifdef LIT_MSDF\n\t\tgl_FragColor = applyMsdf(gl_FragColor);\n\t#endif\n\t#include "outputPS"\n\t#include "debugOutputPS"\n\t#ifdef LIT_SHADOW_CATCHER\n\t\tgl_FragColor.rgb = vec3(dShadowCatcher);\n\t#endif\n}\n',litForwardDeclarationPS:'\nvec3 sReflection;\nvec3 dVertexNormalW;\nvec3 dTangentW;\nvec3 dBinormalW;\nvec3 dViewDirW;\nvec3 dReflDirW;\nvec3 ccReflDirW;\nvec3 dLightDirNormW;\nfloat dAtten;\nmat3 dTBN;\nvec4 dReflection;\nvec3 dDiffuseLight;\nvec3 dSpecularLight;\nfloat ccFresnel;\nvec3 ccReflection;\nvec3 ccSpecularLight;\nfloat ccSpecularityNoFres;\nvec3 sSpecularLight;\n#ifdef LIT_DISPERSION\n\tuniform float material_dispersion;\n#endif\n#ifndef LIT_OPACITY_FADES_SPECULAR\n\tuniform float material_alphaFade;\n#endif\n#ifdef LIT_SSAO\n\tuniform sampler2D ssaoTexture;\n\tuniform vec2 ssaoTextureSizeInv;\n#endif\n#ifdef LIT_SHADOW_CATCHER\n\tfloat dShadowCatcher = 1.0;\n#endif\n#if LIGHT_COUNT > 0\n\t#include "lightDeclarationPS, LIGHT_COUNT"\n#endif\n#ifdef LIT_SPECULAR\n\t#if LIT_FRESNEL_MODEL == NONE && !defined(LIT_REFLECTIONS) && !defined(LIT_DIFFUSE_MAP) \n\t\t#define LIT_OLD_AMBIENT\n\t#endif\n#endif\n',litForwardMainPS:'\nvoid main(void) {\n\tdReflection = vec4(0);\n\t#ifdef LIT_CLEARCOAT\n\t\tccSpecularLight = vec3(0);\n\t\tccReflection = vec3(0);\n\t#endif\n\t#if LIT_NONE_SLICE_MODE == SLICED\n\t\t#include "startNineSlicedPS"\n\t#elif LIT_NONE_SLICE_MODE == TILED\n\t\t#include "startNineSlicedTiledPS"\n\t#endif\n\t#ifdef LIT_NEEDS_NORMAL\n\t\tdVertexNormalW = normalize(vNormalW);\n\t\t#ifdef LIT_TANGENTS\n\t\t\t#if defined(LIT_HEIGHTS) || defined(LIT_USE_NORMALS) || defined(LIT_USE_CLEARCOAT_NORMALS)\n\t\t\t\tdTangentW = vTangentW;\n\t\t\t\tdBinormalW = vBinormalW;\n\t\t\t#endif\n\t\t#endif\n\t\tgetViewDir();\n\t\t#ifdef LIT_TBN\n\t\t\tgetTBN(dTangentW, dBinormalW, dVertexNormalW);\n\t\t\t#ifdef LIT_TWO_SIDED_LIGHTING\n\t\t\t\thandleTwoSidedLighting();\n\t\t\t#endif\n\t\t#endif\n\t#endif\n\tevaluateFrontend();\n\t#include "debugProcessFrontendPS"\n\tevaluateBackend();\n}\n',litForwardPostCodePS:'\n#ifdef LIT_NEEDS_NORMAL\n\t#include "cubeMapRotatePS"\n\t#include "cubeMapProjectPS"\n\t#include "envProcPS"\n#endif\n#ifdef LIT_SPECULAR_OR_REFLECTION\n\t#ifdef LIT_METALNESS\n\t\t#include "metalnessModulatePS"\n\t#endif\n\t#if LIT_FRESNEL_MODEL == SCHLICK\n\t\t#include "fresnelSchlickPS"\n\t#endif\n\t#ifdef LIT_IRIDESCENCE\n\t\t#include "iridescenceDiffractionPS"\n\t#endif\n#endif\n#ifdef LIT_AO\n\t#include "aoDiffuseOccPS"\n\t#include "aoSpecOccPS"\n#endif\n#if LIT_REFLECTION_SOURCE == ENVATLASHQ\n\t#include "envAtlasPS"\n\t#include "reflectionEnvHQPS"\n#elif LIT_REFLECTION_SOURCE == ENVATLAS\n\t#include "envAtlasPS"\n\t#include "reflectionEnvPS"\n#elif LIT_REFLECTION_SOURCE == CUBEMAP\n\t#include "reflectionCubePS"\n#elif LIT_REFLECTION_SOURCE == SPHEREMAP\n\t#include "reflectionSpherePS"\n#endif\n#ifdef LIT_REFLECTIONS\n\t#ifdef LIT_CLEARCOAT\n\t\t#include "reflectionCCPS"\n\t#endif\n\t#ifdef LIT_SHEEN\n\t\t#include "reflectionSheenPS"\n\t#endif\n#endif\n#ifdef LIT_REFRACTION\n\t#if defined(LIT_DYNAMIC_REFRACTION)\n\t\t#include "refractionDynamicPS"\n\t#elif defined(LIT_REFLECTIONS)\n\t\t#include "refractionCubePS"\n\t#endif\n#endif\n#ifdef LIT_SHEEN\n\t#include "lightSheenPS"\n#endif\n#ifdef LIT_GGX_SPECULAR\n\tuniform float material_anisotropy;\n#endif\nuniform vec3 material_ambient;\n#ifdef LIT_SPECULAR\n\t#ifdef LIT_LIGHTING\n\t\t#ifdef LIT_GGX_SPECULAR\n\t\t\t#include "lightSpecularAnisoGGXPS"\n\t\t#else\n\t\t\t#include "lightSpecularBlinnPS"\n\t\t#endif\n\t#endif\n#endif\n#include "combinePS"\n#ifdef LIT_LIGHTMAP\n\t#include "lightmapAddPS"\n#endif\n#ifdef LIT_ADD_AMBIENT\n\t#include "ambientPS"\n#endif\n#ifdef LIT_MSDF\n\t#include "msdfPS"\n#endif\n#ifdef LIT_NEEDS_NORMAL\n\t#include "viewDirPS"\n\t#ifdef LIT_SPECULAR\n\t\t#ifdef LIT_GGX_SPECULAR\n\t\t\t#include "reflDirAnisoPS"\n\t\t#else\n\t\t\t#include "reflDirPS"\n\t\t#endif\n\t#endif\n#endif\n#include "lightingPS"\n',litForwardPreCodePS:'\n#include "basePS"\n#include "sphericalPS"\n#include "decodePS"\n#include "gammaPS"\n#include "tonemappingPS"\n#include "fogPS"\n#if LIT_NONE_SLICE_MODE == SLICED\n\t#include "baseNineSlicedPS"\n#elif LIT_NONE_SLICE_MODE == TILED\n\t#include "baseNineSlicedTiledPS"\n#endif\n#ifdef LIT_TBN\n\t#include "TBNPS"\n\t#ifdef LIT_TWO_SIDED_LIGHTING\n\t\t#include "twoSidedLightingPS"\n\t#endif\n#endif\n',litMainVS:'\n#ifdef VERTEX_COLOR\n\tattribute vec4 vertex_color;\n#endif\n#ifdef NINESLICED\n\tvarying vec2 vMask;\n\tvarying vec2 vTiledUv;\n\tuniform mediump vec4 innerOffset;\n\tuniform mediump vec2 outerScale;\n\tuniform mediump vec4 atlasRect;\n#endif\nvec3 dPositionW;\nmat4 dModelMatrix;\n#include "transformCoreVS"\n#ifdef UV0\n\tattribute vec2 vertex_texCoord0;\n\t#include "uv0VS"\n#endif\n#ifdef UV1\n\tattribute vec2 vertex_texCoord1;\n\t#include "uv1VS"\n#endif\n#ifdef LINEAR_DEPTH\n\t#ifndef VIEWMATRIX\n\t#define VIEWMATRIX\n\t\tuniform mat4 matrix_view;\n\t#endif\n#endif\n#include "transformVS"\n#ifdef NORMALS\n\t#include "normalCoreVS"\n\t#include "normalVS"\n#endif\n#ifdef TANGENTS\n\tattribute vec4 vertex_tangent;\n\t#include "tangentBinormalVS"\n#endif\n#include "uvTransformUniformsPS, UV_TRANSFORMS_COUNT"\n#ifdef MSDF\n\t#include "msdfVS"\n#endif\nvoid main(void) {\n\tgl_Position = getPosition();\n\tvPositionW = getWorldPosition();\n\t#ifdef NORMALS\n\t\tvNormalW = getNormal();\n\t#endif\n\t#ifdef TANGENTS\n\t\tvTangentW = getTangent();\n\t\tvBinormalW = getBinormal();\n\t#elif defined(GGX_SPECULAR)\n\t\tvObjectSpaceUpW = normalize(dNormalMatrix * vec3(0, 1, 0));\n\t#endif\n\t#ifdef UV0\n\t\tvec2 uv0 = getUv0();\n\t\t#ifdef UV0_UNMODIFIED\n\t\t\tvUv0 = uv0;\n\t\t#endif\n\t#endif\n\t#ifdef UV1\n\t\tvec2 uv1 = getUv1();\n\t\t#ifdef UV1_UNMODIFIED\n\t\t\tvUv1 = uv1;\n\t\t#endif\n\t#endif\n\t#include "uvTransformVS, UV_TRANSFORMS_COUNT"\n\t#ifdef VERTEX_COLOR\n\t\tvVertexColor = vertex_color;\n\t#endif\n\t#ifdef LINEAR_DEPTH\n\t\tvLinearDepth = -(matrix_view * vec4(vPositionW, 1.0)).z;\n\t#endif\n\t#ifdef MSDF\n\t\tunpackMsdfParams();\n\t#endif\n}\n',litOtherMainPS:'\n#ifdef PICK_PASS\n\t#include "pickPS"\n#endif\n#ifdef PREPASS_PASS\n\t#include "floatAsUintPS"\n#endif\nvoid main(void) {\n\tevaluateFrontend();\n\t#ifdef PICK_PASS\n\t\tgl_FragColor = getPickOutput();\n\t#endif\n\t#ifdef DEPTH_PASS\n\t\tgl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);\n\t#endif\n\t#ifdef PREPASS_PASS\n\t\tgl_FragColor = float2vec4(vLinearDepth);\n\t#endif\n}\n',litShaderArgsPS:"\nvec3 litArgs_albedo;\nfloat litArgs_opacity;\nvec3 litArgs_emission;\nvec3 litArgs_worldNormal;\nfloat litArgs_ao;\nvec3 litArgs_lightmap;\nvec3 litArgs_lightmapDir;\nfloat litArgs_metalness;\nvec3 litArgs_specularity;\nfloat litArgs_specularityFactor;\nfloat litArgs_gloss;\nfloat litArgs_sheen_gloss;\nvec3 litArgs_sheen_specularity;\nfloat litArgs_transmission;\nfloat litArgs_thickness;\nfloat litArgs_ior;\nfloat litArgs_dispersion;\nfloat litArgs_iridescence_intensity;\nfloat litArgs_iridescence_thickness;\nvec3 litArgs_clearcoat_worldNormal;\nfloat litArgs_clearcoat_specularity;\nfloat litArgs_clearcoat_gloss;\n",litShaderCorePS:'\n\t#if LIT_NONE_SLICE_MODE == TILED\n\t\tconst float textureBias = -1000.0;\n\t#else\n\t\tuniform float textureBias;\n\t#endif\n\t#include "litShaderArgsPS"\n',litShadowMainPS:'\n#if LIGHT_TYPE != DIRECTIONAL\n\tuniform vec3 view_position;\n\tuniform float light_radius;\n#endif\n#if SHADOW_TYPE == PCSS_32F\n\t#include "linearizeDepthPS"\n#endif\nvoid main(void) {\n\tevaluateFrontend();\n\t#ifdef PERSPECTIVE_DEPTH\n\t\tfloat depth = gl_FragCoord.z;\n\t\t#if SHADOW_TYPE == PCSS_32F\n\t\t\t#if LIGHT_TYPE != DIRECTIONAL\n\t\t\t\tdepth = linearizeDepth(depth, camera_params);\n\t\t\t#endif\n\t\t#endif\n\t#else\n\t\tfloat depth = min(distance(view_position, vPositionW) / light_radius, 0.99999);\n\t\t#define MODIFIED_DEPTH\n\t#endif\n\t#if SHADOW_TYPE == VSM_16F || SHADOW_TYPE == VSM_32F\n\t\t#if SHADOW_TYPE == VSM_32F\n\t\t\tfloat exponent = 15.0;\n\t\t#else\n\t\t\tfloat exponent = 5.54;\n\t\t#endif\n\t\tdepth = 2.0 * depth - 1.0;\n\t\tdepth =  exp(exponent * depth);\n\t\tgl_FragColor = vec4(depth, depth*depth, 1.0, 1.0);\n\t#else\n\t\t#if SHADOW_TYPE == PCSS_32F\n\t\t\tgl_FragColor.r = depth;\n\t\t#else\n\t\t\t#ifdef MODIFIED_DEPTH\n\t\t\t\tgl_FragDepth = depth;\n\t\t\t#endif\n\t\t\tgl_FragColor = vec4(1.0);\n\t\t#endif\n\t#endif\n}\n',ltcPS:"\nmat3 transposeMat3( const in mat3 m ) {\n\tmat3 tmp;\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\treturn tmp;\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tfloat dotNV = saturate( dot( N, V ) );\n\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nstruct Coords {\n\tvec3 coord0;\n\tvec3 coord1;\n\tvec3 coord2;\n\tvec3 coord3;\n};\nfloat LTC_EvaluateRect( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in Coords rectCoords) {\n\tvec3 v1 = rectCoords.coord1 - rectCoords.coord0;\n\tvec3 v2 = rectCoords.coord3 - rectCoords.coord0;\n\t\n\tvec3 lightNormal = cross( v1, v2 );\n\tfloat factor = sign(-dot( lightNormal, P - rectCoords.coord0 ));\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 =  factor * cross( N, T1 );\n\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords.coord0 - P );\n\tcoords[ 1 ] = mat * ( rectCoords.coord1 - P );\n\tcoords[ 2 ] = mat * ( rectCoords.coord2 - P );\n\tcoords[ 3 ] = mat * ( rectCoords.coord3 - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\treturn result;\n}\nCoords dLTCCoords;\nCoords getLTCLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){\n\tCoords coords;\n\tcoords.coord0 = lightPos + halfWidth - halfHeight;\n\tcoords.coord1 = lightPos - halfWidth - halfHeight;\n\tcoords.coord2 = lightPos - halfWidth + halfHeight;\n\tcoords.coord3 = lightPos + halfWidth + halfHeight;\n\treturn coords;\n}\nfloat dSphereRadius;\nCoords getSphereLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){\n\tdSphereRadius = max(length(halfWidth), length(halfHeight));\n\tvec3 f = reflect(normalize(lightPos - view_position), vNormalW);\n\tvec3 w = normalize(cross(f, halfHeight));\n\tvec3 h = normalize(cross(f, w));\n\treturn getLTCLightCoords(lightPos, w * dSphereRadius, h * dSphereRadius);\n}\nvec2 dLTCUV;\n#ifdef LIT_CLEARCOAT\nvec2 ccLTCUV;\n#endif\nvec2 getLTCLightUV(float gloss, vec3 worldNormal, vec3 viewDir)\n{\n\tfloat roughness = max((1.0 - gloss) * (1.0 - gloss), 0.001);\n\treturn LTC_Uv( worldNormal, viewDir, roughness );\n}\nvec3 dLTCSpecFres;\n#ifdef LIT_CLEARCOAT\nvec3 ccLTCSpecFres;\n#endif\nvec3 getLTCLightSpecFres(vec2 uv, vec3 specularity)\n{\n\tvec4 t2 = texture2DLod(areaLightsLutTex2, uv, 0.0);\n\treturn specularity * t2.x + ( vec3( 1.0 ) - specularity) * t2.y;\n}\nvoid calcLTCLightValues(float gloss, vec3 worldNormal, vec3 viewDir, vec3 specularity, float clearcoatGloss, vec3 clearcoatWorldNormal, float clearcoatSpecularity)\n{\n\tdLTCUV = getLTCLightUV(gloss, worldNormal, viewDir);\n\tdLTCSpecFres = getLTCLightSpecFres(dLTCUV, specularity); \n#ifdef LIT_CLEARCOAT\n\tccLTCUV = getLTCLightUV(clearcoatGloss, clearcoatWorldNormal, viewDir);\n\tccLTCSpecFres = getLTCLightSpecFres(ccLTCUV, vec3(clearcoatSpecularity));\n#endif\n}\nvoid calcRectLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\tdLTCCoords = getLTCLightCoords(lightPos, halfWidth, halfHeight);\n}\nvoid calcDiskLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\tcalcRectLightValues(lightPos, halfWidth, halfHeight);\n}\nvoid calcSphereLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\tdLTCCoords = getSphereLightCoords(lightPos, halfWidth, halfHeight);\n}\nvec3 SolveCubic(vec4 Coefficient)\n{\n\tfloat pi = 3.14159;\n\tCoefficient.xyz /= Coefficient.w;\n\tCoefficient.yz /= 3.0;\n\tfloat A = Coefficient.w;\n\tfloat B = Coefficient.z;\n\tfloat C = Coefficient.y;\n\tfloat D = Coefficient.x;\n\tvec3 Delta = vec3(\n\t\t-Coefficient.z * Coefficient.z + Coefficient.y,\n\t\t-Coefficient.y * Coefficient.z + Coefficient.x,\n\t\tdot(vec2(Coefficient.z, -Coefficient.y), Coefficient.xy)\n\t);\n\tfloat Discriminant = dot(vec2(4.0 * Delta.x, -Delta.y), Delta.zy);\n\tvec3 RootsA, RootsD;\n\tvec2 xlc, xsc;\n\t{\n\t\tfloat A_a = 1.0;\n\t\tfloat C_a = Delta.x;\n\t\tfloat D_a = -2.0 * B * Delta.x + Delta.y;\n\t\tfloat Theta = atan(sqrt(Discriminant), -D_a) / 3.0;\n\t\tfloat x_1a = 2.0 * sqrt(-C_a) * cos(Theta);\n\t\tfloat x_3a = 2.0 * sqrt(-C_a) * cos(Theta + (2.0 / 3.0) * pi);\n\t\tfloat xl;\n\t\tif ((x_1a + x_3a) > 2.0 * B)\n\t\t\txl = x_1a;\n\t\telse\n\t\t\txl = x_3a;\n\t\txlc = vec2(xl - B, A);\n\t}\n\t{\n\t\tfloat A_d = D;\n\t\tfloat C_d = Delta.z;\n\t\tfloat D_d = -D * Delta.y + 2.0 * C * Delta.z;\n\t\tfloat Theta = atan(D * sqrt(Discriminant), -D_d) / 3.0;\n\t\tfloat x_1d = 2.0 * sqrt(-C_d) * cos(Theta);\n\t\tfloat x_3d = 2.0 * sqrt(-C_d) * cos(Theta + (2.0 / 3.0) * pi);\n\t\tfloat xs;\n\t\tif (x_1d + x_3d < 2.0 * C)\n\t\t\txs = x_1d;\n\t\telse\n\t\t\txs = x_3d;\n\t\txsc = vec2(-D, xs + C);\n\t}\n\tfloat E =  xlc.y * xsc.y;\n\tfloat F = -xlc.x * xsc.y - xlc.y * xsc.x;\n\tfloat G =  xlc.x * xsc.x;\n\tvec2 xmc = vec2(C * F - B * G, -B * F + C * E);\n\tvec3 Root = vec3(xsc.x / xsc.y, xmc.x / xmc.y, xlc.x / xlc.y);\n\tif (Root.x < Root.y && Root.x < Root.z)\n\t\tRoot.xyz = Root.yxz;\n\telse if (Root.z < Root.x && Root.z < Root.y)\n\t\tRoot.xyz = Root.xzy;\n\treturn Root;\n}\nfloat LTC_EvaluateDisk(vec3 N, vec3 V, vec3 P, mat3 Minv, Coords points)\n{\n\tvec3 T1, T2;\n\tT1 = normalize(V - N * dot(V, N));\n\tT2 = cross(N, T1);\n\tmat3 R = transposeMat3( mat3( T1, T2, N ) );\n\tvec3 L_[ 3 ];\n\tL_[ 0 ] = R * ( points.coord0 - P );\n\tL_[ 1 ] = R * ( points.coord1 - P );\n\tL_[ 2 ] = R * ( points.coord2 - P );\n\tvec3 Lo_i = vec3(0);\n\tvec3 C  = 0.5 * (L_[0] + L_[2]);\n\tvec3 V1 = 0.5 * (L_[1] - L_[2]);\n\tvec3 V2 = 0.5 * (L_[1] - L_[0]);\n\tC  = Minv * C;\n\tV1 = Minv * V1;\n\tV2 = Minv * V2;\n\tfloat a, b;\n\tfloat d11 = dot(V1, V1);\n\tfloat d22 = dot(V2, V2);\n\tfloat d12 = dot(V1, V2);\n\tif (abs(d12) / sqrt(d11 * d22) > 0.0001)\n\t{\n\t\tfloat tr = d11 + d22;\n\t\tfloat det = -d12 * d12 + d11 * d22;\n\t\tdet = sqrt(det);\n\t\tfloat u = 0.5 * sqrt(tr - 2.0 * det);\n\t\tfloat v = 0.5 * sqrt(tr + 2.0 * det);\n\t\tfloat e_max = (u + v) * (u + v);\n\t\tfloat e_min = (u - v) * (u - v);\n\t\tvec3 V1_, V2_;\n\t\tif (d11 > d22)\n\t\t{\n\t\t\tV1_ = d12 * V1 + (e_max - d11) * V2;\n\t\t\tV2_ = d12 * V1 + (e_min - d11) * V2;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tV1_ = d12*V2 + (e_max - d22)*V1;\n\t\t\tV2_ = d12*V2 + (e_min - d22)*V1;\n\t\t}\n\t\ta = 1.0 / e_max;\n\t\tb = 1.0 / e_min;\n\t\tV1 = normalize(V1_);\n\t\tV2 = normalize(V2_);\n\t}\n\telse\n\t{\n\t\ta = 1.0 / dot(V1, V1);\n\t\tb = 1.0 / dot(V2, V2);\n\t\tV1 *= sqrt(a);\n\t\tV2 *= sqrt(b);\n\t}\n\tvec3 V3 = normalize(cross(V1, V2));\n\tif (dot(C, V3) < 0.0)\n\t\tV3 *= -1.0;\n\tfloat L  = dot(V3, C);\n\tfloat x0 = dot(V1, C) / L;\n\tfloat y0 = dot(V2, C) / L;\n\tfloat E1 = inversesqrt(a);\n\tfloat E2 = inversesqrt(b);\n\ta *= L * L;\n\tb *= L * L;\n\tfloat c0 = a * b;\n\tfloat c1 = a * b * (1.0 + x0 * x0 + y0 * y0) - a - b;\n\tfloat c2 = 1.0 - a * (1.0 + x0 * x0) - b * (1.0 + y0 * y0);\n\tfloat c3 = 1.0;\n\tvec3 roots = SolveCubic(vec4(c0, c1, c2, c3));\n\tfloat e1 = roots.x;\n\tfloat e2 = roots.y;\n\tfloat e3 = roots.z;\n\tvec3 avgDir = vec3(a * x0 / (a - e2), b * y0 / (b - e2), 1.0);\n\tmat3 rotate = mat3(V1, V2, V3);\n\tavgDir = rotate * avgDir;\n\tavgDir = normalize(avgDir);\n\tfloat L1 = sqrt(-e2 / e3);\n\tfloat L2 = sqrt(-e2 / e1);\n\tfloat formFactor = max(0.0, L1 * L2 * inversesqrt((1.0 + L1 * L1) * (1.0 + L2 * L2)));\n\t\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tvec2 uv = vec2(avgDir.z * 0.5 + 0.5, formFactor);\n\tuv = uv*LUT_SCALE + LUT_BIAS;\n\tfloat scale = texture2DLod(areaLightsLutTex2, uv, 0.0).w;\n\treturn formFactor*scale;\n}\nfloat FixNan(float value) {\n\t#ifdef WEBGPU\n\t\treturn value != value ? 0.0 : value;\n\t#else\n\t\treturn isnan(value) ? 0.0 : value;\n\t#endif\n}\nfloat getRectLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {\n\treturn LTC_EvaluateRect( worldNormal, viewDir, vPositionW, mat3( 1.0 ), dLTCCoords );\n}\nfloat getDiskLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {\n\treturn FixNan(LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, mat3( 1.0 ), dLTCCoords ));\n}\nfloat getSphereLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {\n\tfloat falloff = dSphereRadius / (dot(lightDir, lightDir) + dSphereRadius);\n\treturn FixNan(getLightDiffuse(worldNormal, viewDir, lightDirNorm) * falloff);\n}\nmat3 getLTCLightInvMat(vec2 uv)\n{\n\tvec4 t1 = texture2DLod(areaLightsLutTex1, uv, 0.0);\n\treturn mat3(\n\t\tvec3( t1.x, 0, t1.y ),\n\t\tvec3(\t0, 1,\t0 ),\n\t\tvec3( t1.z, 0, t1.w )\n\t);\n}\nfloat calcRectLightSpecular(vec3 worldNormal, vec3 viewDir, vec2 uv) {\n\tmat3 mInv = getLTCLightInvMat(uv);\n\treturn LTC_EvaluateRect( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );\n}\nfloat getRectLightSpecular(vec3 worldNormal, vec3 viewDir) {\n\treturn calcRectLightSpecular(worldNormal, viewDir, dLTCUV);\n}\nfloat calcDiskLightSpecular(vec3 worldNormal, vec3 viewDir, vec2 uv) {\n\tmat3 mInv = getLTCLightInvMat(uv);\n\treturn LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );\n}\nfloat getDiskLightSpecular(vec3 worldNormal, vec3 viewDir) {\n\treturn calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);\n}\nfloat getSphereLightSpecular(vec3 worldNormal, vec3 viewDir) {\n\treturn calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);\n}\n",metalnessPS:"\n#ifdef STD_METALNESS_CONSTANT\nuniform float material_metalness;\n#endif\nvoid getMetalness() {\n\tfloat metalness = 1.0;\n\t#ifdef STD_METALNESS_CONSTANT\n\tmetalness *= material_metalness;\n\t#endif\n\t#ifdef STD_METALNESS_TEXTURE\n\tmetalness *= texture2DBias({STD_METALNESS_TEXTURE_NAME}, {STD_METALNESS_TEXTURE_UV}, textureBias).{STD_METALNESS_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_METALNESS_VERTEX\n\tmetalness *= saturate(vVertexColor.{STD_METALNESS_VERTEX_CHANNEL});\n\t#endif\n\tdMetalness = metalness;\n}\n",metalnessModulatePS:"\nvec3 getSpecularModulate(in vec3 specularity, in vec3 albedo, in float metalness, in float f0) {\n\tvec3 dielectricF0 = f0 * specularity;\n\treturn mix(dielectricF0, albedo, metalness);\n}\nvec3 getAlbedoModulate(in vec3 albedo, in float metalness) {\n\treturn albedo * (1.0 - metalness);\n}\n",morphEvaluationPS:"\n\tcolor.xyz += morphFactor[{i}] * texture2DLod(morphBlendTex{i}, uv0, 0.0).xyz;\n",morphDeclarationPS:"\n\tuniform highp sampler2D morphBlendTex{i};\n",morphPS:'\n\tvarying vec2 uv0;\n\t#include "morphDeclarationPS, MORPH_TEXTURE_COUNT"\n\t#if MORPH_TEXTURE_COUNT > 0\n\t\tuniform highp float morphFactor[{MORPH_TEXTURE_COUNT}];\n\t#endif\n\t#ifdef MORPH_INT\n\t\tuniform vec3 aabbSize;\n\t\tuniform vec3 aabbMin;\n\t#endif\n\tvoid main (void) {\n\t\thighp vec4 color = vec4(0, 0, 0, 1);\n\t\t#include "morphEvaluationPS, MORPH_TEXTURE_COUNT"\n\t\t#ifdef MORPH_INT\n\t\t\tcolor.xyz = (color.xyz - aabbMin) / aabbSize * 65535.0;\n\t\t\tgl_FragColor = uvec4(color);\n\t\t#else\n\t\t\tgl_FragColor = color;\n\t\t#endif\n\t}\n',morphVS:"\n\tattribute vec2 vertex_position;\n\tvarying vec2 uv0;\n\tvoid main(void) {\n\t\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\t\tuv0 = vertex_position.xy * 0.5 + 0.5;\n\t}\n",msdfPS:"\nuniform sampler2D texture_msdfMap;\nfloat median(float r, float g, float b) {\n\treturn max(min(r, g), min(max(r, g), b));\n}\nfloat map (float min, float max, float v) {\n\treturn (v - min) / (max - min);\n}\nuniform float font_sdfIntensity;\nuniform float font_pxrange;\nuniform float font_textureWidth;\n#ifndef LIT_MSDF_TEXT_ATTRIBUTE\n\tuniform vec4 outline_color;\n\tuniform float outline_thickness;\n\tuniform vec4 shadow_color;\n\tuniform vec2 shadow_offset;\n#else\n\tvarying vec4 outline_color;\n\tvarying float outline_thickness;\n\tvarying vec4 shadow_color;\n\tvarying vec2 shadow_offset;\n#endif\nvec4 applyMsdf(vec4 color) {\n\tcolor.rgb = gammaCorrectInput(color.rgb);\n\tvec3 tsample = texture2D(texture_msdfMap, vUv0).rgb;\n\tvec2 uvShdw = vUv0 - shadow_offset;\n\tvec3 ssample = texture2D(texture_msdfMap, uvShdw).rgb;\n\tfloat sigDist = median(tsample.r, tsample.g, tsample.b);\n\tfloat sigDistShdw = median(ssample.r, ssample.g, ssample.b);\n\tfloat smoothingMax = 0.2;\n\tvec2 w = fwidth(vUv0);\n\tfloat smoothing = clamp(w.x * font_textureWidth / font_pxrange, 0.0, smoothingMax);\n\tfloat mapMin = 0.05;\n\tfloat mapMax = clamp(1.0 - font_sdfIntensity, mapMin, 1.0);\n\tfloat sigDistInner = map(mapMin, mapMax, sigDist);\n\tfloat sigDistOutline = map(mapMin, mapMax, sigDist + outline_thickness);\n\tsigDistShdw = map(mapMin, mapMax, sigDistShdw + outline_thickness);\n\tfloat center = 0.5;\n\tfloat inside = smoothstep(center-smoothing, center+smoothing, sigDistInner);\n\tfloat outline = smoothstep(center-smoothing, center+smoothing, sigDistOutline);\n\tfloat shadow = smoothstep(center-smoothing, center+smoothing, sigDistShdw);\n\tvec4 tcolor = (outline > inside) ? outline * vec4(outline_color.a * outline_color.rgb, outline_color.a) : vec4(0.0);\n\ttcolor = mix(tcolor, color, inside);\n\tvec4 scolor = (shadow > outline) ? shadow * vec4(shadow_color.a * shadow_color.rgb, shadow_color.a) : tcolor;\n\ttcolor = mix(scolor, tcolor, outline);\n\ttcolor.rgb = gammaCorrectOutput(tcolor.rgb);\n\t\n\treturn tcolor;\n}\n",msdfVS:"\nattribute vec3 vertex_outlineParameters;\nattribute vec3 vertex_shadowParameters;\nvarying vec4 outline_color;\nvarying float outline_thickness;\nvarying vec4 shadow_color;\nvarying vec2 shadow_offset;\nvoid unpackMsdfParams() {\n\tvec3 little = mod(vertex_outlineParameters, 256.);\n\tvec3 big = (vertex_outlineParameters - little) / 256.;\n\toutline_color.rb = little.xy / 255.;\n\toutline_color.ga = big.xy / 255.;\n\toutline_thickness = little.z / 255. * 0.2;\n\tlittle = mod(vertex_shadowParameters, 256.);\n\tbig = (vertex_shadowParameters - little) / 256.;\n\tshadow_color.rb = little.xy / 255.;\n\tshadow_color.ga = big.xy / 255.;\n\tshadow_offset = (vec2(little.z, big.z) / 127. - 1.) * 0.005;\n}\n",normalVS:"\nmat3 dNormalMatrix;\nvec3 getNormal() {\n\tdNormalMatrix = getNormalMatrix(dModelMatrix);\n\tvec3 localNormal = getLocalNormal(vertex_normal);\n\treturn normalize(dNormalMatrix * localNormal);\n}\n",normalCoreVS:"\nattribute vec3 vertex_normal;\n#ifdef MORPHING_NORMAL\n\t#ifdef MORPHING_INT\n\t\tuniform highp usampler2D morphNormalTex;\n\t#else\n\t\tuniform highp sampler2D morphNormalTex;\n\t#endif\n#endif\nvec3 getLocalNormal(vec3 vertexNormal) {\n\tvec3 localNormal = vertex_normal;\n\t#ifdef MORPHING_NORMAL\n\t\tivec2 morphUV = getTextureMorphCoords();\n\t\t#ifdef MORPHING_INT\n\t\t\tvec3 morphNormal = vec3(texelFetch(morphNormalTex, ivec2(morphUV), 0).xyz) / 65535.0 * 2.0 - 1.0;\n\t\t#else\n\t\t\tvec3 morphNormal = texelFetch(morphNormalTex, ivec2(morphUV), 0).xyz;\n\t\t#endif\n\t\tlocalNormal += morphNormal;\n\t#endif\n\treturn localNormal;\n}\n#ifdef SKIN\n\tmat3 getNormalMatrix(mat4 modelMatrix) {\n\t\treturn mat3(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);\n\t}\n#elif defined(INSTANCING)\n\tmat3 getNormalMatrix(mat4 modelMatrix) {\n\t\treturn mat3(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);\n\t}\n#else\n\tmat3 getNormalMatrix(mat4 modelMatrix) {\n\t\treturn matrix_normal;\n\t}\n#endif\n",normalMapPS:"\n#ifdef STD_NORMAL_TEXTURE\nuniform float material_bumpiness;\n#endif\n#ifdef STD_NORMALDETAIL_TEXTURE\nuniform float material_normalDetailMapBumpiness;\nvec3 blendNormals(vec3 n1, vec3 n2) {\n\tn1 += vec3(0, 0, 1);\n\tn2 *= vec3(-1, -1, 1);\n\treturn n1 * dot(n1, n2) / n1.z - n2;\n}\n#endif\nvoid getNormal() {\n#ifdef STD_NORMAL_TEXTURE\n\tvec3 normalMap = {STD_NORMAL_TEXTURE_DECODE}(texture2DBias({STD_NORMAL_TEXTURE_NAME}, {STD_NORMAL_TEXTURE_UV}, textureBias));\n\tnormalMap = mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpiness);\n\t#ifdef STD_NORMALDETAIL_TEXTURE\n\t\tvec3 normalDetailMap = {STD_NORMALDETAIL_TEXTURE_DECODE}(texture2DBias({STD_NORMALDETAIL_TEXTURE_NAME}, {STD_NORMALDETAIL_TEXTURE_UV}, textureBias));\n\t\tnormalDetailMap = mix(vec3(0.0, 0.0, 1.0), normalDetailMap, material_normalDetailMapBumpiness);\n\t\tnormalMap = blendNormals(normalMap, normalDetailMap);\n\t#endif\n\tdNormalW = normalize(dTBN * normalMap);\n#else\n\tdNormalW = dVertexNormalW;\n#endif\n}\n",opacityPS:"\nuniform float material_opacity;\nvoid getOpacity() {\n\tdAlpha = material_opacity;\n\t#ifdef STD_OPACITY_TEXTURE\n\tdAlpha *= texture2DBias({STD_OPACITY_TEXTURE_NAME}, {STD_OPACITY_TEXTURE_UV}, textureBias).{STD_OPACITY_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_OPACITY_VERTEX\n\tdAlpha *= clamp(vVertexColor.{STD_OPACITY_VERTEX_CHANNEL}, 0.0, 1.0);\n\t#endif\n}\n",opacityDitherPS:'\n#if STD_OPACITY_DITHER == BAYER8\n\t#include "bayerPS"\n#endif\nuniform vec4 blueNoiseJitter;\n#if STD_OPACITY_DITHER == BLUENOISE\n\tuniform sampler2D blueNoiseTex32;\n#endif\nvoid opacityDither(float alpha, float id) {\n\t#if STD_OPACITY_DITHER == BAYER8\n\t\tfloat noise = bayer8(floor(mod(gl_FragCoord.xy + blueNoiseJitter.xy + id, 8.0))) / 64.0;\n\t#else\n\t\t#if STD_OPACITY_DITHER == BLUENOISE\n\t\t\tvec2 uv = fract(gl_FragCoord.xy / 32.0 + blueNoiseJitter.xy + id);\n\t\t\tfloat noise = texture2DLod(blueNoiseTex32, uv, 0.0).y;\n\t\t#endif\n\t\t#if STD_OPACITY_DITHER == IGNNOISE\n\t\t\tvec3 magic = vec3(0.06711056, 0.00583715, 52.9829189);\n\t\t\tfloat noise = fract(magic.z * fract(dot(gl_FragCoord.xy + blueNoiseJitter.xy + id, magic.xy)));\n\t\t#endif\n\t#endif\n\tnoise = pow(noise, 2.2);\n\tif (alpha < noise)\n\t\tdiscard;\n}\n',outputPS:"\n",outputAlphaPS:"\n#if LIT_BLEND_TYPE == NORMAL || LIT_BLEND_TYPE == ADDITIVEALPHA || defined(LIT_ALPHA_TO_COVERAGE)\n\tgl_FragColor.a = litArgs_opacity;\n#elif LIT_BLEND_TYPE == PREMULTIPLIED\n\tgl_FragColor.rgb *= litArgs_opacity;\n\tgl_FragColor.a = litArgs_opacity;\n#else\n\tgl_FragColor.a = 1.0;\n#endif\n",outputTex2DPS:"\nvarying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n\tgl_FragColor = texture2D(source, vUv0);\n}\n",sheenPS:"\nuniform vec3 material_sheen;\nvoid getSheen() {\n\tvec3 sheenColor = material_sheen;\n\t#ifdef STD_SHEEN_TEXTURE\n\tsheenColor *= {STD_SHEEN_TEXTURE_DECODE}(texture2DBias({STD_SHEEN_TEXTURE_NAME}, {STD_SHEEN_TEXTURE_UV}, textureBias)).{STD_SHEEN_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_SHEEN_VERTEX\n\tsheenColor *= saturate(vVertexColor.{STD_SHEEN_VERTEX_CHANNEL});\n\t#endif\n\tsSpecularity = sheenColor;\n}\n",sheenGlossPS:"\nuniform float material_sheenGloss;\nvoid getSheenGlossiness() {\n\tfloat sheenGlossiness = material_sheenGloss;\n\t#ifdef STD_SHEENGLOSS_TEXTURE\n\tsheenGlossiness *= texture2DBias({STD_SHEENGLOSS_TEXTURE_NAME}, {STD_SHEENGLOSS_TEXTURE_UV}, textureBias).{STD_SHEENGLOSS_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_SHEENGLOSS_VERTEX\n\tsheenGlossiness *= saturate(vVertexColor.{STD_SHEENGLOSS_VERTEX_CHANNEL});\n\t#endif\n\t#ifdef STD_SHEENGLOSS_INVERT\n\tsheenGlossiness = 1.0 - sheenGlossiness;\n\t#endif\n\tsGlossiness = sheenGlossiness + 0.0000001;\n}\n",parallaxPS:"\nuniform float material_heightMapFactor;\nvoid getParallax() {\n\tfloat parallaxScale = material_heightMapFactor;\n\tfloat height = texture2DBias({STD_HEIGHT_TEXTURE_NAME}, {STD_HEIGHT_TEXTURE_UV}, textureBias).{STD_HEIGHT_TEXTURE_CHANNEL};\n\theight = height * parallaxScale - parallaxScale*0.5;\n\tvec3 viewDirT = dViewDirW * dTBN;\n\tviewDirT.z += 0.42;\n\tdUvOffset = height * (viewDirT.xy / viewDirT.z);\n}\n",particlePS:"\nvarying vec4 texCoordsAlphaLife;\nuniform sampler2D colorMap;\nuniform sampler2D colorParam;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\nuniform float softening;\nuniform float colorMult;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvoid main(void) {\n\tvec4 tex  = texture2D(colorMap, vec2(texCoordsAlphaLife.x, 1.0 - texCoordsAlphaLife.y));\n\tvec4 ramp = texture2D(colorParam, vec2(texCoordsAlphaLife.w, 0.0));\n\tramp.rgb *= colorMult;\n\tramp.a += texCoordsAlphaLife.z;\n\tvec3 rgb = tex.rgb * ramp.rgb;\n\tfloat a  = tex.a * ramp.a;\n",particleVS:"\nvec3 unpack3NFloats(float src) {\n\tfloat r = fract(src);\n\tfloat g = fract(src * 256.0);\n\tfloat b = fract(src * 65536.0);\n\treturn vec3(r, g, b);\n}\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec4 tex1Dlod_lerp(TEXTURE_ACCEPT_HIGHP(tex), vec2 tc) {\n\treturn mix( texture2D(tex,tc), texture2D(tex,tc + graphSampleSize), fract(tc.x*graphNumSamples) );\n}\nvec4 tex1Dlod_lerp(TEXTURE_ACCEPT_HIGHP(tex), vec2 tc, out vec3 w) {\n\tvec4 a = texture2D(tex,tc);\n\tvec4 b = texture2D(tex,tc + graphSampleSize);\n\tfloat c = fract(tc.x*graphNumSamples);\n\tvec3 unpackedA = unpack3NFloats(a.w);\n\tvec3 unpackedB = unpack3NFloats(b.w);\n\tw = mix(unpackedA, unpackedB, c);\n\treturn mix(a, b, c);\n}\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix) {\n\tfloat c = cos(pRotation);\n\tfloat s = sin(pRotation);\n\tmat2 m = mat2(c, -s, s, c);\n\trotMatrix = m;\n\treturn m * quadXY;\n}\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY) {\n\t#ifdef SCREEN_SPACE\n\t\tvec3 pos = vec3(-1, 0, 0) * quadXY.x + vec3(0, -1, 0) * quadXY.y;\n\t#else\n\t\tvec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n\t#endif\n\treturn pos;\n}\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY) {\n\tvec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n\treturn pos;\n}\nvec2 safeNormalize(vec2 v) {\n\tfloat l = length(v);\n\treturn (l > 1e-06) ? v / l : v;\n}\nvoid main(void) {\n\tvec3 meshLocalPos = particle_vertexData.xyz;\n\tfloat id = floor(particle_vertexData.w);\n\tfloat rndFactor = fract(sin(id + 1.0 + seed));\n\tvec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n\tfloat uv = id / numParticlesPot;\n\treadInput(uv);\n#ifdef LOCAL_SPACE\n\tinVel = mat3(matrix_model) * inVel;\n#endif\n\tvec2 velocityV = safeNormalize((mat3(matrix_view) * inVel).xy);\n\tfloat particleLifetime = lifetime;\n\tif (inLife <= 0.0 || inLife > particleLifetime || !inShow) meshLocalPos = vec3(0.0);\n\tvec2 quadXY = meshLocalPos.xy;\n\tfloat nlife = clamp(inLife / particleLifetime, 0.0, 1.0);\n\tvec3 paramDiv;\n\tvec4 params = tex1Dlod_lerp(TEXTURE_PASS(internalTex2), vec2(nlife, 0), paramDiv);\n\tfloat scale = params.y;\n\tfloat scaleDiv = paramDiv.x;\n\tfloat alphaDiv = paramDiv.z;\n\tscale += (scaleDiv * 2.0 - 1.0) * scaleDivMult * fract(rndFactor*10000.0);\n#ifndef USE_MESH\n\ttexCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#else\n\ttexCoordsAlphaLife = vec4(particle_uv, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#endif\n\tvec3 particlePos = inPos;\n\tvec3 particlePosMoved = vec3(0.0);\n\tmat2 rotMatrix;\n",particleAnimFrameClampVS:"\n\tfloat animFrame = min(floor(texCoordsAlphaLife.w * animTexParams.y) + animTexParams.x, animTexParams.z);\n",particleAnimFrameLoopVS:"\n\tfloat animFrame = floor(mod(texCoordsAlphaLife.w * animTexParams.y + animTexParams.x, animTexParams.z + 1.0));\n",particleAnimTexVS:"\n\tfloat animationIndex;\n\tif (animTexIndexParams.y == 1.0) {\n\t\tanimationIndex = floor((animTexParams.w + 1.0) * rndFactor3.z) * (animTexParams.z + 1.0);\n\t} else {\n\t\tanimationIndex = animTexIndexParams.x * (animTexParams.z + 1.0);\n\t}\n\tfloat atlasX = (animationIndex + animFrame) * animTexTilesParams.x;\n\tfloat atlasY = 1.0 - floor(atlasX + 1.0) * animTexTilesParams.y;\n\tatlasX = fract(atlasX);\n\ttexCoordsAlphaLife.xy *= animTexTilesParams.xy;\n\ttexCoordsAlphaLife.xy += vec2(atlasX, atlasY);\n",particleInputFloatPS:"\nvoid readInput(float uv) {\n\tvec4 tex = texture2D(particleTexIN, vec2(uv, 0.25));\n\tvec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.75));\n\tinPos = tex.xyz;\n\tinVel = tex2.xyz;\n\tinAngle = (tex.w < 0.0? -tex.w : tex.w) - 1000.0;\n\tinShow = tex.w >= 0.0;\n\tinLife = tex2.w;\n}\n",particleInputRgba8PS:"\n#define PI2 6.283185307179586\nuniform vec3 inBoundsSize;\nuniform vec3 inBoundsCenter;\nuniform float maxVel;\nfloat decodeFloatRG(vec2 rg) {\n\treturn rg.y*(1.0/255.0) + rg.x;\n}\nfloat decodeFloatRGBA( vec4 rgba ) {\n  return dot( rgba, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) );\n}\nvoid readInput(float uv) {\n\tvec4 tex0 = texture2D(particleTexIN, vec2(uv, 0.125));\n\tvec4 tex1 = texture2D(particleTexIN, vec2(uv, 0.375));\n\tvec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.625));\n\tvec4 tex3 = texture2D(particleTexIN, vec2(uv, 0.875));\n\tinPos = vec3(decodeFloatRG(tex0.rg), decodeFloatRG(tex0.ba), decodeFloatRG(tex1.rg));\n\tinPos = (inPos - vec3(0.5)) * inBoundsSize + inBoundsCenter;\n\tinVel = tex2.xyz;\n\tinVel = (inVel - vec3(0.5)) * maxVel;\n\tinAngle = decodeFloatRG(tex1.ba) * PI2;\n\tinShow = tex2.a > 0.5;\n\tinLife = decodeFloatRGBA(tex3);\n\tfloat maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n\tfloat maxPosLife = lifetime+1.0;\n\tinLife = inLife * (maxNegLife + maxPosLife) - maxNegLife;\n}\n",particleOutputFloatPS:"\nvoid writeOutput() {\n\tif (gl_FragCoord.y<1.0) {\n\t\tgl_FragColor = vec4(outPos, (outAngle + 1000.0) * visMode);\n\t} else {\n\t\tgl_FragColor = vec4(outVel, outLife);\n\t}\n}\n",particleOutputRgba8PS:"\nuniform vec3 outBoundsMul;\nuniform vec3 outBoundsAdd;\nvec2 encodeFloatRG( float v ) {\n\tvec2 enc = vec2(1.0, 255.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n\treturn enc;\n}\nvec4 encodeFloatRGBA( float v ) {\n\tvec4 enc = vec4(1.0, 255.0, 65025.0, 160581375.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n\treturn enc;\n}\nvoid writeOutput() {\n\toutPos = outPos * outBoundsMul + outBoundsAdd;\n\toutAngle = fract(outAngle / PI2);\n\toutVel = (outVel / maxVel) + vec3(0.5);\n\tfloat maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n\tfloat maxPosLife = lifetime+1.0;\n\toutLife = (outLife + maxNegLife) / (maxNegLife + maxPosLife);\n\tif (gl_FragCoord.y < 1.0) {\n\t\tgl_FragColor = vec4(encodeFloatRG(outPos.x), encodeFloatRG(outPos.y));\n\t} else if (gl_FragCoord.y < 2.0) {\n\t\tgl_FragColor = vec4(encodeFloatRG(outPos.z), encodeFloatRG(outAngle));\n\t} else if (gl_FragCoord.y < 3.0) {\n\t\tgl_FragColor = vec4(outVel, visMode*0.5+0.5);\n\t} else {\n\t\tgl_FragColor = encodeFloatRGBA(outLife);\n\t}\n}\n",particleUpdaterAABBPS:"\nuniform mat3 spawnBounds;\nuniform vec3 spawnPosInnerRatio;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n\tvec3 pos = inBounds - vec3(0.5);\n\tvec3 posAbs = abs(pos);\n\tvec3 maxPos = vec3(max(posAbs.x, max(posAbs.y, posAbs.z)));\n\tvec3 edge = maxPos + (vec3(0.5) - maxPos) * spawnPosInnerRatio;\n\tpos.x = edge.x * (maxPos.x == posAbs.x ? sign(pos.x) : 2.0 * pos.x);\n\tpos.y = edge.y * (maxPos.y == posAbs.y ? sign(pos.y) : 2.0 * pos.y);\n\tpos.z = edge.z * (maxPos.z == posAbs.z ? sign(pos.z) : 2.0 * pos.z);\n#ifndef LOCAL_SPACE\n\treturn emitterPos + spawnBounds * pos;\n#else\n\treturn spawnBounds * pos;\n#endif\n}\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n\tlocalVelocity -= vec3(0, 0, initialVelocity);\n}\n",particleUpdaterEndPS:"\n\twriteOutput();\n}\n",particleUpdaterInitPS:"\nvarying vec2 vUv0;\nuniform highp sampler2D particleTexIN;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\nuniform highp sampler2D internalTex3;\nuniform mat3 emitterMatrix;\nuniform mat3 emitterMatrixInv;\nuniform vec3 emitterScale;\nuniform vec3 emitterPos;\nuniform vec3 frameRandom;\nuniform vec3 localVelocityDivMult;\nuniform vec3 velocityDivMult;\nuniform float delta;\nuniform float rate;\nuniform float rateDiv;\nuniform float lifetime;\nuniform float numParticles;\nuniform float rotSpeedDivMult;\nuniform float radialSpeedDivMult;\nuniform float seed;\nuniform float startAngle;\nuniform float startAngle2;\nuniform float initialVelocity;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\nfloat visMode;\nvec3 outPos;\nvec3 outVel;\nfloat outAngle;\nbool outShow;\nfloat outLife;\n",particleUpdaterNoRespawnPS:"\n\tif (outLife >= lifetime) {\n\t\toutLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n\t\tvisMode = -1.0;\n\t}\n",particleUpdaterOnStopPS:"\n\tvisMode = outLife < 0.0? -1.0: visMode;\n",particleUpdaterRespawnPS:"\n\tif (outLife >= lifetime) {\n\t\toutLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n\t\tvisMode = 1.0;\n\t}\n\tvisMode = outLife < 0.0? 1.0: visMode;\n",particleUpdaterSpherePS:"\nuniform float spawnBoundsSphere;\nuniform float spawnBoundsSphereInnerRatio;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n\tfloat rnd4 = fract(rndFactor * 1000.0);\n\tvec3 norm = normalize(inBounds.xyz - vec3(0.5));\n\tfloat r = rnd4 * (1.0 - spawnBoundsSphereInnerRatio) + spawnBoundsSphereInnerRatio;\n#ifndef LOCAL_SPACE\n\treturn emitterPos + norm * r * spawnBoundsSphere;\n#else\n\treturn norm * r * spawnBoundsSphere;\n#endif\n}\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n\tlocalVelocity += normalize(inBounds - vec3(0.5)) * initialVelocity;\n}\n",particleUpdaterStartPS:"\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec3 unpack3NFloats(float src) {\n\tfloat r = fract(src);\n\tfloat g = fract(src * 256.0);\n\tfloat b = fract(src * 65536.0);\n\treturn vec3(r, g, b);\n}\nvec3 tex1Dlod_lerp(TEXTURE_ACCEPT_HIGHP(tex), vec2 tc, out vec3 w) {\n\tvec4 a = texture2D(tex, tc);\n\tvec4 b = texture2D(tex, tc + graphSampleSize);\n\tfloat c = fract(tc.x * graphNumSamples);\n\tvec3 unpackedA = unpack3NFloats(a.w);\n\tvec3 unpackedB = unpack3NFloats(b.w);\n\tw = mix(unpackedA, unpackedB, c);\n\treturn mix(a.xyz, b.xyz, c);\n}\n#define HASHSCALE4 vec4(1031, .1030, .0973, .1099)\nvec4 hash41(float p) {\n\tvec4 p4 = fract(vec4(p) * HASHSCALE4);\n\tp4 += dot(p4, p4.wzxy+19.19);\n\treturn fract(vec4((p4.x + p4.y)*p4.z, (p4.x + p4.z)*p4.y, (p4.y + p4.z)*p4.w, (p4.z + p4.w)*p4.x));\n}\nvoid main(void) {\n\tif (gl_FragCoord.x > numParticles) discard;\n\treadInput(vUv0.x);\n\tvisMode = inShow? 1.0 : -1.0;\n\tvec4 rndFactor = hash41(gl_FragCoord.x + seed);\n\tfloat particleRate = rate + rateDiv * rndFactor.x;\n\toutLife = inLife + delta;\n\tfloat nlife = clamp(outLife / lifetime, 0.0, 1.0);\n\tvec3 localVelocityDiv;\n\tvec3 velocityDiv;\n\tvec3 paramDiv;\n\tvec3 localVelocity = tex1Dlod_lerp(TEXTURE_PASS(internalTex0), vec2(nlife, 0), localVelocityDiv);\n\tvec3 velocity =\t  tex1Dlod_lerp(TEXTURE_PASS(internalTex1), vec2(nlife, 0), velocityDiv);\n\tvec3 params =\t\ttex1Dlod_lerp(TEXTURE_PASS(internalTex2), vec2(nlife, 0), paramDiv);\n\tfloat rotSpeed = params.x;\n\tfloat rotSpeedDiv = paramDiv.y;\n\tvec3 radialParams = tex1Dlod_lerp(TEXTURE_PASS(internalTex3), vec2(nlife, 0), paramDiv);\n\tfloat radialSpeed = radialParams.x;\n\tfloat radialSpeedDiv = radialParams.y;\n\tbool respawn = inLife <= 0.0 || outLife >= lifetime;\n\tinPos = respawn ? calcSpawnPosition(rndFactor.xyz, rndFactor.x) : inPos;\n\tinAngle = respawn ? mix(startAngle, startAngle2, rndFactor.x) : inAngle;\n#ifndef LOCAL_SPACE\n\tvec3 radialVel = inPos - emitterPos;\n#else\n\tvec3 radialVel = inPos;\n#endif\n\tradialVel = (dot(radialVel, radialVel) > 1.0E-8) ? radialSpeed * normalize(radialVel) : vec3(0.0);\n\tradialVel += (radialSpeedDiv * vec3(2.0) - vec3(1.0)) * radialSpeedDivMult * rndFactor.xyz;\n\tlocalVelocity +=\t(localVelocityDiv * vec3(2.0) - vec3(1.0)) * localVelocityDivMult * rndFactor.xyz;\n\tvelocity +=\t\t (velocityDiv * vec3(2.0) - vec3(1.0)) * velocityDivMult * rndFactor.xyz;\n\trotSpeed +=\t\t (rotSpeedDiv * 2.0 - 1.0) * rotSpeedDivMult * rndFactor.y;\n\taddInitialVelocity(localVelocity, rndFactor.xyz);\n#ifndef LOCAL_SPACE\n\toutVel = emitterMatrix * localVelocity + (radialVel + velocity) * emitterScale;\n#else\n\toutVel = (localVelocity + radialVel) / emitterScale + emitterMatrixInv * velocity;\n#endif\n\toutPos = inPos + outVel * delta;\n\toutAngle = inAngle + rotSpeed * delta;\n",particle_billboardVS:"\n\tquadXY = rotate(quadXY, inAngle, rotMatrix);\n\tvec3 localPos = billboard(particlePos, quadXY);\n",particle_blendAddPS:"\n\tdBlendModeFogFactor = 0.0;\n\trgb *= saturate(gammaCorrectInput(max(a, 0.0)));\n\tif ((rgb.r + rgb.g + rgb.b) < 0.000001) discard;\n",particle_blendMultiplyPS:"\n\trgb = mix(vec3(1.0), rgb, vec3(a));\n\tif (rgb.r + rgb.g + rgb.b > 2.99) discard;\n",particle_blendNormalPS:"\n\tif (a < 0.01) discard;\n",particle_cpuVS:"\nattribute vec4 particle_vertexData;\nattribute vec4 particle_vertexData2;\nattribute vec4 particle_vertexData3;\nattribute float particle_vertexData4;\n#ifndef USE_MESH\nattribute vec2 particle_vertexData5;\n#else\nattribute vec4 particle_vertexData5;\n#endif\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\nuniform float numParticles;\nuniform float lifetime;\nuniform float stretch;\nuniform float seed;\nuniform vec3 wrapBounds;\nuniform vec3 emitterScale;\nuniform vec3 faceTangent;\nuniform vec3 faceBinorm;\n#ifdef PARTICLE_GPU\n\tuniform highp sampler2D internalTex0;\n\tuniform highp sampler2D internalTex1;\n\tuniform highp sampler2D internalTex2;\n#endif\nuniform vec3 emitterPos;\nvarying vec4 texCoordsAlphaLife;\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix)\n{\n\tfloat c = cos(pRotation);\n\tfloat s = sin(pRotation);\n\tmat2 m = mat2(c, -s, s, c);\n\trotMatrix = m;\n\treturn m * quadXY;\n}\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY)\n{\n\tvec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n\treturn pos;\n}\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY)\n{\n\tvec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n\treturn pos;\n}\nvoid main(void)\n{\n\tvec3 particlePos = particle_vertexData.xyz;\n\tvec3 inPos = particlePos;\n\tvec3 vertPos = particle_vertexData3.xyz;\n\tvec3 inVel = vec3(particle_vertexData2.w, particle_vertexData3.w, particle_vertexData5.x);\n\tfloat id = floor(particle_vertexData4);\n\tfloat rndFactor = fract(sin(id + 1.0 + seed));\n\tvec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n#ifdef LOCAL_SPACE\n\tinVel = mat3(matrix_model) * inVel;\n#endif\n\tvec2 velocityV = normalize((mat3(matrix_view) * inVel).xy);\n\tvec2 quadXY = vertPos.xy;\n#ifdef USE_MESH\n\ttexCoordsAlphaLife = vec4(particle_vertexData5.zw, particle_vertexData2.z, particle_vertexData.w);\n#else\n\ttexCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, particle_vertexData2.z, particle_vertexData.w);\n#endif\n\tmat2 rotMatrix;\n\tfloat inAngle = particle_vertexData2.x;\n\tvec3 particlePosMoved = vec3(0.0);\n\tvec3 meshLocalPos = particle_vertexData3.xyz;\n",particle_cpu_endVS:"\n\tlocalPos *= particle_vertexData2.y * emitterScale;\n\tlocalPos += particlePos;\n\tgl_Position = matrix_viewProjection * vec4(localPos, 1.0);\n",particle_customFaceVS:"\n\tquadXY = rotate(quadXY, inAngle, rotMatrix);\n\tvec3 localPos = customFace(particlePos, quadXY);\n",particle_endPS:"\n\trgb = addFog(rgb);\n\trgb = toneMap(rgb);\n\trgb = gammaCorrectOutput(rgb);\n\tgl_FragColor = vec4(rgb, a);\n}\n",particle_endVS:"\n\tlocalPos *= scale * emitterScale;\n\tlocalPos += particlePos;\n\t#ifdef SCREEN_SPACE\n\tgl_Position = vec4(localPos.x, localPos.y, 0.0, 1.0);\n\t#else\n\tgl_Position = matrix_viewProjection * vec4(localPos.xyz, 1.0);\n\t#endif\n",particle_halflambertPS:"\n\tvec3 negNormal = normal*0.5+0.5;\n\tvec3 posNormal = -normal*0.5+0.5;\n\tnegNormal *= negNormal;\n\tposNormal *= posNormal;\n",particle_initVS:"\nattribute vec4 particle_vertexData;\n#ifdef USE_MESH\nattribute vec2 particle_uv;\n#endif\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform float numParticles;\nuniform float numParticlesPot;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nuniform float stretch;\nuniform vec3 wrapBounds;\nuniform vec3 emitterScale;\nuniform vec3 emitterPos;\nuniform vec3 faceTangent;\nuniform vec3 faceBinorm;\nuniform float rate;\nuniform float rateDiv;\nuniform float lifetime;\nuniform float deltaRandomnessStatic;\nuniform float scaleDivMult;\nuniform float alphaDivMult;\nuniform float seed;\nuniform float delta;\nuniform sampler2D particleTexOUT;\nuniform sampler2D particleTexIN;\n#ifdef PARTICLE_GPU\n\tuniform highp sampler2D internalTex0;\n\tuniform highp sampler2D internalTex1;\n\tuniform highp sampler2D internalTex2;\n#endif\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\nvarying vec4 texCoordsAlphaLife;\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\n",particle_lambertPS:"\n\tvec3 negNormal = max(normal, vec3(0.0));\n\tvec3 posNormal = max(-normal, vec3(0.0));\n",particle_lightingPS:"\n\tvec3 light = negNormal.x*lightCube[0] + posNormal.x*lightCube[1] +\n\t\t\t\t\t\tnegNormal.y*lightCube[2] + posNormal.y*lightCube[3] +\n\t\t\t\t\t\tnegNormal.z*lightCube[4] + posNormal.z*lightCube[5];\n\trgb *= light;\n",particle_localShiftVS:"\n\tparticlePos = (matrix_model * vec4(particlePos, 1.0)).xyz;\n",particle_meshVS:"\n\tvec3 localPos = meshLocalPos;\n\tlocalPos.xy = rotate(localPos.xy, inAngle, rotMatrix);\n\tlocalPos.yz = rotate(localPos.yz, inAngle, rotMatrix);\n\tbillboard(particlePos, quadXY);\n",particle_normalVS:"\n\tNormal = normalize(localPos + matrix_viewInverse[2].xyz);\n",particle_normalMapPS:"\n\tvec3 normalMap = normalize(texture2D(normalMap, vec2(texCoordsAlphaLife.x, 1.0 - texCoordsAlphaLife.y)).xyz * 2.0 - 1.0);\n\tvec3 normal = ParticleMat * normalMap;\n",particle_pointAlongVS:"\n\tinAngle = atan(velocityV.x, velocityV.y);\n",particle_simulationPS:'\n\t#include "particleUpdaterInitPS"\n\t#ifdef PACK8\n\t\t#include "particleInputRgba8PS"\n\t\t#include "particleOutputRgba8PS"\n\t#else\n\t\t#include "particleInputFloatPS"\n\t\t#include "particleOutputFloatPS"\n\t#endif\n\t#ifdef EMITTERSHAPE_BOX\n\t\t#include "particleUpdaterAABBPS"\n\t#else\n\t\t#include "particleUpdaterSpherePS"\n\t#endif\n\t#include "particleUpdaterStartPS"\n\t#ifdef RESPAWN\n\t\t#include "particleUpdaterRespawnPS"\n\t#endif\n\t#ifdef NO_RESPAWN\n\t\t#include "particleUpdaterNoRespawnPS"\n\t#endif\n\t#ifdef ON_STOP\n\t\t#include "particleUpdaterOnStopPS"\n\t#endif\n\t#include "particleUpdaterEndPS"\n',particle_shaderPS:'\n\t#if NORMAL != NONE\n\t\t#if NORMAL == VERTEX\n\t\t\tvarying vec3 Normal;\n\t\t#endif\n\t\t#if NORMAL == MAP\n\t\t\tvarying mat3 ParticleMat;\n\t\t#endif\n\t\tuniform vec3 lightCube[6];\n\t#endif\n\t#ifdef SOFT\n\t\tvarying float vDepth;\n\t\t#include "screenDepthPS"\n\t#endif\n\t#include "gammaPS"\n\t#include "tonemappingPS"\n\t#include "fogPS"\n\t#if NORMAL == MAP\n\t\tuniform sampler2D normalMap;\n\t#endif\n\t#include "particlePS"\n\t#ifdef SOFT\n\t\t#include "particle_softPS"\n\t#endif\n\t#if NORMAL == VERTEX\n\t\tvec3 normal = Normal;\n\t#endif\n\t#if NORMAL == MAP\n\t\t#include "particle_normalMapPS"\n\t#endif\n\t#if NORMAL != NONE\n\t\t#ifdef HALF_LAMBERT\n\t\t\t#include "particle_halflambertPS"\n\t\t#else\n\t\t\t#include "particle_lambertPS"\n\t\t#endif\n\t\t#include "particle_lightingPS"\n\t#endif\n\t#if BLEND == NORMAL\n\t\t#include "particle_blendNormalPS"\n\t#elif BLEND == ADDITIVE\n\t\t#include "particle_blendAddPS"\n\t#elif BLEND == MULTIPLICATIVE\n\t\t#include "particle_blendMultiplyPS"\n\t#endif\n\t#include "particle_endPS"\n',particle_shaderVS:'\n\t#ifdef ANIMTEX\n\t\tuniform vec2 animTexTilesParams;\n\t\tuniform vec4 animTexParams;\n\t\tuniform vec2 animTexIndexParams;\n\t#endif\n\t#if NORMAL == MAP\n\t\tvarying mat3 ParticleMat;\n\t#endif\n\t#if NORMAL == VERTEX\n\t\tvarying vec3 Normal;\n\t#endif\n\t#ifdef SOFT\n\t\tvarying float vDepth;\n\t#endif\n\t#ifdef PARTICLE_GPU\n\t\t#include "particle_initVS"\n\t\t#ifdef PACK8\n\t\t\t#include "particleInputRgba8PS"\n\t\t#else\n\t\t\t#include  "particleInputFloatPS"\n\t\t#endif\n\t\t#ifdef SOFT\n\t\t\t#include "screenDepthPS"\n\t\t#endif\n\t\t#include "particleVS"\n\t#else\n\t\t#ifdef SOFT\n\t\t\t#include "screenDepthPS"\n\t\t#endif\n\t\t#include "particle_cpuVS"\n\t#endif\n\t#ifdef LOCAL_SPACE\n\t\t#include "particle_localShiftVS"\n\t#endif\n\t#ifdef ANIMTEX\n\t\t#ifdef ANIMTEX_LOOP\n\t\t\t#include "particleAnimFrameLoopVS"\n\t\t#else\n\t\t\t#include "particleAnimFrameClampVS"\n\t\t#endif\n\t\t#include "particleAnimTexVS"\n\t#endif\n\t#ifdef PARTICLE_GPU\n\t\t#ifdef WRAP\n\t\t\t#include "particle_wrapVS"\n\t\t#endif\n\t#endif\n\t#ifdef ALIGN_TO_MOTION\n\t\t#include "particle_pointAlongVS"\n\t#endif\n\t#ifdef USE_MESH\n\t\t#include "particle_meshVS"\n\t#else\n\t\t#ifdef CUSTOM_FACE\n\t\t\t#include "particle_customFaceVS"\n\t\t#else\n\t\t\t#include "particle_billboardVS"\n\t\t#endif\n\t#endif\n\t#if NORMAL == VERTEX\n\t\t#include "particle_normalVS"\n\t#endif\n\t#if NORMAL == MAP\n\t\t#include "particle_TBNVS"\n\t#endif\n\t#ifdef STRETCH\n\t\t#include "particle_stretchVS"\n\t#endif\n\t#ifdef PARTICLE_GPU\n\t\t#include "particle_endVS"\n\t#else\n\t\t#include "particle_cpu_endVS"\n\t#endif\n\t#ifdef SOFT\n\t\t#include "particle_softVS"\n\t#endif\n\t}\n',particle_softPS:"\n\tfloat depth = getLinearScreenDepth();\n\tfloat particleDepth = vDepth;\n\tfloat depthDiff = saturate(abs(particleDepth - depth) * softening);\n\ta *= depthDiff;\n",particle_softVS:"\n\tvDepth = getLinearDepth(localPos);\n",particle_stretchVS:"\n\tvec3 moveDir = inVel * stretch;\n\tvec3 posPrev = particlePos - moveDir;\n\tposPrev += particlePosMoved;\n\tvec2 centerToVertexV = normalize((mat3(matrix_view) * localPos).xy);\n\tfloat interpolation = dot(-velocityV, centerToVertexV) * 0.5 + 0.5;\n\tparticlePos = mix(particlePos, posPrev, interpolation);\n",particle_TBNVS:"\n\tmat3 rot3 = mat3(rotMatrix[0][0], rotMatrix[0][1], 0.0, rotMatrix[1][0], rotMatrix[1][1], 0.0, 0.0, 0.0, 1.0);\n\tParticleMat = mat3(-matrix_viewInverse[0].xyz, -matrix_viewInverse[1].xyz, matrix_viewInverse[2].xyz) * rot3;\n",particle_wrapVS:"\n\tvec3 origParticlePos = particlePos;\n\tparticlePos -= matrix_model[3].xyz;\n\tparticlePos = mod(particlePos, wrapBounds) - wrapBounds * 0.5;\n\tparticlePos += matrix_model[3].xyz;\n\tparticlePosMoved = particlePos - origParticlePos;\n",pickPS:"\nuniform uint meshInstanceId;\nvec4 getPickOutput() {\n\tconst vec4 inv = vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0);\n\tconst uvec4 shifts = uvec4(16, 8, 0, 24);\n\tuvec4 col = (uvec4(meshInstanceId) >> shifts) & uvec4(0xff);\n\treturn vec4(col) * inv;\n}\n",reflDirPS:"\nvoid getReflDir(vec3 worldNormal, vec3 viewDir, float gloss, mat3 tbn) {\n\tdReflDirW = normalize(-reflect(viewDir, worldNormal));\n}\n",reflDirAnisoPS:"\nvoid getReflDir(vec3 worldNormal, vec3 viewDir, float gloss, mat3 tbn) {\n\tfloat roughness = sqrt(1.0 - min(gloss, 1.0));\n\tfloat anisotropy = material_anisotropy * roughness;\n\tvec3 anisotropicDirection = anisotropy >= 0.0 ? tbn[1] : tbn[0];\n\tvec3 anisotropicTangent = cross(anisotropicDirection, viewDir);\n\tvec3 anisotropicNormal = cross(anisotropicTangent, anisotropicDirection);\n\tvec3 bentNormal = normalize(mix(normalize(worldNormal), normalize(anisotropicNormal), anisotropy));\n\tdReflDirW = reflect(-viewDir, bentNormal);\n}\n",reflectionCCPS:"\n#ifdef LIT_CLEARCOAT\nvoid addReflectionCC(vec3 reflDir, float gloss) {\n\tccReflection += calcReflection(reflDir, gloss);\n}\n#endif\n",reflectionCubePS:"\nuniform samplerCube texture_cubeMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 reflDir, float gloss) {\n\tvec3 lookupVec = cubeMapProject(reflDir);\n\tlookupVec.x *= -1.0;\n\treturn {reflectionDecode}(textureCube(texture_cubeMap, lookupVec));\n}\nvoid addReflection(vec3 reflDir, float gloss) {   \n\tdReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);\n}\n",reflectionEnvHQPS:"\n#ifndef ENV_ATLAS\n#define ENV_ATLAS\nuniform sampler2D texture_envAtlas;\n#endif\nuniform samplerCube texture_cubeMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 reflDir, float gloss) {\n\tvec3 dir = cubeMapProject(reflDir) * vec3(-1.0, 1.0, 1.0);\n\tvec2 uv = toSphericalUv(dir);\n\tfloat level = saturate(1.0 - gloss) * 5.0;\n\tfloat ilevel = floor(level);\n\tfloat flevel = level - ilevel;\n\tvec3 sharp = {reflectionCubemapDecode}(textureCube(texture_cubeMap, dir));\n\tvec3 roughA = {reflectionDecode}(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel)));\n\tvec3 roughB = {reflectionDecode}(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel + 1.0)));\n\treturn processEnvironment(mix(sharp, mix(roughA, roughB, flevel), min(level, 1.0)));\n}\nvoid addReflection(vec3 reflDir, float gloss) {   \n\tdReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);\n}\n",reflectionEnvPS:"\n#ifndef ENV_ATLAS\n#define ENV_ATLAS\nuniform sampler2D texture_envAtlas;\n#endif\nuniform float material_reflectivity;\nfloat shinyMipLevel(vec2 uv) {\n\tvec2 dx = dFdx(uv);\n\tvec2 dy = dFdy(uv);\n\tvec2 uv2 = vec2(fract(uv.x + 0.5), uv.y);\n\tvec2 dx2 = dFdx(uv2);\n\tvec2 dy2 = dFdy(uv2);\n\tfloat maxd = min(max(dot(dx, dx), dot(dy, dy)), max(dot(dx2, dx2), dot(dy2, dy2)));\n\treturn clamp(0.5 * log2(maxd) - 1.0 + textureBias, 0.0, 5.0);\n}\nvec3 calcReflection(vec3 reflDir, float gloss) {\n\tvec3 dir = cubeMapProject(reflDir) * vec3(-1.0, 1.0, 1.0);\n\tvec2 uv = toSphericalUv(dir);\n\tfloat level = saturate(1.0 - gloss) * 5.0;\n\tfloat ilevel = floor(level);\n\tfloat level2 = shinyMipLevel(uv * atlasSize);\n\tfloat ilevel2 = floor(level2);\n\tvec2 uv0, uv1;\n\tfloat weight;\n\tif (ilevel == 0.0) {\n\t\tuv0 = mapShinyUv(uv, ilevel2);\n\t\tuv1 = mapShinyUv(uv, ilevel2 + 1.0);\n\t\tweight = level2 - ilevel2;\n\t} else {\n\t\tuv0 = uv1 = mapRoughnessUv(uv, ilevel);\n\t\tweight = 0.0;\n\t}\n\tvec3 linearA = {reflectionDecode}(texture2D(texture_envAtlas, uv0));\n\tvec3 linearB = {reflectionDecode}(texture2D(texture_envAtlas, uv1));\n\tvec3 linear0 = mix(linearA, linearB, weight);\n\tvec3 linear1 = {reflectionDecode}(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel + 1.0)));\n\treturn processEnvironment(mix(linear0, linear1, level - ilevel));\n}\nvoid addReflection(vec3 reflDir, float gloss) {   \n\tdReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);\n}\n",reflectionSpherePS:"\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 reflDir, float gloss) {\n\tvec3 reflDirV = (mat3(matrix_view) * reflDir).xyz;\n\tfloat m = 2.0 * sqrt( dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z+1.0)*(reflDirV.z+1.0) );\n\tvec2 sphereMapUv = reflDirV.xy / m + 0.5;\n\treturn {reflectionDecode}(texture2D(texture_sphereMap, sphereMapUv));\n}\nvoid addReflection(vec3 reflDir, float gloss) {   \n\tdReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);\n}\n",reflectionSheenPS:"\nvoid addReflectionSheen(vec3 worldNormal, vec3 viewDir, float gloss) {\n\tfloat NoV = dot(worldNormal, viewDir);\n\tfloat alphaG = gloss * gloss;\n\tfloat a = gloss < 0.25 ? -339.2 * alphaG + 161.4 * gloss - 25.9 : -8.48 * alphaG + 14.3 * gloss - 9.95;\n\tfloat b = gloss < 0.25 ? 44.0 * alphaG - 23.7 * gloss + 3.26 : 1.97 * alphaG - 3.27 * gloss + 0.72;\n\tfloat DG = exp( a * NoV + b ) + ( gloss < 0.25 ? 0.0 : 0.1 * ( gloss - 0.25 ) );\n\tsReflection += calcReflection(worldNormal, 0.0) * saturate(DG);\n}\n",refractionCubePS:"\nvec3 refract2(vec3 viewVec, vec3 normal, float IOR) {\n\tfloat vn = dot(viewVec, normal);\n\tfloat k = 1.0 - IOR * IOR * (1.0 - vn * vn);\n\tvec3 refrVec = IOR * viewVec - (IOR * vn + sqrt(k)) * normal;\n\treturn refrVec;\n}\nvoid addRefraction(\n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tfloat thickness, \n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 albedo, \n\tfloat transmission,\n\tfloat refractionIndex,\n\tfloat dispersion\n#if defined(LIT_IRIDESCENCE)\n\t, vec3 iridescenceFresnel,\n\tfloat iridescenceIntensity\n#endif \n) {\n\tvec4 tmpRefl = dReflection;\n\tvec3 reflectionDir = refract2(-viewDir, worldNormal, refractionIndex);\n\tdReflection = vec4(0);\n\taddReflection(reflectionDir, gloss);\n\tdDiffuseLight = mix(dDiffuseLight, dReflection.rgb * albedo, transmission);\n\tdReflection = tmpRefl;\n}\n",refractionDynamicPS:"\nuniform float material_invAttenuationDistance;\nuniform vec3 material_attenuation;\nvec3 evalRefractionColor(vec3 refractionVector, float gloss, float refractionIndex) {\n\tvec4 pointOfRefraction = vec4(vPositionW + refractionVector, 1.0);\n\tvec4 projectionPoint = matrix_viewProjection * pointOfRefraction;\n\tvec2 uv = getGrabScreenPos(projectionPoint);\n\tfloat iorToRoughness = (1.0 - gloss) * clamp((1.0 / refractionIndex) * 2.0 - 2.0, 0.0, 1.0);\n\tfloat refractionLod = log2(uScreenSize.x) * iorToRoughness;\n\tvec3 refraction = texture2DLod(uSceneColorMap, uv, refractionLod).rgb;\n\treturn refraction;\n}\nvoid addRefraction(\n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tfloat thickness, \n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 albedo, \n\tfloat transmission,\n\tfloat refractionIndex,\n\tfloat dispersion\n#if defined(LIT_IRIDESCENCE)\n\t, vec3 iridescenceFresnel,\n\tfloat iridescenceIntensity\n#endif\n) {\n\tvec3 modelScale;\n\tmodelScale.x = length(vec3(matrix_model[0].xyz));\n\tmodelScale.y = length(vec3(matrix_model[1].xyz));\n\tmodelScale.z = length(vec3(matrix_model[2].xyz));\n\tvec3 scale = thickness * modelScale;\n\tvec3 refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndex)) * scale;\n\tvec3 refraction = evalRefractionColor(refractionVector, gloss, refractionIndex);\n\t#ifdef LIT_DISPERSION\n\t\tfloat halfSpread = (1.0 / refractionIndex - 1.0) * 0.025 * dispersion;\n\t\tfloat refractionIndexR = refractionIndex - halfSpread;\n\t\trefractionVector = normalize(refract(-viewDir, worldNormal, refractionIndexR)) * scale;\n\t\trefraction.r = evalRefractionColor(refractionVector, gloss, refractionIndexR).r;\n\t\tfloat refractionIndexB = refractionIndex + halfSpread;\n\t\trefractionVector = normalize(refract(-viewDir, worldNormal, refractionIndexB)) * scale;\n\t\trefraction.b = evalRefractionColor(refractionVector, gloss, refractionIndexB).b;\n\t#endif\n\tvec3 transmittance;\n\tif (material_invAttenuationDistance != 0.0)\n\t{\n\t\tvec3 attenuation = -log(material_attenuation) * material_invAttenuationDistance;\n\t\ttransmittance = exp(-attenuation * length(refractionVector));\n\t}\n\telse\n\t{\n\t\ttransmittance = refraction;\n\t}\n\tvec3 fresnel = vec3(1.0) - \n\t\tgetFresnel(\n\t\t\tdot(viewDir, worldNormal), \n\t\t\tgloss, \n\t\t\tspecularity\n\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t, iridescenceFresnel,\n\t\t\tiridescenceIntensity\n\t\t#endif\n\t\t);\n\tdDiffuseLight = mix(dDiffuseLight, refraction * transmittance * fresnel, transmission);\n}\n",reprojectPS:'\nvarying vec2 vUv0;\n#ifdef CUBEMAP_SOURCE\n\tuniform samplerCube sourceCube;\n#else\n\tuniform sampler2D sourceTex;\n#endif\n#ifdef USE_SAMPLES_TEX\n\tuniform sampler2D samplesTex;\n\tuniform vec2 samplesTexInverseSize;\n#endif\nuniform vec3 params;\nfloat targetFace() { return params.x; }\nfloat targetTotalPixels() { return params.y; }\nfloat sourceTotalPixels() { return params.z; }\nfloat PI = 3.141592653589793;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\n#include "decodePS"\n#include "encodePS"\nvec3 modifySeams(vec3 dir, float scale) {\n\tvec3 adir = abs(dir);\n\tfloat M = max(max(adir.x, adir.y), adir.z);\n\treturn dir / M * vec3(\n\t\tadir.x == M ? 1.0 : scale,\n\t\tadir.y == M ? 1.0 : scale,\n\t\tadir.z == M ? 1.0 : scale\n\t);\n}\nvec2 toSpherical(vec3 dir) {\n\treturn vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));\n}\nvec3 fromSpherical(vec2 uv) {\n\treturn vec3(cos(uv.y) * sin(uv.x),\n\t\t\t\tsin(uv.y),\n\t\t\t\tcos(uv.y) * cos(uv.x));\n}\nvec3 getDirectionEquirect() {\n\treturn fromSpherical((vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0) * vec2(PI, PI * 0.5));\n}\nfloat signNotZero(float k){\n\treturn(k >= 0.0) ? 1.0 : -1.0;\n}\nvec2 signNotZero(vec2 v) {\n\treturn vec2(signNotZero(v.x), signNotZero(v.y));\n}\nvec3 octDecode(vec2 o) {\n\tvec3 v = vec3(o.x, 1.0 - abs(o.x) - abs(o.y), o.y);\n\tif (v.y < 0.0) {\n\t\tv.xz = (1.0 - abs(v.zx)) * signNotZero(v.xz);\n\t}\n\treturn normalize(v);\n}\nvec3 getDirectionOctahedral() {\n\treturn octDecode(vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0);\n}\nvec2 octEncode(in vec3 v) {\n\tfloat l1norm = abs(v.x) + abs(v.y) + abs(v.z);\n\tvec2 result = v.xz * (1.0 / l1norm);\n\tif (v.y < 0.0) {\n\t\tresult = (1.0 - abs(result.yx)) * signNotZero(result.xy);\n\t}\n\treturn result;\n}\n#ifdef CUBEMAP_SOURCE\n\tvec4 sampleCubemap(vec3 dir) {\n\t\treturn textureCube(sourceCube, modifySeams(dir, 1.0));\n\t}\n\tvec4 sampleCubemap(vec2 sph) {\n\t\treturn sampleCubemap(fromSpherical(sph));\n\t}\n\tvec4 sampleCubemap(vec3 dir, float mipLevel) {\n\t\treturn textureCubeLod(sourceCube, modifySeams(dir, 1.0), mipLevel);\n\t}\n\tvec4 sampleCubemap(vec2 sph, float mipLevel) {\n\t\treturn sampleCubemap(fromSpherical(sph), mipLevel);\n\t}\n#else\n\tvec4 sampleEquirect(vec2 sph) {\n\t\tvec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;\n\t\treturn texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));\n\t}\n\tvec4 sampleEquirect(vec3 dir) {\n\t\treturn sampleEquirect(toSpherical(dir));\n\t}\n\tvec4 sampleEquirect(vec2 sph, float mipLevel) {\n\t\tvec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;\n\t\treturn texture2DLod(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);\n\t}\n\tvec4 sampleEquirect(vec3 dir, float mipLevel) {\n\t\treturn sampleEquirect(toSpherical(dir), mipLevel);\n\t}\n\tvec4 sampleOctahedral(vec3 dir) {\n\t\tvec2 uv = octEncode(dir) * 0.5 + 0.5;\n\t\treturn texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));\n\t}\n\tvec4 sampleOctahedral(vec2 sph) {\n\t\treturn sampleOctahedral(fromSpherical(sph));\n\t}\n\tvec4 sampleOctahedral(vec3 dir, float mipLevel) {\n\t\tvec2 uv = octEncode(dir) * 0.5 + 0.5;\n\t\treturn texture2DLod(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);\n\t}\n\tvec4 sampleOctahedral(vec2 sph, float mipLevel) {\n\t\treturn sampleOctahedral(fromSpherical(sph), mipLevel);\n\t}\n#endif\nvec3 getDirectionCubemap() {\n\tvec2 st = vUv0 * 2.0 - 1.0;\n\tfloat face = targetFace();\n\tvec3 vec;\n\tif (face == 0.0) {\n\t\tvec = vec3(1, -st.y, -st.x);\n\t} else if (face == 1.0) {\n\t\tvec = vec3(-1, -st.y, st.x);\n\t} else if (face == 2.0) {\n\t\tvec = vec3(st.x, 1, st.y);\n\t} else if (face == 3.0) {\n\t\tvec = vec3(st.x, -1, -st.y);\n\t} else if (face == 4.0) {\n\t\tvec = vec3(st.x, -st.y, 1);\n\t} else {\n\t\tvec = vec3(-st.x, -st.y, -1);\n\t}\n\treturn normalize(modifySeams(vec, 1.0));\n}\nmat3 matrixFromVector(vec3 n) {\n\tfloat a = 1.0 / (1.0 + n.z);\n\tfloat b = -n.x * n.y * a;\n\tvec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n\tvec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n\treturn mat3(b1, b2, n);\n}\nmat3 matrixFromVectorSlow(vec3 n) {\n\tvec3 up = (1.0 - abs(n.y) <= 0.0000001) ? vec3(0.0, 0.0, n.y > 0.0 ? 1.0 : -1.0) : vec3(0.0, 1.0, 0.0);\n\tvec3 x = normalize(cross(up, n));\n\tvec3 y = cross(n, x);\n\treturn mat3(x, y, n);\n}\nvec4 reproject() {\n\tif ({NUM_SAMPLES} <= 1) {\n\t\treturn {ENCODE_FUNC}({DECODE_FUNC}({SOURCE_FUNC}({TARGET_FUNC}())));\n\t} else {\n\t\tvec3 t = {TARGET_FUNC}();\n\t\tvec3 tu = dFdx(t);\n\t\tvec3 tv = dFdy(t);\n\t\tvec3 result = vec3(0.0);\n\t\tfor (float u = 0.0; u < {NUM_SAMPLES_SQRT}; ++u) {\n\t\t\tfor (float v = 0.0; v < {NUM_SAMPLES_SQRT}; ++v) {\n\t\t\t\tresult += {DECODE_FUNC}({SOURCE_FUNC}(normalize(t +\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttu * (u / {NUM_SAMPLES_SQRT} - 0.5) +\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttv * (v / {NUM_SAMPLES_SQRT} - 0.5))));\n\t\t\t}\n\t\t}\n\t\treturn {ENCODE_FUNC}(result / ({NUM_SAMPLES_SQRT} * {NUM_SAMPLES_SQRT}));\n\t}\n}\nvec4 unpackFloat = vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0);\n#ifdef USE_SAMPLES_TEX\n\tvoid unpackSample(int i, out vec3 L, out float mipLevel) {\n\t\tfloat u = (float(i * 4) + 0.5) * samplesTexInverseSize.x;\n\t\tfloat v = (floor(u) + 0.5) * samplesTexInverseSize.y;\n\t\tvec4 raw;\n\t\traw.x = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n\t\traw.y = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n\t\traw.z = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n\t\traw.w = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat);\n\t\tL.xyz = raw.xyz * 2.0 - 1.0;\n\t\tmipLevel = raw.w * 8.0;\n\t}\n\tvec4 prefilterSamples() {\n\t\tmat3 vecSpace = matrixFromVectorSlow({TARGET_FUNC}());\n\t\tvec3 L;\n\t\tfloat mipLevel;\n\t\tvec3 result = vec3(0.0);\n\t\tfloat totalWeight = 0.0;\n\t\tfor (int i = 0; i < {NUM_SAMPLES}; ++i) {\n\t\t\tunpackSample(i, L, mipLevel);\n\t\t\tresult += {DECODE_FUNC}({SOURCE_FUNC}(vecSpace * L, mipLevel)) * L.z;\n\t\t\ttotalWeight += L.z;\n\t\t}\n\t\treturn {ENCODE_FUNC}(result / totalWeight);\n\t}\n\tvec4 prefilterSamplesUnweighted() {\n\t\tmat3 vecSpace = matrixFromVectorSlow({TARGET_FUNC}());\n\t\tvec3 L;\n\t\tfloat mipLevel;\n\t\tvec3 result = vec3(0.0);\n\t\tfloat totalWeight = 0.0;\n\t\tfor (int i = 0; i < {NUM_SAMPLES}; ++i) {\n\t\t\tunpackSample(i, L, mipLevel);\n\t\t\tresult += {DECODE_FUNC}({SOURCE_FUNC}(vecSpace * L, mipLevel));\n\t\t}\n\t\treturn {ENCODE_FUNC}(result / float({NUM_SAMPLES}));\n\t}\n#endif\nvoid main(void) {\n\tgl_FragColor = {PROCESS_FUNC}();\n}\n',reprojectVS:"\nattribute vec2 vertex_position;\nuniform vec4 uvMod;\nvarying vec2 vUv0;\nvoid main(void) {\n\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\tvUv0 = getImageEffectUV((vertex_position.xy * 0.5 + 0.5) * uvMod.xy + uvMod.zw);\n}\n",sampleCatmullRomPS:"\nvec4 SampleTextureCatmullRom(TEXTURE_ACCEPT(tex), vec2 uv, vec2 texSize) {\n\tvec2 samplePos = uv * texSize;\n\tvec2 texPos1 = floor(samplePos - 0.5) + 0.5;\n\tvec2 f = samplePos - texPos1;\n\tvec2 w0 = f * (-0.5 + f * (1.0 - 0.5 * f));\n\tvec2 w1 = 1.0 + f * f * (-2.5 + 1.5 * f);\n\tvec2 w2 = f * (0.5 + f * (2.0 - 1.5 * f));\n\tvec2 w3 = f * f * (-0.5 + 0.5 * f);\n\tvec2 w12 = w1 + w2;\n\tvec2 offset12 = w2 / (w1 + w2);\n\tvec2 texPos0 = (texPos1 - 1.0) / texSize;\n\tvec2 texPos3 = (texPos1 + 2.0) / texSize;\n\tvec2 texPos12 = (texPos1 + offset12) / texSize;\n\tvec4 result = vec4(0.0);\n\tresult += texture2DLod(tex, vec2(texPos0.x, texPos0.y), 0.0) * w0.x * w0.y;\n\tresult += texture2DLod(tex, vec2(texPos12.x, texPos0.y), 0.0) * w12.x * w0.y;\n\tresult += texture2DLod(tex, vec2(texPos3.x, texPos0.y), 0.0) * w3.x * w0.y;\n\tresult += texture2DLod(tex, vec2(texPos0.x, texPos12.y), 0.0) * w0.x * w12.y;\n\tresult += texture2DLod(tex, vec2(texPos12.x, texPos12.y), 0.0) * w12.x * w12.y;\n\tresult += texture2DLod(tex, vec2(texPos3.x, texPos12.y), 0.0) * w3.x * w12.y;\n\tresult += texture2DLod(tex, vec2(texPos0.x, texPos3.y), 0.0) * w0.x * w3.y;\n\tresult += texture2DLod(tex, vec2(texPos12.x, texPos3.y), 0.0) * w12.x * w3.y;\n\tresult += texture2DLod(tex, vec2(texPos3.x, texPos3.y), 0.0) * w3.x * w3.y;\n\treturn result;\n}\n",screenDepthPS:"\nuniform highp sampler2D uSceneDepthMap;\n#ifndef SCREENSIZE\n#define SCREENSIZE\nuniform vec4 uScreenSize;\n#endif\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n#ifndef LINEARIZE_DEPTH\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\n#define LINEARIZE_DEPTH\nfloat linearizeDepth(float z) {\n\tif (camera_params.w == 0.0)\n\t\treturn (camera_params.z * camera_params.y) / (camera_params.y + z * (camera_params.z - camera_params.y));\n\telse\n\t\treturn camera_params.z + z * (camera_params.y - camera_params.z);\n}\n#endif\nfloat delinearizeDepth(float linearDepth) {\n\tif (camera_params.w == 0.0) {\n\t\treturn (camera_params.y * (camera_params.z - linearDepth)) / (linearDepth * (camera_params.z - camera_params.y));\n\t} else {\n\t\treturn (linearDepth - camera_params.z) / (camera_params.y - camera_params.z);\n\t}\n}\nfloat getLinearScreenDepth(vec2 uv) {\n\t#ifdef SCENE_DEPTHMAP_LINEAR\n\t\t#ifdef SCENE_DEPTHMAP_FLOAT\n\t\t\treturn texture2D(uSceneDepthMap, uv).r;\n\t\t#else\n\t\t\tivec2 textureSize = textureSize(uSceneDepthMap, 0);\n\t\t\tivec2 texel = ivec2(uv * vec2(textureSize));\n\t\t\tvec4 data = texelFetch(uSceneDepthMap, texel, 0);\n\t\t\tuint intBits = \n\t\t\t\t(uint(data.r * 255.0) << 24u) |\n\t\t\t\t(uint(data.g * 255.0) << 16u) |\n\t\t\t\t(uint(data.b * 255.0) << 8u) |\n\t\t\t\tuint(data.a * 255.0);\n\t\t\treturn uintBitsToFloat(intBits);\n\t\t#endif\n\t#else\n\t\treturn linearizeDepth(texture2D(uSceneDepthMap, uv).r);\n\t#endif\n}\n#ifndef VERTEXSHADER\nfloat getLinearScreenDepth() {\n\tvec2 uv = gl_FragCoord.xy * uScreenSize.zw;\n\treturn getLinearScreenDepth(uv);\n}\n#endif\nfloat getLinearDepth(vec3 pos) {\n\treturn -(matrix_view * vec4(pos, 1.0)).z;\n}\n",shadowCascadesPS:"\nint getShadowCascadeIndex(vec4 shadowCascadeDistances, int shadowCascadeCount) {\n\tfloat depth = 1.0 / gl_FragCoord.w;\n\tvec4 comparisons = step(shadowCascadeDistances, vec4(depth));\n\tint cascadeIndex = int(dot(comparisons, vec4(1.0)));\n\treturn min(cascadeIndex, shadowCascadeCount - 1);\n}\nint ditherShadowCascadeIndex(int cascadeIndex, vec4 shadowCascadeDistances, int shadowCascadeCount, float blendFactor) {\n \n\tif (cascadeIndex < shadowCascadeCount - 1) {\n\t\tfloat currentRangeEnd = shadowCascadeDistances[cascadeIndex];\n\t\tfloat transitionStart = blendFactor * currentRangeEnd;\n\t\tfloat depth = 1.0 / gl_FragCoord.w;\n\t\tif (depth > transitionStart) {\n\t\t\tfloat transitionFactor = smoothstep(transitionStart, currentRangeEnd, depth);\n\t\t\tfloat dither = fract(sin(dot(gl_FragCoord.xy, vec2(12.9898, 78.233))) * 43758.5453);\n\t\t\tif (dither < transitionFactor) {\n\t\t\t\tcascadeIndex += 1;\n\t\t\t}\n\t\t}\n\t}\n\treturn cascadeIndex;\n}\nvec3 fadeShadow(vec3 shadowCoord, vec4 shadowCascadeDistances) {\t\t\t\t  \n\tfloat depth = 1.0 / gl_FragCoord.w;\n\tif (depth > shadowCascadeDistances.w) {\n\t\tshadowCoord.z = -9999999.0;\n\t}\n\treturn shadowCoord;\n}\n",shadowEVSMPS:"\nfloat linstep(float a, float b, float v) {\n\treturn saturate((v - a) / (b - a));\n}\nfloat reduceLightBleeding(float pMax, float amount) {\n   return linstep(amount, 1.0, pMax);\n}\nfloat chebyshevUpperBound(vec2 moments, float mean, float minVariance, float lightBleedingReduction) {\n\tfloat variance = moments.y - (moments.x * moments.x);\n\tvariance = max(variance, minVariance);\n\tfloat d = mean - moments.x;\n\tfloat pMax = variance / (variance + (d * d));\n\tpMax = reduceLightBleeding(pMax, lightBleedingReduction);\n\treturn (mean <= moments.x ? 1.0 : pMax);\n}\nfloat calculateEVSM(vec3 moments, float Z, float vsmBias, float exponent) {\n\tZ = 2.0 * Z - 1.0;\n\tfloat warpedDepth = exp(exponent * Z);\n\tmoments.xy += vec2(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments.z);\n\tfloat VSMBias = vsmBias;\n\tfloat depthScale = VSMBias * exponent * warpedDepth;\n\tfloat minVariance1 = depthScale * depthScale;\n\treturn chebyshevUpperBound(moments.xy, warpedDepth, minVariance1, 0.1);\n}\nfloat VSM16(TEXTURE_ACCEPT(tex), vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\tvec3 moments = texture2DLod(tex, texCoords, 0.0).xyz;\n\treturn calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM16(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent) {\n\treturn VSM16(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM16(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {\n\treturn VSM16(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, length(lightDir) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\nfloat VSM32(TEXTURE_ACCEPT(tex), vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\t#ifdef CAPS_TEXTURE_FLOAT_FILTERABLE\n\t\tvec3 moments = texture2DLod(tex, texCoords, 0.0).xyz;\n\t#else\n\t\tfloat pixelSize = 1.0 / resolution;\n\t\ttexCoords -= vec2(pixelSize);\n\t\tvec3 s00 = texture2DLod(tex, texCoords, 0.0).xyz;\n\t\tvec3 s10 = texture2DLod(tex, texCoords + vec2(pixelSize, 0), 0.0).xyz;\n\t\tvec3 s01 = texture2DLod(tex, texCoords + vec2(0, pixelSize), 0.0).xyz;\n\t\tvec3 s11 = texture2DLod(tex, texCoords + vec2(pixelSize), 0.0).xyz;\n\t\tvec2 fr = fract(texCoords * resolution);\n\t\tvec3 h0 = mix(s00, s10, fr.x);\n\t\tvec3 h1 = mix(s01, s11, fr.x);\n\t\tvec3 moments = mix(h0, h1, fr.y);\n\t#endif\n\treturn calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM32(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent) {\n\treturn VSM32(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM32(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {\n\treturn VSM32(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, length(lightDir) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n",shadowPCF1PS:"\nfloat getShadowPCF1x1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn textureShadow(shadowMap, shadowCoord);\n}\nfloat getShadowSpotPCF1x1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn textureShadow(shadowMap, shadowCoord);\n}\n#ifndef WEBGPU\nfloat getShadowOmniPCF1x1(samplerCubeShadow shadowMap, vec3 shadowCoord, vec4 shadowParams, vec3 lightDir) {\n\tfloat shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n\treturn texture(shadowMap, vec4(lightDir, shadowZ));\n}\n#endif\n",shadowPCF3PS:"\nfloat _getShadowPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec3 shadowParams) {\n\tfloat z = shadowCoord.z;\n\tvec2 uv = shadowCoord.xy * shadowParams.x;\n\tfloat shadowMapSizeInv = 1.0 / shadowParams.x;\n\tvec2 base_uv = floor(uv + 0.5);\n\tfloat s = (uv.x + 0.5 - base_uv.x);\n\tfloat t = (uv.y + 0.5 - base_uv.y);\n\tbase_uv -= vec2(0.5);\n\tbase_uv *= shadowMapSizeInv;\n\tfloat sum = 0.0;\n\tfloat uw0 = (3.0 - 2.0 * s);\n\tfloat uw1 = (1.0 + 2.0 * s);\n\tfloat u0 = (2.0 - s) / uw0 - 1.0;\n\tfloat u1 = s / uw1 + 1.0;\n\tfloat vw0 = (3.0 - 2.0 * t);\n\tfloat vw1 = (1.0 + 2.0 * t);\n\tfloat v0 = (2.0 - t) / vw0 - 1.0;\n\tfloat v1 = t / vw1 + 1.0;\n\tu0 = u0 * shadowMapSizeInv + base_uv.x;\n\tv0 = v0 * shadowMapSizeInv + base_uv.y;\n\tu1 = u1 * shadowMapSizeInv + base_uv.x;\n\tv1 = v1 * shadowMapSizeInv + base_uv.y;\n\tsum += uw0 * vw0 * textureShadow(shadowMap, vec3(u0, v0, z));\n\tsum += uw1 * vw0 * textureShadow(shadowMap, vec3(u1, v0, z));\n\tsum += uw0 * vw1 * textureShadow(shadowMap, vec3(u0, v1, z));\n\tsum += uw1 * vw1 * textureShadow(shadowMap, vec3(u1, v1, z));\n\tsum *= 1.0f / 16.0;\n\treturn sum;\n}\nfloat getShadowPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn _getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);\n}\nfloat getShadowSpotPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn _getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);\n}\n#ifndef WEBGPU\nfloat getShadowOmniPCF3x3(samplerCubeShadow shadowMap, vec4 shadowParams, vec3 dir) {\n\t\n\tfloat shadowZ = length(dir) * shadowParams.w + shadowParams.z;\n\tfloat z = 1.0 / float(textureSize(shadowMap, 0));\n\tvec3 tc = normalize(dir);\n\tmediump vec4 shadows;\n\tshadows.x = texture(shadowMap, vec4(tc + vec3( z, z, z), shadowZ));\n\tshadows.y = texture(shadowMap, vec4(tc + vec3(-z,-z, z), shadowZ));\n\tshadows.z = texture(shadowMap, vec4(tc + vec3(-z, z,-z), shadowZ));\n\tshadows.w = texture(shadowMap, vec4(tc + vec3( z,-z,-z), shadowZ));\n\treturn dot(shadows, vec4(0.25));\n}\nfloat getShadowOmniPCF3x3(samplerCubeShadow shadowMap, vec3 shadowCoord, vec4 shadowParams, vec3 lightDir) {\n\treturn getShadowOmniPCF3x3(shadowMap, shadowParams, lightDir);\n}\n#endif\n",shadowPCF5PS:"\nfloat _getShadowPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec3 shadowParams) {\n\tfloat z = shadowCoord.z;\n\tvec2 uv = shadowCoord.xy * shadowParams.x;\n\tfloat shadowMapSizeInv = 1.0 / shadowParams.x;\n\tvec2 base_uv = floor(uv + 0.5);\n\tfloat s = (uv.x + 0.5 - base_uv.x);\n\tfloat t = (uv.y + 0.5 - base_uv.y);\n\tbase_uv -= vec2(0.5);\n\tbase_uv *= shadowMapSizeInv;\n\tfloat uw0 = (4.0 - 3.0 * s);\n\tfloat uw1 = 7.0;\n\tfloat uw2 = (1.0 + 3.0 * s);\n\tfloat u0 = (3.0 - 2.0 * s) / uw0 - 2.0;\n\tfloat u1 = (3.0 + s) / uw1;\n\tfloat u2 = s / uw2 + 2.0;\n\tfloat vw0 = (4.0 - 3.0 * t);\n\tfloat vw1 = 7.0;\n\tfloat vw2 = (1.0 + 3.0 * t);\n\tfloat v0 = (3.0 - 2.0 * t) / vw0 - 2.0;\n\tfloat v1 = (3.0 + t) / vw1;\n\tfloat v2 = t / vw2 + 2.0;\n\tfloat sum = 0.0;\n\tu0 = u0 * shadowMapSizeInv + base_uv.x;\n\tv0 = v0 * shadowMapSizeInv + base_uv.y;\n\tu1 = u1 * shadowMapSizeInv + base_uv.x;\n\tv1 = v1 * shadowMapSizeInv + base_uv.y;\n\tu2 = u2 * shadowMapSizeInv + base_uv.x;\n\tv2 = v2 * shadowMapSizeInv + base_uv.y;\n\tsum += uw0 * vw0 * textureShadow(shadowMap, vec3(u0, v0, z));\n\tsum += uw1 * vw0 * textureShadow(shadowMap, vec3(u1, v0, z));\n\tsum += uw2 * vw0 * textureShadow(shadowMap, vec3(u2, v0, z));\n\tsum += uw0 * vw1 * textureShadow(shadowMap, vec3(u0, v1, z));\n\tsum += uw1 * vw1 * textureShadow(shadowMap, vec3(u1, v1, z));\n\tsum += uw2 * vw1 * textureShadow(shadowMap, vec3(u2, v1, z));\n\tsum += uw0 * vw2 * textureShadow(shadowMap, vec3(u0, v2, z));\n\tsum += uw1 * vw2 * textureShadow(shadowMap, vec3(u1, v2, z));\n\tsum += uw2 * vw2 * textureShadow(shadowMap, vec3(u2, v2, z));\n\tsum *= 1.0f / 144.0;\n\tsum = saturate(sum);\n\treturn sum;\n}\nfloat getShadowPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn _getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);\n}\nfloat getShadowSpotPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn _getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);\n}\n",shadowPCSSPS:"\n#define PCSS_SAMPLE_COUNT 16\nuniform float pcssDiskSamples[PCSS_SAMPLE_COUNT];\nuniform float pcssSphereSamples[PCSS_SAMPLE_COUNT];\nvec2 vogelDisk(int sampleIndex, float count, float phi, float r) {\n\tconst float GoldenAngle = 2.4;\n\tfloat theta = float(sampleIndex) * GoldenAngle + phi;\n\tfloat sine = sin(theta);\n\tfloat cosine = cos(theta);\n\treturn vec2(r * cosine, r * sine);\n}\nvec3 vogelSphere(int sampleIndex, float count, float phi, float r) {\n\tconst float GoldenAngle = 2.4;\n\tfloat theta = float(sampleIndex) * GoldenAngle + phi;\n\tfloat weight = float(sampleIndex) / count;\n\treturn vec3(cos(theta) * r, weight, sin(theta) * r);\n}\nfloat noise(vec2 screenPos) {\n\tconst float PHI = 1.61803398874989484820459;\n\treturn fract(sin(dot(screenPos * PHI, screenPos)) * screenPos.x);\n}\nfloat viewSpaceDepth(float depth, mat4 invProjection) {\n\tfloat z = depth * 2.0 - 1.0;\n\tvec4 clipSpace = vec4(0.0, 0.0, z, 1.0);\n\tvec4 viewSpace = invProjection * clipSpace;\n\treturn viewSpace.z;\n}\nfloat PCSSBlockerDistance(TEXTURE_ACCEPT(shadowMap), vec2 sampleCoords[PCSS_SAMPLE_COUNT], vec2 shadowCoords, vec2 searchSize, float z, vec4 cameraParams) {\n\tfloat blockers = 0.0;\n\tfloat averageBlocker = 0.0;\n\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {\n\t\tvec2 offset = sampleCoords[i] * searchSize;\n\t\tvec2 sampleUV = shadowCoords + offset;\n\t\tfloat blocker = texture2DLod(shadowMap, sampleUV, 0.0).r;\n\t\tfloat isBlocking = step(blocker, z);\n\t\tblockers += isBlocking;\n\t\taverageBlocker += blocker * isBlocking;\n\t}\n\tif (blockers > 0.0)\n\t\treturn averageBlocker / blockers;\n\treturn -1.0;\n}\nfloat PCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoords, vec4 cameraParams, vec2 shadowSearchArea) {\n\tfloat receiverDepth = linearizeDepth(shadowCoords.z, cameraParams);\n\tvec2 samplePoints[PCSS_SAMPLE_COUNT];\n\tconst float PI = 3.141592653589793;\n\tfloat noise = noise( gl_FragCoord.xy ) * 2.0 * PI;\n\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {\n\t\tfloat pcssPresample = pcssDiskSamples[i];\n\t\tsamplePoints[i] = vogelDisk(i, float(PCSS_SAMPLE_COUNT), noise, pcssPresample);\n\t}\n\tfloat averageBlocker = PCSSBlockerDistance(TEXTURE_PASS(shadowMap), samplePoints, shadowCoords.xy, shadowSearchArea, receiverDepth, cameraParams);\n\tif (averageBlocker == -1.0) {\n\t\treturn 1.0;\n\t} else {\n\t\tfloat depthDifference = (receiverDepth - averageBlocker) / 3.0;\n\t\tvec2 filterRadius = depthDifference * shadowSearchArea;\n\t\tfloat shadow = 0.0;\n\t\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i ++)\n\t\t{\n\t\t\tvec2 sampleUV = samplePoints[i] * filterRadius;\n\t\t\tsampleUV = shadowCoords.xy + sampleUV;\n\t\t\tfloat depth = texture2DLod(shadowMap, sampleUV, 0.0).r;\n\t\t\tshadow += step(receiverDepth, depth);\n\t\t}\n\t\treturn shadow / float(PCSS_SAMPLE_COUNT);\n\t} \n}\n#ifndef WEBGPU\nfloat PCSSCubeBlockerDistance(samplerCube shadowMap, vec3 lightDirNorm, vec3 samplePoints[PCSS_SAMPLE_COUNT], float z, float shadowSearchArea) {\n\tfloat blockers = 0.0;\n\tfloat averageBlocker = 0.0;\n\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {\n\t\tvec3 sampleDir = lightDirNorm + samplePoints[i] * shadowSearchArea;\n\t\tsampleDir = normalize(sampleDir);\n\t\tfloat blocker = textureCubeLod(shadowMap, sampleDir, 0.0).r;\n\t\tfloat isBlocking = step(blocker, z);\n\t\tblockers += isBlocking;\n\t\taverageBlocker += blocker * isBlocking;\n\t}\n\tif (blockers > 0.0)\n\t\treturn averageBlocker / blockers;\n\treturn -1.0;\n}\nfloat PCSSCube(samplerCube shadowMap, vec4 shadowParams, vec3 shadowCoords, vec4 cameraParams, float shadowSearchArea, vec3 lightDir) {\n\t\n\tvec3 samplePoints[PCSS_SAMPLE_COUNT];\n\tconst float PI = 3.141592653589793;\n\tfloat noise = noise( gl_FragCoord.xy ) * 2.0 * PI;\n\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {\n\t\tfloat r = pcssSphereSamples[i];\n\t\tsamplePoints[i] = vogelSphere(i, float(PCSS_SAMPLE_COUNT), noise, r);\n\t}\n\tfloat receiverDepth = length(lightDir) * shadowParams.w + shadowParams.z;\n\tvec3 lightDirNorm = normalize(lightDir);\n\t\n\tfloat averageBlocker = PCSSCubeBlockerDistance(shadowMap, lightDirNorm, samplePoints, receiverDepth, shadowSearchArea);\n\tif (averageBlocker == -1.0) {\n\t\treturn 1.0;\n\t} else {\n\t\tfloat filterRadius = ((receiverDepth - averageBlocker) / averageBlocker) * shadowSearchArea;\n\t\tfloat shadow = 0.0;\n\t\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i++)\n\t\t{\n\t\t\tvec3 offset = samplePoints[i] * filterRadius;\n\t\t\tvec3 sampleDir = lightDirNorm + offset;\n\t\t\tsampleDir = normalize(sampleDir);\n\t\t\tfloat depth = textureCubeLod(shadowMap, sampleDir, 0.0).r;\n\t\t\tshadow += step(receiverDepth, depth);\n\t\t}\n\t\treturn shadow / float(PCSS_SAMPLE_COUNT);\n\t}\n}\nfloat getShadowOmniPCSS(samplerCube shadowMap, vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec2 shadowSearchArea, vec3 lightDir) {\n\treturn PCSSCube(shadowMap, shadowParams, shadowCoord, cameraParams, shadowSearchArea.x, lightDir);\n}\n#endif\nfloat getShadowSpotPCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec2 shadowSearchArea, vec3 lightDir) {\n\treturn PCSS(TEXTURE_PASS(shadowMap), shadowCoord, cameraParams, shadowSearchArea);\n}\n",shadowSoftPS:"\nhighp float fractSinRand( const in vec2 uv ) {\n\tconst float PI = 3.141592653589793;\n\tconst highp float a = 12.9898, b = 78.233, c = 43758.5453;\n\thighp float dt = dot(uv.xy, vec2(a, b)), sn = mod(dt, PI);\n\treturn fract(sin(sn) * c);\n}\nstruct VogelDiskData {\n\tfloat invNumSamples;\n\tfloat initialAngle;\n\tfloat currentPointId;\n};\nvoid prepareDiskConstants(out VogelDiskData data, int sampleCount, int numRings, float randomSeed) {\n\tconst float pi2 = 6.28318530718;\n\tdata.invNumSamples = 1.0 / float(sampleCount);\n\tdata.initialAngle = randomSeed * pi2;\n\tdata.currentPointId = 0.0;\n}\n#define GOLDEN_ANGLE 2.399963\nvec2 generateDiskSample(inout VogelDiskData data) {\n\tfloat r = sqrt((data.currentPointId + 0.5) * data.invNumSamples);\n\tfloat theta = data.currentPointId * GOLDEN_ANGLE + data.initialAngle;\n\tvec2 offset = vec2(cos(theta), sin(theta)) * pow(r, 1.33);\n\tdata.currentPointId += 1.0;\n\treturn offset;\n}\nvoid PCSSFindBlocker(TEXTURE_ACCEPT(shadowMap), out float avgBlockerDepth, out int numBlockers,\n\tvec2 shadowCoords, float z, int shadowBlockerSamples, float penumbraSize, float invShadowMapSize, float randomSeed) {\n\tVogelDiskData diskData;\n\tprepareDiskConstants(diskData, shadowBlockerSamples, 11, randomSeed);\n\tfloat searchWidth = penumbraSize * invShadowMapSize;\n\tfloat blockerSum = 0.0;\n\tnumBlockers = 0;\n\tfor( int i = 0; i < shadowBlockerSamples; ++i ) {\n\t\tvec2 diskUV = generateDiskSample(diskData);\n\t\tvec2 sampleUV = shadowCoords + diskUV * searchWidth;\n\t\tfloat shadowMapDepth = texture2DLod(shadowMap, sampleUV, 0.0).r;\n\t\tif ( shadowMapDepth < z ) {\n\t\t\tblockerSum += shadowMapDepth;\n\t\t\tnumBlockers++;\n\t\t}\n\t}\n\tavgBlockerDepth = blockerSum / float(numBlockers);\n}\nfloat PCSSFilter(TEXTURE_ACCEPT(shadowMap), vec2 uv, float receiverDepth, int shadowSamples, float filterRadius, float randomSeed) {\n\tVogelDiskData diskData;\n\tprepareDiskConstants(diskData, shadowSamples, 11, randomSeed);\n\tfloat sum = 0.0;\n\tfor (int i = 0; i < shadowSamples; i++) {\n\t\tvec2 offsetUV = generateDiskSample(diskData) * filterRadius;\n\t\tfloat depth = texture2DLod(shadowMap, uv + offsetUV, 0.0).r;\n\t\tsum += step(receiverDepth, depth);\n\t}\n\treturn sum / float(shadowSamples);\n}\nfloat getPenumbra(float dblocker, float dreceiver, float penumbraSize, float penumbraFalloff) {\n\tfloat dist = dreceiver - dblocker;\n\tfloat penumbra = 1.0 - pow(1.0 - dist, penumbraFalloff);\n\treturn penumbra * penumbraSize;\n}\nfloat PCSSDirectional(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoords, vec4 cameraParams, vec4 softShadowParams) {\n\tfloat receiverDepth = shadowCoords.z;\n\tfloat randomSeed = fractSinRand(gl_FragCoord.xy);\n\tint shadowSamples = int(softShadowParams.x);\n\tint shadowBlockerSamples = int(softShadowParams.y);\n\tfloat penumbraSize = softShadowParams.z;\n\tfloat penumbraFalloff = softShadowParams.w;\n\tint shadowMapSize = textureSize(shadowMap, 0).x;\n\tfloat invShadowMapSize = 1.0 / float(shadowMapSize);\n\tinvShadowMapSize *= float(shadowMapSize) / 2048.0;\n\tfloat penumbra;\n\tif (shadowBlockerSamples > 0) {\n\t\tfloat avgBlockerDepth = 0.0;\n\t\tint numBlockers = 0;\n\t\tPCSSFindBlocker(TEXTURE_PASS(shadowMap), avgBlockerDepth, numBlockers, shadowCoords.xy, receiverDepth, shadowBlockerSamples, penumbraSize, invShadowMapSize, randomSeed);\n\t\tif (numBlockers < 1)\n\t\t\treturn 1.0f;\n\t\tpenumbra = getPenumbra(avgBlockerDepth, shadowCoords.z, penumbraSize, penumbraFalloff);\n\t} else {\n\t\tpenumbra = penumbraSize;\n\t}\n\tfloat filterRadius = penumbra * invShadowMapSize;\n\treturn PCSSFilter(TEXTURE_PASS(shadowMap), shadowCoords.xy, receiverDepth, shadowSamples, filterRadius, randomSeed);\n}\nfloat getShadowPCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec4 softShadowParams, vec3 lightDir) {\n\treturn PCSSDirectional(TEXTURE_PASS(shadowMap), shadowCoord, cameraParams, softShadowParams);\n}\n",skinBatchVS:"\nattribute float vertex_boneIndices;\nuniform highp sampler2D texture_poseMap;\nmat4 getBoneMatrix(const in float indexFloat) {\n\tint width = textureSize(texture_poseMap, 0).x;\n\tint index = int(indexFloat + 0.5) * 3;\n\tint iy = index / width;\n\tint ix = index % width;\n\tvec4 v1 = texelFetch(texture_poseMap, ivec2(ix + 0, iy), 0);\n\tvec4 v2 = texelFetch(texture_poseMap, ivec2(ix + 1, iy), 0);\n\tvec4 v3 = texelFetch(texture_poseMap, ivec2(ix + 2, iy), 0);\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, 1\n\t);\n}\n",skinVS:"\nattribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\nuniform highp sampler2D texture_poseMap;\nvoid getBoneMatrix(const in int width, const in int index, out vec4 v1, out vec4 v2, out vec4 v3) {\n\tint v = index / width;\n\tint u = index % width;\n\tv1 = texelFetch(texture_poseMap, ivec2(u + 0, v), 0);\n\tv2 = texelFetch(texture_poseMap, ivec2(u + 1, v), 0);\n\tv3 = texelFetch(texture_poseMap, ivec2(u + 2, v), 0);\n}\nmat4 getSkinMatrix(const in vec4 indicesFloat, const in vec4 weights) {\n\tint width = textureSize(texture_poseMap, 0).x;\n\tivec4 indices = ivec4(indicesFloat + 0.5) * 3;\n\tvec4 a1, a2, a3;\n\tgetBoneMatrix(width, indices.x, a1, a2, a3);\n\tvec4 b1, b2, b3;\n\tgetBoneMatrix(width, indices.y, b1, b2, b3);\n\tvec4 c1, c2, c3;\n\tgetBoneMatrix(width, indices.z, c1, c2, c3);\n\tvec4 d1, d2, d3;\n\tgetBoneMatrix(width, indices.w, d1, d2, d3);\n\tvec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;\n\tvec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;\n\tvec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;\n\tfloat one = dot(weights, vec4(1.0));\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, one\n\t);\n}\n",skyboxPS:'\n\t#define LIT_SKYBOX_INTENSITY\n\t#include "envProcPS"\n\t#include "gammaPS"\n\t#include "tonemappingPS"\n\tvarying vec3 vViewDir;\n\tuniform float skyboxHighlightMultiplier;\n\t#ifdef SKY_CUBEMAP\n\t\tuniform samplerCube texture_cubeMap;\n\t\t#ifdef SKYMESH\n\t\t\tvarying vec3 vWorldPos;\n\t\t\tuniform mat3 cubeMapRotationMatrix;\n\t\t\tuniform vec3 projectedSkydomeCenter;\n\t\t#endif\n\t#else\n\t\t#include "sphericalPS"\n\t\t#include "envAtlasPS"\n\t\tuniform sampler2D texture_envAtlas;\n\t\tuniform float mipLevel;\n\t#endif\n\tvoid main(void) {\n\t\t#ifdef SKY_CUBEMAP\n\t\t\t#ifdef SKYMESH\n\t\t\t\tvec3 envDir = normalize(vWorldPos - projectedSkydomeCenter);\n\t\t\t\tvec3 dir = envDir * cubeMapRotationMatrix;\n\t\t\t#else\n\t\t\t\tvec3 dir = vViewDir;\n\t\t\t#endif\n\t\t\tdir.x *= -1.0;\n\t\t\tvec3 linear = {SKYBOX_DECODE_FNC}(textureCube(texture_cubeMap, dir));\n\t\t#else\n\t\t\tvec3 dir = vViewDir * vec3(-1.0, 1.0, 1.0);\n\t\t\tvec2 uv = toSphericalUv(normalize(dir));\n\t\t\tvec3 linear = {SKYBOX_DECODE_FNC}(texture2D(texture_envAtlas, mapRoughnessUv(uv, mipLevel)));\n\t\t#endif\n\t\tif (any(greaterThanEqual(linear, vec3(64.0)))) {\n\t\t\tlinear *= skyboxHighlightMultiplier;\n\t\t}\n\t\tgl_FragColor = vec4(gammaCorrectOutput(toneMap(processEnvironment(linear))), 1.0);\n\t}\n',skyboxVS:"\nattribute vec4 aPosition;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform mat4 matrix_projectionSkybox;\nuniform mat3 cubeMapRotationMatrix;\nvarying vec3 vViewDir;\n#ifdef SKYMESH\n\tuniform mat4 matrix_model;\n\tvarying vec3 vWorldPos;\n#endif\nvoid main(void) {\n\tmat4 view = matrix_view;\n\t#ifdef SKYMESH\n\t\tvec4 worldPos = matrix_model * aPosition;\n\t\tvWorldPos = worldPos.xyz;\n\t\tgl_Position = matrix_projectionSkybox * (view * worldPos);\n\t#else\n\t\tview[3][0] = view[3][1] = view[3][2] = 0.0;\n\t\tgl_Position = matrix_projectionSkybox * (view * aPosition);\n\t\tvViewDir = aPosition.xyz * cubeMapRotationMatrix;\n\t#endif\n\tgl_Position.z = gl_Position.w - 1.0e-7;\n}\n",specularPS:"\n#ifdef STD_SPECULAR_CONSTANT\nuniform vec3 material_specular;\n#endif\nvoid getSpecularity() {\n\tvec3 specularColor = vec3(1,1,1);\n\t#ifdef STD_SPECULAR_CONSTANT\n\tspecularColor *= material_specular;\n\t#endif\n\t#ifdef STD_SPECULAR_TEXTURE\n\tspecularColor *= {STD_SPECULAR_TEXTURE_DECODE}(texture2DBias({STD_SPECULAR_TEXTURE_NAME}, {STD_SPECULAR_TEXTURE_UV}, textureBias)).{STD_SPECULAR_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_SPECULAR_VERTEX\n\tspecularColor *= saturate(vVertexColor.{STD_SPECULAR_VERTEX_CHANNEL});\n\t#endif\n\tdSpecularity = specularColor;\n}\n",sphericalPS:"\nvec2 toSpherical(vec3 dir) {\n\treturn vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));\n}\nvec2 toSphericalUv(vec3 dir) {\n\tconst float PI = 3.141592653589793;\n\tvec2 uv = toSpherical(dir) / vec2(PI * 2.0, PI) + 0.5;\n\treturn vec2(uv.x, 1.0 - uv.y);\n}\n",specularityFactorPS:"\n#ifdef STD_SPECULARITYFACTOR_CONSTANT\nuniform float material_specularityFactor;\n#endif\nvoid getSpecularityFactor() {\n\tfloat specularityFactor = 1.0;\n\t#ifdef STD_SPECULARITYFACTOR_CONSTANT\n\tspecularityFactor *= material_specularityFactor;\n\t#endif\n\t#ifdef STD_SPECULARITYFACTOR_TEXTURE\n\tspecularityFactor *= texture2DBias({STD_SPECULARITYFACTOR_TEXTURE_NAME}, {STD_SPECULARITYFACTOR_TEXTURE_UV}, textureBias).{STD_SPECULARITYFACTOR_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_SPECULARITYFACTOR_VERTEX\n\tspecularityFactor *= saturate(vVertexColor.{STD_SPECULARITYFACTOR_VERTEX_CHANNEL});\n\t#endif\n\tdSpecularityFactor = specularityFactor;\n}\n",spotPS:"\nfloat getSpotEffect(vec3 lightSpotDir, float lightInnerConeAngle, float lightOuterConeAngle, vec3 lightDirNorm) {\n\tfloat cosAngle = dot(lightDirNorm, lightSpotDir);\n\treturn smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);\n}\n",startNineSlicedPS:"\n\tnineSlicedUv = vUv0;\n\tnineSlicedUv.y = 1.0 - nineSlicedUv.y;\n",startNineSlicedTiledPS:"\n\tvec2 tileMask = step(vMask, vec2(0.99999));\n\tvec2 tileSize = 0.5 * (innerOffset.xy + innerOffset.zw);\n\tvec2 tileScale = vec2(1.0) / (vec2(1.0) - tileSize);\n\tvec2 clampedUv = mix(innerOffset.xy * 0.5, vec2(1.0) - innerOffset.zw * 0.5, fract((vTiledUv - tileSize) * tileScale));\n\tclampedUv = clampedUv * atlasRect.zw + atlasRect.xy;\n\tnineSlicedUv = vUv0 * tileMask + clampedUv * (vec2(1.0) - tileMask);\n\tnineSlicedUv.y = 1.0 - nineSlicedUv.y;\n\t\n",stdDeclarationPS:'\n\tfloat dAlpha = 1.0;\n\t#if defined(LIT_ALPHA_TEST)\n\t\t#include "alphaTestPS"\n\t#endif\n\t#if STD_OPACITY_DITHER != NONE\n\t\t#include "opacityDitherPS"\n\t#endif\n\t#ifdef FORWARD_PASS\n\t\tvec3 dAlbedo;\n\t\tvec3 dNormalW;\n\t\tvec3 dSpecularity = vec3(0.0);\n\t\tfloat dGlossiness = 0.0;\n\t\t#ifdef LIT_REFRACTION\n\t\t\tfloat dTransmission;\n\t\t\tfloat dThickness;\n\t\t#endif\n\t\t#ifdef LIT_SCENE_COLOR\n\t\t\tuniform sampler2D uSceneColorMap;\n\t\t#endif\n\t\t#ifdef LIT_SCREEN_SIZE\n\t\t\tuniform vec4 uScreenSize;\n\t\t#endif\n\t\t#ifdef LIT_TRANSFORMS\n\t\t\tuniform mat4 matrix_viewProjection;\n\t\t\tuniform mat4 matrix_model;\n\t\t#endif\n\t\t#ifdef STD_HEIGHT_MAP\n\t\t\tvec2 dUvOffset;\n\t\t\t#ifdef STD_DIFFUSE_TEXTURE_ALLOCATE\n\t\t\t\tuniform sampler2D texture_heightMap;\n\t\t\t#endif\n\t\t#endif\n\t\t#ifdef STD_DIFFUSE_TEXTURE_ALLOCATE\n\t\t\tuniform sampler2D texture_diffuseMap;\n\t\t#endif\n\t\t#ifdef STD_DIFFUSEDETAIL_TEXTURE_ALLOCATE\n\t\t\tuniform sampler2D texture_diffuseDetailMap;\n\t\t#endif\n\t\t#ifdef STD_NORMAL_TEXTURE_ALLOCATE\n\t\t\tuniform sampler2D texture_normalMap;\n\t\t#endif\n\t\t#ifdef STD_NORMALDETAIL_TEXTURE_ALLOCATE\n\t\t\tuniform sampler2D texture_normalDetailMap;\n\t\t#endif\n\t\t#ifdef STD_THICKNESS_TEXTURE_ALLOCATE\n\t\t\tuniform sampler2D texture_thicknessMap;\n\t\t#endif\n\t\t#ifdef STD_REFRACTION_TEXTURE_ALLOCATE\n\t\t\tuniform sampler2D texture_refractionMap;\n\t\t#endif\n\t\t#ifdef LIT_IRIDESCENCE\n\t\t\tfloat dIridescence;\n\t\t\tfloat dIridescenceThickness;\n\t\t\t#ifdef STD_IRIDESCENCE_THICKNESS_TEXTURE_ALLOCATE\n\t\t\t\tuniform sampler2D texture_iridescenceThicknessMap;\n\t\t\t#endif\n\t\t\t#ifdef STD_IRIDESCENCE_TEXTURE_ALLOCATE\n\t\t\t\tuniform sampler2D texture_iridescenceMap;\n\t\t\t#endif\n\t\t#endif\n\t\t#ifdef LIT_CLEARCOAT\n\t\t\tfloat ccSpecularity;\n\t\t\tfloat ccGlossiness;\n\t\t\tvec3 ccNormalW;\n\t\t#endif\n\t\t#ifdef LIT_SPECULAR_OR_REFLECTION\n\t\t\t#ifdef LIT_SHEEN\n\t\t\t\tvec3 sSpecularity;\n\t\t\t\tfloat sGlossiness;\n\t\t\t\t#ifdef STD_SHEEN_TEXTURE_ALLOCATE\n\t\t\t\t\tuniform sampler2D texture_sheenMap;\n\t\t\t\t#endif\n\t\t\t\t#ifdef STD_SHEENGLOSS_TEXTURE_ALLOCATE\n\t\t\t\t\tuniform sampler2D texture_sheenGlossMap;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef LIT_METALNESS\n\t\t\t\tfloat dMetalness;\n\t\t\t\tfloat dIor;\n\t\t\t\t#ifdef STD_METALNESS_TEXTURE_ALLOCATE\n\t\t\t\t\tuniform sampler2D texture_metalnessMap;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULARITY_FACTOR\n\t\t\t\tfloat dSpecularityFactor;\n\t\t\t\t#ifdef STD_SPECULARITYFACTOR_TEXTURE_ALLOCATE\n\t\t\t\t\tuniform sampler2D texture_specularityFactorMap;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef STD_SPECULAR_COLOR\n\t\t\t\t#ifdef STD_SPECULAR_TEXTURE_ALLOCATE\n\t\t\t\t\tuniform sampler2D texture_specularMap;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef STD_GLOSS_TEXTURE_ALLOCATE\n\t\t\t\tuniform sampler2D texture_glossMap;\n\t\t\t#endif\n\t\t#endif\n\t\t#ifdef STD_AO\n\t\t\tfloat dAo;\n\t\t\t#ifdef STD_AO_TEXTURE_ALLOCATE\n\t\t\t\tuniform sampler2D texture_aoMap;\n\t\t\t#endif\n\t\t\t#ifdef STD_AODETAIL_TEXTURE_ALLOCATE\n\t\t\t\tuniform sampler2D texture_aoDetailMap;\n\t\t\t#endif\n\t\t#endif\n\t\tvec3 dEmission;\n\t\t#ifdef STD_EMISSIVE_TEXTURE_ALLOCATE\n\t\t\tuniform sampler2D texture_emissiveMap;\n\t\t#endif\n\t\t#ifdef LIT_CLEARCOAT\n\t\t\t#ifdef STD_CLEARCOAT_TEXTURE_ALLOCATE\n\t\t\t\tuniform sampler2D texture_clearCoatMap;\n\t\t\t#endif\n\t\t\t#ifdef STD_CLEARCOATGLOSS_TEXTURE_ALLOCATE\n\t\t\t\tuniform sampler2D texture_clearCoatGlossMap;\n\t\t\t#endif\n\t\t\t#ifdef STD_CLEARCOATNORMAL_TEXTURE_ALLOCATE\n\t\t\t\tuniform sampler2D texture_clearCoatNormalMap;\n\t\t\t#endif\n\t\t#endif\n\t\t#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)\n\t\t\tvec3 dLightmap;\n\t\t\t#ifdef STD_LIGHT_TEXTURE_ALLOCATE\n\t\t\t\tuniform sampler2D texture_lightMap;\n\t\t\t#endif\n\t\t#endif\n\t#endif\n\t#include "litShaderCorePS"\n',stdFrontEndPS:'\n\t#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE\n\t\t#ifdef STD_OPACITY_TEXTURE_ALLOCATE\n\t\t\tuniform sampler2D texture_opacityMap;\n\t\t#endif\n\t\t#include "opacityPS"\n\t#endif\n\t#ifdef FORWARD_PASS\n\t\t#ifdef STD_HEIGHT_MAP\n\t\t\t#include "parallaxPS"\n\t\t#endif\n\t\t#include  "diffusePS"\n\t\t#ifdef LIT_NEEDS_NORMAL\n\t\t\t#include "normalMapPS"\n\t\t#endif\n\t\t#ifdef LIT_REFRACTION\n\t\t\t#include "transmissionPS"\n\t\t\t#include "thicknessPS"\n\t\t#endif\n\t\t#ifdef LIT_IRIDESCENCE\n\t\t\t#include "iridescencePS"\n\t\t\t#include "iridescenceThicknessPS"\n\t\t#endif\n\t\t#ifdef LIT_SPECULAR_OR_REFLECTION\n\t\t\t#ifdef LIT_SHEEN\n\t\t\t\t#include "sheenPS"\n\t\t\t\t#include "sheenGlossPS"\n\t\t\t#endif\n\t\t\t#ifdef LIT_METALNESS\n\t\t\t\t#include "metalnessPS"\n\t\t\t\t#include "iorPS"\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULARITY_FACTOR\n\t\t\t\t#include "specularityFactorPS"\n\t\t\t#endif\n\t\t\t#ifdef STD_SPECULAR_COLOR\n\t\t\t\t#include "specularPS"\n\t\t\t#else\n\t\t\t\tvoid getSpecularity() { \n\t\t\t\t\tdSpecularity = vec3(1);\n\t\t\t\t}\n\t\t\t#endif\n\t\t\t#include "glossPS"\n\t\t#endif\n\t\t#ifdef STD_AO\n\t\t\t#include "aoPS"\n\t\t#endif\n\t\t#include "emissivePS"\n\t\t#ifdef LIT_CLEARCOAT\n\t\t\t#include "clearCoatPS"\n\t\t\t#include "clearCoatGlossPS"\n\t\t\t#include "clearCoatNormalPS"\n\t\t#endif\n\t\t#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)\n\t\t\t#include "lightmapPS"\n\t\t#endif\n\t#endif\n\tvoid evaluateFrontend() {\n\t\t#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE\n\t\t\tgetOpacity();\n\t\t\t#if defined(LIT_ALPHA_TEST)\n\t\t\t\talphaTest(dAlpha);\n\t\t\t#endif\n\t\t\t#if STD_OPACITY_DITHER != NONE\n\t\t\t\topacityDither(dAlpha, 0.0);\n\t\t\t#endif\n\t\t\tlitArgs_opacity = dAlpha;\n\t\t#endif\n\t\t#ifdef FORWARD_PASS\n\t\t\t#ifdef STD_HEIGHT_MAP\n\t\t\t\tgetParallax();\n\t\t\t#endif\n\t\t\tgetAlbedo();\n\t\t\tlitArgs_albedo = dAlbedo;\n\t\t\t#ifdef LIT_NEEDS_NORMAL\n\t\t\t\tgetNormal();\n\t\t\t\tlitArgs_worldNormal = dNormalW;\n\t\t\t#endif\n\t\t\t#ifdef LIT_REFRACTION\n\t\t\t\tgetRefraction();\n\t\t\t\tlitArgs_transmission = dTransmission;\n\t\t\t\tgetThickness();\n\t\t\t\tlitArgs_thickness = dThickness;\n\t\t\t\t#ifdef LIT_DISPERSION\n\t\t\t\t\tlitArgs_dispersion = material_dispersion;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef LIT_IRIDESCENCE\n\t\t\t\tgetIridescence();\n\t\t\t\tgetIridescenceThickness();\n\t\t\t\tlitArgs_iridescence_intensity = dIridescence;\n\t\t\t\tlitArgs_iridescence_thickness = dIridescenceThickness;\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULAR_OR_REFLECTION\n\t\t\t\t#ifdef LIT_SHEEN\n\t\t\t\t\tgetSheen();\n\t\t\t\t\tlitArgs_sheen_specularity = sSpecularity;\n\t\t\t\t\tgetSheenGlossiness();\n\t\t\t\t\tlitArgs_sheen_gloss = sGlossiness;\n\t\t\t\t#endif\n\t\t\t\t#ifdef LIT_METALNESS\n\t\t\t\t\tgetMetalness();\n\t\t\t\t\tlitArgs_metalness = dMetalness;\n\t\t\t\t\tgetIor();\n\t\t\t\t\tlitArgs_ior = dIor;\n\t\t\t\t#endif\n\t\t\t\t#ifdef LIT_SPECULARITY_FACTOR\n\t\t\t\t\tgetSpecularityFactor();\n\t\t\t\t\tlitArgs_specularityFactor = dSpecularityFactor;\n\t\t\t\t#endif\n\t\t\t\tgetGlossiness();\n\t\t\t\tgetSpecularity();\n\t\t\t\tlitArgs_specularity = dSpecularity;\n\t\t\t\tlitArgs_gloss = dGlossiness;\n\t\t\t#endif\n\t\t\t#ifdef STD_AO\n\t\t\t\tgetAO();\n\t\t\t\tlitArgs_ao = dAo;\n\t\t\t#endif\n\t\t\tgetEmission();\n\t\t\tlitArgs_emission = dEmission;\n\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\tgetClearCoat();\n\t\t\t\tgetClearCoatGlossiness();\n\t\t\t\tgetClearCoatNormal();\n\t\t\t\tlitArgs_clearcoat_specularity = ccSpecularity;\n\t\t\t\tlitArgs_clearcoat_gloss = ccGlossiness;\n\t\t\t\tlitArgs_clearcoat_worldNormal = ccNormalW;\n\t\t\t#endif\n\t\t\t#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)\n\t\t\t\tgetLightMap();\n\t\t\t\tlitArgs_lightmap = dLightmap;\n\t\t\t\t#ifdef STD_LIGHTMAP_DIR\n\t\t\t\t\tlitArgs_lightmapDir = dLightmapDir;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t#endif\n\t}\n',tangentBinormalVS:"\nvec3 getTangent() {\n\treturn normalize(dNormalMatrix * vertex_tangent.xyz);\n}\nvec3 getBinormal() {\n\treturn cross(vNormalW, vTangentW) * vertex_tangent.w;\n}\n",TBNPS:"\n#ifdef LIT_TANGENTS\n\t#define TBN_TANGENTS\n#else\n\t#if defined(LIT_USE_NORMALS) || defined(LIT_USE_CLEARCOAT_NORMALS)\n\t\t#define TBN_DERIVATIVES\n\t#endif\n#endif\n#if defined(TBN_DERIVATIVES)\n\tuniform float tbnBasis;\n#endif\nvoid getTBN(vec3 tangent, vec3 binormal, vec3 normal) {\n\t#ifdef TBN_TANGENTS\n\t\tdTBN = mat3(normalize(tangent), normalize(binormal), normalize(normal));\n\t#elif defined(TBN_DERIVATIVES)\n\t\tvec2 uv = {lightingUv};\n\t\tvec3 dp1 = dFdx( vPositionW );\n\t\tvec3 dp2 = dFdy( vPositionW );\n\t\tvec2 duv1 = dFdx( uv );\n\t\tvec2 duv2 = dFdy( uv );\n\t\tvec3 dp2perp = cross( dp2, normal );\n\t\tvec3 dp1perp = cross( normal, dp1 );\n\t\tvec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n\t\tvec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n\t\tfloat denom = max( dot(T,T), dot(B,B) );\n\t\tfloat invmax = (denom == 0.0) ? 0.0 : tbnBasis / sqrt( denom );\n\t\tdTBN = mat3(T * invmax, -B * invmax, normal );\n\t#else\n\t\tvec3 B = cross(normal, vObjectSpaceUpW);\n\t\tvec3 T = cross(normal, B);\n\t\tif (dot(B,B)==0.0)\n\t\t{\n\t\t\tfloat major=max(max(normal.x, normal.y), normal.z);\n\t\t\tif (normal.x == major)\n\t\t\t{\n\t\t\t\tB = cross(normal, vec3(0,1,0));\n\t\t\t\tT = cross(normal, B);\n\t\t\t}\n\t\t\telse if (normal.y == major)\n\t\t\t{\n\t\t\t\tB = cross(normal, vec3(0,0,1));\n\t\t\t\tT = cross(normal, B);\n\t\t\t}\n\t\t\telse if (normal.z == major)\n\t\t\t{\n\t\t\t\tB = cross(normal, vec3(1,0,0));\n\t\t\t\tT = cross(normal, B);\n\t\t\t}\n\t\t}\n\t\tdTBN = mat3(normalize(T), normalize(B), normalize(normal));\n\t#endif\n}\n",thicknessPS:"\n#ifdef STD_THICKNESS_CONSTANT\nuniform float material_thickness;\n#endif\nvoid getThickness() {\n\tdThickness = 1.0;\n\t#ifdef STD_THICKNESS_CONSTANT\n\tdThickness *= material_thickness;\n\t#endif\n\t#ifdef STD_THICKNESS_TEXTURE\n\tdThickness *= texture2DBias({STD_THICKNESS_TEXTURE_NAME}, {STD_THICKNESS_TEXTURE_UV}, textureBias).{STD_THICKNESS_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_THICKNESS_VERTEX\n\tdThickness *= saturate(vVertexColor.{STD_THICKNESS_VERTEX_CHANNEL});\n\t#endif\n}\n",tonemappingPS:'\n#if (TONEMAP == NONE)\n\t#include "tonemappingNonePS"\n#elif TONEMAP == FILMIC\n\t#include "tonemappingFilmicPS"\n#elif TONEMAP == LINEAR\n\t#include "tonemappingLinearPS"\n#elif TONEMAP == HEJL\n\t#include "tonemappingHejlPS"\n#elif TONEMAP == ACES\n\t#include "tonemappingAcesPS"\n#elif TONEMAP == ACES2\n\t#include "tonemappingAces2PS"\n#elif TONEMAP == NEUTRAL\n\t#include "tonemappingNeutralPS"\n#endif\n',tonemappingAcesPS:"\nuniform float exposure;\nvec3 toneMap(vec3 color) {\n\tfloat tA = 2.51;\n\tfloat tB = 0.03;\n\tfloat tC = 2.43;\n\tfloat tD = 0.59;\n\tfloat tE = 0.14;\n\tvec3 x = color * exposure;\n\treturn (x*(tA*x+tB))/(x*(tC*x+tD)+tE);\n}\n",tonemappingAces2PS:"\nuniform float exposure;\nconst mat3 ACESInputMat = mat3(\n\t0.59719, 0.35458, 0.04823,\n\t0.07600, 0.90834, 0.01566,\n\t0.02840, 0.13383, 0.83777\n);\nconst mat3 ACESOutputMat = mat3(\n\t 1.60475, -0.53108, -0.07367,\n\t-0.10208,  1.10813, -0.00605,\n\t-0.00327, -0.07276,  1.07602\n);\nvec3 RRTAndODTFit(vec3 v) {\n\tvec3 a = v * (v + 0.0245786) - 0.000090537;\n\tvec3 b = v * (0.983729 * v + 0.4329510) + 0.238081;\n\treturn a / b;\n}\nvec3 toneMap(vec3 color) {\n\tcolor *= exposure / 0.6;\n\tcolor = color * ACESInputMat;\n\tcolor = RRTAndODTFit(color);\n\tcolor = color * ACESOutputMat;\n\tcolor = clamp(color, 0.0, 1.0);\n\treturn color;\n}\n",tonemappingFilmicPS:"\nconst float A =  0.15;\nconst float B =  0.50;\nconst float C =  0.10;\nconst float D =  0.20;\nconst float E =  0.02;\nconst float F =  0.30;\nconst float W =  11.2;\nuniform float exposure;\nvec3 uncharted2Tonemap(vec3 x) {\n   return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\n}\nvec3 toneMap(vec3 color) {\n\tcolor = uncharted2Tonemap(color * exposure);\n\tvec3 whiteScale = 1.0 / uncharted2Tonemap(vec3(W,W,W));\n\tcolor = color * whiteScale;\n\treturn color;\n}\n",tonemappingHejlPS:"\nuniform float exposure;\nvec3 toneMap(vec3 color) {\n\tcolor *= exposure;\n\tconst float  A = 0.22, B = 0.3, C = .1, D = 0.2, E = .01, F = 0.3;\n\tconst float Scl = 1.25;\n\tvec3 h = max( vec3(0.0), color - vec3(0.004) );\n\treturn (h*((Scl*A)*h+Scl*vec3(C*B,C*B,C*B))+Scl*vec3(D*E,D*E,D*E)) / (h*(A*h+vec3(B,B,B))+vec3(D*F,D*F,D*F)) - Scl*vec3(E/F,E/F,E/F);\n}\n",tonemappingLinearPS:"\nuniform float exposure;\nvec3 toneMap(vec3 color) {\n\treturn color * exposure;\n}\n",tonemappingNeutralPS:"\nuniform float exposure;\nvec3 toneMap(vec3 color) {\n\tcolor *= exposure;\n\tfloat startCompression = 0.8 - 0.04;\n\tfloat desaturation = 0.15;\n\tfloat x = min(color.r, min(color.g, color.b));\n\tfloat offset = x < 0.08 ? x - 6.25 * x * x : 0.04;\n\tcolor -= offset;\n\tfloat peak = max(color.r, max(color.g, color.b));\n\tif (peak < startCompression) return color;\n\tfloat d = 1. - startCompression;\n\tfloat newPeak = 1. - d * d / (peak + d - startCompression);\n\tcolor *= newPeak / peak;\n\tfloat g = 1. - 1. / (desaturation * (peak - newPeak) + 1.);\n\treturn mix(color, newPeak * vec3(1, 1, 1), g);\n}\n",tonemappingNonePS:"\nvec3 toneMap(vec3 color) {\n\treturn color;\n}\n",transformVS:"\n#ifdef PIXELSNAP\nuniform vec4 uScreenSize;\n#endif\n#ifdef SCREENSPACE\nuniform float projectionFlipY;\n#endif\nvec4 evalWorldPosition(vec3 vertexPosition, mat4 modelMatrix) {\n\tvec3 localPos = getLocalPosition(vertexPosition);\n\t#ifdef NINESLICED\n\t\tlocalPos.xz *= outerScale;\n\t\tvec2 positiveUnitOffset = clamp(vertexPosition.xz, vec2(0.0), vec2(1.0));\n\t\tvec2 negativeUnitOffset = clamp(-vertexPosition.xz, vec2(0.0), vec2(1.0));\n\t\tlocalPos.xz += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\t\tvTiledUv = (localPos.xz - outerScale + innerOffset.xy) * -0.5 + 1.0;\n\t\tlocalPos.xz *= -0.5;\n\t\tlocalPos = localPos.xzy;\n\t#endif\n\tvec4 posW = modelMatrix * vec4(localPos, 1.0);\n\t#ifdef SCREENSPACE\n\t\tposW.zw = vec2(0.0, 1.0);\n\t#endif\n\treturn posW;\n}\nvec4 getPosition() {\n\tdModelMatrix = getModelMatrix();\n\tvec4 posW = evalWorldPosition(vertex_position.xyz, dModelMatrix);\n\tdPositionW = posW.xyz;\n\tvec4 screenPos;\n\t#ifdef UV1LAYOUT\n\t\tscreenPos = vec4(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1);\n\t\t#ifdef WEBGPU\n\t\t\tscreenPos.y *= -1.0;\n\t\t#endif\n\t#else\n\t\t#ifdef SCREENSPACE\n\t\t\tscreenPos = posW;\n\t\t\tscreenPos.y *= projectionFlipY;\n\t\t#else\n\t\t\tscreenPos = matrix_viewProjection * posW;\n\t\t#endif\n\t\t#ifdef PIXELSNAP\n\t\t\tscreenPos.xy = (screenPos.xy * 0.5) + 0.5;\n\t\t\tscreenPos.xy *= uScreenSize.xy;\n\t\t\tscreenPos.xy = floor(screenPos.xy);\n\t\t\tscreenPos.xy *= uScreenSize.zw;\n\t\t\tscreenPos.xy = (screenPos.xy * 2.0) - 1.0;\n\t\t#endif\n\t#endif\n\treturn screenPos;\n}\nvec3 getWorldPosition() {\n\treturn dPositionW;\n}\n",transformCoreVS:'\nattribute vec4 vertex_position;\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\n#ifdef MORPHING\n\tuniform vec2 morph_tex_params;\n\tattribute uint morph_vertex_id;\n\tivec2 getTextureMorphCoords() {\n\t\tivec2 textureSize = ivec2(morph_tex_params);\n\t\tint morphGridV = int(morph_vertex_id) / textureSize.x;\n\t\tint morphGridU = int(morph_vertex_id) - (morphGridV * textureSize.x);\n\t\t#ifdef WEBGPU\n\t\t\tmorphGridV = textureSize.y - morphGridV - 1;\n\t\t#endif\n\t\treturn ivec2(morphGridU, morphGridV);\n\t}\n\t#ifdef MORPHING_POSITION\n\t\t#ifdef MORPHING_INT\n\t\t\tuniform vec3 aabbSize;\n\t\t\tuniform vec3 aabbMin;\n\t\t\tuniform usampler2D morphPositionTex;\n\t\t#else\n\t\t\tuniform highp sampler2D morphPositionTex;\n\t\t#endif\n\t#endif\n#endif\n#ifdef defined(BATCH)\n\t#include "skinBatchVS"\n\tmat4 getModelMatrix() {\n\t\treturn getBoneMatrix(vertex_boneIndices);\n\t}\n#elif defined(SKIN)\n\t#include "skinVS"\n\tmat4 getModelMatrix() {\n\t\treturn matrix_model * getSkinMatrix(vertex_boneIndices, vertex_boneWeights);\n\t}\n#elif defined(INSTANCING)\n\t#include "transformInstancingVS"\n#else\n\tmat4 getModelMatrix() {\n\t\treturn matrix_model;\n\t}\n#endif\nvec3 getLocalPosition(vec3 vertexPosition) {\n\tvec3 localPos = vertexPosition;\n\t#ifdef MORPHING_POSITION\n\t\tivec2 morphUV = getTextureMorphCoords();\n\t\t#ifdef MORPHING_INT\n\t\t\tvec3 morphPos = vec3(texelFetch(morphPositionTex, ivec2(morphUV), 0).xyz) / 65535.0 * aabbSize + aabbMin;\n\t\t#else\n\t\t\tvec3 morphPos = texelFetch(morphPositionTex, ivec2(morphUV), 0).xyz;\n\t\t#endif\n\t\tlocalPos += morphPos;\n\t#endif\n\treturn localPos;\n}\n',transformInstancingVS:"\nattribute vec4 instance_line1;\nattribute vec4 instance_line2;\nattribute vec4 instance_line3;\nattribute vec4 instance_line4;\nmat4 getModelMatrix() {\n\treturn matrix_model * mat4(instance_line1, instance_line2, instance_line3, instance_line4);\n}\n",transmissionPS:"\n#ifdef STD_REFRACTION_CONSTANT\nuniform float material_refraction;\n#endif\nvoid getRefraction() {\n\tfloat refraction = 1.0;\n\t#ifdef STD_REFRACTION_CONSTANT\n\trefraction = material_refraction;\n\t#endif\n\t#ifdef STD_REFRACTION_TEXTURE\n\trefraction *= texture2DBias({STD_REFRACTION_TEXTURE_NAME}, {STD_REFRACTION_TEXTURE_UV}, textureBias).{STD_REFRACTION_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_REFRACTION_VERTEX\n\trefraction *= saturate(vVertexColor.{STD_REFRACTION_VERTEX_CHANNEL});\n\t#endif\n\tdTransmission = refraction;\n}\n",twoSidedLightingPS:"\nuniform float twoSidedLightingNegScaleFactor;\nvoid handleTwoSidedLighting() {\n\tdTBN[2] *= gl_FrontFacing ? twoSidedLightingNegScaleFactor : -twoSidedLightingNegScaleFactor;\n}\n",uv0VS:"\n#ifdef NINESLICED\n\tvec2 getUv0() {\n\t\tvec2 uv = vertex_position.xz;\n\t\tvec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n\t\tvec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n\t\tuv += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\t\tuv = uv * -0.5 + 0.5;\n\t\tuv = uv * atlasRect.zw + atlasRect.xy;\n\t\tvMask = vertex_texCoord0.xy;\n\t\treturn uv;\n\t}\n#else\n\tvec2 getUv0() {\n\t\treturn vertex_texCoord0;\n\t}\n#endif\n",uv1VS:"\nvec2 getUv1() {\n\treturn vertex_texCoord1;\n}\n",uvTransformVS:"\nvUV{TRANSFORM_UV_{i}}_{TRANSFORM_ID_{i}} = vec2(\n\tdot(vec3(uv{TRANSFORM_UV_{i}}, 1), {TRANSFORM_NAME_{i}}0),\n\tdot(vec3(uv{TRANSFORM_UV_{i}}, 1), {TRANSFORM_NAME_{i}}1)\n);\n",uvTransformUniformsPS:"\n\tuniform vec3 {TRANSFORM_NAME_{i}}0;\n\tuniform vec3 {TRANSFORM_NAME_{i}}1;\n",viewDirPS:"\nvoid getViewDir() {\n\tdViewDirW = normalize(view_position - vPositionW);\n}\n",webgpuPS:Ea,webgpuVS:Aa},bh=new hr;function yh(e){return bh.get(e)}class xh{static definesHash(e){var t=Array.from(e).sort(((e,t)=>e[0]>t[0]?1:-1));return Rr(JSON.stringify(t))}}var Sh=new hr;class wh{buildShaderDefines(){var e;this.isShadow?e="SHADOW":this.isForward?e="FORWARD":2===this.index?e="DEPTH":3===this.index&&(e="PICK"),this.defines.set(e+"_PASS",""),this.defines.set(this.name.toUpperCase()+"_PASS","")}constructor(e,t,i={}){this.defines=new Map,this.name=e,this.index=t,Object.assign(this,i),this.buildShaderDefines()}}class Th{static get(e){return Sh.get(e,(()=>new Th))}allocate(e,t){var i=this.passesNamed.get(e);return void 0===i&&(i=new wh(e,this.nextIndex,t),this.passesNamed.set(i.name,i),this.passesIndexed[i.index]=i,this.nextIndex++),i}getByIndex(e){return this.passesIndexed[e]}getByName(e){return this.passesNamed.get(e)}constructor(){this.passesNamed=new Map,this.passesIndexed=[],this.nextIndex=0;var e=(e,t,i)=>{this.allocate(e,i)};e("forward",0,{isForward:!0}),e("prepass"),e("depth"),e("pick"),e("shadow")}}function Ch(){return Ch=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var s in i)Object.prototype.hasOwnProperty.call(i,s)&&(e[s]=i[s])}return e},Ch.apply(this,arguments)}function Eh(e,t,i,s,r,n,a){void 0===n&&(n=!1),void 0===a&&(a={}),"boolean"==typeof n?a.useTransformFeedback=n:"object"==typeof n&&(a=Ch({},a,n));var o=yh(e),l=o.getCachedShader(s);return l||(l=new Ra(e,Ma.createDefinition(e,Ch({},a,{name:s,vertexCode:t,fragmentCode:i,attributes:r}))),o.setCachedShader(s,l)),l}class Ah extends xh{generateKey(e){return this.key}createShaderDefinition(e,t){return this.shaderDefinition}constructor(e,t){super(),this.key=e,this.shaderDefinition=t}}var Ph=(e,t)=>{var i=new Map(e.defines);return t.cameraShaderParams.defines.forEach(((e,t)=>i.set(t,e))),Th.get(t.device).getByIndex(t.pass).defines.forEach(((e,t)=>i.set(t,e))),i},Dh={type:5,base:0,count:4,indexed:!1},Lh=new ui,Mh=new ui,Ih=new _r;class Rh{destroy(){var e,t;null==(e=this.uniformBuffer)||e.destroy(),this.uniformBuffer=null,null==(t=this.bindGroup)||t.destroy(),this.bindGroup=null}render(e,t){var i=this.shader.device;e&&(Lh.set(i.vx,i.vy,i.vw,i.vh),Mh.set(i.sx,i.sy,i.sw,i.sh),t=null!=t?t:e,i.setViewport(e.x,e.y,e.z,e.w),i.setScissor(t.x,t.y,t.z,t.w)),i.setVertexBuffer(i.quadVertexBuffer,0);var s=this.shader;if(i.setShader(s),i.supportsUniformBuffers){i.setBindGroup(0,i.emptyBindGroup);var r=this.bindGroup;r.update(),i.setBindGroup(1,r);var n=this.uniformBuffer;n?(n.update(Ih),i.setBindGroup(2,Ih.bindGroup,Ih.offsets)):i.setBindGroup(2,i.emptyBindGroup)}i.draw(Dh),e&&(i.setViewport(Lh.x,Lh.y,Lh.z,Lh.w),i.setScissor(Mh.x,Mh.y,Mh.z,Mh.w))}constructor(e){var t=e.device;if(this.shader=e,t.supportsUniformBuffers){var i=new vh;this.shader=function(e,t){var i,s=e.definition,r=(null!=(i=s.name)?i:"shader")+"-id-"+e.id,n=new Ah(r,s),a="shader",o=yh(e.device);o.register(a,n);var l=o.getProgram(a,{},t);return o.unregister(a),l}(e,i);var s=this.shader.meshUniformBufferFormat;s&&(this.uniformBuffer=new Na(t,s,!1));var r=this.shader.meshBindGroupFormat;this.bindGroup=new br(t,r)}}}class kh extends Do{execute(){var{device:e}=this;e.setCullMode(0),e.setDepthState(Cr.NODEPTH),e.setStencilState(null,null),this.quad.render(this.rect,this.scissorRect)}constructor(e,t,i,s){super(e),this.quad=t,this.rect=i,this.scissorRect=s}}var Oh=new ui;function Fh(e,t,i,s,r){var n=new Rh(i);s||((s=Oh).x=0,s.y=0,s.z=t?t.width:e.width,s.w=t?t.height:e.height);var a=new kh(e,n,s,r);a.init(t),a.colorOps.clear=!1,a.depthStencilOps.clearDepth=!1,e.isWebGPU&&null===t&&e.samples>1&&(a.colorOps.store=!0),a.render(),n.destroy()}class Bh{constructor(e,t,i,s,r=[0]){this._ui=!1,this._sprite=!1,this._obj={model:[],element:[],sprite:[],render:[]},this.id=e,this.name=t,this.dynamic=i,this.maxAabbSize=s,this.layers=r}}Bh.MODEL="model",Bh.ELEMENT="element",Bh.SPRITE="sprite",Bh.RENDER="render";var Nh=new _i;class zh{set rootBone(e){this._rootBone=e}get rootBone(){return this._rootBone}init(e,t){var i=3*t,s=Math.ceil(Math.sqrt(i));s=ti.roundUp(s,3);var r=Math.ceil(i/s);this.boneTexture=new ur(e,{width:s,height:r,format:ki,mipmaps:!1,minFilter:0,magFilter:0,name:"skin"}),this.matrixPalette=this.boneTexture.lock({mode:1}),this.boneTexture.unlock()}destroy(){this.boneTexture&&(this.boneTexture.destroy(),this.boneTexture=null)}resolve(e,t){this.rootBone=e;for(var i=this.skin,s=[],r=0;r<i.boneNames.length;r++){var n=i.boneNames[r],a=e.findByName(n);a||(a=t),s.push(a)}this.bones=s}initSkin(e){this.skin=e,this.bones=[];var t=e.inverseBindPose.length;this.init(e.device,t),this.matrices=[];for(var i=0;i<t;i++)this.matrices[i]=new _i}uploadBones(e){this.boneTexture.upload()}_updateMatrices(e,t){if(this._skinUpdateIndex!==t){this._skinUpdateIndex=t,Nh.copy(e.getWorldTransform()).invert();for(var i=this.bones.length-1;i>=0;i--)this.matrices[i].mulAffine2(Nh,this.bones[i].getWorldTransform()),this.matrices[i].mulAffine2(this.matrices[i],this.skin.inverseBindPose[i])}}updateMatrices(e,t){this._updateBeforeCull&&this._updateMatrices(e,t)}updateMatrixPalette(e,t){this._updateMatrices(e,t);for(var i=this.matrixPalette,s=this.bones.length,r=0;r<s;r++){var n=this.matrices[r].data,a=12*r;i[a]=n[0],i[a+1]=n[4],i[a+2]=n[8],i[a+3]=n[12],i[a+4]=n[1],i[a+5]=n[5],i[a+6]=n[9],i[a+7]=n[13],i[a+8]=n[2],i[a+9]=n[6],i[a+10]=n[10],i[a+11]=n[14]}this.uploadBones(this.skin.device)}constructor(e){this._dirty=!0,this._rootBone=null,this._skinUpdateIndex=-1,this._updateBeforeCull=!0,e&&this.initSkin(e)}}var Uh=0;class Vh{initDefaults(){this.recreate=!1,this.verticesUsage=0,this.indicesUsage=0,this.maxVertices=0,this.maxIndices=0,this.vertexCount=0,this.indexCount=0,this.vertexStreamsUpdated=!1,this.indexStreamUpdated=!1,this.vertexStreamDictionary={},this.indices=null}_changeVertexCount(e,t){this.vertexCount||(this.vertexCount=e)}constructor(){this.initDefaults()}}Vh.DEFAULT_COMPONENTS_POSITION=3,Vh.DEFAULT_COMPONENTS_NORMAL=3,Vh.DEFAULT_COMPONENTS_UV=2,Vh.DEFAULT_COMPONENTS_COLORS=4;class Hh{constructor(e,t,i,s,r){this.data=e,this.componentCount=t,this.dataType=i,this.dataTypeNormalize=s,this.asInt=r}}class Gh extends gn{static fromGeometry(e,t,i){void 0===i&&(i={});var s=new Gh(e,i),{positions:r,normals:n,tangents:a,colors:o,uvs:l,uvs1:h,blendIndices:c,blendWeights:d,indices:u}=t;return r&&s.setPositions(r),n&&s.setNormals(n),a&&s.setVertexStream(Zi,a,4),o&&s.setColors32(o),l&&s.setUvs(0,l),h&&s.setUvs(1,h),c&&s.setVertexStream(ts,c,4,c.length/4,1),d&&s.setVertexStream(es,d,4),u&&s.setIndices(u),s.update(),s}set morph(e){e!==this._morph&&(this._morph&&this._morph.decRefCount(),this._morph=e,e&&e.incRefCount())}get morph(){return this._morph}set aabb(e){this._aabb=e,this._aabbVer++}get aabb(){return this._aabb}destroy(){var e=this.morph;e&&(this.morph=null,e.refCount<1&&e.destroy()),this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);for(var t=0;t<this.indexBuffer.length;t++)this._destroyIndexBuffer(t);this.indexBuffer.length=0,this._geometryData=null}_destroyIndexBuffer(e){this.indexBuffer[e]&&(this.indexBuffer[e].destroy(),this.indexBuffer[e]=null)}_initBoneAabbs(e){var t,i,s,r,n;this.boneAabb=[],this.boneUsed=[];for(var a,o,l,h=[],c=[],d=this.boneUsed,u=this.skin.boneNames.length,f=0;f<u;f++)h[f]=new hi(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),c[f]=new hi(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var p=new Go(this.vertexBuffer),m=p.element[Ji],g=p.element[es],v=p.element[ts],_=this.vertexBuffer.numVertices,b=0;b<_;b++){for(var y=0;y<4;y++){if(g.array[g.index+y]>0){var x=v.array[v.index+y];if(d[x]=!0,t=m.array[m.index],i=m.array[m.index+1],s=m.array[m.index+2],r=c[x],(n=h[x]).x>t&&(n.x=t),n.y>i&&(n.y=i),n.z>s&&(n.z=s),r.x<t&&(r.x=t),r.y<i&&(r.y=i),r.z<s&&(r.z=s),e){for(var S=a=t,w=o=i,T=l=s,C=0;C<e.length;C++){var E=e[C],A=E.deltaPositions[3*b],P=E.deltaPositions[3*b+1],D=E.deltaPositions[3*b+2];A<0?S+=A:a+=A,P<0?w+=P:o+=P,D<0?T+=D:l+=D}n.x>S&&(n.x=S),n.y>w&&(n.y=w),n.z>T&&(n.z=T),r.x<a&&(r.x=a),r.y<o&&(r.y=o),r.z<l&&(r.z=l)}}}p.next()}var L=this.vertexBuffer.getFormat().elements.find((e=>e.name===Ji));if(L&&L.normalize)for(var M=(()=>{switch(L.dataType){case 0:return e=>Math.max(e/127,-1);case 1:return e=>e/255;case 2:return e=>Math.max(e/32767,-1);case 3:return e=>e/65535;default:return e=>e}})(),I=0;I<u;I++)if(d[I]){var R=h[I],k=c[I];R.set(M(R.x),M(R.y),M(R.z)),k.set(M(k.x),M(k.y),M(k.z))}for(var O=0;O<u;O++){var F=new Ci;F.setMinMax(h[O],c[O]),this.boneAabb.push(F)}}_initGeometryData(){this._geometryData||(this._geometryData=new Vh,this.vertexBuffer&&(this._geometryData.vertexCount=this.vertexBuffer.numVertices,this._geometryData.maxVertices=this.vertexBuffer.numVertices),this.indexBuffer.length>0&&this.indexBuffer[0]&&(this._geometryData.indexCount=this.indexBuffer[0].numIndices,this._geometryData.maxIndices=this.indexBuffer[0].numIndices))}clear(e,t,i,s){void 0===i&&(i=0),void 0===s&&(s=0),this._initGeometryData(),this._geometryData.initDefaults(),this._geometryData.recreate=!0,this._geometryData.maxVertices=i,this._geometryData.maxIndices=s,this._geometryData.verticesUsage=e?0:1,this._geometryData.indicesUsage=t?0:1}setVertexStream(e,t,i,s,r,n,a){void 0===r&&(r=6),void 0===n&&(n=!1),void 0===a&&(a=!1),this._initGeometryData();var o=s||t.length/i;this._geometryData._changeVertexCount(o,e),this._geometryData.vertexStreamsUpdated=!0,this._geometryData.vertexStreamDictionary[e]=new Hh(t,i,r,n,a)}getVertexStream(e,t){var i=0,s=!1;if(this._geometryData){var r=this._geometryData.vertexStreamDictionary[e];r&&(s=!0,i=this._geometryData.vertexCount,ArrayBuffer.isView(t)?t.set(r.data):(t.length=0,t.push(r.data)))}s||this.vertexBuffer&&(i=new Go(this.vertexBuffer).readData(e,t));return i}setPositions(e,t,i){void 0===t&&(t=Vh.DEFAULT_COMPONENTS_POSITION),this.setVertexStream(Ji,e,t,i,6,!1)}setNormals(e,t,i){void 0===t&&(t=Vh.DEFAULT_COMPONENTS_NORMAL),this.setVertexStream($i,e,t,i,6,!1)}setUvs(e,t,i,s){void 0===i&&(i=Vh.DEFAULT_COMPONENTS_UV),this.setVertexStream(ss+e,t,i,s,6,!1)}setColors(e,t,i){void 0===t&&(t=Vh.DEFAULT_COMPONENTS_COLORS),this.setVertexStream(is,e,t,i,6,!1)}setColors32(e,t){this.setVertexStream(is,e,Vh.DEFAULT_COMPONENTS_COLORS,t,1,!0)}setIndices(e,t){this._initGeometryData(),this._geometryData.indexStreamUpdated=!0,this._geometryData.indices=e,this._geometryData.indexCount=t||e.length}getPositions(e){return this.getVertexStream(Ji,e)}getNormals(e){return this.getVertexStream($i,e)}getUvs(e,t){return this.getVertexStream(ss+e,t)}getColors(e){return this.getVertexStream(is,e)}getIndices(e){var t=0;if(this._geometryData&&this._geometryData.indices){var i=this._geometryData.indices;if(t=this._geometryData.indexCount,ArrayBuffer.isView(e))e.set(i);else{e.length=0;for(var s=0,r=i.length;s<r;s++)e.push(i[s])}}else{if(this.indexBuffer.length>0&&this.indexBuffer[0])t=this.indexBuffer[0].readData(e)}return t}update(e,t){if(void 0===e&&(e=4),void 0===t&&(t=!0),this._geometryData){if(t){var i=this._geometryData.vertexStreamDictionary[Ji];i&&3===i.componentCount&&(this._aabb.compute(i.data,this._geometryData.vertexCount),this._aabbVer++)}var s=this._geometryData.recreate;this._geometryData.vertexCount>this._geometryData.maxVertices&&(s=!0,this._geometryData.maxVertices=this._geometryData.vertexCount),s&&this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);var r=this._geometryData.recreate;this._geometryData.indexCount>this._geometryData.maxIndices&&(r=!0,this._geometryData.maxIndices=this._geometryData.indexCount),r&&this.indexBuffer.length>0&&this.indexBuffer[0]&&(this.indexBuffer[0].destroy(),this.indexBuffer[0]=null),this._geometryData.vertexStreamsUpdated&&this._updateVertexBuffer(),this._geometryData.indexStreamUpdated&&this._updateIndexBuffer(),this.primitive[0].type=e,this.indexBuffer.length>0&&this.indexBuffer[0]?this._geometryData.indexStreamUpdated&&(this.primitive[0].count=this._geometryData.indexCount,this.primitive[0].indexed=!0):this._geometryData.vertexStreamsUpdated&&(this.primitive[0].count=this._geometryData.vertexCount,this.primitive[0].indexed=!1),this._geometryData.vertexCount=0,this._geometryData.indexCount=0,this._geometryData.vertexStreamsUpdated=!1,this._geometryData.indexStreamUpdated=!1,this._geometryData.recreate=!1,this.updateRenderStates()}}_buildVertexFormat(e){var t=[];for(var i in this._geometryData.vertexStreamDictionary){var s=this._geometryData.vertexStreamDictionary[i];t.push({semantic:i,components:s.componentCount,type:s.dataType,normalize:s.dataTypeNormalize,asInt:s.asInt})}return new Nr(this.device,t,e)}_updateVertexBuffer(){if(!this.vertexBuffer){var e=this._geometryData.maxVertices,t=this._buildVertexFormat(e);this.vertexBuffer=new Ir(this.device,t,e,{usage:this._geometryData.verticesUsage,storage:this._storageVertex})}var i=new Go(this.vertexBuffer),s=this._geometryData.vertexCount;for(var r in this._geometryData.vertexStreamDictionary){var n=this._geometryData.vertexStreamDictionary[r];i.writeData(r,n.data,s),delete this._geometryData.vertexStreamDictionary[r]}i.end()}_updateIndexBuffer(){if(this.indexBuffer.length<=0||!this.indexBuffer[0]){var e=this._geometryData.maxVertices,t=e>65535||0===e?2:1,i=this._storageIndex?{storage:!0}:void 0;this.indexBuffer[0]=new Eo(this.device,t,this._geometryData.maxIndices,this._geometryData.indicesUsage,void 0,i)}var s=this._geometryData.indices;s&&(this.indexBuffer[0].writeData(s,this._geometryData.indexCount),this._geometryData.indices=null)}prepareRenderState(e){1===e?this.generateWireframe():2===e&&(this.primitive[2]={type:0,base:0,count:this.vertexBuffer?this.vertexBuffer.numVertices:0,indexed:!1})}updateRenderStates(){this.primitive[2]&&this.prepareRenderState(2),this.primitive[1]&&this.prepareRenderState(1)}generateWireframe(){this._destroyIndexBuffer(1);var e,t=this.vertexBuffer.numVertices,i=[];if(this.indexBuffer.length>0&&this.indexBuffer[0]){for(var s=[[0,1],[1,2],[2,0]],r=this.primitive[0].base,n=this.primitive[0].count,a=this.indexBuffer[0],o=new $s[a.format](a.storage),l=new Set,h=r;h<r+n;h+=3)for(var c=0;c<3;c++){var d=o[h+s[c][0]],u=o[h+s[c][1]],f=d>u?u*t+d:d*t+u;l.has(f)||(l.add(f),i.push(d,u))}e=a.format}else{for(var p=0;p<t;p+=3)i.push(p,p+1,p+1,p+2,p+2,p);e=i.length>65535?2:1}var m=new Eo(this.vertexBuffer.device,e,i.length);new $s[m.format](m.storage).set(i),m.unlock(),this.primitive[1]={type:1,base:0,count:i.length,indexed:!0},this.indexBuffer[1]=m}constructor(e,t){super(),this.indexBuffer=[null],this.vertexBuffer=null,this.primitive=[{type:0,base:0,count:0}],this.skin=null,this.boneAabb=null,this._aabbVer=0,this._aabb=new Ci,this._geometryData=null,this._morph=null,this._storageIndex=!1,this._storageVertex=!1,this.id=Uh++,this.device=e,this._storageIndex=(null==t?void 0:t.storageIndex)||!1,this._storageVertex=(null==t?void 0:t.storageVertex)||!1}}var Wh=new hr;function jh(e){return Wh.get(e)}class qh{static incRef(e){this.cache.incRef(e)}static decRef(e){this.cache.decRef(e)}static destroy(){this.cache.destroy()}}qh.cache=new class{destroy(){this.cache.forEach(((e,t)=>{t.destroy()})),this.cache.clear()}incRef(e){var t=(this.cache.get(e)||0)+1;this.cache.set(e,t)}decRef(e){if(e){var t=this.cache.get(e);t&&(0===--t?(this.cache.delete(e),e.destroy()):this.cache.set(e,t))}}constructor(){this.cache=new Map}};var Xh=0,Kh=new Ci,Yh=new Ci,Qh=new Pi,Jh=new Set,$h=new Uint32Array(4);class Zh{destroy(){var e;this._destroyVertexBuffer&&(null==(e=this.vertexBuffer)||e.destroy());this.vertexBuffer=null}constructor(e){this.vertexBuffer=null,this._destroyVertexBuffer=!1,this.count=e}}class ec{getBindGroup(e){if(!this.bindGroup){var t=this.shader.meshBindGroupFormat;this.bindGroup=new br(e,t)}return this.bindGroup}getUniformBuffer(e){if(!this.uniformBuffer){var t=this.shader.meshUniformBufferFormat;this.uniformBuffer=new Na(e,t,!1)}return this.uniformBuffer}destroy(){var e,t;null==(e=this.bindGroup)||e.destroy(),this.bindGroup=null,null==(t=this.uniformBuffer)||t.destroy(),this.uniformBuffer=null}constructor(){this.bindGroup=null,this.uniformBuffer=null}}class tc{set drawBucket(e){this._drawBucket=255&Math.floor(e),this.updateKey()}get drawBucket(){return this._drawBucket}set renderStyle(e){this._renderStyle=e,this.mesh.prepareRenderState(e)}get renderStyle(){return this._renderStyle}set mesh(e){e!==this._mesh&&(this._mesh&&this._mesh.decRefCount(),this._mesh=e,e&&e.incRefCount())}get mesh(){return this._mesh}set aabb(e){this._aabb=e}get aabb(){if(!this._updateAabb)return this._aabb;if(this._updateAabbFunc)return this._updateAabbFunc(this._aabb);var e=this._customAabb,t=!!e;if(!e)if(e=Kh,this.skinInstance){if(!this.mesh.boneAabb){var i=this._morphInstance?this._morphInstance.morph._targets:null;this.mesh._initBoneAabbs(i)}for(var s=this.mesh.boneUsed,r=!0,n=0;n<this.mesh.boneAabb.length;n++)s[n]&&(Yh.setFromTransformedAabb(this.mesh.boneAabb[n],this.skinInstance.matrices[n]),r?(r=!1,e.center.copy(Yh.center),e.halfExtents.copy(Yh.halfExtents)):e.add(Yh));t=!0}else if(this.node._aabbVer!==this._aabbVer||this.mesh._aabbVer!==this._aabbMeshVer){if(this.mesh?(e.center.copy(this.mesh.aabb.center),e.halfExtents.copy(this.mesh.aabb.halfExtents)):(e.center.set(0,0,0),e.halfExtents.set(0,0,0)),this.mesh&&this.mesh.morph){var a=this.mesh.morph.aabb;e._expand(a.getMin(),a.getMax())}t=!0,this._aabbVer=this.node._aabbVer,this._aabbMeshVer=this.mesh._aabbVer}return t&&this._aabb.setFromTransformedAabb(e,this.node.getWorldTransform()),this._aabb}clearShaders(){this._shaderCache.forEach((e=>{e.destroy()})),this._shaderCache.clear()}getShaderInstance(e,t,i,s,r,n,a){var o=this._shaderDefs;$h[0]=e,$h[1]=t,$h[2]=o,$h[3]=s.hash;var l=kr($h),h=this._shaderCache.get(l);if(!h){var c=this._material;if((h=new ec).shader=c.variants.get(l),h.hashes=new Uint32Array($h),!h.shader){var d,u=c.getShaderVariant({device:this.mesh.device,scene:i,objDefs:o,cameraShaderParams:s,pass:e,sortedLights:a,viewUniformFormat:r,viewBindGroupFormat:n,vertexFormat:null==(d=this.mesh.vertexBuffer)?void 0:d.format});c.variants.set(l,u),h.shader=u}this._shaderCache.set(l,h)}return h}set material(e){this.clearShaders();var t=this._material;t&&t.removeMeshInstanceRef(this),this._material=e,e&&(e.addMeshInstanceRef(this),this.transparent=e.transparent,this.updateKey())}get material(){return this._material}_updateShaderDefs(e){e!==this._shaderDefs&&(this._shaderDefs=e,this.clearShaders())}set calculateSortDistance(e){this._calculateSortDistance=e}get calculateSortDistance(){return this._calculateSortDistance}set receiveShadow(e){this._receiveShadow!==e&&(this._receiveShadow=e,this._updateShaderDefs(e?-2&this._shaderDefs:1|this._shaderDefs))}get receiveShadow(){return this._receiveShadow}set batching(e){this._updateShaderDefs(e?this._shaderDefs|sh:-16385&this._shaderDefs)}get batching(){return!!(this._shaderDefs&sh)}set skinInstance(e){this._skinInstance=e,this._updateShaderDefs(e?2|this._shaderDefs:-3&this._shaderDefs),this._setupSkinUpdate()}get skinInstance(){return this._skinInstance}set morphInstance(e){var t;null==(t=this._morphInstance)||t.destroy(),this._morphInstance=e;var i=this._shaderDefs;i=e&&e.morph.morphPositions?i|eh:-1025&i,i=e&&e.morph.morphNormals?i|th:-2049&i,i=e&&e.morph.intRenderFormat?i|ih:-8193&i,this._updateShaderDefs(i)}get morphInstance(){return this._morphInstance}set screenSpace(e){this._screenSpace!==e&&(this._screenSpace=e,this._updateShaderDefs(e?256|this._shaderDefs:-257&this._shaderDefs))}get screenSpace(){return this._screenSpace}set key(e){this._sortKeyForward=e}get key(){return this._sortKeyForward}set mask(e){var t=65535&this._shaderDefs;this._updateShaderDefs(t|e<<16)}get mask(){return this._shaderDefs>>16}set instancingCount(e){this.instancingData&&(this.instancingData.count=e)}get instancingCount(){return this.instancingData?this.instancingData.count:0}destroy(){var e,t,i,s=this.mesh;s&&(this.mesh=null,s.refCount<1&&s.destroy()),this.setRealtimeLightmap(tc.lightmapParamNames[0],null),this.setRealtimeLightmap(tc.lightmapParamNames[1],null),null==(e=this._skinInstance)||e.destroy(),this._skinInstance=null,null==(t=this.morphInstance)||t.destroy(),this.morphInstance=null,this.clearShaders(),this.material=null,null==(i=this.instancingData)||i.destroy()}static _prepareRenderStyleForArray(e,t){if(e){for(var i=0;i<e.length;i++){e[i]._renderStyle=t;var s=e[i].mesh;Jh.has(s)||(Jh.add(s),s.prepareRenderState(t))}Jh.clear()}}_isVisible(e){return!!this.visible&&(this.isVisibleFunc?this.isVisibleFunc(e):(Qh.center=this.aabb.center,Qh.radius=this._aabb.halfExtents.length(),e.frustum.containsSphere(Qh)>0))}updateKey(){var{material:e}=this;this._sortKeyForward=this._drawBucket<<25|(e.alphaToCoverage||e.alphaTest?16777216:0)|16777215&e.id}setInstancing(e,t){void 0===t&&(t=!1),e?(this.instancingData=new Zh(e.numVertices),this.instancingData.vertexBuffer=e,e.format.instancing=!0,this.cull=t):(this.instancingData=null,this.cull=!0),this._updateShaderDefs(e?32|this._shaderDefs:-33&this._shaderDefs)}ensureMaterial(e){this.material||(this.material=jh(e))}clearParameters(){this.parameters={}}getParameters(){return this.parameters}getParameter(e){return this.parameters[e]}setParameter(e,t,i){void 0===i&&(i=4294967295);var s=this.parameters[e];s?(s.data=t,s.passFlags=i):this.parameters[e]={scopeId:null,data:t,passFlags:i}}setRealtimeLightmap(e,t){var i=this.getParameter(e);i!==t&&(i&&qh.decRef(i.data),t?(qh.incRef(t),this.setParameter(e,t)):this.deleteParameter(e))}deleteParameter(e){this.parameters[e]&&delete this.parameters[e]}setParameters(e,t){var i=this.parameters;for(var s in i){var r=i[s];r.passFlags&t&&(r.scopeId||(r.scopeId=e.scope.resolve(s)),r.scopeId.setValue(r.data))}}setLightmapped(e){e?this.mask=-6&this.mask|2:(this.setRealtimeLightmap(tc.lightmapParamNames[0],null),this.setRealtimeLightmap(tc.lightmapParamNames[1],null),this._shaderDefs&=-4289,this.mask=-7&this.mask|1)}setCustomAabb(e){e?this._customAabb?this._customAabb.copy(e):this._customAabb=e.clone():(this._customAabb=null,this._aabbVer=-1),this._setupSkinUpdate()}_setupSkinUpdate(){this._skinInstance&&(this._skinInstance._updateBeforeCull=!this._customAabb)}constructor(e,t,i=null){if(this.castShadow=!1,this.cull=!0,this.drawOrder=0,this._drawBucket=127,this.visible=!0,this.visibleThisFrame=!1,this.flipFacesFactor=1,this.gsplatInstance=null,this.id=Xh++,this.isVisibleFunc=null,this.instancingData=null,this.parameters={},this.pick=!0,this.stencilFront=null,this.stencilBack=null,this.transparent=!1,this._aabb=new Ci,this._aabbVer=-1,this._aabbMeshVer=-1,this._customAabb=null,this._updateAabb=!0,this._updateAabbFunc=null,this._sortKeyShadow=0,this._sortKeyForward=0,this._sortKeyDynamic=0,this._layer=15,this._material=null,this._skinInstance=null,this._morphInstance=null,this._receiveShadow=!0,this._renderStyle=0,this._screenSpace=!1,this._shaderCache=new Map,this._shaderDefs=65536,this._calculateSortDistance=null,this.node=i,this._mesh=e,e.incRefCount(),this.material=t,e.vertexBuffer){var s=e.vertexBuffer.format;this._shaderDefs|=s.hasUv0?4:0,this._shaderDefs|=s.hasUv1?8:0,this._shaderDefs|=s.hasColor?16:0,this._shaderDefs|=s.hasTangents?512:0}this.updateKey()}}tc.lightmapParamNames=["texture_lightMap","texture_dirLightMap"];var ic="uSceneColorMap";class sc extends Do{destroy(){super.destroy(),this.releaseRenderTarget(this.colorRenderTarget)}shouldReallocate(e,t,i){if((null==e?void 0:e.colorBuffer.format)!==i)return!0;var s=(null==t?void 0:t.width)||this.device.width,r=(null==t?void 0:t.height)||this.device.height;return!e||s!==e.width||r!==e.height}allocateRenderTarget(e,t,i,s){var r=new ur(i,{name:ic,format:s,width:t?t.colorBuffer.width:i.width,height:t?t.colorBuffer.height:i.height,mipmaps:!0,minFilter:5,magFilter:1,addressU:1,addressV:1});return e?(e.destroyFrameBuffers(),e._colorBuffer=r,e._colorBuffers=[r]):e=new Wr({name:"ColorGrabRT",colorBuffer:r,depth:!1,stencil:!1,autoResolve:!1}),e}releaseRenderTarget(e){e&&(e.destroyTextureBuffers(),e.destroy())}frameUpdate(){var e,t=this.device,i=this.source,s=null!=(e=null==i?void 0:i.colorBuffer.format)?e:this.device.backBufferFormat;this.shouldReallocate(this.colorRenderTarget,null==i?void 0:i.colorBuffer,s)&&(this.releaseRenderTarget(this.colorRenderTarget),this.colorRenderTarget=this.allocateRenderTarget(this.colorRenderTarget,i,t,s));var r=this.colorRenderTarget.colorBuffer;t.scope.resolve(ic).setValue(r)}execute(){var e=this.device,t=this.source,i=this.colorRenderTarget.colorBuffer;e.isWebGPU?(e.copyRenderTarget(t,this.colorRenderTarget,!0,!1),e.mipmapRenderer.generate(this.colorRenderTarget.colorBuffer.impl)):(e.copyRenderTarget(t,this.colorRenderTarget,!0,!1),e.activeTexture(e.maxCombinedTextures-1),e.bindTexture(i),e.gl.generateMipmap(i.impl._glTarget))}constructor(...e){super(...e),this.colorRenderTarget=null,this.source=null}}var rc="uSceneDepthMap";class nc extends Do{destroy(){super.destroy(),this.releaseRenderTarget(this.depthRenderTarget)}shouldReallocate(e,t){var i=(null==t?void 0:t.width)||this.device.width,s=(null==t?void 0:t.height)||this.device.height;return!e||i!==e.width||s!==e.height}allocateRenderTarget(e,t,i,s,r){var n=new ur(i,{name:rc,format:s,width:t?t.colorBuffer.width:i.width,height:t?t.colorBuffer.height:i.height,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1});return e?(e.destroyFrameBuffers(),r?e._depthBuffer=n:(e._colorBuffer=n,e._colorBuffers=[n])):e=new Wr({name:"DepthGrabRT",colorBuffer:r?null:n,depthBuffer:r?n:null,depth:!r,stencil:i.supportsStencil,autoResolve:!1}),e}releaseRenderTarget(e){e&&(e.destroyTextureBuffers(),e.destroy())}before(){var e,t,i,s,r=this.camera,n=this.device,a=null!=(i=null==r?void 0:r.renderTarget)?i:n.backBuffer,o=!0,l=a.stencil?Bi:Fi;n.isWebGPU&&(a.samples>1&&(l=Oi,o=!1));var h=null!=(s=null==(e=r.renderTarget)?void 0:e.depthBuffer)?s:null==(t=r.renderTarget)?void 0:t.colorBuffer;this.shouldReallocate(this.depthRenderTarget,h)&&(this.releaseRenderTarget(this.depthRenderTarget),this.depthRenderTarget=this.allocateRenderTarget(this.depthRenderTarget,r.renderTarget,n,l,o));var c=o?this.depthRenderTarget.depthBuffer:this.depthRenderTarget.colorBuffer;n.scope.resolve(rc).setValue(c)}execute(){var e=this.device;if(e.isWebGL2&&e.renderTarget.samples>1){var t=e.renderTarget.impl._glFrameBuffer,i=this.depthRenderTarget;e.renderTarget=i,e.updateBegin(),this.depthRenderTarget.impl.internalResolve(e,t,i.impl._glFrameBuffer,this.depthRenderTarget,e.gl.DEPTH_BUFFER_BIT)}else e.copyRenderTarget(e.renderTarget,this.depthRenderTarget,!1,!0)}constructor(e,t){super(e),this.depthRenderTarget=null,this.camera=null,this.camera=t}}class ac{get hash(){if(void 0===this._hash){var e=this.gammaCorrection+"_"+this.toneMapping+"_"+this.srgbRenderTarget+"_"+this.fog+"_"+this.ssaoEnabled+"_"+this.sceneDepthMapLinear;this._hash=Rr(e)}return this._hash}get defines(){var e=this._defines;return this._definesDirty&&(this._definesDirty=!1,e.clear(),this._sceneDepthMapLinear&&e.set("SCENE_DEPTHMAP_LINEAR",!0),e.set("FOG",this._fog.toUpperCase()),e.set("TONEMAP",zl[this._toneMapping]),e.set("GAMMA",Nl[this.shaderOutputGamma])),e}markDirty(){this._hash=void 0,this._definesDirty=!0}set fog(e){this._fog!==e&&(this._fog=e,this.markDirty())}get fog(){return this._fog}set ssaoEnabled(e){this._ssaoEnabled!==e&&(this._ssaoEnabled=e,this.markDirty())}get ssaoEnabled(){return this._ssaoEnabled}set gammaCorrection(e){this._gammaCorrectionAssigned=!0,this._gammaCorrection!==e&&(this._gammaCorrection=e,this.markDirty())}get gammaCorrection(){return this._gammaCorrection}set toneMapping(e){this._toneMapping!==e&&(this._toneMapping=e,this.markDirty())}get toneMapping(){return this._toneMapping}set srgbRenderTarget(e){this._srgbRenderTarget!==e&&(this._srgbRenderTarget=e,this.markDirty())}get srgbRenderTarget(){return this._srgbRenderTarget}set sceneDepthMapLinear(e){this._sceneDepthMapLinear!==e&&(this._sceneDepthMapLinear=e,this.markDirty())}get sceneDepthMapLinear(){return this._sceneDepthMapLinear}get shaderOutputGamma(){return 1===this._gammaCorrection&&!this._srgbRenderTarget?1:0}constructor(){this._gammaCorrection=1,this._toneMapping=0,this._srgbRenderTarget=!1,this._ssaoEnabled=!1,this._fog=ml,this._sceneDepthMapLinear=!1,this._defines=new Map,this._definesDirty=!0}}var oc=new hi,lc=new hi,hc=new hi,cc=new _i,dc=[new hi,new hi,new hi,new hi,new hi,new hi,new hi,new hi];class uc{destroy(){var e,t;null==(e=this.renderPassColorGrab)||e.destroy(),this.renderPassColorGrab=null,null==(t=this.renderPassDepthGrab)||t.destroy(),this.renderPassDepthGrab=null,this.renderPasses.length=0}_storeShaderMatrices(e,t,i,s){var r;this._shaderMatricesVersion!==s&&(this._shaderMatricesVersion=s,this._viewProjPrevious.copy(null!=(r=this._viewProjCurrent)?r:e),null!=this._viewProjCurrent||(this._viewProjCurrent=new _i),this._viewProjCurrent.copy(e),this._viewProjInverse.invert(e),this._jitters[2]=this._jitters[0],this._jitters[3]=this._jitters[1],this._jitters[0]=t,this._jitters[1]=i)}get fullSizeClearRect(){var e=this._scissorRectClear?this.scissorRect:this._rect;return 0===e.x&&0===e.y&&1===e.z&&1===e.w}set aspectRatio(e){this._aspectRatio!==e&&(this._aspectRatio=e,this._projMatDirty=!0)}get aspectRatio(){var e;return(null==(e=this.xr)?void 0:e.active)?this._xrProperties.aspectRatio:this._aspectRatio}set aspectRatioMode(e){this._aspectRatioMode!==e&&(this._aspectRatioMode=e,this._projMatDirty=!0)}get aspectRatioMode(){return this._aspectRatioMode}set calculateProjection(e){this._calculateProjection=e,this._projMatDirty=!0}get calculateProjection(){return this._calculateProjection}set calculateTransform(e){this._calculateTransform=e}get calculateTransform(){return this._calculateTransform}set clearColor(e){this._clearColor.copy(e)}get clearColor(){return this._clearColor}set clearColorBuffer(e){this._clearColorBuffer=e}get clearColorBuffer(){return this._clearColorBuffer}set clearDepth(e){this._clearDepth=e}get clearDepth(){return this._clearDepth}set clearDepthBuffer(e){this._clearDepthBuffer=e}get clearDepthBuffer(){return this._clearDepthBuffer}set clearStencil(e){this._clearStencil=e}get clearStencil(){return this._clearStencil}set clearStencilBuffer(e){this._clearStencilBuffer=e}get clearStencilBuffer(){return this._clearStencilBuffer}set cullFaces(e){this._cullFaces=e}get cullFaces(){return this._cullFaces}set farClip(e){this._farClip!==e&&(this._farClip=e,this._projMatDirty=!0)}get farClip(){var e;return(null==(e=this.xr)?void 0:e.active)?this._xrProperties.farClip:this._farClip}set flipFaces(e){this._flipFaces=e}get flipFaces(){return this._flipFaces}set fov(e){this._fov!==e&&(this._fov=e,this._projMatDirty=!0)}get fov(){var e;return(null==(e=this.xr)?void 0:e.active)?this._xrProperties.fov:this._fov}set frustumCulling(e){this._frustumCulling=e}get frustumCulling(){return this._frustumCulling}set horizontalFov(e){this._horizontalFov!==e&&(this._horizontalFov=e,this._projMatDirty=!0)}get horizontalFov(){var e;return(null==(e=this.xr)?void 0:e.active)?this._xrProperties.horizontalFov:this._horizontalFov}set layers(e){this._layers=e.slice(0),this._layersSet=new Set(this._layers)}get layers(){return this._layers}get layersSet(){return this._layersSet}set nearClip(e){this._nearClip!==e&&(this._nearClip=e,this._projMatDirty=!0)}get nearClip(){var e;return(null==(e=this.xr)?void 0:e.active)?this._xrProperties.nearClip:this._nearClip}set node(e){this._node=e}get node(){return this._node}set orthoHeight(e){this._orthoHeight!==e&&(this._orthoHeight=e,this._projMatDirty=!0)}get orthoHeight(){return this._orthoHeight}set projection(e){this._projection!==e&&(this._projection=e,this._projMatDirty=!0)}get projection(){return this._projection}get projectionMatrix(){return this._evaluateProjectionMatrix(),this._projMat}set rect(e){this._rect.copy(e)}get rect(){return this._rect}set renderTarget(e){this._renderTarget=e}get renderTarget(){return this._renderTarget}set scissorRect(e){this._scissorRect.copy(e)}get scissorRect(){return this._scissorRect}get viewMatrix(){if(this._viewMatDirty){var e=this._node.getWorldTransform();this._viewMat.copy(e).invert(),this._viewMatDirty=!1}return this._viewMat}set aperture(e){this._aperture=e}get aperture(){return this._aperture}set sensitivity(e){this._sensitivity=e}get sensitivity(){return this._sensitivity}set shutter(e){this._shutter=e}get shutter(){return this._shutter}set xr(e){this._xr!==e&&(this._xr=e,this._projMatDirty=!0)}get xr(){return this._xr}clone(){return(new uc).copy(this)}copy(e){return this._aspectRatio=e._aspectRatio,this._farClip=e._farClip,this._fov=e._fov,this._horizontalFov=e._horizontalFov,this._nearClip=e._nearClip,this._xrProperties.aspectRatio=e._xrProperties.aspectRatio,this._xrProperties.farClip=e._xrProperties.farClip,this._xrProperties.fov=e._xrProperties.fov,this._xrProperties.horizontalFov=e._xrProperties.horizontalFov,this._xrProperties.nearClip=e._xrProperties.nearClip,this.aspectRatioMode=e.aspectRatioMode,this.calculateProjection=e.calculateProjection,this.calculateTransform=e.calculateTransform,this.clearColor=e.clearColor,this.clearColorBuffer=e.clearColorBuffer,this.clearDepth=e.clearDepth,this.clearDepthBuffer=e.clearDepthBuffer,this.clearStencil=e.clearStencil,this.clearStencilBuffer=e.clearStencilBuffer,this.cullFaces=e.cullFaces,this.flipFaces=e.flipFaces,this.frustumCulling=e.frustumCulling,this.layers=e.layers,this.orthoHeight=e.orthoHeight,this.projection=e.projection,this.rect=e.rect,this.renderTarget=e.renderTarget,this.scissorRect=e.scissorRect,this.aperture=e.aperture,this.shutter=e.shutter,this.sensitivity=e.sensitivity,this.shaderPassInfo=e.shaderPassInfo,this.jitter=e.jitter,this._projMatDirty=!0,this}_enableRenderPassColorGrab(e,t){var i;t?this.renderPassColorGrab||(this.renderPassColorGrab=new sc(e)):(null==(i=this.renderPassColorGrab)||i.destroy(),this.renderPassColorGrab=null)}_enableRenderPassDepthGrab(e,t,i){var s;i?this.renderPassDepthGrab||(this.renderPassDepthGrab=new nc(e,this)):(null==(s=this.renderPassDepthGrab)||s.destroy(),this.renderPassDepthGrab=null)}_updateViewProjMat(){(this._projMatDirty||this._viewMatDirty||this._viewProjMatDirty)&&(this._viewProjMat.mul2(this.projectionMatrix,this.viewMatrix),this._viewProjMatDirty=!1)}worldToScreen(e,t,i,s){void 0===s&&(s=new hi),this._updateViewProjMat(),this._viewProjMat.transformPoint(e,s);var r=this._viewProjMat.data,n=e.x*r[3]+e.y*r[7]+e.z*r[11]+1*r[15];return s.x=.5*(s.x/n+1)*t,s.y=.5*(1-s.y/n)*i,s}screenToWorld(e,t,i,s,r,n){void 0===n&&(n=new hi);var a=this.farClip-this.nearClip;if(oc.set(e/s,(r-t)/r,i/a),oc.mulScalar(2),oc.sub(hi.ONE),0===this._projection){_i._getPerspectiveHalfSize(lc,this.fov,this.aspectRatio,this.nearClip,this.horizontalFov),lc.x*=oc.x,lc.y*=oc.y;var o=this._node.getWorldTransform();lc.z=-this.nearClip,o.transformPoint(lc,hc);var l=this._node.getPosition();n.sub2(hc,l),n.normalize(),n.mulScalar(i),n.add(l)}else this._updateViewProjMat(),cc.copy(this._viewProjMat).invert(),cc.transformPoint(oc,n);return n}_evaluateProjectionMatrix(){if(this._projMatDirty){if(0===this._projection)this._projMat.setPerspective(this.fov,this.aspectRatio,this.nearClip,this.farClip,this.horizontalFov),this._projMatSkybox.copy(this._projMat);else{var e=this._orthoHeight,t=e*this.aspectRatio;this._projMat.setOrtho(-t,t,-e,e,this.nearClip,this.farClip),this._projMatSkybox.setPerspective(this.fov,this.aspectRatio,this.nearClip,this.farClip)}this._projMatDirty=!1}}getProjectionMatrixSkybox(){return this._evaluateProjectionMatrix(),this._projMatSkybox}getExposure(){var e=Math.log2(this._aperture*this._aperture/this._shutter*100/this._sensitivity);return 1/(1.2*Math.pow(2,e))}getScreenSize(e){if(0===this._projection){var t=this._node.getPosition().distance(e.center);if(t<e.radius)return 1;var i=Math.asin(e.radius/t),s=Math.tan(i),r=Math.tan(this.fov/2*ti.DEG_TO_RAD);return Math.min(s/r,1)}return ti.clamp(e.radius/this._orthoHeight,0,1)}getFrustumCorners(e,t){void 0===e&&(e=this.nearClip),void 0===t&&(t=this.farClip);var i,s,r=this.fov*Math.PI/180;0===this.projection?this.horizontalFov?s=(i=e*Math.tan(r/2))/this.aspectRatio:i=(s=e*Math.tan(r/2))*this.aspectRatio:i=(s=this._orthoHeight)*this.aspectRatio;var n=dc;return n[0].x=i,n[0].y=-s,n[0].z=-e,n[1].x=i,n[1].y=s,n[1].z=-e,n[2].x=-i,n[2].y=s,n[2].z=-e,n[3].x=-i,n[3].y=-s,n[3].z=-e,0===this._projection&&(this.horizontalFov?s=(i=t*Math.tan(r/2))/this.aspectRatio:i=(s=t*Math.tan(r/2))*this.aspectRatio),n[4].x=i,n[4].y=-s,n[4].z=-t,n[5].x=i,n[5].y=s,n[5].z=-t,n[6].x=-i,n[6].y=s,n[6].z=-t,n[7].x=-i,n[7].y=-s,n[7].z=-t,n}setXrProperties(e){Object.assign(this._xrProperties,e),this._projMatDirty=!0}constructor(){this.shaderPassInfo=null,this.renderPassColorGrab=null,this.renderPassDepthGrab=null,this.fogParams=null,this.shaderParams=new ac,this.renderPasses=[],this.jitter=0,this._aspectRatio=16/9,this._aspectRatioMode=0,this._calculateProjection=null,this._calculateTransform=null,this._clearColor=new ii(.75,.75,.75,1),this._clearColorBuffer=!0,this._clearDepth=1,this._clearDepthBuffer=!0,this._clearStencil=0,this._clearStencilBuffer=!0,this._cullFaces=!0,this._farClip=1e3,this._flipFaces=!1,this._fov=45,this._frustumCulling=!0,this._horizontalFov=!1,this._layers=[0,1,2,4,3],this._layersSet=new Set(this._layers),this._nearClip=.1,this._node=null,this._orthoHeight=10,this._projection=0,this._rect=new ui(0,0,1,1),this._renderTarget=null,this._scissorRect=new ui(0,0,1,1),this._scissorRectClear=!1,this._aperture=16,this._shutter=.001,this._sensitivity=1e3,this._projMat=new _i,this._projMatDirty=!0,this._projMatSkybox=new _i,this._viewMat=new _i,this._viewMatDirty=!0,this._viewProjMat=new _i,this._viewProjMatDirty=!0,this._shaderMatricesVersion=0,this._viewProjInverse=new _i,this._viewProjCurrent=null,this._viewProjPrevious=new _i,this._jitters=[0,0,0,0],this.frustum=new Li,this._xr=null,this._xrProperties={horizontalFov:this._horizontalFov,fov:this._fov,aspectRatio:this._aspectRatio,farClip:this._farClip,nearClip:this._nearClip}}}var fc=new _i,pc=new hi,mc=new bi,gc=new bi,vc=new hi,_c=new hi,bc=new _i,yc=new bi,xc=new hi,Sc=new _i,wc=new bi,Tc=new bi,Cc=new _i,Ec=new hi,Ac=new hi;function Pc(e,t){return e instanceof Function?e:i=>{var s=i[e];return s instanceof Function&&(s=s()),s===t}}function Dc(e,t){if(t(e))return e;for(var i=e._children,s=i.length,r=0;r<s;++r){var n=Dc(i[r],t);if(n)return n}return null}class Lc extends Ht{get right(){return this._right||(this._right=new hi),this.getWorldTransform().getX(this._right).normalize()}get up(){return this._up||(this._up=new hi),this.getWorldTransform().getY(this._up).normalize()}get forward(){return this._forward||(this._forward=new hi),this.getWorldTransform().getZ(this._forward).normalize().mulScalar(-1)}get normalMatrix(){var e=this._normalMatrix;return this._dirtyNormal&&(e.invertMat4(this.getWorldTransform()).transpose(),this._dirtyNormal=!1),e}set enabled(e){var t;this._enabled!==e&&(this._enabled=e,(e&&(null==(t=this._parent)?void 0:t.enabled)||!e)&&this._notifyHierarchyStateChanged(this,e))}get enabled(){return this._enabled&&this._enabledInHierarchy}get parent(){return this._parent}get path(){var e=this._parent;if(!e)return"";for(var t=this.name;e&&e._parent;)t=e.name+"/"+t,e=e._parent;return t}get root(){for(var e=this;e._parent;)e=e._parent;return e}get children(){return this._children}get graphDepth(){return this._graphDepth}_notifyHierarchyStateChanged(e,t){e._onHierarchyStateChanged(t);for(var i=e._children,s=0,r=i.length;s<r;s++)i[s]._enabled&&this._notifyHierarchyStateChanged(i[s],t)}_onHierarchyStateChanged(e){this._enabledInHierarchy=e,e&&!this._frozen&&this._unfreezeParentToRoot()}_cloneInternal(e){e.name=this.name;var t=this.tags._list;e.tags.clear();for(var i=0;i<t.length;i++)e.tags.add(t[i]);e.localPosition.copy(this.localPosition),e.localRotation.copy(this.localRotation),e.localScale.copy(this.localScale),e.localEulerAngles.copy(this.localEulerAngles),e.position.copy(this.position),e.rotation.copy(this.rotation),e.eulerAngles.copy(this.eulerAngles),e.localTransform.copy(this.localTransform),e._dirtyLocal=this._dirtyLocal,e.worldTransform.copy(this.worldTransform),e._dirtyWorld=this._dirtyWorld,e._dirtyNormal=this._dirtyNormal,e._aabbVer=this._aabbVer+1,e._enabled=this._enabled,e.scaleCompensation=this.scaleCompensation,e._enabledInHierarchy=!1}clone(){var e=new this.constructor;return this._cloneInternal(e),e}copy(e){return e._cloneInternal(this),this}destroy(){this.remove();for(var e=this._children;e.length;){var t=e.pop();t._parent=null,t.destroy()}this.fire("destroy",this),this.off()}find(e,t){var i=[],s=Pc(e,t);return this.forEach((e=>{s(e)&&i.push(e)})),i}findOne(e,t){return Dc(this,Pc(e,t))}findByTag(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var s=[],r=(e,i)=>{i&&e.tags.has(...t)&&s.push(e);for(var n=0;n<e._children.length;n++)r(e._children[n],!0)};return r(this,!1),s}findByName(e){return this.findOne("name",e)}findByPath(e){for(var t,i=function(e,t){if(r=r.children.find((t=>t.name===s[e])),!r)return{v:null}},s=Array.isArray(e)?e:e.split("/"),r=this,n=0,a=s.length;n<a;++n){var o=i(n);if("object"==((t=o)&&"undefined"!=typeof Symbol&&t.constructor===Symbol?"symbol":typeof t))return o.v}return r}forEach(e,t){e.call(t,this);for(var i=this._children,s=i.length,r=0;r<s;++r)i[r].forEach(e,t)}isDescendantOf(e){for(var t=this._parent;t;){if(t===e)return!0;t=t._parent}return!1}isAncestorOf(e){return e.isDescendantOf(this)}getEulerAngles(){return this.getWorldTransform().getEulerAngles(this.eulerAngles),this.eulerAngles}getLocalEulerAngles(){return this.localRotation.getEulerAngles(this.localEulerAngles),this.localEulerAngles}getLocalPosition(){return this.localPosition}getLocalRotation(){return this.localRotation}getLocalScale(){return this.localScale}getLocalTransform(){return this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this.localTransform}getPosition(){return this.getWorldTransform().getTranslation(this.position),this.position}getRotation(){return this.rotation.setFromMat4(this.getWorldTransform()),this.rotation}getScale(){return this._scale||(this._scale=new hi),this.getWorldTransform().getScale(this._scale)}getWorldTransform(){return this._dirtyLocal||this._dirtyWorld?(this._parent&&this._parent.getWorldTransform(),this._sync(),this.worldTransform):this.worldTransform}get worldScaleSign(){return 0===this._worldScaleSign&&(this._worldScaleSign=this.getWorldTransform().scaleSign),this._worldScaleSign}remove(){var e;null==(e=this._parent)||e.removeChild(this)}reparent(e,t){this.remove(),e&&(t>=0?e.insertChild(this,t):e.addChild(this))}setLocalEulerAngles(e,t,i){this.localRotation.setFromEulerAngles(e,t,i),this._dirtyLocal||this._dirtifyLocal()}setLocalPosition(e,t,i){e instanceof hi?this.localPosition.copy(e):this.localPosition.set(e,t,i),this._dirtyLocal||this._dirtifyLocal()}setLocalRotation(e,t,i,s){e instanceof bi?this.localRotation.copy(e):this.localRotation.set(e,t,i,s),this._dirtyLocal||this._dirtifyLocal()}setLocalScale(e,t,i){e instanceof hi?this.localScale.copy(e):this.localScale.set(e,t,i),this._dirtyLocal||this._dirtifyLocal()}_dirtifyLocal(){this._dirtyLocal||(this._dirtyLocal=!0,this._dirtyWorld||this._dirtifyWorld())}_unfreezeParentToRoot(){for(var e=this._parent;e;)e._frozen=!1,e=e._parent}_dirtifyWorld(){this._dirtyWorld||this._unfreezeParentToRoot(),this._dirtifyWorldInternal()}_dirtifyWorldInternal(){if(!this._dirtyWorld){this._frozen=!1,this._dirtyWorld=!0;for(var e=0;e<this._children.length;e++)this._children[e]._dirtyWorld||this._children[e]._dirtifyWorldInternal()}this._dirtyNormal=!0,this._worldScaleSign=0,this._aabbVer++}setPosition(e,t,i){e instanceof hi?xc.copy(e):xc.set(e,t,i),null===this._parent?this.localPosition.copy(xc):(Sc.copy(this._parent.getWorldTransform()).invert(),Sc.transformPoint(xc,this.localPosition)),this._dirtyLocal||this._dirtifyLocal()}setRotation(e,t,i,s){if(e instanceof bi?wc.copy(e):wc.set(e,t,i,s),null===this._parent)this.localRotation.copy(wc);else{var r=this._parent.getRotation();Tc.copy(r).invert(),this.localRotation.copy(Tc).mul(wc)}this._dirtyLocal||this._dirtifyLocal()}setPositionAndRotation(e,t){if(null===this._parent)this.localPosition.copy(e),this.localRotation.copy(t);else{var i=this._parent.getWorldTransform();Sc.copy(i).invert(),Sc.transformPoint(e,this.localPosition),this.localRotation.setFromMat4(Sc).mul(t)}this._dirtyLocal||this._dirtifyLocal()}setEulerAngles(e,t,i){if(this.localRotation.setFromEulerAngles(e,t,i),null!==this._parent){var s=this._parent.getRotation();Tc.copy(s).invert(),this.localRotation.mul2(Tc,this.localRotation)}this._dirtyLocal||this._dirtifyLocal()}addChild(e){this._prepareInsertChild(e),this._children.push(e),this._onInsertChild(e)}addChildAndSaveTransform(e){var t=e.getPosition(),i=e.getRotation();this._prepareInsertChild(e),e.setPosition(bc.copy(this.worldTransform).invert().transformPoint(t)),e.setRotation(yc.copy(this.getRotation()).invert().mul(i)),this._children.push(e),this._onInsertChild(e)}insertChild(e,t){this._prepareInsertChild(e),this._children.splice(t,0,e),this._onInsertChild(e)}_prepareInsertChild(e){e.remove()}_fireOnHierarchy(e,t,i){this.fire(e,i);for(var s=0;s<this._children.length;s++)this._children[s]._fireOnHierarchy(t,t,i)}_onInsertChild(e){e._parent=this;var t=e._enabled&&this.enabled;e._enabledInHierarchy!==t&&(e._enabledInHierarchy=t,e._notifyHierarchyStateChanged(e,t)),e._updateGraphDepth(),e._dirtifyWorld(),this._frozen&&e._unfreezeParentToRoot(),e._fireOnHierarchy("insert","inserthierarchy",this),this.fire&&this.fire("childinsert",e)}_updateGraphDepth(){this._graphDepth=this._parent?this._parent._graphDepth+1:0;for(var e=0,t=this._children.length;e<t;e++)this._children[e]._updateGraphDepth()}removeChild(e){var t=this._children.indexOf(e);-1!==t&&(this._children.splice(t,1),e._parent=null,e._fireOnHierarchy("remove","removehierarchy",this),this.fire("childremove",e))}_sync(){if(this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this._dirtyWorld){if(null===this._parent)this.worldTransform.copy(this.localTransform);else if(this.scaleCompensation){var e,t=this._parent,i=this.localScale,s=t;if(s){for(;s&&s.scaleCompensation;)s=s._parent;s&&(s=s._parent)&&(e=s.worldTransform.getScale(),vc.mul2(e,this.localScale),i=vc)}gc.setFromMat4(t.worldTransform),mc.mul2(gc,this.localRotation);var r=t.worldTransform;t.scaleCompensation&&(_c.mul2(e,t.getLocalScale()),fc.setTRS(t.worldTransform.getTranslation(pc),gc,_c),r=fc),r.transformPoint(this.localPosition,pc),this.worldTransform.setTRS(pc,mc,i)}else this.worldTransform.mulAffine2(this._parent.worldTransform,this.localTransform);this._dirtyWorld=!1}}syncHierarchy(){if(this._enabled&&!this._frozen){this._frozen=!0,(this._dirtyLocal||this._dirtyWorld)&&this._sync();for(var e=this._children,t=0,i=e.length;t<i;t++)e[t].syncHierarchy()}}lookAt(e,t,i,s,r,n){if(void 0===s&&(s=0),void 0===r&&(r=1),void 0===n&&(n=0),e instanceof hi)Ec.copy(e),t instanceof hi?Ac.copy(t):Ac.copy(hi.UP);else{if(void 0===i)return;Ec.set(e,t,i),Ac.set(s,r,n)}Cc.setLookAt(this.getPosition(),Ec,Ac),wc.setFromMat4(Cc),this.setRotation(wc)}translate(e,t,i){e instanceof hi?xc.copy(e):xc.set(e,t,i),xc.add(this.getPosition()),this.setPosition(xc)}translateLocal(e,t,i){e instanceof hi?xc.copy(e):xc.set(e,t,i),this.localRotation.transformVector(xc,xc),this.localPosition.add(xc),this._dirtyLocal||this._dirtifyLocal()}rotate(e,t,i){if(wc.setFromEulerAngles(e,t,i),null===this._parent)this.localRotation.mul2(wc,this.localRotation);else{var s=this.getRotation(),r=this._parent.getRotation();Tc.copy(r).invert(),wc.mul2(Tc,wc),this.localRotation.mul2(wc,s)}this._dirtyLocal||this._dirtifyLocal()}rotateLocal(e,t,i){wc.setFromEulerAngles(e,t,i),this.localRotation.mul(wc),this._dirtyLocal||this._dirtifyLocal()}constructor(e="Untitled"){super(),this.tags=new Qt(this),this.localPosition=new hi,this.localRotation=new bi,this.localScale=new hi(1,1,1),this.localEulerAngles=new hi,this.position=new hi,this.rotation=new bi,this.eulerAngles=new hi,this._scale=null,this.localTransform=new _i,this._dirtyLocal=!1,this._aabbVer=0,this._frozen=!1,this.worldTransform=new _i,this._dirtyWorld=!1,this._worldScaleSign=0,this._normalMatrix=new ci,this._dirtyNormal=!0,this._right=null,this._up=null,this._forward=null,this._parent=null,this._children=[],this._graphDepth=0,this._enabled=!0,this._enabledInHierarchy=!1,this.scaleCompensation=!1,this.name=e}}var Mc=new _i,Ic=new _i,Rc=new _i;class kc{static create(e,t,i){var s=new uc;switch(s.node=new Lc(e),s.aspectRatio=1,s.aspectRatioMode=1,s._scissorRectClear=!0,t){case 1:s.node.setRotation(kc.pointLightRotations[i]),s.fov=90,s.projection=0;break;case 2:s.projection=0;break;case 0:s.projection=1}return s}static evalSpotCookieMatrix(e){var t=kc._spotCookieCamera;t||(t=kc.create("SpotCookieCamera",2),kc._spotCookieCamera=t),t.fov=2*e._outerConeAngle;var i=t._node;i.setPosition(e._node.getPosition()),i.setRotation(e._node.getRotation()),i.rotateLocal(-90,0,0),Mc.setTRS(i.getPosition(),i.getRotation(),hi.ONE).invert(),Ic.mul2(t.projectionMatrix,Mc);var s=e.cookieMatrix,r=e.atlasViewport;return Rc.setViewport(r.x,r.y,r.z,r.w),s.mul2(Rc,Ic),s}}kc.pointLightRotations=[(new bi).setFromEulerAngles(0,90,180),(new bi).setFromEulerAngles(0,-90,180),(new bi).setFromEulerAngles(90,0,0),(new bi).setFromEulerAngles(-90,0,0),(new bi).setFromEulerAngles(0,180,180),(new bi).setFromEulerAngles(0,0,180)],kc._spotCookieCamera=null;var Oc={ambientPS:'\n\n#if LIT_AMBIENT_SOURCE == AMBIENTSH\n#endif\n\n#if LIT_AMBIENT_SOURCE == ENVALATLAS\n    #include "envAtlasPS"\n\n    #ifndef ENV_ATLAS\n        #define ENV_ATLAS\n        var texture_envAtlas: texture_2d<f32>;\n        var texture_envAtlasSampler: sampler;\n    #endif\n#endif\n\nfn addAmbient(worldNormal: vec3f) {\n    #ifdef LIT_AMBIENT_SOURCE == AMBIENTSH\n\n        let n: vec3f = cubeMapRotate(worldNormal);\n        let color: vec3f =\n            uniform.ambientSH[0] +\n            uniform.ambientSH[1] * n.x +\n            uniform.ambientSH[2] * n.y +\n            uniform.ambientSH[3] * n.z +\n            uniform.ambientSH[4] * n.x * n.z +\n            uniform.ambientSH[5] * n.z * n.y +\n            uniform.ambientSH[6] * n.y * n.x +\n            uniform.ambientSH[7] * (3.0 * n.z * n.z - 1.0) +\n            uniform.ambientSH[8] * (n.x * n.x - n.y * n.y);\n\n        dDiffuseLight += processEnvironment(max(color, vec3f(0.0)));\n\n    #endif\n\n    #if LIT_AMBIENT_SOURCE == ENVALATLAS\n\n        let dir: vec3f = normalize(cubeMapRotate(worldNormal) * vec3f(-1.0, 1.0, 1.0));\n        let uv: vec2f = mapUv(toSphericalUv(dir), vec4f(128.0, 256.0 + 128.0, 64.0, 32.0) / atlasSize);\n\n        let raw: vec4f = textureSample(texture_envAtlas, texture_envAtlasSampler, uv);\n        let linear: vec3f = {ambientDecode}(raw);\n        dDiffuseLight += processEnvironment(linear);\n\n    #endif\n\n    #if LIT_AMBIENT_SOURCE == CONSTANT\n\n        dDiffuseLight += uniform.light_globalAmbient;\n\n    #endif\n}\n',basePS:"\nuniform view_position: vec3f;\n\nuniform light_globalAmbient: vec3f;\n\nfn square(x: f32) -> f32 {\n    return x*x;\n}\n\nfn saturate(x: f32) -> f32 {\n    return clamp(x, 0.0, 1.0);\n}\n\nfn saturate3(x: vec3f) -> vec3f {\n    return clamp(x, vec3f(0.0), vec3f(1.0));\n}\n",combinePS:"\nfn combineColor(albedo: vec3f, sheenSpecularity: vec3f, clearcoatSpecularity: f32) -> vec3f {\n    var ret: vec3f = vec3f(0.0);\n\n    #ifdef LIT_OLD_AMBIENT\n        ret += (dDiffuseLight - uniform.light_globalAmbient) * albedo + uniform.material_ambient * uniform.light_globalAmbient;\n    #else\n        ret += albedo * dDiffuseLight;\n    #endif // LIT_OLD_AMBIENT\n    #ifdef LIT_SPECULAR\n        ret += dSpecularLight;\n    #endif // LIT_SPECULAR\n    #ifdef LIT_REFLECTIONS\n        ret += dReflection.rgb * dReflection.a;\n    #endif // LIT_REFLECTIONS\n\n    #ifdef LIT_SHEEN\n        let sheenScaling: f32 = 1.0 - max(max(sheenSpecularity.r, sheenSpecularity.g), sheenSpecularity.b) * 0.157;\n        ret = ret * sheenScaling + (sSpecularLight + sReflection.rgb) * sheenSpecularity;\n    #endif // LIT_SHEEN\n    #ifdef LIT_CLEARCOAT\n        let clearCoatScaling: f32 = 1.0 - ccFresnel * clearcoatSpecularity;\n        ret = ret * clearCoatScaling + (ccSpecularLight + ccReflection.rgb) * clearcoatSpecularity;\n    #endif // LIT_CLEARCOAT\n\n    return ret;\n}\n",cookieBlit2DPS:"\n    varying uv0: vec2f;\n\n    var blitTexture: texture_2d<f32>;\n    var blitTextureSampler : sampler;\n\n    @fragment\n    fn fragmentMain(input : FragmentInput) -> FragmentOutput {\n        var output: FragmentOutput;\n        output.color = textureSample(blitTexture, blitTextureSampler, input.uv0);\n        return output;\n    }\n",cookieBlitCubePS:"\n    varying uv0: vec2f;\n    uniform invViewProj: mat4x4<f32>;\n    var blitTexture: texture_cube<f32>;\n    var blitTextureSampler : sampler;\n\n    @fragment\n    fn fragmentMain(input : FragmentInput) -> FragmentOutput {\n        var output: FragmentOutput;\n        var projPos = vec4f(input.uv0 * 2.0 - 1.0, 0.5, 1.0);\n        var worldPos = uniform.invViewProj * projPos;\n        output.color = textureSample(blitTexture, blitTextureSampler, worldPos.xyz);\n        return output;\n    }\n",cookieBlitVS:"\n    attribute vertex_position: vec2f;\n    varying uv0: vec2f;\n\n    @vertex\n    fn vertexMain(input: VertexInput) -> VertexOutput {\n        var output: VertexOutput;\n        output.position = vec4f(input.vertex_position, 0.5, 1.0);\n        output.uv0 = input.vertex_position * 0.5 + vec2f(0.5, 0.5);\n        output.uv0.y = 1.0 - output.uv0.y;\n        return output;\n    }\n",debugOutputPS:"\n#ifdef DEBUG_ALBEDO_PASS\noutput.color = vec4(gammaCorrectOutput(dAlbedo), 1.0);\n#endif\n\n#ifdef DEBUG_UV0_PASS\noutput.color = vec4f(litArgs_albedo , 1.0);\n#endif\n\n#ifdef DEBUG_WORLD_NORMAL_PASS\noutput.color = vec4f(litArgs_worldNormal * 0.5 + 0.5, 1.0);\n#endif\n\n#ifdef DEBUG_OPACITY_PASS\noutput.color = vec4f(vec3f(litArgs_opacity) , 1.0);\n#endif\n\n#ifdef DEBUG_SPECULARITY_PASS\noutput.color = vec4f(litArgs_specularity, 1.0);\n#endif\n\n#ifdef DEBUG_GLOSS_PASS\noutput.color = vec4f(vec3f(litArgs_gloss) , 1.0);\n#endif\n\n#ifdef DEBUG_METALNESS_PASS\noutput.color = vec4f(vec3f(litArgs_metalness) , 1.0);\n#endif\n\n#ifdef DEBUG_AO_PASS\noutput.color = vec4f(vec3f(litArgs_ao) , 1.0);\n#endif\n\n#ifdef DEBUG_EMISSION_PASS\noutput.color = vec4f(gammaCorrectOutput(litArgs_emission), 1.0);\n#endif\n",debugProcessFrontendPS:"\n#ifdef DEBUG_LIGHTING_PASS\n    litArgs_albedo = vec3f(0.5);\n#endif\n\n#ifdef DEBUG_UV0_PASS\n#ifdef VARYING_VUV0\n    litArgs_albedo = vec3f(vUv0, 0.0);\n#else\n    litArgs_albedo = vec3f(0.0);\n#endif\n#endif\n",decodePS:"\n\n#ifndef _DECODE_INCLUDED_\n#define _DECODE_INCLUDED_\n\nfn decodeLinear(raw: vec4f) -> vec3f {\n    return raw.rgb;\n}\n\nfn decodeGammaFloat(raw: f32) -> f32 {\n    return pow(raw, 2.2);\n}\n\nfn decodeGamma3(raw: vec3f) -> vec3f {\n    return pow(raw, vec3f(2.2));\n}\n\nfn decodeGamma(raw: vec4f) -> vec3f {\n    return pow(raw.xyz, vec3f(2.2));\n}\n\nfn decodeRGBM(raw: vec4f) -> vec3f {\n    let color = (8.0 * raw.a) * raw.rgb;\n    return color * color;\n}\n\nfn decodeRGBP(raw: vec4f) -> vec3f {\n    let color = raw.rgb * (-raw.a * 7.0 + 8.0);\n    return color * color;\n}\n\nfn decodeRGBE(raw: vec4f) -> vec3f {\n    return select(vec3f(0.0), raw.xyz * pow(2.0, raw.w * 255.0 - 128.0), raw.a != 0.0);\n}\n\nfn passThrough(raw: vec4f) -> vec4f {\n    return raw;\n}\n\nfn unpackNormalXYZ(nmap: vec4f) -> vec3f {\n    return nmap.xyz * 2.0 - 1.0;\n}\n\nfn unpackNormalXY(nmap: vec4f) -> vec3f {\n    var xy = nmap.wy * 2.0 - 1.0;\n    return vec3f(xy, sqrt(1.0 - clamp(dot(xy, xy), 0.0, 1.0)));\n}\n\n#endif\n",encodePS:"\nfn encodeLinear(source: vec3f) -> vec4f {\n    return vec4f(source, 1.0);\n}\n\nfn encodeGamma(source: vec3f) -> vec4f {\n    return vec4f(pow(source + vec3f(0.0000001), vec3f(1.0 / 2.2)), 1.0);\n}\n\nfn encodeRGBM(source: vec3f) -> vec4f {\n    var color: vec3f = pow(source, vec3f(0.5));\n    color *= 1.0 / 8.0;\n\n    var a: f32 = saturate(max(max(color.r, color.g), max(color.b, 1.0 / 255.0)));\n    a = ceil(a * 255.0) / 255.0;\n\n    color /= a;\n    return vec4f(color, a);\n}\n\nfn encodeRGBP(source: vec3f) -> vec4f {\n    // convert incoming linear to gamma(ish)\n    var gamma: vec3f = pow(source, vec3f(0.5));\n\n    // calculate the maximum component clamped to 1..8\n    var maxVal: f32 = min(8.0, max(1.0, max(gamma.x, max(gamma.y, gamma.z))));\n\n    // calculate storage factor\n    var v: f32 = 1.0 - ((maxVal - 1.0) / 7.0);\n\n    // round the value for storage in 8bit channel\n    v = ceil(v * 255.0) / 255.0;\n\n    return vec4f(gamma / (-v * 7.0 + 8.0), v);\n}\n\nfn encodeRGBE(source: vec3f) -> vec4f {\n    var maxVal: f32 = max(source.x, max(source.y, source.z));\n    if (maxVal < 1e-32) {\n        return vec4f(0.0, 0.0, 0.0, 0.0);\n    } else {\n        var e: f32 = ceil(log2(maxVal));\n        return vec4f(source / pow(2.0, e), (e + 128.0) / 255.0);\n    }\n}\n",endPS:"\n    var finalRgb: vec3f = combineColor(litArgs_albedo, litArgs_sheen_specularity, litArgs_clearcoat_specularity);\n\n    finalRgb = finalRgb + litArgs_emission;\n    finalRgb = addFog(finalRgb);\n    finalRgb = toneMap(finalRgb);\n    finalRgb = gammaCorrectOutput(finalRgb);\n    output.color = vec4f(finalRgb, output.color.a);\n",envAtlasPS:"\n// the envAtlas is fixed at 512 pixels. every equirect is generated with 1 pixel boundary.\nconst atlasSize : f32 = 512.0;\nconst seamSize : f32 = 1.0 / atlasSize;\n\n// map a normalized equirect UV to the given rectangle (taking 1 pixel seam into account).\nfn mapUv(uv : vec2f, rect : vec4f) -> vec2f {\n    return vec2f(mix(rect.x + seamSize, rect.x + rect.z - seamSize, uv.x),\n                 mix(rect.y + seamSize, rect.y + rect.w - seamSize, uv.y));\n}\n\n// map a normalized equirect UV and roughness level to the correct atlas rect.\nfn mapRoughnessUv(uv : vec2f, level : f32) -> vec2f {\n    let t : f32 = 1.0 / exp2(level);\n    return mapUv(uv, vec4f(0.0, 1.0 - t, t, t * 0.5));\n}\n\n// map shiny level UV\nfn mapShinyUv(uv : vec2f, level : f32) -> vec2f {\n    let t : f32 = 1.0 / exp2(level);\n    return mapUv(uv, vec4f(1.0 - t, 1.0 - t, t, t * 0.5));\n}\n",envProcPS:"\n#ifdef LIT_SKYBOX_INTENSITY\n    uniform skyboxIntensity : f32;\n#endif\n\nfn processEnvironment(color : vec3f) -> vec3f {\n    #ifdef LIT_SKYBOX_INTENSITY\n        return color * uniform.skyboxIntensity;\n    #else\n        return color;\n    #endif\n}\n",fogPS:"\n\nvar<private> dBlendModeFogFactor : f32 = 1.0;\n\n#if (FOG != NONE)\n    uniform fog_color : vec3f;\n    \n    #if (FOG == LINEAR)\n        uniform fog_start : f32;\n        uniform fog_end : f32;\n    #else\n        uniform fog_density : f32;\n    #endif\n#endif\n\nfn getFogFactor() -> f32 {\n\n    let depth = pcPosition.z / pcPosition.w;\n\n    var fogFactor : f32 = 0.0;\n\n    #if (FOG == LINEAR)\n        fogFactor = (uniform.fog_end - depth) / (uniform.fog_end - uniform.fog_start);\n    #elif (FOG == EXP)\n        fogFactor = exp(-depth * uniform.fog_density);\n    #elif (FOG == EXP2)\n        fogFactor = exp(-depth * depth * uniform.fog_density * uniform.fog_density);\n    #endif\n\n    return clamp(fogFactor, 0.0, 1.0);\n}\n\nfn addFog(color : vec3f) -> vec3f {\n    #if (FOG != NONE)\n        return mix(uniform.fog_color * dBlendModeFogFactor, color, getFogFactor());\n    #else\n        return color;\n    #endif\n}\n",gammaPS:'\n\n#include "decodePS"\n\n#if (GAMMA == SRGB)\n\n    fn gammaCorrectInput(color: f32) -> f32 {\n        return decodeGammaFloat(color);\n    }\n\n    fn gammaCorrectInputVec3(color: vec3f) -> vec3f {\n        return decodeGamma3(color);\n    }\n\n    fn gammaCorrectInputVec4(color: vec4f) -> vec4f {\n        return vec4f(decodeGamma3(color.xyz), color.w);\n    }\n\n    fn gammaCorrectOutput(color: vec3f) -> vec3f {\n        return pow(color + 0.0000001, vec3f(1.0 / 2.2));\n    }\n\n#else // NONE\n\n    fn gammaCorrectInput(color: f32) -> f32 {\n        return color;\n    }\n\n    fn gammaCorrectInputVec3(color: vec3f) -> vec3f {\n        return color;\n    }\n\n    fn gammaCorrectInputVec4(color: vec4f) -> vec4f {\n        return color;\n    }\n\n    fn gammaCorrectOutput(color: vec3f) -> vec3f {\n        return color;\n    }\n\n#endif\n',immediateLinePS:'\n    #include "gammaPS"\n    varying color: vec4f;\n    @fragment\n    fn fragmentMain(input : FragmentInput) -> FragmentOutput {\n        var output: FragmentOutput;\n        output.color = vec4f(gammaCorrectOutput(decodeGamma3(input.color.rgb)), input.color.a);\n        return output;\n    }\n',immediateLineVS:"\n    attribute vertex_position: vec4f;\n    attribute vertex_color: vec4f;\n    uniform matrix_model: mat4x4f;\n    uniform matrix_viewProjection: mat4x4f;\n    varying color: vec4f;\n    @vertex\n    fn vertexMain(input : VertexInput) -> VertexOutput {\n        var output : VertexOutput;\n        output.color = input.vertex_color;\n        output.position = uniform.matrix_viewProjection * uniform.matrix_model * input.vertex_position;\n        return output;\n    }\n",lightBufferDefinesPS:"",lightingPS:'\n\n#ifdef LIT_CLUSTERED_LIGHTS\n    // all this functionality that needs to be included for clustered lighting\n    #define LIT_CODE_FALLOFF_LINEAR\n    #define LIT_CODE_FALLOFF_SQUARED\n    #define LIT_CODE_LIGHTS_POINT\n    #define LIT_CODE_LIGHTS_SPOT\n#endif\n\n#ifdef AREA_LIGHTS\n    var areaLightsLutTex1: texture_2d<f32>;\n    var areaLightsLutTex1Sampler: sampler;\n    var areaLightsLutTex2: texture_2d<f32>;\n    var areaLightsLutTex2Sampler: sampler;\n#endif\n\n#ifdef LIT_LIGHTING\n    #include "lightDiffuseLambertPS"\n\n    // area lights\n    #if defined(AREA_LIGHTS) || defined(LIT_CLUSTERED_AREA_LIGHTS)\n        #include "ltcPS"\n    #endif\n#endif\n\n#ifdef SHADOW_DIRECTIONAL\n    #include "shadowCascadesPS"\n#endif\n\n#if defined(SHADOW_KIND_PCF1)\n    #include "shadowPCF1PS"\n#endif\n\n#if defined(SHADOW_KIND_PCF3)\n    #include "shadowPCF3PS"\n#endif\n\n#if defined(SHADOW_KIND_PCF5)\n    #include "shadowPCF5PS"\n#endif\n\n#if defined(SHADOW_KIND_PCSS)\n    #include "linearizeDepthPS"\n    #include "shadowPCSSPS"\n    #include "shadowSoftPS"\n#endif\n\n#if defined(SHADOW_KIND_VSM)\n    #include "shadowEVSMPS"\n#endif\n\n#ifdef LIT_CODE_FALLOFF_LINEAR\n    #include "falloffLinearPS"\n#endif\n\n#ifdef LIT_CODE_FALLOFF_SQUARED\n    #include "falloffInvSquaredPS"\n#endif\n\n#ifdef LIT_CODE_LIGHTS_POINT\n    #include "lightDirPointPS"\n#endif\n\n#ifdef LIT_CODE_LIGHTS_SPOT\n    #include "spotPS"\n#endif\n\n#ifdef LIT_CODE_COOKIE\n    #include "cookiePS"\n#endif\n\n// clustered lighting\n#ifdef LIT_CLUSTERED_LIGHTS\n    #include "clusteredLightPS"\n#endif\n\n#ifdef LIGHT_COUNT > 0\n    // LOOP - generate shadow evaluation functions for all non-clustered lights\n    #include "lightFunctionShadowPS, LIGHT_COUNT"\n\n    // LOOP - generate light evaluation functions for all non-clustered lights\n    #include "lightFunctionLightPS, LIGHT_COUNT"\n#endif\n',litForwardBackendPS:'\nfn evaluateBackend() -> FragmentOutput {\n\n    var output: FragmentOutput;\n\n    // apply SSAO during lighting\n    #ifdef LIT_SSAO\n        litArgs_ao = litArgs_ao * textureSampleLevel(ssaoTexture, ssaoTextureSampler, pcPosition.xy * ssaoTextureSizeInv, 0.0).r;\n    #endif\n\n    // transform tangent space normals to world space\n    #ifdef LIT_NEEDS_NORMAL\n        #ifdef LIT_SPECULAR\n            getReflDir(litArgs_worldNormal, dViewDirW, litArgs_gloss, dTBN);\n        #endif\n\n        #ifdef LIT_CLEARCOAT\n            ccReflDirW = normalize(-reflect(dViewDirW, litArgs_clearcoat_worldNormal));\n        #endif\n    #endif\n\n    #ifdef LIT_SPECULAR_OR_REFLECTION\n        #ifdef LIT_METALNESS\n            var f0: f32 = 1.0 / litArgs_ior;\n            f0 = (f0 - 1.0) / (f0 + 1.0);\n            f0 = f0 * f0;\n            litArgs_specularity = getSpecularModulate(litArgs_specularity, litArgs_albedo, litArgs_metalness, f0);\n            litArgs_albedo = getAlbedoModulate(litArgs_albedo, litArgs_metalness);\n        #endif\n\n        #ifdef LIT_IRIDESCENCE\n            var iridescenceFresnel: vec3f = getIridescence(saturate3(dot(dViewDirW, litArgs_worldNormal)), litArgs_specularity, litArgs_iridescence_thickness);\n        #endif\n    #endif\n\n    // ambient\n    #ifdef LIT_ADD_AMBIENT\n        addAmbient(litArgs_worldNormal);\n\n        #ifdef LIT_SPECULAR\n            dDiffuseLight = dDiffuseLight * (1.0 - litArgs_specularity);\n        #endif\n\n        // move ambient color out of diffuse (used by Lightmapper, to multiply ambient color by accumulated AO)\n        #ifdef LIT_SEPARATE_AMBIENT\n            var dAmbientLight: vec3f = dDiffuseLight;\n            dDiffuseLight = vec3(0.0);\n        #endif\n    #endif\n\n    #ifndef LIT_OLD_AMBIENT\n        dDiffuseLight = dDiffuseLight * uniform.material_ambient;\n    #endif\n\n    #ifdef LIT_AO\n        #ifndef LIT_OCCLUDE_DIRECT\n            occludeDiffuse(litArgs_ao);\n        #endif\n    #endif\n\n    #ifdef LIT_LIGHTMAP\n        addLightMap(\n            litArgs_lightmap, \n            litArgs_lightmapDir, \n            litArgs_worldNormal, \n            dViewDirW, \n            dReflDirW, \n            litArgs_gloss, \n            litArgs_specularity, \n            dVertexNormalW,\n            dTBN\n        #if defined(LIT_IRIDESCENCE)\n            , iridescenceFresnel,\n            litArgs_iridescence_intensity\n        #endif\n        );\n    #endif\n\n    #ifdef LIT_LIGHTING || LIT_REFLECTIONS\n\n        #ifdef LIT_REFLECTIONS\n\n            #ifdef LIT_CLEARCOAT\n                addReflectionCC(ccReflDirW, litArgs_clearcoat_gloss);\n            \n                #ifdef LIT_SPECULAR_FRESNEL\n                    ccFresnel = getFresnelCC(dot(dViewDirW, litArgs_clearcoat_worldNormal));\n                    ccReflection.rgb = ccReflection.rgb * ccFresnel;\n                #else\n                    ccFresnel = 0.0;\n                #endif\n            #endif\n\n            #ifdef LIT_SPECULARITY_FACTOR\n                ccReflection.rgb = ccReflection.rgb * litArgs_specularityFactor;\n            #endif\n\n            #ifdef LIT_SHEEN\n                addReflectionSheen(litArgs_worldNormal, dViewDirW, litArgs_sheen_gloss);\n            #endif\n\n            // Fresnel has to be applied to reflections\n            addReflection(dReflDirW, litArgs_gloss);\n\n            #ifdef LIT_FRESNEL_MODEL\n\n                dReflection.rgb = dReflection.rgb * getFresnel(\n                    dot(dViewDirW, litArgs_worldNormal), \n                    litArgs_gloss, \n                    litArgs_specularity\n                #if defined(LIT_IRIDESCENCE)\n                    , iridescenceFresnel,\n                    litArgs_iridescence_intensity\n                #endif\n                    );\n\n            #else\n\n                dReflection.rgb = dReflection.rgb * litArgs_specularity;\n\n            #endif\n\n            #ifdef LIT_SPECULARITY_FACTOR\n                dReflection.rgb = dReflection.rgb * litArgs_specularityFactor;\n            #endif\n\n        #endif\n\n        #ifdef AREA_LIGHTS\n            // specular has to be accumulated differently if we want area lights to look correct\n            dSpecularLight = dSpecularLight * litArgs_specularity;\n\n            #ifdef LIT_SPECULAR\n                // evaluate material based area lights data, shared by all area lights\n                calcLTCLightValues(litArgs_gloss, litArgs_worldNormal, dViewDirW, litArgs_specularity, litArgs_clearcoat_gloss, litArgs_clearcoat_worldNormal, litArgs_clearcoat_specularity);\n            #endif\n        #endif\n        \n        // LOOP - evaluate all non-clustered lights\n        #include "lightEvaluationPS, LIGHT_COUNT"\n\n        // clustered lighting\n        #ifdef LIT_CLUSTERED_LIGHTS\n            addClusteredLights(litArgs_worldNormal, dViewDirW, dReflDirW,\n                #if defined(LIT_CLEARCOAT)\n                        ccReflDirW,\n                #endif\n                        litArgs_gloss, litArgs_specularity, dVertexNormalW, dTBN, \n                #if defined(LIT_IRIDESCENCE)\n                        iridescenceFresnel,\n                #endif\n                        litArgs_clearcoat_worldNormal, litArgs_clearcoat_gloss, litArgs_sheen_gloss, litArgs_iridescence_intensity\n            );\n        #endif\n\n        #ifdef AREA_LIGHTS\n\n            #ifdef LIT_CLEARCOAT\n                // specular has to be accumulated differently if we want area lights to look correct\n                litArgs_clearcoat_specularity = 1.0;\n            #endif\n\n            #ifdef LIT_SPECULAR\n                litArgs_specularity = vec3(1.0);\n            #endif\n\n        #endif\n\n        #ifdef LIT_REFRACTION\n            addRefraction(\n                litArgs_worldNormal, \n                dViewDirW, \n                litArgs_thickness, \n                litArgs_gloss, \n                litArgs_specularity, \n                litArgs_albedo, \n                litArgs_transmission,\n                litArgs_ior,\n                litArgs_dispersion\n                #if defined(LIT_IRIDESCENCE)\n                    , iridescenceFresnel, \n                    litArgs_iridescence_intensity\n                #endif\n            );\n        #endif\n    #endif\n\n    // apply ambient occlusion\n    #ifdef LIT_AO\n        #ifdef LIT_OCCLUDE_DIRECT\n            occludeDiffuse(litArgs_ao);\n        #endif\n\n        #if LIT_OCCLUDE_SPECULAR != NONE\n            occludeSpecular(litArgs_gloss, litArgs_ao, litArgs_worldNormal, dViewDirW);\n        #endif\n    #endif\n\n    #ifdef LIT_SPECULARITY_FACTOR\n        dSpecularLight = dSpecularLight * litArgs_specularityFactor;\n    #endif\n\n    #if !defined(LIT_OPACITY_FADES_SPECULAR)\n\n        #if LIT_BLEND_TYPE == NORMAL || LIT_BLEND_TYPE == PREMULTIPLIED\n\n            var specLum: f32 = dot((dSpecularLight + dReflection.rgb * dReflection.a), vec3f( 0.2126, 0.7152, 0.0722 ));\n            #ifdef LIT_CLEARCOAT\n                specLum = specLum + dot(ccSpecularLight * litArgs_clearcoat_specularity + ccReflection.rgb * litArgs_clearcoat_specularity, vec3f( 0.2126, 0.7152, 0.0722 ));\n            #endif\n            litArgs_opacity = clamp(litArgs_opacity + gammaCorrectInput(specLum), 0.0, 1.0);\n\n        #endif\n\n        litArgs_opacity = litArgs_opacity * material_alphaFade;\n\n    #endif\n\n    #include "endPS"\n    #include "outputAlphaPS"\n\n    #ifdef LIT_MSDF\n        output.color = applyMsdf(gl_FragColor);\n    #endif\n\n    #include "outputPS"\n    #include "debugOutputPS"\n\n    #ifdef LIT_SHADOW_CATCHER\n        // output when the shadow catcher is enabled - accumulated shadows\n        output.color = vec4f(dShadowCatcher, output.color.a);\n    #endif\n\n    return output;\n}\n',litForwardDeclarationPS:'\n\n// globals\nvar<private> sReflection: vec3f;\nvar<private> dVertexNormalW: vec3f;\nvar<private> dTangentW: vec3f;\nvar<private> dBinormalW: vec3f;\nvar<private> dViewDirW: vec3f;\nvar<private> dReflDirW: vec3f;\nvar<private> ccReflDirW: vec3f;\n\n// Per-light temporaries\nvar<private> dLightDirNormW: vec3f;\nvar<private> dAtten: f32;\n\n// Outputs\nvar<private> dTBN: mat3x3f;\nvar<private> dReflection: vec4f;\nvar<private> dDiffuseLight: vec3f;\nvar<private> dSpecularLight: vec3f;\nvar<private> ccFresnel: f32;\nvar<private> ccReflection: vec3f;\nvar<private> ccSpecularLight: vec3f;\nvar<private> ccSpecularityNoFres: f32;\nvar<private> sSpecularLight: vec3f;\n\n// FRAGMENT SHADER INPUTS: UNIFORMS\n\n#ifdef LIT_DISPERSION\n    uniform material_dispersion: f32;\n#endif\n\n#ifndef LIT_OPACITY_FADES_SPECULAR\n    uniform material_alphaFade: f32;\n#endif\n\n#ifdef LIT_SSAO\n    var ssaoTexture : texture_2d<f32>;\n    var ssaoTextureSampler : sampler;\n    uniform ssaoTextureSizeInv: vec2f;\n#endif\n\n// lighting and shadowing declarations\n\n#ifdef LIT_SHADOW_CATCHER\n    // a variable to accumulate shadows for shadow catcher materials\n    var<private> dShadowCatcher: f32 = 1.0;\n#endif\n\n// LOOP - uniform declarations for all non-clustered lights\n#if LIGHT_COUNT > 0\n    #include "lightDeclarationPS, LIGHT_COUNT"\n#endif\n\n#ifdef LIT_SPECULAR\n    #if LIT_FRESNEL_MODEL == NONE && !defined(LIT_REFLECTIONS) && !defined(LIT_DIFFUSE_MAP) \n        #define LIT_OLD_AMBIENT\n    #endif\n#endif\n',litForwardMainPS:'\n\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n\n    dReflection = vec4f(0.0);\n\n    #ifdef LIT_CLEARCOAT\n        ccSpecularLight = vec3f(0.0);\n        ccReflection = vec3f(0.0);\n    #endif\n\n    #if LIT_NONE_SLICE_MODE == SLICED\n        #include "startNineSlicedPS"\n    #elif LIT_NONE_SLICE_MODE == TILED\n        #include "startNineSlicedTiledPS"\n    #endif\n\n    #ifdef LIT_NEEDS_NORMAL\n        dVertexNormalW = normalize(vNormalW);\n\n        #ifdef LIT_TANGENTS\n            #if defined(LIT_HEIGHTS) || defined(LIT_USE_NORMALS) || defined(LIT_USE_CLEARCOAT_NORMALS)\n                dTangentW = vTangentW;\n                dBinormalW = vBinormalW;\n            #endif\n        #endif\n\n        getViewDir();\n\n        #ifdef LIT_TBN\n            getTBN(dTangentW, dBinormalW, dVertexNormalW);\n\n            #ifdef LIT_TWO_SIDED_LIGHTING\n                handleTwoSidedLighting();\n            #endif\n        #endif\n    #endif\n\n    // invoke frontend functions\n    evaluateFrontend();\n\n    #include "debugProcessFrontendPS"\n\n    var output: FragmentOutput = evaluateBackend();\n\n    return output;\n}\n',litForwardPostCodePS:'\n\n#ifdef LIT_NEEDS_NORMAL\n    #include "cubeMapRotatePS"\n    #include "cubeMapProjectPS"\n    #include "envProcPS"\n#endif\n\n// ----- specular or reflections -----\n#ifdef LIT_SPECULAR_OR_REFLECTION\n    #ifdef LIT_METALNESS\n        #include "metalnessModulatePS"\n    #endif\n\n    #if LIT_FRESNEL_MODEL == SCHLICK\n        #include "fresnelSchlickPS"\n    #endif\n\n    #ifdef LIT_IRIDESCENCE\n        #include "iridescenceDiffractionPS"\n    #endif\n#endif\n\n// ----- ambient occlusion -----\n#ifdef LIT_AO\n    #include "aoDiffuseOccPS"\n    #include "aoSpecOccPS"\n#endif\n\n#if LIT_REFLECTION_SOURCE == ENVATLASHQ\n    #include "envAtlasPS"\n    #include "reflectionEnvHQPS"\n#elif LIT_REFLECTION_SOURCE == ENVATLAS\n    #include "envAtlasPS"\n    #include "reflectionEnvPS"\n#elif LIT_REFLECTION_SOURCE == CUBEMAP\n    #include "reflectionCubePS"\n#elif LIT_REFLECTION_SOURCE == SPHEREMAP\n    #include "reflectionSpherePS"\n#endif\n\n#ifdef LIT_REFLECTIONS\n    #ifdef LIT_CLEARCOAT\n        #include "reflectionCCPS"\n    #endif\n\n    #ifdef LIT_SHEEN\n        #include "reflectionSheenPS"\n    #endif\n#endif\n\n#ifdef LIT_REFRACTION\n    #if defined(LIT_DYNAMIC_REFRACTION)\n        #include "refractionDynamicPS"\n    #elif defined(LIT_REFLECTIONS)\n        #include "refractionCubePS"\n    #endif\n#endif\n\n#ifdef LIT_SHEEN\n    #include "lightSheenPS"\n#endif\n\n#ifdef LIT_GGX_SPECULAR\n    uniform material_anisotropy: f32;\n#endif\n\nuniform material_ambient: vec3f;\n\n#ifdef LIT_SPECULAR\n    #ifdef LIT_LIGHTING\n        #ifdef LIT_GGX_SPECULAR\n            #include "lightSpecularAnisoGGXPS"\n        #else\n            #include "lightSpecularBlinnPS"\n        #endif\n    #endif\n#endif\n\n#include "combinePS"\n\n#ifdef LIT_LIGHTMAP\n    #include "lightmapAddPS"\n#endif\n\n#ifdef LIT_ADD_AMBIENT\n    #include "ambientPS"\n#endif\n\n#ifdef LIT_MSDF\n    #include "msdfPS"\n#endif\n\n#ifdef LIT_NEEDS_NORMAL\n    #include "viewDirPS"\n    #ifdef LIT_SPECULAR\n        #ifdef LIT_GGX_SPECULAR\n            #include "reflDirAnisoPS"\n        #else\n            #include "reflDirPS"\n        #endif\n    #endif\n#endif\n\n// lighting functionality\n#include "lightingPS"\n\n',litForwardPreCodePS:'\n\n#include "basePS"\n#include "sphericalPS"\n#include "decodePS"\n#include "gammaPS"\n#include "tonemappingPS"\n#include "fogPS"\n\n// 9-slice support code\n#if LIT_NONE_SLICE_MODE == SLICED\n    #include "baseNineSlicedPS"\n#elif LIT_NONE_SLICE_MODE == TILED\n    #include "baseNineSlicedTiledPS"\n#endif\n\n// TBN\n#ifdef LIT_TBN\n    #include "TBNPS"\n\n    #ifdef LIT_TWO_SIDED_LIGHTING\n        #include "twoSidedLightingPS"\n    #endif\n#endif\n\n',litMainVS:'\n#ifdef VERTEX_COLOR\n    attribute vertex_color: vec4f;\n#endif\n\n#ifdef NINESLICED\n\n    varying vMask: vec2f;\n    varying vTiledUv: vec2f;\n\n    uniform innerOffset: vec4f;\n    uniform outerScale: vec2f;\n    uniform atlasRect: vec4f;\n\n#endif\n\nvar<private> dPositionW: vec3f;\nvar<private> dModelMatrix: mat4x4f;\n\n#include "transformCoreVS"\n\n#ifdef UV0\n    attribute vertex_texCoord0: vec2f;\n    #include "uv0VS"\n#endif\n\n#ifdef UV1\n    attribute vertex_texCoord1: vec2f;\n    #include "uv1VS"\n#endif\n\n\n#ifdef LINEAR_DEPTH\n    #ifndef VIEWMATRIX\n    #define VIEWMATRIX\n        uniform matrix_view: mat4x4f;\n    #endif\n#endif\n\n#include "transformVS"\n\n#ifdef NORMALS\n    #include "normalCoreVS"\n    #include "normalVS"\n#endif\n\n#ifdef TANGENTS\n    attribute vertex_tangent: vec4f;\n    #include "tangentBinormalVS"\n#endif\n\n// expand uniforms for uv transforms\n#include "uvTransformUniformsPS, UV_TRANSFORMS_COUNT"\n\n#ifdef MSDF\n    #include "msdfVS"\n#endif\n\n@vertex\nfn vertexMain(input : VertexInput) -> VertexOutput {\n    var output : VertexOutput;\n    output.position = getPosition();\n    output.vPositionW = getWorldPosition();\n\n    #ifdef NORMALS\n        output.vNormalW = getNormal();\n    #endif\n\n    #ifdef TANGENTS\n        output.vTangentW = getTangent();\n        output.vBinormalW = getBinormal();\n    #elif defined(GGX_SPECULAR)\n        output.vObjectSpaceUpW = normalize(dNormalMatrix * vec3f(0.0, 1.0, 0.0));\n    #endif\n\n    #ifdef UV0\n        var uv0: vec2f = getUv0();\n        #ifdef UV0_UNMODIFIED\n            output.vUv0 = uv0;\n        #endif\n    #endif\n\n    #ifdef UV1\n        var uv1: vec2f = getUv1();\n        #ifdef UV1_UNMODIFIED\n            output.vUv1 = uv1;\n        #endif\n    #endif\n\n    // expand code for uv transforms\n    #include "uvTransformVS, UV_TRANSFORMS_COUNT"\n\n    #ifdef VERTEX_COLOR\n        output.vVertexColor = vertex_color;\n    #endif\n\n    #ifdef LINEAR_DEPTH\n        // linear depth from the worldPosition, see getLinearDepth\n        output.vLinearDepth = -(matrix_view * vec4f(vPositionW, 1.0)).z;\n    #endif\n\n    #ifdef MSDF\n        unpackMsdfParams();\n    #endif\n\n    return output;\n}\n',litShaderArgsPS:"\n\n// Surface albedo absorbance\nvar<private> litArgs_albedo: vec3f;\n\n// Transparency\nvar<private> litArgs_opacity: f32;\n\n// Emission color\nvar<private> litArgs_emission: vec3f;\n\n// Normal direction in world space\nvar<private> litArgs_worldNormal: vec3f;\n\n// Ambient occlusion amount, range [0..1]\nvar<private> litArgs_ao: f32;\n\n// Light map color\nvar<private> litArgs_lightmap: vec3f;\n\n// Light map direction\nvar<private> litArgs_lightmapDir: vec3f;\n\n// Surface metalness factor, range [0..1]\nvar<private> litArgs_metalness: f32;\n\n// The f0 specularity factor\nvar<private> litArgs_specularity: vec3f;\n\n// Specularity intensity factor, range [0..1]\nvar<private> litArgs_specularityFactor: f32;\n\n// The microfacet glossiness factor, range [0..1]\nvar<private> litArgs_gloss: f32;\n\n// Glossiness of the sheen layer, range [0..1]\nvar<private> litArgs_sheen_gloss: f32;\n\n// The color of the f0 specularity factor for the sheen layer\nvar<private> litArgs_sheen_specularity: vec3f;\n\n// Transmission factor (refraction), range [0..1]\nvar<private> litArgs_transmission: f32;\n\n// Uniform thickness of medium, used by transmission, range [0..inf]\nvar<private> litArgs_thickness: f32;\n\n// Index of refraction\nvar<private> litArgs_ior: f32;\n\n// Dispersion, range [0..1] typically, but can be higher\nvar<private> litArgs_dispersion: f32;\n\n// Iridescence effect intensity, range [0..1]\nvar<private> litArgs_iridescence_intensity: f32;\n\n// Thickness of the iridescent microfilm layer, value is in nanometers, range [0..1000]\nvar<private> litArgs_iridescence_thickness: f32;\n\n// The normal used for the clearcoat layer\nvar<private> litArgs_clearcoat_worldNormal: vec3f;\n\n// Intensity of the clearcoat layer, range [0..1]\nvar<private> litArgs_clearcoat_specularity: f32;\n\n// Glossiness of clearcoat layer, range [0..1]\nvar<private> litArgs_clearcoat_gloss: f32;\n\n",litShaderCorePS:'\n\n    // global texture bias for standard textures\n    #if LIT_NONE_SLICE_MODE == TILED\n        var<private> textureBias: f32 = -1000.0;\n    #else\n        uniform textureBias: f32;\n    #endif\n\n    #include "litShaderArgsPS"\n',morphEvaluationPS:"\n    color += uniform.morphFactor[{i}].element * textureSampleLevel(morphBlendTex{i}, morphBlendTex{i}Sampler, input.uv0, 0).xyz;\n",morphDeclarationPS:"\n    var morphBlendTex{i}: texture_2d<f32>;\n    var morphBlendTex{i}Sampler : sampler;\n",morphPS:'\n\n    varying uv0: vec2f;\n\n    // LOOP - source morph target textures\n    #include "morphDeclarationPS, MORPH_TEXTURE_COUNT"\n\n    #if MORPH_TEXTURE_COUNT > 0\n        uniform morphFactor: array<f32, {MORPH_TEXTURE_COUNT}>;\n    #endif\n\n    @fragment\n    fn fragmentMain(input : FragmentInput) -> FragmentOutput {\n        var output: FragmentOutput;\n\n        var color = vec3f(0, 0, 0);\n\n        // LOOP - source morph target textures\n        #include "morphEvaluationPS, MORPH_TEXTURE_COUNT"\n\n        output.color = vec4f(color, 1.0);\n        return output;\n    }\n',morphVS:"\n    attribute vertex_position: vec2f;\n    varying uv0: vec2f;\n\n    @vertex\n    fn vertexMain(input: VertexInput) -> VertexOutput {\n        var output: VertexOutput;\n        output.position = vec4f(input.vertex_position, 0.5, 1.0);\n        output.uv0 = input.vertex_position * 0.5 + vec2f(0.5, 0.5);\n        return output;\n    }\n",normalCoreVS:"\nattribute vertex_normal: vec3f;\n#ifdef MORPHING_NORMAL\n\t#ifdef MORPHING_INT\n\t\tuniform morphNormalTex: texture_2d<u32>;\n\t\tuniform morphNormalTexSampler: sampler;\n\t#else\n\t\tuniform morphNormalTex: texture_2d<f32>;\n\t\tuniform morphNormalTexSampler: sampler;\n\t#endif\n#endif\nfn getLocalNormal(vertexNormal: vec3f) -> vec3f {\n\tvar localNormal: vec3f = vertexNormal;\n\t#ifdef MORPHING_NORMAL\n\t\tlet morphUV: vec2i = getTextureMorphCoords();\n\t\t#ifdef MORPHING_INT\n\t\t\tlet morphNormalInt: vec4u = textureLoad(morphNormalTex, morphUV, 0);\n\t\t\tlet morphNormalF: vec3f = vec3f(morphNormalInt.xyz) / 65535.0 * 2.0 - 1.0;\n\t\t\tlocalNormal = localNormal + morphNormalF;\n\t\t#else\n\t\t\tlet morphNormal: vec3f = textureLoad(morphNormalTex, morphUV, 0).xyz;\n\t\t\tlocalNormal = localNormal + morphNormal;\n\t\t#endif\n\t#endif\n\treturn localNormal;\n}\n#ifdef SKIN\n\tfn getNormalMatrix(modelMatrix: mat4x4f) -> mat3x3f {\n\t\treturn mat3x3f(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);\n\t}\n#elif defined(INSTANCING)\n\tfn getNormalMatrix(modelMatrix: mat4x4f) -> mat3x3f {\n\t\treturn mat3x3f(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);\n\t}\n#else\n\tfn getNormalMatrix(modelMatrix: mat4x4f) -> mat3x3f {\n\t\treturn uniform.matrix_normal;\n\t}\n#endif\n",outputPS:"\n",outputAlphaPS:"\n\n#if LIT_BLEND_TYPE == NORMAL || LIT_BLEND_TYPE == ADDITIVEALPHA || defined(LIT_ALPHA_TO_COVERAGE)\n\n    output.color = vec4f(output.color.rgb, litArgs_opacity);\n\n#elif LIT_BLEND_TYPE == PREMULTIPLIED\n\n    output.color = vec4f(output.color.rgb * litArgs_opacity, litArgs_opacity);\n\n#else\n\n    output.color = vec4f(output.color.rgb, 1.0);\n\n#endif\n",reprojectPS:'\n\nvarying vUv0: vec2f;\n\n#ifdef CUBEMAP_SOURCE\n    var sourceCube: texture_cube<f32>;\n    var sourceCubeSampler : sampler;\n#else\n    var sourceTex: texture_2d<f32>;\n    var sourceTexSampler : sampler;\n#endif\n\n#ifdef USE_SAMPLES_TEX\n    // samples\n    var samplesTex: texture_2d<f32>;\n    var samplesTexSampler : sampler;\n    uniform samplesTexInverseSize: vec2f;\n#endif\n\n// params:\n// x - target cubemap face 0..6\n// y - target image total pixels\n// z - source cubemap size\nuniform params: vec3f;\n\nfn targetFace() -> f32 { return uniform.params.x; }\nfn targetTotalPixels() -> f32 { return uniform.params.y; }\nfn sourceTotalPixels() -> f32 { return uniform.params.z; }\n\nconst PI: f32 = 3.141592653589793;\n\nfn saturate(x: f32) -> f32 {\n    return clamp(x, 0.0, 1.0);\n}\n\n#include "decodePS"\n#include "encodePS"\n\n//-- supported projections\n\nfn modifySeams(dir: vec3f, scale: f32) -> vec3f {\n    let adir = abs(dir);\n    let M = max(max(adir.x, adir.y), adir.z);\n    return dir / M * vec3f(\n        select(scale, 1.0, adir.x == M),\n        select(scale, 1.0, adir.y == M),\n        select(scale, 1.0, adir.z == M)\n    );\n}\n\nfn toSpherical(dir: vec3f) -> vec2f {\n    let nonZeroXZ = any(dir.xz != vec2f(0.0, 0.0));\n    return vec2f(select(0.0, atan2(dir.x, dir.z), nonZeroXZ), asin(dir.y));\n}\n\nfn fromSpherical(uv: vec2f) -> vec3f {\n    return vec3f(cos(uv.y) * sin(uv.x),\n                sin(uv.y),\n                cos(uv.y) * cos(uv.x));\n}\n\nfn getDirectionEquirect(uv: vec2f) -> vec3f {\n    return fromSpherical((vec2f(uv.x, 1.0 - uv.y) * 2.0 - 1.0) * vec2f(PI, PI * 0.5));\n}\n\n// octahedral code, based on https://jcgt.org/published/0003/02/01/\n// "Survey of Efficient Representations for Independent Unit Vectors" by Cigolle, Donow, Evangelakos, Mara, McGuire, Meyer\n\nfn signNotZero(k: f32) -> f32 {\n    return select(-1.0, 1.0, k >= 0.0);\n}\n\nfn signNotZeroVec2(v: vec2f) -> vec2f {\n    return vec2f(signNotZero(v.x), signNotZero(v.y));\n}\n\n// Returns a unit vector. Argument o is an octahedral vector packed via octEncode, on the [-1, +1] square\nfn octDecode(o: vec2f) -> vec3f {\n    var v = vec3f(o.x, 1.0 - abs(o.x) - abs(o.y), o.y);\n    if (v.y < 0.0) {\n        var temp: vec2f = (1.0 - abs(v.zx)) * signNotZeroVec2(v.xz);\n        v = vec3f(temp.x, v.y, temp.y);\n    }\n    return normalize(v);\n}\n\nfn getDirectionOctahedral(uv: vec2f) -> vec3f {\n    return octDecode(vec2f(uv.x, 1.0 - uv.y) * 2.0 - 1.0);\n}\n\n// Assumes that v is a unit vector. The result is an octahedral vector on the [-1, +1] square\nfn octEncode(v: vec3f) -> vec2f {\n    let l1norm = abs(v.x) + abs(v.y) + abs(v.z);\n    var result = v.xz * (1.0 / l1norm);\n    if (v.y < 0.0) {\n        result = (1.0 - abs(result.yx)) * signNotZeroVec2(result.xy);\n    }\n    return result;\n}\n\n/////////////////////////////////////////////////////////////////////\n\n#ifdef CUBEMAP_SOURCE\n    fn sampleCubemapDir(dir: vec3f) -> vec4f {\n        return textureSample(sourceCube, sourceCubeSampler, modifySeams(dir, 1.0));\n    }\n\n    fn sampleCubemapSph(sph: vec2f) -> vec4f {\n        return sampleCubemapDir(fromSpherical(sph));\n    }\n\n    fn sampleCubemapDirLod(dir: vec3f, mipLevel: f32) -> vec4f {\n        return textureSampleLevel(sourceCube, sourceCubeSampler, modifySeams(dir, 1.0), mipLevel);\n    }\n\n    fn sampleCubemapSphLod(sph: vec2f, mipLevel: f32) -> vec4f {\n        return sampleCubemapDirLod(fromSpherical(sph), mipLevel);\n    }\n#else\n\n    fn sampleEquirectSph(sph: vec2f) -> vec4f {\n        let uv = sph / vec2f(PI * 2.0, PI) + 0.5;\n        return textureSample(sourceTex, sourceTexSampler, vec2f(uv.x, 1.0 - uv.y));\n    }\n\n    fn sampleEquirectDir(dir: vec3f) -> vec4f {\n        return sampleEquirectSph(toSpherical(dir));\n    }\n\n    fn sampleEquirectSphLod(sph: vec2f, mipLevel: f32) -> vec4f {\n        let uv = sph / vec2f(PI * 2.0, PI) + 0.5;\n        return textureSampleLevel(sourceTex, sourceTexSampler, vec2f(uv.x, 1.0 - uv.y), mipLevel);\n    }\n\n    fn sampleEquirectDirLod(dir: vec3f, mipLevel: f32) -> vec4f {\n        return sampleEquirectSphLod(toSpherical(dir), mipLevel);\n    }\n\n    fn sampleOctahedralDir(dir: vec3f) -> vec4f {\n        let uv = octEncode(dir) * 0.5 + 0.5;\n        return textureSample(sourceTex, sourceTexSampler, vec2f(uv.x, 1.0 - uv.y));\n    }\n\n    fn sampleOctahedralSph(sph: vec2f) -> vec4f {\n        return sampleOctahedralDir(fromSpherical(sph));\n    }\n\n    fn sampleOctahedralDirLod(dir: vec3f, mipLevel: f32) -> vec4f {\n        let uv = octEncode(dir) * 0.5 + 0.5;\n        return textureSampleLevel(sourceTex, sourceTexSampler, vec2f(uv.x, 1.0 - uv.y), mipLevel);\n    }\n\n    fn sampleOctahedralSphLod(sph: vec2f, mipLevel: f32) -> vec4f {\n        return sampleOctahedralDirLod(fromSpherical(sph), mipLevel);\n    }\n\n#endif\n\nfn getDirectionCubemap(uv: vec2f) -> vec3f {\n    let st = uv * 2.0 - 1.0;\n    let face = targetFace();\n\n    var vec: vec3f;\n    if (face == 0.0) {\n        vec = vec3f(1, -st.y, -st.x);\n    } else if (face == 1.0) {\n        vec = vec3f(-1, -st.y, st.x);\n    } else if (face == 2.0) {\n        vec = vec3f(st.x, 1, st.y);\n    } else if (face == 3.0) {\n        vec = vec3f(st.x, -1, -st.y);\n    } else if (face == 4.0) {\n        vec = vec3f(st.x, -st.y, 1);\n    } else {\n        vec = vec3f(-st.x, -st.y, -1);\n    }\n\n    return normalize(modifySeams(vec, 1.0));\n}\n\nfn matrixFromVector(n: vec3f) -> mat3x3f {\n    let a = 1.0 / (1.0 + n.z);\n    let b = -n.x * n.y * a;\n    let b1 = vec3f(1.0 - n.x * n.x * a, b, -n.x);\n    let b2 = vec3f(b, 1.0 - n.y * n.y * a, -n.y);\n    return mat3x3f(b1, b2, n);\n}\n\nfn matrixFromVectorSlow(n: vec3f) -> mat3x3f {\n    let up = select(vec3f(0.0, 0.0, select(-1.0, 1.0, n.y > 0.0)), vec3f(0.0, 1.0, 0.0), abs(n.y) > 0.0000001);\n    let x = normalize(cross(up, n));\n    let y = cross(n, x);\n    return mat3x3f(x, y, n);\n}\n\nfn reproject(uv: vec2f) -> vec4f {\n    if ({NUM_SAMPLES} <= 1) {\n        // single sample\n        return {ENCODE_FUNC}({DECODE_FUNC}({SOURCE_FUNC}Dir({TARGET_FUNC}(uv))));\n    } else {\n        // multi sample\n        let t = {TARGET_FUNC}(uv);\n        let tu = dpdx(t);\n        let tv = dpdy(t);\n\n        var result = vec3f(0.0);\n        for (var u = 0.0; u < {NUM_SAMPLES_SQRT}; u += 1.0) {\n            for (var v = 0.0; v < {NUM_SAMPLES_SQRT}; v += 1.0) {\n                result += {DECODE_FUNC}({SOURCE_FUNC}Dir(normalize(t +\n                                                            tu * (u / {NUM_SAMPLES_SQRT} - 0.5) +\n                                                            tv * (v / {NUM_SAMPLES_SQRT} - 0.5))));\n            }\n        }\n        return {ENCODE_FUNC}(result / ({NUM_SAMPLES_SQRT} * {NUM_SAMPLES_SQRT}));\n    }\n}\n\nconst unpackFloat: vec4f = vec4f(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0);\n\n#ifdef USE_SAMPLES_TEX\n    fn unpackSample(i: i32, L: ptr<function, vec3f>, mipLevel: ptr<function, f32>) {\n        var u = (f32(i * 4) + 0.5) * uniform.samplesTexInverseSize.x;\n        var v = (floor(u) + 0.5) * uniform.samplesTexInverseSize.y;\n\n        var raw: vec4f;\n        raw.x = dot(textureSample(samplesTex, samplesTexSampler, vec2f(u, v)), unpackFloat); u += uniform.samplesTexInverseSize.x;\n        raw.y = dot(textureSample(samplesTex, samplesTexSampler, vec2f(u, v)), unpackFloat); u += uniform.samplesTexInverseSize.x;\n        raw.z = dot(textureSample(samplesTex, samplesTexSampler, vec2f(u, v)), unpackFloat); u += uniform.samplesTexInverseSize.x;\n        raw.w = dot(textureSample(samplesTex, samplesTexSampler, vec2f(u, v)), unpackFloat);\n\n        *L = raw.xyz * 2.0 - 1.0;\n        *mipLevel = raw.w * 8.0;\n    }\n\n    // convolve an environment given pre-generated samples\n    fn prefilterSamples(uv: vec2f) -> vec4f {\n        // construct vector space given target direction\n        let vecSpace = matrixFromVectorSlow({TARGET_FUNC}(uv));\n\n        var L: vec3f;\n        var mipLevel: f32;\n\n        var result = vec3f(0.0);\n        var totalWeight = 0.0;\n        for (var i = 0; i < {NUM_SAMPLES}; i += 1) {\n            unpackSample(i, &L, &mipLevel);\n            result += {DECODE_FUNC}({SOURCE_FUNC}DirLod(vecSpace * L, mipLevel)) * L.z;\n            totalWeight += L.z;\n        }\n\n        return {ENCODE_FUNC}(result / totalWeight);\n    }\n\n    // unweighted version of prefilterSamples\n    fn prefilterSamplesUnweighted(uv: vec2f) -> vec4f {\n        // construct vector space given target direction\n        let vecSpace = matrixFromVectorSlow({TARGET_FUNC}(uv));\n\n        var L: vec3f;\n        var mipLevel: f32;\n\n        var result = vec3f(0.0);\n        for (var i = 0; i < {NUM_SAMPLES}; i += 1) {\n            unpackSample(i, &L, &mipLevel);\n            result += {DECODE_FUNC}({SOURCE_FUNC}DirLod(vecSpace * L, mipLevel));\n        }\n\n        return {ENCODE_FUNC}(result / f32({NUM_SAMPLES}));\n    }\n#endif\n\n@fragment\nfn fragmentMain(input : FragmentInput) -> FragmentOutput {\n    var output: FragmentOutput;\n    output.color = {PROCESS_FUNC}(input.vUv0);\n    return output;\n}\n',reprojectVS:"\nattribute vertex_position: vec2f;\nuniform uvMod: vec4f;\nvarying vUv0: vec2f;\n\n@vertex\nfn vertexMain(input: VertexInput) -> VertexOutput {\n  var output: VertexOutput;\n  output.position = vec4f(input.vertex_position, 0.5, 1.0);\n  output.vUv0 = getImageEffectUV((input.vertex_position * 0.5 + vec2f(0.5, 0.5)) * uniform.uvMod.xy + uniform.uvMod.zw);\n  return output;\n}\n",skinVS:"\n\nattribute vertex_boneWeights: vec4f;\nattribute vertex_boneIndices: vec4f;\n\nvar texture_poseMap: texture_2d<f32>;\n\nstruct BoneMatrix {\n    v1: vec4f,\n    v2: vec4f,\n    v3: vec4f,\n}\n\nfn getBoneMatrix(width: i32, index: i32) -> BoneMatrix {\n\n    let v = index / width;\n    let u = index % width;\n\n    var result: BoneMatrix;\n    result.v1 = textureLoad(texture_poseMap, vec2i(u + 0, v), 0);\n    result.v2 = textureLoad(texture_poseMap, vec2i(u + 1, v), 0);\n    result.v3 = textureLoad(texture_poseMap, vec2i(u + 2, v), 0);\n    return result;\n}\n\nfn getSkinMatrix(indicesFloat: vec4f, weights: vec4f) -> mat4x4f {\n\n    let width = i32(textureDimensions(texture_poseMap).x);\n    var indices = vec4i(indicesFloat + 0.5) * 3;\n\n    let boneA = getBoneMatrix(width, indices.x);\n    let boneB = getBoneMatrix(width, indices.y);\n    let boneC = getBoneMatrix(width, indices.z);\n    let boneD = getBoneMatrix(width, indices.w);\n\n    // ... rest of getSkinMatrix remains the same ...\n    let v1 = boneA.v1 * weights.x + boneB.v1 * weights.y + boneC.v1 * weights.z + boneD.v1 * weights.w;\n    let v2 = boneA.v2 * weights.x + boneB.v2 * weights.y + boneC.v2 * weights.z + boneD.v2 * weights.w;\n    let v3 = boneA.v3 * weights.x + boneB.v3 * weights.y + boneC.v3 * weights.z + boneD.v3 * weights.w;\n\n    let one = dot(weights, vec4f(1.0, 1.0, 1.0, 1.0));\n\n    // transpose to 4x4 matrix\n    return mat4x4f(\n        v1.x, v2.x, v3.x, 0,\n        v1.y, v2.y, v3.y, 0,\n        v1.z, v2.z, v3.z, 0,\n        v1.w, v2.w, v3.w, one\n    );\n}\n",skyboxPS:'\n    #define LIT_SKYBOX_INTENSITY\n\n    #include "envProcPS"\n    #include "gammaPS"\n    #include "tonemappingPS"\n\n    // Varying and uniform declarations\n    varying vViewDir : vec3f;\n    uniform skyboxHighlightMultiplier : f32;\n\n    #ifdef SKY_CUBEMAP\n\n        var texture_cubeMap : texture_cube<f32>;\n        var texture_cubeMap_sampler : sampler;\n\n        #ifdef SKYMESH\n            varying vWorldPos : vec3f;\n            uniform cubeMapRotationMatrix : mat3x3f;\n            uniform projectedSkydomeCenter : vec3f;\n        #endif\n\n    #else // env-atlas\n\n        #include "sphericalPS"\n        #include "envAtlasPS"\n\n        var texture_envAtlas : texture_2d<f32>;\n        var texture_envAtlas_sampler : sampler;\n\n        uniform mipLevel : f32;\n\n    #endif\n\n    @fragment\n    fn fragmentMain(input : FragmentInput) -> FragmentOutput {\n\n        var linear : vec3f;\n        var dir : vec3f;\n\n        #ifdef SKY_CUBEMAP\n\n            #ifdef SKYMESH\n                // get vector from world space pos to tripod origin\n                var envDir : vec3f = normalize(input.vWorldPos - uniform.projectedSkydomeCenter);\n                dir = envDir * uniform.cubeMapRotationMatrix;\n            #else\n                dir = input.vViewDir;\n            #endif\n\n            dir.x *= -1.0;\n            linear = {SKYBOX_DECODE_FNC}(textureSample(texture_cubeMap, texture_cubeMap_sampler, dir));\n\n        #else // env-atlas\n\n            dir = input.vViewDir * vec3f(-1.0, 1.0, 1.0);\n            let uv : vec2f = toSphericalUv(normalize(dir));\n            linear = {SKYBOX_DECODE_FNC}(textureSample(texture_envAtlas, texture_envAtlas_sampler, mapRoughnessUv(uv, uniform.mipLevel)));\n\n        #endif\n\n        // our HDR encodes values up to 64, so allow extra brightness for the clipped values\n        if (any(linear >= vec3f(64.0))) {\n            linear *= uniform.skyboxHighlightMultiplier;\n        }\n        \n        var output: FragmentOutput;\n        output.color = vec4f(gammaCorrectOutput(toneMap(processEnvironment(linear))), 1.0);\n        return output;\n    }\n',skyboxVS:"\n    // Attribute\n    attribute aPosition : vec4f;\n\n    #ifndef VIEWMATRIX\n    #define VIEWMATRIX\n    uniform matrix_view : mat4x4f;\n    #endif\n\n    uniform matrix_projectionSkybox : mat4x4f;\n    uniform cubeMapRotationMatrix : mat3x3f;\n\n    varying vViewDir : vec3f;\n\n    #ifdef SKYMESH\n        uniform matrix_model : mat4x4f;\n        varying vWorldPos : vec3f;\n    #endif\n\n    @vertex\n    fn vertexMain(input : VertexInput) -> VertexOutput {\n\n        var output : VertexOutput;\n        var view : mat4x4f = uniform.matrix_view;\n\n        #ifdef SKYMESH\n\n            var worldPos : vec4f = uniform.matrix_model * input.aPosition;\n            output.vWorldPos = worldPos.xyz;\n            output.position = uniform.matrix_projectionSkybox * (view * worldPos);\n\n        #else\n\n            view[3][0] = 0.0;\n            view[3][1] = 0.0;\n            view[3][2] = 0.0;\n            output.position = uniform.matrix_projectionSkybox * (view * input.aPosition);\n            output.vViewDir = input.aPosition.xyz * uniform.cubeMapRotationMatrix;\n\n        #endif\n\n        // Force skybox to far Z, regardless of the clip planes on the camera\n        // Subtract a tiny fudge factor to ensure floating point errors don't\n        // still push pixels beyond far Z. See:\n        // https://community.khronos.org/t/skybox-problem/61857\n\n        output.position.z = output.position.w - 1.0e-7;\n\n        return output;\n    }\n",sphericalPS:"\n\nfn toSpherical(dir: vec3f) -> vec2f {\n    let angle_xz = select(0.0, atan2(dir.x, dir.z), any(dir.xz != vec2f(0.0)));\n    return vec2f(angle_xz, asin(dir.y));\n}\n\nfn toSphericalUv(dir : vec3f) -> vec2f {\n    const PI : f32 = 3.141592653589793;\n    let uv : vec2f = toSpherical(dir) / vec2f(PI * 2.0, PI) + vec2f(0.5, 0.5);\n    return vec2f(uv.x, 1.0 - uv.y);\n}\n",tonemappingPS:'\n#if (TONEMAP == NONE)\n    #include "tonemappingNonePS"\n#elif TONEMAP == FILMIC\n    #include "tonemappingFilmicPS"\n#elif TONEMAP == LINEAR\n    #include "tonemappingLinearPS"\n#elif TONEMAP == HEJL\n    #include "tonemappingHejlPS"\n#elif TONEMAP == ACES\n    #include "tonemappingAcesPS"\n#elif TONEMAP == ACES2\n    #include "tonemappingAces2PS"\n#elif TONEMAP == NEUTRAL\n    #include "tonemappingNeutralPS"\n#endif\n',tonemappingAcesPS:"\nuniform exposure: f32;\n\nfn toneMap(color: vec3f) -> vec3f {\n    let tA: f32 = 2.51;\n    let tB: f32 = 0.03;\n    let tC: f32 = 2.43;\n    let tD: f32 = 0.59;\n    let tE: f32 = 0.14;\n    let x: vec3f = color * uniform.exposure;\n    return (x * (tA * x + tB)) / (x * (tC * x + tD) + tE);\n}\n",tonemappingAces2PS:"\nuniform exposure: f32;\n\n// ACES approximation by Stephen Hill\n\n// sRGB => XYZ => D65_2_D60 => AP1 => RRT_SAT\nconst ACESInputMat: mat3x3f = mat3x3f(\n    vec3f(0.59719, 0.35458, 0.04823),\n    vec3f(0.07600, 0.90834, 0.01566),\n    vec3f(0.02840, 0.13383, 0.83777)\n);\n\n// ODT_SAT => XYZ => D60_2_D65 => sRGB\nconst ACESOutputMat: mat3x3f = mat3x3f(\n    vec3f( 1.60475, -0.53108, -0.07367),\n    vec3f(-0.10208,  1.10813, -0.00605),\n    vec3f(-0.00327, -0.07276,  1.07602)\n);\n\nfn RRTAndODTFit(v: vec3f) -> vec3f {\n    let a: vec3f = v * (v + vec3f(0.0245786)) - vec3f(0.000090537);\n    let b: vec3f = v * (vec3f(0.983729) * v + vec3f(0.4329510)) + vec3f(0.238081);\n    return a / b;\n}\n\nfn toneMap(color: vec3f) -> vec3f {\n    var c: vec3f = color * (uniform.exposure / 0.6);\n    c = ACESInputMat * c;\n\n    // Apply RRT and ODT\n    c = RRTAndODTFit(c);\n    c = ACESOutputMat * c;\n\n    // Clamp to [0, 1]\n    return clamp(c, vec3f(0.0), vec3f(1.0));\n}\n",tonemappingFilmicPS:"\nconst A: f32 = 0.15;\nconst B: f32 = 0.50;\nconst C: f32 = 0.10;\nconst D: f32 = 0.20;\nconst E: f32 = 0.02;\nconst F: f32 = 0.30;\nconst W: f32 = 11.2;\n\nuniform exposure: f32;\n\nfn uncharted2Tonemap(x: vec3f) -> vec3f {\n    return ((x * (A * x + C * B) + D * E) / (x * (A * x + B) + D * F)) - vec3f(E / F);\n}\n\nfn toneMap(color: vec3f) -> vec3f {\n    var c: vec3f = uncharted2Tonemap(color * uniform.exposure);\n    let whiteScale: vec3f = vec3f(1.0) / uncharted2Tonemap(vec3f(W, W, W));\n    c *= whiteScale;\n    return c;\n}\n",tonemappingHejlPS:"\nuniform exposure: f32;\n\nfn toneMap(color: vec3f) -> vec3f {\n    let A: f32 = 0.22;\n    let B: f32 = 0.3;\n    let C: f32 = 0.1;\n    let D: f32 = 0.2;\n    let E: f32 = 0.01;\n    let F: f32 = 0.3;\n    let Scl: f32 = 1.25;\n\n    let adjusted_color = color * uniform.exposure;\n    let h = max(vec3f(0.0), adjusted_color - vec3f(0.004));\n\n    return (h * ((Scl * A) * h + Scl * vec3f(C * B)) + Scl * vec3f(D * E)) /\n           (h * (A * h + vec3f(B)) + vec3f(D * F)) -\n           Scl * vec3f(E / F);\n}\n",tonemappingLinearPS:"\nuniform exposure: f32;\n\nfn toneMap(color: vec3f) -> vec3f {\n    return color * uniform.exposure;\n}\n",tonemappingNeutralPS:"\nuniform exposure: f32;\n\nfn toneMap(col: vec3f) -> vec3f {\n    var color = col * uniform.exposure;\n\n    let startCompression = 0.8 - 0.04;\n    let desaturation = 0.15;\n\n    let x = min(color.r, min(color.g, color.b));\n    let offset = select(0.04, x - 6.25 * x * x, x < 0.08);\n    color -= vec3f(offset);\n\n    let peak = max(color.r, max(color.g, color.b));\n    if (peak < startCompression) {\n        return color;\n    }\n\n    let d = 1.0 - startCompression;\n    let newPeak = 1.0 - d * d / (peak + d - startCompression);\n    color *= newPeak / peak;\n\n    let g = 1.0 - 1.0 / (desaturation * (peak - newPeak) + 1.0);\n    return mix(color, vec3f(newPeak), vec3f(g));\n}\n",tonemappingNonePS:"\nfn toneMap(color: vec3f) -> vec3f {\n    return color;\n}\n",transformVS:"\n#ifdef PIXELSNAP\n    uniform uScreenSize: vec4f;\n#endif\n\n#ifdef SCREENSPACE\n    uniform projectionFlipY: f32;\n#endif\n\nfn evalWorldPosition(vertexPosition: vec3f, modelMatrix: mat4x4f) -> vec4f {\n\n    var localPos: vec3f = getLocalPosition(vertexPosition);\n\n    #ifdef NINESLICED\n        // outer and inner vertices are at the same position, scale both\n        localPos.xz *= uniform.outerScale;\n\n        // offset inner vertices inside\n        // (original vertices must be in [-1;1] range)\n        let positiveUnitOffset: vec2f = clamp(vertexPosition.xz, vec2f(0.0), vec2f(1.0));\n        let negativeUnitOffset: vec2f = clamp(-vertexPosition.xz, vec2f(0.0), vec2f(1.0));\n        localPos.xz += (-positiveUnitOffset * uniform.innerOffset.xy + negativeUnitOffset * uniform.innerOffset.zw) * vertex_texCoord0.xy;\n\n        vTiledUv = (localPos.xz - outerScale + uniform.innerOffset.xy) * -0.5 + 1.0; // uv = local pos - inner corner\n\n        localPos.xz *= -0.5; // move from -1;1 to -0.5;0.5\n        localPos = localPos.xzy;\n    #endif\n\n    var posW: vec4f = modelMatrix * vec4f(localPos, 1.0);\n\n    #ifdef SCREENSPACE\n        posW.zw = vec2f(0.0, 1.0);\n    #endif\n\n    return posW;\n}\n\nfn getPosition() -> vec4f {\n\n    dModelMatrix = getModelMatrix();\n\n    let posW: vec4f = evalWorldPosition(vertex_position.xyz, dModelMatrix);\n    dPositionW = posW.xyz;\n\n    var screenPos: vec4f;\n    #ifdef UV1LAYOUT\n        screenPos = vec4f(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1.0);\n        screenPos.y *= -1.0;\n    #else\n        #ifdef SCREENSPACE\n            screenPos = posW;\n            screenPos.y *= uniforms.projectionFlipY;\n        #else\n            screenPos = uniform.matrix_viewProjection * posW;\n        #endif\n\n        #ifdef PIXELSNAP\n            // snap vertex to a pixel boundary\n            screenPos.xy = (screenPos.xy * 0.5) + 0.5;\n            screenPos.xy *= uniforms.uScreenSize.xy;\n            screenPos.xy = floor(screenPos.xy);\n            screenPos.xy *= uniforms.uScreenSize.zw;\n            screenPos.xy = (screenPos.xy * 2.0) - 1.0;\n        #endif\n    #endif\n\n    return screenPos;\n}\n\nfn getWorldPosition() -> vec3f {\n    return dPositionW;\n}\n",transformCoreVS:'\n\n    attribute vertex_position: vec4f;\n\n    uniform matrix_viewProjection: mat4x4f;\n    uniform matrix_model: mat4x4f;\n    uniform matrix_normal: mat3x3f;\n\n    #ifdef MORPHING\n\n        uniform morph_tex_params: vec2f;\n        attribute morph_vertex_id: u32;\n\n        fn getTextureMorphCoords() -> vec2i {\n\n            // turn morph_vertex_id into int grid coordinates\n            var textureSize: vec2i = vec2i(uniform.morph_tex_params);\n            var morphGridV: i32 = i32(morph_vertex_id) / textureSize.x;\n            var morphGridU: i32 = i32(morph_vertex_id) - (morphGridV * textureSize.x);\n            morphGridV = textureSize.y - morphGridV - 1;\n            return vec2i(morphGridU, morphGridV);\n        }\n\n        #ifdef MORPHING_POSITION\n            #ifdef MORPHING_INT\n                uniform aabbSize: vec3f;\n                uniform aabbMin: vec3f;\n                var morphPositionTex: texture_2d<u32>;\n            #else\n                var morphPositionTex: texture_2d<f32>;\n            #endif\n        #endif\n    #endif\n\n    #ifdef defined(BATCH)\n        #include "skinBatchVS"\n\n        fn getModelMatrix() -> mat4x4f {\n            return getBoneMatrix(vertex_boneIndices);\n        }\n\n    #elif defined(SKIN)\n        #include "skinVS"\n        fn getModelMatrix() -> mat4x4f {\n            return uniform.matrix_model * getSkinMatrix(vertex_boneIndices, vertex_boneWeights);\n        }\n\n    #elif defined(INSTANCING)\n\n        #include "transformInstancingVS"\n\n    #else\n\n        fn getModelMatrix() -> mat4x4f {\n            return uniform.matrix_model;\n        }\n\n    #endif\n\n    fn getLocalPosition(vertexPosition: vec3f) -> vec3f {\n\n        var localPos: vec3f = vertexPosition;\n\n        #ifdef MORPHING_POSITION\n\n            var morphUV: vec2i = getTextureMorphCoords();\n\n            #ifdef MORPHING_INT\n                // Use textureLoad instead of texelFetch. Coordinates must be integer type (vec2i).\n                // WGSL requires explicit type conversion for vectors.\n                // Division by float literal ensures floating point division.\n                var morphPos: vec3f = vec3f(textureLoad(morphPositionTex, morphUV, 0).xyz) / 65535.0 * uniform.aabbSize + uniform.aabbMin;\n            #else\n                // Use textureLoad instead of texelFetch. Coordinates must be integer type (vec2i).\n                var morphPos: vec3f = textureLoad(morphPositionTex, morphUV, 0).xyz;\n            #endif\n\n            localPos += morphPos;\n\n        #endif\n\n        return localPos;\n    }\n',uv0VS:"\n#ifdef NINESLICED\n    fn getUv0() -> vec2f {\n        var uv = vertex_position.xz;\n\n        // offset inner vertices inside\n        let positiveUnitOffset = clamp(vertex_position.xz, vec2f(0.0, 0.0), vec2f(1.0, 1.0));\n        let negativeUnitOffset = clamp(-vertex_position.xz, vec2f(0.0, 0.0), vec2f(1.0, 1.0));\n\n        uv = uv + ((-positiveUnitOffset * uniform.innerOffset.xy) + (negativeUnitOffset * uniform.innerOffset.zw)) * vertex_texCoord0.xy;\n\n        uv = uv * -0.5 + vec2f(0.5, 0.5);\n        uv = uv * uniform.atlasRect.zw + uniform.atlasRect.xy;\n\n        vMask = vertex_texCoord0.xy;\n\n        return uv;\n    }\n#else\n    fn getUv0() -> vec2f {\n        return vertex_texCoord0;\n    }\n#endif\n",uv1VS:"\nfn getUv1() -> vec2f {\n    return vertex_texCoord1;\n}\n",uvTransformVS:"\nvUV{TRANSFORM_UV_{i}}_{TRANSFORM_ID_{i}} = vec2f(\n    dot(vec3f(uv{TRANSFORM_UV_{i}}, 1), {TRANSFORM_NAME_{i}}0),\n    dot(vec3f(uv{TRANSFORM_UV_{i}}, 1), {TRANSFORM_NAME_{i}}1)\n);\n",uvTransformUniformsPS:"\n    uniform {TRANSFORM_NAME_{i}}0: vec3f;\n    uniform {TRANSFORM_NAME_{i}}1: vec3f;\n"},Fc=new hi,Bc=new Float32Array(6),Nc=new hi(-.5,0,0),zc=new hi(0,0,.5),Uc={POSITION_RANGE:0,DIRECTION_FLAGS:1,COLOR_ANGLES_BIAS:2,PROJ_MAT_0:3,ATLAS_VIEWPORT:3,PROJ_MAT_1:4,PROJ_MAT_2:5,PROJ_MAT_3:6,AREA_DATA_WIDTH:7,AREA_DATA_HEIGHT:8,COUNT:9},Vc={"{LIGHTSHAPE_PUNCTUAL}":"0u","{LIGHTSHAPE_RECT}":"1u","{LIGHTSHAPE_DISK}":"2u","{LIGHTSHAPE_SPHERE}":"3u","{LIGHT_COLOR_DIVIDER}":wl+".0"},Hc=(e,t)=>Object.keys(e).map((i=>"#define "+t+i+" "+e[i])).join("\n");_h.lightBufferDefinesPS=Oc.lightBufferDefinesPS="\n\n    "+Hc(Uc,"CLUSTER_TEXTURE_")+"\n    "+Hc(Vc,"")+"\n";class Gc{destroy(){var e;null==(e=this.lightsTexture)||e.destroy(),this.lightsTexture=null}createTexture(e,t,i,s,r){return new ur(e,{name:r,width:t,height:i,mipmaps:!1,format:s,addressU:1,addressV:1,type:_s,magFilter:0,minFilter:0,anisotropy:1})}setBounds(e,t){this.boundsMin.copy(e),this.boundsDelta.copy(t)}uploadTextures(){this.lightsTexture.lock().set(this.lightsFloat),this.lightsTexture.unlock()}updateUniforms(){this._lightsTextureId.setValue(this.lightsTexture)}getSpotDirection(e,t){t._node.getWorldTransform().getY(e).mulScalar(-1),e.normalize()}getLightAreaSizes(e){var t=e._node.getWorldTransform();return t.transformVector(Nc,Fc),Bc[0]=Fc.x,Bc[1]=Fc.y,Bc[2]=Fc.z,t.transformVector(zc,Fc),Bc[3]=Fc.x,Bc[4]=Fc.y,Bc[5]=Fc.z,Bc}addLightData(e,t){var i=2===e._type,s=e.atlasViewportAllocated,r=this.cookiesEnabled&&!!e._cookie&&s,n=this.areaLightsEnabled&&0!==e.shape,a=this.shadowsEnabled&&e.castShadows&&s,o=e._node.getPosition(),l=null,h=null;i?a?l=e.getRenderData(null,0).shadowMatrix:r&&(l=kc.evalSpotCookieMatrix(e)):(a||r)&&(h=e.atlasViewport);var c=this.lightsFloat,d=this.lightsUint,u=t*this.lightsTexture.width*4;c[u+4*Uc.POSITION_RANGE+0]=o.x,c[u+4*Uc.POSITION_RANGE+1]=o.y,c[u+4*Uc.POSITION_RANGE+2]=o.z,c[u+4*Uc.POSITION_RANGE+3]=e.attenuationEnd;var f=e.clusteredData;if(d[u+4*Uc.COLOR_ANGLES_BIAS+0]=f[0],d[u+4*Uc.COLOR_ANGLES_BIAS+1]=f[1],d[u+4*Uc.COLOR_ANGLES_BIAS+2]=f[2],e.castShadows){var p=e.getRenderData(null,0),m=e._getUniformBiasValues(p),g=li.float2Half(m.bias),v=li.float2Half(m.normalBias);d[u+4*Uc.COLOR_ANGLES_BIAS+3]=g|v<<16}if(i&&(this.getSpotDirection(Fc,e),c[u+4*Uc.DIRECTION_FLAGS+0]=Fc.x,c[u+4*Uc.DIRECTION_FLAGS+1]=Fc.y,c[u+4*Uc.DIRECTION_FLAGS+2]=Fc.z),d[u+4*Uc.DIRECTION_FLAGS+3]=e.getClusteredFlags(a,r),l)for(var _=l.data,b=0;b<16;b++)c[u+4*Uc.PROJ_MAT_0+b]=_[b];if(h&&(c[u+4*Uc.ATLAS_VIEWPORT+0]=h.x,c[u+4*Uc.ATLAS_VIEWPORT+1]=h.y,c[u+4*Uc.ATLAS_VIEWPORT+2]=h.z/3),n){var y=this.getLightAreaSizes(e);c[u+4*Uc.AREA_DATA_WIDTH+0]=y[0],c[u+4*Uc.AREA_DATA_WIDTH+1]=y[1],c[u+4*Uc.AREA_DATA_WIDTH+2]=y[2],c[u+4*Uc.AREA_DATA_HEIGHT+0]=y[3],c[u+4*Uc.AREA_DATA_HEIGHT+1]=y[4],c[u+4*Uc.AREA_DATA_HEIGHT+2]=y[5]}}constructor(e){this.areaLightsEnabled=!1,this.device=e,this.cookiesEnabled=!1,this.shadowsEnabled=!1,this.areaLightsEnabled=!1,this.maxLights=255;var t=Uc.COUNT;this.lightsFloat=new Float32Array(4*t*this.maxLights),this.lightsUint=new Uint32Array(this.lightsFloat.buffer),this.lightsTexture=this.createTexture(this.device,t,this.maxLights,ki,"LightsTexture"),this._lightsTextureId=this.device.scope.resolve("lightsTexture"),this.invMaxColorValue=0,this.invMaxAttenuation=0,this.boundsMin=new hi,this.boundsDelta=new hi}}var Wc=new hi,jc=new hi,qc=new hi,Xc=new Ci;class Kc{constructor(){this.light=null,this.min=new hi,this.max=new hi}}class Yc{set maxCellLightCount(e){e!==this._maxCellLightCount&&(this._maxCellLightCount=e,this._cellsDirty=!0)}get maxCellLightCount(){return this._maxCellLightCount}set cells(e){Wc.copy(e).floor(),this._cells.equals(Wc)||(this._cells.copy(Wc),this._cellsLimit.copy(Wc).sub(hi.ONE),this._cellsDirty=!0)}get cells(){return this._cells}destroy(){this.lightsBuffer.destroy(),this.releaseClusterTexture()}releaseClusterTexture(){this.clusterTexture&&(this.clusterTexture.destroy(),this.clusterTexture=null)}registerUniforms(e){this._clusterSkipId=e.scope.resolve("clusterSkip"),this._clusterMaxCellsId=e.scope.resolve("clusterMaxCells"),this._clusterWorldTextureId=e.scope.resolve("clusterWorldTexture"),this._clusterTextureSizeId=e.scope.resolve("clusterTextureSize"),this._clusterTextureSizeData=new Float32Array(3),this._clusterBoundsMinId=e.scope.resolve("clusterBoundsMin"),this._clusterBoundsMinData=new Float32Array(3),this._clusterBoundsDeltaId=e.scope.resolve("clusterBoundsDelta"),this._clusterBoundsDeltaData=new Float32Array(3),this._clusterCellsCountByBoundsSizeId=e.scope.resolve("clusterCellsCountByBoundsSize"),this._clusterCellsCountByBoundsSizeData=new Float32Array(3),this._clusterCellsDotId=e.scope.resolve("clusterCellsDot"),this._clusterCellsDotData=new Float32Array(3),this._clusterCellsMaxId=e.scope.resolve("clusterCellsMax"),this._clusterCellsMaxData=new Float32Array(3)}updateParams(e){e&&(this.cells=e.cells,this.maxCellLightCount=e.maxLightsPerCell,this.lightsBuffer.cookiesEnabled=e.cookiesEnabled,this.lightsBuffer.shadowsEnabled=e.shadowsEnabled,this.lightsBuffer.areaLightsEnabled=e.areaLightsEnabled)}updateCells(){if(this._cellsDirty){this._cellsDirty=!1;var e=this._cells.x,t=this._cells.y,i=this._cells.z,s=e*t*i,r=this.maxCellLightCount*s,n=Math.ceil(Math.sqrt(r));n=ti.roundUp(n,this.maxCellLightCount);var a=Math.ceil(r/n);this._clusterCellsMaxData[0]=e,this._clusterCellsMaxData[1]=t,this._clusterCellsMaxData[2]=i,this._clusterCellsDotData[0]=this.maxCellLightCount,this._clusterCellsDotData[1]=e*i*this.maxCellLightCount,this._clusterCellsDotData[2]=e*this.maxCellLightCount,this.clusters=new Uint8ClampedArray(r),this.counts=new Int32Array(s),this._clusterTextureSizeData[0]=n,this._clusterTextureSizeData[1]=1/n,this._clusterTextureSizeData[2]=1/a,this.releaseClusterTexture(),this.clusterTexture=this.lightsBuffer.createTexture(this.device,n,a,52,"ClusterTexture")}}uploadTextures(){this.clusterTexture.lock().set(this.clusters),this.clusterTexture.unlock(),this.lightsBuffer.uploadTextures()}updateUniforms(){this._clusterSkipId.setValue(this._usedLights.length>1?0:1),this.lightsBuffer.updateUniforms(),this._clusterWorldTextureId.setValue(this.clusterTexture),this._clusterMaxCellsId.setValue(this.maxCellLightCount);var e=this.boundsDelta;this._clusterCellsCountByBoundsSizeData[0]=this._cells.x/e.x,this._clusterCellsCountByBoundsSizeData[1]=this._cells.y/e.y,this._clusterCellsCountByBoundsSizeData[2]=this._cells.z/e.z,this._clusterCellsCountByBoundsSizeId.setValue(this._clusterCellsCountByBoundsSizeData),this._clusterBoundsMinData[0]=this.boundsMin.x,this._clusterBoundsMinData[1]=this.boundsMin.y,this._clusterBoundsMinData[2]=this.boundsMin.z,this._clusterBoundsDeltaData[0]=e.x,this._clusterBoundsDeltaData[1]=e.y,this._clusterBoundsDeltaData[2]=e.z,this._clusterTextureSizeId.setValue(this._clusterTextureSizeData),this._clusterBoundsMinId.setValue(this._clusterBoundsMinData),this._clusterBoundsDeltaId.setValue(this._clusterBoundsDeltaData),this._clusterCellsDotId.setValue(this._clusterCellsDotData),this._clusterCellsMaxId.setValue(this._clusterCellsMaxData)}evalLightCellMinMax(e,t,i){t.copy(e.min),t.sub(this.boundsMin),t.div(this.boundsDelta),t.mul2(t,this.cells),t.floor(),i.copy(e.max),i.sub(this.boundsMin),i.div(this.boundsDelta),i.mul2(i,this.cells),i.ceil(),t.max(hi.ZERO),i.min(this._cellsLimit)}collectLights(e){var t=this.lightsBuffer.maxLights,i=this._usedLights,s=1;e.forEach((e=>{var r,n=!!(3&e.mask),a=2===e.type&&0===e._outerConeAngle;e.enabled&&0!==e.type&&e.visibleThisFrame&&e.intensity>0&&n&&!a&&(s<t&&(s<i.length?r=i[s]:(r=new Kc,i.push(r)),r.light=e,e.getBoundingBox(Xc),r.min.copy(Xc.getMin()),r.max.copy(Xc.getMax()),s++))})),i.length=s}evaluateBounds(){var e=this._usedLights,t=this.boundsMin,i=this.boundsMax;if(e.length>1){t.copy(e[1].min),i.copy(e[1].max);for(var s=2;s<e.length;s++)t.min(e[s].min),i.max(e[s].max)}else t.set(0,0,0),i.set(1,1,1);this.boundsDelta.sub2(i,t),this.lightsBuffer.setBounds(t,this.boundsDelta)}updateClusters(e){this.counts.fill(0),this.clusters.fill(0),this.lightsBuffer.areaLightsEnabled=!!e&&e.areaLightsEnabled;for(var t=this._cells.x,i=this._cells.z,s=this.counts,r=this._maxCellLightCount,n=this.clusters,a=this.maxCellLightCount,o=this._usedLights,l=1;l<o.length;l++){var h=o[l],c=h.light;this.lightsBuffer.addLightData(c,l),this.evalLightCellMinMax(h,jc,qc);for(var d=jc.x,u=qc.x,f=jc.y,p=qc.y,m=jc.z,g=qc.z,v=d;v<=u;v++)for(var _=m;_<=g;_++)for(var b=f;b<=p;b++){var y=v+t*(_+b*i),x=s[y];x<r&&(n[a*y+x]=l,s[y]=x+1)}}}update(e,t){void 0===t&&(t=null),this.updateParams(t),this.updateCells(),this.collectLights(e),this.evaluateBounds(),this.updateClusters(t),this.uploadTextures()}activate(){this.updateUniforms()}constructor(e){this.device=e,this.name="Untitled",this.reportCount=0,this.boundsMin=new hi,this.boundsMax=new hi,this.boundsDelta=new hi,this._cells=new hi(1,1,1),this._cellsLimit=new hi,this.cells=this._cells,this.maxCellLightCount=4,this._usedLights=[],this._usedLights.push(new Kc),this.lightsBuffer=new Gc(e),this.registerUniforms(e)}}var Qc=null,Jc=()=>{if(!Qc){var e=atob("muPIHORMLNDCz4DxVR/ZvYfAUVEFR47KRIC4nwAAAAAP7WxlhD6Ci+2HCe7BF8jRAPZwdH2UPpI5PdLCJdkvG4UTaNDJ/0crAzne71GCrb4kbdMjjCEGzdX6fNxDMLJq5xkeoIVTdfiZkodEeArmZmp/FQzFjD4x8iOW7Dg64n+3mWqyEwLxXT8zoJXfbw8QJKDCaarUYyTlMzNFHbgUe9IQV7g4YOgtSKpIFZJ0qERm7u4PpmiF89ktHWCywaGmD6h+hfh2/Zd8KYlKqqo4Cem4T42bT/Z9FpCQF1hhSjfBzZ5XFn/y3jegWC6u86KuELRundQS/1Rp+XuKKGIgRv3CvP5y749yqLlFO495JOT3+f2CXgd71npU0/KjjpkZucbJ5m78IVyuSrSozc9jgBUhDrz0hFsyb7LFUH9//wJbBgLdNWJZObfKxrNt8TliLA9w9sXFv6g26iXpf6r/BqcAusj/QzGBZuoUGeEtw8BCXCZ3jUiw4hvM18ZVqlUD3C40LAFXW6FRjuAZGRNstb0/qVk4skwyT+MHrvRorI4rKHVMWZmKyAkzL/78u/9pMQuX14pZN50b2PHn6fRxeaCQLsfT4dpvIkWWFuFVENZIh+8xgR6lU+85W0PPdAu1j99kcCG40JBQa4JMyRzq6qriOBLtqF87vpCJan0WEduVr/mOYkS00urVA0mA6M3031+GmGmW48PaJDYOEIb3bIXWPaLoAOEinX1TN3+/vwhG6nqJu0TdHpedS7QsGZIoxH3nQYYjQP1jmbahlbNngw5ogsGk1y50XZyUmQBY+/JBJ3Unu4dApm+WmPwHPU9gLb+4mHh4BiY6M86pq+WeTyWdI3s0CXPEtHGXZ8zMZgUoyRomBi1VdazzuN+WOmQ9Pa0Z0tlNopUi8AJ4x2Xn4mmOKEbXLxlbVsWu8XhuDGYFOGCRVdSqDPXrHU5SDdUlti3k5///SBwzTMwK3L4a1H7w4lnpEas6////AfX8asyIBfeFXVJ3tgvxQ/blZuUKyIODIfr/UzdWNu7pciLBpdZRZ4pIfZ1R6szq+XNxkGG///8EZFpu7VHAhFWqHEOrB9unw+YQa5o8/9IR/V5/zq+986rJSyfgJKt2u9hxU1wzyQWPjJGvzG9+eWWxGFOHVKqI4jBQALwZZswesnvZ2UmmkEXdiRpz8B+oWE7PY70ZTMndisYSXg2TqoI+3y9BxbnY2Y4EfbdcRhAvG59NqDENNYbxKvK5HJfPG5M+Wi2AcpLVJrD6caiEOzgSoVNSgQK8fm2M3zGcF4xtClv/8Hs9oD7C3jitTATYNQxmKqKf1LhIxzf1bmfiNn7UKFmcJu4sLqVLwxGSue3taBEyknkw5hXTsUCvqmmL/f8n/w0giR7Hu/9EHvpkz3yuu64TioMkzdTJ30i0+hFnQqW1+v9mMwq+z9qGX0UFu9MomvVG2xod6vc12AAAAACq7sGa5qptFR0jF3nQt/D+7PibKYahaxP3hEixPbGi9nwNf2LAa7LkEZRKxzXeCD64Xpii5n+8Kpg8eHIv7AWXZltgMoGltmoJ0XGdOCL8WkzphvR9N2o3ARSZ42l5e5Pe4B58MCRlP3EKv+mcloknH+fto5BWsmEutW6KvjOVsznFCktkSczVk4aGvj9VXlRcLeDoKG8RkBgdcNG2bf8HUL4MT2DM+ar7NImJhKpxakX4Vk0CnP+/XNhl5UsP0lXgeZXPoDBMSW5An+DXlTCO5FQGwSPYwHLKYVIimEdAoVe49rQLaaNcye5LxU2/c5TijTgJtD5eQQIe1snxauj5jZsxJBUJdoP/zqpjqv8qBruoPsVsP8N44PCUW5Dd0DzqjSS/Dl5mI9cn1w2ndN/0KAEm1QAAAACwu6KM/083IBbH5bPa/9oHUwcU8I9v3j6/v18QYammrf+P6VL///8BrpuM3fOLCxaLNOFNF1zPbPYTP65ni6njft4eVcyrVXRQFrs52tr35StiSp55edVDCBC0H5rIfac6nzUwxQSt7y15QoKb+5zebEQUmVbrPjXuUa19Ey7sqXMiSUKHaw72PJKDdrutJoQr3u6lEYJ8K0MakWKj9zjTFi4X94TsKYco0GrLeB60M6D8M/80rhXUW8iMequg8y5F838WI0+gp3GBN5Kj/xIOxTWQuUaPV/LwvARr1VH93BFgGZR1MFW0Ua30GbYmdnAgo9VWy8SQtpDUgGE2r2zq2eTEMCL7sMKmE1hchVhuF/TCq9iXKEm86kzOf3Rp9ZnCxbpDUj+FKNxVyXe6pVZkRXv/m95SnB/EB8aME29N85MtAcDoXWlor8De2Q5Dg1tar+8wgiZufbMam81j//ASUohoR/zSh2KG4bvT6mkIPz6C5/98DC3LaWlaEZ1zA5JORZRu6J/a0GY285sEYzw71YqOT1ihAG0z5SDt1xNiDQWZdFpndArp6xWhqSDkRb4kSJEHb9liPvw7uLV/6i5MVf//A9Qjr8xkAEUh+KDI+zdtJ68d6MBOktg1iyp/SCq8O9f5pbamn1VVVQPRTWqNBvhQKa07s6P0lc9Luu/3gw4HeyOUfz8MxMwV4UQhua+t9cr4bz/nIB2wnDSK1K7I94M+s6C84htaX/CNlMQUSs2KJO+yaebfTbkNX5yWcqEJevo0vbKUiETuFXiL019A3E+lmsyZMwXrXLLiQAZ5t9+jI3JobhJTMiDH5ZOQ+8Jau5555NMjHSscP9qCVaa40doh+1a3Ukf6jqBmLddgh79/fwTfCyqiuldNkUoy+nUp+4nerwg0OjtGv2x485PJOJvUEokNhYIdWjpx7BWk0VZGWOp3jSFTJ2bnu6KCduZtG/UcBC9RZ3W/jMSfSMw4Etr/DoD/XYP2V5Ovw+YoM3F5g2dGLdvuG6ZkVGLE6Dk5Zr+sdSyGliJP1y2OFf/KFO0RWO+3gsGhesTnfZVpTd8/HwgO216gwaqo+vY3TljfJWowY+i0p0Os4SLn/1wLqDHMlszggmT/D8MRFzs+pLv6LNJSsNZ/r41mWi/rF6ZcKp/yzJdK0VU44hskq3RGpgO6mIpJDsf/mZkFrz0yYOMLbuaj/wp1v7JMFM5eqvBhmTd7U8frQAtHtys4zgpjZmzUhOVTfNNLifElGXADlqHGKrkBT/nYwX8ZRm3RjvyPvjKyEqEGKUpVnvOGx+NKPHiWM//ZDpDVGvvrjmk8RPF/wiYZD3+Us8YCXjrVOfjdd1UPAfjLp8jgSn4me7DPTpz1Ggy9XL80guFO7ECT10AvILKfD18Qx+KY/f8aRqu0oOO8hfKRFZa9PUJwCsp6VdZz6LFkm2b9Pl2LIifCwzRy7TpdG2uAtOxP2OemY26bJMa9ZGSLIRlMsgpDpnDJwd0oa5pQ13x1hrHf52HpulUWonGWsfXZbSQYKu9bnEN76ciQih0opN3deDVrbrxorfVlnCmL1R9zq3ePGWIv21c7pW8kEiFTM5JX8dAw867s/60cf79/BH+MDFCZBHlz1L+qGOJf/1txhhmrf3//As+RIJwevDb+fgNXVeHw67QptZegayhrEwr5Gy+EPo1RLaMtPbqOZYoVzXzwzjMFWZxyUG9YUIf6////AQWy84iAygLk9COtXt92+0mT/xg0zMzMBeLkb8y9SL2TDXgSX422hDgpGNLJyuPioA+YJ91G8znrpNqHkwYyscaJDEc9Vc+j4cXle3hvcd2JqDQH2lBZxDn6mUTs0b75raMvbs727codX01Anj8f3wir9P2xQaQ22v/TxCMglKDFoTjaP01XTLgxnTvPv02JgEUrW6UDgOnobFpLdvKdlypgIzPcq14fgXU5tvVW0FEs7VRlsG1IyA69fN4n+awHhT34cE+xUvdj86C8LgAsFheTjI9Ht9EyYAAAAAAVBVKRx2wLgUTI0/2QfyJo2riRw3JDqzEShmx/Lifo6mRkQVbS7X53t+EvKxcXogtdts31e9MRHdcHgsA8rt4/mt2unlzQ/wsU8Gu7+W6Oj7eD8EQdDp5XlCsVaS/AV/t5ZpPOHR3rGpyAJe9IPV+xMrBL1Oz/8MQhFs31h0N1cVnq371uqIJYHyafKH1jteAK3VpMXBcuC+yt0ZeKyRUY4QhdrJJ4tJ1wg3Hu6kDsbovxupTMkGdRrm8oZSoYPbJ+PwH/xotgTdkA1205vUEfnqkI04T/fnnd1fiZW5AwNcggd7fi4j5zasmcntZexIxqFZQMzMJpfndmI5jn17cgn5EV5t9XN0C///8Q9wlJpMGXdoiaMTG2sVyHQsn8mWRISCLNG777S0OuDRP2GlLcJ2UeOg7Fo8hTNPeJ//iTJhyqxhKRUntdXOihq2wfKfH///8B0GGrwT+fSOQRdctKxjjGCSS11d6BlQ9BDfE0J6Z25FaNTKGpFKNCMr2G/041KpWwBLVe1k08vncseQbKZdXi8x1t9XA45U/Wd43D9wAh3Tal0aiLVzGPusOZ1F+W3TWoqlX/A95+dNef11TsuGful+ctGssldk3fqpfqh+43XTxL42+leSHoF/dWHYGX6maqUEuLX7UB+r/6Llr4LKocbVIeu+hB9QTPfz9fCP8RyWmX4SmbhMFsNtCijV7lVcwejLKlvl0GfCndnWV7/39VBrtTRuUx92oke3GBgKkC5fdGK0YvNK+xenKaDmsHDjNFUM3NMz3ZiXXFuLgojosPVCDEl2W5BjX3Ms+j0GSqACHmh0+RPWyuNm/Qe8vFf9AW7N1uRaxWirrUytqEJnJ4/Flm8hSoiZ2NQBsS6w/yQlC4gCaFo8q4nyY6AFdo4hiwhBXzbNKKvZvktCjSCukRR/BbYVbNwZi2Yh3hGodEacLW8qijiWJODf0P2bhfaiPspPT4lYJBgi/KfcFwCfvyUIgkJOv///8CG/JEepRBLaMFE+2TgrqsJXOVOWHt6g/bFwVLLMVBsMR50dis/39/AlBX+/rMTJkUQrnlxpR2iu0Tp8tATkRYGmDIrcAiRP8PjoWIlb7/0ecTdSCE9Y58+a+n/FovJQTVF4F2jAxMZhTgrM/KVS5BQu6bVbkWY5HXnxRshks3urDdW4RkWp4M4TeLmFK5KF/uHkkiO5Kv96RioH984v/CSDBnG+BwlnU9B+o7Y+0X0Nob+0pLsStxjvPXMy2eCpzhOWV4XbObBHN4UE2sLQ/DIqXhOzxVf38GlTi6aG7EnePO7TRJm9yOfUUcqq1I2iQHrVDqn3TUNRi/lMw8KbMW/3/nqCz/Ef8PoW5Qxcz2yHR/f78EPB2Stbd+ZFmfNTUYILzsb9YNhpaHcaymYrBiNHmFE3Y4ccYJ25Prqm7zHobGHED8/93ZNlWro9vcKivGZs31UiK1k5zjUhexUgbqJb+fUTjxce/7Zly8a5KMC1fX5nfjPgibdvzbXV1jRT2asXvmSAusaLdq1TSIJ8fXINk5AtT34EWPAsfP9IFQqM5K11O6saoHJA==");Qc=Uint8Array.from(e,(e=>e.charCodeAt(0)))}},$c=()=>(Jc(),Qc);class Zc{_next(){this.seed=(this.seed+4)%Qc.length}value(){return this._next(),Qc[this.seed]/255}vec4(e){return void 0===e&&(e=new ui),this._next(),e.set(Qc[this.seed],Qc[this.seed+1],Qc[this.seed+2],Qc[this.seed+3]).mulScalar(1/255)}constructor(e=0){this.seed=0,this.seed=4*e,Jc()}}var ed=[new hi(-1,0,0),new hi(1,0,0),new hi(0,-1,0),new hi(0,1,0),new hi(0,0,-1),new hi(0,0,1)];class td{update(e,t){for(var i=this.colors,{r:s,g:r,b:n}=e,a=0;a<6;a++)i[3*a]=s,i[3*a+1]=r,i[3*a+2]=n;for(var o=0;o<t.length;o++){var l=t[o];if(0===l._type)for(var h=0;h<6;h++){var c=Math.max(ed[h].dot(l._direction),0)*l._intensity,d=l._color;i[3*h]+=d.r*c,i[3*h+1]+=d.g*c,i[3*h+2]+=d.b*c}}}constructor(){this.colors=new Float32Array(18)}}var id=new hr,sd=e=>id.get(e,(()=>{var t=$c(),i=Math.sqrt(t.length/4);return((e,t,i,s)=>{var r=new ur(e,{name:""+t+i,width:i,height:i,format:7,addressU:0,addressV:0,type:_s,magFilter:0,minFilter:0,anisotropy:1,mipmaps:!1});return r.lock().set(s),r.unlock(),r})(e,"BlueNoise",i,t)}));class rd{destroy(){this.texture&&(this.texture.destroy(),this.texture=null);for(var e=this.renderTargets,t=0;t<e.length;t++)e[t].destroy();this.renderTargets.length=0}static create(e,t){return 1===t._type?this.createCubemap(e,t._shadowResolution,t._shadowType):this.create2dMap(e,t._shadowResolution,t._shadowType)}static createAtlas(e,t,i){for(var s=this.create2dMap(e,t,i),r=s.renderTargets,n=r[0],a=0;a<5;a++)r.push(n);return s}static create2dMap(e,t,i){var s,r=Il.get(i),n=r.format;n===Oi&&!e.textureFloatRenderable&&e.textureHalfFloatRenderable&&(n=50);var a=null==(s=ji.get(n))?void 0:s.name,o=1;3===i&&(o=e.extTextureFloatLinear?1:0),6===i&&(o=0);var l=new ur(e,{format:n,width:t,height:t,mipmaps:!1,minFilter:o,magFilter:o,addressU:1,addressV:1,name:"ShadowMap2D_"+a}),h=null;return(null==r?void 0:r.pcf)?(l.compareOnRead=!0,l.compareFunc=1,h=new Wr({depthBuffer:l})):h=new Wr({colorBuffer:l,depth:!0}),e.isWebGPU&&(h.flipY=!0),new rd(l,[h])}static createCubemap(e,t,i){var s,r=Il.get(i),n=null==(s=ji.get(r.format))?void 0:s.name,a=6===i,o=a?0:1,l=new ur(e,{format:null==r?void 0:r.format,width:t,height:t,cubemap:!0,mipmaps:!1,minFilter:o,magFilter:o,addressU:1,addressV:1,name:"ShadowMapCube_"+n});a||(l.compareOnRead=!0,l.compareFunc=1);for(var h=[],c=0;c<6;c++)a?h.push(new Wr({colorBuffer:l,face:c,depth:!0})):h.push(new Wr({depthBuffer:l,face:c}));return new rd(l,h)}constructor(e,t){this.texture=e,this.cached=!1,this.renderTargets=t}}var nd=[],ad=[],od=new ui,ld=new ui;class hd{constructor(e){this.size=Math.floor(1024*e.w),this.used=!1,this.lightId=-1,this.rect=e}}class cd{destroy(){this.destroyShadowAtlas(),this.destroyCookieAtlas()}destroyShadowAtlas(){var e;null==(e=this.shadowAtlas)||e.destroy(),this.shadowAtlas=null}destroyCookieAtlas(){var e,t;null==(e=this.cookieAtlas)||e.destroy(),this.cookieAtlas=null,null==(t=this.cookieRenderTarget)||t.destroy(),this.cookieRenderTarget=null}allocateShadowAtlas(e,t){var i;void 0===t&&(t=0);var s=null==(i=this.shadowAtlas)?void 0:i.texture.format,r=Il.get(t).format;if(!this.shadowAtlas||this.shadowAtlas.texture.width!==e||s!==r){this.version++,this.destroyShadowAtlas(),this.shadowAtlas=rd.createAtlas(this.device,e,t),this.shadowAtlas.cached=!0;var n=4/this.shadowAtlasResolution;this.scissorVec.set(n,n,-2*n,-2*n)}}allocateCookieAtlas(e){this.cookieAtlas.width!==e&&(this.cookieRenderTarget.resize(e,e),this.version++)}allocateUniforms(){this._shadowAtlasTextureId=this.device.scope.resolve("shadowAtlasTexture"),this._shadowAtlasParamsId=this.device.scope.resolve("shadowAtlasParams"),this._shadowAtlasParams=new Float32Array(2),this._cookieAtlasTextureId=this.device.scope.resolve("cookieAtlasTexture")}updateUniforms(){var e=this.shadowAtlas.renderTargets[0].depthBuffer;this._shadowAtlasTextureId.setValue(e),this._shadowAtlasParams[0]=this.shadowAtlasResolution,this._shadowAtlasParams[1]=this.shadowEdgePixels,this._shadowAtlasParamsId.setValue(this._shadowAtlasParams),this._cookieAtlasTextureId.setValue(this.cookieAtlas)}subdivide(e,t){var i=t.atlasSplit;if(!i){var s=Math.ceil(Math.sqrt(e));(i=ad)[0]=s,i.length=1}var r,n;if(r=i,n=this.atlasSplit,r.length!==n.length||!r.every(((e,t)=>e===n[t]))){this.version++,this.slots.length=0,this.atlasSplit.length=0,this.atlasSplit.push(...i);var a=this.atlasSplit[0];if(a>1)for(var o=1/a,l=0;l<a;l++)for(var h=0;h<a;h++){var c=new ui(l*o,h*o,o,o),d=this.atlasSplit[1+l*a+h];if(d>1)for(var u=0;u<d;u++)for(var f=0;f<d;f++){var p=o/d,m=new ui(c.x+u*p,c.y+f*p,p,p);this.slots.push(new hd(m))}else this.slots.push(new hd(c))}else this.slots.push(new hd(new ui(0,0,1,1)));this.slots.sort(((e,t)=>t.size-e.size))}}collectLights(e,t){var i=t.cookiesEnabled,s=t.shadowsEnabled,r=!1,n=!1,a=nd;a.length=0;return(i||s)&&(e=>{for(var t=0;t<e.length;t++){var o=e[t];if(o.visibleThisFrame){var l=s&&o.castShadows,h=i&&!!o.cookie;r||(r=l),n||(n=h),(l||h)&&a.push(o)}}})(e),a.sort(((e,t)=>t.maxScreenSize-e.maxScreenSize)),r&&this.allocateShadowAtlas(this.shadowAtlasResolution,t.shadowType),n&&this.allocateCookieAtlas(this.cookieAtlasResolution),(r||n)&&this.subdivide(a.length,t),a}setupSlot(e,t){e.atlasViewport.copy(t);for(var i=e.numShadowFaces,s=0;s<i;s++)if(e.castShadows||e._cookie){if(od.copy(t),ld.copy(t),2===e._type&&od.add(this.scissorVec),1===e._type){var r=od.z/3,n=this.cubeSlotsOffsets[s];od.x+=r*n.x,od.y+=r*n.y,od.z=r,od.w=r,ld.copy(od)}if(e.castShadows){var a=e.getRenderData(null,s);a.shadowViewport.copy(od),a.shadowScissor.copy(ld)}}}assignSlot(e,t,i){e.atlasViewportAllocated=!0;var s=this.slots[t];s.lightId=e.id,s.used=!0,i&&(e.atlasSlotUpdated=!0,e.atlasVersion=this.version,e.atlasSlotIndex=t)}update(e,t){this.shadowAtlasResolution=t.shadowAtlasResolution,this.cookieAtlasResolution=t.cookieAtlasResolution;var i=this.collectLights(e,t);if(i.length>0){for(var s=this.slots,r=0;r<s.length;r++)s[r].used=!1;for(var n=Math.min(i.length,s.length),a=0;a<n;a++){var o=i[a];o.castShadows&&(o._shadowMap=this.shadowAtlas);var l=s[o.atlasSlotIndex];if(o.atlasVersion===this.version&&o.id===(null==l?void 0:l.lightId)){var h=s[o.atlasSlotIndex];h.size!==s[a].size||h.used||this.assignSlot(o,o.atlasSlotIndex,!1)}}for(var c=0,d=0;d<n;d++){for(;c<s.length&&s[c].used;)c++;var u=i[d];u.atlasViewportAllocated||this.assignSlot(u,c,!0);var f=s[u.atlasSlotIndex];this.setupSlot(u,f.rect)}}this.updateUniforms()}constructor(e){this.device=e,this.version=1,this.shadowAtlasResolution=2048,this.shadowAtlas=null,this.shadowEdgePixels=3,this.cookieAtlasResolution=4,this.cookieAtlas=new ur(this.device,{name:"CookieAtlas",width:this.cookieAtlasResolution,height:this.cookieAtlasResolution,format:zi,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1}),this.cookieRenderTarget=new Wr({colorBuffer:this.cookieAtlas,depth:!1,flipY:!0}),this.slots=[],this.atlasSplit=[],this.cubeSlotsOffsets=[new di(0,0),new di(0,1),new di(1,0),new di(1,1),new di(2,0),new di(2,1)],this.scissorVec=new ui,this.allocateShadowAtlas(1),this.allocateCookieAtlas(1),this.allocateUniforms()}}var dd=[];dd[0]={src:1,dst:1,op:2},dd[3]={src:1,dst:0,op:0},dd[2]={src:6,dst:8,op:0,alphaSrc:1},dd[4]={src:1,dst:8,op:0},dd[1]={src:1,dst:1,op:0},dd[6]={src:6,dst:1,op:0},dd[7]={src:4,dst:2,op:0},dd[8]={src:5,dst:1,op:0},dd[5]={src:4,dst:0,op:0},dd[9]={src:1,dst:1,op:3},dd[10]={src:1,dst:1,op:4};var ud=0;class fd{set chunks(e){this._dirtyShader=!0,this._chunks=e}get chunks(){return this._dirtyShader=!0,this._chunks}set depthBias(e){this._depthState.depthBias=e}get depthBias(){return this._depthState.depthBias}set slopeDepthBias(e){this._depthState.depthBiasSlope=e}get slopeDepthBias(){return this._depthState.depthBiasSlope}set redWrite(e){this._blendState.redWrite=e}get redWrite(){return this._blendState.redWrite}set greenWrite(e){this._blendState.greenWrite=e}get greenWrite(){return this._blendState.greenWrite}set blueWrite(e){this._blendState.blueWrite=e}get blueWrite(){return this._blendState.blueWrite}set alphaWrite(e){this._blendState.alphaWrite=e}get alphaWrite(){return this._blendState.alphaWrite}get transparent(){return this._blendState.blend}_updateTransparency(){for(var e=this.transparent,t=this.meshInstances,i=0;i<t.length;i++)t[i].transparent=e}set blendState(e){this._blendState.copy(e),this._updateTransparency()}get blendState(){return this._blendState}set blendType(e){var t,i,s,r=dd[e];this._blendState.setColorBlend(r.op,r.src,r.dst),this._blendState.setAlphaBlend(null!=(t=r.alphaOp)?t:r.op,null!=(i=r.alphaSrc)?i:r.src,null!=(s=r.alphaDst)?s:r.dst);var n=3!==e;this._blendState.blend!==n&&(this._blendState.blend=n,this._updateTransparency()),this._updateMeshInstanceKeys()}get blendType(){if(!this.transparent)return 3;for(var{colorOp:e,colorSrcFactor:t,colorDstFactor:i,alphaOp:s,alphaSrcFactor:r,alphaDstFactor:n}=this._blendState,a=0;a<dd.length;a++){var o=dd[a];if(o.src===t&&o.dst===i&&o.op===e&&o.src===r&&o.dst===n&&o.op===s)return a}return 2}set depthState(e){this._depthState.copy(e)}get depthState(){return this._depthState}set depthTest(e){this._depthState.test=e}get depthTest(){return this._depthState.test}set depthFunc(e){this._depthState.func=e}get depthFunc(){return this._depthState.func}set depthWrite(e){this._depthState.write=e}get depthWrite(){return this._depthState.write}copy(e){var t;for(var i in this.name=e.name,this.alphaTest=e.alphaTest,this.alphaToCoverage=e.alphaToCoverage,this._blendState.copy(e._blendState),this._depthState.copy(e._depthState),this.cull=e.cull,this.stencilFront=null==(t=e.stencilFront)?void 0:t.clone(),e.stencilBack&&(this.stencilBack=e.stencilFront===e.stencilBack?this.stencilFront:e.stencilBack.clone()),this.clearParameters(),e.parameters)e.parameters.hasOwnProperty(i)&&this._setParameterSimple(i,e.parameters[i].data);this.defines.clear(),e.defines.forEach(((e,t)=>this.defines.set(t,e)));var s=e._chunks;for(var r in s)s.hasOwnProperty(r)&&(this._chunks[r]=s[r]);return this}clone(){return(new this.constructor).copy(this)}_updateMeshInstanceKeys(){for(var e=this.meshInstances,t=0;t<e.length;t++)e[t].updateKey()}updateUniforms(e,t){this._dirtyShader&&this.clearVariants()}getShaderVariant(e){}update(){this._definesDirty&&(this._definesDirty=!1,this.clearVariants()),this.dirty=!0}clearParameters(){this.parameters={}}getParameters(){return this.parameters}clearVariants(){this.variants.clear();for(var e=this.meshInstances,t=e.length,i=0;i<t;i++)e[i].clearShaders()}getParameter(e){return this.parameters[e]}_setParameterSimple(e,t){var i=this.parameters[e];i?i.data=t:this.parameters[e]={scopeId:null,data:t}}setParameter(e,t){if(void 0===t&&"object"==typeof e){var i=e;if(i.length){for(var s=0;s<i.length;s++)this.setParameter(i[s]);return}e=i.name,t=i.value}this._setParameterSimple(e,t)}deleteParameter(e){this.parameters[e]&&delete this.parameters[e]}setParameters(e,t){var i=this.parameters;for(var s in void 0===t&&(t=i),t){var r=i[s];r&&(r.scopeId||(r.scopeId=e.scope.resolve(s)),r.scopeId.setValue(r.data))}}setDefine(e,t){var i=!1,{defines:s}=this;void 0!==t&&!1!==t?(i=!s.has(e)||s.get(e)!==t,s.set(e,t)):(i=s.has(e),s.delete(e)),this._definesDirty||(this._definesDirty=i)}getDefine(e){return this.defines.has(e)}destroy(){this.variants.clear();for(var e=0;e<this.meshInstances.length;e++){var t=this.meshInstances[e];if(t.clearShaders(),t._material=null,t.mesh){var i=jh(t.mesh.device);this!==i&&(t.material=i)}}this.meshInstances.length=0}addMeshInstanceRef(e){this.meshInstances.push(e)}removeMeshInstanceRef(e){var t=this.meshInstances,i=t.indexOf(e);-1!==i&&t.splice(i,1)}constructor(){this.meshInstances=[],this.name="Untitled",this.userId="",this.id=ud++,this.variants=new Map,this.defines=new Map,this._definesDirty=!1,this.parameters={},this.alphaTest=0,this.alphaToCoverage=!1,this._blendState=new Sr,this._depthState=new Cr,this.cull=1,this.stencilFront=null,this.stencilBack=null,this._chunks={},this._dirtyShader=!0,this._shaderVersion=0,this._scene=null,this.dirty=!0}}class pd{destroy(){this.clear(),this.cache=null}clear(){this.cache.forEach((e=>{e.forEach((e=>{e.destroy()}))})),this.cache.clear()}getKey(e){return(1===e._type)+"-"+e._shadowType+"-"+e._shadowResolution}get(e,t){var i=this.getKey(t),s=this.cache.get(i);if(s&&s.length)return s.pop();var r=rd.create(e,t);return r.cached=!0,r}add(e,t){var i=this.getKey(e),s=this.cache.get(i);s?s.push(t):this.cache.set(i,[t])}constructor(){this.cache=new Map}}class md extends Do{execute(){this.shadowRenderer.renderFace(this.light,null,this.face,!1)}after(){this.applyVsm&&this.shadowRenderer.renderVsm(this.light,this.shadowCamera)}constructor(e,t,i,s,r){super(e),this.requiresCubemaps=!1,this.shadowRenderer=t,this.light=i,this.face=s,this.applyVsm=r,this.shadowCamera=t.prepareFace(i,null,s),t.setupRenderPass(this,this.shadowCamera,!0)}}class gd{cull(e,t,i){void 0===i&&(i=null);var s=this.renderer.scene.clusteredLightingEnabled;e.visibleThisFrame=!0,s||e._shadowMap||(e._shadowMap=rd.create(this.device,e));for(var r=e._type,n=2===r?1:6,a=0;a<n;a++){var o=e.getRenderData(null,a),l=o.shadowCamera;l.nearClip=e.attenuationEnd/1e3,l.farClip=e.attenuationEnd;var h=l._node,c=e._node;if(h.setPosition(c.getPosition()),2===r)l.fov=2*e._outerConeAngle,h.setRotation(c.getRotation()),h.rotateLocal(-90,0,0);else if(1===r)if(s){var d=2/(this.shadowRenderer.lightTextureAtlas.shadowAtlasResolution*e.atlasViewport.z/3)*this.shadowRenderer.lightTextureAtlas.shadowEdgePixels;l.fov=Math.atan(1+d)*ti.RAD_TO_DEG*2}else l.fov=90;this.renderer.updateCameraFrustum(l),this.shadowRenderer.cullShadowCasters(t,e,o.visibleCasters,l,i)}}prepareLights(e,t){for(var i,s=0;s<t.length;s++){var r=t[s];if(this.shadowRenderer.needsShadowRendering(r)&&r.atlasViewportAllocated){e.push(r);for(var n=0;n<r.numShadowFaces;n++)i=this.shadowRenderer.prepareFace(r,null,n)}}return i}buildNonClusteredRenderPasses(e,t){for(var i=0;i<t.length;i++){var s=t[i];if(this.shadowRenderer.needsShadowRendering(s))for(var r=2===s._type,n=s.numShadowFaces,a=0;a<n;a++){var o=new md(this.device,this.shadowRenderer,s,a,r);e.addRenderPass(o)}}}constructor(e,t){this.shadowLights=[],this.renderer=e,this.shadowRenderer=t,this.device=e.device}}class vd extends Do{execute(){for(var{light:e,camera:t,shadowRenderer:i,allCascadesRendering:s}=this,r=e.numShadowFaces,n=e.shadowUpdateOverrides,a=0;a<r;a++)0!==(null==n?void 0:n[a])&&i.renderFace(e,t,a,!s),1===(null==n?void 0:n[a])&&(n[a]=0)}after(){this.shadowRenderer.renderVsm(this.light,this.camera)}constructor(e,t,i,s,r){super(e),this.shadowRenderer=t,this.light=i,this.camera=s,this.allCascadesRendering=r}}var _d=new Ci,bd=new hi,yd=new _i,xd=[new hi,new hi,new hi,new hi,new hi,new hi,new hi,new hi],Sd={min:0,max:0};function wd(e,t,i){xd[0].x=xd[1].x=xd[2].x=xd[3].x=t.x,xd[1].y=xd[3].y=xd[7].y=xd[5].y=t.y,xd[2].z=xd[3].z=xd[6].z=xd[7].z=t.z,xd[4].x=xd[5].x=xd[6].x=xd[7].x=i.x,xd[0].y=xd[2].y=xd[4].y=xd[6].y=i.y,xd[0].z=xd[1].z=xd[4].z=xd[5].z=i.z;for(var s=9999999999,r=-9999999999,n=0;n<8;++n){e.transformPoint(xd[n],xd[n]);var a=xd[n].z;a<s&&(s=a),a>r&&(r=a)}return Sd.min=s,Sd.max=r,Sd}class Td{cull(e,t,i,s){void 0===s&&(s=null),e.visibleThisFrame=!0,e._shadowMap||(e._shadowMap=rd.create(this.device,e));var r=i._nearClip;this.generateSplitDistances(e,r,Math.min(i._farClip,e.shadowDistance));for(var n=e.shadowUpdateOverrides,a=0;a<e.numCascades&&0!==(null==n?void 0:n[a]);a++){var o=e.getRenderData(i,a),l=o.shadowCamera;l.renderTarget=e._shadowMap.renderTargets[0],o.shadowViewport.copy(e.cascades[a]),o.shadowScissor.copy(e.cascades[a]);var h=l._node,c=e._node;h.setPosition(c.getPosition()),h.setRotation(c.getRotation()),h.rotateLocal(-90,0,0);var d=0===a?r:e._shadowCascadeDistances[a-1],u=e._shadowCascadeDistances[a],f=i.getFrustumCorners(d,u);bd.set(0,0,0);for(var p=i.node.getWorldTransform(),m=0;m<8;m++)p.transformPoint(f[m],f[m]),bd.add(f[m]);bd.mulScalar(1/8);for(var g=0,v=0;v<8;v++){var _=f[v].sub(bd).length();_>g&&(g=_)}var b=h.right,y=h.up,x=h.forward,S=.25*e._shadowResolution/g,w=Math.ceil(bd.dot(y)*S)/S,T=Math.ceil(bd.dot(b)*S)/S,C=y.mulScalar(w),E=b.mulScalar(T),A=bd.dot(x),P=x.mulScalar(A);bd.add2(C,E).add(P),h.setPosition(bd),h.translateLocal(0,0,1e6),l.nearClip=.01,l.farClip=2e6,l.orthoHeight=g,this.renderer.updateCameraFrustum(l),this.shadowRenderer.cullShadowCasters(t,e,o.visibleCasters,l,s);for(var D=!0,L=o.visibleCasters,M=0;M<L.length;M++){var I=L[M];D?(D=!1,_d.copy(I.aabb)):_d.add(I.aabb)}yd.copy(h.getWorldTransform()).invert();var R=wd(yd,_d.getMin(),_d.getMax());h.translateLocal(0,0,R.max+.1),l.farClip=R.max-R.min+.2,o.projectionCompensation=g}}generateSplitDistances(e,t,i){e._shadowCascadeDistances.fill(i);for(var s=1;s<e.numCascades;s++){var r=s/e.numCascades,n=t+(i-t)*r,a=t*(i/t)**r,o=ti.lerp(n,a,e.cascadeDistribution);e._shadowCascadeDistances[s-1]=o}}getLightRenderPass(e,t){var i=null;if(this.shadowRenderer.needsShadowRendering(e)){for(var s,r=e.numShadowFaces,n=e.shadowUpdateOverrides,a=!0,o=0;o<r;o++)0===(null==n?void 0:n[o])&&(a=!1),s=this.shadowRenderer.prepareFace(e,t,o);i=new vd(this.device,this.shadowRenderer,e,t,a),this.shadowRenderer.setupRenderPass(i,s,a)}return i}constructor(e,t){this.renderer=e,this.shadowRenderer=t,this.device=e.device}}var Cd=new Set,Ed=new _i,Ad=new _i,Pd=new Float32Array(2),Dd=new ui(1,1,0,0),Ld=new _i;function Md(e,t){return Math.exp(-e*e/(2*t*t))}class Id{static createShadowCamera(e,t,i){var s,r,n=kc.create("ShadowCamera",t,i),a=Il.get(e),o=null!=(s=null==a?void 0:a.vsm)&&s,l=null!=(r=null==a?void 0:a.pcf)&&r;return n.clearColor=o?new ii(0,0,0,0):new ii(1,1,1,1),n.clearDepthBuffer=!0,n.clearStencilBuffer=!1,n.clearColorBuffer=!l,n}_cullShadowCastersInternal(e,t,i){for(var s=e.length,r=0;r<s;r++){var n=e[r];n.castShadow&&(n.cull&&!n._isVisible(i)||(n.visibleThisFrame=!0,t.push(n)))}}cullShadowCasters(e,t,i,s,r){if(i.length=0,r)this._cullShadowCastersInternal(r,i,s);else{for(var n=e.layerList,a=n.length,o=0;o<a;o++){var l=n[o];l._lightsSet.has(t)&&(Cd.has(l)||(Cd.add(l),this._cullShadowCastersInternal(l.shadowCasters,i,s)))}Cd.clear()}i.sort(this.sortCompareShader)}sortCompareShader(e,t){var i=e._sortKeyShadow,s=t._sortKeyShadow;return i===s?t.mesh.id-e.mesh.id:s-i}setupRenderState(e,t){var i=this.renderer.scene.clusteredLightingEnabled?t._isPcf:t._isPcf&&1!==t._type;e.setBlendState(i?this.blendStateNoWrite:this.blendStateWrite),e.setDepthState(t.shadowDepthState),e.setStencilState(null,null)}dispatchUniforms(e,t,i,s){var r=t._node;0!==e._type&&(this.renderer.dispatchViewPos(r.getPosition()),this.shadowMapLightRadiusId.setValue(e.attenuationEnd)),Ed.setTRS(r.getPosition(),r.getRotation(),hi.ONE).invert(),Ad.mul2(t.projectionMatrix,Ed);var n=i.shadowViewport;t.rect=n,t.scissorRect=i.shadowScissor,Ld.setViewport(n.x,n.y,n.z,n.w),i.shadowMatrix.mul2(Ld,Ad),0===e._type&&e._shadowMatrixPalette.set(i.shadowMatrix.data,16*s)}getShadowPass(e){var t,i=e._type,s=e._shadowType,r=null==(t=this.shadowPassCache[i])?void 0:t[s];if(!r){var n="ShadowPass_"+i+"_"+s;r=Th.get(this.device).allocate(n,{isShadow:!0,lightType:i,shadowType:s}),this.shadowPassCache[i]||(this.shadowPassCache[i]=[]),this.shadowPassCache[i][s]=r}return r.index}submitCasters(e,t,i){for(var s=this.device,r=this.renderer,n=r.scene,a=this.getShadowPass(t),o=i.shaderParams,l=i.renderTarget.flipY?-1:1,h=e.length,c=0;c<h;c++){var d=e[c],u=d.mesh;d.ensureMaterial(s);var f=d.material;r.setBaseConstants(s,f),r.setSkinning(s,d),f.dirty&&(f.updateUniforms(s,n),f.dirty=!1),r.setupCullMode(!0,l,d),f.setParameters(s),d.setParameters(s,16);var p=d.getShaderInstance(a,0,n,o,this.viewUniformFormat,this.viewBindGroupFormat),m=p.shader;if(!m.failed){d._sortKeyShadow=m.id,s.setShader(m),r.setVertexBuffers(s,u),r.setMorphing(s,d.morphInstance),this.renderer.setupMeshUniformBuffers(p,d);var g=d.renderStyle;s.setIndexBuffer(u.indexBuffer[g]),r.drawInstance(s,d,u,g),r._shadowDrawCalls++}}}needsShadowRendering(e){var t=e.enabled&&e.castShadows&&0!==e.shadowUpdateMode&&e.visibleThisFrame;return 1===e.shadowUpdateMode&&(e.shadowUpdateMode=0),t&&(this.renderer._shadowMapUpdates+=e.numShadowFaces),t}getLightRenderData(e,t,i){return e.getRenderData(0===e._type?t:null,i)}setupRenderPass(e,t,i){var s=t.renderTarget;e.init(s),e.depthStencilOps.clearDepthValue=1,e.depthStencilOps.clearDepth=i,s.depthBuffer?e.depthStencilOps.storeDepth=!0:(e.colorOps.clearValue.copy(t.clearColor),e.colorOps.clear=i,e.depthStencilOps.storeDepth=!1),e.requiresCubemaps=!1}prepareFace(e,t,i){var s=e._type,r=this.getLightRenderData(e,t,i).shadowCamera,n=0===s?0:i;return r.renderTarget=e._shadowMap.renderTargets[n],r}renderFace(e,t,i,s,r){void 0===r&&(r=!0);var n=this.device,a=this.getLightRenderData(e,t,i),o=a.shadowCamera;this.dispatchUniforms(e,o,a,i);var l=o.renderTarget,h=this.renderer;h.setCameraUniforms(o,l),n.supportsUniformBuffers&&h.setupViewUniformBuffers(a.viewBindGroups,this.viewUniformFormat,this.viewBindGroupFormat,1),r?(h.setupViewport(o,l),s&&h.clear(o)):h.clearView(o,l,!0,!1),this.setupRenderState(n,e),this.submitCasters(a.visibleCasters,e,o)}render(e,t,i){if(void 0===i&&(i=!0),this.needsShadowRendering(e)){for(var s=e.numShadowFaces,r=0;r<s;r++)this.prepareFace(e,t,r),this.renderFace(e,t,r,!0,i);this.renderVsm(e,t)}}renderVsm(e,t){e._isVsm&&e._vsmBlurSize>1&&(this.renderer.scene.clusteredLightingEnabled&&0!==e._type||this.applyVsmBlur(e,t))}getVsmBlurShader(e,t){var i=this.blurVsmShader,s=i[e][t];if(!s){this.blurVsmWeights[t]=function(e){for(var t=(e-1)/6,i=.5*(e-1),s=new Array(e),r=0,n=0;n<e;++n)s[n]=Md(n-i,t),r+=s[n];for(var a=0;a<e;++a)s[a]/=r;return s}(t);var r=_h.fullscreenQuadVS,n="#define SAMPLES "+t+"\n";n+=this.blurVsmShaderCode[e];var a="blurVsm"+e+t;s=Eh(this.device,r,n,a),i[e][t]=s}return s}applyVsmBlur(e,t){var i=this.device;i.setBlendState(Sr.NOBLEND);var s=e.getRenderData(0===e._type?t:null,0).shadowCamera.renderTarget,r=this.renderer.shadowMapCache.get(i,e),n=r.renderTargets[0],a=e.vsmBlurMode,o=e._vsmBlurSize,l=this.getVsmBlurShader(a,o);Dd.z=e._shadowResolution-2,Dd.w=Dd.z,this.sourceId.setValue(s.colorBuffer),Pd[0]=1/e._shadowResolution,Pd[1]=0,this.pixelOffsetId.setValue(Pd),1===a&&this.weightId.setValue(this.blurVsmWeights[o]),Fh(i,n,l,null,Dd),this.sourceId.setValue(n.colorBuffer),Pd[1]=Pd[0],Pd[0]=0,this.pixelOffsetId.setValue(Pd),Fh(i,s,l,null,Dd),this.renderer.shadowMapCache.add(e,r)}initViewBindGroupFormat(){this.device.supportsUniformBuffers&&!this.viewUniformFormat&&(this.viewUniformFormat=new Pn(this.device,[new An("matrix_viewProjection",Is)]),this.viewBindGroupFormat=new lr(this.device,[new rr(Ks,3)]))}frameUpdate(){this.initViewBindGroupFormat()}constructor(e,t){this.shadowPassCache=[],this.device=e.device,this.renderer=e,this.lightTextureAtlas=t;var i=this.device.scope;this.sourceId=i.resolve("source"),this.pixelOffsetId=i.resolve("pixelOffset"),this.weightId=i.resolve("weight[0]"),this.blurVsmShaderCode=[_h.blurVSMPS,"#define GAUSS\n"+_h.blurVSMPS],this.blurVsmShader=[{},{}],this.blurVsmWeights={},this.shadowMapLightRadiusId=i.resolve("light_radius"),this.viewUniformFormat=null,this.viewBindGroupFormat=null,this.blendStateWrite=new Sr,this.blendStateNoWrite=new Sr,this.blendStateNoWrite.setColorWrite(!1,!1,!1,!1)}}var Rd=[];class kd{destroy(){this._empty&&(this._empty.destroy(),this._empty=null),this._allocated.forEach((e=>{e.destroy()})),this._allocated.length=0}get count(){return this._allocated.length}get empty(){if(!this._empty){var e=new Yc(this.device);e.name="ClusterEmpty",e.update([]),this._empty=e}return this._empty}assign(e){var t=this.empty;Rd.push(...this._allocated),this._allocated.length=0,this._clusters.clear();for(var i=e.length,s=0;s<i;s++){var r=e[s].renderActions;if(r)for(var n=r.length,a=0;a<n;a++){var o=r[a];o.lightClusters=null;var l=o.layer;if(l.hasClusteredLights&&l.meshInstances.length){var h,c=l.getLightIdHash(),d=this._clusters.get(c),u=null==d?void 0:d.lightClusters;if(!u)u=null!=(h=Rd.pop())?h:new Yc(this.device),this._allocated.push(u),this._clusters.set(c,o);o.lightClusters=u}o.lightClusters||(o.lightClusters=t)}}Rd.forEach((e=>e.destroy())),Rd.length=0}update(e,t){this.assign(e),this._clusters.forEach((e=>{var i=e.layer;e.lightClusters.update(i.clusteredLightsSet,t)}))}constructor(e){this._empty=null,this._allocated=[],this._clusters=new Map,this.device=e}}var Od=new ui,Fd=[];class Bd extends Do{destroy(){var e,t;null==(e=this._quadRenderer2D)||e.destroy(),this._quadRenderer2D=null,null==(t=this._quadRendererCube)||t.destroy(),this._quadRendererCube=null}static create(e,t){var i=new Bd(e.device,t);return i.init(e),i.colorOps.clear=!1,i.depthStencilOps.clearDepth=!1,i}update(e){var t=this._filteredLights;this.filter(e,t),this.executeEnabled=t.length>0}filter(e,t){for(var i=0;i<e.length;i++){var s=e[i];0!==s._type&&(s.atlasViewportAllocated&&s.atlasSlotUpdated&&s.enabled&&s.cookie&&s.visibleThisFrame&&t.push(s))}}initInvViewProjMatrices(){if(!Fd.length)for(var e=0;e<6;e++){var t=kc.create(null,1,e),i=t.projectionMatrix,s=t.node.getLocalTransform().clone().invert();Fd[e]=(new _i).mul2(i,s).invert()}}get quadRenderer2D(){if(!this._quadRenderer2D){var e=this.device.isWebGPU,t=e?Oc:_h,i=Eh(this.device,t.cookieBlitVS,t.cookieBlit2DPS,"cookieRenderer2d",{vertex_position:Ji},{shaderLanguage:e?Ms:Ls});this._quadRenderer2D=new Rh(i)}return this._quadRenderer2D}get quadRendererCube(){if(!this._quadRendererCube){var e=this.device.isWebGPU,t=e?Oc:_h,i=Eh(this.device,t.cookieBlitVS,t.cookieBlitCubePS,"cookieRendererCube",{vertex_position:Ji},{shaderLanguage:e?Ms:Ls});this._quadRendererCube=new Rh(i)}return this._quadRendererCube}execute(){var e=this.device;e.setBlendState(Sr.NOBLEND),e.setCullMode(0),e.setDepthState(Cr.NODEPTH),e.setStencilState();for(var t=this.renderTarget.colorBuffer.width,i=this._cubeSlotsOffsets,s=this._filteredLights,r=0;r<s.length;r++){var n=s[r],a=n.numShadowFaces,o=a>1?this.quadRendererCube:this.quadRenderer2D;a>1&&this.initInvViewProjMatrices(),this.blitTextureId.setValue(n.cookie);for(var l=0;l<a;l++){if(Od.copy(n.atlasViewport),a>1){var h=Od.z/3,c=i[l];Od.x+=h*c.x,Od.y+=h*c.y,Od.z=h,Od.w=h,this.invViewProjId.setValue(Fd[l].data)}Od.mulScalar(t),o.render(Od)}}s.length=0}constructor(e,t){super(e),this._quadRenderer2D=null,this._quadRendererCube=null,this._filteredLights=[],this._cubeSlotsOffsets=t,this.requiresCubemaps=!1,this.blitTextureId=e.scope.resolve("blitTexture"),this.invViewProjId=e.scope.resolve("invViewProj")}}class Nd extends Do{update(e){var t=this.shadowRendererLocal.shadowLights,i=this.shadowRendererLocal.prepareLights(t,e),s=t.length;this.enabled=s>0,s&&this.shadowRenderer.setupRenderPass(this,i,!1)}execute(){for(var e=this.shadowRendererLocal.shadowLights,t=e.length,i=0;i<t;i++)for(var s=e[i],r=0;r<s.numShadowFaces;r++)this.shadowRenderer.renderFace(s,null,r,!0);e.length=0}constructor(e,t,i){super(e),this.requiresCubemaps=!1,this.shadowRenderer=t,this.shadowRendererLocal=i}}class zd extends Do{update(e,t,i,s,r){this.frameGraph=e,this.cookiesRenderPass.enabled=i,i&&this.cookiesRenderPass.update(s),this.shadowRenderPass.enabled=t,t&&this.shadowRenderPass.update(r)}destroy(){this.cookiesRenderPass.destroy(),this.cookiesRenderPass=null}execute(){var{renderer:e}=this,{scene:t}=e;e.worldClustersAllocator.update(this.frameGraph.renderPasses,t.lighting)}constructor(e,t,i,s,r){super(e),this.renderer=t,this.frameGraph=null,this.cookiesRenderPass=Bd.create(r.cookieRenderTarget,r.cubeSlotsOffsets),this.beforePasses.push(this.cookiesRenderPass),this.shadowRenderPass=new Nd(e,i,s),this.beforePasses.push(this.shadowRenderPass)}}var Ud=0,Vd=new _i,Hd=new _i,Gd=new _i,Wd=new ci,jd=new Pi,qd=(new _i).setScale(1,-1,1),Xd=new Set,Kd=new Set,Yd=new _r,Qd=(new _i).set([1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1]),Jd=[new di(.5,.333333),new di(.25,.666667),new di(.75,.111111),new di(.125,.444444),new di(.625,.777778),new di(.375,.222222),new di(.875,.555556),new di(.0625,.888889),new di(.5625,.037037),new di(.3125,.37037),new di(.8125,.703704),new di(.1875,.148148),new di(.6875,.481481),new di(.4375,.814815),new di(.9375,.259259),new di(.03125,.592593)],$d=new _i,Zd=new _i,eu=new _i,tu=new _i,iu=new _i,su=new _i,ru=new Set,nu=[],au=[];class ou{destroy(){this.shadowRenderer=null,this._shadowRendererLocal=null,this._shadowRendererDirectional=null,this.shadowMapCache.destroy(),this.shadowMapCache=null,this._renderPassUpdateClustered.destroy(),this._renderPassUpdateClustered=null,this.lightTextureAtlas.destroy(),this.lightTextureAtlas=null}setupViewport(e,t){var i=this.device,s=t?t.width:i.width,r=t?t.height:i.height,n=e.rect,a=Math.floor(n.x*s),o=Math.floor(n.y*r),l=Math.floor(n.z*s),h=Math.floor(n.w*r);if(i.setViewport(a,o,l,h),e._scissorRectClear){var c=e.scissorRect;a=Math.floor(c.x*s),o=Math.floor(c.y*r),l=Math.floor(c.z*s),h=Math.floor(c.w*r)}i.setScissor(a,o,l,h)}setCameraUniforms(e,t){var i=null==t?void 0:t.flipY,s=1;if(e.xr&&e.xr.session){var r,n,a=(null==(n=e._node)||null==(r=n.parent)?void 0:r.getWorldTransform())||null,o=e.xr.views;s=o.list.length;for(var l=0;l<s;l++){var h=o.list[l];h.updateTransforms(a),e.frustum.setFromMat4(h.projViewOffMat)}}else{var c=e.projectionMatrix;e.calculateProjection&&e.calculateProjection(c,0);var d=e.getProjectionMatrixSkybox();i&&(c=$d.mul2(qd,c),d=Zd.mul2(qd,d)),this.device.isWebGPU&&(c=eu.mul2(Qd,c),d=tu.mul2(Qd,d));var{jitter:u}=e,f=0,p=0;if(u>0){var m=t?t.width:this.device.width,g=t?t.height:this.device.height,v=Jd[this.device.renderVersion%Jd.length];f=u*(2*v.x-1)/m,p=u*(2*v.y-1)/g,(c=iu.copy(c)).data[8]=f,c.data[9]=p,(d=su.copy(d)).data[8]=f,d.data[9]=p,this.blueNoiseJitterVersion!==this.device.renderVersion&&(this.blueNoiseJitterVersion=this.device.renderVersion,this.blueNoise.vec4(this.blueNoiseJitterVec))}var _=u>0?this.blueNoiseJitterVec:ui.ZERO;if(this.blueNoiseJitterData[0]=_.x,this.blueNoiseJitterData[1]=_.y,this.blueNoiseJitterData[2]=_.z,this.blueNoiseJitterData[3]=_.w,this.blueNoiseJitterId.setValue(this.blueNoiseJitterData),this.projId.setValue(c.data),this.projSkyboxId.setValue(d.data),e.calculateTransform)e.calculateTransform(Hd,0);else{var b=e._node.getPosition(),y=e._node.getRotation();Hd.setTRS(b,y,hi.ONE)}this.viewInvId.setValue(Hd.data),Gd.copy(Hd).invert(),this.viewId.setValue(Gd.data),Wd.setFromMat4(Gd),this.viewId3.setValue(Wd.data),Vd.mul2(c,Gd),this.viewProjId.setValue(Vd.data),e._storeShaderMatrices(Vd,f,p,this.device.renderVersion),this.flipYId.setValue(i?-1:1),this.dispatchViewPos(e._node.getPosition()),e.frustum.setFromMat4(Vd)}this.tbnBasis.setValue(i?-1:1);var x=e._nearClip,S=e._farClip;return this.nearClipId.setValue(x),this.farClipId.setValue(S),this.cameraParams[0]=1/S,this.cameraParams[1]=S,this.cameraParams[2]=x,this.cameraParams[3]=1===e.projection?1:0,this.cameraParamsId.setValue(this.cameraParams),this.exposureId.setValue(this.scene.physicalUnits?e.getExposure():this.scene.exposure),s}clear(e,t,i,s){var r=((null!=t?t:e._clearColorBuffer)?1:0)|((null!=i?i:e._clearDepthBuffer)?2:0)|((null!=s?s:e._clearStencilBuffer)?4:0);r&&this.device.clear({color:[e._clearColor.r,e._clearColor.g,e._clearColor.b,e._clearColor.a],depth:e._clearDepth,stencil:e._clearStencil,flags:r})}setCamera(e,t,i,s){this.setCameraUniforms(e,t),this.clearView(e,t,i,!1)}clearView(e,t,i,s){var r=this.device;if(r.setRenderTarget(t),r.updateBegin(),s&&(r.setColorWrite(!0,!0,!0,!0),r.setDepthWrite(!0)),this.setupViewport(e,t),i){var n=e._clearOptions;r.clear(n||{color:[e._clearColor.r,e._clearColor.g,e._clearColor.b,e._clearColor.a],depth:e._clearDepth,flags:(e._clearColorBuffer?1:0)|(e._clearDepthBuffer?2:0)|(e._clearStencilBuffer?4:0),stencil:e._clearStencil})}}setupCullMode(e,t,i){var s=i.material,r=0;if(e){var n=1;2!==s.cull&&1!==s.cull||(n=t*i.flipFacesFactor*i.node.worldScaleSign),r=n<0?2===s.cull?1:2:s.cull}this.device.setCullMode(r),0===r&&0===s.cull&&this.twoSidedLightingNegScaleFactorId.setValue(i.node.worldScaleSign)}updateCameraFrustum(e){if(e.xr&&e.xr.views.list.length){var t=e.xr.views.list[0];return Vd.mul2(t.projMat,t.viewOffMat),void e.frustum.setFromMat4(Vd)}var i=e.projectionMatrix;if(e.calculateProjection&&e.calculateProjection(i,0),e.calculateTransform)e.calculateTransform(Hd,0);else{var s=e._node.getPosition(),r=e._node.getRotation();Hd.setTRS(s,r,hi.ONE),this.viewInvId.setValue(Hd.data)}Gd.copy(Hd).invert(),Vd.mul2(i,Gd),e.frustum.setFromMat4(Vd)}setBaseConstants(e,t){e.setCullMode(t.cull),t.opacityMap&&this.opacityMapId.setValue(t.opacityMap),(t.opacityMap||t.alphaTest>0)&&this.alphaTestId.setValue(t.alphaTest)}updateCpuSkinMatrices(e){Ud++;var t=e.length;if(0!==t)for(var i=0;i<t;i++){var s=e[i].skinInstance;s&&(s.updateMatrices(e[i].node,Ud),s._dirty=!0)}}updateGpuSkinMatrices(e){for(var t of e){var i=t.skinInstance;i&&i._dirty&&(i.updateMatrixPalette(t.node,Ud),i._dirty=!1)}}updateMorphing(e){for(var t of e){var i=t.morphInstance;i&&i._dirty&&i.update()}}updateGSplats(e){for(var t of e){var i;null==(i=t.gsplatInstance)||i.update()}}gpuUpdate(e){this.updateGpuSkinMatrices(e),this.updateMorphing(e),this.updateGSplats(e)}setVertexBuffers(e,t){e.setVertexBuffer(t.vertexBuffer)}setMorphing(e,t){t&&(t.prepareRendering(e),e.setVertexBuffer(t.morph.vertexBufferIds),this.morphPositionTex.setValue(t.texturePositions),this.morphNormalTex.setValue(t.textureNormals),this.morphTexParams.setValue(t._textureParams))}setSkinning(e,t){var i=t.skinInstance;if(i){this._skinDrawCalls++;var s=i.boneTexture;this.boneTextureId.setValue(s)}}dispatchViewPos(e){var t=this.viewPos;t[0]=e.x,t[1]=e.y,t[2]=e.z,this.viewPosId.setValue(t)}initViewBindGroupFormat(e){if(this.device.supportsUniformBuffers&&!this.viewUniformFormat){var t=[new An("matrix_viewProjection",Is),new An("cubeMapRotationMatrix",13),new An("view_position",4),new An("skyboxIntensity",2),new An("exposure",2),new An("textureBias",2)];e&&t.push(new An("clusterCellsCountByBoundsSize",4),new An("clusterTextureSize",4),new An("clusterBoundsMin",4),new An("clusterBoundsDelta",4),new An("clusterCellsDot",4),new An("clusterCellsMax",4),new An("shadowAtlasParams",3),new An("clusterMaxCells",1),new An("clusterSkip",2)),this.viewUniformFormat=new Pn(this.device,t);var i=[new rr(Ks,3)];this.viewBindGroupFormat=new lr(this.device,i)}}setupViewUniformBuffers(e,t,i,s){for(var r=this.device;e.length<s;){var n=new Na(r,t,!1),a=new br(r,i,n);e.push(a)}var o=e[0];o.defaultUniformBuffer.update(),o.update(),r.setBindGroup(0,o)}setupMeshUniformBuffers(e,t){var i=this.device;if(i.supportsUniformBuffers){this.modelMatrixId.setValue(t.node.worldTransform.data),this.normalMatrixId.setValue(t.node.normalMatrix.data);var s=e.getBindGroup(i);s.update(),i.setBindGroup(1,s),e.getUniformBuffer(i).update(Yd),i.setBindGroup(2,Yd.bindGroup,Yd.offsets)}}drawInstance(e,t,i,s,r){var n=t.node.worldTransform;this.modelMatrixId.setValue(n.data),r&&this.normalMatrixId.setValue(t.node.normalMatrix.data);var a=t.instancingData;a?a.count>0?(this._instancedDrawCalls++,e.setVertexBuffer(a.vertexBuffer),e.draw(i.primitive[s],a.count)):(e.clearVertexBuffer(),e.clearIndexBuffer()):e.draw(i.primitive[s])}drawInstance2(e,t,i,s){var r=t.instancingData;r?r.count>0?(this._instancedDrawCalls++,e.draw(i.primitive[s],r.count,!0)):(e.clearVertexBuffer(),e.clearIndexBuffer()):e.draw(i.primitive[s],void 0,!0)}cull(e,t,i){var s=i.opaque;s.length=0;var r=i.transparent;r.length=0;for(var n=e.frustumCulling,a=t.length,o=0;o<a;o++){var l=t[o];if(l.visible)if(!n||!l.cull||l._isVisible(e))l.visibleThisFrame=!0,(l.transparent?r:s).push(l),(l.skinInstance||l.morphInstance||l.gsplatInstance)&&(this.processingMeshInstances.add(l),l.gsplatInstance&&l.gsplatInstance.cameras.push(e))}}collectLights(e){this.lights.length=0,this.localLights.length=0;for(var t=this.scene._stats,i=e.layerList.length,s=0;s<i;s++){var r=e.layerList[s];if(!Kd.has(r)){Kd.add(r);for(var n=r._lights,a=0;a<n.length;a++){var o=n[a];Xd.has(o)||(Xd.add(o),this.lights.push(o),0!==o._type&&this.localLights.push(o))}}}t.lights=this.lights.length,Xd.clear(),Kd.clear()}cullLights(e,t){for(var i=this.scene.clusteredLightingEnabled,s=this.scene.physicalUnits,r=0;r<t.length;r++){var n=t[r];if(n.enabled)if(0!==n._type)if(n.getBoundingSphere(jd),e.frustum.containsSphere(jd)){n.visibleThisFrame=!0,n.usePhysicalUnits=s;var a=e.getScreenSize(jd);n.maxScreenSize=Math.max(n.maxScreenSize,a)}else i||n.castShadows&&!n.shadowMap&&(n.visibleThisFrame=!0);else n.usePhysicalUnits=this.scene.physicalUnits}}cullShadowmaps(e){for(var t=this.scene.clusteredLightingEnabled,i=0;i<this.localLights.length;i++){var s=this.localLights[i];0!==s._type&&(t?s.atlasSlotUpdated&&0===s.shadowUpdateMode&&(s.shadowUpdateMode=1):0===s.shadowUpdateMode&&s.castShadows&&(s.getRenderData(null,0).shadowCamera.renderTarget||(s.shadowUpdateMode=1)),s.visibleThisFrame&&s.castShadows&&0!==s.shadowUpdateMode&&this._shadowRendererLocal.cull(s,e))}this.cameraDirShadowLights.clear();for(var r=e.cameras,n=0;n<r.length;n++){var a=r[n];if(a.enabled){for(var o=a.camera,l=void 0,h=o.layers,c=0;c<h.length;c++){var d=e.getLayerById(h[c]);if(d)for(var u=d.splitLights[0],f=0;f<u.length;f++){var p=u[f];p.castShadows&&!ru.has(p)&&(ru.add(p),(l=null!=l?l:[]).push(p),this._shadowRendererDirectional.cull(p,e,o))}}l&&this.cameraDirShadowLights.set(o,l),ru.clear()}}}cullComposition(e){var{scene:t}=this;this.processingMeshInstances.clear();var i=e.cameras.length;this._camerasRendered+=i;for(var s=0;s<i;s++){var r=e.cameras[s];null==t||t.fire("precull",r);var n=r.renderTarget;r.frameUpdate(n),this.updateCameraFrustum(r.camera);for(var a=r.layers,o=0;o<a.length;o++){var l=e.getLayerById(a[o]);if(l&&l.enabled){this.cullLights(r.camera,l._lights);var h=l.getCulledInstances(r.camera);this.cull(r.camera,l.meshInstances,h)}}null==t||t.fire("postcull",r)}t.clusteredLightingEnabled&&this.updateLightTextureAtlas(),this.cullShadowmaps(e)}updateShaders(e,t){for(var i=e.length,s=0;s<i;s++){var r=e[s].material;if(r&&!ru.has(r)&&(ru.add(r),r.getShaderVariant!==fd.prototype.getShaderVariant)){if(t&&(!r.useLighting||r.emitter&&!r.emitter.lighting))continue;r.clearVariants()}}ru.clear()}updateFrameUniforms(){this.blueNoiseTextureId.setValue(sd(this.device))}beginFrame(e){for(var t=this.scene,i=t.updateShaders||this.device._shadersDirty,s=e.layerList,r=s.length,n=0;n<r;n++)for(var a=s[n].meshInstances,o=a.length,l=0;l<o;l++){var h=a[l];h.visibleThisFrame=!1,i&&nu.push(h),h.skinInstance&&au.push(h)}if(i){var c=!t.updateShaders||!this.device._shadersDirty;this.updateShaders(nu,c),t.updateShaders=!1,this.device._shadersDirty=!1,t._shaderVersion++}this.updateFrameUniforms(),this.updateCpuSkinMatrices(au),nu.length=0,au.length=0;for(var d=this.lights,u=d.length,f=0;f<u;f++)d[f].beginFrame()}updateLightTextureAtlas(){this.lightTextureAtlas.update(this.localLights,this.scene.lighting)}updateLayerComposition(e){for(var t=e.layerList.length,i=this.scene._shaderVersion,s=0;s<t;s++){e.layerList[s]._shaderVersion=i}e._update()}frameUpdate(){this.clustersDebugRendered=!1,this.initViewBindGroupFormat(this.scene.clusteredLightingEnabled),this.dirLightShadows.clear()}constructor(e){this.clustersDebugRendered=!1,this.processingMeshInstances=new Set,this.lights=[],this.localLights=[],this.cameraDirShadowLights=new Map,this.dirLightShadows=new Map,this.blueNoise=new Zc(123),this.device=e,this.scene=null,this.worldClustersAllocator=new kd(e),this.lightTextureAtlas=new cd(e),this.shadowMapCache=new pd,this.shadowRenderer=new Id(this,this.lightTextureAtlas),this._shadowRendererLocal=new gd(this,this.shadowRenderer),this._shadowRendererDirectional=new Td(this,this.shadowRenderer),this._renderPassUpdateClustered=new zd(this.device,this,this.shadowRenderer,this._shadowRendererLocal,this.lightTextureAtlas),this.viewUniformFormat=null,this.viewBindGroupFormat=null,this._skinTime=0,this._morphTime=0,this._cullTime=0,this._shadowMapTime=0,this._lightClustersTime=0,this._layerCompositionUpdateTime=0,this._shadowDrawCalls=0,this._skinDrawCalls=0,this._instancedDrawCalls=0,this._shadowMapUpdates=0,this._numDrawCallsCulled=0,this._camerasRendered=0,this._lightClusters=0;var t=e.scope;this.boneTextureId=t.resolve("texture_poseMap"),this.modelMatrixId=t.resolve("matrix_model"),this.normalMatrixId=t.resolve("matrix_normal"),this.viewInvId=t.resolve("matrix_viewInverse"),this.viewPos=new Float32Array(3),this.viewPosId=t.resolve("view_position"),this.projId=t.resolve("matrix_projection"),this.projSkyboxId=t.resolve("matrix_projectionSkybox"),this.viewId=t.resolve("matrix_view"),this.viewId3=t.resolve("matrix_view3"),this.viewProjId=t.resolve("matrix_viewProjection"),this.flipYId=t.resolve("projectionFlipY"),this.tbnBasis=t.resolve("tbnBasis"),this.nearClipId=t.resolve("camera_near"),this.farClipId=t.resolve("camera_far"),this.cameraParams=new Float32Array(4),this.cameraParamsId=t.resolve("camera_params"),this.viewIndexId=t.resolve("view_index"),this.blueNoiseJitterVersion=0,this.blueNoiseJitterVec=new ui,this.blueNoiseJitterData=new Float32Array(4),this.blueNoiseJitterId=t.resolve("blueNoiseJitter"),this.blueNoiseTextureId=t.resolve("blueNoiseTex32"),this.alphaTestId=t.resolve("alpha_ref"),this.opacityMapId=t.resolve("texture_opacityMap"),this.exposureId=t.resolve("exposure"),this.twoSidedLightingNegScaleFactorId=t.resolve("twoSidedLightingNegScaleFactor"),this.twoSidedLightingNegScaleFactorId.setValue(0),this.morphPositionTex=t.resolve("morphPositionTex"),this.morphNormalTex=t.resolve("morphNormalTex"),this.morphTexParams=t.resolve("morph_tex_params"),this.lightCube=new td,this.constantLightCube=t.resolve("lightCube[0]")}}class lu{destroy(){this.viewBindGroups.forEach((e=>{e.defaultUniformBuffer.destroy(),e.destroy()})),this.viewBindGroups.length=0}setupClears(e,t){this.clearColor=(null==e?void 0:e.clearColorBuffer)||t.clearColorBuffer,this.clearDepth=(null==e?void 0:e.clearDepthBuffer)||t.clearDepthBuffer,this.clearStencil=(null==e?void 0:e.clearStencilBuffer)||t.clearStencilBuffer}constructor(){this.camera=null,this.layer=null,this.transparent=!1,this.renderTarget=null,this.lightClusters=null,this.clearColor=!1,this.clearDepth=!1,this.clearStencil=!1,this.triggerPostprocess=!1,this.firstCameraUse=!1,this.lastCameraUse=!1,this.viewBindGroups=[],this.useCameraPasses=!1}}class hu extends Do{get rendersAnything(){return this.renderActions.length>0}addRenderAction(e){this.renderActions.push(e)}addLayer(e,t,i,s){void 0===s&&(s=!0);var r=new lu;if(r.renderTarget=this.renderTarget,r.camera=e,r.layer=t,r.transparent=i,s){var n=0===this.renderActions.length;r.setupClears(n?e:void 0,t)}this.addRenderAction(r)}addLayers(e,t,i,s,r,n){void 0===n&&(n=!0);for(var{layerList:a,subLayerList:o}=e,l=s,h=i;h<a.length;){var c=a[h],d=o[h];if(t.camera.layersSet.has(c.id)&&(this.addLayer(t,c,d,l),l=!1),h++,c.id===r&&d===n)break}return h}updateDirectionalShadows(){for(var{renderer:e,renderActions:t}=this,i=0;i<t.length;i++){var s=t[i].camera.camera,r=this.renderer.cameraDirShadowLights.get(s);if(r)for(var n=0;n<r.length;n++){var a=r[n];if(e.dirLightShadows.get(a)!==s){e.dirLightShadows.set(a,s);var o=e._shadowRendererDirectional.getLightRenderPass(a,s);o&&this.beforePasses.push(o)}}}}updateClears(){var e=this.renderActions[0];if(e){var t=e.camera.camera,i=t.fullSizeClearRect;this.setClearColor(i&&e.clearColor?t.clearColor:void 0),this.setClearDepth(i&&e.clearDepth&&!this.noDepthClear?t.clearDepth:void 0),this.setClearStencil(i&&e.clearStencil?t.clearStencil:void 0)}}frameUpdate(){super.frameUpdate(),this.updateDirectionalShadows(),this.updateClears()}before(){for(var{renderActions:e}=this,t=0;t<e.length;t++){var i=e[t];i.firstCameraUse&&this.scene.fire(mh,i.camera)}}execute(){for(var{layerComposition:e,renderActions:t}=this,i=0;i<t.length;i++){var s=t[i],r=s.layer;e.isEnabled(r,s.transparent)&&this.renderRenderAction(s,0===i)}}after(){for(var e=0;e<this.renderActions.length;e++){var t=this.renderActions[e];t.lastCameraUse&&this.scene.fire(gh,t.camera)}this.beforePasses.length=0}renderRenderAction(e,t){var{renderer:i,scene:s}=this,r=i.device,{layer:n,transparent:a,camera:o}=e;if(o){var l,h=o.gammaCorrection,c=o.toneMapping;void 0!==this.gammaCorrection&&(o.gammaCorrection=this.gammaCorrection),void 0!==this.toneMapping&&(o.toneMapping=this.toneMapping),s.fire("prerender:layer",o,n,a);var d,u,f={lightClusters:e.lightClusters},p=null!=(d=null==(l=o.camera.shaderPassInfo)?void 0:l.index)?d:0;t&&o.camera.fullSizeClearRect||(f.clearColor=e.clearColor,f.clearDepth=e.clearDepth,f.clearStencil=e.clearStencil);var m=null!=(u=e.renderTarget)?u:r.backBuffer;i.renderForwardLayer(o.camera,m,n,a,p,e.viewBindGroups,f),r.setBlendState(Sr.NOBLEND),r.setStencilState(null,null),r.setAlphaToCoverage(!1),s.fire("postrender:layer",o,n,a),void 0!==this.gammaCorrection&&(o.gammaCorrection=h),void 0!==this.toneMapping&&(o.toneMapping=c)}}constructor(e,t,i,s){super(e),this.renderActions=[],this.noDepthClear=!1,this.layerComposition=t,this.scene=i,this.renderer=s}}class cu extends Do{execute(){this.renderAction.camera.onPostprocessing()}constructor(e,t,i){super(e),this.renderer=t,this.renderAction=i,this.requiresCubemaps=!1}}var du=[[],[],[]],uu=new ii,fu={drawCalls:[],shaderInstances:[],isNewMaterial:[],lightMaskChanged:[],clear:function(){this.drawCalls.length=0,this.shaderInstances.length=0,this.isNewMaterial.length=0,this.lightMaskChanged.length=0}};class pu extends ou{destroy(){super.destroy()}dispatchGlobalLights(e){var t=this.ambientColor;if(uu.linear(e.ambientLight),t[0]=uu.r,t[1]=uu.g,t[2]=uu.b,e.physicalUnits)for(var i=0;i<3;i++)t[i]*=e.ambientLuminance;this.ambientId.setValue(t),this.skyboxIntensityId.setValue(e.physicalUnits?e.skyboxLuminance:e.skyboxIntensity),this.cubeMapRotationMatrixId.setValue(e._skyboxRotationMat3.data)}_resolveLight(e,t){var i="light"+t;this.lightColorId[t]=e.resolve(i+"_color"),this.lightDir[t]=new Float32Array(3),this.lightDirId[t]=e.resolve(i+"_direction"),this.lightShadowMapId[t]=e.resolve(i+"_shadowMap"),this.lightShadowMatrixId[t]=e.resolve(i+"_shadowMatrix"),this.lightShadowParamsId[t]=e.resolve(i+"_shadowParams"),this.lightShadowIntensity[t]=e.resolve(i+"_shadowIntensity"),this.lightShadowSearchAreaId[t]=e.resolve(i+"_shadowSearchArea"),this.lightRadiusId[t]=e.resolve(i+"_radius"),this.lightPos[t]=new Float32Array(3),this.lightPosId[t]=e.resolve(i+"_position"),this.lightWidth[t]=new Float32Array(3),this.lightWidthId[t]=e.resolve(i+"_halfWidth"),this.lightHeight[t]=new Float32Array(3),this.lightHeightId[t]=e.resolve(i+"_halfHeight"),this.lightInAngleId[t]=e.resolve(i+"_innerConeAngle"),this.lightOutAngleId[t]=e.resolve(i+"_outerConeAngle"),this.lightCookieId[t]=e.resolve(i+"_cookie"),this.lightCookieIntId[t]=e.resolve(i+"_cookieIntensity"),this.lightCookieMatrixId[t]=e.resolve(i+"_cookieMatrix"),this.lightCookieOffsetId[t]=e.resolve(i+"_cookieOffset"),this.lightCameraParamsId[t]=e.resolve(i+"_cameraParams"),this.lightSoftShadowParamsId[t]=e.resolve(i+"_softShadowParams"),this.shadowMatrixPaletteId[t]=e.resolve(i+"_shadowMatrixPalette[0]"),this.shadowCascadeDistancesId[t]=e.resolve(i+"_shadowCascadeDistances"),this.shadowCascadeCountId[t]=e.resolve(i+"_shadowCascadeCount"),this.shadowCascadeBlendId[t]=e.resolve(i+"_shadowCascadeBlend")}setLTCDirectionalLight(e,t,i,s,r){this.lightPos[t][0]=s.x-i.x*r,this.lightPos[t][1]=s.y-i.y*r,this.lightPos[t][2]=s.z-i.z*r,this.lightPosId[t].setValue(this.lightPos[t]);var n=e.transformVector(new hi(-.5,0,0));this.lightWidth[t][0]=n.x*r,this.lightWidth[t][1]=n.y*r,this.lightWidth[t][2]=n.z*r,this.lightWidthId[t].setValue(this.lightWidth[t]);var a=e.transformVector(new hi(0,0,.5));this.lightHeight[t][0]=a.x*r,this.lightHeight[t][1]=a.y*r,this.lightHeight[t][2]=a.z*r,this.lightHeightId[t].setValue(this.lightHeight[t])}dispatchDirectLights(e,t,i){for(var s=0,r=this.device.scope,n=0;n<e.length;n++)if(e[n].mask&t){var a=e[n],o=a._node.getWorldTransform();if(this.lightColorId[s]||this._resolveLight(r,s),this.lightColorId[s].setValue(a._colorLinear),o.getY(a._direction).mulScalar(-1),a._direction.normalize(),this.lightDir[s][0]=a._direction.x,this.lightDir[s][1]=a._direction.y,this.lightDir[s][2]=a._direction.z,this.lightDirId[s].setValue(this.lightDir[s]),0!==a.shape&&this.setLTCDirectionalLight(o,s,a._direction,i._node.getPosition(),i.farClip),a.castShadows){var l=a.getRenderData(i,0),h=a._getUniformBiasValues(l);this.lightShadowMapId[s].setValue(l.shadowBuffer),this.lightShadowMatrixId[s].setValue(l.shadowMatrix.data),this.shadowMatrixPaletteId[s].setValue(a._shadowMatrixPalette),this.shadowCascadeDistancesId[s].setValue(a._shadowCascadeDistances),this.shadowCascadeCountId[s].setValue(a.numCascades),this.shadowCascadeBlendId[s].setValue(1-a.cascadeBlend),this.lightShadowIntensity[s].setValue(a.shadowIntensity),this.lightSoftShadowParamsId[s].setValue(a._softShadowParams),l.shadowCamera.renderTarget&&this.lightShadowSearchAreaId[s].setValue(a.penumbraSize/l.shadowCamera.renderTarget.width*l.projectionCompensation);var c=a._shadowCameraParams;c.length=4,c[0]=0,c[1]=l.shadowCamera._farClip,c[2]=l.shadowCamera._nearClip,c[3]=1,this.lightCameraParamsId[s].setValue(c);var d=a._shadowRenderParams;d.length=4,d[0]=a._shadowResolution,d[1]=h.normalBias,d[2]=h.bias,d[3]=0,this.lightShadowParamsId[s].setValue(d)}s++}return s}setLTCPositionalLight(e,t){var i=e.transformVector(new hi(-.5,0,0));this.lightWidth[t][0]=i.x,this.lightWidth[t][1]=i.y,this.lightWidth[t][2]=i.z,this.lightWidthId[t].setValue(this.lightWidth[t]);var s=e.transformVector(new hi(0,0,.5));this.lightHeight[t][0]=s.x,this.lightHeight[t][1]=s.y,this.lightHeight[t][2]=s.z,this.lightHeightId[t].setValue(this.lightHeight[t])}dispatchOmniLight(e,t,i){var s=t._node.getWorldTransform();if(this.lightColorId[i]||this._resolveLight(e,i),this.lightRadiusId[i].setValue(t.attenuationEnd),this.lightColorId[i].setValue(t._colorLinear),s.getTranslation(t._position),this.lightPos[i][0]=t._position.x,this.lightPos[i][1]=t._position.y,this.lightPos[i][2]=t._position.z,this.lightPosId[i].setValue(this.lightPos[i]),0!==t.shape&&this.setLTCPositionalLight(s,i),t.castShadows){var r=t.getRenderData(null,0);this.lightShadowMapId[i].setValue(r.shadowBuffer);var n=t._getUniformBiasValues(r),a=t._shadowRenderParams;a.length=4,a[0]=t._shadowResolution,a[1]=n.normalBias,a[2]=n.bias,a[3]=1/t.attenuationEnd,this.lightShadowParamsId[i].setValue(a),this.lightShadowIntensity[i].setValue(t.shadowIntensity);var o=t.penumbraSize/r.shadowCamera.renderTarget.width;this.lightShadowSearchAreaId[i].setValue(o);var l=t._shadowCameraParams;l.length=4,l[0]=0,l[1]=r.shadowCamera._farClip,l[2]=r.shadowCamera._nearClip,l[3]=0,this.lightCameraParamsId[i].setValue(l)}t._cookie&&(this.lightCookieId[i].setValue(t._cookie),this.lightShadowMatrixId[i].setValue(s.data),this.lightCookieIntId[i].setValue(t.cookieIntensity))}dispatchSpotLight(e,t,i){var s=t._node.getWorldTransform();if(this.lightColorId[i]||this._resolveLight(e,i),this.lightInAngleId[i].setValue(t._innerConeAngleCos),this.lightOutAngleId[i].setValue(t._outerConeAngleCos),this.lightRadiusId[i].setValue(t.attenuationEnd),this.lightColorId[i].setValue(t._colorLinear),s.getTranslation(t._position),this.lightPos[i][0]=t._position.x,this.lightPos[i][1]=t._position.y,this.lightPos[i][2]=t._position.z,this.lightPosId[i].setValue(this.lightPos[i]),0!==t.shape&&this.setLTCPositionalLight(s,i),s.getY(t._direction).mulScalar(-1),t._direction.normalize(),this.lightDir[i][0]=t._direction.x,this.lightDir[i][1]=t._direction.y,this.lightDir[i][2]=t._direction.z,this.lightDirId[i].setValue(this.lightDir[i]),t.castShadows){var r=t.getRenderData(null,0);this.lightShadowMapId[i].setValue(r.shadowBuffer),this.lightShadowMatrixId[i].setValue(r.shadowMatrix.data);var n=t._getUniformBiasValues(r),a=t._shadowRenderParams;a.length=4,a[0]=t._shadowResolution,a[1]=n.normalBias,a[2]=n.bias,a[3]=1/t.attenuationEnd,this.lightShadowParamsId[i].setValue(a),this.lightShadowIntensity[i].setValue(t.shadowIntensity);var o=t.penumbraSize/r.shadowCamera.renderTarget.width,l=r.shadowCamera._fov*Math.PI/180,h=1/Math.tan(l/2);this.lightShadowSearchAreaId[i].setValue(o*h);var c=t._shadowCameraParams;c.length=4,c[0]=0,c[1]=r.shadowCamera._farClip,c[2]=r.shadowCamera._nearClip,c[3]=0,this.lightCameraParamsId[i].setValue(c)}if(t._cookie){if(!t.castShadows){var d=kc.evalSpotCookieMatrix(t);this.lightShadowMatrixId[i].setValue(d.data)}this.lightCookieId[i].setValue(t._cookie),this.lightCookieIntId[i].setValue(t.cookieIntensity),t._cookieTransform&&(t._cookieTransformUniform[0]=t._cookieTransform.x,t._cookieTransformUniform[1]=t._cookieTransform.y,t._cookieTransformUniform[2]=t._cookieTransform.z,t._cookieTransformUniform[3]=t._cookieTransform.w,this.lightCookieMatrixId[i].setValue(t._cookieTransformUniform),t._cookieOffsetUniform[0]=t._cookieOffset.x,t._cookieOffsetUniform[1]=t._cookieOffset.y,this.lightCookieOffsetId[i].setValue(t._cookieOffsetUniform))}}dispatchLocalLights(e,t,i){for(var s=i,r=this.device.scope,n=e[1],a=n.length,o=0;o<a;o++){var l=n[o];l.mask&t&&(this.dispatchOmniLight(r,l,s),s++)}for(var h=e[2],c=h.length,d=0;d<c;d++){var u=h[d];u.mask&t&&(this.dispatchSpotLight(r,u,s),s++)}}renderForwardPrepareMaterials(e,t,i,s,r,n){var a,o,l=null!=(a=e.fogParams)?a:this.scene.fog,h=e.shaderParams;h.fog=l.type,h.srgbRenderTarget=null!=(o=null==t?void 0:t.isColorBufferSrgb(0))&&o;var c=(e,t,i,s)=>{fu.drawCalls.push(e),fu.shaderInstances.push(t),fu.isNewMaterial.push(i),fu.lightMaskChanged.push(s)};fu.clear();for(var d,u,f,p=this.device,m=this.scene,g=m.clusteredLightingEnabled,v=null!=(d=null==r?void 0:r.getLightHash(g))?d:0,_=null,b=i.length,y=0;y<b;y++){var x=i[y];x.ensureMaterial(p);var S=x.material,w=x._shaderDefs,T=x.mask;S&&S===_&&w!==u&&(_=null),S!==_&&(this._materialSwitches++,S._scene=m,S.dirty&&(S.updateUniforms(p,m),S.dirty=!1));var C=x.getShaderInstance(n,v,m,h,this.viewUniformFormat,this.viewBindGroupFormat,s);c(x,C,S!==_,!_||T!==f),_=S,u=w,f=T}return fu}renderForwardInternal(e,t,i,s,r,n){for(var a=this.device,o=1<<s,l=n?-1:1,h=this.scene.clusteredLightingEnabled,c=t.drawCalls.length,d=0;d<c;d++){var u=t.drawCalls[d],f=t.isNewMaterial[d],p=t.lightMaskChanged[d],m=t.shaderInstances[d],g=u.material,v=u.mask;if(!m.shader.failed){if(f){if(a.setShader(m.shader,!1),g.setParameters(a),p){var _=this.dispatchDirectLights(i[0],v,e);h||this.dispatchLocalLights(i,v,_)}this.alphaTestId.setValue(g.alphaTest),a.setBlendState(g.blendState),a.setDepthState(g.depthState),a.setAlphaToCoverage(g.alphaToCoverage)}var b;this.setupCullMode(e._cullFaces,l,u);var y,x=null!=(b=u.stencilFront)?b:g.stencilFront,S=null!=(y=u.stencilBack)?y:g.stencilBack;a.setStencilState(x,S),u.setParameters(a,o),a.scope.resolve("meshInstanceId").setValue(u.id);var w=u.mesh;this.setVertexBuffers(a,w),this.setMorphing(a,u.morphInstance),this.setSkinning(a,u),this.setupMeshUniformBuffers(m,u);var T=u.renderStyle;if(a.setIndexBuffer(w.indexBuffer[T]),null==r||r(u,d),e.xr&&e.xr.session&&e.xr.views.list.length)for(var C=e.xr.views,E=0;E<C.list.length;E++){var A=C.list[E];a.setViewport(A.viewport.x,A.viewport.y,A.viewport.z,A.viewport.w),this.projId.setValue(A.projMat.data),this.projSkyboxId.setValue(A.projMat.data),this.viewId.setValue(A.viewOffMat.data),this.viewInvId.setValue(A.viewInvOffMat.data),this.viewId3.setValue(A.viewMat3.data),this.viewProjId.setValue(A.projViewOffMat.data),this.viewPosId.setValue(A.positionData),this.viewIndexId.setValue(E),0===E?this.drawInstance(a,u,w,T,!0):this.drawInstance2(a,u,w,T),this._forwardDrawCalls++}else this.drawInstance(a,u,w,T,!0),this._forwardDrawCalls++;d<c-1&&!t.isNewMaterial[d+1]&&g.setParameters(a,u.parameters)}}}renderForward(e,t,i,s,r,n,a,o){var l=this.renderForwardPrepareMaterials(e,t,i,s,a,r);this.renderForwardInternal(e,l,s,r,n,o),fu.clear()}renderForwardLayer(e,t,i,s,r,n,a){void 0===a&&(a={});var o,l,h,c,{scene:d,device:u}=this,f=d.clusteredLightingEnabled;if(this.setupViewport(e,t),i){i.sortVisible(e,s);var p=i.getCulledInstances(e);o=s?p.transparent:p.opaque,d.immediate.onPreRenderLayer(i,o,s),i.requiresLightCube&&(this.lightCube.update(d.ambientLight,i._lights),this.constantLightCube.setValue(this.lightCube.colors)),l=i.splitLights}else{var m;o=a.meshInstances,l=null!=(m=a.splitLights)?m:du}f&&((null!=(h=a.lightClusters)?h:this.worldClustersAllocator.empty).activate(),i&&(this.clustersDebugRendered||d.lighting.debugLayer!==i.id||(this.clustersDebugRendered=!0)));d._activeCamera=e;var g=null!=(c=e.fogParams)?c:this.scene.fog;this.setFogConstants(g);var v,_=this.setCameraUniforms(e,t);u.supportsUniformBuffers&&this.setupViewUniformBuffers(n,this.viewUniformFormat,this.viewBindGroupFormat,_);var b,y,x=null!=(v=a.clearColor)&&v,S=null!=(b=a.clearDepth)&&b,w=null!=(y=a.clearStencil)&&y;(x||S||w)&&this.clear(e,x,S,w);var T=!!(e._flipFaces^(null==t?void 0:t.flipY)),C=this._forwardDrawCalls;this.renderForward(e,t,o,l,r,null,i,T),i&&(i._forwardDrawCalls+=this._forwardDrawCalls-C)}setFogConstants(e){if(e.type!==ml){uu.linear(e.color);var t=this.fogColor;t[0]=uu.r,t[1]=uu.g,t[2]=uu.b,this.fogColorId.setValue(t),"linear"===e.type?(this.fogStartId.setValue(e.start),this.fogEndId.setValue(e.end)):this.fogDensityId.setValue(e.density)}}setSceneConstants(){var e=this.scene;this.dispatchGlobalLights(e);var t=this.device;this._screenSize[0]=t.width,this._screenSize[1]=t.height,this._screenSize[2]=1/t.width,this._screenSize[3]=1/t.height,this.screenSizeId.setValue(this._screenSize),this.pcssDiskSamplesId.setValue(this.pcssDiskSamples),this.pcssSphereSamplesId.setValue(this.pcssSphereSamples)}buildFrameGraph(e,t){var i=this.scene;if(e.reset(),i.clusteredLightingEnabled){var{shadowsEnabled:s,cookiesEnabled:r}=i.lighting;this._renderPassUpdateClustered.update(e,s,r,this.lights,this.localLights),e.addRenderPass(this._renderPassUpdateClustered)}else this._shadowRendererLocal.buildNonClusteredRenderPasses(e,this.localLights);for(var n=0,a=!0,o=null,l=t._renderActions,h=n;h<l.length;h++){var c=l[h],{layer:d,camera:u}=c;if(c.useCameraPasses)u.camera.renderPasses.forEach((t=>{e.addRenderPass(t)}));else{var f=1===d.id,p=f&&(u.renderSceneColorMap||u.renderSceneDepthMap);a&&(a=!1,n=h,o=c.renderTarget);var m=l[h+1],g=!!m&&(!m.useCameraPasses&&1===m.layer.id)&&(u.renderSceneColorMap||u.renderSceneDepthMap),v=!!m&&(m.firstCameraUse&&this.cameraDirShadowLights.has(m.camera.camera));if(!m||m.renderTarget!==o||v||g||p){if(f&&n===h||this.addMainRenderPass(e,t,o,n,h),f){if(u.renderSceneColorMap){var _=u.camera.renderPassColorGrab;_.source=u.renderTarget,e.addRenderPass(_)}u.renderSceneDepthMap&&e.addRenderPass(u.camera.renderPassDepthGrab)}if(c.triggerPostprocess&&(null==u?void 0:u.onPostprocessing)){var b=new cu(this.device,this,c);e.addRenderPass(b)}a=!0}}}}addMainRenderPass(e,t,i,s,r){var n=new hu(this.device,t,this.scene,this);n.init(i);for(var a=t._renderActions,o=s;o<=r;o++)n.addRenderAction(a[o]);e.addRenderPass(n)}update(e){this.frameUpdate(),this.shadowRenderer.frameUpdate(),this.scene._updateSkyMesh(),this.updateLayerComposition(e),this.collectLights(e),this.beginFrame(e),this.setSceneConstants(),this.cullComposition(e),this.gpuUpdate(this.processingMeshInstances)}constructor(e){super(e);var t=this.device;this._forwardDrawCalls=0,this._materialSwitches=0,this._depthMapTime=0,this._forwardTime=0,this._sortTime=0;var i=t.scope;this.fogColorId=i.resolve("fog_color"),this.fogStartId=i.resolve("fog_start"),this.fogEndId=i.resolve("fog_end"),this.fogDensityId=i.resolve("fog_density"),this.ambientId=i.resolve("light_globalAmbient"),this.skyboxIntensityId=i.resolve("skyboxIntensity"),this.cubeMapRotationMatrixId=i.resolve("cubeMapRotationMatrix"),this.pcssDiskSamplesId=i.resolve("pcssDiskSamples[0]"),this.pcssSphereSamplesId=i.resolve("pcssSphereSamples[0]"),this.lightColorId=[],this.lightDir=[],this.lightDirId=[],this.lightShadowMapId=[],this.lightShadowMatrixId=[],this.lightShadowParamsId=[],this.lightShadowIntensity=[],this.lightRadiusId=[],this.lightPos=[],this.lightPosId=[],this.lightWidth=[],this.lightWidthId=[],this.lightHeight=[],this.lightHeightId=[],this.lightInAngleId=[],this.lightOutAngleId=[],this.lightCookieId=[],this.lightCookieIntId=[],this.lightCookieMatrixId=[],this.lightCookieOffsetId=[],this.lightShadowSearchAreaId=[],this.lightCameraParamsId=[],this.lightSoftShadowParamsId=[],this.shadowMatrixPaletteId=[],this.shadowCascadeDistancesId=[],this.shadowCascadeCountId=[],this.shadowCascadeBlendId=[],this.screenSizeId=i.resolve("uScreenSize"),this._screenSize=new Float32Array(4),this.fogColor=new Float32Array(3),this.ambientColor=new Float32Array(3),this.pcssDiskSamples=function(e){for(var t=[],i=0;i<e;++i){var s=Math.sqrt(i+.5)/Math.sqrt(e);t.push(s)}return t}(16),this.pcssSphereSamples=function(e){for(var t=[],i=0;i<e;i++){var s=i/e,r=Math.sqrt(s*s);t.push(r)}return t}(16)}}var mu=0,gu=[],vu=new Set;var _u=[null,function(e,t){return e.drawOrder-t.drawOrder},function(e,t){var i=e._sortKeyForward,s=t._sortKeyForward;return i===s?t.mesh.id-e.mesh.id:s-i},function(e,t){return t._sortKeyDynamic-e._sortKeyDynamic},function(e,t){return e._sortKeyDynamic-t._sortKeyDynamic}];class bu{constructor(){this.opaque=[],this.transparent=[]}}class yu{set enabled(e){e!==this._enabled&&(this._dirtyComposition=!0,this._enabled=e,e?(this.incrementCounter(),this.onEnable&&this.onEnable()):(this.decrementCounter(),this.onDisable&&this.onDisable()))}get enabled(){return this._enabled}set clearColorBuffer(e){this._clearColorBuffer=e,this._dirtyComposition=!0}get clearColorBuffer(){return this._clearColorBuffer}set clearDepthBuffer(e){this._clearDepthBuffer=e,this._dirtyComposition=!0}get clearDepthBuffer(){return this._clearDepthBuffer}set clearStencilBuffer(e){this._clearStencilBuffer=e,this._dirtyComposition=!0}get clearStencilBuffer(){return this._clearStencilBuffer}get hasClusteredLights(){return this._clusteredLightsSet.size>0}get clusteredLightsSet(){return this._clusteredLightsSet}incrementCounter(){0===this._refCounter&&(this._enabled=!0,this.onEnable&&this.onEnable()),this._refCounter++}decrementCounter(){if(1===this._refCounter)this._enabled=!1,this.onDisable&&this.onDisable();else if(0===this._refCounter)return;this._refCounter--}addMeshInstances(e,t){for(var i=this.meshInstances,s=this.meshInstancesSet,r=0;r<e.length;r++){var n=e[r];s.has(n)||(i.push(n),s.add(n),vu.add(n.material))}if(t||this.addShadowCasters(e),vu.size>0){var a=this._shaderVersion;vu.forEach((e=>{a>=0&&e._shaderVersion!==a&&(e.getShaderVariant!==fd.prototype.getShaderVariant&&e.clearVariants(),e._shaderVersion=a)})),vu.clear()}}removeMeshInstances(e,t){for(var i=this.meshInstances,s=this.meshInstancesSet,r=0;r<e.length;r++){var n=e[r];if(s.has(n)){s.delete(n);var a=i.indexOf(n);a>=0&&i.splice(a,1)}}t||this.removeShadowCasters(e)}addShadowCasters(e){for(var t=this.shadowCasters,i=this.shadowCastersSet,s=0;s<e.length;s++){var r=e[s];r.castShadow&&!i.has(r)&&(i.add(r),t.push(r))}}removeShadowCasters(e){for(var t=this.shadowCasters,i=this.shadowCastersSet,s=0;s<e.length;s++){var r=e[s];if(i.has(r)){i.delete(r);var n=t.indexOf(r);n>=0&&t.splice(n,1)}}}clearMeshInstances(e){void 0===e&&(e=!1),this.meshInstances.length=0,this.meshInstancesSet.clear(),e||(this.shadowCasters.length=0,this.shadowCastersSet.clear())}markLightsDirty(){this._lightHashDirty=!0,this._lightIdHashDirty=!0,this._splitLightsDirty=!0}hasLight(e){return this._lightsSet.has(e)}addLight(e){var t=e.light;this._lightsSet.has(t)||(this._lightsSet.add(t),this._lights.push(t),this.markLightsDirty()),0!==t.type&&this._clusteredLightsSet.add(t)}removeLight(e){var t=e.light;this._lightsSet.has(t)&&(this._lightsSet.delete(t),this._lights.splice(this._lights.indexOf(t),1),this.markLightsDirty()),0!==t.type&&this._clusteredLightsSet.delete(t)}clearLights(){this._lightsSet.forEach((e=>e.removeLayer(this))),this._lightsSet.clear(),this._clusteredLightsSet.clear(),this._lights.length=0,this.markLightsDirty()}get splitLights(){if(this._splitLightsDirty){this._splitLightsDirty=!1;for(var e=this._splitLights,t=0;t<e.length;t++)e[t].length=0;for(var i=this._lights,s=0;s<i.length;s++){var r=i[s];r.enabled&&e[r._type].push(r)}for(var n=0;n<e.length;n++)e[n].sort(((e,t)=>e.key-t.key))}return this._splitLights}evaluateLightHash(e,t,i){for(var s=0,r=this._lights,n=0;n<r.length;n++){var a=0!==r[n].type;(e&&a||t&&!a)&&gu.push(i?r[n].id:r[n].key)}return gu.length>0&&(gu.sort(),s=kr(gu),gu.length=0),s}getLightHash(e){return this._lightHashDirty&&(this._lightHashDirty=!1,this._lightHash=this.evaluateLightHash(!e,!0,!1)),this._lightHash}getLightIdHash(){return this._lightIdHashDirty&&(this._lightIdHashDirty=!1,this._lightIdHash=this.evaluateLightHash(!0,!1,!0)),this._lightIdHash}addCamera(e){this.camerasSet.has(e.camera)||(this.camerasSet.add(e.camera),this.cameras.push(e),this._dirtyComposition=!0)}removeCamera(e){if(this.camerasSet.has(e.camera)){this.camerasSet.delete(e.camera);var t=this.cameras.indexOf(e);this.cameras.splice(t,1),this._dirtyComposition=!0}}clearCameras(){this.cameras.length=0,this.camerasSet.clear(),this._dirtyComposition=!0}_calculateSortDistances(e,t,i){for(var s=e.length,{x:r,y:n,z:a}=t,{x:o,y:l,z:h}=i,c=0;c<s;c++){var d=e[c],u=void 0;if(d.calculateSortDistance)u=d.calculateSortDistance(d,t,i);else{var f=d.aabb.center;u=(f.x-r)*o+(f.y-n)*l+(f.z-a)*h}var p=1e9*d._drawBucket;d._sortKeyDynamic=p+u}}getCulledInstances(e){var t=this._visibleInstances.get(e);return t||(t=new bu,this._visibleInstances.set(e,t)),t}sortVisible(e,t){var i=t?this.transparentSortMode:this.opaqueSortMode;if(0!==i){var s=this.getCulledInstances(e),r=t?s.transparent:s.opaque,n=e.node;if(5===i){var a=n.getPosition(),o=n.forward;this.customCalculateSortValues&&this.customCalculateSortValues(r,r.length,a,o),this.customSortCallback&&r.sort(this.customSortCallback)}else{if(3===i||4===i){var l=n.getPosition(),h=n.forward;this._calculateSortDistances(r,l,h)}r.sort(_u[i])}}}constructor(e={}){var t,i,s;this.meshInstances=[],this.meshInstancesSet=new Set,this.shadowCasters=[],this.shadowCastersSet=new Set,this._visibleInstances=new WeakMap,this._lights=[],this._lightsSet=new Set,this._clusteredLightsSet=new Set,this._splitLights=[[],[],[]],this._splitLightsDirty=!0,this.requiresLightCube=!1,this.cameras=[],this.camerasSet=new Set,this._dirtyComposition=!1,void 0!==e.id?(this.id=e.id,mu=Math.max(this.id+1,mu)):this.id=mu++,this.name=e.name,this._enabled=null==(t=e.enabled)||t,this._refCounter=this._enabled?1:0,this.opaqueSortMode=null!=(i=e.opaqueSortMode)?i:2,this.transparentSortMode=null!=(s=e.transparentSortMode)?s:3,e.renderTarget&&(this.renderTarget=e.renderTarget),this._clearColorBuffer=!!e.clearColorBuffer,this._clearDepthBuffer=!!e.clearDepthBuffer,this._clearStencilBuffer=!!e.clearStencilBuffer,this.onEnable=e.onEnable,this.onDisable=e.onDisable,this._enabled&&this.onEnable&&this.onEnable(),this.customSortCallback=null,this.customCalculateSortValues=null,this._lightHash=0,this._lightHashDirty=!1,this._lightIdHash=0,this._lightIdHashDirty=!1,this._shaderVersion=-1}}var xu=(e,t)=>e.priority-t.priority,Su=e=>e.sort(xu);class wu extends Ht{destroy(){this.destroyRenderActions()}destroyRenderActions(){this._renderActions.forEach((e=>e.destroy())),this._renderActions.length=0}markDirty(){this._dirty=!0}_update(){var e=this.layerList.length;if(!this._dirty)for(var t=0;t<e;t++)if(this.layerList[t]._dirtyComposition){this._dirty=!0;break}if(this._dirty){this._dirty=!1,this.cameras.length=0;for(var i=0;i<e;i++){var s=this.layerList[i];s._dirtyComposition=!1;for(var r=0;r<s.cameras.length;r++){var n=s.cameras[r];this.cameras.indexOf(n)<0&&this.cameras.push(n)}}this.cameras.length>1&&Su(this.cameras);var a=[],o=0;this.destroyRenderActions();for(var l=0;l<this.cameras.length;l++){var h=this.cameras[l];if(a.length=0,h.camera.renderPasses.length>0)this.addDummyRenderAction(o,h),o++;else{for(var c=!0,d=o,u=null,f=!1,p=0;p<e;p++){var m=this.layerList[p];if(m.enabled&&this.subLayerEnabled[p]&&m.cameras.length>0&&h.layers.indexOf(m.id)>=0){a.push(m),f||m.id!==h.disablePostEffectsLayer||(f=!0,u&&(u.triggerPostprocess=!0));var g=this.subLayerList[p];u=this.addRenderAction(o,m,g,h,c,f),o++,c=!1}}d<o&&(u.lastCameraUse=!0),!f&&u&&(u.triggerPostprocess=!0),h.renderTarget&&h.postEffectsEnabled&&this.propagateRenderTarget(d-1,h)}}this._logRenderActions()}}getNextRenderAction(e){var t=new lu;return this._renderActions.push(t),t}addDummyRenderAction(e,t){var i=this.getNextRenderAction(e);i.camera=t,i.useCameraPasses=!0}addRenderAction(e,t,i,s,r,n){for(var a=1!==t.id?s.renderTarget:null,o=!1,l=this._renderActions,h=e-1;h>=0;h--)if(l[h].camera===s&&l[h].renderTarget===a){o=!0;break}n&&s.postEffectsEnabled&&(a=null);var c=this.getNextRenderAction(e);c.triggerPostprocess=!1,c.layer=t,c.transparent=i,c.camera=s,c.renderTarget=a,c.firstCameraUse=r,c.lastCameraUse=!1;var d=r||!o,u=t.clearColorBuffer||t.clearDepthBuffer||t.clearStencilBuffer;return(d||u)&&c.setupClears(d?s:void 0,t),c}propagateRenderTarget(e,t){for(var i=e;i>=0;i--){var s=this._renderActions[i],r=s.layer;if(s.renderTarget&&1!==r.id)break;if(1!==r.id){if(s.useCameraPasses)break;var n=null==s?void 0:s.camera.camera;if(n&&(!t.camera.rect.equals(n.rect)||!t.camera.scissorRect.equals(n.scissorRect)))break;s.renderTarget=t.renderTarget}}}_logRenderActions(){}_isLayerAdded(e){return this.layerIdMap.get(e.id)===e}_isSublayerAdded(e,t){return void 0!==(t?this.layerTransparentIndexMap:this.layerOpaqueIndexMap).get(e)}push(e){this._isLayerAdded(e)||(this.layerList.push(e),this.layerList.push(e),this._opaqueOrder[e.id]=this.subLayerList.push(!1)-1,this._transparentOrder[e.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this.subLayerEnabled.push(!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e))}insert(e,t){if(!this._isLayerAdded(e)){this.layerList.splice(t,0,e,e),this.subLayerList.splice(t,0,!1,!0);var i=this.layerList.length;this._updateOpaqueOrder(t,i-1),this._updateTransparentOrder(t,i-1),this.subLayerEnabled.splice(t,0,!0,!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e)}}remove(e){var t=this.layerList.indexOf(e);for(delete this._opaqueOrder[t],delete this._transparentOrder[t];t>=0;)this.layerList.splice(t,1),this.subLayerList.splice(t,1),this.subLayerEnabled.splice(t,1),t=this.layerList.indexOf(e),this._dirty=!0,this.fire("remove",e);var i=this.layerList.length;this._updateOpaqueOrder(0,i-1),this._updateTransparentOrder(0,i-1),this._updateLayerMaps()}pushOpaque(e){this._isSublayerAdded(e,!1)||(this.layerList.push(e),this._opaqueOrder[e.id]=this.subLayerList.push(!1)-1,this.subLayerEnabled.push(!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e))}insertOpaque(e,t){if(!this._isSublayerAdded(e,!1)){this.layerList.splice(t,0,e),this.subLayerList.splice(t,0,!1);var i=this.subLayerList.length;this._updateOpaqueOrder(t,i-1),this.subLayerEnabled.splice(t,0,!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e)}}removeOpaque(e){for(var t=0,i=this.layerList.length;t<i;t++)if(this.layerList[t]===e&&!this.subLayerList[t]){this.layerList.splice(t,1),this.subLayerList.splice(t,1),i--,this._updateOpaqueOrder(t,i-1),this.subLayerEnabled.splice(t,1),this._dirty=!0,this.layerList.indexOf(e)<0&&this.fire("remove",e);break}this._updateLayerMaps()}pushTransparent(e){this._isSublayerAdded(e,!0)||(this.layerList.push(e),this._transparentOrder[e.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e))}insertTransparent(e,t){if(!this._isSublayerAdded(e,!0)){this.layerList.splice(t,0,e),this.subLayerList.splice(t,0,!0);var i=this.subLayerList.length;this._updateTransparentOrder(t,i-1),this.subLayerEnabled.splice(t,0,!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e)}}removeTransparent(e){for(var t=0,i=this.layerList.length;t<i;t++)if(this.layerList[t]===e&&this.subLayerList[t]){this.layerList.splice(t,1),this.subLayerList.splice(t,1),i--,this._updateTransparentOrder(t,i-1),this.subLayerEnabled.splice(t,1),this._dirty=!0,this.layerList.indexOf(e)<0&&this.fire("remove",e);break}this._updateLayerMaps()}getOpaqueIndex(e){var t;return null!=(t=this.layerOpaqueIndexMap.get(e))?t:-1}getTransparentIndex(e){var t;return null!=(t=this.layerTransparentIndexMap.get(e))?t:-1}isEnabled(e,t){if(e.enabled){var i=t?this.getTransparentIndex(e):this.getOpaqueIndex(e);if(i>=0)return this.subLayerEnabled[i]}return!1}_updateLayerMaps(){this.layerIdMap.clear(),this.layerNameMap.clear(),this.layerOpaqueIndexMap.clear(),this.layerTransparentIndexMap.clear();for(var e=0;e<this.layerList.length;e++){var t=this.layerList[e];this.layerIdMap.set(t.id,t),this.layerNameMap.set(t.name,t),(this.subLayerList[e]?this.layerTransparentIndexMap:this.layerOpaqueIndexMap).set(t,e)}}getLayerById(e){var t;return null!=(t=this.layerIdMap.get(e))?t:null}getLayerByName(e){var t;return null!=(t=this.layerNameMap.get(e))?t:null}_updateOpaqueOrder(e,t){for(var i=e;i<=t;i++)!1===this.subLayerList[i]&&(this._opaqueOrder[this.layerList[i].id]=i)}_updateTransparentOrder(e,t){for(var i=e;i<=t;i++)!0===this.subLayerList[i]&&(this._transparentOrder[this.layerList[i].id]=i)}_sortLayersDescending(e,t,i){for(var s=-1,r=-1,n=0,a=e.length;n<a;n++){var o=e[n];i.hasOwnProperty(o)&&(s=Math.max(s,i[o]))}for(var l=0,h=t.length;l<h;l++){var c=t[l];i.hasOwnProperty(c)&&(r=Math.max(r,i[c]))}return-1===s&&-1!==r?1:-1===r&&-1!==s?-1:r-s}sortTransparentLayers(e,t){return this._sortLayersDescending(e,t,this._transparentOrder)}sortOpaqueLayers(e,t){return this._sortLayersDescending(e,t,this._opaqueOrder)}constructor(e="Untitled"){super(),this.layerList=[],this.layerIdMap=new Map,this.layerNameMap=new Map,this.layerOpaqueIndexMap=new Map,this.layerTransparentIndexMap=new Map,this.subLayerList=[],this.subLayerEnabled=[],this.cameras=[],this._renderActions=[],this._dirty=!1,this.name=e,this._opaqueOrder={},this._transparentOrder={}}}var Tu=new hi,Cu={bias:0,normalBias:0},Eu=new ii,Au={r:0,g:1,b:2,a:3},Pu={directional:0,omni:1,point:1,spot:2},Du=[[new ui(0,0,1,1)],[new ui(0,0,.5,.5),new ui(0,.5,.5,.5)],[new ui(0,0,.5,.5),new ui(0,.5,.5,.5),new ui(.5,0,.5,.5)],[new ui(0,0,.5,.5),new ui(0,.5,.5,.5),new ui(.5,0,.5,.5),new ui(.5,.5,.5,.5)]],Lu={rrr:1,ggg:2,bbb:4,aaa:8,rgb:7},Mu=0;class Iu{destroy(){this.viewBindGroups.forEach((e=>{e.defaultUniformBuffer.destroy(),e.destroy()})),this.viewBindGroups.length=0}get shadowBuffer(){var e=this.shadowCamera.renderTarget;return e?this.light._isPcf?e.depthBuffer:e.colorBuffer:null}constructor(e,t,i){this.light=i,this.camera=e,this.shadowCamera=Id.createShadowCamera(i._shadowType,i._type,t),this.shadowMatrix=new _i,this.shadowViewport=new ui(0,0,1,1),this.shadowScissor=new ui(0,0,1,1),this.projectionCompensation=0,this.face=t,this.visibleCasters=[],this.viewBindGroups=[]}}class Ru{destroy(){this._destroyShadowMap(),this.releaseRenderData(),this._renderData=null}releaseRenderData(){if(this._renderData){for(var e=0;e<this._renderData.length;e++)this._renderData[e].destroy();this._renderData.length=0}}addLayer(e){this.layers.add(e)}removeLayer(e){this.layers.delete(e)}set shadowSamples(e){this._softShadowParams[0]=e}get shadowSamples(){return this._softShadowParams[0]}set shadowBlockerSamples(e){this._softShadowParams[1]=e}get shadowBlockerSamples(){return this._softShadowParams[1]}set shadowBias(e){this._shadowBias!==e&&(this._shadowBias=e,this._updateShadowBias())}get shadowBias(){return this._shadowBias}set numCascades(e){this.cascades&&this.numCascades===e||(this.cascades=Du[e-1],this._shadowMatrixPalette=new Float32Array(64),this._shadowCascadeDistances=new Float32Array(4),this._destroyShadowMap(),this.updateKey())}get numCascades(){return this.cascades.length}set cascadeBlend(e){this._cascadeBlend!==e&&(this._cascadeBlend=e,this.updateKey())}get cascadeBlend(){return this._cascadeBlend}set shadowMap(e){this._shadowMap!==e&&(this._destroyShadowMap(),this._shadowMap=e)}get shadowMap(){return this._shadowMap}set mask(e){this._mask!==e&&(this._mask=e,this.updateKey(),this.updateClusteredFlags())}get mask(){return this._mask}get numShadowFaces(){var e=this._type;return 0===e?this.numCascades:1===e?6:1}set type(e){if(this._type!==e){this._type=e,this._destroyShadowMap(),this._updateShadowBias(),this.updateKey(),this.updateClusteredFlags();var t=this._shadowType;this._shadowType=null,this.shadowUpdateOverrides=null,this.shadowType=t}}get type(){return this._type}set shape(e){if(this._shape!==e){this._shape=e,this._destroyShadowMap(),this.updateKey(),this.updateClusteredFlags();var t=this._shadowType;this._shadowType=null,this.shadowType=t}}get shape(){return this._shape}set usePhysicalUnits(e){this._usePhysicalUnits!==e&&(this._usePhysicalUnits=e,this._updateLinearColor())}get usePhysicalUnits(){return this._usePhysicalUnits}set shadowType(e){if(this._shadowType!==e){var t=Il.get(e);t||(e=0);var i,s,r=this.device;6!==e||r.textureFloatRenderable||r.textureHalfFloatRenderable||(e=0),1===this._type&&5!==e&&0!==e&&7!==e&&8!==e&&6!==e&&(e=0),3!==e||r.textureFloatRenderable&&r.textureFloatFilterable||(e=2),2!==e||r.textureHalfFloatRenderable||(e=0),t=Il.get(e),this._isVsm=null!=(i=null==t?void 0:t.vsm)&&i,this._isPcf=null!=(s=null==t?void 0:t.pcf)&&s,this._shadowType=e,this._destroyShadowMap(),this.updateKey()}}get shadowType(){return this._shadowType}set enabled(e){this._enabled!==e&&(this._enabled=e,this.layersDirty())}get enabled(){return this._enabled}set castShadows(e){this._castShadows!==e&&(this._castShadows=e,this._destroyShadowMap(),this.layersDirty(),this.updateKey())}get castShadows(){return this._castShadows&&4!==this._mask&&0!==this._mask}set shadowIntensity(e){this._shadowIntensity!==e&&(this._shadowIntensity=e,this.updateKey())}get shadowIntensity(){return this._shadowIntensity}get bakeShadows(){return this._castShadows&&4===this._mask}set shadowResolution(e){this._shadowResolution!==e&&(e=1===this._type?Math.min(e,this.device.maxCubeMapSize):Math.min(e,this.device.maxTextureSize),this._shadowResolution=e,this._destroyShadowMap())}get shadowResolution(){return this._shadowResolution}set vsmBlurSize(e){this._vsmBlurSize!==e&&(e%2==0&&e++,this._vsmBlurSize=e)}get vsmBlurSize(){return this._vsmBlurSize}set normalOffsetBias(e){if(this._normalOffsetBias!==e){var t=!this._normalOffsetBias&&e||this._normalOffsetBias&&!e;this._normalOffsetBias=e,t&&this.updateKey()}}get normalOffsetBias(){return this._normalOffsetBias}set falloffMode(e){this._falloffMode!==e&&(this._falloffMode=e,this.updateKey(),this.updateClusteredFlags())}get falloffMode(){return this._falloffMode}set innerConeAngle(e){this._innerConeAngle!==e&&(this._innerConeAngle=e,this._innerConeAngleCos=Math.cos(e*Math.PI/180),this.updateClusterData(!1,!0),this._usePhysicalUnits&&this._updateLinearColor())}get innerConeAngle(){return this._innerConeAngle}set outerConeAngle(e){this._outerConeAngle!==e&&(this._outerConeAngle=e,this._updateOuterAngle(e),this._usePhysicalUnits&&this._updateLinearColor())}get outerConeAngle(){return this._outerConeAngle}set penumbraSize(e){this._penumbraSize=e,this._softShadowParams[2]=e}get penumbraSize(){return this._penumbraSize}set penumbraFalloff(e){this._softShadowParams[3]=e}get penumbraFalloff(){return this._softShadowParams[3]}_updateOuterAngle(e){var t=e*Math.PI/180;this._outerConeAngleCos=Math.cos(t),this._outerConeAngleSin=Math.sin(t),this.updateClusterData(!1,!0)}set intensity(e){this._intensity!==e&&(this._intensity=e,this._updateLinearColor())}get intensity(){return this._intensity}set affectSpecularity(e){0===this._type&&(this._affectSpecularity=e,this.updateKey())}get affectSpecularity(){return this._affectSpecularity}set luminance(e){this._luminance!==e&&(this._luminance=e,this._updateLinearColor())}get luminance(){return this._luminance}get cookieMatrix(){return this._cookieMatrix||(this._cookieMatrix=new _i),this._cookieMatrix}get atlasViewport(){return this._atlasViewport||(this._atlasViewport=new ui(0,0,1,1)),this._atlasViewport}set cookie(e){this._cookie!==e&&(this._cookie=e,this.updateKey())}get cookie(){return this._cookie}set cookieFalloff(e){this._cookieFalloff!==e&&(this._cookieFalloff=e,this.updateKey())}get cookieFalloff(){return this._cookieFalloff}set cookieChannel(e){if(this._cookieChannel!==e){if(e.length<3)for(var t=e.charAt(e.length-1),i=3-e.length,s=0;s<i;s++)e+=t;this._cookieChannel=e,this.updateKey(),this.updateClusteredFlags()}}get cookieChannel(){return this._cookieChannel}set cookieTransform(e){this._cookieTransform!==e&&(this._cookieTransform=e,this._cookieTransformSet=!!e,e&&!this._cookieOffset&&(this.cookieOffset=new di,this._cookieOffsetSet=!1),this.updateKey())}get cookieTransform(){return this._cookieTransform}set cookieOffset(e){this._cookieOffset!==e&&(!(!this._cookieTransformSet&&!e)&&!e&&this._cookieOffset?this._cookieOffset.set(0,0):this._cookieOffset=e,this._cookieOffsetSet=!!e,e&&!this._cookieTransform&&(this.cookieTransform=new ui(1,1,0,0),this._cookieTransformSet=!1),this.updateKey())}get cookieOffset(){return this._cookieOffset}beginFrame(){this.visibleThisFrame=0===this._type&&this._enabled,this.maxScreenSize=0,this.atlasViewportAllocated=!1,this.atlasSlotUpdated=!1}_destroyShadowMap(){if(this.releaseRenderData(),this._shadowMap&&(this._shadowMap.cached||this._shadowMap.destroy(),this._shadowMap=null),0===this.shadowUpdateMode&&(this.shadowUpdateMode=1),this.shadowUpdateOverrides)for(var e=0;e<this.shadowUpdateOverrides.length;e++)0===this.shadowUpdateOverrides[e]&&(this.shadowUpdateOverrides[e]=1)}getRenderData(e,t){for(var i=0;i<this._renderData.length;i++){var s=this._renderData[i];if(s.camera===e&&s.face===t)return s}var r=new Iu(e,t,this);return this._renderData.push(r),r}clone(){var e=new Ru(this.device,this.clusteredLighting);return e.type=this._type,e.setColor(this._color),e.intensity=this._intensity,e.affectSpecularity=this._affectSpecularity,e.luminance=this._luminance,e.castShadows=this.castShadows,e._enabled=this._enabled,e.attenuationStart=this.attenuationStart,e.attenuationEnd=this.attenuationEnd,e.falloffMode=this._falloffMode,e.shadowType=this._shadowType,e.vsmBlurSize=this._vsmBlurSize,e.vsmBlurMode=this.vsmBlurMode,e.vsmBias=this.vsmBias,e.shadowUpdateMode=this.shadowUpdateMode,e.mask=this.mask,this.shadowUpdateOverrides&&(e.shadowUpdateOverrides=this.shadowUpdateOverrides.slice()),e.innerConeAngle=this._innerConeAngle,e.outerConeAngle=this._outerConeAngle,e.numCascades=this.numCascades,e.cascadeDistribution=this.cascadeDistribution,e.cascadeBlend=this._cascadeBlend,e.shape=this._shape,e.shadowDepthState.copy(this.shadowDepthState),e.shadowBias=this.shadowBias,e.normalOffsetBias=this._normalOffsetBias,e.shadowResolution=this._shadowResolution,e.shadowDistance=this.shadowDistance,e.shadowIntensity=this.shadowIntensity,e.shadowSamples=this.shadowSamples,e.shadowBlockerSamples=this.shadowBlockerSamples,e.penumbraSize=this.penumbraSize,e.penumbraFalloff=this.penumbraFalloff,e}static getLightUnitConversion(e,t,i){switch(void 0===t&&(t=Math.PI/4),void 0===i&&(i=0),e){case 2:var s=Math.cos(t),r=Math.cos(i);return 2*Math.PI*(1-r+(r-s)/2);case 1:return 4*Math.PI;case 0:return 1}}_getUniformBiasValues(e){var t=e.shadowCamera._farClip;switch(this._type){case 1:Cu.bias=this.shadowBias,Cu.normalBias=this._normalOffsetBias;break;case 2:this._isVsm?Cu.bias=-2e-4:Cu.bias=20*this.shadowBias,Cu.normalBias=this._isVsm?this.vsmBias/(this.attenuationEnd/7):this._normalOffsetBias;break;case 0:this._isVsm?Cu.bias=-2e-4:Cu.bias=this.shadowBias/t*100,Cu.normalBias=this._isVsm?this.vsmBias/(t/7):this._normalOffsetBias}return Cu}getColor(){return this._color}getBoundingSphere(e){if(2===this._type){var t=this.attenuationEnd,i=this._outerConeAngle,s=this._outerConeAngleCos,r=this._node;Tu.copy(r.up),i>45?(e.radius=t*this._outerConeAngleSin,Tu.mulScalar(-t*s)):(e.radius=t/(2*s),Tu.mulScalar(-e.radius)),e.center.add2(r.getPosition(),Tu)}else 1===this._type&&(e.center=this._node.getPosition(),e.radius=this.attenuationEnd)}getBoundingBox(e){if(2===this._type){var t=this.attenuationEnd,i=this._outerConeAngle,s=this._node,r=Math.abs(Math.sin(i*ti.DEG_TO_RAD)*t);e.center.set(0,.5*-t,0),e.halfExtents.set(r,.5*t,r),e.setFromTransformedAabb(e,s.getWorldTransform(),!0)}else 1===this._type&&(e.center.copy(this._node.getPosition()),e.halfExtents.set(this.attenuationEnd,this.attenuationEnd,this.attenuationEnd))}_updateShadowBias(){if(1!==this._type||this.clusteredLighting){var e=-1e3*this.shadowBias;this.shadowDepthState.depthBias=e,this.shadowDepthState.depthBiasSlope=e}else this.shadowDepthState.depthBias=0,this.shadowDepthState.depthBiasSlope=0}_updateLinearColor(){var e=this._intensity;this._usePhysicalUnits&&(e=this._luminance/Ru.getLightUnitConversion(this._type,this._outerConeAngle*ti.DEG_TO_RAD,this._innerConeAngle*ti.DEG_TO_RAD));var t=this._color,i=this._colorLinear;e>=1?Eu.linear(t).mulScalar(e):Eu.copy(t).mulScalar(e).linear(),i[0]=Eu.r,i[1]=Eu.g,i[2]=Eu.b,this.updateClusterData(!0)}setColor(){1===arguments.length?this._color.set(arguments[0].r,arguments[0].g,arguments[0].b):3===arguments.length&&this._color.set(arguments[0],arguments[1],arguments[2]),this._updateLinearColor()}layersDirty(){this.layers.forEach((e=>{e.hasLight(this)&&e.markLightsDirty()}))}updateKey(){var e=this._type<<29|this._shadowType<<25|this._falloffMode<<23|(0!==this._normalOffsetBias?1:0)<<22|(this._cookie?1:0)<<21|(this._cookieFalloff?1:0)<<20|Au[this._cookieChannel.charAt(0)]<<18|(this._cookieTransform?1:0)<<12|this._shape<<10|(this.numCascades>0?1:0)<<9|(this._cascadeBlend>0?1:0)<<8|(this.affectSpecularity?1:0)<<7|this.mask<<6|(this._castShadows?1:0)<<3;3===this._cookieChannel.length&&(e|=Au[this._cookieChannel.charAt(1)]<<16,e|=Au[this._cookieChannel.charAt(2)]<<14),e!==this.key&&this.layersDirty(),this.key=e}updateClusteredFlags(){var e,t=!!(1&this.mask),i=!!(2&this.mask);this.clusteredFlags=(2===this.type?1:0)<<30|(3&this._shape)<<28|(1&this._falloffMode)<<27|(null!=(e=Lu[this._cookieChannel])?e:0)<<23|(t?1:0)<<22|(i?1:0)<<21}getClusteredFlags(e,t){return this.clusteredFlags|255&(e?Math.floor(255*this.shadowIntensity):0)|(255&(t?Math.floor(255*this.cookieIntensity):0))<<8}updateClusterData(e,t){var{clusteredData16:i}=this,s=li.float2Half;e&&(i[0]=s(ti.clamp(this._colorLinear[0]/wl,0,65504)),i[1]=s(ti.clamp(this._colorLinear[1]/wl,0,65504)),i[2]=s(ti.clamp(this._colorLinear[2]/wl,0,65504))),t&&(i[4]=s(this._innerConeAngleCos),i[5]=s(this._outerConeAngleCos))}constructor(e,t){this.layers=new Set,this.shadowDepthState=Cr.DEFAULT.clone(),this.clusteredFlags=0,this.clusteredData=new Uint32Array(3),this.clusteredData16=new Uint16Array(this.clusteredData.buffer),this.device=e,this.clusteredLighting=t,this.id=Mu++,this._type=0,this._color=new ii(.8,.8,.8),this._intensity=1,this._affectSpecularity=!0,this._luminance=0,this._castShadows=!1,this._enabled=!1,this._mask=1,this.isStatic=!1,this.key=0,this.bakeDir=!0,this.bakeNumSamples=1,this.bakeArea=0,this.attenuationStart=10,this.attenuationEnd=10,this._falloffMode=0,this._shadowType=0,this._vsmBlurSize=11,this.vsmBlurMode=1,this.vsmBias=.0025,this._cookie=null,this.cookieIntensity=1,this._cookieFalloff=!0,this._cookieChannel="rgb",this._cookieTransform=null,this._cookieTransformUniform=new Float32Array(4),this._cookieOffset=null,this._cookieOffsetUniform=new Float32Array(2),this._cookieTransformSet=!1,this._cookieOffsetSet=!1,this._innerConeAngle=40,this._outerConeAngle=45,this.cascades=null,this._shadowMatrixPalette=null,this._shadowCascadeDistances=null,this.numCascades=1,this._cascadeBlend=0,this.cascadeDistribution=.5,this._shape=0,this._colorLinear=new Float32Array(3),this._updateLinearColor(),this._position=new hi(0,0,0),this._direction=new hi(0,0,0),this._innerConeAngleCos=Math.cos(this._innerConeAngle*Math.PI/180),this._updateOuterAngle(this._outerConeAngle),this._usePhysicalUnits=void 0,this._shadowMap=null,this._shadowRenderParams=[],this._shadowCameraParams=[],this.shadowDistance=40,this._shadowResolution=1024,this._shadowBias=-5e-4,this._shadowIntensity=1,this._normalOffsetBias=0,this.shadowUpdateMode=2,this.shadowUpdateOverrides=null,this._isVsm=!1,this._isPcf=!0,this._softShadowParams=new Float32Array(4),this.shadowSamples=16,this.shadowBlockerSamples=16,this.penumbraSize=1,this.penumbraFalloff=1,this._cookieMatrix=null,this._atlasViewport=null,this.atlasViewportAllocated=!1,this.atlasVersion=0,this.atlasSlotIndex=0,this.atlasSlotUpdated=!1,this._node=null,this._renderData=[],this.visibleThisFrame=!1,this.maxScreenSize=0,this._updateShadowBias()}}class ku{applySettings(e){var t,i,s,r,n,a,o;this.shadowsEnabled=null!=(t=e.lightingShadowsEnabled)?t:this.shadowsEnabled,this.cookiesEnabled=null!=(i=e.lightingCookiesEnabled)?i:this.cookiesEnabled,this.areaLightsEnabled=null!=(s=e.lightingAreaLightsEnabled)?s:this.areaLightsEnabled,this.shadowAtlasResolution=null!=(r=e.lightingShadowAtlasResolution)?r:this.shadowAtlasResolution,this.cookieAtlasResolution=null!=(n=e.lightingCookieAtlasResolution)?n:this.cookieAtlasResolution,this.maxLightsPerCell=null!=(a=e.lightingMaxLightsPerCell)?a:this.maxLightsPerCell,this.shadowType=null!=(o=e.lightingShadowType)?o:this.shadowType,e.lightingCells&&(this.cells=new hi(e.lightingCells))}set cells(e){this._cells.copy(e)}get cells(){return this._cells}set maxLightsPerCell(e){this._maxLightsPerCell=ti.clamp(e,1,255)}get maxLightsPerCell(){return this._maxLightsPerCell}set cookieAtlasResolution(e){this._cookieAtlasResolution=ti.clamp(e,32,this._maxTextureSize)}get cookieAtlasResolution(){return this._cookieAtlasResolution}set shadowAtlasResolution(e){this._shadowAtlasResolution=ti.clamp(e,32,this._maxTextureSize)}get shadowAtlasResolution(){return this._shadowAtlasResolution}set shadowType(e){this._shadowType!==e&&(this._shadowType=e,this._dirtyLightsFnc())}get shadowType(){return this._shadowType}set cookiesEnabled(e){this._cookiesEnabled!==e&&(this._cookiesEnabled=e,this._dirtyLightsFnc())}get cookiesEnabled(){return this._cookiesEnabled}set areaLightsEnabled(e){this._supportsAreaLights&&this._areaLightsEnabled!==e&&(this._areaLightsEnabled=e,this._dirtyLightsFnc())}get areaLightsEnabled(){return this._areaLightsEnabled}set shadowsEnabled(e){this._shadowsEnabled!==e&&(this._shadowsEnabled=e,this._dirtyLightsFnc())}get shadowsEnabled(){return this._shadowsEnabled}constructor(e,t,i){this._areaLightsEnabled=!1,this._cells=new hi(10,3,10),this._maxLightsPerCell=255,this._shadowsEnabled=!0,this._shadowType=0,this._shadowAtlasResolution=2048,this._cookiesEnabled=!1,this._cookieAtlasResolution=2048,this.atlasSplit=null,this._supportsAreaLights=e,this._maxTextureSize=t,this._dirtyLightsFnc=i}}var Ou=new Sr(!0,0,1,1);class Fu{destroy(){this.shader=null;var e=this.morph;e&&(this.morph=null,e.decRefCount(),e.refCount<1&&e.destroy()),this.rtPositions&&(this.rtPositions.destroy(),this.rtPositions=null),this.texturePositions&&(this.texturePositions.destroy(),this.texturePositions=null),this.rtNormals&&(this.rtNormals.destroy(),this.rtNormals=null),this.textureNormals&&(this.textureNormals.destroy(),this.textureNormals=null)}clone(){return new Fu(this.morph)}_getWeightIndex(e){return"string"==typeof e?this._weightMap.get(e):e}getWeight(e){var t=this._getWeightIndex(e);return this._weights[t]}setWeight(e,t){var i=this._getWeightIndex(e);this._weights[i]=t,this._dirty=!0}_getShader(e){var t=this.shaderCache[e];if(!t){var i=this.device.isWebGPU,s=i?Oc:_h,r=new Map;r.set("MORPH_TEXTURE_COUNT",e),r.set("{MORPH_TEXTURE_COUNT}",e),this.morph.intRenderFormat&&r.set("MORPH_INT","");var n=new Map;n.set("morphDeclarationPS",s.morphDeclarationPS),n.set("morphEvaluationPS",s.morphEvaluationPS);var a=this.morph.intRenderFormat?"uvec4":"vec4";t=Eh(this.device,s.morphVS,s.morphPS,"textureMorph"+e,{vertex_position:Ji},{shaderLanguage:i?Ms:Ls,fragmentIncludes:n,fragmentDefines:r,fragmentOutputTypes:[a]}),this.shaderCache[e]=t}return t}_updateTextureRenderTarget(e,t,i){var s=this.device,r=(t,i)=>{this.morphFactor.setValue(this._shaderMorphWeights),s.setBlendState(i?Ou:Sr.NOBLEND);var r=this._getShader(t);Fh(s,e,r)};this.setAabbUniforms(i);for(var n=0,a=!1,o=this._activeTargets.length,l=0;l<o;l++){var h=this._activeTargets[l],c=h.target[t];c&&(this["morphBlendTex"+n].setValue(c),this._shaderMorphWeights[n]=h.weight,++n>=this.maxSubmitCount&&(r(n,a),n=0,a=!0))}(n>0||0===o&&!this.zeroTextures)&&r(n,a)}_updateTextureMorph(){(this._activeTargets.length>0||!this.zeroTextures)&&(this.rtPositions&&this._updateTextureRenderTarget(this.rtPositions,"texturePositions",!0),this.rtNormals&&this._updateTextureRenderTarget(this.rtNormals,"textureNormals",!1),this.zeroTextures=0===this._activeTargets.length)}setAabbUniforms(e){void 0===e&&(e=!0),this.aabbSizeId.setValue(e?this._aabbSize:this._aabbNrmSize),this.aabbMinId.setValue(e?this._aabbMin:this._aabbNrmMin)}prepareRendering(e){this.setAabbUniforms()}update(){this._dirty=!1;for(var e=this.morph._targets,t=0,i=0;i<e.length;i++){var s=Math.abs(this.getWeight(i));if(s>1e-5){this._activeTargets.length<=t&&(this._activeTargets[t]={});var r=this._activeTargets[t++];r.absWeight=s,r.weight=this.getWeight(i),r.target=e[i]}}this._activeTargets.length=t,this.morph.intRenderFormat&&this._activeTargets.length>this.maxSubmitCount&&(this._activeTargets.sort(((e,t)=>e.absWeight<t.absWeight?1:t.absWeight<e.absWeight?-1:0)),this._activeTargets.length=this.maxSubmitCount),this._updateTextureMorph()}constructor(e){this.shaderCache=[],this.morph=e,e.incRefCount(),this.device=e.device,this._weights=[],this._weightMap=new Map;for(var t=0;t<e._targets.length;t++){var i=e._targets[t];i.name&&this._weightMap.set(i.name,t),this.setWeight(t,i.defaultWeight)}this._activeTargets=[],this.maxSubmitCount=this.device.maxTextures,this._shaderMorphWeights=new Float32Array(this.maxSubmitCount);var s=(t,i)=>(this[i]=e._createTexture(t,e._renderTextureFormat),new Wr({colorBuffer:this[i],depth:!1}));e.morphPositions&&(this.rtPositions=s("MorphRTPos","texturePositions")),e.morphNormals&&(this.rtNormals=s("MorphRTNrm","textureNormals")),this._textureParams=new Float32Array([e.morphTextureWidth,e.morphTextureHeight]);var r=e.aabb.halfExtents;this._aabbSize=new Float32Array([4*r.x,4*r.y,4*r.z]);var n=e.aabb.getMin();this._aabbMin=new Float32Array([2*n.x,2*n.y,2*n.z]),this._aabbNrmSize=new Float32Array([2,2,2]),this._aabbNrmMin=new Float32Array([-1,-1,-1]),this.aabbSizeId=this.device.scope.resolve("aabbSize"),this.aabbMinId=this.device.scope.resolve("aabbMin");for(var a=0;a<this.maxSubmitCount;a++)this["morphBlendTex"+a]=this.device.scope.resolve("morphBlendTex"+a);this.morphFactor=this.device.scope.resolve("morphFactor[0]"),this.zeroTextures=!1}}class Bu{getGraph(){return this.graph}setGraph(e){this.graph=e}getCameras(){return this.cameras}setCameras(e){this.cameras=e}getLights(){return this.lights}setLights(e){this.lights=e}getMaterials(){for(var e=[],t=0;t<this.meshInstances.length;t++){var i=this.meshInstances[t];-1===e.indexOf(i.material)&&e.push(i.material)}return e}clone(){for(var e=[],t=[],i=function(s){var r=s.clone();e.push(s),t.push(r);for(var n=0;n<s._children.length;n++)r.addChild(i(s._children[n]));return r},s=i(this.graph),r=[],n=[],a=[],o=0;o<this.skinInstances.length;o++){for(var l=this.skinInstances[o].skin,h=new zh(l),c=[],d=0;d<l.boneNames.length;d++){var u=l.boneNames[d],f=s.findByName(u);c.push(f)}h.bones=c,n.push(h)}for(var p=0;p<this.morphInstances.length;p++){var m=this.morphInstances[p].morph,g=new Fu(m);a.push(g)}for(var v=0;v<this.meshInstances.length;v++){var _=this.meshInstances[v],b=e.indexOf(_.node),y=new tc(_.mesh,_.material,t[b]);if(_.skinInstance){var x=this.skinInstances.indexOf(_.skinInstance);y.skinInstance=n[x]}if(_.morphInstance){var S=this.morphInstances.indexOf(_.morphInstance);y.morphInstance=a[S]}r.push(y)}var w=new Bu;return w.graph=s,w.meshInstances=r,w.skinInstances=n,w.morphInstances=a,w.getGraph().syncHierarchy(),w}destroy(){for(var e=this.meshInstances,t=0;t<e.length;t++)e[t].destroy();this.meshInstances.length=0}generateWireframe(){tc._prepareRenderStyleForArray(this.meshInstances,1)}constructor(){this.graph=null,this.meshInstances=[],this.skinInstances=[],this.morphInstances=[],this.cameras=[],this.lights=[],this._shadersVersion=0,this._immutable=!1}}class Nu extends gn{get aabb(){if(!this._aabb){for(var e=new hi,t=new hi,i=0;i<this._targets.length;i++){var s=this._targets[i].aabb;e.min(s.getMin()),t.max(s.getMax())}this._aabb=new Ci,this._aabb.setMinMax(e,t)}return this._aabb}get morphPositions(){return this._morphPositions}get morphNormals(){return this._morphNormals}_init(){this._initTextureBased();for(var e=0;e<this._targets.length;e++)this._targets[e]._postInit()}_findSparseSet(e,t,i){for(var s=1,r=e[0].length,n=0;n<r;n+=3){for(var a=!1,o=0;o<e.length;o++){var l=e[o];if(0!==l[n]||0!==l[n+1]||0!==l[n+2]){a=!0;break}}a?(t.push(s),i.push(n/3),s++):t.push(0)}return s}_initTextureBased(){for(var e=[],t=[],i=0;i<this._targets.length;i++){var s=this._targets[i];s.options.deltaPositions&&(e.push(s.options.deltaPositions),t.push({target:s,name:"texturePositions"})),s.options.deltaNormals&&(e.push(s.options.deltaNormals),t.push({target:s,name:"textureNormals"}))}var r=[],n=[],a=this._findSparseSet(e,r,n),o=this.device.maxTextureSize,l=Math.ceil(Math.sqrt(a));l=Math.min(l,o);var h=Math.ceil(a/l);if(h>o)return!1;this.morphTextureWidth=l,this.morphTextureHeight=h;var c=!1,d=li.float2Half;this._textureFormat===Ri&&(c=!0);for(var u=[],f=0;f<e.length;f++)u.push(this._createTexture("MorphTarget",this._textureFormat));for(var p=0;p<e.length;p++){var m=e[p],g=u[p],v=g.lock();if(c)for(var _=0;_<n.length;_++){var b=3*n[_],y=4*_+4;v[y]=d(m[b]),v[y+1]=d(m[b+1]),v[y+2]=d(m[b+2])}else for(var x=0;x<n.length;x++){var S=3*n[x],w=4*x+4;v[w]=m[S],v[w+1]=m[S+1],v[w+2]=m[S+2]}g.unlock(),t[p].target._setTexture(t[p].name,g)}var T=[{semantic:vs,components:1,type:5,asInt:!0}];return this.vertexBufferIds=new Ir(this.device,new Nr(this.device,T,r.length),r.length,{data:new Uint32Array(r)}),!0}destroy(){var e;null==(e=this.vertexBufferIds)||e.destroy(),this.vertexBufferIds=null;for(var t=0;t<this._targets.length;t++)this._targets[t].destroy();this._targets.length=0}get targets(){return this._targets}_updateMorphFlags(){this._morphPositions=!1,this._morphNormals=!1;for(var e=0;e<this._targets.length;e++){var t=this._targets[e];t.morphPositions&&(this._morphPositions=!0),t.morphNormals&&(this._morphNormals=!0)}}_createTexture(e,t){return new ur(this.device,{width:this.morphTextureWidth,height:this.morphTextureHeight,format:t,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1,name:e})}constructor(e,t,{preferHighPrecision:i=!1}={}){super(),this.device=t;var s=t;this.preferHighPrecision=i,this._targets=e.slice();var r,n=s.textureHalfFloatRenderable?Ri:void 0,a=s.textureFloatRenderable?ki:void 0;this._renderTextureFormat=this.preferHighPrecision?null!=a?a:n:null!=n?n:a,this._renderTextureFormat=null!=(r=this._renderTextureFormat)?r:47,this.intRenderFormat=Ki(this._renderTextureFormat),this._textureFormat=this.preferHighPrecision?ki:Ri,this._init(),this._updateMorphFlags()}}class zu{destroy(){var e,t;null==(e=this.texturePositions)||e.destroy(),this.texturePositions=null,null==(t=this.textureNormals)||t.destroy(),this.textureNormals=null}get name(){return this._name}get defaultWeight(){return this._defaultWeight}get aabb(){return this._aabb||(this._aabb=new Ci,this.deltaPositions&&this._aabb.compute(this.deltaPositions)),this._aabb}get morphPositions(){return!!this.texturePositions}get morphNormals(){return!!this.textureNormals}clone(){return new zu(this.options)}_postInit(){this.options.preserveData||(this.options=null),this.used=!0}_setTexture(e,t){this[e]=t}constructor(e){this.used=!1,this.options=e,this._name=e.name,this._defaultWeight=e.defaultWeight||0,this._aabb=e.aabb,this.deltaPositions=e.deltaPositions}}function Uu(){return Uu=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var s in i)Object.prototype.hasOwnProperty.call(i,s)&&(e[s]=i[s])}return e},Uu.apply(this,arguments)}var Vu=new class extends xh{generateKey(e){var t=e.shaderDesc,i=t.vertexGLSL?Rr(t.vertexGLSL):0,s=t.fragmentGLSL?Rr(t.fragmentGLSL):0,r=t.vertexWGSL?Rr(t.vertexWGSL):0,n=t.fragmentWGSL?Rr(t.fragmentWGSL):0,a=xh.definesHash(e.defines),o=t.uniqueName+"_"+a+"_"+i+"_"+s+"_"+r+"_"+n;return e.skin&&(o+="_skin"),e.useInstancing&&(o+="_inst"),e.useMorphPosition&&(o+="_morphp"),e.useMorphNormal&&(o+="_morphn"),e.useMorphTextureBasedInt&&(o+="_morphi"),o}createAttributesDefinition(e,t){var i=t.shaderDesc.attributes,s=i?Uu({},i):void 0;t.skin&&(s.vertex_boneWeights=es,s.vertex_boneIndices=ts),(t.useMorphPosition||t.useMorphNormal)&&(s.morph_vertex_id=vs),e.attributes=s}createVertexDefinition(e,t,i,s){var r=t.shaderDesc,n=new Map(i);n.set("transformInstancingVS","");var a=new Map(t.defines);t.skin&&a.set("SKIN",!0),t.useInstancing&&a.set("INSTANCING",!0),(t.useMorphPosition||t.useMorphNormal)&&(a.set("MORPHING",!0),t.useMorphTextureBasedInt&&a.set("MORPHING_INT",!0),t.useMorphPosition&&a.set("MORPHING_POSITION",!0),t.useMorphNormal&&a.set("MORPHING_NORMAL",!0)),e.vertexCode=s?r.vertexWGSL:r.vertexGLSL,e.vertexIncludes=n,e.vertexDefines=a}createFragmentDefinition(e,t,i,s){var r=t.shaderDesc,n=new Map(i),a=new Map(t.defines);e.fragmentCode=s?r.fragmentWGSL:r.fragmentGLSL,e.fragmentIncludes=n,e.fragmentDefines=a}createShaderDefinition(e,t){var i=t.shaderDesc,s=e.isWebGPU&&i.vertexWGSL&&i.fragmentWGSL,r={name:"ShaderMaterial-"+i.uniqueName,shaderLanguage:s?Ms:Ls,fragmentOutputTypes:i.fragmentOutputTypes,meshUniformBufferFormat:i.meshUniformBufferFormat,meshBindGroupFormat:i.meshBindGroupFormat},n=s?Oc:_h,a=new Map(Object.entries(Uu({},n,t.chunks)));return this.createAttributesDefinition(r,t),this.createVertexDefinition(r,t,a,s),this.createFragmentDefinition(r,t,a,s),Ma.createDefinition(e,r)}};class Hu extends fd{set shaderDesc(e){if(this._shaderDesc=void 0,e&&(this._shaderDesc={uniqueName:e.uniqueName,attributes:e.attributes,fragmentOutputTypes:e.fragmentOutputTypes,vertexGLSL:e.vertexGLSL,fragmentGLSL:e.fragmentGLSL,vertexWGSL:e.vertexWGSL,fragmentWGSL:e.fragmentWGSL},e.vertexCode||e.fragmentCode||e.shaderLanguage)){var t,i=null!=(t=e.shaderLanguage)?t:Ls;i===Ls?(this._shaderDesc.vertexGLSL=e.vertexCode,this._shaderDesc.fragmentGLSL=e.fragmentCode):i===Ms&&(this._shaderDesc.vertexWGSL=e.vertexCode,this._shaderDesc.fragmentWGSL=e.fragmentCode)}this.clearVariants()}get shaderDesc(){return this._shaderDesc}copy(e){return super.copy(e),this.shaderDesc=e.shaderDesc,this}getShaderVariant(e){var t,{objDefs:i}=e,s={defines:Ph(this,e),skin:!!(2&i),useInstancing:!!(32&i),useMorphPosition:!!(i&eh),useMorphNormal:!!(i&th),useMorphTextureBasedInt:!!(i&ih),pass:e.pass,gamma:e.cameraShaderParams.shaderOutputGamma,toneMapping:e.cameraShaderParams.toneMapping,fog:e.cameraShaderParams.fog,shaderDesc:this.shaderDesc,chunks:null!=(t=this.chunks)?t:{}},r=new vh(e.viewUniformFormat,e.viewBindGroupFormat,e.vertexFormat),n=yh(e.device);return n.register("shader-material",Vu),n.getProgram("shader-material",s,r,this.userId)}constructor(e){super(),this.shaderDesc=e}}var Gu={linear:"decodeLinear",srgb:"decodeGamma",rgbm:"decodeRGBM",rgbe:"decodeRGBE",rgbp:"decodeRGBP",xy:"unpackNormalXY",xyz:"unpackNormalXYZ"},Wu={linear:"encodeLinear",srgb:"encodeGamma",rgbm:"encodeRGBM",rgbe:"encodeRGBE",rgbp:"encodeRGBP"};class ju{static decodeFunc(e){var t;return null!=(t=Gu[e])?t:"decodeGamma"}static encodeFunc(e){var t;return null!=(t=Wu[e])?t:"encodeGamma"}static getScreenDepthChunk(e,t){return"\n            "+(t.sceneDepthMapLinear?"#define SCENE_DEPTHMAP_LINEAR":"")+"\n            "+(e.textureFloatRenderable?"#define SCENE_DEPTHMAP_FLOAT":"")+"\n            "+_h.screenDepthPS+"\n        "}}var qu=(e,t)=>{for(var i=t.length/3,s=e.length/3,r=new hi,n=new hi,a=new hi,o=new hi,l=new hi,h=new hi,c=[],d=0;d<e.length;d++)c[d]=0;for(var u=0;u<i;u++){var f=t[3*u],p=t[3*u+1],m=t[3*u+2];r.set(e[3*f],e[3*f+1],e[3*f+2]),n.set(e[3*p],e[3*p+1],e[3*p+2]),a.set(e[3*m],e[3*m+1],e[3*m+2]),o.sub2(n,r),l.sub2(a,r),h.cross(o,l).normalize(),c[3*f]+=h.x,c[3*f+1]+=h.y,c[3*f+2]+=h.z,c[3*p]+=h.x,c[3*p+1]+=h.y,c[3*p+2]+=h.z,c[3*m]+=h.x,c[3*m+1]+=h.y,c[3*m+2]+=h.z}for(var g=0;g<s;g++){var v=c[3*g],_=c[3*g+1],b=c[3*g+2],y=1/Math.sqrt(v*v+_*_+b*b);c[3*g]*=y,c[3*g+1]*=y,c[3*g+2]*=y}return c},Xu=(e,t,i,s)=>{for(var r=s.length/3,n=e.length/3,a=new hi,o=new hi,l=new hi,h=new di,c=new di,d=new di,u=new hi,f=new hi,p=new Float32Array(3*n),m=new Float32Array(3*n),g=[],v=0;v<r;v++){var _=s[3*v],b=s[3*v+1],y=s[3*v+2];a.set(e[3*_],e[3*_+1],e[3*_+2]),o.set(e[3*b],e[3*b+1],e[3*b+2]),l.set(e[3*y],e[3*y+1],e[3*y+2]),h.set(i[2*_],i[2*_+1]),c.set(i[2*b],i[2*b+1]),d.set(i[2*y],i[2*y+1]);var x=o.x-a.x,S=l.x-a.x,w=o.y-a.y,T=l.y-a.y,C=o.z-a.z,E=l.z-a.z,A=c.x-h.x,P=d.x-h.x,D=c.y-h.y,L=d.y-h.y,M=A*L-P*D;if(0===M)u.set(0,1,0),f.set(1,0,0);else{var I=1/M;u.set((L*x-D*S)*I,(L*w-D*T)*I,(L*C-D*E)*I),f.set((A*S-P*x)*I,(A*T-P*w)*I,(A*E-P*C)*I)}p[3*_+0]+=u.x,p[3*_+1]+=u.y,p[3*_+2]+=u.z,p[3*b+0]+=u.x,p[3*b+1]+=u.y,p[3*b+2]+=u.z,p[3*y+0]+=u.x,p[3*y+1]+=u.y,p[3*y+2]+=u.z,m[3*_+0]+=f.x,m[3*_+1]+=f.y,m[3*_+2]+=f.z,m[3*b+0]+=f.x,m[3*b+1]+=f.y,m[3*b+2]+=f.z,m[3*y+0]+=f.x,m[3*y+1]+=f.y,m[3*y+2]+=f.z}for(var R=new hi,k=new hi,O=new hi,F=new hi,B=0;B<n;B++){O.set(t[3*B],t[3*B+1],t[3*B+2]),R.set(p[3*B],p[3*B+1],p[3*B+2]),k.set(m[3*B],m[3*B+1],m[3*B+2]);var N=O.dot(R);F.copy(O).mulScalar(N),F.sub2(R,F).normalize(),g[4*B]=F.x,g[4*B+1]=F.y,g[4*B+2]=F.z,F.cross(O,R),g[4*B+3]=F.dot(k)<0?-1:1}return g};class Ku{calculateNormals(){this.normals=qu(this.positions,this.indices)}calculateTangents(){this.tangents=Xu(this.positions,this.normals,this.uvs,this.indices)}}var Yu=4/64;class Qu extends Ku{constructor(e={}){var t;super();var i,s,r,n,a=null!=(t=e.halfExtents)?t:new hi(.5,.5,.5),o=null!=(i=e.widthSegments)?i:1,l=null!=(s=e.lengthSegments)?s:1,h=null!=(r=e.heightSegments)?r:1,c=null!=(n=e.yOffset)?n:0,d=-a.y+c,u=a.y+c,f=[new hi(-a.x,d,a.z),new hi(a.x,d,a.z),new hi(a.x,u,a.z),new hi(-a.x,u,a.z),new hi(a.x,d,-a.z),new hi(-a.x,d,-a.z),new hi(-a.x,u,-a.z),new hi(a.x,u,-a.z)],p=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]],m=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],g=1,v=2,_=3,b=4,y=5,x=[],S=[],w=[],T=[],C=0,E=(e,t,i)=>{for(var s=new hi,r=new hi,n=new hi,a=new hi,o=0;o<=t;o++)for(var l=0;l<=i;l++){s.lerp(f[p[e][0]],f[p[e][1]],o/t),r.lerp(f[p[e][0]],f[p[e][2]],l/i),n.sub2(r,f[p[e][0]]),a.add2(s,n);var h=o/t,c=l/i;x.push(a.x,a.y,a.z),S.push(m[e][0],m[e][1],m[e][2]),w.push(h,1-c),h=.875*h+Yu,c=.875*c+Yu,h/=3,c/=3,h+=e%3/3,c+=Math.floor(e/3)/3,o<t&&l<i&&(T.push(C+i+1,C+1,C),T.push(C+i+1,C+i+2,C+1)),C++}};E(0,o,h),E(g,o,h),E(v,o,l),E(_,o,l),E(b,l,h),E(y,l,h),this.positions=x,this.normals=S,this.uvs=w,this.uvs1=w,this.indices=T,e.calculateTangents&&(this.tangents=Xu(x,S,w,T))}}class Ju extends Ku{constructor(e={}){var t;super();for(var i,s,r=null!=(t=e.radius)?t:.5,n=null!=(i=e.latitudeBands)?i:16,a=null!=(s=e.longitudeBands)?s:16,o=[],l=[],h=[],c=[],d=0;d<=n;d++)for(var u=d*Math.PI/n,f=Math.sin(u),p=Math.cos(u),m=0;m<=a;m++){var g=2*m*Math.PI/a-Math.PI/2,v=Math.sin(g),_=Math.cos(g)*f,b=p,y=v*f,x=1-m/a,S=1-d/n;o.push(_*r,b*r,y*r),l.push(_,b,y),h.push(x,1-S)}for(var w=0;w<n;++w)for(var T=0;T<a;++T){var C=w*(a+1)+T,E=C+a+1;c.push(C+1,E,C),c.push(C+1,E+1,E)}this.positions=o,this.normals=l,this.uvs=h,this.uvs1=h,this.indices=c,e.calculateTangents&&(this.tangents=Xu(o,l,h,c))}}class $u extends Ju{constructor(e={}){var t,i,s=.5;super({radius:s,latitudeBands:null!=(t=e.latitudeBands)?t:16,longitudeBands:null!=(i=e.longitudeBands)?i:16});for(var r=this.positions,n=0;n<r.length;n+=3){var a=r[n]/s,o=r[n+1]/s,l=r[n+2]/s;o<0&&(o*=.3,a*a+l*l<.9025&&(o=-.1)),o+=.1,o*=s,r[n+1]=o}}}class Zu{static create(e,t){switch(t){case"box":return Zu.box(e);case hh:return Zu.dome(e)}return Zu.infinite(e)}static infinite(e){return Gh.fromGeometry(e,new Qu(e))}static box(e){return Gh.fromGeometry(e,new Qu({yOffset:.5}))}static dome(e){var t=new $u({latitudeBands:50,longitudeBands:50});return t.normals=void 0,t.uvs=void 0,Gh.fromGeometry(e,t)}}class ef{destroy(){this.meshInstance&&(this.skyLayer&&this.skyLayer.removeMeshInstances([this.meshInstance]),this.meshInstance.destroy(),this.meshInstance=null)}constructor(e,t,i,s,r){this.meshInstance=null;var n=new Hu({uniqueName:"SkyMaterial",vertexGLSL:_h.skyboxVS,fragmentGLSL:_h.skyboxPS,vertexWGSL:Oc.skyboxVS,fragmentWGSL:Oc.skyboxPS,attributes:{aPosition:Ji}});n.setDefine("{SKYBOX_DECODE_FNC}",ju.decodeFunc(s.encoding)),r!==lh&&n.setDefine("SKYMESH",""),s.cubemap&&n.setDefine("SKY_CUBEMAP",""),n.setParameter("skyboxHighlightMultiplier",t.skyboxHighlightMultiplier),s.cubemap?n.setParameter("texture_cubeMap",s):(n.setParameter("texture_envAtlas",s),n.setParameter("mipLevel",t.skyboxMip)),n.cull=2,n.depthWrite=!1;var a=t.layers.getLayerById(2);if(a){var o=Zu.create(e,r),l=new tc(o,n,i);this.meshInstance=l,l.cull=!1,l.pick=!1,a.addMeshInstances([l]),this.skyLayer=a}}}class tf{applySettings(e){var t,i,s,r;this.type=null!=(t=e.skyType)?t:lh,this.node.setLocalPosition(new hi(null!=(i=e.skyMeshPosition)?i:[0,0,0])),this.node.setLocalEulerAngles(new hi(null!=(s=e.skyMeshRotation)?s:[0,0,0])),this.node.setLocalScale(new hi(null!=(r=e.skyMeshScale)?r:[1,1,1])),e.skyCenter&&(this._center=new hi(e.skyCenter))}set type(e){this._type!==e&&(this._type=e,this.scene.updateShaders=!0,this.updateSkyMesh())}get type(){return this._type}set center(e){this._center.copy(e)}get center(){return this._center}updateSkyMesh(){var e=this.scene._getSkyboxTex();e&&(this.resetSkyMesh(),this.skyMesh=new ef(this.device,this.scene,this.node,e,this.type),this.scene.fire("set:skybox",e))}resetSkyMesh(){var e;null==(e=this.skyMesh)||e.destroy(),this.skyMesh=null}update(){if(this.type!==lh){var{center:e,centerArray:t}=this,i=new hi;this.node.getWorldTransform().transformPoint(e,i),t[0]=i.x,t[1]=i.y,t[2]=i.z,this.projectedSkydomeCenterId.setValue(t)}}constructor(e){this._type=lh,this._center=new hi(0,1,0),this.skyMesh=null,this.node=new Lc("SkyMeshNode"),this.device=e.device,this.scene=e,this.center=new hi(0,1,0),this.centerArray=new Float32Array(3),this.projectedSkydomeCenterId=this.device.scope.resolve("projectedSkydomeCenter")}}var sf=new Lc;sf.worldTransform=_i.IDENTITY,sf._dirtyWorld=sf._dirtyNormal=!1;class rf{addLines(e,t){for(var i=this.positions,s=e.length,r=0;r<s;r++){var n=e[r];i.push(n.x,n.y,n.z)}var a=this.colors;if(t.length)for(var o=0;o<s;o++){var l=t[o];a.push(l.r,l.g,l.b,l.a)}else for(var h=0;h<s;h++)a.push(t.r,t.g,t.b,t.a)}addLinesArrays(e,t){for(var i=this.positions,s=0;s<e.length;s+=3)i.push(e[s],e[s+1],e[s+2]);var r=this.colors;if(t.length)for(var n=0;n<t.length;n+=4)r.push(t[n],t[n+1],t[n+2],t[n+3]);else for(var a=e.length/3,o=0;o<a;o++)r.push(t.r,t.g,t.b,t.a)}onPreRender(e,t){this.positions.length>0&&this.material.transparent===t&&(this.mesh.setPositions(this.positions),this.mesh.setColors(this.colors),this.mesh.update(1,!1),this.meshInstance||(this.meshInstance=new tc(this.mesh,this.material,sf)),e.push(this.meshInstance))}clear(){this.positions.length=0,this.colors.length=0}constructor(e,t,i){this.material=t,this.layer=i,this.positions=[],this.colors=[],this.mesh=new Gh(e),this.meshInstance=null}}class nf{getBatch(e,t){var i=this.map.get(e);return i||(i=new rf(this.device,e,t),this.map.set(e,i)),i}onPreRender(e,t){this.map.forEach((i=>{i.onPreRender(e,t)}))}clear(){this.map.forEach((e=>e.clear()))}constructor(e){this.device=e,this.map=new Map}}var af=[],of=new hi,lf={uniqueName:"ImmediateLine",vertexGLSL:_h.immediateLineVS,fragmentGLSL:_h.immediateLinePS,vertexWGSL:Oc.immediateLineVS,fragmentWGSL:Oc.immediateLinePS,attributes:{vertex_position:Ji,vertex_color:is}};class hf{createMaterial(e){var t=new Hu(lf);return t.blendType=2,t.depthTest=e,t.update(),t}get materialDepth(){return this._materialDepth||(this._materialDepth=this.createMaterial(!0)),this._materialDepth}get materialNoDepth(){return this._materialNoDepth||(this._materialNoDepth=this.createMaterial(!1)),this._materialNoDepth}getBatch(e,t){var i=this.batchesMap.get(e);i||(i=new nf(this.device),this.batchesMap.set(e,i)),this.allBatches.add(i);var s=t?this.materialDepth:this.materialNoDepth;return i.getBatch(s,e)}getShaderDesc(e,t){if(!this.shaderDescs.has(e)){this.shaderDescs.set(e,{uniqueName:"DebugShader:"+e,vertexGLSL:"\n\t\t\t\tattribute vec2 vertex_position;\n\t\t\t\tuniform mat4 matrix_model;\n\t\t\t\tvarying vec2 uv0;\n\t\t\t\tvoid main(void) {\n\t\t\t\t\tgl_Position = matrix_model * vec4(vertex_position, 0, 1);\n\t\t\t\t\tuv0 = vertex_position.xy + 0.5;\n\t\t\t\t}\n\t\t\t",fragmentGLSL:t,attributes:{vertex_position:Ji}})}return this.shaderDescs.get(e)}getTextureShaderDesc(e){var t=ju.decodeFunc(e);return this.getShaderDesc("textureShader-"+e,'\n\t\t\t#include "gammaPS"\n\t\t\tvarying vec2 uv0;\n\t\t\tuniform sampler2D colorMap;\n\t\t\tvoid main (void) {\n\t\t\t\tvec3 linearColor = '+t+"(texture2D(colorMap, uv0));\n\t\t\t\tgl_FragColor = vec4(gammaCorrectOutput(linearColor), 1);\n\t\t\t}\n\t\t")}getUnfilterableTextureShaderDesc(){return this.getShaderDesc("textureShaderUnfilterable","\n\t\t\tvarying vec2 uv0;\n\t\t\tuniform highp sampler2D colorMap;\n\t\t\tvoid main (void) {\n\t\t\t\tivec2 uv = ivec2(uv0 * textureSize(colorMap, 0));\n\t\t\t\tgl_FragColor = vec4(texelFetch(colorMap, uv, 0).xyz, 1);\n\t\t\t}\n\t\t")}getDepthTextureShaderDesc(){return this.getShaderDesc("depthTextureShader","\n\t\t\t"+_h.screenDepthPS+'\n\t\t\t#include "gammaPS"\n\t\t\tvarying vec2 uv0;\n\t\t\tvoid main() {\n\t\t\t\tfloat depth = getLinearScreenDepth(getImageEffectUV(uv0)) * camera_params.x;\n\t\t\t\tgl_FragColor = vec4(gammaCorrectOutput(vec3(depth)), 1.0);\n\t\t\t}\n\t\t')}getQuadMesh(){return this.quadMesh||(this.quadMesh=new Gh(this.device),this.quadMesh.setPositions([-.5,-.5,0,.5,-.5,0,-.5,.5,0,.5,.5,0]),this.quadMesh.update(5)),this.quadMesh}drawMesh(e,t,i,s,r){if(!s){var n=this.getGraphNode(t);s=new tc(i,e,n)}var a=this.layerMeshInstances.get(r);a||(a=[],this.layerMeshInstances.set(r,a)),a.push(s)}drawWireAlignedBox(e,t,i,s,r,n){if(n){var a=(e,t,i)=>{of.set(e,t,i),n.transformPoint(of,of),af.push(of.x,of.y,of.z)};a(e.x,e.y,e.z),a(e.x,t.y,e.z),a(e.x,t.y,e.z),a(t.x,t.y,e.z),a(t.x,t.y,e.z),a(t.x,e.y,e.z),a(t.x,e.y,e.z),a(e.x,e.y,e.z),a(e.x,e.y,t.z),a(e.x,t.y,t.z),a(e.x,t.y,t.z),a(t.x,t.y,t.z),a(t.x,t.y,t.z),a(t.x,e.y,t.z),a(t.x,e.y,t.z),a(e.x,e.y,t.z),a(e.x,e.y,e.z),a(e.x,e.y,t.z),a(e.x,t.y,e.z),a(e.x,t.y,t.z),a(t.x,t.y,e.z),a(t.x,t.y,t.z),a(t.x,e.y,e.z),a(t.x,e.y,t.z)}else af.push(e.x,e.y,e.z,e.x,t.y,e.z,e.x,t.y,e.z,t.x,t.y,e.z,t.x,t.y,e.z,t.x,e.y,e.z,t.x,e.y,e.z,e.x,e.y,e.z,e.x,e.y,t.z,e.x,t.y,t.z,e.x,t.y,t.z,t.x,t.y,t.z,t.x,t.y,t.z,t.x,e.y,t.z,t.x,e.y,t.z,e.x,e.y,t.z,e.x,e.y,e.z,e.x,e.y,t.z,e.x,t.y,e.z,e.x,t.y,t.z,t.x,t.y,e.z,t.x,t.y,t.z,t.x,e.y,e.z,t.x,e.y,t.z);this.getBatch(r,s).addLinesArrays(af,i),af.length=0}drawWireSphere(e,t,i,s,r,n){for(var a=2*Math.PI/s,o=0,l=0;l<s;l++){var h=Math.sin(o),c=Math.cos(o);o+=a;var d=Math.sin(o),u=Math.cos(o);af.push(e.x+t*h,e.y,e.z+t*c),af.push(e.x+t*d,e.y,e.z+t*u),af.push(e.x+t*h,e.y+t*c,e.z),af.push(e.x+t*d,e.y+t*u,e.z),af.push(e.x,e.y+t*h,e.z+t*c),af.push(e.x,e.y+t*d,e.z+t*u)}this.getBatch(n,r).addLinesArrays(af,i),af.length=0}getGraphNode(e){var t=new Lc("ImmediateDebug");return t.worldTransform=e,t._dirtyWorld=t._dirtyNormal=!1,t}onPreRenderLayer(e,t,i){if(this.batchesMap.forEach(((s,r)=>{r===e&&s.onPreRender(t,i)})),!this.updatedLayers.has(e)){this.updatedLayers.add(e);var s=this.layerMeshInstances.get(e);if(s){for(var r=0;r<s.length;r++)t.push(s[r]);s.length=0}}}onPostRender(){this.allBatches.forEach((e=>e.clear())),this.allBatches.clear(),this.updatedLayers.clear()}constructor(e){this.shaderDescs=new Map,this.device=e,this.quadMesh=null,this.textureShader=null,this.depthTextureShader=null,this.cubeLocalPos=null,this.cubeWorldPos=null,this.batchesMap=new Map,this.allBatches=new Set,this.updatedLayers=new Set,this._materialDepth=null,this._materialNoDepth=null,this.layerMeshInstances=new Map}}var cf=2.399963229728653,df={circlePoint(e){var t=Math.sqrt(Math.random()),i=2*Math.random()*Math.PI;e.x=t*Math.cos(i),e.y=t*Math.sin(i)},circlePointDeterministic(e,t,i){var s=t*cf,r=Math.sqrt(t)/Math.sqrt(i);e.x=r*Math.cos(s),e.y=r*Math.sin(s)},spherePointDeterministic(e,t,i,s,r){void 0===s&&(s=0),void 0===r&&(r=1),s=1-2*s,r=1-2*r;var n=ti.lerp(s,r,t/i),a=Math.sqrt(1-n*n),o=cf*t;e.x=Math.cos(o)*a,e.y=n,e.z=Math.sin(o)*a},radicalInverse(e){var t=(e<<16|e>>>16)>>>0;return 2.3283064365386963e-10*(t=((16711935&(t=((252645135&(t=((858993459&(t=((1431655765&t)<<1|(2863311530&t)>>>1)>>>0))<<2|(3435973836&t)>>>2)>>>0))<<4|(4042322160&t)>>>4)>>>0))<<8|(4278255360&t)>>>8)>>>0)}},uf=e=>{switch(e){case Ps:return"Cubemap";case"octahedral":return"Octahedral";default:return"Equirect"}},ff=(e,t,i)=>{if(e<=0)t[i+0]=0,t[i+1]=0,t[i+2]=0,t[i+3]=0;else if(e>=1)t[i+0]=255,t[i+1]=0,t[i+2]=0,t[i+3]=0;else{var s=1*e%1,r=255*e%1,n=65025*e%1,a=16581375*e%1;s-=r/255,r-=n/255,n-=a/255,t[i+0]=Math.min(255,Math.floor(256*s)),t[i+1]=Math.min(255,Math.floor(256*r)),t[i+2]=Math.min(255,Math.floor(256*n)),t[i+3]=Math.min(255,Math.floor(256*a))}},pf=(e,t,i,s)=>{var r=2*i*Math.PI,n=Math.pow(1-t,1/(s+1)),a=Math.sqrt(1-n*n);e.set(Math.cos(r)*a,Math.sin(r)*a,n).normalize()},mf=(e,t,i)=>{var s=2*i*Math.PI,r=Math.sqrt(1-t),n=Math.sqrt(t);e.set(Math.cos(s)*n,Math.sin(s)*n,r).normalize()},gf=(e,t,i,s)=>{var r=2*i*Math.PI,n=Math.sqrt((1-t)/(1+(s*s-1)*t)),a=Math.sqrt(1-n*n);e.set(Math.cos(r)*a,Math.sin(r)*a,n).normalize()},vf=(e,t)=>{var i=e*t,s=t/(1-e*e+i*i);return s*s*(1/Math.PI)},_f={16:{2:26,8:20,32:17,128:16,512:16},32:{2:53,8:40,32:34,128:32,512:32},128:{2:214,8:163,32:139,128:130,512:128},1024:{2:1722,8:1310,32:1114,128:1041,512:1025}},bf=(e,t,i)=>{for(var s=i/e,r=1-Math.log2(t)/11,n=r*r,a=new hi,o=new hi,l=new hi(0,0,1),h=[],c=((e,t)=>{var i=_f[e];return i&&i[t]||e})(e,t),d=0;d<c;++d){gf(a,d/c,df.radicalInverse(d),n);var u=a.z;if(o.set(a.x,a.y,a.z).mulScalar(2*u).sub(l),o.z>0){var f=vf(Math.min(1,u),n)/4+.001,p=.5*Math.log2(s/f);h.push(o.x,o.y,o.z,p)}}for(;h.length<4*e;)h.push(0,0,0,0);return h},yf=(e,t,i)=>{var s=(e=>{for(var t=e.length,i=Math.min(t,512),s=Math.ceil(t/i),r=new Uint8Array(i*s*4),n=0,a=0;a<t;a+=4)ff(.5*e[a+0]+.5,r,n+0),ff(.5*e[a+1]+.5,r,n+4),ff(.5*e[a+2]+.5,r,n+8),ff(e[a+3]/8,r,n+12),n+=16;return{width:i,height:s,data:r}})(i);return new ur(e,{name:t,width:s.width,height:s.height,mipmaps:!1,minFilter:0,magFilter:0,levels:[s.data]})};class xf{destroy(){this.destroyContent&&this.map.forEach(((e,t)=>{e.destroy()}))}get(e,t){if(!this.map.has(e)){var i=t();return this.map.set(e,i),i}return this.map.get(e)}constructor(e=!0){this.map=new Map,this.destroyContent=e}}var Sf=new xf(!1),wf=new hr,Tf=(e,t,i)=>wf.get(e,(()=>new xf)).get(t,(()=>yf(e,t,Sf.get(t,i)))),Cf=(e,t,i)=>Tf(e,"lambert-samples-"+t+"-"+i,(()=>((e,t)=>{for(var i=t/e,s=new hi,r=[],n=0;n<e;++n){mf(s,n/e,df.radicalInverse(n));var a=s.z/Math.PI,o=.5*Math.log2(i/a);r.push(s.x,s.y,s.z,o)}return r})(t,i))),Ef=(e,t,i)=>Tf(e,"phong-samples-"+t+"-"+i,(()=>((e,t)=>{for(var i=new hi,s=[],r=0;r<e;++r)pf(i,r/e,df.radicalInverse(r),t),s.push(i.x,i.y,i.z,0);return s})(t,i)));function Af(e,t,i){var s,r,n;void 0===i&&(i={});var a,o,l=null!=(n=i.seamPixels)?n:0,h=(null!=(a=null==(s=i.rect)?void 0:s.z)?a:t.width)-2*l,c=(null!=(o=null==(r=i.rect)?void 0:r.w)?o:t.height)-2*l;if(h<1||c<1)return!1;var d=i.hasOwnProperty("specularPower")?i.specularPower:1,u=i.hasOwnProperty("face")?i.face:null,f=i.hasOwnProperty("distribution")?i.distribution:1===d?"none":"phong",p={none:"reproject",lambert:"prefilterSamplesUnweighted",phong:"prefilterSamplesUnweighted",ggx:"prefilterSamples"}[f]||"reproject",m=p.startsWith("prefilterSamples"),g=ju.decodeFunc(e.encoding),v=ju.encodeFunc(t.encoding),_="sample"+uf(e.projection),b="getDirection"+uf(t.projection),y=i.hasOwnProperty("numSamples")?i.numSamples:1024,x=p+"_"+g+"_"+v+"_"+_+"_"+b+"_"+y,S=e.device,w=yh(S).getCachedShader(x);if(!w){var T="\n            "+(m?"#define USE_SAMPLES_TEX":"")+"\n            "+(e.cubemap?"#define CUBEMAP_SOURCE":"")+"\n            #define {PROCESS_FUNC} "+p+"\n            #define {DECODE_FUNC} "+g+"\n            #define {ENCODE_FUNC} "+v+"\n            #define {SOURCE_FUNC} "+_+"\n            #define {TARGET_FUNC} "+b+"\n            #define {NUM_SAMPLES} "+y+"\n            #define {NUM_SAMPLES_SQRT} "+Math.round(Math.sqrt(y)).toFixed(1)+"\n        ",C=S.isWebGPU,E=C?Oc:_h,A=new Map;A.set("decodePS",E.decodePS),A.set("encodePS",E.encodePS),w=Eh(S,E.reprojectVS,"\n                "+T+"\n                "+E.reprojectPS+"\n            ",x,{vertex_position:Ji},{fragmentIncludes:A,shaderLanguage:C?Ms:Ls})}S.setBlendState(Sr.NOBLEND),S.scope.resolve(e.cubemap?"sourceCube":"sourceTex").setValue(e);var P=S.scope.resolve("params"),D=S.scope.resolve("uvMod");l>0?D.setValue([(h+2*l)/h,(c+2*l)/c,-l/h,-l/c]):D.setValue([1,1,0,0]);var L=[0,t.width*t.height*(t.cubemap?6:1),e.width*e.height*(e.cubemap?6:1)];if(m){var M=e.width*e.height*(e.cubemap?6:1),I="ggx"===f?((e,t,i,s)=>Tf(e,"ggx-samples-"+t+"-"+i+"-"+s,(()=>bf(t,i,s))))(S,y,d,M):"lambert"===f?Cf(S,y,M):Ef(S,y,d);S.scope.resolve("samplesTex").setValue(I),S.scope.resolve("samplesTexInverseSize").setValue([1/I.width,1/I.height])}for(var R=0;R<(t.cubemap?6:1);R++)if(null===u||R===u){var k=new Wr({colorBuffer:t,face:R,depth:!1,flipY:S.isWebGPU});L[0]=R,P.setValue(L),Fh(S,k,w,null==i?void 0:i.rect),k.destroy()}return!0}var Pf=(e,t)=>(void 0===t&&(t=0),1+Math.floor(Math.log2(Math.max(e,t))));class Df{static generateSkyboxCubemap(e,t){var i=((e,t,i)=>new ur(e,{name:"lighting-"+t,cubemap:!0,width:t,height:t,format:i,type:xs,addressU:1,addressV:1,mipmaps:!1}))(e.device,t||(e.cubemap?e.width:e.width/4),7);return Af(e,i,{numSamples:1024}),i}static generateLightingSource(e,t){var i=e.device,s=(e=>(e=>e.textureHalfFloatRenderable)(e)?Ri:(e=>e.textureFloatRenderable)(e)?ki:7)(i),r=(null==t?void 0:t.target)||new ur(i,{name:"lighting-source",cubemap:!0,width:(null==t?void 0:t.size)||128,height:(null==t?void 0:t.size)||128,format:s,type:7===s?xs:_s,addressU:1,addressV:1,mipmaps:!0});return Af(e,r,{numSamples:e.mipmaps?1:1024}),r}static generateAtlas(e,t){for(var i=e.device,s=(null==t?void 0:t.target)||new ur(i,{name:"envAtlas",width:(null==t?void 0:t.size)||512,height:(null==t?void 0:t.size)||512,format:7,type:xs,projection:Ds,addressU:1,addressV:1,mipmaps:!1}),r=s.width/512,n=new ui(0,0,512*r,256*r),a=Pf(256)-Pf(4),o=0;o<a;++o)Af(e,s,{numSamples:1,rect:n,seamPixels:r}),n.x+=n.w,n.y+=n.w,n.z=Math.max(1,Math.floor(.5*n.z)),n.w=Math.max(1,Math.floor(.5*n.w));n.set(0,256*r,256*r,128*r);for(var l=1;l<7;++l)Af(e,s,{numSamples:(null==t?void 0:t.numReflectionSamples)||1024,distribution:(null==t?void 0:t.distribution)||"ggx",specularPower:Math.max(1,2048>>2*l),rect:n,seamPixels:r}),n.y+=n.w,n.z=Math.max(1,Math.floor(.5*n.z)),n.w=Math.max(1,Math.floor(.5*n.w));return n.set(128*r,384*r,64*r,32*r),Af(e,s,{numSamples:(null==t?void 0:t.numAmbientSamples)||2048,distribution:"lambert",rect:n,seamPixels:r}),s}static generatePrefilteredAtlas(e,t){for(var i=e[0].device,s=e[0].format,r=e[0].type,n=(null==t?void 0:t.target)||new ur(i,{name:"envPrefilteredAtlas",width:(null==t?void 0:t.size)||512,height:(null==t?void 0:t.size)||512,format:s,type:r,projection:Ds,addressU:1,addressV:1,mipmaps:!1}),a=n.width/512,o=new ui(0,0,512*a,256*a),l=Pf(512),h=0;h<l;++h)Af(e[0],n,{numSamples:1,rect:o,seamPixels:a}),o.x+=o.w,o.y+=o.w,o.z=Math.max(1,Math.floor(.5*o.z)),o.w=Math.max(1,Math.floor(.5*o.w));o.set(0,256*a,256*a,128*a);for(var c=1;c<e.length;++c)Af(e[c],n,{numSamples:1,rect:o,seamPixels:a}),o.y+=o.w,o.z=Math.max(1,Math.floor(.5*o.z)),o.w=Math.max(1,Math.floor(.5*o.w));return o.set(128*a,384*a,64*a,32*a),(null==t?void 0:t.legacyAmbient)?Af(e[5],n,{numSamples:1,rect:o,seamPixels:a}):Af(e[0],n,{numSamples:(null==t?void 0:t.numSamples)||2048,distribution:"lambert",rect:o,seamPixels:a}),n}}class Lf{constructor(){this.type=ml,this.color=new ii(0,0,0),this.density=0,this.start=1,this.end=1e3}}class Mf extends Ht{get defaultDrawLayer(){return this.layers.getLayerById(3)}set ambientBakeNumSamples(e){this._ambientBakeNumSamples=ti.clamp(Math.floor(e),1,255)}get ambientBakeNumSamples(){return this._ambientBakeNumSamples}set ambientBakeSpherePart(e){this._ambientBakeSpherePart=ti.clamp(e,.001,1)}get ambientBakeSpherePart(){return this._ambientBakeSpherePart}set clusteredLightingEnabled(e){this.device.isWebGPU&&!e||(this._clusteredLightingEnabled||!e?this._clusteredLightingEnabled=e:console.error("Turning on disabled clustered lighting is not currently supported"))}get clusteredLightingEnabled(){return this._clusteredLightingEnabled}set envAtlas(e){e!==this._envAtlas&&(this._envAtlas=e,e&&(e.addressU=1,e.addressV=1,e.minFilter=1,e.magFilter=1,e.mipmaps=!1),this._prefilteredCubemaps=[],this._internalEnvAtlas&&(this._internalEnvAtlas.destroy(),this._internalEnvAtlas=null),this._resetSkyMesh())}get envAtlas(){return this._envAtlas}set layers(e){var t=this._layers;this._layers=e,this.fire("set:layers",t,e)}get layers(){return this._layers}get sky(){return this._sky}get lighting(){return this._lightingParams}get fog(){return this._fogParams}set lightmapFilterRange(e){this._lightmapFilterRange=Math.max(e,.001)}get lightmapFilterRange(){return this._lightmapFilterRange}set lightmapFilterSmoothness(e){this._lightmapFilterSmoothness=Math.max(e,.001)}get lightmapFilterSmoothness(){return this._lightmapFilterSmoothness}set prefilteredCubemaps(e){e=e||[];var t=this._prefilteredCubemaps,i=t.length!==e.length||t.some(((t,i)=>t!==e[i]));if(i){var s=6===e.length&&e.every((e=>!!e));s?(this._internalEnvAtlas=Df.generatePrefilteredAtlas(e,{target:this._internalEnvAtlas}),this._envAtlas=this._internalEnvAtlas):(this._internalEnvAtlas&&(this._internalEnvAtlas.destroy(),this._internalEnvAtlas=null),this._envAtlas=null),this._prefilteredCubemaps=e.slice(),this._resetSkyMesh()}}get prefilteredCubemaps(){return this._prefilteredCubemaps}set skybox(e){e!==this._skyboxCubeMap&&(this._skyboxCubeMap=e,this._resetSkyMesh())}get skybox(){return this._skyboxCubeMap}set skyboxIntensity(e){e!==this._skyboxIntensity&&(this._skyboxIntensity=e,this._resetSkyMesh())}get skyboxIntensity(){return this._skyboxIntensity}set skyboxLuminance(e){e!==this._skyboxLuminance&&(this._skyboxLuminance=e,this._resetSkyMesh())}get skyboxLuminance(){return this._skyboxLuminance}set skyboxMip(e){e!==this._skyboxMip&&(this._skyboxMip=e,this._resetSkyMesh())}get skyboxMip(){return this._skyboxMip}set skyboxHighlightMultiplier(e){e!==this._skyboxHighlightMultiplier&&(this._skyboxHighlightMultiplier=e,this._resetSkyMesh())}get skyboxHighlightMultiplier(){return this._skyboxHighlightMultiplier}set skyboxRotation(e){if(!this._skyboxRotation.equals(e)){var t=e.equals(bi.IDENTITY);this._skyboxRotation.copy(e),t?this._skyboxRotationMat3.setIdentity():(this._skyboxRotationMat4.setTRS(hi.ZERO,e,hi.ONE),this._skyboxRotationMat3.invertMat4(this._skyboxRotationMat4)),this._skyboxRotationShaderInclude||t||(this._skyboxRotationShaderInclude=!0,this._resetSkyMesh())}}get skyboxRotation(){return this._skyboxRotation}destroy(){this._resetSkyMesh(),this.root=null,this.off()}drawLine(e,t,i,s,r){void 0===i&&(i=ii.WHITE),void 0===s&&(s=!0),void 0===r&&(r=this.defaultDrawLayer),this.immediate.getBatch(r,s).addLines([e,t],[i,i])}drawLines(e,t,i,s){void 0===i&&(i=!0),void 0===s&&(s=this.defaultDrawLayer),this.immediate.getBatch(s,i).addLines(e,t)}drawLineArrays(e,t,i,s){void 0===i&&(i=!0),void 0===s&&(s=this.defaultDrawLayer),this.immediate.getBatch(s,i).addLinesArrays(e,t)}applySettings(e){var t,i,s,r,n=e.physics,a=e.render;this._gravity.set(n.gravity[0],n.gravity[1],n.gravity[2]),this.ambientLight.set(a.global_ambient[0],a.global_ambient[1],a.global_ambient[2]),this.ambientLuminance=a.ambientLuminance,this.fog.type=a.fog,this.fog.color.set(a.fog_color[0],a.fog_color[1],a.fog_color[2]),this.fog.start=a.fog_start,this.fog.end=a.fog_end,this.fog.density=a.fog_density,this.lightmapSizeMultiplier=a.lightmapSizeMultiplier,this.lightmapMaxResolution=a.lightmapMaxResolution,this.lightmapMode=a.lightmapMode,this.exposure=a.exposure,this._skyboxIntensity=null!=(t=a.skyboxIntensity)?t:1,this._skyboxLuminance=null!=(i=a.skyboxLuminance)?i:2e4,this._skyboxMip=null!=(s=a.skyboxMip)?s:0,a.skyboxRotation&&(this.skyboxRotation=(new bi).setFromEulerAngles(a.skyboxRotation[0],a.skyboxRotation[1],a.skyboxRotation[2])),this.sky.applySettings(a),this.clusteredLightingEnabled=null!=(r=a.clusteredLightingEnabled)&&r,this.lighting.applySettings(a),["lightmapFilterEnabled","lightmapFilterRange","lightmapFilterSmoothness","ambientBake","ambientBakeNumSamples","ambientBakeSpherePart","ambientBakeOcclusionBrightness","ambientBakeOcclusionContrast"].forEach((e=>{a.hasOwnProperty(e)&&(this[e]=a[e])})),this._resetSkyMesh()}_getSkyboxTex(){var e=this._prefilteredCubemaps;if(this._skyboxMip){return e[[0,1,3,4,5,6][this._skyboxMip]]||this._envAtlas||e[0]||this._skyboxCubeMap}return this._skyboxCubeMap||e[0]||this._envAtlas}_updateSkyMesh(){this.sky.skyMesh||this.sky.updateSkyMesh(),this.sky.update()}_resetSkyMesh(){this.sky.resetSkyMesh(),this.updateShaders=!0}setSkybox(e){e?(this.skybox=e[0]||null,e[1]&&!e[1].cubemap?this.envAtlas=e[1]:this.prefilteredCubemaps=e.slice(1)):(this.skybox=null,this.envAtlas=null)}get lightmapPixelFormat(){return this.lightmapHDR&&this.device.getRenderableHdrFormat()||7}constructor(e){super(),this.ambientBake=!1,this.ambientBakeOcclusionBrightness=0,this.ambientBakeOcclusionContrast=0,this.ambientLight=new ii(0,0,0),this.ambientLuminance=0,this.exposure=1,this.lightmapSizeMultiplier=1,this.lightmapMaxResolution=2048,this.lightmapMode=1,this.lightmapFilterEnabled=!1,this.lightmapHDR=!1,this.root=null,this.physicalUnits=!1,this._envAtlas=null,this._skyboxCubeMap=null,this._fogParams=new Lf,this.forcePassThroughSpecular=!1,this.device=e,this._gravity=new hi(0,-9.8,0),this._layers=null,this._prefilteredCubemaps=[],this._internalEnvAtlas=null,this._skyboxIntensity=1,this._skyboxLuminance=0,this._skyboxMip=0,this._skyboxHighlightMultiplier=1,this._skyboxRotationShaderInclude=!1,this._skyboxRotation=new bi,this._skyboxRotationMat3=new ci,this._skyboxRotationMat4=new _i,this._ambientBakeNumSamples=1,this._ambientBakeSpherePart=.4,this._lightmapFilterRange=10,this._lightmapFilterSmoothness=.2,this._clusteredLightingEnabled=!0,this._lightingParams=new ku(this.device.supportsAreaLights,this.device.maxTextureSize,(()=>{this.updateShaders=!0})),this._sky=new tf(this),this._stats={meshInstances:0,lights:0,dynamicLights:0,bakedLights:0,updateShadersTime:0},this.updateShaders=!0,this._shaderVersion=0,this.immediate=new hf(this.device)}}Mf.EVENT_SETLAYERS="set:layers",Mf.EVENT_SETSKYBOX="set:skybox",Mf.EVENT_PRERENDER="prerender",Mf.EVENT_POSTRENDER="postrender",Mf.EVENT_PRERENDER_LAYER="prerender:layer",Mf.EVENT_POSTRENDER_LAYER="postrender:layer",Mf.EVENT_PRECULL="precull",Mf.EVENT_POSTCULL="postcull";class If{constructor(e,t,i){this.device=e,this.inverseBindPose=t,this.boneNames=i}}class Rf{constructor(){this.hasTangents=!1,this.chunks={},this.pass=0,this.alphaTest=!1,this.blendType=3,this.separateAmbient=!1,this.screenSpace=!1,this.skin=!1,this.batch=!1,this.useInstancing=!1,this.useMorphPosition=!1,this.useMorphNormal=!1,this.useMorphTextureBasedInt=!1,this.nineSlicedMode=0,this.clusteredLightingEnabled=!0,this.clusteredLightingCookiesEnabled=!1,this.clusteredLightingShadowsEnabled=!1,this.clusteredLightingShadowType=0,this.clusteredLightingAreaLightsEnabled=!1,this.vertexColors=!1,this.lightMapEnabled=!1,this.dirLightMapEnabled=!1,this.useHeights=!1,this.useNormals=!1,this.useClearCoatNormals=!1,this.useAo=!1,this.diffuseMapEnabled=!1,this.customFragmentShader=null,this.pixelSnap=!1,this.ambientSH=!1,this.ssao=!1,this.twoSidedLighting=!1,this.occludeDirect=!1,this.occludeSpecular=0,this.occludeSpecularFloat=!1,this.useMsdf=!1,this.msdfTextAttribute=!1,this.alphaToCoverage=!1,this.opacityFadesSpecular=!1,this.opacityDither=ch,this.opacityShadowDither=ch,this.cubeMapProjection=0,this.useSpecular=!1,this.useSpecularityFactor=!1,this.enableGGXSpecular=!1,this.fresnelModel=0,this.useRefraction=!1,this.useClearCoat=!1,this.useSheen=!1,this.useIridescence=!1,this.useMetalness=!1,this.useDynamicRefraction=!1,this.dispersion=!1,this.fog=ml,this.gamma=0,this.toneMap=-1,this.reflectionSource=Wl,this.reflectionEncoding=null,this.reflectionCubemapEncoding=null,this.ambientSource="constant",this.ambientEncoding=null,this.skyboxIntensity=1,this.useCubeMapRotation=!1,this.lightMapWithoutAmbient=!1,this.lights=[],this.noShadow=!1,this.lightMaskDynamic=0,this.userAttributes={},this.linearDepth=!1,this.shadowCatcher=!1}}class kf{static update(e,t,i,s,r,n,a){kf.updateSharedOptions(e,t,i,r,n),kf.updateMaterialOptions(e,t),kf.updateEnvOptions(e,t,i,s),kf.updateLightingOptions(e,t,r,a)}static updateSharedOptions(e,t,i,s,r){e.chunks=t.chunks,e.pass=r,e.alphaTest=t.alphaTest>0,e.blendType=t.blendType,e.screenSpace=s&&!!(256&s),e.skin=s&&!!(2&s),e.useInstancing=s&&!!(32&s),e.useMorphPosition=s&&!!(s&eh),e.useMorphNormal=s&&!!(s&th),e.useMorphTextureBasedInt=s&&!!(s&ih),e.hasTangents=s&&!!(512&s),e.nineSlicedMode=t.nineSlicedMode||0,t.useLighting&&i.clusteredLightingEnabled?(e.clusteredLightingEnabled=!0,e.clusteredLightingCookiesEnabled=i.lighting.cookiesEnabled,e.clusteredLightingShadowsEnabled=i.lighting.shadowsEnabled,e.clusteredLightingShadowType=i.lighting.shadowType,e.clusteredLightingAreaLightsEnabled=i.lighting.areaLightsEnabled):(e.clusteredLightingEnabled=!1,e.clusteredLightingCookiesEnabled=!1,e.clusteredLightingShadowsEnabled=!1,e.clusteredLightingAreaLightsEnabled=!1)}static updateMaterialOptions(e,t){e.separateAmbient=!1,e.customFragmentShader=null,e.pixelSnap=t.pixelSnap,e.ambientSH=t.ambientSH,e.twoSidedLighting=t.twoSidedLighting,e.occludeDirect=t.occludeDirect,e.occludeSpecular=t.occludeSpecular,e.occludeSpecularFloat=1!==t.occludeSpecularIntensity,e.useMsdf=!1,e.msdfTextAttribute=!1,e.alphaToCoverage=t.alphaToCoverage,e.opacityFadesSpecular=t.opacityFadesSpecular,e.opacityDither=t.opacityDither,e.cubeMapProjection=0,e.useSpecular=t.hasSpecular,e.useSpecularityFactor=t.hasSpecularityFactor,e.enableGGXSpecular=t.ggxSpecular,e.fresnelModel=t.fresnelModel,e.useRefraction=t.hasRefraction,e.useClearCoat=t.hasClearCoat,e.useSheen=t.hasSheen,e.useIridescence=t.hasIrridescence,e.useMetalness=t.hasMetalness,e.useDynamicRefraction=t.dynamicRefraction,e.dispersion=t.dispersion>0,e.vertexColors=!1,e.lightMapEnabled=t.hasLighting,e.dirLightMapEnabled=t.dirLightMap,e.useHeights=t.hasHeights,e.useNormals=t.hasNormals,e.useClearCoatNormals=t.hasClearCoatNormals,e.useAo=t.hasAo,e.diffuseMapEnabled=t.hasDiffuseMap}static updateEnvOptions(e,t,i,s){e.fog=t.useFog?s.fog:ml,e.gamma=s.shaderOutputGamma,e.toneMap=t.useTonemap?s.toneMapping:6,t.useSkybox&&i.envAtlas&&i.skybox?(e.reflectionSource=ql,e.reflectionEncoding=i.envAtlas.encoding,e.reflectionCubemapEncoding=i.skybox.encoding):t.useSkybox&&i.envAtlas?(e.reflectionSource=jl,e.reflectionEncoding=i.envAtlas.encoding):t.useSkybox&&i.skybox?(e.reflectionSource=Xl,e.reflectionEncoding=i.skybox.encoding):(e.reflectionSource=Wl,e.reflectionEncoding=null),t.ambientSH?(e.ambientSource=Ql,e.ambientEncoding=null):e.reflectionSource!==Wl&&i.envAtlas?(e.ambientSource=Jl,e.ambientEncoding=i.envAtlas.encoding):(e.ambientSource=$l,e.ambientEncoding=null);var r=e.reflectionSource!==Wl;e.skyboxIntensity=r,e.useCubeMapRotation=r&&i._skyboxRotationShaderInclude}static updateLightingOptions(e,t,i,s){if(e.lightMapWithoutAmbient=!1,t.useLighting){var r=[],n=i?i>>16:1;e.lightMaskDynamic=!!(1&n),e.lightMapWithoutAmbient=!1,s&&(kf.collectLights(0,s[0],r,n),kf.collectLights(1,s[1],r,n),kf.collectLights(2,s[2],r,n)),e.lights=r}else e.lights=[];(0===e.lights.length||1&i)&&(e.noShadow=!0)}static collectLights(e,t,i,s){for(var r=0;r<t.length;r++){var n=t[r];n.enabled&&n.mask&s&&i.push(n)}}}var Of={vertex_normal:$i,vertex_tangent:Zi,vertex_texCoord0:rs,vertex_texCoord1:ns,vertex_color:is,vertex_boneWeights:es,vertex_boneIndices:ts},Ff=new Map([["vec4","vec4f"],["vec3","vec3f"],["vec2","vec2f"],["float","f32"]]);class Bf{fDefineSet(e,t,i){void 0===i&&(i=""),e&&this.fDefines.set(t,i)}generateVertexShader(e,t,i){var{options:s,vDefines:r,attributes:n}=this,a=new Map;a.set("vPositionW","vec3"),1!==s.nineSlicedMode&&2!==s.nineSlicedMode||r.set("NINESLICED",!0),this.options.linearDepth&&(r.set("LINEAR_DEPTH",!0),a.set("vLinearDepth","float")),this.needsNormal&&r.set("NORMALS",!0),this.options.useInstancing&&this.chunks.transformInstancingVS===_h.transformInstancingVS&&(n.instance_line1=ps,n.instance_line2=ms,n.instance_line3=gs,n.instance_line4=vs),this.needsNormal&&(n.vertex_normal=$i,a.set("vNormalW","vec3"),s.hasTangents&&(s.useHeights||s.useNormals||s.useClearCoatNormals||s.enableGGXSpecular)?(r.set("TANGENTS",!0),n.vertex_tangent=Zi,a.set("vTangentW","vec3"),a.set("vBinormalW","vec3")):s.enableGGXSpecular&&(r.set("GGX_SPECULAR",!0),a.set("vObjectSpaceUpW","vec3")));for(var o=0;o<2;o++)e[o]&&(r.set("UV"+o,!0),n["vertex_texCoord"+o]="TEXCOORD"+o),t[o]&&(r.set("UV"+o+"_UNMODIFIED",!0),a.set("vUv"+o,"vec2"));var l=0,h=new Set;i.forEach((e=>{var{id:t,uv:i,name:s}=e,n=t+100*i;if(!h.has(n)){h.add(n),a.set("vUV"+i+"_"+t,"vec2");var o="texture_"+s+"MapTransform";r.set("{TRANSFORM_NAME_"+l+"}",o),r.set("{TRANSFORM_UV_"+l+"}",i),r.set("{TRANSFORM_ID_"+l+"}",t),l++}})),r.set("UV_TRANSFORMS_COUNT",l),s.vertexColors&&(n.vertex_color=is,r.set("VERTEX_COLOR",!0),a.set("vVertexColor","vec4")),s.useMsdf&&s.msdfTextAttribute&&(n.vertex_outlineParameters=us,n.vertex_shadowParameters=fs,r.set("MSDF",!0)),(s.useMorphPosition||s.useMorphNormal)&&(r.set("MORPHING",!0),s.useMorphTextureBasedInt&&r.set("MORPHING_INT",!0),s.useMorphPosition&&r.set("MORPHING_POSITION",!0),s.useMorphNormal&&r.set("MORPHING_NORMAL",!0),n.morph_vertex_id=vs),s.skin&&(n.vertex_boneIndices=ts,s.batch?r.set("BATCH",!0):(n.vertex_boneWeights=es,r.set("SKIN",!0))),s.useInstancing&&r.set("INSTANCING",!0),s.screenSpace&&r.set("SCREENSPACE",!0),s.pixelSnap&&r.set("PIXELSNAP",!0),a.forEach(((e,t)=>{r.set("VARYING_"+t.toUpperCase(),!0),this.varyingsCode+=this.shaderLanguage===Ms?"varying "+t+": "+Ff.get(e)+";\n":"varying "+e+" "+t+";\n"})),this.vshader="\n            "+this.varyingsCode+'\n            #include "litMainVS"\n        '}_setupLightingDefines(e,t){var i=this.fDefines,s=this.options;if(this.fDefines.set("LIGHT_COUNT",s.lights.length),e&&i.set("AREA_LIGHTS",!0),t&&this.lighting&&(i.set("LIT_CLUSTERED_LIGHTS",!0),s.clusteredLightingCookiesEnabled&&i.set("CLUSTER_COOKIES",!0),s.clusteredLightingAreaLightsEnabled&&i.set("CLUSTER_AREALIGHTS",!0),s.lightMaskDynamic&&i.set("CLUSTER_MESH_DYNAMIC_LIGHTS",!0),s.clusteredLightingShadowsEnabled&&!s.noShadow)){var r=Il.get(s.clusteredLightingShadowType);i.set("CLUSTER_SHADOWS",!0),i.set("SHADOW_KIND_"+r.kind,!0),i.set("CLUSTER_SHADOW_TYPE_"+r.kind,!0)}for(var n=0;n<s.lights.length;n++){var a=s.lights[n],o=a._type;if(!t||0===o){var l=e&&a._shape?a._shape:0,h=a._shadowType,c=a.castShadows&&!s.noShadow,d=Il.get(h);i.set("LIGHT"+n,!0),i.set("LIGHT"+n+"TYPE",""+Sl[o]),i.set("LIGHT"+n+"SHADOWTYPE",""+d.name),i.set("LIGHT"+n+"SHAPE",""+Pl[l]),i.set("LIGHT"+n+"FALLOFF",""+Ml[a._falloffMode]),a.affectSpecularity&&i.set("LIGHT"+n+"AFFECT_SPECULARITY",!0),a._cookie&&(2===o&&!a._cookie._cubemap||1===o&&a._cookie._cubemap)&&(i.set("LIGHT"+n+"COOKIE",!0),i.set("{LIGHT"+n+"COOKIE_CHANNEL}",a._cookieChannel),2===o&&(a._cookieTransform&&i.set("LIGHT"+n+"COOKIE_TRANSFORM",!0),a._cookieFalloff&&i.set("LIGHT"+n+"COOKIE_FALLOFF",!0))),c&&(i.set("LIGHT"+n+"CASTSHADOW",!0),d.pcf&&i.set("LIGHT"+n+"SHADOW_PCF",!0),a._normalOffsetBias&&!a._isVsm&&i.set("LIGHT"+n+"_SHADOW_SAMPLE_NORMAL_OFFSET",!0),0===o&&(i.set("LIGHT"+n+"_SHADOW_SAMPLE_ORTHO",!0),a.cascadeBlend>0&&i.set("LIGHT"+n+"_SHADOW_CASCADE_BLEND",!0),a.numCascades>1&&i.set("LIGHT"+n+"_SHADOW_CASCADES",!0)),(d.pcf||d.pcss||this.device.isWebGPU)&&i.set("LIGHT"+n+"_SHADOW_SAMPLE_SOURCE_ZBUFFER",!0),1===o&&i.set("LIGHT"+n+"_SHADOW_SAMPLE_POINT",!0)),c&&(i.set("SHADOW_KIND_"+d.kind,!0),0===o&&i.set("SHADOW_DIRECTIONAL",!0))}}}prepareForwardPass(e){var{options:t}=this,i=t.clusteredLightingEnabled&&t.clusteredLightingAreaLightsEnabled||t.lights.some((e=>e._shape&&0!==e._shape)),s=!t.lightMapEnabled||t.lightMapWithoutAmbient,r=this.needsNormal&&(t.useNormals||t.useClearCoatNormals||t.enableGGXSpecular&&!t.useHeights);t.useSpecular&&(this.fDefineSet(!0,"LIT_SPECULAR"),this.fDefineSet(this.reflections,"LIT_REFLECTIONS"),this.fDefineSet(t.useClearCoat,"LIT_CLEARCOAT"),this.fDefineSet(t.fresnelModel>0,"LIT_SPECULAR_FRESNEL"),this.fDefineSet(t.useSheen,"LIT_SHEEN"),this.fDefineSet(t.useIridescence,"LIT_IRIDESCENCE")),this.fDefineSet(this.lighting&&t.useSpecular||this.reflections,"LIT_SPECULAR_OR_REFLECTION"),this.fDefineSet(this.needsSceneColor,"LIT_SCENE_COLOR"),this.fDefineSet(this.needsScreenSize,"LIT_SCREEN_SIZE"),this.fDefineSet(this.needsTransforms,"LIT_TRANSFORMS"),this.fDefineSet(this.needsNormal,"LIT_NEEDS_NORMAL"),this.fDefineSet(this.lighting,"LIT_LIGHTING"),this.fDefineSet(t.useMetalness,"LIT_METALNESS"),this.fDefineSet(t.enableGGXSpecular,"LIT_GGX_SPECULAR"),this.fDefineSet(t.useSpecularityFactor,"LIT_SPECULARITY_FACTOR"),this.fDefineSet(t.useCubeMapRotation,"CUBEMAP_ROTATION"),this.fDefineSet(t.occludeSpecularFloat,"LIT_OCCLUDE_SPECULAR_FLOAT"),this.fDefineSet(t.separateAmbient,"LIT_SEPARATE_AMBIENT"),this.fDefineSet(t.twoSidedLighting,"LIT_TWO_SIDED_LIGHTING"),this.fDefineSet(t.lightMapEnabled,"LIT_LIGHTMAP"),this.fDefineSet(t.dirLightMapEnabled,"LIT_DIR_LIGHTMAP"),this.fDefineSet(t.skyboxIntensity>0,"LIT_SKYBOX_INTENSITY"),this.fDefineSet(t.clusteredLightingShadowsEnabled,"LIT_CLUSTERED_SHADOWS"),this.fDefineSet(t.clusteredLightingAreaLightsEnabled,"LIT_CLUSTERED_AREA_LIGHTS"),this.fDefineSet(r,"LIT_TBN"),this.fDefineSet(s,"LIT_ADD_AMBIENT"),this.fDefineSet(t.hasTangents,"LIT_TANGENTS"),this.fDefineSet(t.useNormals,"LIT_USE_NORMALS"),this.fDefineSet(t.useClearCoatNormals,"LIT_USE_CLEARCOAT_NORMALS"),this.fDefineSet(t.useRefraction,"LIT_REFRACTION"),this.fDefineSet(t.useDynamicRefraction,"LIT_DYNAMIC_REFRACTION"),this.fDefineSet(t.dispersion,"LIT_DISPERSION"),this.fDefineSet(t.useHeights,"LIT_HEIGHTS"),this.fDefineSet(t.opacityFadesSpecular,"LIT_OPACITY_FADES_SPECULAR"),this.fDefineSet(t.alphaToCoverage,"LIT_ALPHA_TO_COVERAGE"),this.fDefineSet(t.alphaTest,"LIT_ALPHA_TEST"),this.fDefineSet(t.useMsdf,"LIT_MSDF"),this.fDefineSet(t.ssao,"LIT_SSAO"),this.fDefineSet(t.useAo,"LIT_AO"),this.fDefineSet(t.occludeDirect,"LIT_OCCLUDE_DIRECT"),this.fDefineSet(t.msdfTextAttribute,"LIT_MSDF_TEXT_ATTRIBUTE"),this.fDefineSet(t.diffuseMapEnabled,"LIT_DIFFUSE_MAP"),this.fDefineSet(t.shadowCatcher,"LIT_SHADOW_CATCHER"),this.fDefineSet(!0,"LIT_FRESNEL_MODEL",_l[t.fresnelModel]),this.fDefineSet(!0,"LIT_NONE_SLICE_MODE",oh[t.nineSlicedMode]),this.fDefineSet(!0,"LIT_BLEND_TYPE",pl[t.blendType]),this.fDefineSet(!0,"LIT_CUBEMAP_PROJECTION",Ol[t.cubeMapProjection]),this.fDefineSet(!0,"LIT_OCCLUDE_SPECULAR",Gl[t.occludeSpecular]),this.fDefineSet(!0,"LIT_REFLECTION_SOURCE",Yl[t.reflectionSource]),this.fDefineSet(!0,"LIT_AMBIENT_SOURCE",Zl[t.ambientSource]),this.fDefineSet(!0,"{lightingUv}",null!=e?e:""),this.fDefineSet(!0,"{reflectionDecode}",ju.decodeFunc(t.reflectionEncoding)),this.fDefineSet(!0,"{reflectionCubemapDecode}",ju.decodeFunc(t.reflectionCubemapEncoding)),this.fDefineSet(!0,"{ambientDecode}",ju.decodeFunc(t.ambientEncoding)),this._setupLightingDefines(i,t.clusteredLightingEnabled)}prepareShadowPass(){var{options:e}=this,t=this.shaderPassInfo.lightType,i=this.shaderPassInfo.shadowType,s=Il.get(i),r=0===t||!s.vsm&&2===t;this.fDefineSet(r,"PERSPECTIVE_DEPTH"),this.fDefineSet(!0,"LIGHT_TYPE",""+Sl[t]),this.fDefineSet(!0,"SHADOW_TYPE",""+s.name),this.fDefineSet(e.alphaTest,"LIT_ALPHA_TEST")}generateFragmentShader(e,t,i){var s=this.options;3===s.pass||2===s.pass||1===s.pass?this.fshader="\n\n                "+this.varyingsCode+"\n                "+e+"\n                "+t+'\n                #include "litOtherMainPS"\n            ':this.shadowPass?(this.prepareShadowPass(),this.fshader="\n                "+this.varyingsCode+"\n                "+e+"\n                "+t+'\n                #include "litShadowMainPS"\n            '):s.customFragmentShader?this.fshader="\n                "+s.customFragmentShader+"\n            ":(this.prepareForwardPass(i),this.fshader="\n                "+this.varyingsCode+"\n                "+e+'\n                #include "litForwardDeclarationPS"\n                #include "litForwardPreCodePS"\n                '+t+'\n                #include "litForwardPostCodePS"\n                #include "litForwardBackendPS"\n                #include "litForwardMainPS"\n            ')}constructor(e,t,i){if(this.varyingsCode="",this.device=e,this.options=t,this.shaderLanguage=i,this.attributes={vertex_position:Ji},t.userAttributes)for(var[s,r]of Object.entries(t.userAttributes))this.attributes[r]=s;var n=i===Ls?_h:Oc;if(t.chunks){var a=t.chunks;for(var o in this.chunks=Object.create(n),n)if(a.hasOwnProperty(o)){var l=a[o];for(var h in Of)Of.hasOwnProperty(h)&&l.indexOf(h)>=0&&(this.attributes[h]=Of[h]);this.chunks[o]=l}}else this.chunks=n;this.shaderPassInfo=Th.get(this.device).getByIndex(t.pass),this.shadowPass=this.shaderPassInfo.isShadow,this.lighting=t.lights.length>0||t.dirLightMapEnabled||t.clusteredLightingEnabled,this.reflections=t.reflectionSource!==Wl,this.needsNormal=this.lighting||this.reflections||t.useSpecular||t.ambientSH||t.useHeights||t.enableGGXSpecular||t.clusteredLightingEnabled&&!this.shadowPass||t.useClearCoatNormals,this.needsNormal=this.needsNormal&&!this.shadowPass,this.needsSceneColor=t.useDynamicRefraction,this.needsScreenSize=t.useDynamicRefraction,this.needsTransforms=t.useDynamicRefraction,this.vshader=null,this.vDefines=new Map,this.fDefines=new Map,this.fshader=null}}var Nf={generateKey:e=>"lit"+Object.keys(e).sort().map((t=>"chunks"===t?Nf.generateChunksKey(e):"lights"===t?Nf.generateLightsKey(e):t+e[t])).join("\n"),generateLightsKey:e=>"lights:"+e.lights.map((t=>e.clusteredLightingEnabled&&0!==t._type?"":t.key+",")).join(""),generateChunksKey(e){var t;return"chunks:\n"+Object.keys(null!=(t=e.chunks)?t:{}).sort().map((t=>t+e.chunks[t])).join("")}};class zf{get pass(){return this.litOptions.pass}constructor(){this.defines=new Map,this.forceUv1=!1,this.specularTint=!1,this.metalnessTint=!1,this.glossTint=!1,this.emissiveEncoding="linear",this.lightMapEncoding="linear",this.packedNormal=!1,this.normalDetailPackedNormal=!1,this.clearCoatPackedNormal=!1,this.glossInvert=!1,this.sheenGlossInvert=!1,this.clearCoatGlossInvert=!1,this.useAO=!1,this.litOptions=new Rf}}function Uf(){return Uf=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var s in i)Object.prototype.hasOwnProperty.call(i,s)&&(e[s]=i[s])}return e},Uf.apply(this,arguments)}var Vf=[],Hf=e=>Object.keys(e).filter((e=>"litOptions"!==e)).sort();var Gf=new class extends xh{generateKey(e){var t;return e===this.optionsContextMin?(this.propsMin||(this.propsMin=Hf(e)),t=this.propsMin):e===this.optionsContext?(this.props||(this.props=Hf(e)),t=this.props):t=Hf(e),"standard:\n"+xh.definesHash(e.defines)+"\n"+t.map((t=>t+e[t])).join("\n")+Nf.generateKey(e.litOptions)}_getUvSourceExpression(e,t,i){var s,r=i[e],n=i[t],a=0===i.litOptions.pass;return a&&1===i.litOptions.nineSlicedMode||a&&2===i.litOptions.nineSlicedMode?s="nineSlicedUv":(s=0===r?"vUv"+n:"vUV"+n+"_"+r,i.heightMap&&"heightMapTransform"!==e&&(s+=" + dUvOffset")),s}_validateMapChunk(e,t,i){}_addMapDefines(e,t,i,s,r,n,a){void 0===a&&(a=null);var o=t+"Map",l=t.toUpperCase(),h=o+"Uv",c=o+"Identifier",d=o+"Transform",u=o+"Channel",f=t+"VertexColorChannel",p=t+"VertexColor",m=t+"Mode",g=t+"Invert",v=s[t+"Tint"],_=s[p],b=s[o],y=s[c],x=s[m],S=r[i];if(b){e.set("STD_"+l+"_TEXTURE","");var w=this._getUvSourceExpression(d,h,s);e.set("{STD_"+l+"_TEXTURE_UV}",w),e.set("{STD_"+l+"_TEXTURE_CHANNEL}",s[u]);var T="{STD_"+l+"_TEXTURE_NAME}";if(S.includes(T)){var C="texture_"+o,E=n[y];E?C=E:(n[y]=C,e.set("STD_"+l+"_TEXTURE_ALLOCATE","")),e.set(T,C)}if(a){var A="aaa"===s[u]?"passThrough":ju.decodeFunc(a);e.set("{STD_"+l+"_TEXTURE_DECODE}",A)}}_&&(e.set("STD_"+l+"_VERTEX",""),e.set("{STD_"+l+"_VERTEX_CHANNEL}",s[f])),x&&e.set("{STD_"+l+"_DETAILMODE}",x),v&&e.set("STD_"+l+"_CONSTANT",""),s[g]&&e.set("STD_"+l+"_INVERT","")}_correctChannel(e,t,i){if(i[e]>0){if(i[e]<t.length)return t.substring(0,i[e]);if(i[e]>t.length){for(var s=t,r=s.charAt(s.length-1),n=i[e]-s.length,a=0;a<n;a++)s+=r;return s}return t}}createVertexShader(e,t){var i=[],s=[],r=[];for(var n in Vf){var a=n+"Map";if(t[n+"VertexColor"]){var o=n+"VertexColorChannel";t[o]=this._correctChannel(n,t[o],Vf)}if(t[a]){var l=a+"Channel",h=a+"Transform",c=a+"Uv";t[c]=Math.min(t[c],1),t[l]=this._correctChannel(n,t[l],Vf);var d=t[c];i[d]=!0,s[d]=s[d]||t[a]&&!t[h],t[h]&&r.push({name:n,id:t[h],uv:t[c]})}}t.forceUv1&&(i[1]=!0,s[1]=void 0===s[1]||s[1]),e.generateVertexShader(i,s,r)}prepareFragmentDefines(e,t,i){var s=(e,i,s)=>{void 0===s&&(s=""),e&&t.set(i,s)};s(e.lightMap,"STD_LIGHTMAP",""),s(e.lightVertexColor,"STD_LIGHT_VERTEX_COLOR",""),s(e.dirLightMap&&e.litOptions.useSpecular,"STD_LIGHTMAP_DIR",""),s(e.heightMap,"STD_HEIGHT_MAP",""),s(e.useSpecularColor,"STD_SPECULAR_COLOR",""),s(e.aoMap||e.aoVertexColor||e.useAO,"STD_AO",""),s(!0,"STD_OPACITY_DITHER",ph[i.isForward?e.litOptions.opacityDither:e.litOptions.opacityShadowDither])}createShaderDefinition(e,t){var i=Th.get(e).getByIndex(t.litOptions.pass),s=i.isForward,r=new Bf(e,t.litOptions,Ls);this.createVertexShader(r,t);var n={};t.litOptions.fresnelModel=0===t.litOptions.fresnelModel?2:t.litOptions.fresnelModel;var a=r.fDefines;this.prepareFragmentDefines(t,a,i);var o="";if(s){if(t.heightMap&&this._addMapDefines(a,"height","parallaxPS",t,r.chunks,n),(3!==t.litOptions.blendType||t.litOptions.alphaTest||t.litOptions.alphaToCoverage||t.litOptions.opacityDither!==ch)&&this._addMapDefines(a,"opacity","opacityPS",t,r.chunks,n),r.needsNormal){if((t.normalMap||t.clearCoatNormalMap)&&!t.litOptions.hasTangents){var l=t.normalMap?"normalMap":"clearCoatNormalMap";o=this._getUvSourceExpression(l+"Transform",l+"Uv",t)}this._addMapDefines(a,"normalDetail","normalMapPS",t,r.chunks,n,t.normalDetailPackedNormal?"xy":"xyz"),this._addMapDefines(a,"normal","normalMapPS",t,r.chunks,n,t.packedNormal?"xy":"xyz")}t.diffuseDetail&&this._addMapDefines(a,"diffuseDetail","diffusePS",t,r.chunks,n,t.diffuseDetailEncoding),this._addMapDefines(a,"diffuse","diffusePS",t,r.chunks,n,t.diffuseEncoding),t.litOptions.useRefraction&&(this._addMapDefines(a,"refraction","transmissionPS",t,r.chunks,n),this._addMapDefines(a,"thickness","thicknessPS",t,r.chunks,n)),t.litOptions.useIridescence&&(this._addMapDefines(a,"iridescence","iridescencePS",t,r.chunks,n),this._addMapDefines(a,"iridescenceThickness","iridescenceThicknessPS",t,r.chunks,n)),(r.lighting&&t.litOptions.useSpecular||r.reflections)&&(t.litOptions.useSheen&&(this._addMapDefines(a,"sheen","sheenPS",t,r.chunks,n,t.sheenEncoding),this._addMapDefines(a,"sheenGloss","sheenGlossPS",t,r.chunks,n)),t.litOptions.useMetalness&&(this._addMapDefines(a,"metalness","metalnessPS",t,r.chunks,n),this._addMapDefines(a,"ior","iorPS",t,r.chunks,n)),t.litOptions.useSpecularityFactor&&this._addMapDefines(a,"specularityFactor","specularityFactorPS",t,r.chunks,n),t.useSpecularColor&&this._addMapDefines(a,"specular","specularPS",t,r.chunks,n,t.specularEncoding),this._addMapDefines(a,"gloss","glossPS",t,r.chunks,n)),t.aoDetail&&this._addMapDefines(a,"aoDetail","aoPS",t,r.chunks,n),(t.aoMap||t.aoVertexColor||t.useAO)&&this._addMapDefines(a,"ao","aoPS",t,r.chunks,n),this._addMapDefines(a,"emissive","emissivePS",t,r.chunks,n,t.emissiveEncoding),t.litOptions.useClearCoat&&(this._addMapDefines(a,"clearCoat","clearCoatPS",t,r.chunks,n),this._addMapDefines(a,"clearCoatGloss","clearCoatGlossPS",t,r.chunks,n),this._addMapDefines(a,"clearCoatNormal","clearCoatNormalPS",t,r.chunks,n,t.clearCoatPackedNormal?"xy":"xyz")),(t.lightMap||t.lightVertexColor)&&this._addMapDefines(a,"light","lightmapPS",t,r.chunks,n,t.lightMapEncoding)}else{var h=t.litOptions.opacityShadowDither;(t.litOptions.alphaTest||h)&&this._addMapDefines(a,"opacity","opacityPS",t,r.chunks,n)}r.generateFragmentShader(r.chunks.stdDeclarationPS,r.chunks.stdFrontEndPS,o);var c=new Map(Object.entries(Uf({},Object.getPrototypeOf(r.chunks),r.chunks,t.litOptions.chunks))),d=r.vDefines;t.defines.forEach(((e,t)=>d.set(t,e))),t.defines.forEach(((e,t)=>a.set(t,e)));var u=Ma.createDefinition(e,{name:"StandardShader",attributes:r.attributes,vertexCode:r.vshader,fragmentCode:r.fshader,vertexIncludes:c,fragmentIncludes:c,fragmentDefines:a,vertexDefines:d});return r.shaderPassInfo.isForward&&(u.tag=1),u}constructor(...e){super(...e),this.optionsContext=new zf,this.optionsContextMin=new zf}},Wf=(e,t)=>{if(e.length!==t.length)return!1;for(var i=0;i<e.length;++i)if(e[i]!==t[i])return!1;return!0};class jf{updateMinRef(e,t,i,s,r,n){this._updateSharedOptions(e,t,i,s,r),this._updateMinOptions(e,i,r),this._updateUVOptions(e,i,s,!0)}updateRef(e,t,i,s,r,n,a){this._updateSharedOptions(e,t,s,r,n),this._updateEnvOptions(e,s,t,i),this._updateMaterialOptions(e,s,t),e.litOptions.hasTangents=r&&!!(512&r),this._updateLightOptions(e,t,s,r,a),this._updateUVOptions(e,s,r,!1,i)}_updateSharedOptions(e,t,i,s,r){e.forceUv1=i.forceUv1,i.userAttributes&&(e.litOptions.userAttributes=Object.fromEntries(i.userAttributes.entries())),e.litOptions.chunks=i.chunks||{},e.litOptions.pass=r,e.litOptions.alphaTest=i.alphaTest>0,e.litOptions.blendType=i.blendType,e.litOptions.screenSpace=s&&!!(256&s),e.litOptions.skin=s&&!!(2&s),e.litOptions.batch=s&&!!(s&sh),e.litOptions.useInstancing=s&&!!(32&s),e.litOptions.useMorphPosition=s&&!!(s&eh),e.litOptions.useMorphNormal=s&&!!(s&th),e.litOptions.useMorphTextureBasedInt=s&&!!(s&ih),e.litOptions.nineSlicedMode=i.nineSlicedMode||0,t.clusteredLightingEnabled&&i.useLighting?(e.litOptions.clusteredLightingEnabled=!0,e.litOptions.clusteredLightingCookiesEnabled=t.lighting.cookiesEnabled,e.litOptions.clusteredLightingShadowsEnabled=t.lighting.shadowsEnabled,e.litOptions.clusteredLightingShadowType=t.lighting.shadowType,e.litOptions.clusteredLightingAreaLightsEnabled=t.lighting.areaLightsEnabled):(e.litOptions.clusteredLightingEnabled=!1,e.litOptions.clusteredLightingCookiesEnabled=!1,e.litOptions.clusteredLightingShadowsEnabled=!1,e.litOptions.clusteredLightingAreaLightsEnabled=!1)}_updateUVOptions(e,t,i,s,r){var n=!1,a=!1,o=!1;i&&(n=!!(4&i),a=!!(8&i),o=!!(16&i)),e.litOptions.vertexColors=!1,this._mapXForms=[];var l={};for(var h in Vf)this._updateTexOptions(e,t,h,n,a,o,s,l);this._mapXForms=null,e.litOptions.ssao=null==r?void 0:r.ssaoEnabled,e.useAO=e.litOptions.ssao,e.litOptions.lightMapEnabled=e.lightMap,e.litOptions.dirLightMapEnabled=e.dirLightMap,e.litOptions.useHeights=e.heightMap,e.litOptions.useNormals=e.normalMap,e.litOptions.useClearCoatNormals=e.clearCoatNormalMap,e.litOptions.useAo=e.aoMap||e.aoVertexColor||e.litOptions.ssao,e.litOptions.diffuseMapEnabled=e.diffuseMap}_updateTexOptions(e,t,i,s,r,n,a,o){var l="opacity"===i;if(!a||l){var h=i+"Map",c=i+"VertexColor",d=i+"VertexColorChannel",u=h+"Channel",f=h+"Transform",p=h+"Uv",m=h+"Identifier";if("light"!==i&&(e[h]=!1,e[m]=void 0,e[u]="",e[f]=0,e[p]=0),e[c]=!1,e[d]="",l&&3===t.blendType&&0===t.alphaTest&&!t.alphaToCoverage&&t.opacityDither===ch)return;if("height"!==i&&t[c]&&n&&(e[c]=t[c],e[d]=t[d],e.litOptions.vertexColors=!0),t[h]){var g=!0;if(0!==t[p]||s||(g=!1),1!==t[p]||r||(g=!1),g){var v=t[h].id,_=o[v];void 0===_&&(o[v]=i,_=i),e[h]=!!t[h],e[m]=_,e[f]=this._getMapTransformID(t.getUniform(f),t[p]),e[u]=t[u],e[p]=t[p]}}}}_updateMinOptions(e,t,i){var s=1===i;e.litOptions.opacityShadowDither=s?t.opacityDither:t.opacityShadowDither,e.litOptions.linearDepth=s,e.litOptions.lights=[]}_updateMaterialOptions(e,t,i){var s,r,n,a,o,l,h,c=!!(t.useMetalness||t.specularMap||t.sphereMap||t.cubeMap||(h=t.specular,0!==h.r||0!==h.g||0!==h.b)||t.specularityFactor>0&&t.useMetalness||t.enableGGXSpecular||t.clearCoat>0),d=!t.useMetalness||t.useMetalnessSpecularColor,u=c&&(t.specularTint||!t.specularMap&&!t.specularVertexColor)&&(e=>1!==e.r||1!==e.g||1!==e.b)(t.specular),f=c&&t.useMetalnessSpecularColor&&(t.specularityFactorTint||t.specularityFactor<1&&!t.specularityFactorMap),p=e=>!!e&&(e.format===Ii||e.type===Ss),m=(e,t)=>Math.abs(e-t)<1e-4;e.specularTint=u,e.specularityFactorTint=f,e.metalnessTint=t.useMetalness&&t.metalness<1,e.glossTint=!0,e.diffuseEncoding=null==(s=t.diffuseMap)?void 0:s.encoding,e.diffuseDetailEncoding=null==(r=t.diffuseDetailMap)?void 0:r.encoding,e.emissiveEncoding=null==(n=t.emissiveMap)?void 0:n.encoding,e.lightMapEncoding=null==(a=t.lightMap)?void 0:a.encoding,e.packedNormal=p(t.normalMap),e.refractionTint=m(t.refraction,1),e.refractionIndexTint=m(t.refractionIndex,1/1.5),e.thicknessTint=t.useDynamicRefraction&&1!==t.thickness,e.specularEncoding=null==(o=t.specularMap)?void 0:o.encoding,e.sheenEncoding=null==(l=t.sheenMap)?void 0:l.encoding,e.aoMapUv=t.aoUvSet,e.aoDetail=!!t.aoDetailMap,e.diffuseDetail=!!t.diffuseDetailMap,e.normalDetail=!!t.normalMap,e.normalDetailPackedNormal=p(t.normalDetailMap),e.diffuseDetailMode=t.diffuseDetailMode,e.aoDetailMode=t.aoDetailMode,e.clearCoatTint=m(t.clearCoat,1),e.clearCoatGloss=!!t.clearCoatGloss,e.clearCoatGlossTint=1!==t.clearCoatGloss,e.clearCoatPackedNormal=p(t.clearCoatNormalMap),e.iorTint=m(t.refractionIndex,1/1.5),i.forcePassThroughSpecular&&(e.specularEncoding="linear",e.sheenEncoding="linear"),e.iridescenceTint=1!==t.iridescence,e.glossInvert=t.glossInvert,e.sheenGlossInvert=t.sheenGlossInvert,e.clearCoatGlossInvert=t.clearCoatGlossInvert,e.useSpecularColor=d,e.litOptions.separateAmbient=!1,e.litOptions.customFragmentShader=t.customFragmentShader,e.litOptions.pixelSnap=t.pixelSnap,e.litOptions.ambientSH=!!t.ambientSH,e.litOptions.twoSidedLighting=t.twoSidedLighting,e.litOptions.occludeSpecular=t.occludeSpecular,e.litOptions.occludeSpecularFloat=1!==t.occludeSpecularIntensity,e.litOptions.useMsdf=!!t.msdfMap,e.litOptions.msdfTextAttribute=!!t.msdfTextAttribute,e.litOptions.alphaToCoverage=t.alphaToCoverage,e.litOptions.opacityFadesSpecular=t.opacityFadesSpecular,e.litOptions.opacityDither=t.opacityDither,e.litOptions.cubeMapProjection=t.cubeMapProjection,e.litOptions.occludeDirect=t.occludeDirect,e.litOptions.useSpecular=c,e.litOptions.useSpecularityFactor=(f||!!t.specularityFactorMap)&&t.useMetalnessSpecularColor,e.litOptions.enableGGXSpecular=t.enableGGXSpecular,e.litOptions.fresnelModel=t.fresnelModel,e.litOptions.useRefraction=(t.refraction||!!t.refractionMap)&&(t.useDynamicRefraction||e.litOptions.reflectionSource!==Wl),e.litOptions.useClearCoat=!!t.clearCoat,e.litOptions.useSheen=t.useSheen,e.litOptions.useIridescence=t.useIridescence&&0!==t.iridescence,e.litOptions.useMetalness=t.useMetalness,e.litOptions.useDynamicRefraction=t.useDynamicRefraction,e.litOptions.dispersion=t.dispersion>0,e.litOptions.shadowCatcher=t.shadowCatcher}_updateEnvOptions(e,t,i,s){e.litOptions.fog=t.useFog?s.fog:ml,e.litOptions.gamma=s.shaderOutputGamma,e.litOptions.toneMap=t.useTonemap?s.toneMapping:6;var r=!1;if(t.envAtlas&&t.cubeMap?(e.litOptions.reflectionSource=ql,e.litOptions.reflectionEncoding=t.envAtlas.encoding,e.litOptions.reflectionCubemapEncoding=t.cubeMap.encoding):t.envAtlas?(e.litOptions.reflectionSource=jl,e.litOptions.reflectionEncoding=t.envAtlas.encoding):t.cubeMap?(e.litOptions.reflectionSource=Xl,e.litOptions.reflectionEncoding=t.cubeMap.encoding):t.sphereMap?(e.litOptions.reflectionSource=Kl,e.litOptions.reflectionEncoding=t.sphereMap.encoding):t.useSkybox&&i.envAtlas&&i.skybox?(e.litOptions.reflectionSource=ql,e.litOptions.reflectionEncoding=i.envAtlas.encoding,e.litOptions.reflectionCubemapEncoding=i.skybox.encoding,r=!0):t.useSkybox&&i.envAtlas?(e.litOptions.reflectionSource=jl,e.litOptions.reflectionEncoding=i.envAtlas.encoding,r=!0):t.useSkybox&&i.skybox?(e.litOptions.reflectionSource=Xl,e.litOptions.reflectionEncoding=i.skybox.encoding,r=!0):(e.litOptions.reflectionSource=Wl,e.litOptions.reflectionEncoding=null),t.ambientSH)e.litOptions.ambientSource=Ql,e.litOptions.ambientEncoding=null;else{var n=t.envAtlas||(t.useSkybox&&i.envAtlas?i.envAtlas:null);n&&!t.sphereMap?(e.litOptions.ambientSource=Jl,e.litOptions.ambientEncoding=n.encoding):(e.litOptions.ambientSource=$l,e.litOptions.ambientEncoding=null)}e.litOptions.skyboxIntensity=r,e.litOptions.useCubeMapRotation=r&&i._skyboxRotationShaderInclude}_updateLightOptions(e,t,i,s,r){if(e.lightMap=!1,e.lightMapChannel="",e.lightMapUv=0,e.lightMapTransform=0,e.litOptions.lightMapWithoutAmbient=!1,e.dirLightMap=!1,s&&(e.litOptions.noShadow=!!(1&s),64&s&&(e.lightMapEncoding=7===t.lightmapPixelFormat?"rgbm":"linear",e.lightMap=!0,e.lightMapChannel="rgb",e.lightMapUv=1,e.lightMapTransform=0,e.litOptions.lightMapWithoutAmbient=!i.lightMap,128&s&&(e.dirLightMap=!0),4096&s&&(e.litOptions.lightMapWithoutAmbient=!1))),i.useLighting){var n=[],a=s?s>>16:1;e.litOptions.lightMaskDynamic=!!(1&a),r&&(kf.collectLights(0,r[0],n,a),kf.collectLights(1,r[1],n,a),kf.collectLights(2,r[2],n,a)),e.litOptions.lights=n}else e.litOptions.lights=[];0===e.litOptions.lights.length&&(e.litOptions.noShadow=!0)}_getMapTransformID(e,t){if(!e)return 0;var i=this._mapXForms[t];i||(i=[],this._mapXForms[t]=i);for(var s=0;s<i.length;s++)if(Wf(i[s][0].value,e[0].value)&&Wf(i[s][1].value,e[1].value))return s+1;return i.push(e)}constructor(){this._mapXForms=null}}function qf(){return qf=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var s in i)Object.prototype.hasOwnProperty.call(i,s)&&(e[s]=i[s])}return e},qf.apply(this,arguments)}function Xf(e,t,i){void 0===t&&(t=!0),void 0===i&&(i=!0);var s={};return s[e+"Map"]="texture",s[e+"MapTiling"]="vec2",s[e+"MapOffset"]="vec2",s[e+"MapRotation"]="number",s[e+"MapUv"]="number",t&&(s[e+"MapChannel"]="string",i&&(s[e+"VertexColor"]="boolean",s[e+"VertexColorChannel"]="string")),s}var Kf=qf({name:"string",chunks:"chunks",mappingFormat:"string",_engine:"boolean",ambient:"rgb"},Xf("ao"),Xf("aoDetail",!0,!1),{aoDetailMode:"string",diffuse:"rgb"},Xf("diffuse"),Xf("diffuseDetail",!0,!1),{diffuseDetailMode:"string",specular:"rgb",specularTint:"boolean"},Xf("specular"),{occludeSpecular:"enum:occludeSpecular",specularityFactor:"number",specularityFactorTint:"boolean"},Xf("specularityFactor"),{useMetalness:"boolean",metalness:"number",enableGGXSpecular:"boolean",anisotropy:"number",metalnessTint:"boolean"},Xf("metalness"),{useMetalnessSpecularColor:"boolean",shininess:"number",gloss:"number",glossInvert:"boolean"},Xf("gloss"),{clearCoat:"number"},Xf("clearCoat"),{clearCoatGloss:"number",clearCoatGlossInvert:"boolean"},Xf("clearCoatGloss"),{clearCoatBumpiness:"number"},Xf("clearCoatNormal",!1),{useSheen:"boolean",sheen:"rgb"},Xf("sheen"),{sheenGloss:"number",sheenGlossInvert:"boolean"},Xf("sheenGloss"),{fresnelModel:"number",emissive:"rgb"},Xf("emissive"),{emissiveIntensity:"number"},Xf("normal",!1),{bumpiness:"number"},Xf("normalDetail",!1),{normalDetailMapBumpiness:"number"},Xf("height",!0,!1),{heightMapFactor:"number",alphaToCoverage:"boolean",alphaTest:"number",alphaFade:"number",opacity:"number"},Xf("opacity"),{opacityFadesSpecular:"boolean",opacityDither:"string",opacityShadowDither:"string",reflectivity:"number",refraction:"number",refractionTint:"boolean"},Xf("refraction"),{refractionIndex:"number",dispersion:"number",thickness:"number",thicknessTint:"boolean"},Xf("thickness"),{attenuation:"rgb",attenuationDistance:"number",useDynamicRefraction:"boolean",sphereMap:"texture",cubeMap:"cubemap",cubeMapProjection:"number",cubeMapProjectionBox:"boundingbox",useIridescence:"boolean",iridescence:"number",iridescenceTint:"boolean"},Xf("iridescence"),{iridescenceThicknessTint:"boolean",iridescenceThicknessMin:"number",iridescenceThicknessMax:"number",iridescenceRefractionIndex:"number"},Xf("iridescenceThickness"),Xf("light"),{depthTest:"boolean",depthFunc:"enum:depthFunc",depthWrite:"boolean",depthBias:"number",slopeDepthBias:"number",cull:"enum:cull",blendType:"enum:blendType",useFog:"boolean",useLighting:"boolean",useSkybox:"boolean",useTonemap:"boolean",envAtlas:"texture",twoSidedLighting:"boolean",shadowCatcher:"boolean"}),Yf=[];for(var Qf in Kf){"texture"===Kf[Qf]&&Yf.push(Qf)}var Jf=[];for(var $f in Kf){"cubemap"===Kf[$f]&&Jf.push($f)}var Zf={},ep={},tp=new Set,ip=new ii;class sp extends fd{reset(){Object.keys(Zf).forEach((e=>{this["_"+e]=Zf[e].value()})),this._uniformCache={}}copy(e){return super.copy(e),Object.keys(Zf).forEach((t=>{this[t]=e[t]})),this.userAttributes=new Map(e.userAttributes),this}setAttribute(e,t){this.userAttributes.set(t,e)}_setParameter(e,t){tp.add(e),this.setParameter(e,t)}_setParameters(e){e.forEach((e=>{this._setParameter(e.name,e.value)}))}_processParameters(e){var t=this[e];t.forEach((e=>{tp.has(e)||delete this.parameters[e]})),this[e]=tp,(tp=t).clear()}_updateMap(e){var t=e+"Map",i=this[t];if(i){this._setParameter("texture_"+t,i);var s=t+"Transform",r=this.getUniform(s);r&&this._setParameters(r)}}_allocUniform(e,t){var i=this._uniformCache[e];return i||(i=t(),this._uniformCache[e]=i),i}getUniform(e,t,i){return ep[e](this,t,i)}updateUniforms(e,t){var i=i=>this.getUniform(i,e,t);for(var s in this._setParameter("material_ambient",i("ambient")),this._setParameter("material_diffuse",i("diffuse")),this._setParameter("material_aoIntensity",this.aoIntensity),this.useMetalness?((!this.metalnessMap||this.metalness<1)&&this._setParameter("material_metalness",this.metalness),this.specularMap&&!this.specularTint||this._setParameter("material_specular",i("specular")),this.specularityFactorMap&&!this.specularityFactorTint||this._setParameter("material_specularityFactor",this.specularityFactor),this._setParameter("material_sheen",i("sheen")),this._setParameter("material_sheenGloss",this.sheenGloss),this._setParameter("material_refractionIndex",this.refractionIndex)):this.specularMap&&!this.specularTint||this._setParameter("material_specular",i("specular")),this.enableGGXSpecular&&this._setParameter("material_anisotropy",this.anisotropy),this.clearCoat>0&&(this._setParameter("material_clearCoat",this.clearCoat),this._setParameter("material_clearCoatGloss",this.clearCoatGloss),this._setParameter("material_clearCoatBumpiness",this.clearCoatBumpiness)),this._setParameter("material_gloss",this.gloss),this._setParameter("material_emissive",i("emissive")),this._setParameter("material_emissiveIntensity",this.emissiveIntensity),this.refraction>0&&this._setParameter("material_refraction",this.refraction),this.dispersion>0&&this._setParameter("material_dispersion",this.dispersion),this.useDynamicRefraction&&(this._setParameter("material_thickness",this.thickness),this._setParameter("material_attenuation",i("attenuation")),this._setParameter("material_invAttenuationDistance",0===this.attenuationDistance?0:1/this.attenuationDistance)),this.useIridescence&&(this._setParameter("material_iridescence",this.iridescence),this._setParameter("material_iridescenceRefractionIndex",this.iridescenceRefractionIndex),this._setParameter("material_iridescenceThicknessMin",this.iridescenceThicknessMin),this._setParameter("material_iridescenceThicknessMax",this.iridescenceThicknessMax)),this._setParameter("material_opacity",this.opacity),!1===this.opacityFadesSpecular&&this._setParameter("material_alphaFade",this.alphaFade),this.occludeSpecular&&this._setParameter("material_occludeSpecularIntensity",this.occludeSpecularIntensity),1===this.cubeMapProjection&&this._setParameter(i("cubeMapProjectionBox")),Vf)this._updateMap(s);this.ambientSH&&this._setParameter("ambientSH[0]",this.ambientSH),this.normalMap&&this._setParameter("material_bumpiness",this.bumpiness),this.normalMap&&this.normalDetailMap&&this._setParameter("material_normalDetailMapBumpiness",this.normalDetailMapBumpiness),this.heightMap&&this._setParameter("material_heightMapFactor",i("heightMapFactor")),this.envAtlas&&this.cubeMap?(this._setParameter("texture_envAtlas",this.envAtlas),this._setParameter("texture_cubeMap",this.cubeMap)):this.envAtlas?this._setParameter("texture_envAtlas",this.envAtlas):this.cubeMap?this._setParameter("texture_cubeMap",this.cubeMap):this.sphereMap&&this._setParameter("texture_sphereMap",this.sphereMap),this._setParameter("material_reflectivity",this.reflectivity),this._processParameters("_activeParams"),super.updateUniforms(e,t)}updateEnvUniforms(e,t){!(this.envAtlas||this.cubeMap||this.sphereMap)&&this.useSkybox&&(t.envAtlas&&t.skybox?(this._setParameter("texture_envAtlas",t.envAtlas),this._setParameter("texture_cubeMap",t.skybox)):t.envAtlas?this._setParameter("texture_envAtlas",t.envAtlas):t.skybox&&this._setParameter("texture_cubeMap",t.skybox)),this._processParameters("_activeLightingParams")}getShaderVariant(e){var{device:t,scene:i,pass:s,objDefs:r,sortedLights:n,cameraShaderParams:a}=e;this.updateEnvUniforms(t,i);var o=Th.get(t).getByIndex(s),l=2===s||3===s||1===s||o.isShadow,h=l?Gf.optionsContextMin:Gf.optionsContext;h.defines=Ph(this,e),l?this.shaderOptBuilder.updateMinRef(h,i,this,r,s,n):this.shaderOptBuilder.updateRef(h,i,a,this,r,s,n),this.useFog||h.defines.set("FOG","NONE"),h.defines.set("TONEMAP",zl[h.litOptions.toneMap]),this.onUpdateShader&&(h=this.onUpdateShader(h));var c=new vh(e.viewUniformFormat,e.viewBindGroupFormat,e.vertexFormat),d=yh(t);d.register("standard",Gf);var u=d.getProgram("standard",h,c,this.userId);return this._dirtyShader=!1,u}destroy(){for(var e in this._assetReferences)this._assetReferences[e]._unbind();this._assetReferences=null,super.destroy()}constructor(){super(),this.userAttributes=new Map,this._assetReferences={},this._activeParams=new Set,this._activeLightingParams=new Set,this.shaderOptBuilder=new jf,this.reset()}}sp.TEXTURE_PARAMETERS=Yf,sp.CUBEMAP_PARAMETERS=Jf;var rp=(e,t)=>{ep[e]=t},np=(e,t,i,s)=>{Object.defineProperty(sp.prototype,e,{get:s||function(){return this["_"+e]},set:i}),Zf[e]={value:t}},ap=e=>{var t="_"+e.name,i=e.dirtyShaderFunc||(()=>!0);np(e.name,(()=>e.defaultValue),(function(e){var s=this[t];s!==e&&(this._dirtyShader=this._dirtyShader||i(s,e),this[t]=e)}),e.getterFunc)},op=e=>{var t="_"+e.name,i=e.dirtyShaderFunc||(()=>!0);np(e.name,(()=>e.defaultValue.clone()),(function(e){var s=this[t];s.equals(e)||(this._dirtyShader=this._dirtyShader||i(s,e),this[t]=s.copy(e))}),e.getterFunc)},lp=e=>e.defaultValue&&e.defaultValue.clone?op(e):ap(e);function hp(e,t,i,s){void 0===t&&(t="rgb"),void 0===i&&(i=!0),void 0===s&&(s=0),Vf[e]=t.length||-1,lp({name:e+"Map",defaultValue:null,dirtyShaderFunc:(e,t)=>!!e!=!!t||e&&(e.type!==t.type||e.format!==t.format)}),lp({name:e+"MapTiling",defaultValue:new di(1,1)}),lp({name:e+"MapOffset",defaultValue:new di(0,0)}),lp({name:e+"MapRotation",defaultValue:0}),lp({name:e+"MapUv",defaultValue:s}),t&&(lp({name:e+"MapChannel",defaultValue:t}),i&&(lp({name:e+"VertexColor",defaultValue:!1}),lp({name:e+"VertexColorChannel",defaultValue:t})));var r=e+"MapTiling",n=e+"MapOffset",a=e+"MapRotation",o=e+"MapTransform";rp(o,((e,t,i)=>{var s=e[r],l=e[n],h=e[a];if(1===s.x&&1===s.y&&0===l.x&&0===l.y&&0===h)return null;var c=e._allocUniform(o,(()=>[{name:"texture_"+o+"0",value:new Float32Array(3)},{name:"texture_"+o+"1",value:new Float32Array(3)}])),d=Math.cos(h*ti.DEG_TO_RAD),u=Math.sin(h*ti.DEG_TO_RAD),f=c[0].value;f[0]=d*s.x,f[1]=-u*s.y,f[2]=l.x;var p=c[1].value;return p[0]=u*s.x,p[1]=d*s.y,p[2]=1-s.y-l.y,c}))}function cp(e,t){lp({name:e,defaultValue:t,getterFunc:function(){return this._dirtyShader=!0,this["_"+e]}}),rp(e,((t,i,s)=>{var r=t._allocUniform(e,(()=>new Float32Array(3))),n=t[e];return ip.linear(n),r[0]=ip.r,r[1]=ip.g,r[2]=ip.b,r}))}function dp(e,t,i){lp({name:e,defaultValue:t,dirtyShaderFunc:(e,t)=>(0===e||1===e)!=(0===t||1===t)}),rp(e,i)}function up(e,t){lp({name:e,defaultValue:null,dirtyShaderFunc:(e,t)=>!!e==!!t}),rp(e,t)}function fp(e,t){lp({name:e,defaultValue:t})}!function(){cp("ambient",new ii(1,1,1)),cp("diffuse",new ii(1,1,1)),cp("specular",new ii(0,0,0)),cp("emissive",new ii(0,0,0)),cp("sheen",new ii(1,1,1)),cp("attenuation",new ii(1,1,1)),dp("emissiveIntensity",1),dp("specularityFactor",1),dp("sheenGloss",0),dp("gloss",.25),dp("aoIntensity",1),dp("heightMapFactor",1,((e,t,i)=>.025*e.heightMapFactor)),dp("opacity",1),dp("alphaFade",1),dp("alphaTest",0),dp("bumpiness",1),dp("normalDetailMapBumpiness",1),dp("reflectivity",1),dp("occludeSpecularIntensity",1),dp("refraction",0),dp("refractionIndex",1/1.5),dp("dispersion",0),dp("thickness",0),dp("attenuationDistance",0),dp("metalness",1),dp("anisotropy",0),dp("clearCoat",0),dp("clearCoatGloss",1),dp("clearCoatBumpiness",1),dp("aoUvSet",0,null),dp("iridescence",0),dp("iridescenceRefractionIndex",1/1.5),dp("iridescenceThicknessMin",0),dp("iridescenceThicknessMax",0),up("ambientSH"),up("cubeMapProjectionBox",((e,t,i)=>{var s=e._allocUniform("cubeMapProjectionBox",(()=>[{name:"envBoxMin",value:new Float32Array(3)},{name:"envBoxMax",value:new Float32Array(3)}])),r=e.cubeMapProjectionBox.getMin(),n=s[0].value;n[0]=r.x,n[1]=r.y,n[2]=r.z;var a=e.cubeMapProjectionBox.getMax(),o=s[1].value;return o[0]=a.x,o[1]=a.y,o[2]=a.z,s})),fp("specularTint",!1),fp("specularityFactorTint",!1),fp("useMetalness",!1),fp("useMetalnessSpecularColor",!1),fp("useSheen",!1),fp("enableGGXSpecular",!1),fp("occludeDirect",!1),fp("opacityFadesSpecular",!0),fp("occludeSpecular",1),fp("fresnelModel",2),fp("useDynamicRefraction",!1),fp("cubeMapProjection",0),fp("customFragmentShader",null),fp("useFog",!0),fp("useLighting",!0),fp("useTonemap",!0),fp("useSkybox",!0),fp("forceUv1",!1),fp("pixelSnap",!1),fp("twoSidedLighting",!1),fp("nineSlicedMode",void 0),fp("msdfTextAttribute",!1),fp("useIridescence",!1),fp("glossInvert",!1),fp("sheenGlossInvert",!1),fp("clearCoatGlossInvert",!1),fp("opacityDither",ch),fp("opacityShadowDither",ch),fp("shadowCatcher",!1),hp("diffuse"),hp("specular"),hp("emissive"),hp("thickness","g"),hp("specularityFactor","g"),hp("normal",""),hp("metalness","g"),hp("gloss","g"),hp("opacity","a"),hp("refraction","g"),hp("height","g",!1),hp("ao","g"),hp("light","rgb",!0,1),hp("msdf",""),hp("diffuseDetail","rgb",!1),hp("normalDetail",""),hp("aoDetail","g",!1),hp("clearCoat","g"),hp("clearCoatGloss","g"),hp("clearCoatNormal",""),hp("sheen","rgb"),hp("sheenGloss","g"),hp("iridescence","g"),hp("iridescenceThickness","g"),fp("diffuseDetailMode","mul"),fp("aoDetailMode","mul"),up("cubeMap"),up("sphereMap"),up("envAtlas");var e=[null,null,null,null,null,null];np("prefilteredCubemaps",(()=>e.slice()),(function(e){var t=this._prefilteredCubemaps;e=e||[];for(var i=!1,s=!0,r=0;r<6;++r){var n=e[r]||null;t[r]!==n&&(t[r]=n,i=!0),s=s&&!!t[r]}i&&(s?this.envAtlas=Df.generatePrefilteredAtlas(t,{target:this.envAtlas}):this.envAtlas&&(this.envAtlas.destroy(),this.envAtlas=null),this._dirtyShader=!0)}),(function(){return this._prefilteredCubemaps}))}();var pp=4/64,mp=.875;class gp extends Ku{constructor(e,t,i,s,r,n){super();var a,o=new hi,l=new hi,h=new hi,c=new hi,d=new hi,u=new hi,f=[],p=[],m=[],g=[],v=[];if(i>0)for(var _=0;_<=s;_++)for(var b=0;b<=r;b++){var y=b/r*2*Math.PI-Math.PI,x=Math.sin(y),S=Math.cos(y);d.set(x*e,-i/2,S*e),c.set(x*t,i/2,S*t),o.lerp(d,c,_/s),l.sub2(c,d).normalize(),u.set(S,0,-x),h.cross(u,l).normalize(),f.push(o.x,o.y,o.z),p.push(h.x,h.y,h.z);var w=b/r,T=_/s;m.push(w,1-T);var C=T;if(T=w,w=(w=C)*mp+pp,T=T*mp+pp,w/=3,g.push(w,1-T),_<s&&b<r){var E=_*(r+1)+b,A=_*(r+1)+(b+1),P=(_+1)*(r+1)+b,D=(_+1)*(r+1)+(b+1);v.push(E,A,P),v.push(A,D,P)}}if(n){for(var L=Math.floor(r/2),M=r,I=i/2,R=0;R<=L;R++)for(var k=R*Math.PI*.5/L,O=Math.sin(k),F=Math.cos(k),B=0;B<=M;B++){var N=2*B*Math.PI/M-Math.PI/2,z=Math.sin(N),U=Math.cos(N)*O,V=F,H=z*O,G=1-B/M,W=1-R/L;f.push(U*t,V*t+I,H*t),p.push(U,V,H),m.push(G,1-W),G=G*mp+pp,W=W*mp+pp,G/=3,W/=3,G+=1/3,g.push(G,1-W)}a=(s+1)*(r+1);for(var j=0;j<L;++j)for(var q=0;q<M;++q){var X=j*(M+1)+q,K=X+M+1;v.push(a+X+1,a+K,a+X),v.push(a+X+1,a+K+1,a+K)}for(var Y=0;Y<=L;Y++)for(var Q=.5*Math.PI+Y*Math.PI*.5/L,J=Math.sin(Q),$=Math.cos(Q),Z=0;Z<=M;Z++){var ee=2*Z*Math.PI/M-Math.PI/2,te=Math.sin(ee),ie=Math.cos(ee)*J,se=$,re=te*J,ne=1-Z/M,ae=1-Y/L;f.push(ie*t,se*t-I,re*t),p.push(ie,se,re),m.push(ne,1-ae),ne=ne*mp+pp,ae=ae*mp+pp,ne/=3,ae/=3,ne+=2/3,g.push(ne,1-ae)}a=(s+1)*(r+1)+(M+1)*(L+1);for(var oe=0;oe<L;++oe)for(var le=0;le<M;++le){var he=oe*(M+1)+le,ce=he+M+1;v.push(a+he+1,a+ce,a+he),v.push(a+he+1,a+ce+1,a+ce)}}else{if(a=(s+1)*(r+1),e>0)for(var de=0;de<r;de++){var ue=de/r*2*Math.PI,fe=Math.sin(ue),pe=-i/2,me=Math.cos(ue),ge=1-(fe+1)/2,ve=(me+1)/2;f.push(fe*e,pe,me*e),p.push(0,-1,0),m.push(ge,1-ve),ge=ge*mp+pp,ve=ve*mp+pp,ge/=3,ve/=3,ge+=1/3,g.push(ge,1-ve),de>1&&v.push(a,a+de,a+de-1)}if(a+=r,t>0)for(var _e=0;_e<r;_e++){var be=_e/r*2*Math.PI,ye=Math.sin(be),xe=i/2,Se=Math.cos(be),we=1-(ye+1)/2,Te=(Se+1)/2;f.push(ye*t,xe,Se*t),p.push(0,1,0),m.push(we,1-Te),we=we*mp+pp,Te=Te*mp+pp,we/=3,Te/=3,we+=2/3,g.push(we,1-Te),_e>1&&v.push(a,a+_e-1,a+_e)}}this.positions=f,this.normals=p,this.uvs=m,this.uvs1=g,this.indices=v}}class vp extends gp{constructor(e={}){var t,i,s,r,n=null!=(t=e.radius)?t:.3;super(n,n,(null!=(i=e.height)?i:1)-2*n,null!=(s=e.heightSegments)?s:1,null!=(r=e.sides)?r:20,!0),e.calculateTangents&&(this.tangents=Xu(this.positions,this.normals,this.uvs,this.indices))}}class _p extends gp{constructor(e={}){var t,i,s,r,n;super(null!=(t=e.baseRadius)?t:.5,null!=(i=e.peakRadius)?i:0,null!=(s=e.height)?s:1,null!=(r=e.heightSegments)?r:5,null!=(n=e.capSegments)?n:18,!1),e.calculateTangents&&(this.tangents=Xu(this.positions,this.normals,this.uvs,this.indices))}}class bp extends gp{constructor(e={}){var t,i,s,r,n=null!=(t=e.radius)?t:.5;super(n,n,null!=(i=e.height)?i:1,null!=(s=e.heightSegments)?s:5,null!=(r=e.capSegments)?r:20,!1),e.calculateTangents&&(this.tangents=Xu(this.positions,this.normals,this.uvs,this.indices))}}class yp extends Ku{constructor(e={}){var t;super();for(var i,s,r=null!=(t=e.halfExtents)?t:new di(.5,.5),n=null!=(i=e.widthSegments)?i:5,a=null!=(s=e.lengthSegments)?s:5,o=[],l=[],h=[],c=[],d=0,u=0;u<=n;u++)for(var f=0;f<=a;f++){var p=-r.x+2*r.x*u/n,m=-(-r.y+2*r.y*f/a),g=u/n,v=f/a;o.push(p,0,m),l.push(0,1,0),h.push(g,1-v),u<n&&f<a&&(c.push(d+a+1,d+1,d),c.push(d+a+1,d+a+2,d+1)),d++}this.positions=o,this.normals=l,this.uvs=h,this.uvs1=h,this.indices=c,e.calculateTangents&&(this.tangents=Xu(o,l,h,c))}}class xp extends Ku{constructor(e={}){var t;super();for(var i,s,r,n,a=null!=(t=e.tubeRadius)?t:.2,o=null!=(i=e.ringRadius)?i:.3,l=(null!=(s=e.sectorAngle)?s:360)*ti.DEG_TO_RAD,h=null!=(r=e.segments)?r:30,c=null!=(n=e.sides)?n:20,d=[],u=[],f=[],p=[],m=0;m<=c;m++)for(var g=0;g<=h;g++){var v=Math.cos(l*g/h)*(o+a*Math.cos(2*Math.PI*m/c)),_=Math.sin(2*Math.PI*m/c)*a,b=Math.sin(l*g/h)*(o+a*Math.cos(2*Math.PI*m/c)),y=Math.cos(l*g/h)*Math.cos(2*Math.PI*m/c),x=Math.sin(2*Math.PI*m/c),S=Math.sin(l*g/h)*Math.cos(2*Math.PI*m/c),w=m/c,T=1-g/h;if(d.push(v,_,b),u.push(y,x,S),f.push(w,1-T),m<c&&g<h){var C=m*(h+1)+g,E=(m+1)*(h+1)+g,A=m*(h+1)+(g+1),P=(m+1)*(h+1)+(g+1);p.push(C,E,A),p.push(E,P,A)}}this.positions=d,this.normals=u,this.uvs=f,this.uvs1=f,this.indices=p,e.calculateTangents&&(this.tangents=Xu(d,u,f,p))}}class Sp{destroy(){this.clearCache()}register(e,t){this._generators.has(e)||this._generators.set(e,t)}unregister(e){this._generators.has(e)&&this._generators.delete(e)}isRegistered(e){return this._generators.has(e)}generateShaderDefinition(e,t,i,s){var r=this.definitionsCache.get(i);if(!r){var n,a,o;(null==(n=s.litOptions)?void 0:n.lights)&&(o=s.litOptions.lights,s.litOptions.lights=o.map((e=>{var t=e.clone?e.clone():e;return t.key=e.key,t}))),this.storeNewProgram(t,s),(null==(a=s.litOptions)?void 0:a.lights)&&(s.litOptions.lights=o);var l,h=this._device;(r=e.createShaderDefinition(h,s)).name=null!=(l=r.name)?l:s.pass?t+"-pass:"+s.pass:t,this.definitionsCache.set(i,r)}return r}getCachedShader(e){return this.processedCache.get(e)}setCachedShader(e,t){this.processedCache.set(e,t)}getProgram(e,t,i,s){var r=this._generators.get(e);if(!r)return null;var n=Rr(r.generateKey(t)),a=n+"#"+Rr(i.generateKey(this._device)),o=this.getCachedShader(a);if(!o){var l,h=this.generateShaderDefinition(r,e,n,t),c="";void 0!==t.pass&&(c="-"+(l=Th.get(this._device).getByIndex(t.pass)).name),this._device.fire("shader:generate",{userMaterialId:s,shaderPassInfo:l,definition:h});var d={name:""+h.name+c+"-proc",attributes:h.attributes,vshader:h.vshader,vincludes:h.vincludes,fincludes:h.fincludes,fshader:h.fshader,processingOptions:i,shaderLanguage:h.shaderLanguage,meshUniformBufferFormat:h.meshUniformBufferFormat,meshBindGroupFormat:h.meshBindGroupFormat};o=new Ra(this._device,d),this.setCachedShader(a,o)}return o}storeNewProgram(e,t){var i={};if("standard"===e){var s=this._getDefaultStdMatOptions(t.pass);for(var r in t)(t.hasOwnProperty(r)&&s[r]!==t[r]||"pass"===r)&&(i[r]=t[r]);for(var n in t.litOptions)i[n]=t.litOptions[n]}else i=t;this._programsCollection.push(JSON.stringify({name:e,options:i}))}dumpPrograms(){var e="let device = pc.app ? pc.app.graphicsDevice : pc.Application.getApplication().graphicsDevice;\n";e+="let shaders = [",this._programsCollection[0]&&(e+="\n\t"+this._programsCollection[0]);for(var t=1;t<this._programsCollection.length;++t)e+=",\n\t"+this._programsCollection[t];e+="\n];\n",e+="pc.getProgramLibrary(device).precompile(shaders);\n",e+='if (pc.version != "2.7.3" || pc.revision != "'+Mt+'")\n',e+='\tconsole.warn("precompile-shaders.js: engine version mismatch, rebuild shaders lib with current engine");';var i=document.createElement("a");i.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(e)),i.setAttribute("download","precompile-shaders.js"),i.style.display="none",document.body.appendChild(i),i.click(),document.body.removeChild(i)}clearCache(){this._isClearingCache=!0,this.processedCache.forEach((e=>{e.destroy()})),this.processedCache.clear(),this._isClearingCache=!1}removeFromCache(e){this._isClearingCache||this.processedCache.forEach(((t,i)=>{e===t&&this.processedCache.delete(i)}))}_getDefaultStdMatOptions(e){var t=Th.get(this._device).getByIndex(e);return 2===e||3===e||1===e||t.isShadow?this._defaultStdMatOptionMin:this._defaultStdMatOption}precompile(e){if(e)for(var t=new Array(e.length),i=0;i<e.length;i++){if("standard"===e[i].name){var s=e[i].options,r=this._getDefaultStdMatOptions(s.pass);for(var n in r)r.hasOwnProperty(n)&&void 0===s[n]&&(s[n]=r[n])}t[i]=this.getProgram(e[i].name,e[i].options)}this._precached=!0}constructor(e,t){this.processedCache=new Map,this.definitionsCache=new Map,this._generators=new Map,this._device=e,this._isClearingCache=!1,this._precached=!1,this._programsCollection=[],this._defaultStdMatOption=new zf,this._defaultStdMatOptionMin=new zf;var i=new ac;t.shaderOptBuilder.updateRef(this._defaultStdMatOption,{},i,t,null,[],0,null),t.shaderOptBuilder.updateMinRef(this._defaultStdMatOptionMin,{},t,null,4,null),e.on("destroy:shader",(e=>{this.removeFromCache(e)}))}}var wp="\n\tvec4 dirLm = texture2D(texture_dirLightMap, vUv1);\n\tif (bakeDir > 0.5) {\n\t\tif (dAtten > 0.00001) {\n\t\t\tdirLm.xyz = dirLm.xyz * 2.0 - vec3(1.0);\n\t\t\tdAtten = saturate(dAtten);\n\t\t\tgl_FragColor.rgb = normalize(dLightDirNormW.xyz*dAtten + dirLm.xyz*dirLm.w) * 0.5 + vec3(0.5);\n\t\t\tgl_FragColor.a = dirLm.w + dAtten;\n\t\t\tgl_FragColor.a = max(gl_FragColor.a, 1.0 / 255.0);\n\t\t} else {\n\t\t\tgl_FragColor = dirLm;\n\t\t}\n\t} else {\n\t\tgl_FragColor.rgb = dirLm.xyz;\n\t\tgl_FragColor.a = max(dirLm.w, dAtten > 0.00001? (1.0/255.0) : 0.0);\n\t}\n",Tp="\n#ifdef LIGHTMAP_RGBM\n\tgl_FragColor.rgb = dDiffuseLight;\n\tgl_FragColor.rgb = pow(gl_FragColor.rgb, vec3(0.5));\n\tgl_FragColor.rgb /= 8.0;\n\tgl_FragColor.a = clamp( max( max( gl_FragColor.r, gl_FragColor.g ), max( gl_FragColor.b, 1.0 / 255.0 ) ), 0.0,1.0 );\n\tgl_FragColor.a = ceil(gl_FragColor.a * 255.0) / 255.0;\n\tgl_FragColor.rgb /= gl_FragColor.a;\n#else\n\tgl_FragColor = vec4(dDiffuseLight, 1.0);\n#endif\n",Cp="\nvarying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\nbool isUsed(vec4 pixel) {\n\t#if HDR\n\t\treturn any(greaterThan(pixel.rgb, vec3(0.0)));\n\t#else\n\t\treturn pixel.a > 0.0;\n\t#endif\n}\nvoid main(void) {\n\tvec4 c = texture2DLod(source, vUv0, 0.0);\n\tc = isUsed(c) ? c : texture2DLod(source, vUv0 - pixelOffset, 0.0);\n\tc = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(0, -pixelOffset.y), 0.0);\n\tc = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(pixelOffset.x, -pixelOffset.y), 0.0);\n\tc = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(-pixelOffset.x, 0), 0.0);\n\tc = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(pixelOffset.x, 0), 0.0);\n\tc = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(-pixelOffset.x, pixelOffset.y), 0.0);\n\tc = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(0, pixelOffset.y), 0.0);\n\tc = isUsed(c) ? c : texture2DLod(source, vUv0 + pixelOffset, 0.0);\n\tgl_FragColor = c;\n}\n",Ep="\nfloat normpdf3(in vec3 v, in float sigma) {\n\treturn 0.39894 * exp(-0.5 * dot(v, v) / (sigma * sigma)) / sigma;\n}\nvec3 decodeRGBM(vec4 rgbm) {\n\tvec3 color = (8.0 * rgbm.a) * rgbm.rgb;\n\treturn color * color;\n}\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec4 encodeRGBM(vec3 color) {\n\tvec4 encoded;\n\tencoded.rgb = pow(color.rgb, vec3(0.5));\n\tencoded.rgb *= 1.0 / 8.0;\n\tencoded.a = saturate( max( max( encoded.r, encoded.g ), max( encoded.b, 1.0 / 255.0 ) ) );\n\tencoded.a = ceil(encoded.a * 255.0) / 255.0;\n\tencoded.rgb /= encoded.a;\n\treturn encoded;\n}\nvec3 decode(vec4 pixel) {\n\t#if HDR\n\t\treturn pixel.rgb;\n\t#else\n\t\treturn decodeRGBM(pixel);\n\t#endif\n}\nbool isUsed(vec4 pixel) {\n\t#if HDR\n\t\treturn any(greaterThan(pixel.rgb, vec3(0.0)));\n\t#else\n\t\treturn pixel.a > 0.0;\n\t#endif\n}\n#define MSIZE 15\nvarying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\nuniform vec2 sigmas;\nuniform float bZnorm;\nuniform float kernel[MSIZE];\nvoid main(void) {\n\t\n\tvec4 pixel = texture2DLod(source, vUv0, 0.0);\n\tif (!isUsed(pixel)) {\n\t\tgl_FragColor = pixel;\n\t\treturn ;\n\t}\n\tfloat sigma = sigmas.x;\n\tfloat bSigma = sigmas.y;\n\tvec3 pixelHdr = decode(pixel);\n\tvec3 accumulatedHdr = vec3(0.0);\n\tfloat accumulatedFactor = 0.000001;\n\tconst int kSize = (MSIZE-1)/2;\n\tfor (int i = -kSize; i <= kSize; ++i) {\n\t\tfor (int j = -kSize; j <= kSize; ++j) {\n\t\t\t\n\t\t\tvec2 coord = vUv0 + vec2(float(i), float(j)) * pixelOffset;\n\t\t\tvec4 pix = texture2DLod(source, coord, 0.0);\n\t\t\tif (isUsed(pix)) {\n\t\t\t\tvec3 hdr = decode(pix);\n\t\t\t\tfloat factor = kernel[kSize + j] * kernel[kSize + i];\n\t\t\t\tfactor *= normpdf3(hdr - pixelHdr, bSigma) * bZnorm;\n\t\t\t\taccumulatedHdr += factor * hdr;\n\t\t\t\taccumulatedFactor += factor;\n\t\t\t}\n\t\t}\n\t}\n\tvec3 finalHDR = accumulatedHdr / accumulatedFactor;\n\t#if HDR\n\t\tgl_FragColor = vec4(finalHDR, 1.0);\n\t#else\n\t\tgl_FragColor = encodeRGBM(finalHDR);\n\t#endif\n}\n",Ap=new _i,Pp=new bi,Dp=new Ci,Lp=new Ci,Mp=new ii(1,1,0,.4),Ip=.28209479177387814;class Rp{constructor(e,t,i,s,r){var n=e.getProp("x"),a=e.getProp("y"),o=e.getProp("z"),l=e.getProp("rot_1"),h=e.getProp("rot_2"),c=e.getProp("rot_3"),d=e.getProp("rot_0"),u=e.getProp("scale_0"),f=e.getProp("scale_1"),p=e.getProp("scale_2"),m=e.getProp("f_dc_0"),g=e.getProp("f_dc_1"),v=e.getProp("f_dc_2"),_=e.getProp("opacity");this.read=e=>{t&&(t.x=n[e],t.y=a[e],t.z=o[e]),i&&i.set(l[e],h[e],c[e],d[e]),s&&s.set(Math.exp(u[e]),Math.exp(f[e]),Math.exp(p[e])),r&&r.set(.5+m[e]*Ip,.5+g[e]*Ip,.5+v[e]*Ip,(e=>{if(e>0)return 1/(1+Math.exp(-e));var t=Math.exp(e);return t/(1+t)})(_[e]))}}}var kp=(e,t,i)=>{Pp.set(i.x,i.y,i.z,i.w).normalize(),e.setTRS(t,Pp,hi.ONE)};class Op{static calcSplatAabb(e,t,i,s){kp(Ap,t,i),Dp.center.set(0,0,0),Dp.halfExtents.set(2*s.x,2*s.y,2*s.z),e.setFromTransformedAabb(Dp,Ap)}getProp(e,t){var i,s;return void 0===t&&(t="vertex"),null==(s=this.getElement(t))||null==(i=s.properties.find((t=>t.name===e)))?void 0:i.storage}getElement(e){return this.elements.find((t=>t.name===e))}addProp(e,t){this.getElement("vertex").properties.push({type:"float",name:e,storage:t,byteSize:4})}createIter(e,t,i,s){return new Rp(this,e,t,i,s)}calcAabb(e,t){for(var i,s,r,n,a,o,l=!0,h=this.getProp("x"),c=this.getProp("y"),d=this.getProp("z"),u=this.getProp("scale_0"),f=this.getProp("scale_1"),p=this.getProp("scale_2"),m=0;m<this.numSplats;++m)if(!t||t(m)){var g=h[m],v=c[m],_=d[m],b=Math.max(u[m],f[m],p[m]);if(isFinite(g)&&isFinite(v)&&isFinite(_)&&isFinite(b)){var y=2*Math.exp(b);l?(l=!1,i=g-y,s=v-y,r=_-y,n=g+y,a=v+y,o=_+y):(i=Math.min(i,g-y),s=Math.min(s,v-y),r=Math.min(r,_-y),n=Math.max(n,g+y),a=Math.max(a,v+y),o=Math.max(o,_+y))}}return l||(e.center.set(.5*(i+n),.5*(s+a),.5*(r+o)),e.halfExtents.set(.5*(n-i),.5*(a-s),.5*(o-r))),!l}calcAabbExact(e,t){for(var i=new hi,s=new bi,r=new hi,n=this.createIter(i,s,r),a=!0,o=0;o<this.numSplats;++o)t&&!t(o)||(n.read(o),a?(a=!1,Op.calcSplatAabb(e,i,s,r)):(Op.calcSplatAabb(Lp,i,s,r),e.add(Lp)));return!a}getCenters(e){for(var t=this.getProp("x"),i=this.getProp("y"),s=this.getProp("z"),r=0;r<this.numSplats;++r)e[3*r+0]=t[r],e[3*r+1]=i[r],e[3*r+2]=s[r]}calcFocalPoint(e,t){var i=this.getProp("x"),s=this.getProp("y"),r=this.getProp("z"),n=this.getProp("scale_0"),a=this.getProp("scale_1"),o=this.getProp("scale_2");e.x=0,e.y=0,e.z=0;for(var l=0,h=0;h<this.numSplats;++h)if(!t||t(h)){var c=i[h],d=s[h],u=r[h];if(isFinite(c)&&isFinite(d)&&isFinite(u)){var f=1/(1+Math.exp(Math.max(n[h],a[h],o[h])));e.x+=c*f,e.y+=d*f,e.z+=u*f,l+=f}}e.mulScalar(1/l)}renderWireframeBounds(e,t){for(var i=new hi,s=new bi,r=new hi,n=new hi,a=new hi,o=this.createIter(i,s,r),l=0;l<this.numSplats;++l)o.read(l),kp(Ap,i,s),Ap.mul2(t,Ap),n.set(-2*r.x,-2*r.y,-2*r.z),a.set(2*r.x,2*r.y,2*r.z),e.immediate.drawWireAlignedBox(n,a,Mp,!0,e.defaultDrawLayer,Ap)}get isCompressed(){return!1}get shBands(){var e;return null!=(e={9:1,24:2,45:3}[(()=>{for(var e=0;e<45;++e)if(!this.getProp("f_rest_"+e))return e;return 45})()])?e:0}calcMortonOrder(){for(var e=e=>{for(var t=e[0],i=e[0],s=1;s<e.length;s++)e[s]<t&&(t=e[s]),e[s]>i&&(i=e[s]);return{min:t,max:i}},t=(e,t,i)=>{var s=e=>e=153391689&((e=51130563&((e=50393103&((e=4278190335&((e&=1023)^e<<16))^e<<8))^e<<4))^e<<2);return(s(i)<<2)+(s(t)<<1)+s(e)},i=this.getProp("x"),s=this.getProp("y"),r=this.getProp("z"),{min:n,max:a}=e(i),{min:o,max:l}=e(s),{min:h,max:c}=e(r),d=n===a?0:1024/(a-n),u=o===l?0:1024/(l-o),f=h===c?0:1024/(c-h),p=new Map,m=0;m<this.numSplats;m++){var g=t(Math.floor((i[m]-n)*d),Math.floor((s[m]-o)*u),Math.floor((r[m]-h)*f)),v=p.get(g);v?v.push(m):p.set(g,[m])}for(var _=Array.from(p.keys()).sort(((e,t)=>e-t)),b=new Uint32Array(this.numSplats),y=0,x=0;x<_.length;++x)for(var S=p.get(_[x]),w=0;w<S.length;++w)b[y++]=S[w];return b}reorder(e){var t=new Map,i=i=>{for(var s,r=new i.constructor((e=>{if(t.has(e)){var i=t.get(e);return t.delete(e),i}return new ArrayBuffer(e)})(i.byteLength)),n=0;n<e.length;n++)r[n]=i[e[n]];return s=i.buffer,t.set(s.byteLength,s),r};this.elements.forEach((e=>{e.properties.forEach((e=>{e.storage&&(e.storage=i(e.storage))}))}))}reorderData(){this.reorder(this.calcMortonOrder())}constructor(e){this.elements=e,this.numSplats=this.getElement("vertex").count}}var Fp=e=>{var t;void 0===e&&(e={});var i,s,r=null!=(t=e.dither)?t:ch,n=r!==ch,a=new Hu({uniqueName:"SplatMaterial",vertexGLSL:null!=(i=e.vertex)?i:_h.gsplatVS,fragmentGLSL:null!=(s=e.fragment)?s:_h.gsplatPS,attributes:{vertex_position:Ji,vertex_id_attrib:ms}});return a.setDefine("DITHER_"+r.toUpperCase(),""),a.cull=0,a.blendType=n?3:4,a.depthWrite=n,a.update(),a};class Bp{destroy(){var e,t,i,s,r,n,a;null==(e=this.colorTexture)||e.destroy(),null==(t=this.transformATexture)||t.destroy(),null==(i=this.transformBTexture)||i.destroy(),null==(s=this.sh1to3Texture)||s.destroy(),null==(r=this.sh4to7Texture)||r.destroy(),null==(n=this.sh8to11Texture)||n.destroy(),null==(a=this.sh12to15Texture)||a.destroy()}createMaterial(e){var t=Fp(e);return t.setParameter("splatColor",this.colorTexture),t.setParameter("transformA",this.transformATexture),t.setParameter("transformB",this.transformBTexture),t.setParameter("numSplats",this.numSplatsVisible),t.setDefine("SH_BANDS",this.shBands),this.sh1to3Texture&&t.setParameter("splatSH_1to3",this.sh1to3Texture),this.sh4to7Texture&&t.setParameter("splatSH_4to7",this.sh4to7Texture),this.sh8to11Texture&&t.setParameter("splatSH_8to11",this.sh8to11Texture),this.sh12to15Texture&&t.setParameter("splatSH_12to15",this.sh12to15Texture),t}evalTextureSize(e){var t=Math.ceil(Math.sqrt(e)),i=Math.ceil(e/t);return new di(t,i)}createTexture(e,t,i){return new ur(this.device,{name:e,width:i.x,height:i.y,format:t,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1})}updateColorData(e){var t=this.colorTexture;if(t){for(var i=li.float2Half,s=t.lock(),r=e.getProp("f_dc_0"),n=e.getProp("f_dc_1"),a=e.getProp("f_dc_2"),o=e.getProp("opacity"),l=.28209479177387814,h=0;h<this.numSplats;++h){var c=r[h]*l+.5,d=n[h]*l+.5,u=a[h]*l+.5,f=1/(1+Math.exp(-o[h]));s[4*h+0]=i(c),s[4*h+1]=i(d),s[4*h+2]=i(u),s[4*h+3]=i(f)}t.unlock()}}updateTransformData(e){var t=li.float2Half;if(this.transformATexture){for(var i=this.transformATexture.lock(),s=new Float32Array(i.buffer),r=this.transformBTexture.lock(),n=new hi,a=new bi,o=new hi,l=e.createIter(n,a,o),h=0;h<this.numSplats;h++)l.read(h),a.normalize(),a.w<0&&a.mulScalar(-1),s[4*h+0]=n.x,s[4*h+1]=n.y,s[4*h+2]=n.z,i[4*h+3]=t(a.x)|t(a.y)<<16,r[4*h+0]=t(o.x),r[4*h+1]=t(o.y),r[4*h+2]=t(o.z),r[4*h+3]=t(a.z);this.transformATexture.unlock(),this.transformBTexture.unlock()}}updateSHData(e){for(var t,i,s,r,n,a,o=this.sh1to3Texture.lock(),l=null==(t=this.sh4to7Texture)?void 0:t.lock(),h=null==(i=this.sh8to11Texture)?void 0:i.lock(),c=null==(s=this.sh12to15Texture)?void 0:s.lock(),d={1:3,2:8,3:15}[this.shBands],u=((e,t)=>{for(var i=[],s=0;s<t;++s)i.push(e.getProp("f_rest_"+s));return i})(e,3*d),f=2047,p=new Float32Array(1),m=new Uint32Array(p.buffer),g=new Array(3*d).fill(0),v=0;v<e.numSplats;++v){for(var _=0;_<d;++_)g[3*_]=u[_][v],g[3*_+1]=u[_+d][v],g[3*_+2]=u[_+2*d][v];for(var b=g[0],y=1;y<3*d;++y)b=Math.max(b,Math.abs(g[y]));if(0!==b){for(var x=0;x<d;++x)g[3*x+0]=Math.max(0,Math.min(f,Math.floor((g[3*x+0]/b*.5+.5)*f+.5))),g[3*x+1]=Math.max(0,Math.min(1023,Math.floor(1023*(g[3*x+1]/b*.5+.5)+.5))),g[3*x+2]=Math.max(0,Math.min(f,Math.floor((g[3*x+2]/b*.5+.5)*f+.5)));p[0]=b,o[4*v+0]=m[0],o[4*v+1]=g[0]<<21|g[1]<<11|g[2],o[4*v+2]=g[3]<<21|g[4]<<11|g[5],o[4*v+3]=g[6]<<21|g[7]<<11|g[8],this.shBands>1&&(l[4*v+0]=g[9]<<21|g[10]<<11|g[11],l[4*v+1]=g[12]<<21|g[13]<<11|g[14],l[4*v+2]=g[15]<<21|g[16]<<11|g[17],l[4*v+3]=g[18]<<21|g[19]<<11|g[20],this.shBands>2?(h[4*v+0]=g[21]<<21|g[22]<<11|g[23],h[4*v+1]=g[24]<<21|g[25]<<11|g[26],h[4*v+2]=g[27]<<21|g[28]<<11|g[29],h[4*v+3]=g[30]<<21|g[31]<<11|g[32],c[4*v+0]=g[33]<<21|g[34]<<11|g[35],c[4*v+1]=g[36]<<21|g[37]<<11|g[38],c[4*v+2]=g[39]<<21|g[40]<<11|g[41],c[4*v+3]=g[42]<<21|g[43]<<11|g[44]):h[v]=g[21]<<21|g[22]<<11|g[23])}}this.sh1to3Texture.unlock(),null==(r=this.sh4to7Texture)||r.unlock(),null==(n=this.sh8to11Texture)||n.unlock(),null==(a=this.sh12to15Texture)||a.unlock()}constructor(e,t){var i=t.numSplats;this.device=e,this.numSplats=i,this.numSplatsVisible=i,this.centers=new Float32Array(3*t.numSplats),t.getCenters(this.centers),this.aabb=new Ci,t.calcAabb(this.aabb);var s=this.evalTextureSize(i);this.colorTexture=this.createTexture("splatColor",Ri,s),this.transformATexture=this.createTexture("transformA",Gi,s),this.transformBTexture=this.createTexture("transformB",Ri,s),this.updateColorData(t),this.updateTransformData(t),this.shBands=t.shBands,this.shBands>0&&(this.sh1to3Texture=this.createTexture("splatSH_1to3",Gi,s),this.shBands>1&&(this.sh4to7Texture=this.createTexture("splatSH_4to7",Gi,s),this.shBands>2?(this.sh8to11Texture=this.createTexture("splatSH_8to11",Gi,s),this.sh12to15Texture=this.createTexture("splatSH_12to15",Gi,s)):this.sh8to11Texture=this.createTexture("splatSH_8to11",Hi,s)),this.updateSHData(t))}}function Np(){var e,t,i,s,r,n,a,o,l=!1,h={x:0,y:0,z:0},c={x:0,y:0,z:0},d={x:0,y:0,z:0},u={x:0,y:0,z:0},f=32,p=new Array(f).fill(0),m=new Array(f).fill(0),g=new Array(f).fill(0);self.onmessage=v=>{if(v.data.order&&(e=new Uint32Array(v.data.order)),v.data.centers)if(t=new Float32Array(v.data.centers),l=!0,v.data.chunks){var _=new Float32Array(v.data.chunks);i=new Float32Array(v.data.chunks,0,4*_.length/6),d.x=_[0],d.y=_[1],d.z=_[2],u.x=_[3],u.y=_[4],u.z=_[5];for(var b=0;b<_.length/6;++b){var y=_[6*b+0],x=_[6*b+1],S=_[6*b+2],w=_[6*b+3],T=_[6*b+4],C=_[6*b+5];i[4*b+0]=.5*(y+w),i[4*b+1]=.5*(x+T),i[4*b+2]=.5*(S+C),i[4*b+3]=.5*Math.sqrt((w-y)**2+(T-x)**2+(C-S)**2),y<d.x&&(d.x=y),x<d.y&&(d.y=x),S<d.z&&(d.z=S),w>u.x&&(u.x=w),T>u.y&&(u.y=T),C>u.z&&(u.z=C)}}else{var E,A,P,D,L,M,I=t.length/3,R=Math.ceil(I/256);i=new Float32Array(4*R),d.x=d.y=d.z=1/0,u.x=u.y=u.z=-1/0;for(var k=0;k<R;++k){E=A=P=1/0,D=L=M=-1/0;for(var O=256*k,F=Math.min(I,256*(k+1)),B=O;B<F;++B){var N=t[3*B+0],z=t[3*B+1],U=t[3*B+2],V=Number.isFinite(N),H=Number.isFinite(z),G=Number.isFinite(U);V||(t[3*B+0]=0),H||(t[3*B+1]=0),G||(t[3*B+2]=0),V&&H&&G&&(N<E?E=N:N>D&&(D=N),z<A?A=z:z>L&&(L=z),U<P?P=U:U>M&&(M=U),N<d.x?d.x=N:N>u.x&&(u.x=N),z<d.y?d.y=z:z>u.y&&(u.y=z),U<d.z?d.z=U:U>u.z&&(u.z=U))}i[4*k+0]=.5*(E+D),i[4*k+1]=.5*(A+L),i[4*k+2]=.5*(P+M),i[4*k+3]=.5*Math.sqrt((D-E)**2+(L-A)**2+(M-P)**2)}}v.data.hasOwnProperty("mapping")&&(s=v.data.mapping?new Uint32Array(v.data.mapping):null,l=!0),v.data.cameraPosition&&(r=v.data.cameraPosition),v.data.cameraDirection&&(n=v.data.cameraDirection),(()=>{if(e&&t&&0!==t.length&&r&&n){var v=r.x,_=r.y,b=r.z,y=n.x,x=n.y,S=n.z,w=.001;if(!(!l&&Math.abs(v-h.x)<w&&Math.abs(_-h.y)<w&&Math.abs(b-h.z)<w&&Math.abs(y-c.x)<w&&Math.abs(x-c.y)<w&&Math.abs(S-c.z)<w)){var T,C;l=!1,h.x=v,h.y=_,h.z=b,c.x=y,c.y=x,c.z=S;for(var E=0;E<8;++E){var A=1&E?d.x:u.x,P=2&E?d.y:u.y,D=4&E?d.z:u.z,L=A*y+P*x+D*S;0===E?T=C=L:(T=Math.min(T,L),C=Math.max(C,L))}var M=t.length/3,I=2**Math.max(10,Math.min(20,Math.round(Math.log2(M/4))))+1;(null==a?void 0:a.length)!==M&&(a=new Uint32Array(M)),o&&o.length===I?o.fill(0):o=new Uint32Array(I);var R=C-T;if(R<1e-6)for(var k=0;k<M;++k)a[k]=0,o[0]++;else{var O=i.length/4;p.fill(0);for(var F=0;F<O;++F)for(var B=i[4*F+0],N=i[4*F+1],z=i[4*F+2],U=i[4*F+3],V=B*y+N*x+z*S-T,H=Math.max(0,Math.floor((V-U)*f/R)),G=Math.min(f,Math.ceil((V+U)*f/R)),W=H;W<G;++W)p[W]++;for(var j=p.reduce(((e,t)=>e+t),0),q=0;q<f;++q)g[q]=p[q]/j*I>>>0;for(var X=0;X<f;++X)m[X]=0===X?0:m[X-1]+g[X-1];for(var K=R/f,Y=0,Q=0;Q<M;++Q){var J=t[Y++],$=t[Y++],Z=t[Y++],ee=(J*y+$*x+Z*S-T)/K,te=ee>>>0,ie=m[te]+g[te]*(ee-te)>>>0;a[Q]=ie,o[ie]++}}for(var se=1;se<I;se++)o[se]+=o[se-1];for(var re=0;re<M;re++){var ne=a[re],ae=--o[ne];e[ae]=re}var oe=v*y+_*x+b*S,le=i=>{var s=3*e[i];return t[s++]*y+t[s++]*x+t[s]*S-oe},he=le(M-1)>=0?(()=>{var e=((e,t,i)=>{for(;e<=t;){var s=t+e>>1,r=i(s);if(r>0)e=s+1;else{if(!(r<0))return s;t=s-1}}return~e})(0,M-1,(e=>-le(e)));return Math.min(M,Math.abs(e))})():M;if(s)for(var ce=0;ce<M;++ce)e[ce]=s[e[ce]];self.postMessage({order:e.buffer,count:he},[e.buffer]),e=null}}})()}}class zp extends Ht{destroy(){this.worker.terminate(),this.worker=null}init(e,t,i){this.orderTexture=e,this.centers=t.slice();var s=this.orderTexture.lock({mode:1}).slice();this.orderTexture.unlock();for(var r=0;r<s.length;++r)s[r]=r;var n={order:s.buffer,centers:t.buffer,chunks:null==i?void 0:i.buffer},a=[s.buffer,t.buffer].concat(i?[i.buffer]:[]);this.worker.postMessage(n,a)}setMapping(e){if(e){for(var t=new Float32Array(3*e.length),i=0;i<e.length;++i){var s=3*e[i],r=3*i;t[r+0]=this.centers[s+0],t[r+1]=this.centers[s+1],t[r+2]=this.centers[s+2]}this.worker.postMessage({centers:t.buffer,mapping:e.buffer},[t.buffer,e.buffer])}else{var n=this.centers.slice();this.worker.postMessage({centers:n.buffer,mapping:null},[n.buffer])}}setCamera(e,t){this.enabled&&this.worker.postMessage({cameraPosition:{x:e.x,y:e.y,z:e.z},cameraDirection:{x:t.x,y:t.y,z:t.z}})}forceSortSync(e,t){if(!e.equalsApprox(this.pos)||!t.equalsApprox(this.dir)){this.pos=e,this.dir=t;const i=e,s=t;if(!this.centers||0===this.centers.length||!i||!s)return;const r=i.x,n=i.y,a=i.z,o=s.x,l=s.y,h=s.z,c=this.centers.length/3,d=new Array(c),u=r*o+n*l+a*h;for(let e=0;e<c;++e){const t=3*e,i=this.centers[t]*o+this.centers[t+1]*l+this.centers[t+2]*h-u;d[e]={i:e,key:i}}d.sort(((e,t)=>e.key-t.key));const f=this.orderTexture,p=f._levels[0].length,m=new Uint32Array(p);for(let e=0;e<c;++e)m[e]=d[e].i;for(let e=c;e<p;++e)m[e]=0;f._levels[0]=m,f.upload(),this.fire("updated",c)}}constructor(){super(),this.enabled=!0,this.pos=new hi,this.dir=new hi,this.worker=new Worker(URL.createObjectURL(new Blob(["("+Np.toString()+")()"],{type:"application/javascript"}))),this.worker.onmessage=e=>{var t=e.data.order,i=this.orderTexture._levels[0].buffer;this.worker.postMessage({order:i},[i]),this.orderTexture._levels[0]=new Uint32Array(t),this.orderTexture.upload(),this.fire("updated",e.data.count)}}}var Up=new _i,Vp=new hi,Hp=new hi,Gp=[0,0];class Wp{destroy(){var e,t,i;null==(e=this.material)||e.destroy(),null==(t=this.meshInstance)||t.destroy(),null==(i=this.sorter)||i.destroy()}clone(){return new Wp(this.splat,this.options)}createMaterial(e){this.material=this.splat.createMaterial(e),this.material.setParameter("splatOrder",this.orderTexture),this.material.setParameter("alphaClip",.3),this.meshInstance&&(this.meshInstance.material=this.material)}updateViewport(e){var t,i=null==e?void 0:e.camera,s=null==i?void 0:i.renderTarget,{width:r,height:n}=null!=s?s:this.splat.device;Gp[0]=r,Gp[1]=n;var a=null==i||null==(t=i.camera)?void 0:t.xr;(null==a?void 0:a.active)&&2===a.views.list.length&&(Gp[0]*=.5),this.material.setParameter("viewport",Gp)}sort(e){if(this.sorter){var t=e.getWorldTransform();t.getTranslation(Vp),t.getZ(Hp);var i=this.meshInstance.node.getWorldTransform(),s=Up.invert(i);s.transformPoint(Vp,Vp),s.transformVector(Hp,Hp),Vp.equalsApprox(this.lastCameraPosition)&&Hp.equalsApprox(this.lastCameraDirection)||(this.lastCameraPosition.copy(Vp),this.lastCameraDirection.copy(Hp),this.sorter.setCamera(Vp,Hp))}this.updateViewport(e)}update(){if(this.cameras.length>0){var e=this.cameras[0];this.sort(e._node),this.cameras.length=0}}constructor(e,t){var i;this.options={},this.sorter=null,this.lastCameraPosition=new hi,this.lastCameraDirection=new hi,this.cameras=[],this.splat=e,t=Object.assign(this.options,t);var s=e.device;this.orderTexture=this.splat.createTexture("splatOrder",Hi,this.splat.evalTextureSize(this.splat.numSplats)),this.createMaterial(t);for(var r=128,n=Math.ceil(e.numSplats/r)*r/r,a=new Uint32Array(n),o=0;o<n;++o)a[o]=o*r;for(var l=new Nr(s,[{semantic:ms,components:1,type:5,asInt:!0}]),h=new Ir(s,l,n,{usage:0,data:a.buffer}),c=new Float32Array(1536),d=new Uint32Array(768),u=0;u<r;++u){c.set([-1,-1,u,1,-1,u,1,1,u,-1,1,u],12*u);var f=4*u;d.set([0+f,1+f,2+f,0+f,2+f,3+f],6*u)}var p=new Gh(s);p.setPositions(c,3),p.setIndices(d),p.update(),this.mesh=p,this.mesh.aabb.copy(e.aabb),this.meshInstance=new tc(this.mesh,this.material),this.meshInstance.setInstancing(h,!0),this.meshInstance.gsplatInstance=this,this.meshInstance.instancingCount=0;var m=e.centers.slice(),g=null==(i=e.chunks)?void 0:i.slice();t.dither&&t.dither!==ch||(this.sorter=new zp,this.sorter.init(this.orderTexture,m,g),this.sorter.on("updated",(e=>{this.meshInstance.instancingCount=Math.ceil(e/r),this.material.setParameter("numSplats",e)})))}}var jp,qp="KEEP_ASPECT",Xp="AUTO";function Kp(){return jp}function Yp(e){jp=e}class Qp{addRenderPass(e){e.frameUpdate();for(var t=e.beforePasses,i=0;i<t.length;i++){var s=t[i];s.enabled&&this.addRenderPass(s)}e.enabled&&this.renderPasses.push(e);for(var r=e.afterPasses,n=0;n<r.length;n++){var a=r[n];a.enabled&&this.addRenderPass(a)}}reset(){this.renderPasses.length=0}compile(){for(var e=this.renderTargetMap,t=this.renderPasses,i=0;i<t.length;i++){var s=t[i],r=s.renderTarget;if(void 0!==r){var n=e.get(r);if(n){for(var a=s.colorArrayOps.length,o=0;o<a;o++){s.colorArrayOps[o].clear||(n.colorArrayOps[o].store=!0)}s.depthStencilOps.clearDepth||(n.depthStencilOps.storeDepth=!0),s.depthStencilOps.clearStencil||(n.depthStencilOps.storeStencil=!0)}e.set(r,s)}}for(var l=0;l<t.length-1;l++){var h=t[l],c=h.renderTarget,d=t[l+1];c===d.renderTarget&&void 0!==c&&(d.depthStencilOps.clearDepth||d.depthStencilOps.clearStencil||d.colorArrayOps.some((e=>e.clear))||h.afterPasses.length>0||d.beforePasses.length>0||(h._skipEnd=!0,d._skipStart=!0))}for(var u=null,f=null,p=0;p<t.length;p++){var m=t[p],g=m.renderTarget,v=null==g?void 0:g.colorBuffer;if(null==v?void 0:v.cubemap){if(u===v)for(var _=f.colorArrayOps.length,b=0;b<_;b++)f.colorArrayOps[b].mipmaps=!1;u=g.colorBuffer,f=m}else m.requiresCubemaps&&(u=null,f=null)}e.clear()}render(e){this.compile();for(var t=this.renderPasses,i=0;i<t.length;i++)t[i].render()}constructor(){this.renderPasses=[],this.renderTargetMap=new Map}}class Jp{destroy(){var e,t;null==(e=this.texture0)||e.destroy(),null==(t=this.texture1)||t.destroy()}constructor(e,t){this.texture0=e,this.texture1=t}}var $p=new hr;class Zp{static createTexture(e,t,i,s){return void 0===s&&(s=""),new ur(e,{name:"AreaLightLUT"+s,width:i,height:i,format:t,addressU:1,addressV:1,type:_s,magFilter:1,minFilter:0,anisotropy:1,mipmaps:!1})}static applyTextures(e,t,i){$p.remove(e),$p.get(e,(()=>new Jp(t,t===i?null:i))),e.scope.resolve("areaLightsLutTex1").setValue(t),e.scope.resolve("areaLightsLutTex2").setValue(i)}static createPlaceholder(e){var t=Zp.createTexture(e,Ri,2,"placeholder");t.lock().fill(0),t.unlock(),Zp.applyTextures(e,t,t)}static set(e,t,i){function s(e,t,i){var s=Zp.createTexture(e,i,64);return s.lock().set(t),s.unlock(),s}function r(e){for(var t=e.length,i=new Uint16Array(t),s=li.float2Half,r=0;r<t;r++)i[r]=s(e[r]);return i}var n=i,a=r(t),o=r(n),l=s(e,a,Ri),h=s(e,o,Ri);Zp.applyTextures(e,l,h)}}var em="en-US",tm={en:"en-US",es:"en-ES",zh:"zh-CN","zh-HK":"zh-TW","zh-TW":"zh-HK","zh-MO":"zh-HK",fr:"fr-FR",de:"de-DE",it:"it-IT",ru:"ru-RU",ja:"ja-JP"},im={};function sm(e,t){for(var i=0,s=e.length;i<s;i++)im[e[i]]=t}function rm(e){var t=e.indexOf("-");return-1!==t?e.substring(0,t):e}function nm(e,t){if(t[e])return e;var i=tm[e];if(i&&t[i])return i;var s=rm(e);return t[i=tm[s]]?i:t[s]?s:em}sm(["ja","ko","th","vi","zh","id"],(e=>0)),sm(["fa","hi"],(e=>e>=0&&e<=1?0:1)),sm(["fr","pt"],(e=>e>=0&&e<2?0:1)),sm(["da"],(e=>1===e||!Number.isInteger(e)&&e>=0&&e<=1?0:1)),sm(["de","en","it","el","es","tr","fi","sv","nb","no","ur"],(e=>1===e?0:1)),sm(["ru","uk"],(e=>{if(Number.isInteger(e)){var t=e%10,i=e%100;if(1===t&&11!==i)return 0;if(t>=2&&t<=4&&(i<12||i>14))return 1;if(0===t||t>=5&&t<=9||i>=11&&i<=14)return 2}return 3})),sm(["pl"],(e=>{if(Number.isInteger(e)){if(1===e)return 0;var t=e%10,i=e%100;if(t>=2&&t<=4&&(i<12||i>14))return 1;if(t>=0&&t<=1||t>=5&&t<=9||i>=12&&i<=14)return 2}return 3})),sm(["ar"],(e=>{if(0===e)return 0;if(1===e)return 1;if(2===e)return 2;if(Number.isInteger(e)){var t=e%100;if(t>=3&&t<=10)return 3;if(t>=11&&t<=99)return 4}return 5}));var am=im[rm(em)];function om(e){return im[e]||am}var lm=new RegExp("^\\s*(?:(?:[a-z]+[a-z0-9\\-+.]*:)?//|data:|blob:)","i");class hm{equals(e){return this.url===e.url&&this.filename===e.filename&&this.hash===e.hash&&this.size===e.size&&this.opt===e.opt&&this.contents===e.contents}constructor(e="",t="",i=null,s=null,r=null,n=null){this.url=e,this.filename=t,this.hash=i,this.size=s,this.opt=r,this.contents=n}}var cm=-1,dm={pvr:"extCompressedTexturePVRTC",dxt:"extCompressedTextureS3TC",etc2:"extCompressedTextureETC",etc1:"extCompressedTextureETC1",basis:"canvas"},um=["pvr","dxt","etc2","etc1","basis"];class fm extends Ht{set name(e){if(this._name!==e){var t=this._name;this._name=e,this.fire("name",this,this._name,t)}}get name(){return this._name}set file(e){if(e&&e.variants&&-1!==["texture","textureatlas","bundle"].indexOf(this.type)){var t,i,s=(null==(i=this.registry)||null==(t=i._loader)?void 0:t._app)||Kp(),r=null==s?void 0:s.graphicsDevice;if(r)for(var n,a=function(t,i){var a=um[t];if(e.variants[a]&&r[dm[a]])return e=e.variants[a],"break";if(s.enableBundles){var o=s.bundles.listBundlesForAsset(n);if(o&&o.find((e=>{var t;return null==e||null==(t=e.file)?void 0:t.variants[a]})))return"break"}},o=0,l=um.length;o<l;o++){if("break"===(n=this,a(o)))break}}var h=this._file,c=e?new hm(e.url,e.filename,e.hash,e.size,e.opt,e.contents):null;(!!c!=!!h||c&&!c.equals(h))&&(this._file=c,this.fire("change",this,"file",c,h),this.reload())}get file(){return this._file}set data(e){var t=this._data;this._data=e,e!==t&&(this.fire("change",this,"data",e,t),this.loaded&&this.registry._loader.patch(this,this.registry))}get data(){return this._data}set resource(e){var t=this._resources[0];this._resources[0]=e,this.fire("change",this,"resource",e,t)}get resource(){return this._resources[0]}set resources(e){var t=this._resources;this._resources=e,this.fire("change",this,"resources",e,t)}get resources(){return this._resources}set preload(e){e=!!e,this._preload!==e&&(this._preload=e,this._preload&&!this.loaded&&!this.loading&&this.registry&&this.registry.load(this))}get preload(){return this._preload}set loadFaces(e){e=!!e,this.hasOwnProperty("_loadFaces")&&e===this._loadFaces||(this._loadFaces=e,this.loaded&&this.registry._loader.patch(this,this.registry))}get loadFaces(){return this._loadFaces}getFileUrl(){var e=this.file;if(!e||!e.url)return null;var t=e.url;if(this.registry&&this.registry.prefix&&!lm.test(t)&&(t=this.registry.prefix+t),"script"!==this.type&&e.hash){var i=-1!==t.indexOf("?")?"&":"?";t+=i+"t="+e.hash}return t}getAbsoluteUrl(e){if(e.startsWith("blob:")||e.startsWith("data:"))return e;var t=kt.getDirectory(this.file.url);return kt.join(t,e)}getLocalizedAssetId(e){return e=nm(e,this._i18n),this._i18n[e]||null}addLocalizedAssetId(e,t){this._i18n[e]=t,this.fire("add:localized",e,t)}removeLocalizedAssetId(e){var t=this._i18n[e];t&&(delete this._i18n[e],this.fire("remove:localized",e,t))}ready(e,t){t=t||this,this.loaded?e.call(t,this):this.once("load",(i=>{e.call(t,i)}))}reload(){this.loaded&&(this.loaded=!1,this.registry.load(this))}unload(){if(this.loaded||0!==this._resources.length){this.fire("unload",this),this.registry.fire("unload:"+this.id,this);var e=this._resources;this.urlObject&&(URL.revokeObjectURL(this.urlObject),this.urlObject=null),this.resources=[],this.loaded=!1,this.file&&this.registry._loader.clearCache(this.getFileUrl(),this.type);for(var t=0;t<e.length;++t){var i=e[t];i&&i.destroy&&i.destroy()}}}static fetchArrayBuffer(e,t,i,s){var r;void 0===s&&(s=0),(null==i||null==(r=i.file)?void 0:r.contents)?setTimeout((()=>{t(null,i.file.contents)})):il.get(e,{cache:!0,responseType:"arraybuffer",retry:s>0,maxRetries:s},t)}constructor(e,t,i,s={},r={}){super(),this._file=null,this._i18n={},this._preload=!1,this._resources=[],this.id=cm--,this.loaded=!1,this.loading=!1,this.options={},this.registry=null,this.tags=new Qt(this),this.urlObject=null,this._name=e||"",this.type=t,this._data=s||{},this.options=r||{},i&&(this.file=i)}}fm.EVENT_LOAD="load",fm.EVENT_UNLOAD="unload",fm.EVENT_REMOVE="remove",fm.EVENT_ERROR="error",fm.EVENT_CHANGE="change",fm.EVENT_PROGRESS="progress",fm.EVENT_ADDLOCALIZED="add:localized",fm.EVENT_REMOVELOCALIZED="remove:localized";class pm{addItem(e){var t=e.tags._list;for(var i of t)this.add(i,e)}removeItem(e){var t=e.tags._list;for(var i of t)this.remove(i,e)}add(e,t){this._index[e]&&-1!==this._index[e].list.indexOf(t)||(this._index[e]||(this._index[e]={list:[]},this._key&&(this._index[e].keys={})),this._index[e].list.push(t),this._key&&(this._index[e].keys[t[this._key]]=t))}remove(e,t){if(this._index[e]&&(!this._key||this._index[e].keys[t[this._key]])){var i=this._index[e].list.indexOf(t);-1!==i&&(this._index[e].list.splice(i,1),this._key&&delete this._index[e].keys[t[this._key]],0===this._index[e].list.length&&delete this._index[e])}}find(e){for(var t,i,s,r,n,a={},o=[],l=(e,t)=>this._index[e].list.length-this._index[t].list.length,h=0;h<e.length;h++){if((i=e[h])instanceof Array){if(0===i.length)continue;if(1!==i.length){n=!1;for(var c=0;c<i.length;c++)if(!this._index[i[c]]){n=!0;break}if(n)continue;1===(r=(s=i.slice(0).sort(l)).slice(1)).length&&(r=r[0]);for(var d=0;d<this._index[s[0]].list.length;d++)t=this._index[s[0]].list[d],(this._key?!a[t[this._key]]:-1===o.indexOf(t))&&t.tags.has(r)&&(this._key&&(a[t[this._key]]=!0),o.push(t));continue}i=i[0]}if(i&&"string"==typeof i&&this._index[i])for(var u=0;u<this._index[i].list.length;u++)t=this._index[i].list[u],this._key?a[t[this._key]]||(a[t[this._key]]=!0,o.push(t)):-1===o.indexOf(t)&&o.push(t)}return o}constructor(e=null){this._index={},this._key=e}}class mm extends Ht{list(e){void 0===e&&(e={});var t=Array.from(this._assets);return void 0!==e.preload?t.filter((t=>t.preload===e.preload)):t}add(e){var t,i;this._assets.has(e)||(this._assets.add(e),this._idToAsset.set(e.id,e),(null==(t=e.file)?void 0:t.url)&&this._urlToAsset.set(e.file.url,e),this._nameToAsset.has(e.name)||this._nameToAsset.set(e.name,new Set),this._nameToAsset.get(e.name).add(e),e.on("name",this._onNameChange,this),e.registry=this,this._tags.addItem(e),e.tags.on("add",this._onTagAdd,this),e.tags.on("remove",this._onTagRemove,this),this.fire("add",e),this.fire("add:"+e.id,e),(null==(i=e.file)?void 0:i.url)&&this.fire("add:url:"+e.file.url,e),e.preload&&this.load(e))}remove(e){var t,i;if(!this._assets.has(e))return!1;if(this._assets.delete(e),this._idToAsset.delete(e.id),(null==(t=e.file)?void 0:t.url)&&this._urlToAsset.delete(e.file.url),e.off("name",this._onNameChange,this),this._nameToAsset.has(e.name)){var s=this._nameToAsset.get(e.name);s.delete(e),0===s.size&&this._nameToAsset.delete(e.name)}return this._tags.removeItem(e),e.tags.off("add",this._onTagAdd,this),e.tags.off("remove",this._onTagRemove,this),e.fire("remove",e),this.fire("remove",e),this.fire("remove:"+e.id,e),(null==(i=e.file)?void 0:i.url)&&this.fire("remove:url:"+e.file.url,e),!0}get(e){return this._idToAsset.get(Number(e))}getByUrl(e){return this._urlToAsset.get(e)}load(e,t){if(!e.loading&&!e.loaded||(null==t?void 0:t.force)){var i=e.file,s=()=>{this.fire("load",e),this.fire("load:"+e.id,e),i&&i.url&&this.fire("load:url:"+i.url,e),e.fire("load",e)},r=t=>{if(t instanceof Array?e.resources=t:e.resource=t,this._loader.patch(e,this),"bundle"===e.type){for(var r=e.data.assets,n=0;n<r.length;n++){var a=this._idToAsset.get(r[n]);a&&!a.loaded&&this.load(a,{force:!0})}e.resource.loaded?s():(this.fire("load:start",e),this.fire("load:start:"+e.id,e),i&&i.url&&this.fire("load:start:url:"+i.url,e),e.fire("load:start",e),e.resource.on("load",s))}else s()};if(i||"cubemap"===e.type){this.fire("load:start",e),this.fire("load:"+e.id+":start",e),e.loading=!0;var n=e.getFileUrl();if("bundle"===e.type)for(var a=e.data.assets,o=0;o<a.length;o++){var l=this._idToAsset.get(a[o]);l&&(l.loaded||l.resource||l.loading||(l.loading=!0))}this._loader.load(n,e.type,((t,i,s)=>{if(e.loaded=!0,e.loading=!1,t)this.fire("error",t,e),this.fire("error:"+e.id,t,e),e.fire("error",t,e);else{if("script"===e.type){var n=this._loader.getHandler("script");n._cache[e.id]&&n._cache[e.id].parentNode===document.head&&document.head.removeChild(n._cache[e.id]),n._cache[e.id]=s}r(i)}}),e,t)}else{var h=this._loader.open(e.type,e.data);e.loaded=!0,r(h)}}}loadFromUrl(e,t,i){this.loadFromUrlAndFilename(e,null,t,i)}loadFromUrlAndFilename(e,t,i,s){var r=kt.getBasename(t||e),n={filename:t||r,url:e},a=this.getByUrl(e);if(a){if(a.loaded)return void s(a.loadFromUrlError||null,a)}else a=new fm(r,i,n),this.add(a);var o=e=>{e.once("load",(e=>{"material"===i?this._loadTextures(e,((t,i)=>{s(t,e)})):s(null,e)})),e.once("error",(t=>{t&&(this.loadFromUrlError=t),s(t,e)})),this.load(e)};a.resource?s(null,a):"model"===i?this._loadModel(a,o):o(a)}_loadModel(e,t){var i=e.getFileUrl(),s=kt.getExtension(i);if(".json"===s||".glb"===s){var r=kt.getDirectory(i),n=kt.getBasename(i),a=kt.join(r,n.replace(s,".mapping.json"));this._loader.load(a,"json",((i,s)=>{i?(e.data={mapping:[]},t(e)):this._loadMaterials(e,s,((i,r)=>{e.data=s,t(e)}))}))}else t(e)}_loadMaterials(e,t,i){for(var s=[],r=0,n=(e,t)=>{this._loadTextures(t,((e,n)=>{s.push(t),s.length===r&&i(null,s)}))},a=0;a<t.mapping.length;a++){var o=t.mapping[a].path;if(o){r++;var l=e.getAbsoluteUrl(o);this.loadFromUrl(l,"material",n)}}0===r&&i(null,s)}_loadTextures(e,t){var i=[],s=0,r=e.data;if("path"===r.mappingFormat){for(var n=(e,r)=>{e&&console.error(e),i.push(r),i.length===s&&t(null,i)},a=Yf,o=0;o<a.length;o++){var l=r[a[o]];if(l&&"string"==typeof l){s++;var h=e.getAbsoluteUrl(l);this.loadFromUrl(h,"texture",n)}}0===s&&t(null,i)}else t(null,i)}_onTagAdd(e,t){this._tags.add(e,t)}_onTagRemove(e,t){this._tags.remove(e,t)}_onNameChange(e,t,i){if(this._nameToAsset.has(i)){var s=this._nameToAsset.get(i);s.delete(e),0===s.size&&this._nameToAsset.delete(i)}this._nameToAsset.has(e.name)||this._nameToAsset.set(e.name,new Set),this._nameToAsset.get(e.name).add(e)}findByTag(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return this._tags.find(t)}filter(e){return Array.from(this._assets).filter((t=>e(t)))}find(e,t){var i=this._nameToAsset.get(e);if(!i)return null;for(var s of i)if(!t||s.type===t)return s;return null}findAll(e,t){var i=this._nameToAsset.get(e);if(!i)return[];var s=Array.from(i);return t?s.filter((e=>e.type===t)):s}constructor(e){super(),this._assets=new Set,this._idToAsset=new Map,this._urlToAsset=new Map,this._nameToAsset=new Map,this._tags=new pm("_id"),this.prefix=null,this.bundles=null,this._loader=e}}mm.EVENT_LOAD="load",mm.EVENT_ADD="add",mm.EVENT_REMOVE="remove",mm.EVENT_ERROR="error";class gm{_onAssetAdd(e){if("bundle"===e.type){this._idToBundle.set(e.id,e),this._assets.on("load:start:"+e.id,this._onBundleLoadStart,this),this._assets.on("load:"+e.id,this._onBundleLoad,this),this._assets.on("error:"+e.id,this._onBundleError,this);for(var t=e.data.assets,i=0;i<t.length;i++)this._indexAssetInBundle(t[i],e)}else this._assetToBundles.has(e.id)&&this._indexAssetFileUrls(e)}_unbindAssetEvents(e){this._assets.off("load:start:"+e,this._onBundleLoadStart,this),this._assets.off("load:"+e,this._onBundleLoad,this),this._assets.off("error:"+e,this._onBundleError,this)}_indexAssetInBundle(e,t){var i=this._assetToBundles.get(e);i||(i=new Set,this._assetToBundles.set(e,i)),i.add(t);var s=this._assets.get(e);s&&this._indexAssetFileUrls(s)}_indexAssetFileUrls(e){var t=this._getAssetFileUrls(e);if(t)for(var i=0;i<t.length;i++){var s=this._assetToBundles.get(e.id);s&&this._urlsToBundles.set(t[i],s)}}_getAssetFileUrls(e){var t=e.getFileUrl();if(!t)return null;var i=[t=t.split("?")[0]];if("font"===e.type)for(var s=e.data.info.maps.length,r=1;r<s;r++)i.push(t.replace(".png",r+".png"));return i}_onAssetRemove(e){if("bundle"===e.type){this._idToBundle.delete(e.id),this._unbindAssetEvents(e.id);for(var t=e.data.assets,i=0;i<t.length;i++){var s=this._assetToBundles.get(t[i]);if(s&&(s.delete(e),0===s.size))for(var[r,n]of(this._assetToBundles.delete(t[i]),this._urlsToBundles))n===s&&this._urlsToBundles.delete(r)}this._onBundleError("Bundle "+e.id+" was removed")}else{if(!this._assetToBundles.get(e.id))return;this._assetToBundles.delete(e.id);var a=this._getAssetFileUrls(e);if(!a)return;for(var o=0;o<a.length;o++)this._urlsToBundles.delete(a[o])}}_onBundleLoadStart(e){e.resource.on("add",((e,t)=>{var i=this._fileRequests.get(e);if(i){for(var s=0;s<i.length;s++)i[s](null,t);this._fileRequests.delete(e)}}))}_onBundleLoad(e){if(e.resource){if(this._fileRequests)for(var[t,i]of this._fileRequests){var s=this._urlsToBundles.get(t);if(s&&s.has(e)){var r=decodeURIComponent(t),n=void 0,a=void 0;if(e.resource.has(r))a=e.resource.get(r);else{if(!e.resource.loaded)continue;n="Bundle "+e.id+" does not contain URL "+t}for(var o=0;o<i.length;o++)i[o](n,n||a);this._fileRequests.delete(t)}}}else this._onBundleError("Bundle "+e.id+" failed to load")}_onBundleError(e){for(var[t,i]of this._fileRequests){if(!this._findLoadedOrLoadingBundleForUrl(t)){for(var s=0;s<i.length;s++)i[s](e);this._fileRequests.delete(t)}}}_findLoadedOrLoadingBundleForUrl(e){var t=this._urlsToBundles.get(e);if(!t)return null;var i=null;for(var s of t){if(s.loaded&&s.resource)return s;s.loading&&(i=s)}return i}listBundlesForAsset(e){var t=this._assetToBundles.get(e.id);return t?Array.from(t):null}list(){return Array.from(this._idToBundle.values())}hasUrl(e){return this._urlsToBundles.has(e)}urlIsLoadedOrLoading(e){return!!this._findLoadedOrLoadingBundleForUrl(e)}loadUrl(e,t){var i=this._findLoadedOrLoadingBundleForUrl(e);if(i){if(i.loaded){var s=decodeURIComponent(e);if(i.resource.has(s))return void t(null,i.resource.get(s));if(i.resource.loaded)return void t("Bundle "+i.id+" does not contain URL "+e)}var r=this._fileRequests.get(e);r||(r=[],this._fileRequests.set(e,r)),r.push(t)}else t("URL "+e+" not found in any bundles")}destroy(){for(var e of(this._assets.off("add",this._onAssetAdd,this),this._assets.off("remove",this._onAssetRemove,this),this._idToBundle.keys()))this._unbindAssetEvents(e);this._assets=null,this._idToBundle.clear(),this._idToBundle=null,this._assetToBundles.clear(),this._assetToBundles=null,this._urlsToBundles.clear(),this._urlsToBundles=null,this._fileRequests.clear(),this._fileRequests=null}constructor(e){this._idToBundle=new Map,this._assetToBundles=new Map,this._urlsToBundles=new Map,this._fileRequests=new Map,this._assets=e,this._assets.bundles=this,this._assets.on("add",this._onAssetAdd,this),this._assets.on("remove",this._onAssetRemove,this)}}class vm extends Ht{add(e){var t=e.id;if(this[t])throw new Error("ComponentSystem name '"+t+"' already registered or not allowed");this[t]=e,this.list.push(e)}remove(e){var t=e.id;if(!this[t])throw new Error("No ComponentSystem named '"+t+"' registered");delete this[t];var i=this.list.indexOf(this[t]);-1!==i&&this.list.splice(i,1)}destroy(){this.off();for(var e=0;e<this.list.length;e++)this.list[e].destroy()}constructor(){super(),this.list=[]}}class _m extends Ht{addFile(e,t){this._index.has(e)||(this._index.set(e,t),this.fire("add",e,t))}has(e){return this._index.has(e)}get(e){return this._index.get(e)||null}destroy(){this._index.clear()}set loaded(e){e&&!this._loaded&&(this._loaded=!0,this.fire("load"))}get loaded(){return this._loaded}constructor(...e){super(...e),this._index=new Map,this._loaded=!1}}_m.EVENT_ADD="add",_m.EVENT_LOAD="load";class bm extends Ht{pump(e,t){if(e)return this.fire("done"),null;this.bytesReceived+=t.byteLength;var i=new Uint8Array(this.data.length+t.length);for(i.set(this.data),i.set(t,this.data.length),this.data=i;this.readFile(););return this.reader.read().then((e=>{this.pump(e.done,e.value)})).catch((e=>{this.fire("error",e)}))}readFile(){if(!this.headerRead&&this.bytesReceived>this.bytesRead+this.headerSize){this.headerRead=!0;var e=new DataView(this.data.buffer,this.bytesRead,this.headerSize);null!=this.decoder||(this.decoder=new TextDecoder("windows-1252"));var t=this.decoder.decode(e);if(this.fileName=t.substring(0,100).replace(/\0/g,""),this.fileSize=parseInt(t.substring(124,136),8),this.fileType=t.substring(156,157),this.ustarFormat=t.substring(257,263),-1!==this.ustarFormat.indexOf("ustar")){var i=t.substring(345,500).replace(/\0/g,"");i.length>0&&(this.fileName=i.trim()+this.fileName.trim())}this.bytesRead+=512}if(this.headerRead){if(this.bytesReceived<this.bytesRead+this.fileSize)return!1;if(""===this.fileType||"0"===this.fileType){var s=new DataView(this.data.buffer,this.bytesRead,this.fileSize),r={name:this.prefix+this.fileName,size:this.fileSize,data:s};this.fire("file",r)}this.bytesRead+=this.fileSize,this.headerRead=!1;var n=this.bytesRead%this.paddingSize;return 0!==n&&(this.bytesRead+=this.paddingSize-n),!0}return!1}constructor(e,t=""){super(),this.headerSize=512,this.paddingSize=512,this.bytesRead=0,this.bytesReceived=0,this.headerRead=!1,this.reader=null,this.data=new Uint8Array(0),this.decoder=null,this.prefix="",this.fileName="",this.fileSize=0,this.fileType="",this.ustarFormat="",this.prefix=t||"",this.reader=e.body.getReader(),this.reader.read().then((e=>{this.pump(e.done,e.value)})).catch((e=>{this.fire("error",e)}))}}class ym{set maxRetries(e){this._maxRetries=e}get maxRetries(){return this._maxRetries}load(e,t,i){}open(e,t,i){return t}patch(e,t){}constructor(e,t){this.handlerType="",this._maxRetries=0,this._app=e,this.handlerType=t}}class xm extends ym{_fetchRetries(e,t,i){return void 0===i&&(i=0),new Promise(((s,r)=>{var n=()=>{fetch(e,t).then(s).catch((e=>{++i<this.maxRetries?n():r(e)}))};n()}))}load(e,t){"string"==typeof e&&(e={load:e,original:e}),this._fetchRetries(e.load,{mode:"cors",credentials:"include"},this.maxRetries).then((e=>{var i=new _m;t(null,i);var s=new bm(e,this._assets.prefix);s.on("file",(e=>{i.addFile(e.name,e.data)})),s.on("done",(()=>{i.loaded=!0})),s.on("error",(e=>{t(e)}))})).catch((e=>{t(e)}))}open(e,t){return t}constructor(e){super(e,"bundle"),this._assets=e.assets}}class Sm{addHandler(e,t){this._handlers[e]=t,t._loader=this}removeHandler(e){delete this._handlers[e]}getHandler(e){return this._handlers[e]}static makeKey(e,t){return e+"-"+t}load(e,t,i,s,r){var n=this._handlers[t];if(n)if(e){var a=Sm.makeKey(e,t);if(void 0!==this._cache[a])i(null,this._cache[a]);else if(this._requests[a])this._requests[a].push(i);else{this._requests[a]=[i];var o=this,l=function(e,t){if(e)o._onFailure(a,e);else{if(t.load instanceof DataView){if(n.openBinary){if(!o._requests[a])return;try{var i=n.openBinary(t.load);o._onSuccess(a,i)}catch(e){o._onFailure(a,e)}return}t.load=URL.createObjectURL(new Blob([t.load])),s&&(s.urlObject&&URL.revokeObjectURL(s.urlObject),s.urlObject=t.load)}n.load(t,((e,i,r)=>{if(o._requests[a])if(e)o._onFailure(a,e);else try{o._onSuccess(a,n.open(t.original,i,s),r)}catch(e){o._onFailure(a,e)}}),s)}},h=e.split("?")[0];if(!this._app.enableBundles||!this._app.bundles.hasUrl(h)||r&&r.bundlesIgnore)l(null,{load:e,original:s&&s.file.filename||e});else{if(!this._app.bundles.urlIsLoadedOrLoading(h)){var c,d,u=this._app.bundles.listBundlesForAsset(s);r&&r.bundlesFilter&&(d=r.bundlesFilter(u)),d||(null==u||u.sort(((e,t)=>e.file.size-t.file.size)),d=null==u?void 0:u[0]),d&&(null==(c=this._app.assets)||c.load(d))}this._app.bundles.loadUrl(h,((e,t)=>{l(e,{load:t,original:h})}))}}}else this._loadNull(n,i,s);else i("No resource handler for asset type: '"+t+"' when loading ["+e+"]")}_loadNull(e,t,i){e.load(null,(function(s,r,n){if(s)t(s);else try{t(null,e.open(null,r,i),n)}catch(e){t(e)}}),i)}_onSuccess(e,t,i){null!==t?this._cache[e]=t:delete this._cache[e];for(var s=0;s<this._requests[e].length;s++)this._requests[e][s](null,t,i);delete this._requests[e]}_onFailure(e,t){if(console.error(t),this._requests[e]){for(var i=0;i<this._requests[e].length;i++)this._requests[e][i](t);delete this._requests[e]}}open(e,t){var i=this._handlers[e];return i?i.open(null,t):(console.warn("No resource handler found for: "+e),t)}patch(e,t){var i=this._handlers[e.type];i?i.patch&&i.patch(e,t):console.warn("No resource handler found for: "+e.type)}clearCache(e,t){var i=Sm.makeKey(e,t);delete this._cache[i]}getFromCache(e,t){var i=Sm.makeKey(e,t);if(this._cache[i])return this._cache[i]}enableRetry(e){for(var t in void 0===e&&(e=5),e=Math.max(0,e)||0,this._handlers)this._handlers[t].maxRetries=e}disableRetry(){for(var e in this._handlers)this._handlers[e].maxRetries=0}destroy(){this._handlers={},this._requests={},this._cache={}}constructor(e){this._handlers={},this._requests={},this._cache={},this._app=e}}class wm{_validate(e){if(!e.header)throw new Error('pc.I18n#addData: Missing "header" field');if(!e.header.version)throw new Error('pc.I18n#addData: Missing "header.version" field');if(1!==e.header.version)throw new Error('pc.I18n#addData: Invalid "header.version" field');if(!e.data)throw new Error('pc.I18n#addData: Missing "data" field');if(!Array.isArray(e.data))throw new Error('pc.I18n#addData: "data" field must be an array');for(var t=0,i=e.data.length;t<i;t++){var s=e.data[t];if(!s.info)throw new Error('pc.I18n#addData: missing "data['+t+'].info" field');if(!s.info.locale)throw new Error('pc.I18n#addData: missing "data['+t+'].info.locale" field');if("string"!=typeof s.info.locale)throw new Error('pc.I18n#addData: "data['+t+'].info.locale" must be a string');if(!s.messages)throw new Error('pc.I18n#addData: missing "data['+t+'].messages" field')}}parse(e){return e.data}}class Tm extends Ht{set assets(e){for(var t={},i=0,s=e.length;i<s;i++){t[e[i]instanceof fm?e[i].id:e[i]]=!0}for(var r=this._assets.length;r--;){var n=this._assets[r];if(!t[n]){this._app.assets.off("add:"+n,this._onAssetAdd,this);var a=this._app.assets.get(n);a&&this._onAssetRemove(a),this._assets.splice(r,1)}}for(var o in t){var l=parseInt(o,10);if(-1===this._assets.indexOf(l)){this._assets.push(l);var h=this._app.assets.get(l);h?this._onAssetAdd(h):this._app.assets.once("add:"+l,this._onAssetAdd,this)}}}get assets(){return this._assets}set locale(e){if(this._locale!==e){var t=rm(e);if("in"!==t||(s=t="id",e=-1!==(r=(i=e).indexOf("-"))?s+i.substring(r):s,this._locale!==e)){var i,s,r,n=this._locale;this._locale=e,this._lang=t,this._pluralFn=om(this._lang),this.fire("set:locale",e,n)}}}get locale(){return this._locale}static findAvailableLocale(e,t){return nm(e,t)}findAvailableLocale(e){if(this._translations[e])return e;var t=rm(e);return this._findFallbackLocale(e,t)}getText(e,t){var i,s=e;t||(t=this._locale,i=this._lang);var r=this._translations[t];return r||(i||(i=rm(t)),t=this._findFallbackLocale(t,i),r=this._translations[t]),r&&r.hasOwnProperty(e)&&(s=r[e],Array.isArray(s)&&(s=s[0]),null==s&&(s=e)),s}getPluralText(e,t,i){var s,r,n=e;i?r=om(s=rm(i)):(i=this._locale,s=this._lang,r=this._pluralFn);var a=this._translations[i];if(a||(r=om(s=rm(i=this._findFallbackLocale(i,s))),a=this._translations[i]),a&&a[e]&&r){var o=r(t);null==(n=a[e][o])&&(n=e)}return n}addData(e){var t;try{t=this._parser.parse(e)}catch(e){return void console.error(e)}for(var i=0,s=t.length;i<s;i++){var r=t[i],n=r.info.locale,a=r.messages;if(!this._translations[n]){this._translations[n]={};var o=rm(n);this._availableLangs[o]||(this._availableLangs[o]=n)}Object.assign(this._translations[n],a),this.fire("data:add",n,a)}}removeData(e){var t;try{t=this._parser.parse(e)}catch(e){return void console.error(e)}for(var i=0,s=t.length;i<s;i++){var r=t[i],n=r.info.locale,a=this._translations[n];if(a){var o=r.messages;for(var l in o)delete a[l];0===Object.keys(a).length&&(delete this._translations[n],delete this._availableLangs[rm(n)]),this.fire("data:remove",n,o)}}}destroy(){this._translations=null,this._availableLangs=null,this._assets=null,this._parser=null,this.off()}_findFallbackLocale(e,t){var i=tm[e];return i&&this._translations[i]||(i=tm[t])&&this._translations[i]||(i=this._availableLangs[t])&&this._translations[i]?i:em}_onAssetAdd(e){e.on("load",this._onAssetLoad,this),e.on("change",this._onAssetChange,this),e.on("remove",this._onAssetRemove,this),e.on("unload",this._onAssetUnload,this),e.resource&&this._onAssetLoad(e)}_onAssetLoad(e){this.addData(e.resource)}_onAssetChange(e){e.resource&&this.addData(e.resource)}_onAssetRemove(e){e.off("load",this._onAssetLoad,this),e.off("change",this._onAssetChange,this),e.off("remove",this._onAssetRemove,this),e.off("unload",this._onAssetUnload,this),e.resource&&this.removeData(e.resource),this._app.assets.once("add:"+e.id,this._onAssetAdd,this)}_onAssetUnload(e){e.resource&&this.removeData(e.resource)}constructor(e){super(),this.locale=em,this._translations={},this._availableLangs={},this._app=e,this._assets=[],this._parser=new wm}}class Cm extends Ht{destroy(){this.app=null,this.off()}addSchema(e,t){t&&this._scriptSchemas.set(e,t)}getSchema(e){return this._scriptSchemas.get(e)}add(e){var t=e.__name;return this._scripts.hasOwnProperty(t)?(setTimeout((()=>{if(e.prototype.swap){var i=this._scripts[t],s=this._list.indexOf(i);this._list[s]=e,this._scripts[t]=e,this.fire("swap",t,e),this.fire("swap:"+t,e)}else console.warn("script registry already has '"+t+"' script, define 'swap' method for new script type to enable code hot swapping")})),!1):(this._scripts[t]=e,this._list.push(e),this.fire("add",t,e),this.fire("add:"+t,e),setTimeout((()=>{if(this._scripts.hasOwnProperty(t)&&this.app&&this.app.systems&&this.app.systems.script){var e,i=this.app.systems.script._components,s=[],r=[];for(i.loopIndex=0;i.loopIndex<i.length;i.loopIndex++){var n=i.items[i.loopIndex];if(n._scriptsIndex[t]&&n._scriptsIndex[t].awaiting){n._scriptsData&&n._scriptsData[t]&&(e=n._scriptsData[t].attributes);var a=n.create(t,{preloading:!0,ind:n._scriptsIndex[t].ind,attributes:e});for(var o of(a&&s.push(a),n.scripts))n.initializeAttributes(o)}}for(var l=0;l<s.length;l++)s[l].enabled&&(s[l]._initialized=!0,r.push(s[l]),s[l].initialize&&s[l].initialize());for(var h=0;h<r.length;h++)r[h].enabled&&!r[h]._postInitialized&&(r[h]._postInitialized=!0,r[h].postInitialize&&r[h].postInitialize())}})),!0)}remove(e){var t=e,i=e;if("string"!=typeof i?i=t.__name:t=this.get(i),this.get(i)!==t)return!1;delete this._scripts[i];var s=this._list.indexOf(t);return this._list.splice(s,1),this.fire("remove",i,t),this.fire("remove:"+i,t),!0}get(e){return this._scripts[e]||null}has(e){if("string"==typeof e)return this._scripts.hasOwnProperty(e);if(!e)return!1;var t=e.__name;return this._scripts[t]===e}list(){return this._list}constructor(e){super(),this._scripts={},this._list=[],this._scriptSchemas=new Map,this.app=e}}var Em=(e,t)=>e.constructor.order-t.constructor.order,Am=[],Pm=[],Dm=e=>{e.length=0,Pm.push(e)};class Lm extends Lc{addComponent(e,t){var i=this._app.systems[e];return i?this.c[e]?null:i.addComponent(this,t):null}removeComponent(e){var t=this._app.systems[e];t&&this.c[e]&&t.removeComponent(this)}findComponent(e){var t=this.findOne((t=>{var i;return null==(i=t.c)?void 0:i[e]}));return t&&t.c[e]}findComponents(e){return this.find((t=>{var i;return null==(i=t.c)?void 0:i[e]})).map((t=>t.c[e]))}findScript(e){var t=this.findOne((t=>{var i,s;return null==(s=t.c)||null==(i=s.script)?void 0:i.has(e)}));return null==t?void 0:t.c.script.get(e)}findScripts(e){return this.find((t=>{var i,s;return null==(s=t.c)||null==(i=s.script)?void 0:i.has(e)})).map((t=>t.c.script.get(e)))}getGuid(){return this._guid||this.setGuid(Rt.create()),this._guid}setGuid(e){var t=this._app._entityIndex;this._guid&&delete t[this._guid],this._guid=e,t[this._guid]=this}_notifyHierarchyStateChanged(e,t){var i=!1;e===this&&0===Am.length&&(i=!0),e._beingEnabled=!0,e._onHierarchyStateChanged(t),e._onHierarchyStatePostChanged&&Am.push(e);for(var s=e._children,r=0,n=s.length;r<n;r++)s[r]._enabled&&this._notifyHierarchyStateChanged(s[r],t);if(e._beingEnabled=!1,i){for(var a=0;a<Am.length;a++)Am[a]._onHierarchyStatePostChanged();Am.length=0}}_onHierarchyStateChanged(e){super._onHierarchyStateChanged(e);for(var t=this._getSortedComponents(),i=0;i<t.length;i++){var s=t[i];s.enabled&&(e?s.onEnable():s.onDisable())}Dm(t)}_onHierarchyStatePostChanged(){for(var e=this._getSortedComponents(),t=0;t<e.length;t++)e[t].onPostStateChange();Dm(e)}findByGuid(e){if(this._guid===e)return this;var t=this._app._entityIndex[e];return t&&(t===this||t.isDescendantOf(this))?t:null}destroy(){for(var e in this._destroying=!0,this.c)this.c[e].enabled=!1;for(var t in this.c)this.c[t].system.removeComponent(this);super.destroy(),this._guid&&delete this._app._entityIndex[this._guid],this._destroying=!1}clone(){var e={},t=this._cloneRecursively(e);return e[this.getGuid()]=t,Mm(this,this,t,e),t}_getSortedComponents(){var e,t=this.c,i=null!=(e=Pm.pop())?e:[],s=0;for(var r in t)if(t.hasOwnProperty(r)){var n=t[r];s|=0!==n.constructor.order,i.push(n)}return s&&i.length>1&&i.sort(Em),i}_cloneRecursively(e){var t=new this.constructor(void 0,this._app);for(var i in super._cloneInternal(t),this.c){this.c[i].system.cloneComponent(this,t)}for(var s=0;s<this._children.length;s++){var r=this._children[s];if(r instanceof Lm){var n=r._cloneRecursively(e);t.addChild(n),e[r.getGuid()]=n}}return t}constructor(e,t=Kp()){super(e),this.c={},this._destroying=!1,this._guid=null,this._template=!1,this._app=t}}function Mm(e,t,i,s){if(t instanceof Lm){var r=t.c;for(var n in r)for(var a=r[n],o=a.system.getPropertiesOfType("entity"),l=0,h=o.length;l<h;l++){var c=o[l].name,d=a[c];if(!!e.findByGuid(d)){var u=s[d].getGuid();u&&(i.c[n][c]=u)}}r.script&&i.script.resolveDuplicatedEntityReferenceProperties(r.script,s),r.render&&i.render.resolveDuplicatedEntityReferenceProperties(r.render,s),r.button&&i.button.resolveDuplicatedEntityReferenceProperties(r.button,s),r.scrollview&&i.scrollview.resolveDuplicatedEntityReferenceProperties(r.scrollview,s),r.scrollbar&&i.scrollbar.resolveDuplicatedEntityReferenceProperties(r.scrollbar,s),r.anim&&i.anim.resolveDuplicatedEntityReferenceProperties(r.anim,s);for(var f=t.children.filter((e=>e instanceof Lm)),p=i.children.filter((e=>e instanceof Lm)),m=0,g=f.length;m<g;m++)Mm(e,f[m],p[m],s)}}Lm.EVENT_DESTROY="destroy";class Im{get loaded(){return!!this.data}get loading(){return this._loading}constructor(e,t){this.data=null,this._loading=!1,this._onLoadedCallbacks=[],this.name=e,this.url=t}}class Rm{destroy(){this._app=null}list(){return this._list}add(e,t){if(this._index.hasOwnProperty(e))return!1;var i=new Im(e,t),s=this._list.push(i);return this._index[i.name]=s-1,this._urlIndex[i.url]=s-1,!0}find(e){return this._index.hasOwnProperty(e)?this._list[this._index[e]]:null}findByUrl(e){return this._urlIndex.hasOwnProperty(e)?this._list[this._urlIndex[e]]:null}remove(e){if(this._index.hasOwnProperty(e)){var t=this._index[e],i=this._list[t];delete this._urlIndex[i.url],delete this._index[e],this._list.splice(t,1);for(var s=0;s<this._list.length;s++)i=this._list[s],this._index[i.name]=s,this._urlIndex[i.url]=s}}_loadSceneData(e,t,i){var s=this._app,r=e;if("string"==typeof e&&(e=this.findByUrl(r)||this.find(r)||new Im("Untitled",r)),r=e.url)if(e.loaded)i(null,e);else{if(s.assets&&s.assets.prefix&&!lm.test(r)&&(r=kt.join(s.assets.prefix,r)),e._onLoadedCallbacks.push(i),!e._loading)s.loader.getHandler("hierarchy").load(r,((i,s)=>{e.data=s,e._loading=!1;for(var r=0;r<e._onLoadedCallbacks.length;r++)e._onLoadedCallbacks[r](i,e);t||(e.data=null),e._onLoadedCallbacks.length=0}));e._loading=!0}else i("Cannot find scene to load")}loadSceneData(e,t){this._loadSceneData(e,!0,t)}unloadSceneData(e){"string"==typeof e&&(e=this.findByUrl(e)),e&&(e.data=null)}_loadSceneHierarchy(e,t,i){this._loadSceneData(e,!1,((e,s)=>{if(e)i&&i(e);else{t&&t(s);var r=this._app;r._preloadScripts(s.data,(()=>{var e=r.loader.getHandler("hierarchy");r.systems.script.preloading=!0;var t=e.open(s.url,s.data);r.systems.script.preloading=!1,r.loader.clearCache(s.url,"hierarchy"),r.root.addChild(t),r.systems.fire("initialize",t),r.systems.fire("postInitialize",t),r.systems.fire("postPostInitialize",t),i&&i(null,t)}))}}))}loadSceneHierarchy(e,t){this._loadSceneHierarchy(e,null,t)}loadSceneSettings(e,t){this._loadSceneData(e,!1,((e,i)=>{e?t&&t(e):(this._app.applySceneSettings(i.data.settings),t&&t(null))}))}changeScene(e,t){var i=this._app;this._loadSceneHierarchy(e,(e=>{for(var{children:t}=i.root;t.length;)t[0].destroy();i.applySceneSettings(e.data.settings)}),t)}loadScene(e,t){var i=this._app,s=i.loader.getHandler("scene");i.assets&&i.assets.prefix&&!lm.test(e)&&(e=kt.join(i.assets.prefix,e)),s.load(e,((r,n)=>{if(r)t&&t(r);else{i._preloadScripts(n,(()=>{i.systems.script.preloading=!0;var r=s.open(e,n),a=this.findByUrl(e);a&&!a.loaded&&(a.data=n),i.systems.script.preloading=!1,i.loader.clearCache(e,"scene"),i.loader.patch({resource:r,type:"scene"},i.assets),i.root.addChild(r.root),i.systems.rigidbody&&"undefined"!=typeof Ammo&&i.systems.rigidbody.gravity.set(r._gravity.x,r._gravity.y,r._gravity.z),t&&t(null,r)}))}}))}constructor(e){this._list=[],this._index={},this._urlIndex={},this._app=e}}class km{get scene(){return Kp().scene._stats}get lightmapper(){var e;return null==(e=Kp().lightmapper)?void 0:e.stats}get batcher(){var e=Kp()._batcher;return e?e._stats:null}constructor(e){this.frame={fps:0,ms:0,dt:0,updateStart:0,updateTime:0,renderStart:0,renderTime:0,physicsStart:0,physicsTime:0,cullTime:0,sortTime:0,skinTime:0,morphTime:0,instancingTime:0,triangles:0,otherPrimitives:0,shaders:0,materials:0,cameras:0,shadowMapUpdates:0,shadowMapTime:0,depthMapTime:0,forwardTime:0,lightClustersTime:0,lightClusters:0,_timeToCountFrames:0,_fpsAccum:0},this.drawCalls={forward:0,depth:0,shadow:0,immediate:0,misc:0,total:0,skinned:0,instanced:0,removedByInstancing:0},this.misc={renderTargetCreationTime:0},this.particles={updatesPerFrame:0,_updatesPerFrame:0,frameTime:0,_frameTime:0},this.shaders=e._shaderStats,this.vram=e._vram,Object.defineProperty(this.vram,"totalUsed",{get:function(){return this.tex+this.vb+this.ib}}),Object.defineProperty(this.vram,"geom",{get:function(){return this.vb+this.ib}})}}class Om extends Ht{init(e){var{assetPrefix:t,batchManager:i,componentSystems:s,elementInput:r,gamepads:n,graphicsDevice:a,keyboard:o,lightmapper:l,mouse:h,resourceHandlers:c,scriptsOrder:d,scriptPrefix:u,soundManager:f,touch:p,xr:m}=e;this.graphicsDevice=a,this._initDefaultMaterial(),this._initProgramLibrary(),this.stats=new km(a),this._soundManager=f,this.scene=new Mf(a),this._registerSceneImmediate(this.scene),this.assets=new mm(this.loader),t&&(this.assets.prefix=t),this.bundles=new gm(this.assets),this.scriptsOrder=d||[],this.defaultLayerWorld=new yu({name:"World",id:0}),this.defaultLayerDepth=new yu({name:"Depth",id:1,enabled:!1,opaqueSortMode:0}),this.defaultLayerSkybox=new yu({name:"Skybox",id:2,opaqueSortMode:0}),this.defaultLayerUi=new yu({name:"UI",id:4,transparentSortMode:1}),this.defaultLayerImmediate=new yu({name:"Immediate",id:3,opaqueSortMode:0});var g=new wu("default");g.pushOpaque(this.defaultLayerWorld),g.pushOpaque(this.defaultLayerDepth),g.pushOpaque(this.defaultLayerSkybox),g.pushTransparent(this.defaultLayerWorld),g.pushOpaque(this.defaultLayerImmediate),g.pushTransparent(this.defaultLayerImmediate),g.pushTransparent(this.defaultLayerUi),this.scene.layers=g,Zp.createPlaceholder(a),this.renderer=new pu(a),this.renderer.scene=this.scene,l&&(this.lightmapper=new l(a,this.root,this.scene,this.renderer,this.assets),this.once("prerender",this._firstBake,this)),i&&(this._batcher=new i(a,this.root,this.scene),this.once("prerender",this._firstBatch,this)),this.keyboard=o||null,this.mouse=h||null,this.touch=p||null,this.gamepads=n||null,r&&(this.elementInput=r,this.elementInput.app=this),this.xr=m?new m(this):null,this.elementInput&&this.elementInput.attachSelectEvents(),this._scriptPrefix=u||"",this.enableBundles&&this.loader.addHandler("bundle",new xm(this)),c.forEach((e=>{var t=new e(this);this.loader.addHandler(t.handlerType,t)})),s.forEach((e=>{this.systems.add(new e(this))})),this._visibilityChangeHandler=this.onVisibilityChange.bind(this),"undefined"!=typeof document&&(void 0!==document.hidden?(this._hiddenAttr="hidden",document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.mozHidden?(this._hiddenAttr="mozHidden",document.addEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.msHidden?(this._hiddenAttr="msHidden",document.addEventListener("msvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.webkitHidden&&(this._hiddenAttr="webkitHidden",document.addEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1))),this.tick=Bm(this)}static getApplication(e){return e?Om._applications[e]:Kp()}_initDefaultMaterial(){var e=new sp;e.name="Default Material",function(e,t){Wh.get(e,(()=>t))}(this.graphicsDevice,e)}_initProgramLibrary(){var e=new Sp(this.graphicsDevice,new sp);!function(e,t){bh.get(e,(()=>t))}(this.graphicsDevice,e)}get soundManager(){return this._soundManager}get batcher(){return this._batcher}get fillMode(){return this._fillMode}get resolutionMode(){return this._resolutionMode}configure(e,t){il.get(e,((e,i)=>{if(e)t(e);else{var s=i.application_properties,r=i.scenes,n=i.assets;this._parseApplicationProperties(s,(e=>{this._parseScenes(r),this._parseAssets(n),t(e||null)}))}}))}preload(e){this.fire("preload:start");var t=this.assets.list({preload:!0});if(0===t.length)return this.fire("preload:end"),void e();var i=0,s=()=>{i++,this.fire("preload:progress",i/t.length),i===t.length&&(this.fire("preload:end"),e())};t.forEach((e=>{e.loaded?s():(e.once("load",s),e.once("error",s),this.assets.load(e))}))}_preloadScripts(e,t){t()}_parseApplicationProperties(e,t){if("number"==typeof e.maxAssetRetries&&e.maxAssetRetries>0&&this.loader.enableRetry(e.maxAssetRetries),e.useDevicePixelRatio||(e.useDevicePixelRatio=e.use_device_pixel_ratio),e.resolutionMode||(e.resolutionMode=e.resolution_mode),e.fillMode||(e.fillMode=e.fill_mode),this._width=e.width,this._height=e.height,e.useDevicePixelRatio&&(this.graphicsDevice.maxPixelRatio=window.devicePixelRatio),this.setCanvasResolution(e.resolutionMode,this._width,this._height),this.setCanvasFillMode(e.fillMode,this._width,this._height),e.layers&&e.layerOrder){var i=new wu("application"),s={};for(var r in e.layers){var n=e.layers[r];n.id=parseInt(r,10),n.enabled=1!==n.id,s[r]=new yu(n)}for(var a=0,o=e.layerOrder.length;a<o;a++){var l=e.layerOrder[a],h=s[l.layer];h&&(l.transparent?i.pushTransparent(h):i.pushOpaque(h),i.subLayerEnabled[a]=l.enabled)}this.scene.layers=i}if(e.batchGroups){var c=this.batcher;if(c)for(var d=0,u=e.batchGroups.length;d<u;d++){var f=e.batchGroups[d];c.addGroup(f.name,f.dynamic,f.maxAabbSize,f.id,f.layers)}}e.i18nAssets&&(this.i18n.assets=e.i18nAssets),this._loadLibraries(e.libraries,t)}_loadLibraries(e,t){var i=e.length,s=i,r=/^https?:\/\//;if(i)for(var n=(e,i)=>{s--,e?t(e):0===s&&(this.onLibrariesLoaded(),t(null))},a=0;a<i;++a){var o=e[a];!r.test(o.toLowerCase())&&this._scriptPrefix&&(o=kt.join(this._scriptPrefix,o)),this.loader.load(o,"script",n)}else this.onLibrariesLoaded(),t(null)}_parseScenes(e){if(e)for(var t=0;t<e.length;t++)this.scenes.add(e[t].name,e[t].url)}_parseAssets(e){for(var t=[],i={},s={},r=0;r<this.scriptsOrder.length;r++){var n=this.scriptsOrder[r];e[n]&&(i[n]=!0,t.push(e[n]))}if(this.enableBundles)for(var a in e)"bundle"===e[a].type&&(s[a]=!0,t.push(e[a]));for(var o in e)i[o]||s[o]||t.push(e[o]);for(var l=0;l<t.length;l++){var h=t[l],c=new fm(h.name,h.type,h.file,h.data);if(c.id=parseInt(h.id,10),c.preload=!!h.preload&&h.preload,c.loaded="script"===h.type&&h.data&&h.data.loadingType>0,c.tags.add(h.tags),h.i18n)for(var d in h.i18n)c.addLocalizedAssetId(d,h.i18n[d]);this.assets.add(c)}}start(){this.frame=0,this.fire("start",{timestamp:Jt(),target:this}),this._librariesLoaded||this.onLibrariesLoaded(),this.systems.fire("initialize",this.root),this.fire("initialize"),this.systems.fire("postInitialize",this.root),this.systems.fire("postPostInitialize",this.root),this.fire("postinitialize"),this.tick()}inputUpdate(e){this.controller&&this.controller.update(e),this.mouse&&this.mouse.update(),this.keyboard&&this.keyboard.update(),this.gamepads&&this.gamepads.update()}update(e){this.frame++,this.graphicsDevice.updateClientRect(),this.systems.fire(this._inTools?"toolsUpdate":"update",e),this.systems.fire("animationUpdate",e),this.systems.fire("postUpdate",e),this.fire("update",e),this.inputUpdate(e)}frameStart(){this.graphicsDevice.frameStart()}frameEnd(){this.graphicsDevice.frameEnd()}render(){this.fire("prerender"),this.root.syncHierarchy(),this._batcher&&this._batcher.updateAll(),this.renderComposition(this.scene.layers),this.fire("postrender")}renderComposition(e){this.renderer.update(e),this.renderer.buildFrameGraph(this.frameGraph,e),this.frameGraph.render(this.graphicsDevice)}_fillFrameStatsBasic(e,t,i){var s=this.stats.frame;s.dt=t,s.ms=i,e>s._timeToCountFrames?(s.fps=s._fpsAccum,s._fpsAccum=0,s._timeToCountFrames=e+1e3):s._fpsAccum++,this.stats.drawCalls.total=this.graphicsDevice._drawCallsPerFrame,this.graphicsDevice._drawCallsPerFrame=0}_fillFrameStats(){var e=this.stats.frame;e.cameras=this.renderer._camerasRendered,e.materials=this.renderer._materialSwitches,e.shaders=this.graphicsDevice._shaderSwitchesPerFrame,e.shadowMapUpdates=this.renderer._shadowMapUpdates,e.shadowMapTime=this.renderer._shadowMapTime,e.depthMapTime=this.renderer._depthMapTime,e.forwardTime=this.renderer._forwardTime;var t=this.graphicsDevice._primsPerFrame;e.triangles=t[4]/3+Math.max(t[5]-2,0)+Math.max(t[6]-2,0),e.cullTime=this.renderer._cullTime,e.sortTime=this.renderer._sortTime,e.skinTime=this.renderer._skinTime,e.morphTime=this.renderer._morphTime,e.lightClusters=this.renderer._lightClusters,e.lightClustersTime=this.renderer._lightClustersTime,e.otherPrimitives=0;for(var i=0;i<t.length;i++)i<4&&(e.otherPrimitives+=t[i]),t[i]=0;this.renderer._camerasRendered=0,this.renderer._materialSwitches=0,this.renderer._shadowMapUpdates=0,this.graphicsDevice._shaderSwitchesPerFrame=0,this.renderer._cullTime=0,this.renderer._layerCompositionUpdateTime=0,this.renderer._lightClustersTime=0,this.renderer._sortTime=0,this.renderer._skinTime=0,this.renderer._morphTime=0,this.renderer._shadowMapTime=0,this.renderer._depthMapTime=0,this.renderer._forwardTime=0,(e=this.stats.drawCalls).forward=this.renderer._forwardDrawCalls,e.culled=this.renderer._numDrawCallsCulled,e.depth=0,e.shadow=this.renderer._shadowDrawCalls,e.skinned=this.renderer._skinDrawCalls,e.immediate=0,e.instanced=0,e.removedByInstancing=0,e.misc=e.total-(e.forward+e.shadow),this.renderer._depthDrawCalls=0,this.renderer._shadowDrawCalls=0,this.renderer._forwardDrawCalls=0,this.renderer._numDrawCallsCulled=0,this.renderer._skinDrawCalls=0,this.renderer._immediateRendered=0,this.renderer._instancedDrawCalls=0,this.stats.misc.renderTargetCreationTime=this.graphicsDevice.renderTargetCreationTime,(e=this.stats.particles).updatesPerFrame=e._updatesPerFrame,e.frameTime=e._frameTime,e._updatesPerFrame=0,e._frameTime=0}setCanvasFillMode(e,t,i){this._fillMode=e,this.resizeCanvas(t,i)}setCanvasResolution(e,t,i){this._resolutionMode=e,e===Xp&&void 0===t&&(t=this.graphicsDevice.canvas.clientWidth,i=this.graphicsDevice.canvas.clientHeight),this.graphicsDevice.resizeCanvas(t,i)}isHidden(){return document[this._hiddenAttr]}onVisibilityChange(){this.isHidden()?this._soundManager&&this._soundManager.suspend():this._soundManager&&this._soundManager.resume()}resizeCanvas(e,t){if(this._allowResize&&(!this.xr||!this.xr.session)){var i=window.innerWidth,s=window.innerHeight;if(this._fillMode===qp){var r=this.graphicsDevice.canvas.width/this.graphicsDevice.canvas.height;r>i/s?t=(e=i)/r:e=(t=s)*r}else"FILL_WINDOW"===this._fillMode&&(e=i,t=s);return this.graphicsDevice.canvas.style.width=e+"px",this.graphicsDevice.canvas.style.height=t+"px",this.updateCanvasSize(),{width:e,height:t}}}updateCanvasSize(){var e;if(this._allowResize&&!(null==(e=this.xr)?void 0:e.active)&&this._resolutionMode===Xp){var t=this.graphicsDevice.canvas;this.graphicsDevice.resizeCanvas(t.clientWidth,t.clientHeight)}}onLibrariesLoaded(){this._librariesLoaded=!0,this.systems.rigidbody&&this.systems.rigidbody.onLibraryLoaded()}applySceneSettings(e){var t;if(this.systems.rigidbody&&"undefined"!=typeof Ammo){var[i,s,r]=e.physics.gravity;this.systems.rigidbody.gravity.set(i,s,r)}this.scene.applySettings(e),e.render.hasOwnProperty("skybox")&&(e.render.skybox?(t=this.assets.get(e.render.skybox))?this.setSkybox(t):this.assets.once("add:"+e.render.skybox,this.setSkybox,this):this.setSkybox(null))}setAreaLightLuts(e,t){e&&t&&Zp.set(this.graphicsDevice,e,t)}setSkybox(e){if(e!==this._skyboxAsset){var t=()=>{this.setSkybox(null)},i=()=>{this.scene.setSkybox(this._skyboxAsset?this._skyboxAsset.resources:null)};this._skyboxAsset&&(this.assets.off("load:"+this._skyboxAsset.id,i,this),this.assets.off("remove:"+this._skyboxAsset.id,t,this),this._skyboxAsset.off("change",i,this)),this._skyboxAsset=e,this._skyboxAsset&&(this.assets.on("load:"+this._skyboxAsset.id,i,this),this.assets.once("remove:"+this._skyboxAsset.id,t,this),this._skyboxAsset.on("change",i,this),0!==this.scene.skyboxMip||this._skyboxAsset.loadFaces||(this._skyboxAsset.loadFaces=!0),this.assets.load(this._skyboxAsset)),i()}}_firstBake(){var e;null==(e=this.lightmapper)||e.bake(null,this.scene.lightmapMode)}_firstBatch(){var e;null==(e=this.batcher)||e.generate()}_processTimestamp(e){return e}drawLine(e,t,i,s,r){this.scene.drawLine(e,t,i,s,r)}drawLines(e,t,i,s){void 0===i&&(i=!0),void 0===s&&(s=this.scene.defaultDrawLayer),this.scene.drawLines(e,t,i,s)}drawLineArrays(e,t,i,s){void 0===i&&(i=!0),void 0===s&&(s=this.scene.defaultDrawLayer),this.scene.drawLineArrays(e,t,i,s)}drawWireSphere(e,t,i,s,r,n){void 0===i&&(i=ii.WHITE),void 0===s&&(s=20),void 0===r&&(r=!0),void 0===n&&(n=this.scene.defaultDrawLayer),this.scene.immediate.drawWireSphere(e,t,i,s,r,n)}drawWireAlignedBox(e,t,i,s,r,n){void 0===i&&(i=ii.WHITE),void 0===s&&(s=!0),void 0===r&&(r=this.scene.defaultDrawLayer),this.scene.immediate.drawWireAlignedBox(e,t,i,s,r,n)}drawMeshInstance(e,t){void 0===t&&(t=this.scene.defaultDrawLayer),this.scene.immediate.drawMesh(null,null,null,e,t)}drawMesh(e,t,i,s){void 0===s&&(s=this.scene.defaultDrawLayer),this.scene.immediate.drawMesh(t,i,e,null,s)}drawQuad(e,t,i){void 0===i&&(i=this.scene.defaultDrawLayer),this.scene.immediate.drawMesh(t,e,this.scene.immediate.getQuadMesh(),null,i)}drawTexture(e,t,i,s,r,n,a,o){if(void 0===a&&(a=this.scene.defaultDrawLayer),void 0===o&&(o=!0),!1!==o||this.graphicsDevice.isWebGPU){var l=new _i;l.setTRS(new hi(e,t,0),bi.IDENTITY,new hi(i,-s,0)),n||((n=new Hu).cull=0,n.setParameter("colorMap",r),n.shaderDesc=o?this.scene.immediate.getTextureShaderDesc(r.encoding):this.scene.immediate.getUnfilterableTextureShaderDesc(),n.update()),this.drawQuad(l,n,a)}}drawDepthTexture(e,t,i,s,r){void 0===r&&(r=this.scene.defaultDrawLayer);var n=new Hu;n.cull=0,n.shaderDesc=this.scene.immediate.getDepthTextureShaderDesc(),n.update(),this.drawTexture(e,t,i,s,null,n,r)}destroy(){var e,t,i,s;if(this._inFrameUpdate)this._destroyRequested=!0;else{var r=this.graphicsDevice.canvas.id;this.fire("destroy",this),this.off("librariesloaded"),"undefined"!=typeof document&&(document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("msvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1)),this._visibilityChangeHandler=null,this.root.destroy(),this.root=null,this.mouse&&(this.mouse.off(),this.mouse.detach(),this.mouse=null),this.keyboard&&(this.keyboard.off(),this.keyboard.detach(),this.keyboard=null),this.touch&&(this.touch.off(),this.touch.detach(),this.touch=null),this.elementInput&&(this.elementInput.detach(),this.elementInput=null),this.gamepads&&(this.gamepads.destroy(),this.gamepads=null),this.controller&&(this.controller=null),this.systems.destroy(),this.scene.layers&&this.scene.layers.destroy();for(var n=this.assets.list(),a=0;a<n.length;a++)n[a].unload(),n[a].off();this.assets.off(),this.bundles.destroy(),this.bundles=null,this.i18n.destroy(),this.i18n=null;var o=this.loader.getHandler("script");null==o||o.clearCache(),this.loader.destroy(),this.loader=null,this.scene.destroy(),this.scene=null,this.systems=null,this.context=null,this.scripts.destroy(),this.scripts=null,this.scenes.destroy(),this.scenes=null,null==(e=this.lightmapper)||e.destroy(),this.lightmapper=null,this._batcher&&(this._batcher.destroy(),this._batcher=null),this._entityIndex={},this.defaultLayerDepth.onDisable=null,this.defaultLayerDepth.onEnable=null,this.defaultLayerDepth=null,this.defaultLayerWorld=null,null==(t=this.xr)||t.end(),null==(i=this.xr)||i.destroy(),this.renderer.destroy(),this.renderer=null,this.graphicsDevice.destroy(),this.graphicsDevice=null,this.tick=null,this.off(),null==(s=this._soundManager)||s.destroy(),this._soundManager=null,Om._applications[r]=null,Kp()===this&&Yp(null),Om.cancelTick(this)}}static cancelTick(e){e.frameRequestId&&(window.cancelAnimationFrame(e.frameRequestId),e.frameRequestId=void 0)}getEntityFromIndex(e){return this._entityIndex[e]}_registerSceneImmediate(e){this.on("postrender",e.immediate.onPostRender,e.immediate)}constructor(e){super(),this._batcher=null,this._destroyRequested=!1,this._inFrameUpdate=!1,this._librariesLoaded=!1,this._fillMode=qp,this._resolutionMode="FIXED",this._allowResize=!0,this._skyboxAsset=null,this._entityIndex={},this._inTools=!1,this._scriptPrefix="",this._time=0,this.enableBundles="undefined"!=typeof TextDecoder,this.timeScale=1,this.maxDeltaTime=.1,this.frame=0,this.frameGraph=new Qp,this.scriptsOrder=[],this.autoRender=!0,this.renderNextFrame=!1,this.lightmapper=null,this.loader=new Sm(this),this.scenes=new Rm(this),this.scripts=new Cm(this),this.systems=new vm,this.i18n=new Tm(this),this.keyboard=null,this.mouse=null,this.touch=null,this.gamepads=null,this.elementInput=null,this.xr=null,Om._applications[e.id]=this,Yp(this),this.root=new Lm,this.root._enabledInHierarchy=!0}}Om._applications={};var Fm={},Bm=function(e){var t=e;return function(e,i){var s;if(t.graphicsDevice){var r,n;if(t.frameRequestId)null==(n=t.xr)||null==(r=n.session)||r.cancelAnimationFrame(t.frameRequestId),cancelAnimationFrame(t.frameRequestId),t.frameRequestId=null;t._inFrameUpdate=!0,Yp(t);var a=t._processTimestamp(e)||Jt(),o=a-(t._time||a),l=o/1e3;if(l=ti.clamp(l,0,t.maxDeltaTime),l*=t.timeScale,t._time=a,(null==(s=t.xr)?void 0:s.session)?t.frameRequestId=t.xr.session.requestAnimationFrame(t.tick):t.frameRequestId=Ut.browser||Ut.worker?requestAnimationFrame(t.tick):null,!t.graphicsDevice.contextLost){t._fillFrameStatsBasic(a,l,o),t.fire("frameupdate",o);var h,c=!0;if(i)c=null==(h=t.xr)?void 0:h.update(i),t.graphicsDevice.defaultFramebuffer=i.session.renderState.baseLayer.framebuffer;else t.graphicsDevice.defaultFramebuffer=null;c&&(t.update(l),t.fire("framerender"),(t.autoRender||t.renderNextFrame)&&(t.updateCanvasSize(),t.frameStart(),t.render(),t.frameEnd(),t.renderNextFrame=!1),Fm.timestamp=Jt(),Fm.target=t,t.fire("frameend",Fm)),t._inFrameUpdate=!1,t._destroyRequested&&t.destroy()}}}};class Nm{constructor(){this.componentSystems=[],this.resourceHandlers=[]}}var zm=new Pi;class Um{store(){this.mask=this.light.mask,this.shadowUpdateMode=this.light.shadowUpdateMode,this.enabled=this.light.enabled,this.intensity=this.light.intensity,this.rotation=this.light._node.getLocalRotation().clone(),this.numCascades=this.light.numCascades,this.castShadows=this.light._castShadows}restore(){var e=this.light;e.mask=this.mask,e.shadowUpdateMode=this.shadowUpdateMode,e.enabled=this.enabled,e.intensity=this.intensity,e._node.setLocalRotation(this.rotation),e.numCascades=this.numCascades,e._castShadows=this.castShadows}startBake(){this.light.enabled=!0,this.light._destroyShadowMap(),this.light.beginFrame()}endBake(e){var t=this.light;t.enabled=!1,t.shadowMap&&(t.shadowMap.cached&&e.add(t,t.shadowMap),t.shadowMap=null)}constructor(e,t,i){this.scene=e,this.light=t,this.store(),t.numCascades=1,this.scene.clusteredLightingEnabled&&!i.shadowsEnabled&&(t.castShadows=!1),0!==t.type&&(t._node.getWorldTransform(),t.getBoundingSphere(zm),this.lightBounds=new Ci,this.lightBounds.center.copy(zm.center),this.lightBounds.halfExtents.set(zm.radius,zm.radius,zm.radius))}}var Vm=new di;class Hm extends Um{get numVirtualLights(){return 0===this.light.type?this.light.bakeNumSamples:1}prepareVirtualLight(e,t){var i=this.light;if(i._node.setLocalRotation(this.rotation),e>0){var s=i.bakeArea;df.circlePointDeterministic(Vm,e,t),Vm.mulScalar(.5*s),i._node.rotateLocal(Vm.x,0,Vm.y)}i._node.getWorldTransform();var r=Math.pow(this.intensity,2.2);i.intensity=Math.pow(r/t,1/2.2)}constructor(e,t){super(e.scene,t,e.lightingParams)}}var Gm=new hi;class Wm extends Um{get numVirtualLights(){return this.light.bakeNumSamples}prepareVirtualLight(e,t){df.spherePointDeterministic(Gm,e,t,0,this.scene.ambientBakeSpherePart),this.light._node.lookAt(Gm.mulScalar(-1)),this.light._node.rotateLocal(90,0,0);var i=2*Math.PI*this.scene.ambientBakeSpherePart,s=Math.pow(i,2.2);this.light.intensity=Math.pow(s/t,1/2.2)}constructor(e){var t=e.scene,i=new Lm("AmbientLight");i.addComponent("light",{type:"directional",affectDynamic:!0,affectLightmapped:!1,bake:!0,bakeNumSamples:t.ambientBakeNumSamples,castShadows:!0,normalOffsetBias:.05,shadowBias:.2,shadowDistance:1,shadowResolution:2048,shadowType:0,color:ii.WHITE,intensity:1,bakeDir:!1}),super(t,i.light.light,e.lightingParams)}}class jm{store(){this.castShadows=this.component.castShadows}restore(){this.component.castShadows=this.castShadows}constructor(e,t=null){this.node=e,this.component=e.render||e.model,t=t||this.component.meshInstances,this.store(),this.meshInstances=t,this.bounds=null,this.renderTargets=[]}}class qm{setSourceTexture(e){this.constantTexSource.setValue(e)}prepare(e,t){this.pixelOffset[0]=1/e,this.pixelOffset[1]=1/t,this.constantPixelOffset.setValue(this.pixelOffset)}prepareDenoise(e,t,i){var s=i?0:1;if(!this.shaderDenoise[s]){var r="lmBilateralDeNoise-"+(i?"hdr":"rgbm"),n=i?"#define HDR\n":"";this.shaderDenoise[s]=Eh(this.device,_h.fullscreenQuadVS,n+Ep,r),this.sigmas=new Float32Array(2),this.constantSigmas=this.device.scope.resolve("sigmas"),this.constantKernel=this.device.scope.resolve("kernel[0]"),this.bZnorm=this.device.scope.resolve("bZnorm")}this.sigmas[0]=e,this.sigmas[1]=t,this.constantSigmas.setValue(this.sigmas),this.evaluateDenoiseUniforms(e,t)}getDenoise(e){var t=e?0:1;return this.shaderDenoise[t]}getDilate(e,t){var i=t?0:1;if(!this.shaderDilate[i]){var s="lmDilate-"+(t?"hdr":"rgbm"),r=t?"#define HDR\n":"";this.shaderDilate[i]=Eh(e,_h.fullscreenQuadVS,r+Cp,s)}return this.shaderDilate[i]}evaluateDenoiseUniforms(e,t){function i(e,t){return.39894*Math.exp(-.5*e*e/(t*t))/t}this.kernel=this.kernel||new Float32Array(15);for(var s=this.kernel,r=Math.floor(7),n=0;n<=r;++n){var a=i(n,e);s[r+n]=a,s[r-n]=a}this.constantKernel.setValue(this.kernel);var o=1/i(0,t);this.bZnorm.setValue(o)}constructor(e){this.device=e,this.shaderDilate=Eh(e,_h.fullscreenQuadVS,Cp,"lmDilate"),this.constantTexSource=e.scope.resolve("source"),this.constantPixelOffset=e.scope.resolve("pixelOffset"),this.pixelOffset=new Float32Array(2),this.shaderDenoise=[],this.sigmas=null,this.constantSigmas=null,this.kernel=null}}class Xm extends Do{destroy(){this.viewBindGroups.forEach((e=>{e.defaultUniformBuffer.destroy(),e.destroy()})),this.viewBindGroups.length=0}execute(){var{renderer:e,camera:t,receivers:i,renderTarget:s,worldClusters:r,lightArray:n}=this;e.renderForwardLayer(t,s,null,void 0,0,this.viewBindGroups,{meshInstances:i,splitLights:n,lightClusters:r})}constructor(e,t,i,s,r,n){super(e),this.viewBindGroups=[],this.renderer=t,this.camera=i,this.worldClusters=s,this.receivers=r,this.lightArray=n}}var Km=new hi;class Ym{destroy(){var e;qh.decRef(this.blackTex),this.blackTex=null,qh.destroy(),this.device=null,this.root=null,this.scene=null,this.renderer=null,this.assets=null,null==(e=this.camera)||e.destroy(),this.camera=null}initBake(e){if(this.bakeHDR=7!==this.scene.lightmapPixelFormat,!this._initCalled){this._initCalled=!0,this.lightmapFilters=new qm(e),this.constantBakeDir=e.scope.resolve("bakeDir"),this.materials=[],this.blackTex=new ur(this.device,{width:4,height:4,format:7,type:bs,name:"lightmapBlack"}),qh.incRef(this.blackTex);var t=new uc;t.clearColor.set(0,0,0,0),t.clearColorBuffer=!0,t.clearDepthBuffer=!1,t.clearStencilBuffer=!1,t.frustumCulling=!1,t.projection=1,t.aspectRatio=1,t.node=new Lc,this.camera=t,this.camera.shaderParams.gammaCorrection=0,this.camera.shaderParams.toneMapping=0}if(this.scene.clusteredLightingEnabled){var i=new ku(e.supportsAreaLights,e.maxTextureSize,(()=>{}));this.lightingParams=i;var s=this.scene.lighting;i.shadowsEnabled=s.shadowsEnabled,i.shadowAtlasResolution=s.shadowAtlasResolution,i.cookiesEnabled=s.cookiesEnabled,i.cookieAtlasResolution=s.cookieAtlasResolution,i.areaLightsEnabled=s.areaLightsEnabled,i.cells=new hi(3,3,3),i.maxLightsPerCell=4,this.worldClusters=new Yc(e),this.worldClusters.name="ClusterLightmapper"}}finishBake(e){function t(e){qh.decRef(e.colorBuffer),e.destroy()}this.materials=[],this.renderTargets.forEach((e=>{t(e)})),this.renderTargets.clear(),e.forEach((e=>{e.renderTargets.forEach((e=>{t(e)})),e.renderTargets.length=0})),this.ambientAOMaterial=null,this.worldClusters&&(this.worldClusters.destroy(),this.worldClusters=null)}createMaterialForPass(e,t,i,s){var r=new sp;if(r.name="lmMaterial-pass:"+i+"-ambient:"+s,r.chunks.APIVersion=tr,r.setDefine("UV1LAYOUT",""),0===i){var n=Tp;s?n="\n                    dDiffuseLight = ((dDiffuseLight - 0.5) * max("+t.ambientBakeOcclusionContrast.toFixed(1)+" + 1.0, 0.0)) + 0.5;\n                    dDiffuseLight += vec3("+t.ambientBakeOcclusionBrightness.toFixed(1)+");\n                    dDiffuseLight = saturate(dDiffuseLight);\n                    dDiffuseLight *= dAmbientLight;\n                    "+n+"\n                ":r.ambient=new ii(0,0,0),r.chunks.basePS=_h.basePS+(this.bakeHDR?"":"\n#define LIGHTMAP_RGBM\n"),r.chunks.endPS=n,r.lightMap=this.blackTex}else r.chunks.basePS="\n                #define STD_LIGHTMAP_DIR\n                "+_h.basePS+"\n                uniform float bakeDir;\n            ",r.chunks.endPS=wp;return r.chunks.outputAlphaPS="\n",r.cull=0,r.forceUv1=!0,r.update(),r}createMaterials(e,t,i){for(var s=0;s<i;s++)this.passMaterials[s]||(this.passMaterials[s]=this.createMaterialForPass(e,t,s,!1));this.ambientAOMaterial||(this.ambientAOMaterial=this.createMaterialForPass(e,t,0,!0),this.ambientAOMaterial.onUpdateShader=function(e){return e.litOptions.lightMapWithoutAmbient=!0,e.litOptions.separateAmbient=!0,e})}createTexture(e,t){return new ur(this.device,{width:e,height:e,format:this.scene.lightmapPixelFormat,mipmaps:!1,type:this.bakeHDR?_s:bs,minFilter:0,magFilter:0,addressU:1,addressV:1,name:t})}collectModels(e,t,i){var s,r,n;if(e.enabled){var a;if((null==(s=e.model)?void 0:s.model)&&(null==(r=e.model)?void 0:r.enabled)&&(i&&i.push(new jm(e)),e.model.lightmapped&&t&&(a=e.model.model.meshInstances)),(null==(n=e.render)?void 0:n.enabled)&&(i&&i.push(new jm(e)),e.render.lightmapped&&t&&(a=e.render.meshInstances)),a){for(var o=!0,l=0;l<a.length;l++)if(!a[l].mesh.vertexBuffer.format.hasUv1){o=!1;break}if(o){for(var h=[],c=0;c<a.length;c++){var d=a[c].mesh;this._tempSet.has(d)?t.push(new jm(e,[a[c]])):h.push(a[c]),this._tempSet.add(d)}this._tempSet.clear(),h.length>0&&t.push(new jm(e,h))}}for(var u=0;u<e._children.length;u++)this.collectModels(e._children[u],t,i)}}prepareShadowCasters(e){for(var t=[],i=0;i<e.length;i++){var s=e[i].component;if(s.castShadows=s.castShadowsLightmap,s.castShadowsLightmap)for(var r=e[i].meshInstances,n=0;n<r.length;n++)r[n].visibleThisFrame=!0,t.push(r[n])}return t}updateTransforms(e){for(var t=0;t<e.length;t++)for(var i=e[t].meshInstances,s=0;s<i.length;s++)i[s].node.getWorldTransform()}calculateLightmapSize(e){var t,i,s,r=this.scene.lightmapSizeMultiplier||16,n=Km;e.model?(s=e.model.lightmapSizeMultiplier,e.model.asset?(t=this.assets.get(e.model.asset).data).area&&(i=t.area):e.model._area&&(t=e.model)._area&&(i=t._area)):e.render&&(s=e.render.lightmapSizeMultiplier,"asset"!==e.render.type&&e.render._area&&(t=e.render)._area&&(i=t._area));var a={x:1,y:1,z:1,uv:1};i&&(a.x=i.x,a.y=i.y,a.z=i.z,a.uv=i.uv);var o=s||1;a.x*=o,a.y*=o,a.z*=o;var l=e.render||e.model,h=this.computeNodeBounds(l.meshInstances);n.copy(h.halfExtents);var c=a.x*n.y*n.z+a.y*n.x*n.z+a.z*n.x*n.y;return c/=a.uv,c=Math.sqrt(c),Math.min(ti.nextPowerOfTwo(c*r),this.scene.lightmapMaxResolution||2048)}setLightmapping(e,t,i,s){for(var r=0;r<e.length;r++)for(var n=e[r],a=n.meshInstances,o=0;o<a.length;o++){var l=a[o];if(l.setLightmapped(t),t){s&&(l._shaderDefs|=s),l.mask=2;for(var h=0;h<i;h++){var c=n.renderTargets[h].colorBuffer;c.minFilter=1,c.magFilter=1,l.setRealtimeLightmap(tc.lightmapParamNames[h],c)}}}}bake(e,t){void 0===t&&(t=1);var i=this.device,s=Jt();this.scene._updateSkyMesh(),this.stats.renderPasses=0,this.stats.shadowMapTime=0,this.stats.forwardTime=0;var r=i._shaderStats.linked,n=i._renderTargetCreationTime,a=i._shaderStats.compileTime,o=[],l=[];if(e){for(var h=0;h<e.length;h++)this.collectModels(e[h],o,null);this.collectModels(this.root,null,l)}else this.collectModels(this.root,o,l);if(o.length>0){this.renderer.shadowRenderer.frameUpdate();var c=1===t?2:1;this.setLightmapping(o,!1,c),this.initBake(i),this.bakeInternal(c,o,l);var d=64;1===t&&(d|=128),this.scene.ambientBake&&(d|=4096),this.setLightmapping(o,!0,c,d),this.finishBake(o)}var u=Jt();this.stats.totalRenderTime=u-s,this.stats.shadersLinked=i._shaderStats.linked-r,this.stats.compileTime=i._shaderStats.compileTime-a,this.stats.fboTime=i._renderTargetCreationTime-n,this.stats.lightmapCount=o.length}allocateTextures(e,t){for(var i=0;i<e.length;i++){for(var s=e[i],r=this.calculateLightmapSize(s.node),n=0;n<t;n++){var a=this.createTexture(r,"lightmapper_lightmap_"+i);qh.incRef(a),s.renderTargets[n]=new Wr({colorBuffer:a,depth:!1})}if(!this.renderTargets.has(r)){var o=this.createTexture(r,"lightmapper_temp_lightmap_"+r);qh.incRef(o),this.renderTargets.set(r,new Wr({colorBuffer:o,depth:!1}))}}}prepareLightsToBake(e,t){if(this.scene.ambientBake){var i=new Wm(this);t.push(i)}for(var s=this.renderer.lights,r=0;r<s.length;r++){var n=s[r],a=new Hm(this,n);e.push(a),n.enabled&&4&n.mask&&(n.mask=7,n.shadowUpdateMode=0===n.type?2:1,t.push(a))}t.sort()}restoreLights(e){for(var t=0;t<e.length;t++)e[t].restore()}setupScene(){this.ambientLight.copy(this.scene.ambientLight),this.scene.ambientBake||this.scene.ambientLight.set(0,0,0),this.renderer.setSceneConstants()}restoreScene(){this.scene.ambientLight.copy(this.ambientLight)}computeNodeBounds(e){var t=new Ci;if(e.length>0){t.copy(e[0].aabb);for(var i=1;i<e.length;i++)t.add(e[i].aabb)}return t}computeNodesBounds(e){for(var t=0;t<e.length;t++){var i=e[t].meshInstances;e[t].bounds=this.computeNodeBounds(i)}}computeBounds(e){for(var t=new Ci,i=0;i<e.length;i++){t.copy(e[0].aabb);for(var s=1;s<e.length;s++)t.add(e[s].aabb)}return t}backupMaterials(e){for(var t=0;t<e.length;t++)this.materials[t]=e[t].material}restoreMaterials(e){for(var t=0;t<e.length;t++)e[t].material=this.materials[t]}lightCameraPrepare(e,t){var i,s=t.light;2===s.type&&((i=s.getRenderData(null,0).shadowCamera)._node.setPosition(s._node.getPosition()),i._node.setRotation(s._node.getRotation()),i._node.rotateLocal(-90,0,0),i.projection=0,i.nearClip=s.attenuationEnd/1e3,i.farClip=s.attenuationEnd,i.aspectRatio=1,i.fov=2*s._outerConeAngle,this.renderer.updateCameraFrustum(i));return i}lightCameraPrepareAndCull(e,t,i,s){var r=e.light,n=!0;if(0===r.type){Km.copy(s.center),Km.y+=s.halfExtents.y,this.camera.node.setPosition(Km),this.camera.node.setEulerAngles(-90,0,0),this.camera.nearClip=0,this.camera.farClip=2*s.halfExtents.y;var a=Math.max(s.halfExtents.x,s.halfExtents.z);this.camera.orthoHeight=a}else e.lightBounds.intersects(t.bounds)||(n=!1);if(2===r.type){for(var o=!1,l=t.meshInstances,h=0;h<l.length;h++)if(l[h]._isVisible(i)){o=!0;break}o||(n=!1)}return n}setupLightArray(e,t){e[0].length=0,e[1].length=0,e[2].length=0,e[t.type][0]=t,t.visibleThisFrame=!0}renderShadowMap(e,t,i,s){var r=s.light,n=this.scene.clusteredLightingEnabled,a=r.castShadows&&(!n||this.scene.lighting.shadowsEnabled);if(!t&&a)if(r.shadowMap||n||(r.shadowMap=this.shadowMapCache.get(this.device,r)),0===r.type){this.renderer._shadowRendererDirectional.cull(r,e,this.camera,i);var o=this.renderer._shadowRendererDirectional.getLightRenderPass(r,this.camera);null==o||o.render()}else{if(this.device.isWebGPU)return!0;this.renderer._shadowRendererLocal.cull(r,e,i);this.renderer.shadowRenderer.render(r,this.camera,!1)}return!0}postprocessTextures(e,t,i){var s,r=this.lightmapFilters.getDilate(e,this.bakeHDR),n=this.scene.lightmapFilterEnabled;n&&(this.lightmapFilters.prepareDenoise(this.scene.lightmapFilterRange,this.scene.lightmapFilterSmoothness,this.bakeHDR),s=this.lightmapFilters.getDenoise(this.bakeHDR)),e.setBlendState(Sr.NOBLEND),e.setDepthState(Cr.NODEPTH),e.setStencilState(null,null);for(var a=0;a<t.length;a++)for(var o=t[a],l=0;l<i;l++){var h=o.renderTargets[l],c=h.colorBuffer,d=this.renderTargets.get(c.width),u=d.colorBuffer;this.lightmapFilters.prepare(c.width,c.height);for(var f=0;f<1;f++){this.lightmapFilters.setSourceTexture(c),Fh(e,d,n&&0===l&&0===f?s:r),this.lightmapFilters.setSourceTexture(u),Fh(e,h,r)}}}bakeInternal(e,t,i){var s=this.scene,r=s.layers,n=this.device,a=s.clusteredLightingEnabled;this.createMaterials(n,s,e),this.setupScene(),r._update(),this.computeNodesBounds(t),this.allocateTextures(t,e),this.renderer.collectLights(r);var o=[],l=[];this.prepareLightsToBake(o,l),this.updateTransforms(i);var h=this.prepareShadowCasters(i);this.renderer.updateCpuSkinMatrices(h),this.renderer.gpuUpdate(h);var c,d,u,f,p=this.computeBounds(h);for(c=0;c<t.length;c++){for(u=t[c].meshInstances,d=0;d<u.length;d++)(f=u[d]).setLightmapped(!1),f.mask=4,f.setRealtimeLightmap(tc.lightmapParamNames[0],this.blackTex),f.setRealtimeLightmap(tc.lightmapParamNames[1],this.blackTex)}for(d=0;d<l.length;d++)l[d].light.enabled=!1;var m,g,v=[[],[],[]],_=!1;for(c=0;c<l.length;c++){var b=l[c],y=b instanceof Wm,x=0===b.light.type,S=b.numVirtualLights;e>1&&S>1&&b.light.bakeDir&&(S=1);for(var w=0;w<S;w++){S>1&&b.prepareVirtualLight(w,S),b.startBake();var T=!1,C=this.lightCameraPrepare(n,b);for(g=0;g<t.length;g++){var E=t[g];if(u=E.meshInstances,this.lightCameraPrepareAndCull(b,E,C,p)){this.setupLightArray(v,b.light);var A=x?[]:[b.light];for(a&&this.renderer.lightTextureAtlas.update(A,this.lightingParams),T=this.renderShadowMap(r,T,h,b),a&&this.worldClusters.update(A,this.lightingParams),this.backupMaterials(u),m=0;m<e&&!(m>0&&w>0)&&!(y&&m>0);m++){var P=E.renderTargets[m],D=E.renderTargets[m].colorBuffer.width,L=this.renderTargets.get(D),M=L.colorBuffer;0===m?_=s.updateShaders:_&&(s.updateShaders=!0);var I=this.passMaterials[m];for(y&&w+1===S&&0===m&&(I=this.ambientAOMaterial),d=0;d<u.length;d++)u[d].material=I;if(this.renderer.updateShaders(u),1===m&&this.constantBakeDir.setValue(b.light.bakeDir?1:0),n.isWebGPU){var R=new Xm(n,this.renderer,this.camera,a?this.worldClusters:null,u,v);R.init(L),R.render(),R.destroy()}else this.renderer.setCamera(this.camera,L,!0),a&&this.worldClusters.activate(),this.renderer._forwardTime=0,this.renderer._shadowMapTime=0,this.renderer.renderForward(this.camera,L,u,v,0),n.updateEnd();for(E.renderTargets[m]=L,this.renderTargets.set(D,P),d=0;d<u.length;d++)(f=u[d]).setRealtimeLightmap(tc.lightmapParamNames[m],M),f._shaderDefs|=64}this.restoreMaterials(u)}}b.endBake(this.shadowMapCache)}}for(this.postprocessTextures(n,t,e),g=0;g<i.length;g++)i[g].restore();this.restoreLights(o),this.restoreScene(),a||this.shadowMapCache.clear()}constructor(e,t,i,s,r){this.device=e,this.root=t,this.scene=i,this.renderer=s,this.assets=r,this.shadowMapCache=s.shadowMapCache,this._tempSet=new Set,this._initCalled=!1,this.passMaterials=[],this.ambientAOMaterial=null,this.fog="",this.ambientLight=new ii,this.renderTargets=new Map,this.stats={renderPasses:0,lightmapCount:0,totalRenderTime:0,forwardTime:0,fboTime:0,shadowMapTime:0,compileTime:0,shadersLinked:0}}}class Qm extends Ht{static _buildAccessors(e,t){t.forEach((t=>{var i="object"==typeof t?t.name:t;Object.defineProperty(e,i,{get:function(){return this.data[i]},set:function(e){var t=this.data,s=t[i];t[i]=e,this.fire("set",i,s,e)},configurable:!0})})),e._accessorsBuilt=!0}buildAccessors(e){Qm._buildAccessors(this,e)}onSetEnabled(e,t,i){t!==i&&this.entity.enabled&&(i?this.onEnable():this.onDisable())}onEnable(){}onDisable(){}onPostStateChange(){}get data(){var e=this.system.store[this.entity.getGuid()];return e?e.data:null}set enabled(e){}get enabled(){return!0}constructor(e,t){super(),this.system=e,this.entity=t,this.system.schema&&!this._accessorsBuilt&&this.buildAccessors(this.system.schema),this.on("set",(function(e,t,i){this.fire("set_"+e,e,t,i)})),this.on("set_enabled",this.onSetEnabled,this)}}Qm.order=0;class Jm extends Ht{addComponent(e,t){void 0===t&&(t={});var i=new this.ComponentType(this,e),s=new this.DataType;return this.store[e.getGuid()]={entity:e,data:s},e[this.id]=i,e.c[this.id]=i,this.initializeComponentData(i,t,[]),this.fire("add",e,i),i}removeComponent(e){var t=this.id,i=this.store[e.getGuid()],s=e.c[t];s.fire("beforeremove"),this.fire("beforeremove",e,s),delete this.store[e.getGuid()],e[t]=void 0,delete e.c[t],this.fire("remove",e,i.data)}cloneComponent(e,t){var i=this.store[e.getGuid()];return this.addComponent(t,i.data)}initializeComponentData(e,t,i){void 0===t&&(t={});for(var s=0,r=i.length;s<r;s++){var n=i[s],a=void 0,o=void 0;"object"==typeof n?(a=n.name,o=n.type):(a=n,o=void 0);var l=t[a];void 0!==l?(void 0!==o&&(l=$m(l,o)),e[a]=l):e[a]=e.data[a]}e.enabled&&e.entity.enabled&&e.onEnable()}getPropertiesOfType(e){var t=[];return(this.schema||[]).forEach((i=>{i&&"object"==typeof i&&i.type===e&&t.push(i)})),t}destroy(){this.off()}constructor(e){super(),this.app=e,this.store={},this.schema=[]}}function $m(e,t){if(!e)return e;switch(t){case"rgb":return e instanceof ii?e.clone():new ii(e[0],e[1],e[2]);case"rgba":return e instanceof ii?e.clone():new ii(e[0],e[1],e[2],e[3]);case"vec2":return e instanceof di?e.clone():new di(e[0],e[1]);case"vec3":return e instanceof hi?e.clone():new hi(e[0],e[1],e[2]);case"vec4":return e instanceof ui?e.clone():new ui(e[0],e[1],e[2],e[3]);case"boolean":case"number":case"string":case"entity":return e;default:throw new Error("Could not convert unhandled type: "+t)}}class Zm{update(e,t){if(e<this._left||e>=this._right){var i=t.length;if(i)if(e<t[0])this._left=-1/0,this._right=t[0],this._len=0,this._recip=0,this._p0=this._p1=0;else if(e>=t[i-1])this._left=t[i-1],this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=i-1;else{var s=this._findKey(e,t);this._left=t[s],this._right=t[s+1],this._len=this._right-this._left;var r=1/this._len;this._recip=isFinite(r)?r:0,this._p0=s,this._p1=s+1}else this._left=-1/0,this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=0}this._t=0===this._recip?0:(e-this._left)*this._recip,this._hermite.valid=!1}_findKey(e,t){for(var i=0;e>=t[i+1];)i++;return i}eval(e,t,i){var s=i._data,r=i._components,n=this._p0*r;if(0===t)for(var a=0;a<r;++a)e[a]=s[n+a];else{var o=this._t,l=this._p1*r;switch(t){case 1:for(var h=0;h<r;++h)e[h]=ti.lerp(s[n+h],s[l+h],o);break;case 2:var c=this._hermite;if(!c.valid){var d=o*o,u=o+o,f=1-o,p=f*f;c.valid=!0,c.p0=(1+u)*p,c.m0=o*p,c.p1=d*(3-u),c.m1=d*(o-1)}for(var m=(3*this._p0+1)*r,g=(3*this._p0+2)*r,v=(3*this._p1+1)*r,_=(3*this._p1+0)*r,b=0;b<r;++b)e[b]=c.p0*s[m+b]+c.m0*s[g+b]*this._len+c.p1*s[v+b]+c.m1*s[_+b]*this._len}}}constructor(){this._left=1/0,this._right=-1/0,this._len=0,this._recip=0,this._p0=0,this._p1=0,this._t=0,this._hermite={valid:!1,p0:0,m0:0,p1:0,m1:0}}}class eg{constructor(e){this._name=e.name+"Snapshot",this._time=-1,this._cache=[],this._results=[];for(var t=0;t<e._inputs.length;++t)this._cache[t]=new Zm;for(var i=e._curves,s=e._outputs,r=0;r<i.length;++r){for(var n=s[i[r]._output],a=[],o=0;o<n._components;++o)a[o]=0;this._results[r]=a}}}function tg(){return tg=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var s in i)Object.prototype.hasOwnProperty.call(i,s)&&(e[s]=i[s])}return e},tg.apply(this,arguments)}class ig{set name(e){this._name=e}get name(){return this._name}set track(e){this._track=e,this._snapshot=new eg(e)}get track(){return this._track}get snapshot(){return this._snapshot}set time(e){this._time=e,this.alignCursorToCurrentTime()}get time(){return this._time}set speed(e){var t=Math.sign(e)!==Math.sign(this._speed);this._speed=e,t&&this.alignCursorToCurrentTime()}get speed(){return this._speed}set loop(e){this._loop=e}get loop(){return this._loop}set blendWeight(e){this._blendWeight=e}get blendWeight(){return this._blendWeight}set blendOrder(e){this._blendOrder=e}get blendOrder(){return this._blendOrder}set eventCursor(e){this._eventCursor=e}get eventCursor(){return this._eventCursor}get eventCursorEnd(){return this.isReverse?0:this._track.events.length-1}get nextEvent(){return this._track.events[this._eventCursor]}get isReverse(){return this._speed<0}nextEventAheadOfTime(e){return!!this.nextEvent&&(this.isReverse?this.nextEvent.time<=e:this.nextEvent.time>=e)}nextEventBehindTime(e){return!!this.nextEvent&&(e===this.track.duration?this.isReverse?this.nextEvent.time>=e:this.nextEvent.time<=e:this.isReverse?this.nextEvent.time>e:this.nextEvent.time<e)}resetEventCursor(){this._eventCursor=this.isReverse?this._track.events.length-1:0}moveEventCursor(){this._eventCursor+=this.isReverse?-1:1,this._eventCursor>=this.track.events.length?this._eventCursor=0:this._eventCursor<0&&(this._eventCursor=this.track.events.length-1)}clipFrameTime(e){var t=ig.eventFrame;t.start=0,t.end=e,t.residual=0,this.isReverse?e<0&&(t.start=this.track.duration,t.end=0,t.residual=e+this.track.duration):e>this.track.duration&&(t.start=0,t.end=this.track.duration,t.residual=e-this.track.duration)}alignCursorToCurrentTime(){for(this.resetEventCursor();this.nextEventBehindTime(this._time)&&this._eventCursor!==this.eventCursorEnd;)this.moveEventCursor()}fireNextEvent(){this._eventHandler.fire(this.nextEvent.name,tg({track:this.track},this.nextEvent)),this.moveEventCursor()}fireNextEventInFrame(e,t){return!(!this.nextEventAheadOfTime(e)||!this.nextEventBehindTime(t))&&(this.fireNextEvent(),!0)}activeEventsForFrame(e,t){var i=ig.eventFrame;this.clipFrameTime(t);for(var s=this.eventCursor;this.fireNextEventInFrame(e,i.end)&&s!==this.eventCursor;);this.loop&&Math.abs(i.residual)>0&&this.activeEventsForFrame(i.start,i.residual)}progressForTime(e){return e*this._speed/this._track.duration}_update(e){if(this._playing){var t=this._time,i=this._track.duration,s=this._speed,r=this._loop;this._track.events.length>0&&i>0&&this.activeEventsForFrame(t,t+s*e),t+=s*e,s>=0?t>i&&(r?t=t%i||0:(t=this._track.duration,this.pause())):t<0&&(r?t=i+(t%i||0):(t=0,this.pause())),this._time=t}this._time!==this._snapshot._time&&this._track.eval(this._time,this._snapshot)}play(){this._playing=!0,this._time=0}stop(){this._playing=!1,this._time=0}pause(){this._playing=!1}resume(){this._playing=!0}reset(){this._time=0}constructor(e,t,i,s,r,n){this._name=e.name,this._track=e,this._snapshot=new eg(e),this._playing=s,this._time=t,this._speed=i,this._loop=r,this._blendWeight=1,this._blendOrder=0,this._eventHandler=n,this.alignCursorToCurrentTime()}}ig.eventFrame={start:0,end:0,residual:0};var sg="NONE",rg="INTEGER",ng="FLOAT",ag="BOOLEAN",og="TRIGGER",lg="START",hg="END",cg="ANY",dg=[lg,hg,cg],ug="OVERWRITE";class fg{static dot(e,t){for(var i=e.length,s=0,r=0;r<i;++r)s+=e[r]*t[r];return s}static normalize(e){var t=fg.dot(e,e);if(t>0){t=1/Math.sqrt(t);for(var i=e.length,s=0;s<i;++s)e[s]*=t}}static set(e,t,i){var s=e.length;if("quaternion"===i){var r=fg.dot(t,t);r>0&&(r=1/Math.sqrt(r));for(var n=0;n<s;++n)e[n]=t[n]*r}else for(var a=0;a<s;++a)e[a]=t[a]}static blendVec(e,t,i,s){for(var r=s?1:1-i,n=e.length,a=0;a<n;++a)e[a]=e[a]*r+t[a]*i}static blendQuat(e,t,i,s){var r=e.length,n=s?1:1-i;fg.dot(e,t)<0&&(i=-i);for(var a=0;a<r;++a)e[a]=e[a]*n+t[a]*i;s||fg.normalize(e)}static blend(e,t,i,s,r){"quaternion"===s?fg.blendQuat(e,t,i,r):fg.blendVec(e,t,i,r)}static stableSort(e,t){for(var i=e.length,s=0;s<i-1;++s)for(var r=s+1;r<i;++r)if(t(e[r],e[s])){var n=e[s];e[s]=e[r],e[r]=n}}}class pg{get _normalizeWeights(){return this._component.normalizeWeights}getWeight(e){return this.dirty&&this.updateWeights(),this._normalizeWeights&&0===this.totalWeight||!this.mask[e]?0:this._normalizeWeights?this.weights[e]/this.totalWeight:ti.clamp(this.weights[e],0,1)}_layerBlendType(e){return this._component.layers[e].blendType}setMask(e,t){this.mask[e]=t,this._normalizeWeights&&(this._component.layers[e].blendType===ug&&(this.mask=this.mask.fill(0,0,e)),this.dirty=!0)}updateWeights(){this.totalWeight=0;for(var e=0;e<this.weights.length;e++)this.weights[e]=this._component.layers[e].weight,this.totalWeight+=this.mask[e]*this.weights[e];this.dirty=!1}updateValue(e,t){if(0===this.counter&&(fg.set(this.value,pg.IDENTITY_QUAT_ARR,this.valueType),this._normalizeWeights||fg.blend(this.value,this.baseValue,1,this.valueType)),this.mask[e]&&0!==this.getWeight(e)){if("ADDITIVE"!==this._layerBlendType(e)||this._normalizeWeights)fg.blend(this.value,t,this.getWeight(e),this.valueType);else if(this.valueType===pg.TYPE_QUAT){var i=pg.q1.set(this.value[0],this.value[1],this.value[2],this.value[3]),s=pg.q2.set(this.baseValue[0],this.baseValue[1],this.baseValue[2],this.baseValue[3]),r=pg.q3.set(t[0],t[1],t[2],t[3]),n=s.invert().mul(r);n.slerp(bi.IDENTITY,n,this.getWeight(e)),i.mul(n),pg.quatArr[0]=i.x,pg.quatArr[1]=i.y,pg.quatArr[2]=i.z,pg.quatArr[3]=i.w,fg.set(this.value,pg.quatArr,this.valueType)}else pg.vecArr[0]=t[0]-this.baseValue[0],pg.vecArr[1]=t[1]-this.baseValue[1],pg.vecArr[2]=t[2]-this.baseValue[2],fg.blend(this.value,pg.vecArr,this.getWeight(e),this.valueType,!0);this.setter&&this.setter(this.value)}}unbind(){this.setter&&this.setter(this.baseValue)}constructor(e,t){this._component=e,this.mask=new Int8Array(e.layers.length),this.weights=new Float32Array(e.layers.length),this.totalWeight=0,this.counter=0,this.layerCounter=0,this.valueType=t,this.dirty=!0,this.value=t===pg.TYPE_QUAT?[0,0,0,1]:[0,0,0],this.baseValue=null,this.setter=null}}pg.TYPE_QUAT="quaternion",pg.TYPE_VEC3="vector3",pg.q1=new bi,pg.q2=new bi,pg.q3=new bi,pg.quatArr=[0,0,0,1],pg.vecArr=[0,0,0],pg.IDENTITY_QUAT_ARR=[0,0,0,1];class mg{get clips(){return this._clips}addClip(e){for(var t=this._targets,i=this._binder,s=e.track.curves,r=e.snapshot,n=[],a=[],o=0;o<s.length;++o)for(var l=s[o].paths,h=0;h<l.length;++h){var c=l[h],d=i.resolve(c),u=t[d&&d.targetPath||null];if(!u&&d){u={target:d,value:[],curves:0,blendCounter:0};for(var f=0;f<u.target.components;++f)u.value.push(0);if(t[d.targetPath]=u,i.animComponent){if(!i.animComponent.targets[d.targetPath]){var p=void 0;p="localRotation"===d.targetPath.substring(d.targetPath.length-13)?pg.TYPE_QUAT:pg.TYPE_VEC3,i.animComponent.targets[d.targetPath]=new pg(i.animComponent,p)}i.animComponent.targets[d.targetPath].layerCounter++,i.animComponent.targets[d.targetPath].setMask(i.layerIndex,1)}}u&&(u.curves++,n.push(r._results[o]),a.push(u))}this._clips.push(e),this._inputs.push(n),this._outputs.push(a)}removeClip(e){for(var t=this._targets,i=this._binder,s=this._clips,r=s[e].track.curves,n=0;n<r.length;++n)for(var a=r[n].paths,o=0;o<a.length;++o){var l=a[o],h=this._binder.resolve(l);h&&(h.curves--,0===h.curves&&(i.unresolve(l),delete t[h.targetPath],i.animComponent&&i.animComponent.targets[h.targetPath].layerCounter--))}s.splice(e,1),this._inputs.splice(e,1),this._outputs.splice(e,1)}removeClips(){for(;this._clips.length>0;)this.removeClip(0)}updateClipTrack(e,t){this._clips.forEach((i=>{i.name.includes(e)&&(i.track=t)})),this.rebind()}findClip(e){for(var t=this._clips,i=0;i<t.length;++i){var s=t[i];if(s.name===e)return s}return null}rebind(){this._binder.rebind(),this._targets={};var e=[...this.clips];this.removeClips(),e.forEach((e=>{this.addClip(e)}))}assignMask(e){return this._binder.assignMask(e)}update(e,t){void 0===t&&(t=!0);var i=this._clips,s=i.map(((e,t)=>t));fg.stableSort(s,((e,t)=>i[e].blendOrder<i[t].blendOrder));for(var r=0;r<s.length;++r){var n=s[r],a=i[n],o=this._inputs[n],l=this._outputs[n],h=a.blendWeight;if(h>0&&a._update(e),!t)break;var c=void 0,d=void 0,u=void 0;if(h>=1)for(var f=0;f<o.length;++f)c=o[f],u=(d=l[f]).value,fg.set(u,c,d.target.type),d.blendCounter++;else if(h>0)for(var p=0;p<o.length;++p)c=o[p],u=(d=l[p]).value,0===d.blendCounter?fg.set(u,c,d.target.type):fg.blend(u,c,h,d.target.type),d.blendCounter++}var m=this._targets,g=this._binder;for(var v in m)if(m.hasOwnProperty(v)){var _=m[v];if(g.animComponent&&_.target.isTransform){var b=g.animComponent.targets[v];b.counter===b.layerCounter&&(b.counter=0),b.path||(b.path=v,b.baseValue=_.target.get(),b.setter=_.target.set),b.updateValue(g.layerIndex,_.value),b.counter++}else _.target.set(_.value);_.blendCounter=0}this._binder.update(e)}constructor(e){this._binder=e,this._clips=[],this._inputs=[],this._outputs=[],this._targets={}}}class gg{get events(){return this._events}constructor(e){this._events=[...e],this._events.sort(((e,t)=>e.time-t.time))}}class vg{get name(){return this._name}get duration(){return this._duration}get inputs(){return this._inputs}get outputs(){return this._outputs}get curves(){return this._curves}set events(e){this._animEvents=e}get events(){return this._animEvents.events}eval(e,t){t._time=e;for(var i=this._inputs,s=this._outputs,r=this._curves,n=t._cache,a=t._results,o=0;o<i.length;++o)n[o].update(e,i[o]._data);for(var l=0;l<r.length;++l){var h=r[l],c=s[h._output],d=a[l];n[h._input].eval(d,h._interpolation,c)}}constructor(e,t,i,s,r,n=new gg([])){this._name=e,this._duration=t,this._inputs=i,this._outputs=s,this._curves=r,this._animEvents=n}}vg.EMPTY=Object.freeze(new vg("empty",Number.MAX_VALUE,[],[],[]));class _g{static joinPath(e,t){t=t||".";return e.map((function(e){return e.replace(/\\/g,"\\\\").replace(new RegExp("\\"+t,"g"),"\\"+t)})).join(t)}static splitPath(e,t){t=t||".";for(var i=[],s="",r=0;r<e.length;){var n=e[r++];"\\"===n&&r<e.length?s+="\\"===(n=e[r++])||n===t?n:"\\"+n:n===t?(i.push(s),s=""):s+=n}return s.length>0&&i.push(s),i}static encode(e,t,i){return(Array.isArray(e)?e.join("/"):e)+"/"+t+"/"+(Array.isArray(i)?i.join("/"):i)}resolve(e){return null}unresolve(e){}update(e){}}class bg{get set(){return this._set}get get(){return this._get}get type(){return this._type}get components(){return this._components}get targetPath(){return this._targetPath}get isTransform(){return this._isTransform}constructor(e,t,i,s){e.set?(this._set=e.set,this._get=e.get):this._set=e,this._type=t,this._components=i,this._targetPath=s,this._isTransform="localRotation"===this._targetPath.substring(this._targetPath.length-13)||"localPosition"===this._targetPath.substring(this._targetPath.length-13)||"localScale"===this._targetPath.substring(this._targetPath.length-10)}}class yg{_isPathActive(e){if(!this._mask)return!0;for(var t=[e.entityPath[0],this.graph.name],i=0;i<t.length;++i){var s=t[i];if(this._isPathInMask(s,1===e.entityPath.length))return!0;for(var r=1;r<e.entityPath.length;r++)if(s+="/"+e.entityPath[r],this._isPathInMask(s,r===e.entityPath.length-1))return!0}return!1}findNode(e){return this._isPathActive(e)?(this.graph&&((t=this.graph.findByPath(e.entityPath))||(t=this.graph.findByPath(e.entityPath.slice(1)))),t||(t=this.nodes[e.entityPath[e.entityPath.length-1]||""]),t):null;var t}static createAnimTarget(e,t,i,s,r,n){var a=_g.encode(s.path,n||"entity",r);return new bg(e,t,i,a)}resolve(e){var t=_g.encode(e.entityPath,e.component,e.propertyPath),i=this.targetCache[t];if(i)return i;var s=this.findNode(e);if(!s)return null;var r=this.handlers[e.propertyPath];return r&&(i=r(s))?(this.targetCache[t]=i,this.nodeCounts[s.path]?this.nodeCounts[s.path]++:(this.activeNodes.push(s),this.nodeCounts[s.path]=1),i):null}unresolve(e){if("graph"===e.component){var t=this.nodes[e.entityPath[e.entityPath.length-1]||""];if(this.nodeCounts[t.path]--,0===this.nodeCounts[t.path]){var i=this.activeNodes,s=i.indexOf(t.node),r=i.length;s<r-1&&(i[s]=i[r-1]),i.pop()}}}update(e){for(var t=this.activeNodes,i=0;i<t.length;++i)t[i]._dirtifyLocal()}assignMask(e){return e!==this._mask&&(this._mask=e,!0)}constructor(e){if(this._isPathInMask=(e,t)=>{var i=this._mask[e];return!!i&&!!(i.children||t&&!1!==i.value)},this.graph=e,e){this._mask=null;var t={},i=function(e){t[e.name]=e;for(var s=0;s<e.children.length;++s)i(e.children[s])};i(e),this.nodes=t,this.targetCache={};var s=function(e){for(var t,i=e;i&&!(i instanceof Lm);)i=i.parent;return i&&(i.render?t=i.render.meshInstances:i.model&&(t=i.model.meshInstances)),t};this.nodeCounts={},this.activeNodes=[],this.handlers={localPosition:function(e){var t=e.localPosition;return yg.createAnimTarget((function(e){t.set(...e)}),"vector",3,e,"localPosition")},localRotation:function(e){var t=e.localRotation;return yg.createAnimTarget((function(e){t.set(...e)}),"quaternion",4,e,"localRotation")},localScale:function(e){var t=e.localScale;return yg.createAnimTarget((function(e){t.set(...e)}),"vector",3,e,"localScale")},weight:function(e,t){t=0===t.indexOf("name.")?t.replace("name.",""):Number(t);var i,r=s(e);if(r)for(var n=function(s){if(r[s].node.name===e.name&&r[s].morphInstance){var n=r[s].morphInstance;i||(i=[]),i.push((e=>{n.setWeight(t,e[0])}))}},a=0;a<r.length;++a)n(a);if(i){return yg.createAnimTarget((e=>{for(var t=0;t<i.length;++t)i[t](e)}),"number",1,e,"weight."+t)}return null},materialTexture:(e,t)=>{var i=s(e);if(i){for(var r,n=0;n<i.length;++n)if(i[n].node.name===e.name){r=i[n];break}if(r){return yg.createAnimTarget((e=>{var i=this.animComponent.system.app.assets.get(e[0]);i&&i.resource&&"texture"===i.type&&(r.material[t]=i.resource,r.material.update())}),"vector",1,e,"materialTexture","material")}}return null}}}}}class xg{get parent(){return this._parent}get name(){return this._name}get path(){return this._parent?this._parent.path+"."+this._name:this._name}get point(){return this._point}get pointLength(){return this._pointLength}set weight(e){this._weight=e}get weight(){return this._parent?this._parent.weight*this._weight:this._weight}get normalizedWeight(){var e=this._state.totalWeight;return 0===e?0:this.weight/e}get speed(){return this._weightedSpeed*this._speed}get absoluteSpeed(){return Math.abs(this._speed)}set weightedSpeed(e){this._weightedSpeed=e}get weightedSpeed(){return this._weightedSpeed}set animTrack(e){this._animTrack=e}get animTrack(){return this._animTrack}constructor(e,t,i,s,r=1){this._state=e,this._parent=t,this._name=i,Array.isArray(s)?(this._point=new di(s[0],s[1]),this._pointLength=this._point.length()):(this._point=s,this._pointLength=s),this._speed=r,this._weightedSpeed=1,this._weight=1,this._animTrack=null}}class Sg extends xg{get weight(){return this.calculateWeights(),this._parent?this._parent.weight*this._weight:this._weight}get syncAnimations(){return this._syncAnimations}getChild(e){for(var t=0;t<this._children.length;t++)if(this._children[t].name===e)return this._children[t];return null}updateParameterValues(){for(var e=!0,t=0;t<this._parameterValues.length;t++){var i=this._findParameter(this._parameters[t]).value;this._parameterValues[t]!==i&&(this._parameterValues[t]=i,e=!1)}return e}getNodeWeightedDuration(e){return this._children[e].animTrack.duration/this._children[e].speedMultiplier*this._children[e].weight}getNodeCount(){for(var e=0,t=0;t<this._children.length;t++){this._children[t].constructor===Sg?e+=this._children[t].getNodeCount():e++}return e}constructor(e,t,i,s,r,n,a,o,l){super(e,t,i,s),this._parameters=r,this._parameterValues=new Array(r.length),this._children=[],this._findParameter=l,this._syncAnimations=!1!==a,this._pointCache={};for(var h=0;h<n.length;h++){var c=n[h];c.children?this._children.push(o(c.type,e,this,c.name,1,c.parameter?[c.parameter]:c.parameters,c.children,c.syncAnimations,o,l)):this._children.push(new xg(e,this,c.name,c.point,c.speed))}}}class wg extends Sg{calculateWeights(){if(!this.updateParameterValues()){var e=0;this._children[0].weight=0;for(var t=0;t<this._children.length;t++){var i=this._children[t];if(t!==this._children.length-1){var s=this._children[t+1];if(i.point===s.point)i.weight=.5,s.weight=.5;else if(ti.between(this._parameterValues[0],i.point,s.point,!0)){var r=Math.abs(i.point-s.point),n=(r-Math.abs(i.point-this._parameterValues[0]))/r;i.weight=n,s.weight=1-n}else s.weight=0}this._syncAnimations&&(e+=i.animTrack.duration/i.absoluteSpeed*i.weight)}if(this._syncAnimations)for(var a=0;a<this._children.length;a++){var o=this._children[a];o.weightedSpeed=o.animTrack.duration/o.absoluteSpeed/e}}}constructor(e,t,i,s,r,n,a,o,l){n.sort(((e,t)=>e.point-t.point)),super(e,t,i,s,r,n,a,o,l)}}class Tg extends Sg{pointDistanceCache(e,t){var i=""+e+t;return this._pointCache[i]||(this._pointCache[i]=this._children[t].point.clone().sub(this._children[e].point)),this._pointCache[i]}calculateWeights(){if(!this.updateParameterValues()){var e,t;Tg._p.set(...this._parameterValues),e=0,t=0;for(var i=0;i<this._children.length;i++){var s=this._children[i],r=s.point;Tg._pip.set(Tg._p.x,Tg._p.y).sub(r);for(var n=Number.MAX_VALUE,a=0;a<this._children.length;a++)if(i!==a){var o=this.pointDistanceCache(i,a),l=ti.clamp(1-Tg._pip.dot(o)/o.lengthSq(),0,1);l<n&&(n=l)}s.weight=n,e+=n,this._syncAnimations&&(t+=s.animTrack.duration/s.absoluteSpeed*s.weight)}for(var h=0;h<this._children.length;h++){var c=this._children[h];c.weight=c._weight/e,this._syncAnimations&&(c.weightedSpeed=c.animTrack.duration/c.absoluteSpeed/t)}}}}Tg._p=new di,Tg._pip=new di;class Cg extends Sg{pointCache(e,t){var i=""+e+t;return this._pointCache[i]||(this._pointCache[i]=new di((this._children[t].pointLength-this._children[e].pointLength)/((this._children[t].pointLength+this._children[e].pointLength)/2),2*di.angleRad(this._children[e].point,this._children[t].point))),this._pointCache[i]}calculateWeights(){if(!this.updateParameterValues()){var e,t;Cg._p.set(...this._parameterValues);var i=Cg._p.length();e=0,t=0;for(var s=0;s<this._children.length;s++){for(var r=this._children[s],n=r.point,a=r.pointLength,o=Number.MAX_VALUE,l=0;l<this._children.length;l++)if(s!==l){var h=this.pointCache(s,l),c=this._children[l].pointLength;Cg._pip.set((i-a)/((c+a)/2),2*di.angleRad(n,Cg._p));var d=ti.clamp(1-Math.abs(Cg._pip.dot(h)/h.lengthSq()),0,1);d<o&&(o=d)}r.weight=o,e+=o,this._syncAnimations&&(t+=r.animTrack.duration/r.absoluteSpeed*r.weight)}for(var u=0;u<this._children.length;u++){var f=this._children[u];if(f.weight=f._weight/e,this._syncAnimations){var p=f.animTrack.duration/t*e;f.weightedSpeed=f.absoluteSpeed*p}}}}}Cg._p=new di,Cg._pip=new di;class Eg extends Sg{calculateWeights(){if(!this.updateParameterValues()){for(var e=0,t=0,i=0;i<this._children.length;i++)if(e+=Math.max(this._parameterValues[i],0),this._syncAnimations){var s=this._children[i];t+=s.animTrack.duration/s.absoluteSpeed*s.weight}for(var r=0;r<this._children.length;r++){var n=this._children[r],a=Math.max(this._parameterValues[r],0);e?(n.weight=a/e,this._syncAnimations&&(n.weightedSpeed=n.animTrack.duration/n.absoluteSpeed/t)):(n.weight=0,this._syncAnimations&&(n.weightedSpeed=0))}}}}class Ag{_createTree(e,t,i,s,r,n,a,o,l,h){switch(e){case"1D":return new wg(t,i,s,r,n,a,o,l,h);case"2D_CARTESIAN":return new Tg(t,i,s,r,n,a,o,l,h);case"2D_DIRECTIONAL":return new Cg(t,i,s,r,n,a,o,l,h);case"DIRECT":return new Eg(t,i,s,r,n,a,o,l,h)}}_getNodeFromPath(e){for(var t=this._blendTree,i=1;i<e.length;i++)t=t.getChild(e[i]);return t}addAnimation(e,t){var i=e.join("."),s=this._animationList.findIndex((e=>e.path===i));if(s>=0)this._animationList[s].animTrack=t;else{var r=this._getNodeFromPath(e);r.animTrack=t,this._animationList.push(r)}this._updateHasAnimations()}_updateHasAnimations(){this._hasAnimations=this._animationList.length>0&&this._animationList.every((e=>e.animTrack&&e.animTrack!==vg.EMPTY))}get name(){return this._name}set animations(e){this._animationList=e,this._updateHasAnimations()}get animations(){return this._animationList}get hasAnimations(){return this._hasAnimations}set speed(e){this._speed=e}get speed(){return this._speed}set loop(e){this._loop=e}get loop(){return this._loop}get nodeCount(){return this._blendTree&&this._blendTree.constructor!==xg?this._blendTree.getNodeCount():1}get playable(){return-1!==dg.indexOf(this.name)||this.animations.length===this.nodeCount}get looping(){if(this.animations.length>0){var e=this.name+"."+this.animations[0].animTrack.name,t=this._controller.animEvaluator.findClip(e);if(t)return t.loop}return!1}get totalWeight(){for(var e=0,t=0;t<this.animations.length;t++)e+=this.animations[t].weight;return e}get timelineDuration(){for(var e=0,t=0;t<this.animations.length;t++){var i=this.animations[t];i.animTrack.duration>e&&(e=i.animTrack.duration)}return e}constructor(e,t,i=1,s=!0,r){this._animations={},this._animationList=[],this._controller=e,this._name=t,this._speed=i,this._loop=s,this._hasAnimations=!1,this._blendTree=r?this._createTree(r.type,this,null,t,1,r.parameter?[r.parameter]:r.parameters,r.children,r.syncAnimations,this._createTree,this._controller.findParameter):new xg(this,null,t,1,i)}}class Pg{get from(){return this._from}set to(e){this._to=e}get to(){return this._to}get time(){return this._time}get priority(){return this._priority}get conditions(){return this._conditions}get exitTime(){return this._exitTime}get transitionOffset(){return this._transitionOffset}get interruptionSource(){return this._interruptionSource}get hasExitTime(){return!!this.exitTime}constructor({from:e,to:t,time:i=0,priority:s=0,conditions:r=[],exitTime:n=null,transitionOffset:a=null,interruptionSource:o=sg}){this._from=e,this._to=t,this._time=i,this._priority=s,this._conditions=r,this._exitTime=n,this._transitionOffset=a,this._interruptionSource=o}}function Dg(){return Dg=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var s in i)Object.prototype.hasOwnProperty.call(i,s)&&(e[s]=i[s])}return e},Dg.apply(this,arguments)}class Lg{get animEvaluator(){return this._animEvaluator}set activeState(e){this._activeStateName=e}get activeState(){return this._findState(this._activeStateName)}get activeStateName(){return this._activeStateName}get activeStateAnimations(){return this.activeState.animations}set previousState(e){this._previousStateName=e}get previousState(){return this._findState(this._previousStateName)}get previousStateName(){return this._previousStateName}get playable(){for(var e=!0,t=0;t<this._stateNames.length;t++)this._states[this._stateNames[t]].playable||(e=!1);return e}set playing(e){this._playing=e}get playing(){return this._playing}get activeStateProgress(){return this._getActiveStateProgressForTime(this._timeInState)}get activeStateDuration(){if(this._activeStateDurationDirty){for(var e=0,t=0;t<this.activeStateAnimations.length;t++){var i=this._animEvaluator.findClip(this.activeStateAnimations[t].name);i&&(e=Math.max(e,i.track.duration))}this._activeStateDuration=e,this._activeStateDurationDirty=!1}return this._activeStateDuration}set activeStateCurrentTime(e){this._timeInStateBefore=e,this._timeInState=e;for(var t=0;t<this.activeStateAnimations.length;t++){var i=this.animEvaluator.findClip(this.activeStateAnimations[t].name);i&&(i.time=e)}}get activeStateCurrentTime(){return this._timeInState}get transitioning(){return this._isTransitioning}get transitionProgress(){return this._currTransitionTime/this._totalTransitionTime}get states(){return this._stateNames}assignMask(e){return this._animEvaluator.assignMask(e)}_findState(e){return this._states[e]}_getActiveStateProgressForTime(e){if(this.activeStateName===lg||this.activeStateName===hg||this.activeStateName===cg)return 1;var t=this._animEvaluator.findClip(this.activeStateAnimations[0].name);return t?t.progressForTime(e):null}_findTransitionsFromState(e){var t=this._findTransitionsFromStateCache[e];return t||(t=this._transitions.filter((t=>t.from===e)),Su(t),this._findTransitionsFromStateCache[e]=t),t}_findTransitionsBetweenStates(e,t){var i=this._findTransitionsBetweenStatesCache[e+"->"+t];return i||(i=this._transitions.filter((i=>i.from===e&&i.to===t)),Su(i),this._findTransitionsBetweenStatesCache[e+"->"+t]=i),i}_transitionHasConditionsMet(e){for(var t=e.conditions,i=0;i<t.length;i++){var s=t[i],r=this._findParameter(s.parameterName);switch(s.predicate){case"GREATER_THAN":if(!(r.value>s.value))return!1;break;case"LESS_THAN":if(!(r.value<s.value))return!1;break;case"GREATER_THAN_EQUAL_TO":if(!(r.value>=s.value))return!1;break;case"LESS_THAN_EQUAL_TO":if(!(r.value<=s.value))return!1;break;case"EQUAL_TO":if(r.value!==s.value)return!1;break;case"NOT_EQUAL_TO":if(r.value===s.value)return!1}}return!0}_findTransition(e,t){var i=[];if(e&&t)i=i.concat(this._findTransitionsBetweenStates(e,t));else if(this._isTransitioning)switch(this._transitionInterruptionSource){case"PREV_STATE":i=(i=i.concat(this._findTransitionsFromState(this._previousStateName))).concat(this._findTransitionsFromState(cg));break;case"NEXT_STATE":i=(i=i.concat(this._findTransitionsFromState(this._activeStateName))).concat(this._findTransitionsFromState(cg));break;case"PREV_STATE_NEXT_STATE":i=(i=(i=i.concat(this._findTransitionsFromState(this._previousStateName))).concat(this._findTransitionsFromState(this._activeStateName))).concat(this._findTransitionsFromState(cg));break;case"NEXT_STATE_PREV_STATE":i=(i=(i=i.concat(this._findTransitionsFromState(this._activeStateName))).concat(this._findTransitionsFromState(this._previousStateName))).concat(this._findTransitionsFromState(cg))}else i=(i=i.concat(this._findTransitionsFromState(this._activeStateName))).concat(this._findTransitionsFromState(cg));if(i=i.filter((e=>{if(e.to===this.activeStateName)return!1;if(e.hasExitTime){var t=this._getActiveStateProgressForTime(this._timeInStateBefore),i=this._getActiveStateProgressForTime(this._timeInState);if(e.exitTime<1&&this.activeState.loop&&(t-=Math.floor(t),i-=Math.floor(i)),i===t){if(i!==e.exitTime)return null}else if(!(e.exitTime>t&&e.exitTime<=i))return null}return this._transitionHasConditionsMet(e)})),i.length>0){var s=i[0];if(s.to===hg){var r=this._findTransitionsFromState(lg)[0];s.to=r.to}return s}return null}updateStateFromTransition(e){var t,i,s;this.previousState=e.from?this.activeStateName:null,this.activeState=e.to,this._activeStateDurationDirty=!0;for(var r=0;r<e.conditions.length;r++){var n=e.conditions[r];this._findParameter(n.parameterName).type===og&&this._consumeTrigger(n.parameterName)}if(this.previousState){this._isTransitioning||(this._transitionPreviousStates=[]),this._transitionPreviousStates.push({name:this._previousStateName,weight:1});for(var a=Math.min(0!==this._totalTransitionTime?this._currTransitionTime/this._totalTransitionTime:1,1),o=0;o<this._transitionPreviousStates.length;o++){this._isTransitioning?o!==this._transitionPreviousStates.length-1?this._transitionPreviousStates[o].weight*=1-a:this._transitionPreviousStates[o].weight=a:this._transitionPreviousStates[o].weight=1,t=this._findState(this._transitionPreviousStates[o].name);for(var l=0;l<t.animations.length;l++)i=t.animations[l],(s=this._animEvaluator.findClip(i.name+".previous."+o))||((s=this._animEvaluator.findClip(i.name)).name=i.name+".previous."+o),o!==this._transitionPreviousStates.length-1&&s.pause()}}this._isTransitioning=!0,this._totalTransitionTime=e.time,this._currTransitionTime=0,this._transitionInterruptionSource=e.interruptionSource;var h=this.activeState,c=e.transitionOffset&&e.transitionOffset>0&&e.transitionOffset<1,d=0,u=0;if(c){var f=h.timelineDuration*e.transitionOffset;d=f,u=f}this._timeInState=d,this._timeInStateBefore=u;for(var p=0;p<h.animations.length;p++){if(s=this._animEvaluator.findClip(h.animations[p].name))s.reset();else{var m=Number.isFinite(h.animations[p].speed)?h.animations[p].speed:h.speed;(s=new ig(h.animations[p].animTrack,this._timeInState,m,!0,h.loop,this._eventHandler)).name=h.animations[p].name,this._animEvaluator.addClip(s)}if(e.time>0?s.blendWeight=0:s.blendWeight=h.animations[p].normalizedWeight,s.play(),c)s.time=h.timelineDuration*e.transitionOffset;else{var g=h.speed>=0?0:this.activeStateDuration;s.time=g}}}_transitionToState(e){if(this._findState(e)){var t=this._findTransition(this._activeStateName,e);t||(this._animEvaluator.removeClips(),t=new Pg({from:null,to:e})),this.updateStateFromTransition(t)}}assignAnimation(e,t,i,s){var r=e.split("."),n=this._findState(r[0]);n||(n=new Ag(this,r[0],i),this._states[r[0]]=n,this._stateNames.push(r[0])),n.addAnimation(r,t),this._animEvaluator.updateClipTrack(n.name,t),void 0!==i&&(n.speed=i),void 0!==s&&(n.loop=s),!this._playing&&this._activate&&this.playable&&this.play(),this._activeStateDurationDirty=!0}removeNodeAnimations(e){if(-1!==dg.indexOf(e))return!1;var t=this._findState(e);return!!t&&(t.animations=[],!0)}play(e){e&&this._transitionToState(e),this._playing=!0}pause(){this._playing=!1}reset(){this._previousStateName=null,this._activeStateName=lg,this._playing=!1,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=!1,this._timeInState=0,this._timeInStateBefore=0,this._animEvaluator.removeClips()}rebind(){this._animEvaluator.rebind()}update(e){if(this._playing){var t,i,s;(this.activeState.loop||this._timeInState<this.activeStateDuration)&&(this._timeInStateBefore=this._timeInState,this._timeInState+=e*this.activeState.speed,!this.activeState.loop&&this._timeInState>this.activeStateDuration&&(this._timeInState=this.activeStateDuration,e=this.activeStateDuration-this._timeInStateBefore));var r=this._findTransition(this._activeStateName);if(r&&this.updateStateFromTransition(r),this._isTransitioning)if(this._currTransitionTime+=e,this._currTransitionTime<=this._totalTransitionTime){for(var n=0!==this._totalTransitionTime?this._currTransitionTime/this._totalTransitionTime:1,a=0;a<this._transitionPreviousStates.length;a++){t=this._findState(this._transitionPreviousStates[a].name);for(var o=this._transitionPreviousStates[a].weight,l=0;l<t.animations.length;l++)i=t.animations[l],(s=this._animEvaluator.findClip(i.name+".previous."+a))&&(s.blendWeight=(1-n)*i.normalizedWeight*o)}t=this.activeState;for(var h=0;h<t.animations.length;h++)i=t.animations[h],this._animEvaluator.findClip(i.name).blendWeight=n*i.normalizedWeight}else{this._isTransitioning=!1;for(var c=this.activeStateAnimations.length,d=this._animEvaluator.clips.length,u=0;u<d-c;u++)this._animEvaluator.removeClip(0);this._transitionPreviousStates=[],t=this.activeState;for(var f=0;f<t.animations.length;f++)i=t.animations[f],(s=this._animEvaluator.findClip(i.name))&&(s.blendWeight=i.normalizedWeight)}else if(this.activeState._blendTree.constructor!==xg){t=this.activeState;for(var p=0;p<t.animations.length;p++)i=t.animations[p],(s=this._animEvaluator.findClip(i.name))&&(s.blendWeight=i.normalizedWeight,i.parent.syncAnimations&&(s.speed=i.speed))}this._animEvaluator.update(e,this.activeState.hasAnimations)}}constructor(e,t,i,s,r,n,a){this._states={},this._stateNames=[],this._findTransitionsFromStateCache={},this._findTransitionsBetweenStatesCache={},this._previousStateName=null,this._activeStateName=lg,this._activeStateDuration=0,this._activeStateDurationDirty=!0,this._playing=!1,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=!1,this._transitionInterruptionSource=sg,this._transitionPreviousStates=[],this._timeInState=0,this._timeInStateBefore=0,this.findParameter=e=>this._findParameter(e),this._animEvaluator=e,this._eventHandler=r,this._findParameter=n,this._consumeTrigger=a;for(var o=0;o<t.length;o++)this._states[t[o].name]=new Ag(this,t[o].name,t[o].speed,t[o].loop,t[o].blendTree),this._stateNames.push(t[o].name);this._transitions=i.map((e=>new Pg(Dg({},e)))),this._activate=s}}var Mg=new di,Ig=new hi,Rg=new ui,kg=new ii,Og=new bi;class Fg extends yg{static _packFloat(e){return e[0]}static _packBoolean(e){return!!e[0]}static _packVec2(e){return Mg.x=e[0],Mg.y=e[1],Mg}static _packVec3(e){return Ig.x=e[0],Ig.y=e[1],Ig.z=e[2],Ig}static _packVec4(e){return Rg.x=e[0],Rg.y=e[1],Rg.z=e[2],Rg.w=e[3],Rg}static _packColor(e){return kg.r=e[0],kg.g=e[1],kg.b=e[2],kg.a=e[3],kg}static _packQuat(e){return Og.x=e[0],Og.y=e[1],Og.z=e[2],Og.w=e[3],Og}resolve(e){var t,i,s,r=_g.encode(e.entityPath,e.component,e.propertyPath),n=this.targetCache[r];if(n)return n;switch(e.component){case"entity":t=this._getEntityFromHierarchy(e.entityPath),s=_g.encode(t.path,"entity",e.propertyPath),i=t;break;case"graph":if(!(i=this.findNode(e)))return null;s=_g.encode(i.path,"graph",e.propertyPath);break;default:if(!(i=(t=this._getEntityFromHierarchy(e.entityPath)).findComponent(e.component)))return null;s=_g.encode(t.path,e.component,e.propertyPath)}return n=this._createAnimTargetForProperty(i,e.propertyPath,s),this.targetCache[r]=n,n}update(e){var t=this.activeNodes;if(t)for(var i=0;i<t.length;i++)t[i]._dirtifyLocal()}_getEntityFromHierarchy(e){if(!this.animComponent.entity.name===e[0])return null;var t=this.animComponent.entity;return 1===e.length?t:t._parent.findByPath(e)}_resolvePath(e,t,i){for(var s=t.length-(i?0:1),r=0;r<s;r++)e=e[t[r]];return e}_setter(e,t,i){var s=this._resolvePath(e,t),r=t[t.length-1],n="set"+r.substring(0,1).toUpperCase()+r.substring(1);if(s[n]){var a=s["get"+r.substring(0,1).toUpperCase()+r.substring(1)].bind(s)();a=[a.x,a.y,a.z,a.w];var o=s[n].bind(s);return{set:e=>{o(i(e))},get:()=>a}}var l=s[r];if("object"==typeof l&&l.hasOwnProperty("copy"))return function(e){l.copy(i(e))};if(-1!==[di,hi,ui,ii,bi].indexOf(s.constructor)&&t.length>1){var h=t.length>2?this._resolvePath(e,t.slice(0,-1)):e,c=t[t.length-2];return function(e){s[r]=i(e),h[c]=s}}return function(e){s[r]=i(e)}}_createAnimTargetForProperty(e,t,i){if(this.handlers&&t[0].startsWith("weight."))return this.handlers.weight(e,t[0].replace("weight.",""));if(this.handlers&&"material"===t[0]&&2===t.length){var s=t[1];if(s.endsWith("Map"))return this.handlers.materialTexture(e,s)}var r,n,a,o=this._resolvePath(e,t,!0);if(void 0===o)return null;if("number"==typeof o)r=this._setter(e,t,Fg._packFloat),n="vector",a=1;else if("boolean"==typeof o)r=this._setter(e,t,Fg._packBoolean),n="vector",a=1;else if("object"==typeof o)switch(o.constructor){case di:r=this._setter(e,t,Fg._packVec2),n="vector",a=2;break;case hi:r=this._setter(e,t,Fg._packVec3),n="vector",a=3;break;case ui:r=this._setter(e,t,Fg._packVec4),n="vector",a=4;break;case ii:r=this._setter(e,t,Fg._packColor),n="vector",a=4;break;case bi:r=this._setter(e,t,Fg._packQuat),n="quaternion",a=4;break;default:return null}return-1!==t.indexOf("material")?new bg((t=>{r(t),e.material.update()}),n,a,i):new bg(r,n,a,i)}rebind(){this.targetCache={},this.animComponent.rootBone?this.graph=this.animComponent.rootBone:this.graph=this.animComponent.entity;var e={},t=function(i){e[i.name]=i;for(var s=0;s<i.children.length;++s)t(i.children[s])};t(this.graph),this.nodes=e}constructor(e,t,i,s,r){super(t),this.animComponent=e,this._mask=s,this.layerName=i,this.layerIndex=r}}class Bg{get name(){return this._name}set playing(e){this._controller.playing=e}get playing(){return this._controller.playing}get playable(){return this._controller.playable}get activeState(){return this._controller.activeStateName}get previousState(){return this._controller.previousStateName}get activeStateProgress(){return this._controller.activeStateProgress}get activeStateDuration(){return this._controller.activeStateDuration}set activeStateCurrentTime(e){var t=this._controller,i=t.playing;t.playing=!0,t.activeStateCurrentTime=e,i||t.update(0),t.playing=i}get activeStateCurrentTime(){return this._controller.activeStateCurrentTime}get transitioning(){return this._controller.transitioning}get transitionProgress(){return this.transitioning?this._controller.transitionProgress:null}get states(){return this._controller.states}set weight(e){this._weight=e,this._component.dirtifyTargets()}get weight(){return this._weight}set blendType(e){e!==this._blendType&&(this._blendType=e,this._controller.normalizeWeights&&this._component.rebind())}get blendType(){return this._blendType}set mask(e){this._controller.assignMask(e)&&this._component.rebind(),this._mask=e}get mask(){return this._mask}play(e){this._controller.play(e)}pause(){this._controller.pause()}reset(){this._controller.reset()}rebind(){this._controller.rebind()}update(e){this._blendTime&&(this._blendTimeElapsed<this._blendTime?(this.weight=ti.lerp(this._startingWeight,this._targetWeight,this._blendTimeElapsed/this._blendTime),this._blendTimeElapsed+=e):(this.weight=this._targetWeight,this._blendTime=0,this._blendTimeElapsed=0,this._startingWeight=0,this._targetWeight=0)),this._controller.update(e)}blendToWeight(e,t){this._startingWeight=this.weight,this._targetWeight=e,this._blendTime=Math.max(0,t),this._blendTimeElapsed=0}assignAnimation(e,t,i,s){t instanceof vg&&(this._controller.assignAnimation(e,t,i,s),0===this._controller._transitions.length&&this._controller._transitions.push(new Pg({from:"START",to:e})),this._component.activate&&this._component.playable&&(this._component.playing=!0))}removeNodeAnimations(e){this._controller.removeNodeAnimations(e)&&(this._component.playing=!1)}getAnimationAsset(e){return this._component.animationAssets[this.name+":"+e]}transition(e,t,i){void 0===t&&(t=0),void 0===i&&(i=null),this._controller.updateStateFromTransition(new Pg({from:this._controller.activeStateName,to:e,time:t,transitionOffset:i}))}constructor(e,t,i,s=1,r=ug){this._mask=null,this._blendTime=0,this._blendTimeElapsed=0,this._startingWeight=0,this._targetWeight=0,this._name=e,this._controller=t,this._component=i,this._weight=s,this._blendType=r}}class Ng{get parameters(){return Object.assign({},this._parameters)}get layers(){return this._layers}constructor(e){if(this._layers=[],this._parameters={},Array.isArray(e.layers))this._layers=e.layers;else for(var t in e.layers){for(var i=e.layers[t],s={name:i.name,blendType:i.blendType,weight:i.weight,states:[],transitions:[]},r=0;r<i.states.length;r++)s.states.push(e.states[i.states[r]]);for(var n=0;n<i.transitions.length;n++){var a=e.transitions[i.transitions[n]];if(a.conditions&&!Array.isArray(a.conditions)){for(var o=Object.keys(a.conditions),l=[],h=0;h<o.length;h++){var c=a.conditions[o[h]];c.parameterName&&l.push(c)}a.conditions=l}Number.isInteger(a.from)&&(a.from=e.states[a.from].name),Number.isInteger(a.to)&&(a.to=e.states[a.to].name),s.transitions.push(a)}this._layers.push(s)}for(var d in e.parameters){var u=e.parameters[d];this._parameters[u.name]={type:u.type,value:u.value}}}}function zg(){return zg=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var s in i)Object.prototype.hasOwnProperty.call(i,s)&&(e[s]=i[s])}return e},zg.apply(this,arguments)}class Ug extends Qm{set stateGraphAsset(e){if(null!==e){var t,i;if(this._stateGraphAsset)this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this);e instanceof fm?(t=e.id,(i=this.system.app.assets.get(t))||(this.system.app.assets.add(e),i=this.system.app.assets.get(t))):(t=e,i=this.system.app.assets.get(t)),i&&this._stateGraphAsset!==t&&(i.resource?(this._stateGraph=i.resource,this.loadStateGraph(this._stateGraph),i.on("change",this._onStateGraphAssetChangeEvent,this)):(i.once("load",(e=>{this._stateGraph=e.resource,this.loadStateGraph(this._stateGraph)})),i.on("change",this._onStateGraphAssetChangeEvent,this),this.system.app.assets.load(i)),this._stateGraphAsset=t)}else this.removeStateGraph()}get stateGraphAsset(){return this._stateGraphAsset}set normalizeWeights(e){this._normalizeWeights=e,this.unbind()}get normalizeWeights(){return this._normalizeWeights}set animationAssets(e){this._animationAssets=e,this.loadAnimationAssets()}get animationAssets(){return this._animationAssets}set speed(e){this._speed=e}get speed(){return this._speed}set activate(e){this._activate=e}get activate(){return this._activate}set playing(e){this._playing=e}get playing(){return this._playing}set rootBone(e){if("string"==typeof e){var t=this.entity.root.findByGuid(e);this._rootBone=t}else this._rootBone=e instanceof Lm?e:null;this.rebind()}get rootBone(){return this._rootBone}set stateGraph(e){this._stateGraph=e}get stateGraph(){return this._stateGraph}get layers(){return this._layers}set layerIndices(e){this._layerIndices=e}get layerIndices(){return this._layerIndices}set parameters(e){this._parameters=e}get parameters(){return this._parameters}set targets(e){this._targets=e}get targets(){return this._targets}get playable(){for(var e=0;e<this._layers.length;e++)if(!this._layers[e].playable)return!1;return!0}get baseLayer(){return this._layers.length>0?this._layers[0]:null}_onStateGraphAssetChangeEvent(e){var t=this.animationAssets,i=this.layers.map((e=>e.mask));this.removeStateGraph(),this._stateGraph=new Ng(e._data),this.loadStateGraph(this._stateGraph),this.animationAssets=t,this.loadAnimationAssets(),this.layers.forEach(((e,t)=>{e.mask=i[t]})),this.rebind()}dirtifyTargets(){for(var e=Object.values(this._targets),t=0;t<e.length;t++)e[t].dirty=!0}_addLayer(e){var t,{name:i,states:s,transitions:r,weight:n,mask:a,blendType:o}=e;t=this.rootBone?this.rootBone:this.entity;var l=this._layers.length,h=new Fg(this,t,i,a,l),c=new mg(h),d=new Lg(c,s,r,this._activate,this,this.findParameter,this.consumeTrigger);return this._layers.push(new Bg(i,d,this,n,o)),this._layerIndices[i]=l,this._layers[l]}addLayer(e,t,i,s){var r=this.findAnimationLayer(e);if(r)return r;return this._addLayer({name:e,states:[{name:"START",speed:1}],transitions:[],weight:t,mask:i,blendType:s})}_assignParameters(e){this._parameters={};for(var t=Object.keys(e.parameters),i=0;i<t.length;i++){var s=t[i];this._parameters[s]={type:e.parameters[s].type,value:e.parameters[s].value}}}loadStateGraph(e){this._stateGraph=e,this._assignParameters(e),this._layers=[];for(var t=!1,i=0;i<e.layers.length;i++){var s=e.layers[i];this._addLayer(zg({},s)),s.states.some((e=>e.blendTree))&&(t=!0)}t||this.setupAnimationAssets()}setupAnimationAssets(){for(var e=0;e<this._layers.length;e++)for(var t=this._layers[e],i=t.name,s=0;s<t.states.length;s++){var r=t.states[s];if(-1===dg.indexOf(r)){var n=i+":"+r;this._animationAssets[n]||(this._animationAssets[n]={asset:null})}}this.loadAnimationAssets()}loadAnimationAssets(){for(var e=0;e<this._layers.length;e++)for(var t=this._layers[e],i=0;i<t.states.length;i++){var s=t.states[i];if(-1===dg.indexOf(s)){var r=this._animationAssets[t.name+":"+s];if(r&&r.asset){var n=r.asset,a=this.system.app.assets.get(n);a&&(a.resource?this.onAnimationAssetLoaded(t.name,s,a):(a.once("load",function(e,t){return function(i){this.onAnimationAssetLoaded(e,t,i)}.bind(this)}.bind(this)(t.name,s)),this.system.app.assets.load(a)))}else this.findAnimationLayer(t.name).assignAnimation(s,vg.EMPTY)}}}onAnimationAssetLoaded(e,t,i){this.findAnimationLayer(e).assignAnimation(t,i.resource)}removeStateGraph(){this._stateGraph=null,this._stateGraphAsset=null,this._animationAssets={},this._layers=[],this._layerIndices={},this._parameters={},this._playing=!1,this.unbind(),this._targets={}}reset(){this._assignParameters(this._stateGraph);for(var e=0;e<this._layers.length;e++){var t=this._layers[e].playing;this._layers[e].reset(),this._layers[e].playing=t}}unbind(){this._normalizeWeights||Object.keys(this._targets).forEach((e=>{this._targets[e].unbind()}))}rebind(){this._targets={};for(var e=0;e<this._layers.length;e++)this._layers[e].rebind()}findAnimationLayer(e){var t=this._layerIndices[e];return this._layers[t]||null}addAnimationState(e,t,i,s,r){void 0===i&&(i=1),void 0===s&&(s=!0),void 0===r&&(r="Base"),this._stateGraph||this.loadStateGraph(new Ng({layers:[{name:r,states:[{name:"START",speed:1},{name:e,speed:i,loop:s,defaultState:!0}],transitions:[{from:"START",to:e}]}],parameters:{}}));var n,a=this.findAnimationLayer(r);a?a.assignAnimation(e,t,i,s):null==(n=this.addLayer(r))||n.assignAnimation(e,t,i,s)}assignAnimation(e,t,i,s,r){if(void 0===s&&(s=1),void 0===r&&(r=!0),!this._stateGraph&&-1===e.indexOf("."))return this.loadStateGraph(new Ng({layers:[{name:"Base",states:[{name:"START",speed:1},{name:e,speed:s,loop:r,defaultState:!0}],transitions:[{from:"START",to:e}]}],parameters:{}})),void this.baseLayer.assignAnimation(e,t);var n=i?this.findAnimationLayer(i):this.baseLayer;n&&n.assignAnimation(e,t,s,r)}removeNodeAnimations(e,t){var i=t?this.findAnimationLayer(t):this.baseLayer;i&&i.removeNodeAnimations(e)}getParameterValue(e,t){var i=this._parameters[e];if(i&&i.type===t)return i.value}setParameterValue(e,t,i){var s=this._parameters[e];s&&s.type===t&&(s.value=i)}getFloat(e){return this.getParameterValue(e,ng)}setFloat(e,t){this.setParameterValue(e,ng,t)}getInteger(e){return this.getParameterValue(e,rg)}setInteger(e,t){"number"==typeof t&&t%1==0&&this.setParameterValue(e,rg,t)}getBoolean(e){return this.getParameterValue(e,ag)}setBoolean(e,t){this.setParameterValue(e,ag,!!t)}getTrigger(e){return this.getParameterValue(e,og)}setTrigger(e,t){void 0===t&&(t=!1),this.setParameterValue(e,og,!0),t&&this._consumedTriggers.add(e)}resetTrigger(e){this.setParameterValue(e,og,!1)}onBeforeRemove(){Number.isFinite(this._stateGraphAsset)&&this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this)}update(e){for(var t=0;t<this.layers.length;t++)this.layers[t].update(e*this.speed);this._consumedTriggers.forEach((e=>{this.parameters[e].value=!1})),this._consumedTriggers.clear()}resolveDuplicatedEntityReferenceProperties(e,t){e.rootBone&&t[e.rootBone.getGuid()]?this.rootBone=t[e.rootBone.getGuid()]:this.rebind()}constructor(...e){super(...e),this._stateGraphAsset=null,this._animationAssets={},this._speed=1,this._activate=!0,this._playing=!1,this._rootBone=null,this._stateGraph=null,this._layers=[],this._layerIndices={},this._parameters={},this._targets={},this._consumedTriggers=new Set,this._normalizeWeights=!1,this.findParameter=e=>this._parameters[e],this.consumeTrigger=e=>{this._consumedTriggers.add(e)}}}class Vg{constructor(){this.enabled=!0}}var Hg=["enabled"];class Gg extends Jm{initializeComponentData(e,t,i){super.initializeComponentData(e,t,Hg);var s=["animationAssets","stateGraph","layers","masks"];Object.keys(t).forEach((i=>{s.includes(i)||(e[i]=t[i])})),t.stateGraph&&(e.stateGraph=t.stateGraph,e.loadStateGraph(e.stateGraph)),t.layers&&t.layers.forEach(((t,i)=>{t._controller.states.forEach((s=>{t._controller._states[s]._animationList.forEach((s=>{if(s.animTrack&&s.animTrack!==vg.EMPTY)e.layers[i].assignAnimation(s.name,s.animTrack);else{var r=this.app.assets.get(t._component._animationAssets[t.name+":"+s.name].asset);r&&!r.loaded&&r.once("load",(()=>{e.layers[i].assignAnimation(s.name,r.resource)}))}}))}))})),t.animationAssets&&(e.animationAssets=Object.assign(e.animationAssets,t.animationAssets)),t.masks&&Object.keys(t.masks).forEach((i=>{if(e.layers[i]){var s=t.masks[i].mask,r={};Object.keys(s).forEach((e=>{r[decodeURI(e)]=s[e]})),e.layers[i].mask=r}}))}onAnimationUpdate(e){var t=this.store;for(var i in t)if(t.hasOwnProperty(i)){var s=t[i].entity.anim;s.data.enabled&&s.entity.enabled&&s.playing&&s.update(e)}}cloneComponent(e,t){var i;e.anim.rootBone&&e.anim.rootBone!==e||(i={},e.anim.layers.forEach(((e,s)=>{if(e.mask){var r={};Object.keys(e.mask).forEach((i=>{var s=i.split("/");s.shift();var n=[t.name,...s].join("/");r[n]=e.mask[i]})),i[s]={mask:r}}})));var s={enabled:e.anim.enabled,stateGraphAsset:e.anim.stateGraphAsset,animationAssets:e.anim.animationAssets,speed:e.anim.speed,activate:e.anim.activate,playing:e.anim.playing,rootBone:e.anim.rootBone,stateGraph:e.anim.stateGraph,layers:e.anim.layers,layerIndices:e.anim.layerIndices,parameters:e.anim.parameters,normalizeWeights:e.anim.normalizeWeights,masks:i};return this.addComponent(t,s)}onBeforeRemove(e,t){t.onBeforeRemove()}destroy(){super.destroy(),this.app.systems.off("animationUpdate",this.onAnimationUpdate,this)}constructor(e){super(e),this.id="anim",this.ComponentType=Ug,this.DataType=Vg,this.schema=Hg,this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("animationUpdate",this.onAnimationUpdate,this)}}Qm._buildAccessors(Ug.prototype,Hg);var Wg="static",jg="dynamic",qg="kinematic";class Xg{destroy(e){this.map.forEach((e=>e.mesh.destroy()))}constructor(){this.map=new Map}}var Kg=new hr,Yg=(e,t)=>{var i=Kg.get(e,(()=>new Xg)),s=i.map.get(t);if(!s){var r,n;switch(t){case"box":r=Gh.fromGeometry(e,new Qu),n={x:2,y:2,z:2,uv:2/3};break;case"capsule":r=Gh.fromGeometry(e,new vp({radius:.5,height:2})),n={x:2*Math.PI,y:Math.PI,z:2*Math.PI,uv:1/3+1/3/3*2};break;case"cone":r=Gh.fromGeometry(e,new _p({baseRadius:.5,peakRadius:0,height:1})),n={x:2.54,y:2.54,z:2.54,uv:1/3+1/3/3};break;case"cylinder":r=Gh.fromGeometry(e,new bp({radius:.5,height:1})),n={x:Math.PI,y:1.58,z:Math.PI,uv:1/3+1/3/3*2};break;case"plane":r=Gh.fromGeometry(e,new yp({halfExtents:new di(.5,.5),widthSegments:1,lengthSegments:1})),n={x:0,y:1,z:0,uv:1};break;case"sphere":r=Gh.fromGeometry(e,new Ju({radius:.5})),n={x:Math.PI,y:Math.PI,z:Math.PI,uv:1};break;case"torus":r=Gh.fromGeometry(e,new xp({tubeRadius:.2,ringRadius:.3})),n={x:.5*Math.PI*.5-.1*Math.PI*.1,y:.4,z:.4,uv:1};break;default:throw new Error("Invalid primitive type: "+t)}r.incRefCount(),s={mesh:r,area:n},i.map.set(t,s)}return s};class Qg extends gn{constructor(e,t){super(),this.skin=e,this.skinInstance=t}}class Jg{static createCachedSkinInstance(e,t,i){var s=Jg.getCachedSkinInstance(e,t);return s||((s=new zh(e)).resolve(t,i),Jg.addCachedSkinInstance(e,t,s)),s}static getCachedSkinInstance(e,t){var i=null,s=Jg._skinInstanceCache.get(t);if(s){var r=s.find((t=>t.skin===e));r&&(r.incRefCount(),i=r.skinInstance)}return i}static addCachedSkinInstance(e,t,i){var s=Jg._skinInstanceCache.get(t);s||(s=[],Jg._skinInstanceCache.set(t,s));var r=s.find((t=>t.skin===e));r||(r=new Qg(e,i),s.push(r)),r.incRefCount()}static removeCachedSkinInstance(e){if(e){var t=e.rootBone;if(t){var i=Jg._skinInstanceCache.get(t);if(i){var s=i.findIndex((t=>t.skinInstance===e));if(s>=0){var r=i[s];r.decRefCount(),0===r.refCount&&(i.splice(s,1),i.length||Jg._skinInstanceCache.delete(t),e&&(e.destroy(),r.skinInstance=null))}}}}}}Jg._skinInstanceCache=new Map;class $g{set id(e){if(this.url)throw Error("Can't set id and url");this._unbind(),this._id=e,this.asset=this._registry.get(this._id),this._bind()}get id(){return this._id}set url(e){if(this.id)throw Error("Can't set id and url");this._unbind(),this._url=e,this.asset=this._registry.getByUrl(this._url),this._bind()}get url(){return this._url}_bind(){this.id&&(this._onAssetLoad&&(this._evtLoadById=this._registry.on("load:"+this.id,this._onLoad,this)),this._onAssetAdd&&(this._evtAddById=this._registry.once("add:"+this.id,this._onAdd,this)),this._onAssetRemove&&(this._evtRemoveById=this._registry.on("remove:"+this.id,this._onRemove,this)),this._onAssetUnload&&(this._evtUnloadById=this._registry.on("unload:"+this.id,this._onUnload,this))),this.url&&(this._onAssetLoad&&(this._evtLoadByUrl=this._registry.on("load:url:"+this.url,this._onLoad,this)),this._onAssetAdd&&(this._evtAddByUrl=this._registry.once("add:url:"+this.url,this._onAdd,this)),this._onAssetRemove&&(this._evtRemoveByUrl=this._registry.on("remove:url:"+this.url,this._onRemove,this)))}_unbind(){var e,t,i,s,r,n,a;this.id&&(null==(e=this._evtLoadById)||e.off(),this._evtLoadById=null,null==(t=this._evtAddById)||t.off(),this._evtAddById=null,null==(i=this._evtRemoveById)||i.off(),this._evtRemoveById=null,null==(s=this._evtUnloadById)||s.off(),this._evtUnloadById=null);this.url&&(null==(r=this._evtLoadByUrl)||r.off(),this._evtLoadByUrl=null,null==(n=this._evtAddByUrl)||n.off(),this._evtAddByUrl=null,null==(a=this._evtRemoveByUrl)||a.off(),this._evtRemoveByUrl=null)}_onLoad(e){this._onAssetLoad.call(this._scope,this.propertyName,this.parent,e)}_onAdd(e){this.asset=e,this._onAssetAdd.call(this._scope,this.propertyName,this.parent,e)}_onRemove(e){this._onAssetRemove.call(this._scope,this.propertyName,this.parent,e),this.asset=null}_onUnload(e){this._onAssetUnload.call(this._scope,this.propertyName,this.parent,e)}constructor(e,t,i,s,r){this._evtLoadById=null,this._evtUnloadById=null,this._evtAddById=null,this._evtRemoveById=null,this._evtLoadByUrl=null,this._evtAddByUrl=null,this._evtRemoveByUrl=null,this.propertyName=e,this.parent=t,this._scope=r,this._registry=i,this.id=null,this.url=null,this.asset=null,this._onAssetLoad=s.load,this._onAssetAdd=s.add,this._onAssetRemove=s.remove,this._onAssetUnload=s.unload}}class Zg extends Qm{set renderStyle(e){this._renderStyle!==e&&(this._renderStyle=e,tc._prepareRenderStyleForArray(this._meshInstances,e))}get renderStyle(){return this._renderStyle}set customAabb(e){this._customAabb=e;var t=this._meshInstances;if(t)for(var i=0;i<t.length;i++)t[i].setCustomAabb(this._customAabb)}get customAabb(){return this._customAabb}set type(e){if(this._type!==e&&(this._area=null,this._type=e,this.destroyMeshInstances(),"asset"!==e)){var t=this._material;t&&t!==this.system.defaultMaterial||(t=this._materialReferences[0]&&this._materialReferences[0].asset&&this._materialReferences[0].asset.resource);var i=Yg(this.system.app.graphicsDevice,e);this._area=i.area,this.meshInstances=[new tc(i.mesh,t||this.system.defaultMaterial,this.entity)]}}get type(){return this._type}set meshInstances(e){if(this.destroyMeshInstances(),this._meshInstances=e,this._meshInstances){for(var t=this._meshInstances,i=0;i<t.length;i++)t[i].node||(t[i].node=this.entity),t[i].castShadow=this._castShadows,t[i].receiveShadow=this._receiveShadows,t[i].renderStyle=this._renderStyle,t[i].setLightmapped(this._lightmapped),t[i].setCustomAabb(this._customAabb);this.enabled&&this.entity.enabled&&this.addToLayers()}}get meshInstances(){return this._meshInstances}set lightmapped(e){if(e!==this._lightmapped){this._lightmapped=e;var t=this._meshInstances;if(t)for(var i=0;i<t.length;i++)t[i].setLightmapped(e)}}get lightmapped(){return this._lightmapped}set castShadows(e){if(this._castShadows!==e){var t=this._meshInstances;if(t){var i=this.layers,s=this.system.app.scene;if(this._castShadows&&!e)for(var r=0;r<i.length;r++){var n=s.layers.getLayerById(this.layers[r]);n&&n.removeShadowCasters(t)}for(var a=0;a<t.length;a++)t[a].castShadow=e;if(!this._castShadows&&e)for(var o=0;o<i.length;o++){var l=s.layers.getLayerById(i[o]);l&&l.addShadowCasters(t)}}this._castShadows=e}}get castShadows(){return this._castShadows}set receiveShadows(e){if(this._receiveShadows!==e){this._receiveShadows=e;var t=this._meshInstances;if(t)for(var i=0;i<t.length;i++)t[i].receiveShadow=e}}get receiveShadows(){return this._receiveShadows}set castShadowsLightmap(e){this._castShadowsLightmap=e}get castShadowsLightmap(){return this._castShadowsLightmap}set lightmapSizeMultiplier(e){this._lightmapSizeMultiplier=e}get lightmapSizeMultiplier(){return this._lightmapSizeMultiplier}set layers(e){var t,i=this.system.app.scene.layers;if(this._meshInstances)for(var s=0;s<this._layers.length;s++)(t=i.getLayerById(this._layers[s]))&&t.removeMeshInstances(this._meshInstances);this._layers.length=0;for(var r=0;r<e.length;r++)this._layers[r]=e[r];if(this.enabled&&this.entity.enabled&&this._meshInstances)for(var n=0;n<this._layers.length;n++)(t=i.getLayerById(this._layers[n]))&&t.addMeshInstances(this._meshInstances)}get layers(){return this._layers}set batchGroupId(e){if(this._batchGroupId!==e){var t,i;if(this.entity.enabled&&this._batchGroupId>=0)null==(t=this.system.app.batcher)||t.remove(Bh.RENDER,this.batchGroupId,this.entity);if(this.entity.enabled&&e>=0)null==(i=this.system.app.batcher)||i.insert(Bh.RENDER,e,this.entity);e<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addToLayers(),this._batchGroupId=e}}get batchGroupId(){return this._batchGroupId}set material(e){if(this._material!==e&&(this._material=e,this._meshInstances&&"asset"!==this._type))for(var t=0;t<this._meshInstances.length;t++)this._meshInstances[t].material=e}get material(){return this._material}set materialAssets(e){if(void 0===e&&(e=[]),this._materialReferences.length>e.length){for(var t=e.length;t<this._materialReferences.length;t++)this._materialReferences[t].id=null;this._materialReferences.length=e.length}for(var i=0;i<e.length;i++)if(this._materialReferences[i]||this._materialReferences.push(new $g(i,this,this.system.app.assets,{add:this._onMaterialAdded,load:this._onMaterialLoad,remove:this._onMaterialRemove,unload:this._onMaterialUnload},this)),e[i]){var s=e[i]instanceof fm?e[i].id:e[i];this._materialReferences[i].id!==s&&(this._materialReferences[i].id=s),this._materialReferences[i].asset&&this._onMaterialAdded(i,this,this._materialReferences[i].asset)}else this._materialReferences[i].id=null,this._meshInstances[i]&&(this._meshInstances[i].material=this.system.defaultMaterial)}get materialAssets(){return this._materialReferences.map((e=>e.id))}set asset(e){var t=e instanceof fm?e.id:e;this._assetReference.id!==t&&(this._assetReference.asset&&this._assetReference.asset.resource&&this._onRenderAssetRemove(),this._assetReference.id=t,this._assetReference.asset&&this._onRenderAssetAdded())}get asset(){return this._assetReference.id}assignAsset(e){var t=e instanceof fm?e.id:e;this._assetReference.id=t}set rootBone(e){if(this._rootBone!==e){var t="string"==typeof e;if(this._rootBone&&t&&this._rootBone.getGuid()===e)return;this._rootBone&&this._clearSkinInstances(),this._rootBone=e instanceof Lc?e:t&&this.system.app.getEntityFromIndex(e)||null,this._rootBone&&this._cloneSkinInstances()}}get rootBone(){return this._rootBone}destroyMeshInstances(){var e=this._meshInstances;if(e){this.removeFromLayers(),this._clearSkinInstances();for(var t=0;t<e.length;t++)e[t].destroy();this._meshInstances.length=0}}addToLayers(){for(var e=this.system.app.scene.layers,t=0;t<this._layers.length;t++){var i=e.getLayerById(this._layers[t]);i&&i.addMeshInstances(this._meshInstances)}}removeFromLayers(){if(this._meshInstances&&this._meshInstances.length)for(var e=this.system.app.scene.layers,t=0;t<this._layers.length;t++){var i=e.getLayerById(this._layers[t]);i&&i.removeMeshInstances(this._meshInstances)}}onRemoveChild(){this.removeFromLayers()}onInsertChild(){this._meshInstances&&this.enabled&&this.entity.enabled&&this.addToLayers()}onRemove(){this.destroyMeshInstances(),this.asset=null,this.materialAsset=null,this._assetReference.id=null;for(var e=0;e<this._materialReferences.length;e++)this._materialReferences[e].id=null;this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(e,t){this.addToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||e.addMeshInstances(this._meshInstances)}onLayerRemoved(e){this.layers.indexOf(e.id)<0||e.removeMeshInstances(this._meshInstances)}onEnable(){var e=this.system.app,t=e.scene,i=t.layers;this._rootBone&&this._cloneSkinInstances(),this._evtLayersChanged=t.on("set:layers",this.onLayersChanged,this),i&&(this._evtLayerAdded=i.on("add",this.onLayerAdded,this),this._evtLayerRemoved=i.on("remove",this.onLayerRemoved,this));var s,r="asset"===this._type;this._meshInstances&&this._meshInstances.length?this.addToLayers():r&&this.asset&&this._onRenderAssetAdded();for(var n=0;n<this._materialReferences.length;n++)this._materialReferences[n].asset&&this.system.app.assets.load(this._materialReferences[n].asset);this._batchGroupId>=0&&(null==(s=e.batcher)||s.insert(Bh.RENDER,this.batchGroupId,this.entity))}onDisable(){var e,t,i,s,r=this.system.app,n=r.scene.layers;(null==(e=this._evtLayersChanged)||e.off(),this._evtLayersChanged=null,this._rootBone&&this._clearSkinInstances(),n)&&(null==(t=this._evtLayerAdded)||t.off(),this._evtLayerAdded=null,null==(i=this._evtLayerRemoved)||i.off(),this._evtLayerRemoved=null);this._batchGroupId>=0&&(null==(s=r.batcher)||s.remove(Bh.RENDER,this.batchGroupId,this.entity));this.removeFromLayers()}hide(){if(this._meshInstances)for(var e=0;e<this._meshInstances.length;e++)this._meshInstances[e].visible=!1}show(){if(this._meshInstances)for(var e=0;e<this._meshInstances.length;e++)this._meshInstances[e].visible=!0}_onRenderAssetAdded(){this._assetReference.asset&&(this._assetReference.asset.resource?this._onRenderAssetLoad():this.enabled&&this.entity.enabled&&this.system.app.assets.load(this._assetReference.asset))}_onRenderAssetLoad(){if(this.destroyMeshInstances(),this._assetReference.asset){var e,t=this._assetReference.asset.resource;null==(e=this._evtSetMeshes)||e.off(),this._evtSetMeshes=t.on("set:meshes",this._onSetMeshes,this),t.meshes&&this._onSetMeshes(t.meshes)}}_onSetMeshes(e){this._cloneMeshes(e)}_clearSkinInstances(){for(var e=0;e<this._meshInstances.length;e++){var t=this._meshInstances[e];Jg.removeCachedSkinInstance(t.skinInstance),t.skinInstance=null}}_cloneSkinInstances(){if(this._meshInstances.length&&this._rootBone instanceof Lc)for(var e=0;e<this._meshInstances.length;e++){var t=this._meshInstances[e],i=t.mesh;i.skin&&!t.skinInstance&&(t.skinInstance=Jg.createCachedSkinInstance(i.skin,this._rootBone,this.entity))}}_cloneMeshes(e){if(e&&e.length){for(var t=[],i=0;i<e.length;i++){var s=e[i],r=this._materialReferences[i]&&this._materialReferences[i].asset&&this._materialReferences[i].asset.resource,n=new tc(s,r||this.system.defaultMaterial,this.entity);t.push(n),s.morph&&(n.morphInstance=new Fu(s.morph))}this.meshInstances=t,this._cloneSkinInstances()}}_onRenderAssetUnload(){"asset"===this._type&&this.destroyMeshInstances()}_onRenderAssetRemove(){var e;null==(e=this._evtSetMeshes)||e.off(),this._evtSetMeshes=null,this._onRenderAssetUnload()}_onMaterialAdded(e,t,i){i.resource?this._onMaterialLoad(e,t,i):this.enabled&&this.entity.enabled&&this.system.app.assets.load(i)}_updateMainMaterial(e,t){0===e&&(this.material=t)}_onMaterialLoad(e,t,i){this._meshInstances[e]&&(this._meshInstances[e].material=i.resource),this._updateMainMaterial(e,i.resource)}_onMaterialRemove(e,t,i){this._meshInstances[e]&&(this._meshInstances[e].material=this.system.defaultMaterial),this._updateMainMaterial(e,this.system.defaultMaterial)}_onMaterialUnload(e,t,i){this._meshInstances[e]&&(this._meshInstances[e].material=this.system.defaultMaterial),this._updateMainMaterial(e,this.system.defaultMaterial)}resolveDuplicatedEntityReferenceProperties(e,t){e.rootBone&&(this.rootBone=t[e.rootBone.getGuid()])}constructor(e,t){super(e,t),this._type="asset",this._castShadows=!0,this._receiveShadows=!0,this._castShadowsLightmap=!0,this._lightmapped=!1,this._lightmapSizeMultiplier=1,this.isStatic=!1,this._batchGroupId=-1,this._layers=[0],this._renderStyle=0,this._meshInstances=[],this._customAabb=null,this._area=null,this._materialReferences=[],this._rootBone=null,this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._evtSetMeshes=null,this._assetReference=new $g("asset",this,e.app.assets,{add:this._onRenderAssetAdded,load:this._onRenderAssetLoad,remove:this._onRenderAssetRemove,unload:this._onRenderAssetUnload},this),this._material=e.defaultMaterial,t.on("remove",this.onRemoveChild,this),t.on("removehierarchy",this.onRemoveChild,this),t.on("insert",this.onInsertChild,this),t.on("inserthierarchy",this.onInsertChild,this)}}class ev{constructor(){this.enabled=!0}}var tv,iv,sv,rv,nv=["enabled"],av=["material","meshInstances","asset","materialAssets","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","renderStyle","type","layers","isStatic","batchGroupId","rootBone"];class ov extends Jm{initializeComponentData(e,t,i){null!==t.batchGroupId&&void 0!==t.batchGroupId||(t.batchGroupId=-1),t.layers&&t.layers.length&&(t.layers=t.layers.slice(0));for(var s=0;s<av.length;s++)t.hasOwnProperty(av[s])&&(e[av[s]]=t[av[s]]);t.aabbCenter&&t.aabbHalfExtents&&(e.customAabb=new Ci(new hi(t.aabbCenter),new hi(t.aabbHalfExtents))),super.initializeComponentData(e,t,nv)}cloneComponent(e,t){for(var i={},s=0;s<av.length;s++)i[av[s]]=e.render[av[s]];i.enabled=e.render.enabled,delete i.meshInstances;var r=this.addComponent(t,i),n=e.render.meshInstances,a=n.map((e=>e.mesh));r._onSetMeshes(a);for(var o=0;o<n.length;o++)r.meshInstances[o].material=n[o].material;return e.render.customAabb&&(r.customAabb=e.render.customAabb.clone()),r}onRemove(e,t){t.onRemove()}constructor(e){super(e),this.id="render",this.ComponentType=Zg,this.DataType=ev,this.schema=nv,this.defaultMaterial=jh(e.graphicsDevice),this.on("beforeremove",this.onRemove,this)}}Qm._buildAccessors(Zg.prototype,nv);class lv{_resize(e){if(e>this._pool.length)for(var t=this._pool.length;t<e;t++)this._pool[t]=new this._constructor}allocate(){return this._count>=this._pool.length&&this._resize(2*this._pool.length),this._pool[this._count++]}freeAll(){this._count=0}constructor(e,t){this._pool=[],this._count=0,this._constructor=e,this._resize(t)}}var hv,cv,dv=new bi,uv=new bi,fv=new hi;class pv extends Qm{static onLibraryLoaded(){"undefined"!=typeof Ammo&&(tv=new Ammo.btTransform,iv=new Ammo.btVector3,sv=new Ammo.btVector3,rv=new Ammo.btQuaternion)}static onAppDestroy(){Ammo.destroy(tv),Ammo.destroy(iv),Ammo.destroy(sv),Ammo.destroy(rv),tv=null,iv=null,sv=null,rv=null}set angularDamping(e){this._angularDamping!==e&&(this._angularDamping=e,this._body&&this._body.setDamping(this._linearDamping,e))}get angularDamping(){return this._angularDamping}set angularFactor(e){this._angularFactor.equals(e)||(this._angularFactor.copy(e),this._body&&this._type===jg&&(iv.setValue(e.x,e.y,e.z),this._body.setAngularFactor(iv)))}get angularFactor(){return this._angularFactor}set angularVelocity(e){this._body&&this._type===jg&&(this._body.activate(),iv.setValue(e.x,e.y,e.z),this._body.setAngularVelocity(iv),this._angularVelocity.copy(e))}get angularVelocity(){if(this._body&&this._type===jg){var e=this._body.getAngularVelocity();this._angularVelocity.set(e.x(),e.y(),e.z())}return this._angularVelocity}set body(e){this._body!==e&&(this._body=e,e&&this._simulationEnabled&&e.activate())}get body(){return this._body}set friction(e){this._friction!==e&&(this._friction=e,this._body&&this._body.setFriction(e))}get friction(){return this._friction}set group(e){this._group!==e&&(this._group=e,this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation()))}get group(){return this._group}set linearDamping(e){this._linearDamping!==e&&(this._linearDamping=e,this._body&&this._body.setDamping(e,this._angularDamping))}get linearDamping(){return this._linearDamping}set linearFactor(e){this._linearFactor.equals(e)||(this._linearFactor.copy(e),this._body&&this._type===jg&&(iv.setValue(e.x,e.y,e.z),this._body.setLinearFactor(iv)))}get linearFactor(){return this._linearFactor}set linearVelocity(e){this._body&&this._type===jg&&(this._body.activate(),iv.setValue(e.x,e.y,e.z),this._body.setLinearVelocity(iv),this._linearVelocity.copy(e))}get linearVelocity(){if(this._body&&this._type===jg){var e=this._body.getLinearVelocity();this._linearVelocity.set(e.x(),e.y(),e.z())}return this._linearVelocity}set mask(e){this._mask!==e&&(this._mask=e,this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation()))}get mask(){return this._mask}set mass(e){if(this._mass!==e&&(this._mass=e,this._body&&this._type===jg)){var t=this.enabled&&this.entity.enabled;t&&this.disableSimulation(),this._body.getCollisionShape().calculateLocalInertia(e,iv),this._body.setMassProps(e,iv),this._body.updateInertiaTensor(),t&&this.enableSimulation()}}get mass(){return this._mass}set restitution(e){this._restitution!==e&&(this._restitution=e,this._body&&this._body.setRestitution(e))}get restitution(){return this._restitution}set rollingFriction(e){this._rollingFriction!==e&&(this._rollingFriction=e,this._body&&this._body.setRollingFriction(e))}get rollingFriction(){return this._rollingFriction}set type(e){if(this._type!==e){switch(this._type=e,this.disableSimulation(),e){case jg:this._group=1,this._mask=65535;break;case qg:this._group=4,this._mask=65535;break;default:this._group=2,this._mask=65533}this.createBody()}}get type(){return this._type}createBody(){var e,t=this.entity;if(t.collision&&(e=t.collision.shape,t.trigger&&(t.trigger.destroy(),delete t.trigger)),e){this._body&&(this.system.removeBody(this._body),this.system.destroyBody(this._body),this._body=null);var i=this._type===jg?this._mass:0;this._getEntityTransform(tv);var s=this.system.createBody(i,e,tv);if(s.setRestitution(this._restitution),s.setFriction(this._friction),s.setRollingFriction(this._rollingFriction),s.setDamping(this._linearDamping,this._angularDamping),this._type===jg){var r=this._linearFactor;iv.setValue(r.x,r.y,r.z),s.setLinearFactor(iv);var n=this._angularFactor;iv.setValue(n.x,n.y,n.z),s.setAngularFactor(iv)}else this._type===qg&&(s.setCollisionFlags(2|s.getCollisionFlags()),s.setActivationState(4));s.entity=t,this.body=s,this.enabled&&t.enabled&&this.enableSimulation()}}isActive(){return!!this._body&&this._body.isActive()}activate(){this._body&&this._body.activate()}enableSimulation(){var e=this.entity;if(e.collision&&e.collision.enabled&&!this._simulationEnabled){var t=this._body;if(t){switch(this.system.addBody(t,this._group,this._mask),this._type){case jg:this.system._dynamic.push(this),t.forceActivationState(1),this.syncEntityToBody();break;case qg:this.system._kinematic.push(this),t.forceActivationState(4);break;case Wg:t.forceActivationState(1),this.syncEntityToBody()}"compound"===e.collision.type&&this.system._compounds.push(e.collision),t.activate(),this._simulationEnabled=!0}}}disableSimulation(){var e=this._body;if(e&&this._simulationEnabled){var t=this.system,i=t._compounds.indexOf(this.entity.collision);i>-1&&t._compounds.splice(i,1),(i=t._dynamic.indexOf(this))>-1&&t._dynamic.splice(i,1),(i=t._kinematic.indexOf(this))>-1&&t._kinematic.splice(i,1),t.removeBody(e),e.forceActivationState(5),this._simulationEnabled=!1}}applyForce(e,t,i,s,r,n){var a=this._body;a&&(a.activate(),e instanceof hi?iv.setValue(e.x,e.y,e.z):iv.setValue(e,t,i),t instanceof hi?sv.setValue(t.x,t.y,t.z):void 0!==s?sv.setValue(s,r,n):sv.setValue(0,0,0),a.applyForce(iv,sv))}applyTorque(e,t,i){var s=this._body;s&&(s.activate(),e instanceof hi?iv.setValue(e.x,e.y,e.z):iv.setValue(e,t,i),s.applyTorque(iv))}applyImpulse(e,t,i,s,r,n){var a=this._body;a&&(a.activate(),e instanceof hi?iv.setValue(e.x,e.y,e.z):iv.setValue(e,t,i),t instanceof hi?sv.setValue(t.x,t.y,t.z):void 0!==s?sv.setValue(s,r,n):sv.setValue(0,0,0),a.applyImpulse(iv,sv))}applyTorqueImpulse(e,t,i){var s=this._body;s&&(s.activate(),e instanceof hi?iv.setValue(e.x,e.y,e.z):iv.setValue(e,t,i),s.applyTorqueImpulse(iv))}isStatic(){return this._type===Wg}isStaticOrKinematic(){return this._type===Wg||this._type===qg}isKinematic(){return this._type===qg}_getEntityTransform(e){var t=this.entity,i=t.collision;if(i){var s=i.getShapePosition(),r=i.getShapeRotation();iv.setValue(s.x,s.y,s.z),rv.setValue(r.x,r.y,r.z,r.w)}else{var n=t.getPosition(),a=t.getRotation();iv.setValue(n.x,n.y,n.z),rv.setValue(a.x,a.y,a.z,a.w)}e.setOrigin(iv),e.setRotation(rv)}syncEntityToBody(){var e=this._body;if(e){if(this._getEntityTransform(tv),e.setWorldTransform(tv),this._type===qg){var t=e.getMotionState();t&&t.setWorldTransform(tv)}e.activate()}}_updateDynamic(){var e=this._body;if(e.isActive()){var t=e.getMotionState();if(t){var i=this.entity;t.getWorldTransform(tv);var s=tv.getOrigin(),r=tv.getRotation(),n=i.collision;if(n&&n._hasOffset){var a=n.data.linearOffset,o=n.data.angularOffset,l=uv.copy(o).invert(),h=dv.set(r.x(),r.y(),r.z(),r.w()).mul(l);h.transformVector(a,fv),i.setPosition(s.x()-fv.x,s.y()-fv.y,s.z()-fv.z),i.setRotation(h)}else i.setPosition(s.x(),s.y(),s.z()),i.setRotation(r.x(),r.y(),r.z(),r.w())}}}_updateKinematic(){var e=this._body.getMotionState();e&&(this._getEntityTransform(tv),e.setWorldTransform(tv))}teleport(e,t,i,s,r,n){e instanceof hi?this.entity.setPosition(e):this.entity.setPosition(e,t,i),t instanceof bi?this.entity.setRotation(t):t instanceof hi?this.entity.setEulerAngles(t):void 0!==s&&this.entity.setEulerAngles(s,r,n),this.syncEntityToBody()}onEnable(){this._body||this.createBody(),this.enableSimulation()}onDisable(){this.disableSimulation()}constructor(...e){super(...e),this._angularDamping=0,this._angularFactor=new hi(1,1,1),this._angularVelocity=new hi,this._body=null,this._friction=.5,this._group=2,this._linearDamping=0,this._linearFactor=new hi(1,1,1),this._linearVelocity=new hi,this._mask=65533,this._mass=1,this._restitution=0,this._rollingFriction=0,this._simulationEnabled=!1,this._type=Wg}}pv.EVENT_CONTACT="contact",pv.EVENT_COLLISIONSTART="collisionstart",pv.EVENT_COLLISIONEND="collisionend",pv.EVENT_TRIGGERENTER="triggerenter",pv.EVENT_TRIGGERLEAVE="triggerleave",pv.order=-1;class mv{constructor(){this.enabled=!0}}class gv{constructor(e,t,i,s){this.entity=e,this.point=t,this.normal=i,this.hitFraction=s}}class vv{constructor(e,t,i){0!==arguments.length?(this.a=e,this.b=t,this.impulse=i.impulse,this.localPointA=i.localPoint,this.localPointB=i.localPointOther,this.pointA=i.point,this.pointB=i.pointOther,this.normal=i.normal):(this.a=null,this.b=null,this.impulse=0,this.localPointA=new hi,this.localPointB=new hi,this.pointA=new hi,this.pointB=new hi,this.normal=new hi)}}class _v{constructor(e=new hi,t=new hi,i=new hi,s=new hi,r=new hi,n=0){this.localPoint=e,this.localPointOther=t,this.point=i,this.pointOther=s,this.normal=r,this.impulse=n}}class bv{constructor(e,t){this.other=e,this.contacts=t}}var yv=["enabled"];class xv extends Jm{onLibraryLoaded(){if("undefined"!=typeof Ammo){if(this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration,this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration),this.overlappingPairCache=new Ammo.btDbvtBroadphase,this.solver=new Ammo.btSequentialImpulseConstraintSolver,this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration),this.dynamicsWorld.setInternalTickCallback){var e=Ammo.addFunction(this._checkForCollisions.bind(this),"vif");this.dynamicsWorld.setInternalTickCallback(e)}hv=new Ammo.btVector3,cv=new Ammo.btVector3,pv.onLibraryLoaded(),this.contactPointPool=new lv(_v,1),this.contactResultPool=new lv(bv,1),this.singleContactResultPool=new lv(vv,1),this.app.systems.on("update",this.onUpdate,this)}else this.app.systems.off("update",this.onUpdate,this)}initializeComponentData(e,t,i){for(var s of["mass","linearDamping","angularDamping","linearFactor","angularFactor","friction","rollingFriction","restitution","type","group","mask"])if(t.hasOwnProperty(s)){var r=t[s];Array.isArray(r)?e[s]=new hi(r[0],r[1],r[2]):e[s]=r}super.initializeComponentData(e,t,["enabled"])}cloneComponent(e,t){var i=e.rigidbody,s={enabled:i.enabled,mass:i.mass,linearDamping:i.linearDamping,angularDamping:i.angularDamping,linearFactor:[i.linearFactor.x,i.linearFactor.y,i.linearFactor.z],angularFactor:[i.angularFactor.x,i.angularFactor.y,i.angularFactor.z],friction:i.friction,rollingFriction:i.rollingFriction,restitution:i.restitution,type:i.type,group:i.group,mask:i.mask};return this.addComponent(t,s)}onBeforeRemove(e,t){t.enabled&&(t.enabled=!1),t.body&&(this.destroyBody(t.body),t.body=null)}addBody(e,t,i){void 0!==t&&void 0!==i?this.dynamicsWorld.addRigidBody(e,t,i):this.dynamicsWorld.addRigidBody(e)}removeBody(e){this.dynamicsWorld.removeRigidBody(e)}createBody(e,t,i){var s=new Ammo.btVector3(0,0,0);0!==e&&t.calculateLocalInertia(e,s);var r=new Ammo.btDefaultMotionState(i),n=new Ammo.btRigidBodyConstructionInfo(e,r,t,s),a=new Ammo.btRigidBody(n);return Ammo.destroy(n),Ammo.destroy(s),a}destroyBody(e){var t=e.getMotionState();t&&Ammo.destroy(t),Ammo.destroy(e)}raycastFirst(e,t,i){if(void 0===i&&(i={}),i.filterTags||i.filterCallback)return i.sort=!0,this.raycastAll(e,t,i)[0]||null;var s=null;hv.setValue(e.x,e.y,e.z),cv.setValue(t.x,t.y,t.z);var r=new Ammo.ClosestRayResultCallback(hv,cv);if("number"==typeof i.filterCollisionGroup&&r.set_m_collisionFilterGroup(i.filterCollisionGroup),"number"==typeof i.filterCollisionMask&&r.set_m_collisionFilterMask(i.filterCollisionMask),this.dynamicsWorld.rayTest(hv,cv,r),r.hasHit()){var n=r.get_m_collisionObject(),a=Ammo.castObject(n,Ammo.btRigidBody);if(a){var o=r.get_m_hitPointWorld(),l=r.get_m_hitNormalWorld();s=new gv(a.entity,new hi(o.x(),o.y(),o.z()),new hi(l.x(),l.y(),l.z()),r.get_m_closestHitFraction())}}return Ammo.destroy(r),s}raycastAll(e,t,i){void 0===i&&(i={});var s=[];hv.setValue(e.x,e.y,e.z),cv.setValue(t.x,t.y,t.z);var r=new Ammo.AllHitsRayResultCallback(hv,cv);if("number"==typeof i.filterCollisionGroup&&r.set_m_collisionFilterGroup(i.filterCollisionGroup),"number"==typeof i.filterCollisionMask&&r.set_m_collisionFilterMask(i.filterCollisionMask),this.dynamicsWorld.rayTest(hv,cv,r),r.hasHit()){for(var n=r.get_m_collisionObjects(),a=r.get_m_hitPointWorld(),o=r.get_m_hitNormalWorld(),l=r.get_m_hitFractions(),h=n.size(),c=0;c<h;c++){var d=Ammo.castObject(n.at(c),Ammo.btRigidBody);if(d&&d.entity){if(i.filterTags&&!d.entity.tags.has(...i.filterTags)||i.filterCallback&&!i.filterCallback(d.entity))continue;var u=a.at(c),f=o.at(c),p=new gv(d.entity,new hi(u.x(),u.y(),u.z()),new hi(f.x(),f.y(),f.z()),l.at(c));s.push(p)}}i.sort&&s.sort(((e,t)=>e.hitFraction-t.hitFraction))}return Ammo.destroy(r),s}_storeCollision(e,t){var i=!1,s=e.getGuid();return this.collisions[s]=this.collisions[s]||{others:[],entity:e},this.collisions[s].others.indexOf(t)<0&&(this.collisions[s].others.push(t),i=!0),this.frameCollisions[s]=this.frameCollisions[s]||{others:[],entity:e},this.frameCollisions[s].others.push(t),i}_createContactPointFromAmmo(e){var t=e.get_m_localPointA(),i=e.get_m_localPointB(),s=e.getPositionWorldOnA(),r=e.getPositionWorldOnB(),n=e.get_m_normalWorldOnB(),a=this.contactPointPool.allocate();return a.localPoint.set(t.x(),t.y(),t.z()),a.localPointOther.set(i.x(),i.y(),i.z()),a.point.set(s.x(),s.y(),s.z()),a.pointOther.set(r.x(),r.y(),r.z()),a.normal.set(n.x(),n.y(),n.z()),a.impulse=e.getAppliedImpulse(),a}_createReverseContactPointFromAmmo(e){var t=e.get_m_localPointA(),i=e.get_m_localPointB(),s=e.getPositionWorldOnA(),r=e.getPositionWorldOnB(),n=e.get_m_normalWorldOnB(),a=this.contactPointPool.allocate();return a.localPointOther.set(t.x(),t.y(),t.z()),a.localPoint.set(i.x(),i.y(),i.z()),a.pointOther.set(s.x(),s.y(),s.z()),a.point.set(r.x(),r.y(),r.z()),a.normal.set(n.x(),n.y(),n.z()),a.impulse=e.getAppliedImpulse(),a}_createSingleContactResult(e,t,i){var s=this.singleContactResultPool.allocate();return s.a=e,s.b=t,s.localPointA=i.localPoint,s.localPointB=i.localPointOther,s.pointA=i.point,s.pointB=i.pointOther,s.normal=i.normal,s.impulse=i.impulse,s}_createContactResult(e,t){var i=this.contactResultPool.allocate();return i.other=e,i.contacts=t,i}_cleanOldCollisions(){for(var e in this.collisions)if(this.collisions.hasOwnProperty(e)){for(var t=this.frameCollisions[e],i=this.collisions[e],s=i.entity,r=s.collision,n=s.rigidbody,a=i.others,o=a.length;o--;){var l=a[o];(!t||t.others.indexOf(l)<0)&&(a.splice(o,1),s.trigger?(r&&r.fire("triggerleave",l),l.rigidbody&&l.rigidbody.fire("triggerleave",s)):l.trigger||(n&&n.fire("collisionend",l),r&&r.fire("collisionend",l)))}0===a.length&&delete this.collisions[e]}}_hasContactEvent(e){var t=e.collision;if(t&&(t.hasEvent("collisionstart")||t.hasEvent("collisionend")||t.hasEvent("contact")))return!0;var i=e.rigidbody;return i&&(i.hasEvent("collisionstart")||i.hasEvent("collisionend")||i.hasEvent("contact"))}_checkForCollisions(e,t){var i=Ammo.wrapPointer(e,Ammo.btDynamicsWorld).getDispatcher(),s=i.getNumManifolds();this.frameCollisions={};for(var r=0;r<s;r++){var n=i.getManifoldByIndexInternal(r),a=n.getBody0(),o=n.getBody1(),l=Ammo.castObject(a,Ammo.btRigidBody),h=Ammo.castObject(o,Ammo.btRigidBody),c=l.entity,d=h.entity;if(c&&d){var u=l.getCollisionFlags(),f=h.getCollisionFlags(),p=n.getNumContacts(),m=[],g=[],v=void 0;if(p>0)if(4&u||4&f){var _=c.collision&&(c.collision.hasEvent("triggerenter")||c.collision.hasEvent("triggerleave")),b=d.collision&&(d.collision.hasEvent("triggerenter")||d.collision.hasEvent("triggerleave")),y=c.rigidbody&&(c.rigidbody.hasEvent("triggerenter")||c.rigidbody.hasEvent("triggerleave")),x=d.rigidbody&&(d.rigidbody.hasEvent("triggerenter")||d.rigidbody.hasEvent("triggerleave"));_&&(!(v=this._storeCollision(c,d))||4&f||c.collision.fire("triggerenter",d)),b&&(!(v=this._storeCollision(d,c))||4&u||d.collision.fire("triggerenter",c)),y&&(v||(v=this._storeCollision(d,c)),v&&c.rigidbody.fire("triggerenter",d)),x&&(v||(v=this._storeCollision(c,d)),v&&d.rigidbody.fire("triggerenter",c))}else{var S=this._hasContactEvent(c),w=this._hasContactEvent(d),T=this.hasEvent("contact");if(T||S||w){for(var C=0;C<p;C++){var E=n.getContactPoint(C),A=this._createContactPointFromAmmo(E);if(S||w){m.push(A);var P=this._createReverseContactPointFromAmmo(E);g.push(P)}if(T){var D=this._createSingleContactResult(c,d,A);this.fire("contact",D)}}if(S){var L=this._createContactResult(d,m);v=this._storeCollision(c,d),c.collision&&(c.collision.fire("contact",L),v&&c.collision.fire("collisionstart",L)),c.rigidbody&&(c.rigidbody.fire("contact",L),v&&c.rigidbody.fire("collisionstart",L))}if(w){var M=this._createContactResult(c,g);v=this._storeCollision(d,c),d.collision&&(d.collision.fire("contact",M),v&&d.collision.fire("collisionstart",M)),d.rigidbody&&(d.rigidbody.fire("contact",M),v&&d.rigidbody.fire("collisionstart",M))}}}}}this._cleanOldCollisions(),this.contactPointPool.freeAll(),this.contactResultPool.freeAll(),this.singleContactResultPool.freeAll()}onUpdate(e){var t,i;this._gravityFloat32[0]=this.gravity.x,this._gravityFloat32[1]=this.gravity.y,this._gravityFloat32[2]=this.gravity.z;var s=this.dynamicsWorld.getGravity();s.x()===this._gravityFloat32[0]&&s.y()===this._gravityFloat32[1]&&s.z()===this._gravityFloat32[2]||(s.setValue(this.gravity.x,this.gravity.y,this.gravity.z),this.dynamicsWorld.setGravity(s));var r=this._triggers;for(t=0,i=r.length;t<i;t++)r[t].updateTransform();var n=this._compounds;for(t=0,i=n.length;t<i;t++)n[t]._updateCompound();var a=this._kinematic;for(t=0,i=a.length;t<i;t++)a[t]._updateKinematic();this.dynamicsWorld.stepSimulation(e,this.maxSubSteps,this.fixedTimeStep);var o=this._dynamic;for(t=0,i=o.length;t<i;t++)o[t]._updateDynamic();this.dynamicsWorld.setInternalTickCallback||this._checkForCollisions(Ammo.getPointer(this.dynamicsWorld),e)}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this),"undefined"!=typeof Ammo&&(Ammo.destroy(this.dynamicsWorld),Ammo.destroy(this.solver),Ammo.destroy(this.overlappingPairCache),Ammo.destroy(this.dispatcher),Ammo.destroy(this.collisionConfiguration),Ammo.destroy(hv),Ammo.destroy(cv),this.dynamicsWorld=null,this.solver=null,this.overlappingPairCache=null,this.dispatcher=null,this.collisionConfiguration=null,hv=null,cv=null,pv.onAppDestroy())}constructor(e){super(e),this.maxSubSteps=10,this.fixedTimeStep=1/60,this.gravity=new hi(0,-9.81,0),this._gravityFloat32=new Float32Array(3),this._dynamic=[],this._kinematic=[],this._triggers=[],this._compounds=[],this.id="rigidbody",this._stats=e.stats.frame,this.ComponentType=pv,this.DataType=mv,this.contactPointPool=null,this.contactResultPool=null,this.singleContactResultPool=null,this.schema=yv,this.collisions={},this.frameCollisions={},this.on("beforeremove",this.onBeforeRemove,this)}}xv.EVENT_CONTACT="contact",Qm._buildAccessors(pv.prototype,yv);class Sv{constructor(e,t){this.effect=e,this.inputTarget=t,this.outputTarget=null,this.name=e.constructor.name}}class wv{_allocateColorBuffer(e,t){var i,s,r=this.camera.rect,n=this.destinationRenderTarget,a=this.app.graphicsDevice,o=Math.floor(r.z*(null!=(i=null==n?void 0:n.width)?i:a.width)),l=Math.floor(r.w*(null!=(s=null==n?void 0:n.height)?s:a.height));return new ur(a,{name:t,format:e,width:o,height:l,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1})}_createOffscreenTarget(e,t){var i,s,r=this.app.graphicsDevice,n=(null!=(i=this.destinationRenderTarget)?i:r.backBuffer).isColorBufferSrgb(0),a=null!=(s=t&&r.getRenderableHdrFormat([Ri,ki],!0))?s:n?zi:7,o=this.camera.entity.name+"-posteffect-"+this.effects.length,l=this._allocateColorBuffer(a,o);return new Wr({colorBuffer:l,depth:e,stencil:e&&this.app.graphicsDevice.supportsStencil,samples:e?r.samples:1})}_resizeOffscreenTarget(e){var t=e.colorBuffer.format,i=e.colorBuffer.name;e.destroyFrameBuffers(),e.destroyTextureBuffers(),e._colorBuffer=this._allocateColorBuffer(t,i),e._colorBuffers=[e._colorBuffer]}_destroyOffscreenTarget(e){e.destroyTextureBuffers(),e.destroy()}addEffect(e){var t=this.effects,i=0===t.length,s=this._createOffscreenTarget(i,e.hdr),r=new Sv(e,s);t.push(r),this._sourceTarget=r.inputTarget,t.length>1&&(t[t.length-2].outputTarget=r.inputTarget),this._newPostEffect=e,e.needsDepthBuffer&&this._requestDepthMap(),this.enable(),this._newPostEffect=void 0}removeEffect(e){for(var t=-1,i=0,s=this.effects.length;i<s;i++)if(this.effects[i].effect===e){t=i;break}t>=0&&(t>0?this.effects[t-1].outputTarget=t+1<this.effects.length?this.effects[t+1].inputTarget:null:this.effects.length>1&&(this.effects[1].inputTarget._depth||(this._destroyOffscreenTarget(this.effects[1].inputTarget),this.effects[1].inputTarget=this._createOffscreenTarget(!0,this.effects[1].hdr),this._sourceTarget=this.effects[1].inputTarget),this.camera.renderTarget=this.effects[1].inputTarget),this._destroyOffscreenTarget(this.effects[t].inputTarget),this.effects.splice(t,1)),this.enabled&&e.needsDepthBuffer&&this._releaseDepthMap(),0===this.effects.length&&this.disable()}_requestDepthMaps(){for(var e=0,t=this.effects.length;e<t;e++){var i=this.effects[e].effect;this._newPostEffect!==i&&(i.needsDepthBuffer&&this._requestDepthMap())}}_releaseDepthMaps(){for(var e=0,t=this.effects.length;e<t;e++){this.effects[e].effect.needsDepthBuffer&&this._releaseDepthMap()}}_requestDepthMap(){var e=this.app.scene.layers.getLayerById(1);e&&(e.incrementCounter(),this.camera.requestSceneDepthMap(!0))}_releaseDepthMap(){var e=this.app.scene.layers.getLayerById(1);e&&(e.decrementCounter(),this.camera.requestSceneDepthMap(!1))}destroy(){for(var e=0,t=this.effects.length;e<t;e++)this.effects[e].inputTarget.destroy();this.effects.length=0,this.disable()}enable(){!this.enabled&&this.effects.length&&(this.enabled=!0,this._requestDepthMaps(),this.app.graphicsDevice.on("resizecanvas",this._onCanvasResized,this),this.destinationRenderTarget=this.camera.renderTarget,this.camera.renderTarget=this.effects[0].inputTarget,this.camera.onPostprocessing=()=>{if(this.enabled){var e=null,t=this.effects.length;if(t)for(var i=0;i<t;i++){var s=this.effects[i],r=s.outputTarget;i===t-1&&(e=this.camera.rect,this.destinationRenderTarget&&(r=this.destinationRenderTarget)),s.effect.render(s.inputTarget,r,e)}}})}disable(){this.enabled&&(this.enabled=!1,this.app.graphicsDevice.off("resizecanvas",this._onCanvasResized,this),this._releaseDepthMaps(),this._destroyOffscreenTarget(this._sourceTarget),this.camera.renderTarget=this.destinationRenderTarget,this.camera.onPostprocessing=null)}_onCanvasResized(e,t){var i,s,r=this.camera.rect,n=this.destinationRenderTarget;e=null!=(i=null==n?void 0:n.width)?i:e,t=null!=(s=null==n?void 0:n.height)?s:t,this.camera.camera.aspectRatio=e*r.z/(t*r.w),this.resizeRenderTargets()}resizeRenderTargets(){for(var e,t,i=this.app.graphicsDevice,s=this.destinationRenderTarget,r=null!=(e=null==s?void 0:s.width)?e:i.width,n=null!=(t=null==s?void 0:s.height)?t:i.height,a=this.camera.rect,o=Math.floor(a.z*r),l=Math.floor(a.w*n),h=this.effects,c=0,d=h.length;c<d;c++){var u=h[c];u.inputTarget.width===o&&u.inputTarget.height===l||this._resizeOffscreenTarget(u.inputTarget)}}onCameraRectChanged(e,t,i){this.enabled&&this.resizeRenderTargets()}constructor(e,t){this.app=e,this.camera=t,this.destinationRenderTarget=null,this.effects=[],this.enabled=!1,this.depthTarget=null,t.on("set:rect",this.onCameraRectChanged,this)}}class Tv extends Qm{setShaderPass(e){var t=Th.get(this.system.app.graphicsDevice),i=e?t.allocate(e,{isForward:!0}):null;return this._camera.shaderPassInfo=i,i.index}getShaderPass(){var e;return null==(e=this._camera.shaderPassInfo)?void 0:e.name}set renderPasses(e){this._camera.renderPasses=e||[],this.dirtyLayerCompositionCameras(),this.system.app.scene.updateShaders=!0}get renderPasses(){return this._camera.renderPasses}get shaderParams(){return this._camera.shaderParams}set gammaCorrection(e){this.camera.shaderParams.gammaCorrection=e}get gammaCorrection(){return this.camera.shaderParams.gammaCorrection}set toneMapping(e){this.camera.shaderParams.toneMapping=e}get toneMapping(){return this.camera.shaderParams.toneMapping}set fog(e){this._camera.fogParams=e}get fog(){return this._camera.fogParams}set aperture(e){this._camera.aperture=e}get aperture(){return this._camera.aperture}set aspectRatio(e){this._camera.aspectRatio=e}get aspectRatio(){return this._camera.aspectRatio}set aspectRatioMode(e){this._camera.aspectRatioMode=e}get aspectRatioMode(){return this._camera.aspectRatioMode}set calculateProjection(e){this._camera.calculateProjection=e}get calculateProjection(){return this._camera.calculateProjection}set calculateTransform(e){this._camera.calculateTransform=e}get calculateTransform(){return this._camera.calculateTransform}get camera(){return this._camera}set clearColor(e){this._camera.clearColor=e}get clearColor(){return this._camera.clearColor}set clearColorBuffer(e){this._camera.clearColorBuffer=e,this.dirtyLayerCompositionCameras()}get clearColorBuffer(){return this._camera.clearColorBuffer}set clearDepthBuffer(e){this._camera.clearDepthBuffer=e,this.dirtyLayerCompositionCameras()}get clearDepthBuffer(){return this._camera.clearDepthBuffer}set clearStencilBuffer(e){this._camera.clearStencilBuffer=e,this.dirtyLayerCompositionCameras()}get clearStencilBuffer(){return this._camera.clearStencilBuffer}set cullFaces(e){this._camera.cullFaces=e}get cullFaces(){return this._camera.cullFaces}set disablePostEffectsLayer(e){this._disablePostEffectsLayer=e,this.dirtyLayerCompositionCameras()}get disablePostEffectsLayer(){return this._disablePostEffectsLayer}set farClip(e){this._camera.farClip=e}get farClip(){return this._camera.farClip}set flipFaces(e){this._camera.flipFaces=e}get flipFaces(){return this._camera.flipFaces}set fov(e){this._camera.fov=e}get fov(){return this._camera.fov}get frustum(){return this._camera.frustum}set frustumCulling(e){this._camera.frustumCulling=e}get frustumCulling(){return this._camera.frustumCulling}set horizontalFov(e){this._camera.horizontalFov=e}get horizontalFov(){return this._camera.horizontalFov}set layers(e){var t=this._camera.layers,i=this.system.app.scene;t.forEach((e=>{var t=i.layers.getLayerById(e);null==t||t.removeCamera(this)})),this._camera.layers=e,this.enabled&&this.entity.enabled&&e.forEach((e=>{var t=i.layers.getLayerById(e);null==t||t.addCamera(this)}))}get layers(){return this._camera.layers}get layersSet(){return this._camera.layersSet}set jitter(e){this._camera.jitter=e}get jitter(){return this._camera.jitter}set nearClip(e){this._camera.nearClip=e}get nearClip(){return this._camera.nearClip}set orthoHeight(e){this._camera.orthoHeight=e}get orthoHeight(){return this._camera.orthoHeight}get postEffects(){return this._postEffects}get postEffectsEnabled(){return this._postEffects.enabled}set priority(e){this._priority=e,this.dirtyLayerCompositionCameras()}get priority(){return this._priority}set projection(e){this._camera.projection=e}get projection(){return this._camera.projection}get projectionMatrix(){return this._camera.projectionMatrix}set rect(e){this._camera.rect=e,this.fire("set:rect",this._camera.rect)}get rect(){return this._camera.rect}set renderSceneColorMap(e){e&&!this._sceneColorMapRequested?(this.requestSceneColorMap(!0),this._sceneColorMapRequested=!0):this._sceneColorMapRequested&&(this.requestSceneColorMap(!1),this._sceneColorMapRequested=!1)}get renderSceneColorMap(){return this._renderSceneColorMap>0}set renderSceneDepthMap(e){e&&!this._sceneDepthMapRequested?(this.requestSceneDepthMap(!0),this._sceneDepthMapRequested=!0):this._sceneDepthMapRequested&&(this.requestSceneDepthMap(!1),this._sceneDepthMapRequested=!1)}get renderSceneDepthMap(){return this._renderSceneDepthMap>0}set renderTarget(e){this._camera.renderTarget=e,this.dirtyLayerCompositionCameras()}get renderTarget(){return this._camera.renderTarget}set scissorRect(e){this._camera.scissorRect=e}get scissorRect(){return this._camera.scissorRect}set sensitivity(e){this._camera.sensitivity=e}get sensitivity(){return this._camera.sensitivity}set shutter(e){this._camera.shutter=e}get shutter(){return this._camera.shutter}get viewMatrix(){return this._camera.viewMatrix}_enableDepthLayer(e){if(this.layers.find((e=>1===e))){var t=this.system.app.scene.layers.getLayerById(1);e?null==t||t.incrementCounter():null==t||t.decrementCounter()}else if(e)return!1;return!0}requestSceneColorMap(e){this._renderSceneColorMap+=e?1:-1,this._enableDepthLayer(e),this.camera._enableRenderPassColorGrab(this.system.app.graphicsDevice,this.renderSceneColorMap),this.system.app.scene.layers.markDirty()}requestSceneDepthMap(e){this._renderSceneDepthMap+=e?1:-1,this._enableDepthLayer(e),this.camera._enableRenderPassDepthGrab(this.system.app.graphicsDevice,this.system.app.renderer,this.renderSceneDepthMap),this.system.app.scene.layers.markDirty()}dirtyLayerCompositionCameras(){this.system.app.scene.layers._dirty=!0}screenToWorld(e,t,i,s){var r=this.system.app.graphicsDevice,{width:n,height:a}=r.clientRect;return this._camera.screenToWorld(e,t,i,n,a,s)}worldToScreen(e,t){var i=this.system.app.graphicsDevice,{width:s,height:r}=i.clientRect;return this._camera.worldToScreen(e,s,r,t)}onAppPrerender(){this._camera._viewMatDirty=!0,this._camera._viewProjMatDirty=!0}addCameraToLayers(){for(var e=this.layers,t=0;t<e.length;t++){var i=this.system.app.scene.layers.getLayerById(e[t]);i&&i.addCamera(this)}}removeCameraFromLayers(){for(var e=this.layers,t=0;t<e.length;t++){var i=this.system.app.scene.layers.getLayerById(e[t]);i&&i.removeCamera(this)}}onLayersChanged(e,t){this.addCameraToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||e.addCamera(this)}onLayerRemoved(e){this.layers.indexOf(e.id)<0||e.removeCamera(this)}onEnable(){var e,t,i,s=this.system.app.scene,r=s.layers;(this.system.addCamera(this),null==(e=this._evtLayersChanged)||e.off(),this._evtLayersChanged=s.on("set:layers",this.onLayersChanged,this),r)&&(null==(t=this._evtLayerAdded)||t.off(),this._evtLayerAdded=r.on("add",this.onLayerAdded,this),null==(i=this._evtLayerRemoved)||i.off(),this._evtLayerRemoved=r.on("remove",this.onLayerRemoved,this));this.enabled&&this.entity.enabled&&this.addCameraToLayers(),this.postEffects.enable()}onDisable(){var e,t,i,s=this.system.app.scene.layers;(this.postEffects.disable(),this.removeCameraFromLayers(),null==(e=this._evtLayersChanged)||e.off(),this._evtLayersChanged=null,s)&&(null==(t=this._evtLayerAdded)||t.off(),this._evtLayerAdded=null,null==(i=this._evtLayerRemoved)||i.off(),this._evtLayerRemoved=null);this.system.removeCamera(this)}onRemove(){this.onDisable(),this.off(),this.camera.destroy()}calculateAspectRatio(e){var t=this.system.app.graphicsDevice,i=e?e.width:t.width,s=e?e.height:t.height;return i*this.rect.z/(s*this.rect.w)}frameUpdate(e){0===this.aspectRatioMode&&(this.aspectRatio=this.calculateAspectRatio(e))}startXr(e,t,i){this.system.app.xr.start(this,e,t,i)}endXr(e){this._camera.xr?this._camera.xr.end(e):e&&e(new Error("Camera is not in XR"))}copy(e){this.aperture=e.aperture,this.aspectRatio=e.aspectRatio,this.aspectRatioMode=e.aspectRatioMode,this.calculateProjection=e.calculateProjection,this.calculateTransform=e.calculateTransform,this.clearColor=e.clearColor,this.clearColorBuffer=e.clearColorBuffer,this.clearDepthBuffer=e.clearDepthBuffer,this.clearStencilBuffer=e.clearStencilBuffer,this.cullFaces=e.cullFaces,this.disablePostEffectsLayer=e.disablePostEffectsLayer,this.farClip=e.farClip,this.flipFaces=e.flipFaces,this.fov=e.fov,this.frustumCulling=e.frustumCulling,this.horizontalFov=e.horizontalFov,this.layers=e.layers,this.nearClip=e.nearClip,this.orthoHeight=e.orthoHeight,this.priority=e.priority,this.projection=e.projection,this.rect=e.rect,this.renderTarget=e.renderTarget,this.scissorRect=e.scissorRect,this.sensitivity=e.sensitivity,this.shutter=e.shutter}constructor(e,t){super(e,t),this.onPostprocessing=null,this._renderSceneDepthMap=0,this._renderSceneColorMap=0,this._sceneDepthMapRequested=!1,this._sceneColorMapRequested=!1,this._priority=0,this._disablePostEffectsLayer=4,this._camera=new uc,this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._camera.node=t,this._postEffects=new wv(e.app,this)}}class Cv{constructor(){this.enabled=!0}}var Ev=["enabled"];class Av extends Jm{initializeComponentData(e,t,i){i=["aspectRatio","aspectRatioMode","calculateProjection","calculateTransform","clearColor","clearColorBuffer","clearDepthBuffer","clearStencilBuffer","renderSceneColorMap","renderSceneDepthMap","cullFaces","farClip","flipFaces","fog","fov","frustumCulling","horizontalFov","layers","renderTarget","nearClip","orthoHeight","projection","priority","rect","scissorRect","aperture","shutter","sensitivity","gammaCorrection","toneMapping"];for(var s=0;s<i.length;s++){var r=i[s];if(t.hasOwnProperty(r)){var n=t[r];switch(r){case"rect":case"scissorRect":Array.isArray(n)?e[r]=new ui(n[0],n[1],n[2],n[3]):e[r]=n;break;case"clearColor":Array.isArray(n)?e[r]=new ii(n[0],n[1],n[2],n[3]):e[r]=n;break;default:e[r]=n}}}super.initializeComponentData(e,t,["enabled"])}cloneComponent(e,t){var i=e.camera;return this.addComponent(t,{aspectRatio:i.aspectRatio,aspectRatioMode:i.aspectRatioMode,calculateProjection:i.calculateProjection,calculateTransform:i.calculateTransform,clearColor:i.clearColor,clearColorBuffer:i.clearColorBuffer,clearDepthBuffer:i.clearDepthBuffer,clearStencilBuffer:i.clearStencilBuffer,renderSceneDepthMap:i.renderSceneDepthMap,renderSceneColorMap:i.renderSceneColorMap,cullFaces:i.cullFaces,enabled:i.enabled,farClip:i.farClip,flipFaces:i.flipFaces,fov:i.fov,frustumCulling:i.frustumCulling,horizontalFov:i.horizontalFov,layers:i.layers,renderTarget:i.renderTarget,nearClip:i.nearClip,orthoHeight:i.orthoHeight,projection:i.projection,priority:i.priority,rect:i.rect,scissorRect:i.scissorRect,aperture:i.aperture,sensitivity:i.sensitivity,shutter:i.shutter,gammaCorrection:i.gammaCorrection,toneMapping:i.toneMapping})}onBeforeRemove(e,t){this.removeCamera(t),t.onRemove()}onAppPrerender(){for(var e=0,t=this.cameras.length;e<t;e++)this.cameras[e].onAppPrerender()}addCamera(e){this.cameras.push(e),Su(this.cameras)}removeCamera(e){var t=this.cameras.indexOf(e);t>=0&&(this.cameras.splice(t,1),Su(this.cameras))}destroy(){this.app.off("prerender",this.onAppPrerender,this),super.destroy()}constructor(e){super(e),this.cameras=[],this.id="camera",this.ComponentType=Tv,this.DataType=Cv,this.schema=Ev,this.on("beforeremove",this.onBeforeRemove,this),this.app.on("prerender",this.onAppPrerender,this)}}Qm._buildAccessors(Tv.prototype,Ev);class Pv{constructor(){this.enabled=!0,this.type="directional",this.color=new ii(1,1,1),this.intensity=1,this.luminance=0,this.shape=0,this.affectSpecularity=!0,this.castShadows=!1,this.shadowDistance=40,this.shadowIntensity=1,this.shadowResolution=1024,this.shadowBias=.05,this.numCascades=1,this.cascadeBlend=0,this.bakeNumSamples=1,this.bakeArea=0,this.cascadeDistribution=.5,this.normalOffsetBias=0,this.range=10,this.innerConeAngle=40,this.outerConeAngle=45,this.falloffMode=0,this.shadowType=0,this.vsmBlurSize=11,this.vsmBlurMode=1,this.vsmBias=.0025,this.cookieAsset=null,this.cookie=null,this.cookieIntensity=1,this.cookieFalloff=!0,this.cookieChannel="rgb",this.cookieAngle=0,this.cookieScale=null,this.cookieOffset=null,this.shadowUpdateMode=2,this.mask=1,this.affectDynamic=!0,this.affectLightmapped=!1,this.bake=!1,this.bakeDir=!0,this.isStatic=!1,this.layers=[0],this.penumbraSize=1,this.penumbraFalloff=1,this.shadowSamples=16,this.shadowBlockerSamples=16}}var Dv=Object.keys(new Pv);class Lv extends Qm{get data(){var e=this.system.store[this.entity.getGuid()];return e?e.data:null}set enabled(e){this._setValue("enabled",e,(function(e,t){this.onSetEnabled(null,t,e)}))}get enabled(){return this.data.enabled}set light(e){this._setValue("light",e)}get light(){return this.data.light}set type(e){this._setValue("type",e,(function(e,t){this.system.changeType(this,t,e),this.refreshProperties()}))}get type(){return this.data.type}set color(e){this._setValue("color",e,(function(e,t){this.light.setColor(e)}),!0)}get color(){return this.data.color}set intensity(e){this._setValue("intensity",e,(function(e,t){this.light.intensity=e}))}get intensity(){return this.data.intensity}set luminance(e){this._setValue("luminance",e,(function(e,t){this.light.luminance=e}))}get luminance(){return this.data.luminance}set shape(e){this._setValue("shape",e,(function(e,t){this.light.shape=e}))}get shape(){return this.data.shape}set affectSpecularity(e){this._setValue("affectSpecularity",e,(function(e,t){this.light.affectSpecularity=e}))}get affectSpecularity(){return this.data.affectSpecularity}set castShadows(e){this._setValue("castShadows",e,(function(e,t){this.light.castShadows=e}))}get castShadows(){return this.data.castShadows}set shadowDistance(e){this._setValue("shadowDistance",e,(function(e,t){this.light.shadowDistance=e}))}get shadowDistance(){return this.data.shadowDistance}set shadowIntensity(e){this._setValue("shadowIntensity",e,(function(e,t){this.light.shadowIntensity=e}))}get shadowIntensity(){return this.data.shadowIntensity}set shadowResolution(e){this._setValue("shadowResolution",e,(function(e,t){this.light.shadowResolution=e}))}get shadowResolution(){return this.data.shadowResolution}set shadowBias(e){this._setValue("shadowBias",e,(function(e,t){this.light.shadowBias=-.01*ti.clamp(e,0,1)}))}get shadowBias(){return this.data.shadowBias}set numCascades(e){this._setValue("numCascades",e,(function(e,t){this.light.numCascades=ti.clamp(Math.floor(e),1,4)}))}get numCascades(){return this.data.numCascades}set cascadeBlend(e){this._setValue("cascadeBlend",e,(function(e,t){this.light.cascadeBlend=ti.clamp(e,0,1)}))}get cascadeBlend(){return this.data.cascadeBlend}set bakeNumSamples(e){this._setValue("bakeNumSamples",e,(function(e,t){this.light.bakeNumSamples=ti.clamp(Math.floor(e),1,255)}))}get bakeNumSamples(){return this.data.bakeNumSamples}set bakeArea(e){this._setValue("bakeArea",e,(function(e,t){this.light.bakeArea=ti.clamp(e,0,180)}))}get bakeArea(){return this.data.bakeArea}set cascadeDistribution(e){this._setValue("cascadeDistribution",e,(function(e,t){this.light.cascadeDistribution=ti.clamp(e,0,1)}))}get cascadeDistribution(){return this.data.cascadeDistribution}set normalOffsetBias(e){this._setValue("normalOffsetBias",e,(function(e,t){this.light.normalOffsetBias=ti.clamp(e,0,1)}))}get normalOffsetBias(){return this.data.normalOffsetBias}set range(e){this._setValue("range",e,(function(e,t){this.light.attenuationEnd=e}))}get range(){return this.data.range}set innerConeAngle(e){this._setValue("innerConeAngle",e,(function(e,t){this.light.innerConeAngle=e}))}get innerConeAngle(){return this.data.innerConeAngle}set outerConeAngle(e){this._setValue("outerConeAngle",e,(function(e,t){this.light.outerConeAngle=e}))}get outerConeAngle(){return this.data.outerConeAngle}set falloffMode(e){this._setValue("falloffMode",e,(function(e,t){this.light.falloffMode=e}))}get falloffMode(){return this.data.falloffMode}set shadowType(e){this._setValue("shadowType",e,(function(e,t){this.light.shadowType=e}))}get shadowType(){return this.data.shadowType}set vsmBlurSize(e){this._setValue("vsmBlurSize",e,(function(e,t){this.light.vsmBlurSize=e}))}get vsmBlurSize(){return this.data.vsmBlurSize}set vsmBlurMode(e){this._setValue("vsmBlurMode",e,(function(e,t){this.light.vsmBlurMode=e}))}get vsmBlurMode(){return this.data.vsmBlurMode}set vsmBias(e){this._setValue("vsmBias",e,(function(e,t){this.light.vsmBias=ti.clamp(e,0,1)}))}get vsmBias(){return this.data.vsmBias}set cookieAsset(e){this._setValue("cookieAsset",e,(function(e,t){if(!this._cookieAssetId||!(e instanceof fm&&e.id===this._cookieAssetId||e===this._cookieAssetId))if(this.onCookieAssetRemove(),this._cookieAssetId=null,e instanceof fm)this.data.cookieAsset=e.id,this._cookieAssetId=e.id,this.onCookieAssetAdd(e);else if("number"==typeof e){this._cookieAssetId=e;var i=this.system.app.assets.get(e);i?this.onCookieAssetAdd(i):(this._cookieAssetAdd=!0,this.system.app.assets.on("add:"+this._cookieAssetId,this.onCookieAssetAdd,this))}}))}get cookieAsset(){return this.data.cookieAsset}set cookie(e){this._setValue("cookie",e,(function(e,t){this.light.cookie=e}))}get cookie(){return this.data.cookie}set cookieIntensity(e){this._setValue("cookieIntensity",e,(function(e,t){this.light.cookieIntensity=ti.clamp(e,0,1)}))}get cookieIntensity(){return this.data.cookieIntensity}set cookieFalloff(e){this._setValue("cookieFalloff",e,(function(e,t){this.light.cookieFalloff=e}))}get cookieFalloff(){return this.data.cookieFalloff}set cookieChannel(e){this._setValue("cookieChannel",e,(function(e,t){this.light.cookieChannel=e}))}get cookieChannel(){return this.data.cookieChannel}set cookieAngle(e){this._setValue("cookieAngle",e,(function(e,t){if(0!==e||null!==this.cookieScale){this._cookieMatrix||(this._cookieMatrix=new ui);var i=1,s=1;this.cookieScale&&(i=this.cookieScale.x,s=this.cookieScale.y);var r=Math.cos(e*ti.DEG_TO_RAD),n=Math.sin(e*ti.DEG_TO_RAD);this._cookieMatrix.set(r/i,-n/i,n/s,r/s),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null}))}get cookieAngle(){return this.data.cookieAngle}set cookieScale(e){this._setValue("cookieScale",e,(function(e,t){if(null!==e||0!==this.cookieAngle){this._cookieMatrix||(this._cookieMatrix=new ui);var i=e.x,s=e.y,r=Math.cos(this.cookieAngle*ti.DEG_TO_RAD),n=Math.sin(this.cookieAngle*ti.DEG_TO_RAD);this._cookieMatrix.set(r/i,-n/i,n/s,r/s),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null}),!0)}get cookieScale(){return this.data.cookieScale}set cookieOffset(e){this._setValue("cookieOffset",e,(function(e,t){this.light.cookieOffset=e}),!0)}get cookieOffset(){return this.data.cookieOffset}set shadowUpdateMode(e){this._setValue("shadowUpdateMode",e,(function(e,t){this.light.shadowUpdateMode=e}),!0)}get shadowUpdateMode(){return this.data.shadowUpdateMode}set mask(e){this._setValue("mask",e,(function(e,t){this.light.mask=e}))}get mask(){return this.data.mask}set affectDynamic(e){this._setValue("affectDynamic",e,(function(e,t){e?this.light.mask|=1:this.light.mask&=-2,this.light.layersDirty()}))}get affectDynamic(){return this.data.affectDynamic}set affectLightmapped(e){this._setValue("affectLightmapped",e,(function(e,t){e?(this.light.mask|=2,this.bake&&(this.light.mask&=-5)):(this.light.mask&=-3,this.bake&&(this.light.mask|=4))}))}get affectLightmapped(){return this.data.affectLightmapped}set bake(e){this._setValue("bake",e,(function(e,t){e?(this.light.mask|=4,this.affectLightmapped&&(this.light.mask&=-3)):(this.light.mask&=-5,this.affectLightmapped&&(this.light.mask|=2)),this.light.layersDirty()}))}get bake(){return this.data.bake}set bakeDir(e){this._setValue("bakeDir",e,(function(e,t){this.light.bakeDir=e}))}get bakeDir(){return this.data.bakeDir}set isStatic(e){this._setValue("isStatic",e,(function(e,t){this.light.isStatic=e}))}get isStatic(){return this.data.isStatic}set layers(e){this._setValue("layers",e,(function(e,t){for(var i=0;i<t.length;i++){var s=this.system.app.scene.layers.getLayerById(t[i]);s&&(s.removeLight(this),this.light.removeLayer(s))}for(var r=0;r<e.length;r++){var n=this.system.app.scene.layers.getLayerById(e[r]);n&&(this.enabled&&this.entity.enabled&&(n.addLight(this),this.light.addLayer(n)))}}))}get layers(){return this.data.layers}set shadowUpdateOverrides(e){this.light.shadowUpdateOverrides=e}get shadowUpdateOverrides(){return this.light.shadowUpdateOverrides}set shadowSamples(e){this.light.shadowSamples=e}get shadowSamples(){return this.light.shadowSamples}set shadowBlockerSamples(e){this.light.shadowBlockerSamples=e}get shadowBlockerSamples(){return this.light.shadowBlockerSamples}set penumbraSize(e){this.light.penumbraSize=e}get penumbraSize(){return this.light.penumbraSize}set penumbraFalloff(e){this.light.penumbraFalloff=e}get penumbraFalloff(){return this.light.penumbraFalloff}_setValue(e,t,i,s){var r=this.data,n=r[e];(s||n!==t)&&(r[e]=t,i&&i.call(this,t,n))}addLightToLayers(){for(var e=0;e<this.layers.length;e++){var t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&(t.addLight(this),this.light.addLayer(t))}}removeLightFromLayers(){for(var e=0;e<this.layers.length;e++){var t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&(t.removeLight(this),this.light.removeLayer(t))}}onLayersChanged(e,t){this.enabled&&this.entity.enabled&&this.addLightToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)>=0&&this.enabled&&this.entity.enabled&&(e.addLight(this),this.light.addLayer(e))}onLayerRemoved(e){this.layers.indexOf(e.id)>=0&&(e.removeLight(this),this.light.removeLayer(e))}refreshProperties(){for(var e=0;e<Dv.length;e++){var t=Dv[e];this[t]=this[t]}this.enabled&&this.entity.enabled&&this.onEnable()}onCookieAssetSet(){var e=!1;"cubemap"!==this._cookieAsset.type||this._cookieAsset.loadFaces||(this._cookieAsset.loadFaces=!0,e=!0),this._cookieAsset.resource&&!e||this.system.app.assets.load(this._cookieAsset),this._cookieAsset.resource&&this.onCookieAssetLoad()}onCookieAssetAdd(e){this._cookieAssetId===e.id&&(this._cookieAsset=e,this.light.enabled&&this.onCookieAssetSet(),this._cookieAsset.on("load",this.onCookieAssetLoad,this),this._cookieAsset.on("remove",this.onCookieAssetRemove,this))}onCookieAssetLoad(){this._cookieAsset&&this._cookieAsset.resource&&(this.cookie=this._cookieAsset.resource)}onCookieAssetRemove(){this._cookieAssetId&&(this._cookieAssetAdd&&(this.system.app.assets.off("add:"+this._cookieAssetId,this.onCookieAssetAdd,this),this._cookieAssetAdd=!1),this._cookieAsset&&(this._cookieAsset.off("load",this.onCookieAssetLoad,this),this._cookieAsset.off("remove",this.onCookieAssetRemove,this),this._cookieAsset=null),this.cookie=null)}onEnable(){var e=this.system.app.scene,t=e.layers;this.light.enabled=!0,this._evtLayersChanged=e.on("set:layers",this.onLayersChanged,this),t&&(this._evtLayerAdded=t.on("add",this.onLayerAdded,this),this._evtLayerRemoved=t.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addLightToLayers(),this._cookieAsset&&!this.cookie&&this.onCookieAssetSet()}onDisable(){var e,t,i,s=this.system.app.scene.layers;(this.light.enabled=!1,null==(e=this._evtLayersChanged)||e.off(),this._evtLayersChanged=null,s)&&(null==(t=this._evtLayerAdded)||t.off(),this._evtLayerAdded=null,null==(i=this._evtLayerRemoved)||i.off(),this._evtLayerRemoved=null);this.removeLightFromLayers()}onRemove(){this.onDisable(),this.light.destroy(),this.cookieAsset=null}constructor(...e){super(...e),this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._cookieAsset=null,this._cookieAssetId=null,this._cookieAssetAdd=!1,this._cookieMatrix=null}}function Mv(){return Mv=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var s in i)Object.prototype.hasOwnProperty.call(i,s)&&(e[s]=i[s])}return e},Mv.apply(this,arguments)}class Iv extends Jm{initializeComponentData(e,t){var i=Mv({},t);i.type||(i.type=e.data.type),e.data.type=i.type,i.layers&&Array.isArray(i.layers)&&(i.layers=i.layers.slice(0)),i.color&&Array.isArray(i.color)&&(i.color=new ii(i.color[0],i.color[1],i.color[2])),i.cookieOffset&&i.cookieOffset instanceof Array&&(i.cookieOffset=new di(i.cookieOffset[0],i.cookieOffset[1])),i.cookieScale&&i.cookieScale instanceof Array&&(i.cookieScale=new di(i.cookieScale[0],i.cookieScale[1])),i.enable&&(console.warn("WARNING: enable: Property is deprecated. Set enabled property instead."),i.enabled=i.enable),i.shape||(i.shape=0);var s=new Ru(this.app.graphicsDevice,this.app.scene.clusteredLightingEnabled);s.type=Pu[i.type],s._node=e.entity,e.data.light=s,super.initializeComponentData(e,i,Dv)}_onRemoveComponent(e,t){t.onRemove()}cloneComponent(e,t){for(var i,s=e.light,r=[],n=0;n<Dv.length;n++)"light"!==(i=Dv[n])&&(s[i]&&s[i].clone?r[i]=s[i].clone():r[i]=s[i]);return this.addComponent(t,r)}changeType(e,t,i){t!==i&&(e.light.type=Pu[i])}constructor(e){super(e),this.id="light",this.ComponentType=Lv,this.DataType=Pv,this.on("beforeremove",this._onRemoveComponent,this)}}var Rv=["x","y","z","w"],kv=[void 0,void 0,di,hi,ui];function Ov(e,t,i,s){switch(t.type){case"boolean":return!!i;case"number":if("number"==typeof i)return i;if("string"==typeof i){var r=parseInt(i,10);return isNaN(r)?null:r}return"boolean"==typeof i?0+i:null;case"json":var n={};if(Array.isArray(t.schema)){i&&"object"==typeof i||(i={});for(var a=0;a<t.schema.length;a++){var o=t.schema[a];if(o.name)if(o.array){n[o.name]=[];for(var l=Array.isArray(i[o.name])?i[o.name]:[],h=0;h<l.length;h++)n[o.name].push(Ov(e,o,l[h]))}else{var c=i.hasOwnProperty(o.name)?i[o.name]:o.default;n[o.name]=Ov(e,o,c)}}}return n;case"asset":return i instanceof fm?i:"number"==typeof i?e.assets.get(i)||null:"string"==typeof i&&e.assets.get(parseInt(i,10))||null;case"entity":return i instanceof Lc?i:"string"==typeof i?e.getEntityFromIndex(i):null;case"rgb":case"rgba":if(i instanceof ii)return s instanceof ii?(s.copy(i),s):i.clone();if(i instanceof Array&&i.length>=3&&i.length<=4){for(var d=0;d<i.length;d++)if("number"!=typeof i[d])return null;return s||(s=new ii),s.r=i[0],s.g=i[1],s.b=i[2],s.a=3===i.length?1:i[3],s}return"string"==typeof i&&/#(?:[0-9a-f]{2}){3,4}/i.test(i)?(s||(s=new ii),s.fromString(i),s):null;case"vec2":case"vec3":case"vec4":var u=parseInt(t.type.slice(3),10),f=kv[u];if(i instanceof f)return s instanceof f?(s.copy(i),s):i.clone();if(i instanceof Array&&i.length===u){for(var p=0;p<i.length;p++)if("number"!=typeof i[p])return null;s||(s=new f);for(var m=0;m<u;m++)s[Rv[m]]=i[m];return s}return null;case"curve":if(i){var g;if(i instanceof ri||i instanceof ni)g=i.clone();else(g=new(i.keys[0]instanceof Array?ni:ri)(i.keys)).type=i.type;return g}}return i}function Fv(e,t,i,s){return t.array?i.map(((i,r)=>Ov(e,t,i,s?s[r]:null))):Ov(e,t,i,s)}function Bv(e,t,i,s){if(i)for(var r in t){var n=t[r],a=i[r];void 0!==a&&(s[r]=Fv(e,n,a,s[r]))}}class Nv{add(e,t){this.index[e]||Nv.reservedNames.has(e)||(this.index[e]=t,Object.defineProperty(this.scriptType.prototype,e,{get:function(){return this.__attributes[e]},set:function(i){var s="attr",r="attr:"+e,n=this.__attributes[e],a=n;if(n&&"json"!==t.type&&"entity"!==t.type&&n.clone&&(this.hasEvent(s)||this.hasEvent(r))&&(a=n.clone()),t.array){if(this.__attributes[e]=[],i)for(var o=0,l=i.length;o<l;o++)this.__attributes[e].push(Ov(this.app,t,i[o],n?n[o]:null))}else this.__attributes[e]=Ov(this.app,t,i,n);this.fire(s,e,this.__attributes[e],a),this.fire(r,this.__attributes[e],a)}}))}remove(e){return!!this.index[e]&&(delete this.index[e],delete this.scriptType.prototype[e],!0)}has(e){return!!this.index[e]}get(e){return this.index[e]||null}constructor(e){this.scriptType=e,this.index={}}}Nv.assignAttributesToScript=Bv,Nv.attributeToValue=Fv,Nv.reservedNames=new Set(["app","entity","enabled","_enabled","_enabledOld","_destroyed","__attributes","__attributesRaw","__scriptType","__executionOrder","_callbacks","_callbackActive","has","get","on","off","fire","once","hasEvent"]);var zv="initialize",Uv="postInitialize";class Vv extends Ht{set enabled(e){this._enabled=!!e,this.enabled!==this._enabledOld&&(this._enabledOld=this.enabled,this.fire(this.enabled?"enable":"disable"),this.fire("state",this.enabled),!this._initialized&&this.enabled&&(this._initialized=!0,this.fire("preInitialize"),this.initialize&&this.entity.script._scriptMethod(this,zv)),this._initialized&&!this._postInitialized&&this.enabled&&!this.entity.script._beingEnabled&&(this._postInitialized=!0,this.postInitialize&&this.entity.script._scriptMethod(this,Uv)))}get enabled(){return this._enabled&&!this._destroyed&&this.entity.script.enabled&&this.entity.enabled}initScript(e){var t=this.constructor;this.app=e.app,this.entity=e.entity,this._enabled="boolean"!=typeof e.enabled||e.enabled,this._enabledOld=this.enabled,this.__destroyed=!1,this.__scriptType=t,this.__executionOrder=-1}static get scriptName(){return this.__name}constructor(e){super(),this.initScript(e)}}Vv.EVENT_ENABLE="enable",Vv.EVENT_DISABLE="disable",Vv.EVENT_STATE="state",Vv.EVENT_DESTROY="destroy",Vv.EVENT_ATTR="attr",Vv.EVENT_ERROR="error",Vv.__name=null,Vv.__getScriptName=Gv;var Hv=/^\s*function(?:\s|\s*\/\*.*\*\/\s*)+([^(\s\/]*)\s*/;function Gv(e){if("function"==typeof e){if("name"in Function.prototype)return e.name;if(e===Function||e===Function.prototype.constructor)return"Function";var t=(""+e).match(Hv);return t?t[1]:void 0}}class Wv extends Vv{static get attributes(){return this.hasOwnProperty("__attributes")||(this.__attributes=new Nv(this)),this.__attributes}initScript(e){Vv.prototype.initScript.call(this,e),this.__attributes={},this.__attributesRaw=e.attributes||{}}initScriptType(e){this.initScript(e)}__initializeAttributes(e){if(e||this.__attributesRaw){for(var t in this.__scriptType.attributes.index)this.__attributesRaw&&this.__attributesRaw.hasOwnProperty(t)?this[t]=this.__attributesRaw[t]:this.__attributes.hasOwnProperty(t)||(this.__scriptType.attributes.index[t].hasOwnProperty("default")?this[t]=this.__scriptType.attributes.index[t].default:this[t]=null);this.__attributesRaw=null}}static extend(e){for(var t in e)e.hasOwnProperty(t)&&(this.prototype[t]=e[t])}constructor(e){super(e),this.initScriptType(e)}}class jv extends Qm{set scripts(e){var t,i=function(i){if(!e.hasOwnProperty(i))return"continue";var s=t._scriptsIndex[i];if(s){if("boolean"==typeof e[i].enabled&&(s.once("preInitialize",(()=>{t.initializeAttributes(s)})),s.enabled=!!e[i].enabled),"object"==typeof e[i].attributes)for(var r in e[i].attributes)if(!Nv.reservedNames.has(r)){if(!s.__attributes.hasOwnProperty(r)){var n=t.system.app.scripts.get(i);n&&n.attributes.add(r,{})}s[r]=e[i].attributes[r]}}else console.log(t.order)};for(var s in this._scriptsData=e,e)t=this,i(s)}get scripts(){return this._scripts}set enabled(e){var t=this._enabled;this._enabled=e,this.fire("set","enabled",t,e)}get enabled(){return this._enabled}onEnable(){this._beingEnabled=!0,this._checkState(),this.entity._beingEnabled||this.onPostStateChange(),this._beingEnabled=!1}onDisable(){this._checkState()}onPostStateChange(){for(var e=this._beginLooping(),t=0,i=this.scripts.length;t<i;t++){var s=this.scripts[t];s._initialized&&!s._postInitialized&&s.enabled&&(s._postInitialized=!0,s.postInitialize&&this._scriptMethod(s,Uv))}this._endLooping(e)}_beginLooping(){var e=this._isLoopingThroughScripts;return this._isLoopingThroughScripts=!0,e}_endLooping(e){this._isLoopingThroughScripts=e,this._isLoopingThroughScripts||this._removeDestroyedScripts()}_onSetEnabled(e,t,i){this._beingEnabled=!0,this._checkState(),this._beingEnabled=!1}_checkState(){var e,t=function(t,i){var s=e.scripts[t];s.once("preInitialize",(()=>{e.initializeAttributes(s)})),s.enabled=s._enabled},i=this.enabled&&this.entity.enabled;if(i!==this._oldState){this._oldState=i,this.fire(i?"enable":"disable"),this.fire("state",i),i?this.system._addComponentToEnabled(this):this.system._removeComponentFromEnabled(this);for(var s=this._beginLooping(),r=0,n=this.scripts.length;r<n;r++)e=this,t(r);this._endLooping(s)}}_onBeforeRemove(){this.fire("remove");for(var e=this._beginLooping(),t=0;t<this.scripts.length;t++){var i=this.scripts[t];i&&this.destroy(i.__scriptType.__name)}this._endLooping(e)}_removeDestroyedScripts(){var e=this._destroyedScripts.length;if(e){for(var t=0;t<e;t++){var i=this._destroyedScripts[t];this._removeScriptInstance(i)}this._destroyedScripts.length=0,this._resetExecutionOrder(0,this._scripts.length)}}_onInitializeAttributes(){for(var e=0,t=this.scripts.length;e<t;e++){var i=this.scripts[e];this.initializeAttributes(i)}}initializeAttributes(e){if(e instanceof Wv)e.__initializeAttributes();else{var t,i=e.__scriptType.__name,s=this._attributeDataMap.get(i);if(!s)return;var r=null==(t=this.system.app.scripts)?void 0:t.getSchema(i);Bv(this.system.app,r.attributes,s,e)}}_scriptMethod(e,t,i){e[t](i)}_onInitialize(){for(var e=this._scripts,t=this._beginLooping(),i=0,s=e.length;i<s;i++){var r=e[i];!r._initialized&&r.enabled&&(r._initialized=!0,r.initialize&&this._scriptMethod(r,zv))}this._endLooping(t)}_onPostInitialize(){this.onPostStateChange()}_onUpdate(e){var t=this._updateList;if(t.length){var i=this._beginLooping();for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++){var s=t.items[t.loopIndex];s.enabled&&this._scriptMethod(s,"update",e)}this._endLooping(i)}}_onPostUpdate(e){var t=this._postUpdateList;if(t.length){var i=this._beginLooping();for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++){var s=t.items[t.loopIndex];s.enabled&&this._scriptMethod(s,"postUpdate",e)}this._endLooping(i)}}_insertScriptInstance(e,t,i){-1===t?(this._scripts.push(e),e.__executionOrder=i,e.update&&this._updateList.append(e),e.postUpdate&&this._postUpdateList.append(e)):(this._scripts.splice(t,0,e),e.__executionOrder=t,this._resetExecutionOrder(t+1,i+1),e.update&&this._updateList.insert(e),e.postUpdate&&this._postUpdateList.insert(e))}_removeScriptInstance(e){var t=this._scripts.indexOf(e);return-1===t||(this._scripts.splice(t,1),e.update&&this._updateList.remove(e),e.postUpdate&&this._postUpdateList.remove(e)),t}_resetExecutionOrder(e,t){for(var i=e;i<t;i++)this._scripts[i].__executionOrder=i}_resolveEntityScriptAttribute(e,t,i,s,r,n){if(e.array){var a=i.length;if(!a)return;for(var o=i.slice(),l=0;l<a;l++){var h=o[l]instanceof Lm?o[l].getGuid():o[l];n[h]&&(o[l]=s?n[h].getGuid():n[h])}r[t]=o}else{if(i instanceof Lm)i=i.getGuid();else if("string"!=typeof i)return;n[i]&&(r[t]=n[i])}}has(e){if("string"==typeof e)return!!this._scriptsIndex[e];if(!e)return!1;var t=e,i=t.__name,s=this._scriptsIndex[i];return(s&&s.instance)instanceof t}get(e){if("string"==typeof e){var t=this._scriptsIndex[e];return t?t.instance:null}if(!e)return null;var i=e,s=i.__name,r=this._scriptsIndex[s],n=r&&r.instance;return n instanceof i?n:null}create(e,t){void 0===t&&(t={});var i,s=this,r=e,n=e;if("string"==typeof r)r=this.system.app.scripts.get(r);else if(r){var a,o;n=null!=(o=(a=r).__name)?o:a.__name=(i=Gv(r))[0].toLowerCase()+i.substring(1)}if(r){if(!this._scriptsIndex[n]||!this._scriptsIndex[n].instance){var l=new r({app:this.system.app,entity:this.entity,enabled:!t.hasOwnProperty("enabled")||t.enabled,attributes:t.attributes||{}});t.properties&&"object"==typeof t.properties&&Object.assign(l,t.properties),l instanceof Wv||this._attributeDataMap.set(n,t.attributes);var h=this._scripts.length,c=-1;return"number"==typeof t.ind&&-1!==t.ind&&h>t.ind&&(c=t.ind),this._insertScriptInstance(l,c,h),this._scriptsIndex[n]={instance:l,onSwap:function(){s.swap(n)}},this[n]=l,t.preloading||this.initializeAttributes(l),this.fire("create",n,l),this.fire("create:"+n,l),this.system.app.scripts.on("swap:"+n,this._scriptsIndex[n].onSwap),t.preloading||(l.enabled&&!l._initialized&&(l._initialized=!0,l.initialize&&this._scriptMethod(l,zv)),l.enabled&&!l._postInitialized&&(l._postInitialized=!0,l.postInitialize&&this._scriptMethod(l,Uv))),l}}else this._scriptsIndex[n]={awaiting:!0,ind:this._scripts.length};return null}destroy(e){var t=e,i=e;"string"==typeof i?i=this.system.app.scripts.get(i):i&&(t=i.__name);var s=this._scriptsIndex[t];if(delete this._scriptsIndex[t],!s)return!1;this._attributeDataMap.delete(t);var r=s.instance;if(r&&!r._destroyed)if(r.enabled=!1,r._destroyed=!0,this._isLoopingThroughScripts)this._destroyedScripts.push(r);else{var n=this._removeScriptInstance(r);n>=0&&this._resetExecutionOrder(n,this._scripts.length)}return this.system.app.scripts.off("swap:"+t,s.onSwap),delete this[t],this.fire("destroy",t,r||null),this.fire("destroy:"+t,r||null),r&&r.fire("destroy"),!0}swap(e){var t=e,i=e;"string"==typeof i?i=this.system.app.scripts.get(i):i&&(t=i.__name);var s=this._scriptsIndex[t];if(!s||!s.instance)return!1;var r=s.instance,n=this._scripts.indexOf(r),a=new i({app:this.system.app,entity:this.entity,enabled:r.enabled,attributes:r.__attributes});return!!a.swap&&(this.initializeAttributes(a),this._scripts[n]=a,this._scriptsIndex[t].instance=a,this[t]=a,a.__executionOrder=n,r.update&&this._updateList.remove(r),r.postUpdate&&this._postUpdateList.remove(r),a.update&&this._updateList.insert(a),a.postUpdate&&this._postUpdateList.insert(a),this._scriptMethod(a,"swap",r),this.fire("swap",t,a),this.fire("swap:"+t,a),!0)}resolveDuplicatedEntityReferenceProperties(e,t){var i=this.entity.script;for(var s in e._scriptsIndex){var r=this.system.app.scripts.get(s);if(r){var n=e._scriptsIndex[s];if(n&&n.instance){var a=i[s].__attributesRaw,o=i[s].__attributes;if(a||o){var l=!!a,h=n.instance.__attributes;for(var c in h)if(h[c]){var d=r.attributes.get(c);if(d)if("entity"===d.type)this._resolveEntityScriptAttribute(d,c,h[c],l,a||o,t);else if("json"===d.type&&Array.isArray(d.schema))for(var u=h[c],f=a?a[c]:o[c],p=0;p<d.schema.length;p++){var m=d.schema[p];if("entity"===m.type)if(d.array)for(var g=0;g<u.length;g++)this._resolveEntityScriptAttribute(m,m.name,u[g][m.name],l,f[g],t);else this._resolveEntityScriptAttribute(m,m.name,u[m.name],l,f,t)}}}}}}}move(e,t){var i=this._scripts.length;if(t>=i||t<0)return!1;var s=e,r=e;"string"!=typeof r?r=e.__name:s=null;var n=this._scriptsIndex[r];if(!n||!n.instance)return!1;var a=n.instance;if(s&&!(a instanceof s))return!1;var o=this._scripts.indexOf(a);return-1!==o&&o!==t&&(this._scripts.splice(t,0,this._scripts.splice(o,1)[0]),this._resetExecutionOrder(0,i),this._updateList.sort(),this._postUpdateList.sort(),this.fire("move",r,a,t,o),this.fire("move:"+r,a,t,o),!0)}constructor(e,t){super(e,t),this._attributeDataMap=new Map,this._scripts=[],this._updateList=new Yt({sortBy:"__executionOrder"}),this._postUpdateList=new Yt({sortBy:"__executionOrder"}),this._scriptsIndex={},this._destroyedScripts=[],this._destroyed=!1,this._scriptsData=null,this._oldState=!0,this._enabled=!0,this._beingEnabled=!1,this._isLoopingThroughScripts=!1,this._executionOrder=-1,this.on("set_enabled",this._onSetEnabled,this)}}jv.EVENT_CREATE="create",jv.EVENT_DESTROY="destroy",jv.EVENT_ENABLE="enable",jv.EVENT_DISABLE="disable",jv.EVENT_REMOVE="remove",jv.EVENT_STATE="state",jv.EVENT_MOVE="move",jv.EVENT_ERROR="error";class qv{constructor(){this.enabled=!0}}var Xv=0;class Kv extends Jm{initializeComponentData(e,t){if(e._executionOrder=Xv++,this._components.append(e),Xv>Number.MAX_SAFE_INTEGER&&this._resetExecutionOrder(),e.enabled=!t.hasOwnProperty("enabled")||!!t.enabled,e.enabled&&e.entity.enabled&&this._enabledComponents.append(e),t.hasOwnProperty("order")&&t.hasOwnProperty("scripts")){e._scriptsData=t.scripts;for(var i=0;i<t.order.length;i++)e.create(t.order[i],{enabled:t.scripts[t.order[i]].enabled,attributes:t.scripts[t.order[i]].attributes,preloading:this.preloading})}}cloneComponent(e,t){for(var i=[],s={},r=0;r<e.script._scripts.length;r++){var n,a=e.script._scripts[r],o=a.__scriptType.__name;i.push(o);var l=(null==(n=e.script._attributeDataMap)?void 0:n.get(o))||{};for(var h in a.__attributes)l[h]=a.__attributes[h];s[o]={enabled:a._enabled,attributes:l}}for(var c in e.script._scriptsIndex)c.awaiting&&i.splice(c.ind,0,c);var d={enabled:e.script.enabled,order:i,scripts:s};return this.addComponent(t,d)}_resetExecutionOrder(){Xv=0;for(var e=0,t=this._components.length;e<t;e++)this._components.items[e]._executionOrder=Xv++}_callComponentMethod(e,t,i){for(e.loopIndex=0;e.loopIndex<e.length;e.loopIndex++)e.items[e.loopIndex][t](i)}_onInitialize(){this.preloading=!1,this._callComponentMethod(this._components,"_onInitializeAttributes"),this._callComponentMethod(this._enabledComponents,"_onInitialize")}_onPostInitialize(){this._callComponentMethod(this._enabledComponents,"_onPostInitialize")}_onUpdate(e){this._callComponentMethod(this._enabledComponents,"_onUpdate",e)}_onPostUpdate(e){this._callComponentMethod(this._enabledComponents,"_onPostUpdate",e)}_addComponentToEnabled(e){this._enabledComponents.insert(e)}_removeComponentFromEnabled(e){this._enabledComponents.remove(e)}_onBeforeRemove(e,t){this._components.items.indexOf(t)>=0&&t._onBeforeRemove(),this._removeComponentFromEnabled(t),this._components.remove(t)}destroy(){super.destroy(),this.app.systems.off("initialize",this._onInitialize,this),this.app.systems.off("postInitialize",this._onPostInitialize,this),this.app.systems.off("update",this._onUpdate,this),this.app.systems.off("postUpdate",this._onPostUpdate,this)}constructor(e){super(e),this.id="script",this.ComponentType=jv,this.DataType=qv,this._components=new Yt({sortBy:"_executionOrder"}),this._enabledComponents=new Yt({sortBy:"_executionOrder"}),this.preloading=!0,this.on("beforeremove",this._onBeforeRemove,this),this.app.systems.on("initialize",this._onInitialize,this),this.app.systems.on("postInitialize",this._onPostInitialize,this),this.app.systems.on("update",this._onUpdate,this),this.app.systems.on("postUpdate",this._onPostUpdate,this)}}class Yv extends Qm{set customAabb(e){var t,i;this._customAabb=e,null==(i=this._instance)||null==(t=i.meshInstance)||t.setCustomAabb(this._customAabb)}get customAabb(){return this._customAabb}set instance(e){var t;if(this.destroyInstance(),this._instance=e,null==(t=this._instance)?void 0:t.meshInstance){var i=this._instance.meshInstance;i.node||(i.node=this.entity),i.castShadow=this._castShadows,i.setCustomAabb(this._customAabb),this._materialOptions&&this._instance.createMaterial(this._materialOptions),this.enabled&&this.entity.enabled&&this.addToLayers()}}get instance(){return this._instance}set materialOptions(e){this._materialOptions=Object.assign({},e),this._instance&&this._instance.createMaterial(this._materialOptions)}get materialOptions(){return this._materialOptions}get material(){var e;return null==(e=this._instance)?void 0:e.material}set castShadows(e){if(this._castShadows!==e){var t,i=null==(t=this.instance)?void 0:t.meshInstance;if(i){var s=this.layers,r=this.system.app.scene;if(this._castShadows&&!e)for(var n=0;n<s.length;n++){var a=r.layers.getLayerById(this.layers[n]);a&&a.removeShadowCasters([i])}if(i.castShadow=e,!this._castShadows&&e)for(var o=0;o<s.length;o++){var l=r.layers.getLayerById(s[o]);l&&l.addShadowCasters([i])}}this._castShadows=e}}get castShadows(){return this._castShadows}set layers(e){this.removeFromLayers(),this._layers.length=0;for(var t=0;t<e.length;t++)this._layers[t]=e[t];this.enabled&&this.entity.enabled&&this.addToLayers()}get layers(){return this._layers}set asset(e){var t=e instanceof fm?e.id:e;this._assetReference.id!==t&&(this._assetReference.asset&&this._assetReference.asset.resource&&this._onGSplatAssetRemove(),this._assetReference.id=t,this._assetReference.asset&&this._onGSplatAssetAdded())}get asset(){return this._assetReference.id}assignAsset(e){var t=e instanceof fm?e.id:e;this._assetReference.id=t}destroyInstance(){var e;this._instance&&(this.removeFromLayers(),null==(e=this._instance)||e.destroy(),this._instance=null)}addToLayers(){var e,t=null==(e=this.instance)?void 0:e.meshInstance;if(t)for(var i=this.system.app.scene.layers,s=0;s<this._layers.length;s++){var r;null==(r=i.getLayerById(this._layers[s]))||r.addMeshInstances([t])}}removeFromLayers(){var e,t=null==(e=this.instance)?void 0:e.meshInstance;if(t)for(var i=this.system.app.scene.layers,s=0;s<this._layers.length;s++){var r;null==(r=i.getLayerById(this._layers[s]))||r.removeMeshInstances([t])}}onRemoveChild(){this.removeFromLayers()}onInsertChild(){this._instance&&this.enabled&&this.entity.enabled&&this.addToLayers()}onRemove(){this.destroyInstance(),this.asset=null,this._assetReference.id=null,this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(e,t){this.addToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||this._instance&&e.addMeshInstances(this._instance.meshInstance)}onLayerRemoved(e){this.layers.indexOf(e.id)<0||this._instance&&e.removeMeshInstances(this._instance.meshInstance)}onEnable(){var e=this.system.app.scene,t=e.layers;this._evtLayersChanged=e.on("set:layers",this.onLayersChanged,this),t&&(this._evtLayerAdded=t.on("add",this.onLayerAdded,this),this._evtLayerRemoved=t.on("remove",this.onLayerRemoved,this)),this._instance?this.addToLayers():this.asset&&this._onGSplatAssetAdded()}onDisable(){var e,t,i,s=this.system.app.scene.layers;(null==(e=this._evtLayersChanged)||e.off(),this._evtLayersChanged=null,s)&&(null==(t=this._evtLayerAdded)||t.off(),this._evtLayerAdded=null,null==(i=this._evtLayerRemoved)||i.off(),this._evtLayerRemoved=null);this.removeFromLayers()}hide(){this._instance&&(this._instance.meshInstance.visible=!1)}show(){this._instance&&(this._instance.meshInstance.visible=!0)}_onGSplatAssetAdded(){this._assetReference.asset&&(this._assetReference.asset.resource?this._onGSplatAssetLoad():this.enabled&&this.entity.enabled&&this.system.app.assets.load(this._assetReference.asset))}_onGSplatAssetLoad(){this.destroyInstance();var e=this._assetReference.asset;e&&(this.instance=e.resource.createInstance())}_onGSplatAssetUnload(){this.destroyInstance()}_onGSplatAssetRemove(){this._onGSplatAssetUnload()}constructor(e,t){super(e,t),this._layers=[0],this._instance=null,this._customAabb=null,this._materialOptions=null,this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._castShadows=!1,this._assetReference=new $g("asset",this,e.app.assets,{add:this._onGSplatAssetAdded,load:this._onGSplatAssetLoad,remove:this._onGSplatAssetRemove,unload:this._onGSplatAssetUnload},this),t.on("remove",this.onRemoveChild,this),t.on("removehierarchy",this.onRemoveChild,this),t.on("insert",this.onInsertChild,this),t.on("inserthierarchy",this.onInsertChild,this)}}class Qv{constructor(){this.enabled=!0}}var Jv=["enabled"],$v=["castShadows","instance","asset","layers"];class Zv extends Jm{initializeComponentData(e,t,i){t.layers&&t.layers.length&&(t.layers=t.layers.slice(0));for(var s=0;s<$v.length;s++)t.hasOwnProperty($v[s])&&(e[$v[s]]=t[$v[s]]);t.aabbCenter&&t.aabbHalfExtents&&(e.customAabb=new Ci(new hi(t.aabbCenter),new hi(t.aabbHalfExtents))),super.initializeComponentData(e,t,Jv)}cloneComponent(e,t){for(var i=e.gsplat,s={},r=0;r<$v.length;r++)s[$v[r]]=i[$v[r]];s.enabled=i.enabled,delete s.instance;var n=this.addComponent(t,s);return i.instance&&(n.instance=i.instance.clone()),i.customAabb&&(n.customAabb=i.customAabb.clone()),n}onRemove(e,t){t.onRemove()}constructor(e){super(e),this.id="gsplat",this.ComponentType=Yv,this.DataType=Qv,this.schema=Jv,this.on("beforeremove",this.onRemove,this)}}Qm._buildAccessors(Yv.prototype,Jv);class e_ extends Ht{set meshes(e){this.decRefMeshes(),this._meshes=e,this.incRefMeshes(),this.fire("set:meshes",e)}get meshes(){return this._meshes}destroy(){this.meshes=null}decRefMeshes(){var e;null==(e=this._meshes)||e.forEach(((e,t)=>{e&&(e.decRefCount(),e.refCount<1&&(e.destroy(),this._meshes[t]=null))}))}incRefMeshes(){var e;null==(e=this._meshes)||e.forEach((e=>{null==e||e.incRefCount()}))}constructor(...e){super(...e),this._meshes=null}}function t_(e){var t=this;if(t.resource){var i=e.resource,s=i.renders&&i.renders[t.data.renderIndex];s&&(t.resource.meshes=s.resource.meshes)}}function i_(e){var t=this;t.registry.off("load:"+e.id,t_,t),t.registry.on("load:"+e.id,t_,t),t.registry.off("remove:"+e.id,s_,t),t.registry.once("remove:"+e.id,s_,t),e.resource?t_.call(t,e):t.registry.load(e)}function s_(e){var t=this;t.registry.off("load:"+e.id,t_,t),t.resource&&t.resource.destroy()}e_.EVENT_SETMESHES="set:meshes";class r_ extends ym{open(e,t){return new e_}patch(e,t){if(e.data.containerAsset){var i=t.get(e.data.containerAsset);i?i_.call(e,i):t.once("add:"+e.data.containerAsset,i_,e)}}constructor(e){super(e,"render"),this._registry=e.assets}}class n_{get paths(){return this._paths}get input(){return this._input}get output(){return this._output}get interpolation(){return this._interpolation}constructor(e,t,i,s){this._paths=e,this._input=t,this._output=i,this._interpolation=s}}class a_{get components(){return this._components}get data(){return this._data}constructor(e,t){this._components=e,this._data=t}}function o_(e,t){var i,s=(e,t)=>{switch(t){case i.DT_INT8:return new Int8Array(e.buffer,e.byteOffset,e.byteLength);case i.DT_INT16:return new Int16Array(e.buffer,e.byteOffset,e.byteLength/2);case i.DT_INT32:return new Int32Array(e.buffer,e.byteOffset,e.byteLength/4);case i.DT_UINT8:return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);case i.DT_UINT16:return new Uint16Array(e.buffer,e.byteOffset,e.byteLength/2);case i.DT_UINT32:return new Uint32Array(e.buffer,e.byteOffset,e.byteLength/4);case i.DT_FLOAT32:return new Float32Array(e.buffer,e.byteOffset,e.byteLength/4)}return null},r=e=>e.num_components()*(e=>{switch(e){case i.DT_INT8:return 1;case i.DT_INT16:return 2;case i.DT_INT32:return 4;case i.DT_UINT8:return 1;case i.DT_UINT16:return 2;case i.DT_UINT32:case i.DT_FLOAT32:return 4}return 1})(e.data_type()),n={0:0,1:1,5:2,2:3,7:4,8:5,4:6,3:7},a=(e,t)=>{for(var i=(e,t,i)=>{e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2]},s=(e,t,i)=>{e[0]=t[1]*i[2]-i[1]*t[2],e[1]=t[2]*i[0]-i[2]*t[0],e[2]=t[0]*i[1]-i[0]*t[1]},r=(e,t)=>{var i=e[t+0],s=e[t+1],r=e[t+2],n=1/Math.sqrt(i*i+s*s+r*r);e[t+0]*=n,e[t+1]*=n,e[t+2]*=n},n=(e,t,i)=>{for(var s=0;s<3;++s)e[s]=t[i+s]},a=t.length/3,o=e.length/3,l=new Float32Array(e.length),h=[0,0,0],c=[0,0,0],d=[0,0,0],u=[0,0,0],f=[0,0,0],p=[0,0,0],m=0;m<a;++m){var g=3*t[3*m+0],v=3*t[3*m+1],_=3*t[3*m+2];n(h,e,g),n(c,e,v),n(d,e,_),i(u,c,h),i(f,d,h),s(p,u,f),r(p,0);for(var b=0;b<3;++b)l[g+b]+=p[b],l[v+b]+=p[b],l[_+b]+=p[b]}for(var y=0;y<o;++y)r(l,3*y);return new Uint8Array(l.buffer)},o=e=>{var t=(e=>{var t={},o=new i.DecoderBuffer;o.Init(e,e.length);var l=new i.Decoder;if(l.GetEncodedGeometryType(o)!==i.TRIANGULAR_MESH)return t.error="Failed to decode draco mesh: not a mesh",t;var h=new i.Mesh,c=l.DecodeBufferToMesh(o,h);if(!c||!c.ok()||0===i.getPointer(h))return t.error="Failed to decode draco asset",t;var d=3*h.num_faces(),u=h.num_points()<=65535,f=d*(u?2:4),p=i._malloc(f);u?(l.GetTrianglesUInt16Array(h,f,p),t.indices=new Uint16Array(i.HEAPU16.buffer,p,d).slice().buffer):(l.GetTrianglesUInt32Array(h,f,p),t.indices=new Uint32Array(i.HEAPU32.buffer,p,d).slice().buffer),i._free(p);for(var m=[],g=0;g<h.num_attributes();++g)m.push(l.GetAttribute(h,g));m.sort(((e,t)=>{var i,s;return(null!=(i=n[e.attribute_type()])?i:n.length)-(null!=(s=n[t.attribute_type()])?s:n.length)})),t.attributes=m.map((e=>e.unique_id()));var v=0,_=m.map((e=>{var t=v;return v+=4*Math.ceil(r(e)/4),t})),b=m.some((e=>1===e.attribute_type())),y=_[1];if(!b){for(var x=1;x<_.length;++x)_[x]+=12;v+=12}t.vertices=new ArrayBuffer(h.num_points()*v);for(var S=new Uint8Array(t.vertices),w=0;w<h.num_attributes();++w){var T=m[w],C=r(T),E=h.num_points()*C,A=i._malloc(E);l.GetAttributeDataArrayForAllPoints(h,T,T.data_type(),E,A);for(var P=new Uint8Array(i.HEAPU8.buffer,A,E),D=0;D<h.num_points();++D)for(var L=0;L<C;++L)S[D*v+_[w]+L]=P[D*C+L];if(!b&&0===T.attribute_type())for(var M=a(s(P,T.data_type()),u?new Uint16Array(t.indices):new Uint32Array(t.indices)),I=0;I<h.num_points();++I)for(var R=0;R<12;++R)S[I*v+y+R]=M[12*I+R];i._free(A)}return i.destroy(h),i.destroy(l),i.destroy(o),t})(new Uint8Array(e.buffer));self.postMessage({jobId:e.jobId,error:t.error,indices:t.indices,vertices:t.vertices,attributes:t.attributes},[t.indices,t.vertices].filter((e=>null!=e)))},l=[];self.onmessage=e=>{var t=e.data;switch(t.type){case"init":self.DracoDecoderModule({instantiateWasm:(e,i)=>(WebAssembly.instantiate(t.module,e).then((e=>i(e))).catch((e=>console.error("instantiate failed + "+e))),{})}).then((e=>{i=e,l.forEach((e=>o(e)))}));break;case"decodeMesh":i?o(t):l.push(t)}}}class l_{init(e){for(e.forEach((e=>{e.addEventListener("message",(t=>{var i=t.data,s=this.jobCallbacks.get(i.jobId);if(s&&s(i.error,{indices:i.indices,vertices:i.vertices,attributes:i.attributes}),this.jobCallbacks.delete(i.jobId),this.jobQueue.length>0){var r=this.jobQueue.shift();this.run(e,r)}else{var n=this.workers[2].indexOf(e);if(-1!==n)this.workers[2].splice(n,1),this.workers[1].push(e);else{var a=this.workers[1].indexOf(e);-1!==a&&(this.workers[1].splice(a,1),this.workers[0].push(e))}}}))})),this.workers[0]=e;this.jobQueue.length&&(this.workers[0].length||this.workers[1].length);){var t=this.jobQueue.shift();if(this.workers[0].length>0){var i=this.workers[0].shift();this.workers[1].push(i),this.run(i,t)}else{var s=this.workers[1].shift();this.workers[2].push(s),this.run(s,t)}}}enqueueJob(e,t){var i={jobId:this.jobId++,buffer:e};if(this.jobCallbacks.set(i.jobId,t),this.workers[0].length>0){var s=this.workers[0].shift();this.workers[1].push(s),this.run(s,i)}else if(this.workers[1].length>0){var r=this.workers[1].shift();this.workers[2].push(r),this.run(r,i)}else this.jobQueue.push(i)}constructor(){this.workers=[[],[],[]],this.jobId=0,this.jobQueue=[],this.jobCallbacks=new Map,this.run=(e,t)=>{e.postMessage({type:"decodeMesh",jobId:t.jobId,buffer:t.buffer},[t.buffer])}}}var h_,c_=e=>{var t=()=>fetch(e).then((e=>e.arrayBuffer())).then((e=>WebAssembly.compile(e)));return WebAssembly.compileStreaming?WebAssembly.compileStreaming(fetch(e)).catch((e=>t())):t()},d_=(e,t)=>!!(e=>{if(h_)return!0;if(!e){var t=Xt.getConfig("DracoDecoderModule");e=t?{jsUrl:t.glueUrl,wasmUrl:t.wasmUrl,numWorkers:t.numWorkers}:{jsUrl:"draco.wasm.js",wasmUrl:"draco.wasm.wasm",numWorkers:1}}return!(!e.jsUrl||!e.wasmUrl||(h_=new l_,Promise.all([(i=e.jsUrl,new Promise(((e,t)=>{var s={cache:!0,responseType:"text",retry:!0,maxRetries:3};il.get(i,s,((i,s)=>{i?t(i):e(s)}))}))),c_(e.wasmUrl)]).then((t=>{for(var[i,s]=t,r=["/* draco */",i,"/* worker */","(\n"+o_.toString()+"\n)()\n\n"].join("\n"),n=new Blob([r],{type:"application/javascript"}),a=URL.createObjectURL(n),o=Math.max(1,Math.min(16,e.numWorkers||1)),l=[],h=0;h<o;++h){var c=new Worker(a);c.postMessage({type:"init",module:s}),l.push(c)}h_.init(l)})),0));var i})()&&(h_.enqueueJob(e,t),!0);function u_(e,t,i,s,r,n,a){try{var o=e[n](a),l=o.value}catch(e){return void i(e)}o.done?t(l):Promise.resolve(l).then(s,r)}function f_(e){return function(){var t=this,i=arguments;return new Promise((function(s,r){var n=e.apply(t,i);function a(e){u_(n,s,r,a,o,"next",e)}function o(e){u_(n,s,r,a,o,"throw",e)}a(void 0)}))}}class p_{destroy(){this.renders&&this.renders.forEach((e=>{e.meshes=null}))}}var m_=e=>/^data:[^\n\r,\u2028\u2029]*,.*$/i.test(e),g_=e=>{switch(e){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":default:return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}},v_=e=>{switch(e){case 5120:default:return 0;case 5121:return 1;case 5122:return 2;case 5123:return 3;case 5124:return 4;case 5125:return 5;case 5126:return 6}},__=e=>{switch(e){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5124:case 5125:case 5126:return 4;default:return 0}},b_={POSITION:Ji,NORMAL:$i,TANGENT:Zi,COLOR_0:is,JOINTS_0:ts,WEIGHTS_0:es,TEXCOORD_0:rs,TEXCOORD_1:ns,TEXCOORD_2:as,TEXCOORD_3:os,TEXCOORD_4:ls,TEXCOORD_5:hs,TEXCOORD_6:cs,TEXCOORD_7:ds},y_={[Ji]:0,[$i]:1,[Zi]:2,[is]:3,[ts]:4,[es]:5,[rs]:6,[ns]:7,[as]:8,[os]:9,[ls]:10,[hs]:11,[cs]:12,[ds]:13},x_=(e,t,i)=>{for(var s=(e=>{switch(e){case 0:return e=>Math.max(e/127,-1);case 1:return e=>e/255;case 2:return e=>Math.max(e/32767,-1);case 3:return e=>e/65535;default:return e=>e}})(i),r=t.length,n=0;n<r;++n)e[n]=s(t[n]);return e},S_=(e,t,i)=>{void 0===i&&(i=!1);var s,r=g_(e.type),n=(e=>{switch(e){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:return null}})(e.componentType);if(!n)return null;if(e.sparse){var a=e.sparse,o={count:a.count,type:"SCALAR"},l=S_(Object.assign(o,a.indices),t,!0),h={count:a.count,type:e.type,componentType:e.componentType},c=S_(Object.assign(h,a.values),t,!0);if(e.hasOwnProperty("bufferView")){var d={bufferView:e.bufferView,byteOffset:e.byteOffset,componentType:e.componentType,count:e.count,type:e.type};s=S_(d,t,!0).slice()}else s=new n(e.count*r);for(var u=0;u<a.count;++u)for(var f=l[u],p=0;p<r;++p)s[f*r+p]=c[u*r+p]}else if(e.hasOwnProperty("bufferView")){var m=t[e.bufferView];if(i&&m.hasOwnProperty("byteStride")){for(var g=r*n.BYTES_PER_ELEMENT,v=new ArrayBuffer(e.count*g),_=new Uint8Array(v),b=0,y=0;y<e.count;++y)for(var x=(e.byteOffset||0)+y*m.byteStride,S=0;S<g;++S)_[b++]=m[x++];s=new n(v)}else s=new n(m.buffer,m.byteOffset+(e.byteOffset||0),e.count*r)}else s=new n(e.count*r);return s},w_=(e,t)=>{var i=S_(e,t,!0);if(i instanceof Float32Array||!e.normalized)return i;var s=new Float32Array(i.length);return x_(s,i,v_(e.componentType)),s},T_=e=>{var t=e.min,i=e.max;if(!t||!i)return null;if(e.normalized){var s=v_(e.componentType);t=x_([],t,s),i=x_([],i,s)}return new Ci(new hi(.5*(i[0]+t[0]),.5*(i[1]+t[1]),.5*(i[2]+t[2])),new hi(.5*(i[0]-t[0]),.5*(i[1]-t[1]),.5*(i[2]-t[2])))},C_=e=>{if(!e.hasOwnProperty("mode"))return 4;switch(e.mode){case 0:return 0;case 1:return 1;case 2:return 2;case 3:return 3;case 4:default:return 4;case 5:return 5;case 6:return 6}},E_=(e,t)=>{var i=e[Ji];if(i&&3===i.components){var s;if(i.size!==i.stride){var r=i.stride/Js[i.type],n=new Qs[i.type](i.buffer,i.offset,i.count*r);s=new Qs[i.type](3*i.count);for(var a=0;a<i.count;++a)s[3*a+0]=n[a*r+0],s[3*a+1]=n[a*r+1],s[3*a+2]=n[a*r+2]}else s=new Qs[i.type](i.buffer,i.offset,3*i.count);var o=i.count;t||(t=(e=>{for(var t=new Uint16Array(e),i=0;i<e;i++)t[i]=i;return t})(o));var l=qu(s,t),h=new Float32Array(l.length);h.set(l),e[$i]={buffer:h.buffer,size:12,offset:0,stride:12,count:o,components:3,type:6}}},A_=e=>{var t=new fm(e.name+"_clone",e.type,e.file,e.data,e.options);return t.loaded=!0,t.resource=(e=>{var t=new ur(e.device,e);return t._levels=(e=>{for(var t=[],i=0;i<e._levels.length;++i){var s=[];if(e.cubemap)for(var r=0;r<6;++r)s.push(e._levels[i][r]);else s=e._levels[i];t.push(s)}return t})(e),t})(e.resource),e.registry.add(t),t},P_=(e,t,i,s,r,n)=>{var a={},o=[];for(var l in t)t.hasOwnProperty(l)&&b_.hasOwnProperty(l)&&(a[l]=t[l],o.push(l+":"+t[l]));o.sort();var h=o.join(),c=n[h];if(!c){var d={};for(var u in a){var f=s[t[u]],p=S_(f,r),m=r[f.bufferView],g=b_[u],v=g_(f.type)*__(f.componentType),_=m&&m.hasOwnProperty("byteStride")?m.byteStride:v;d[g]={buffer:p.buffer,size:v,offset:p.byteOffset,stride:_,count:f.count,components:g_(f.type),type:v_(f.componentType),normalize:f.normalized}}d.hasOwnProperty($i)||E_(d,i),c=((e,t)=>{var i=t[Ji];if(!i)return null;var s,r,n,a,o,l,h=i.count,c=[];for(var d in t)if(t.hasOwnProperty(d)){var u={semantic:d,components:t[d].components,type:t[d].type,normalize:!!t[d].normalize};Nr.isElementValid(e,u)||u.components++,c.push(u)}c.sort(((e,t)=>y_[e.semantic]-y_[t.semantic]));var f=new Nr(e,c),p=!0;for(s=0;s<f.elements.length;++s)if(l=(a=t[(o=f.elements[s]).name]).offset-i.offset,a.buffer!==i.buffer||a.stride!==o.stride||a.size!==o.size||l!==o.offset){p=!1;break}var m,g,v,_=new Ir(e,f,h),b=_.lock(),y=new Uint32Array(b);if(p)m=new Uint32Array(i.buffer,i.offset,h*_.format.size/4),y.set(m);else for(s=0;s<_.format.elements.length;++s){g=(o=_.format.elements[s]).stride/4,v=(a=t[o.name]).stride/4,m=new Uint32Array(a.buffer,a.offset,(a.count-1)*v+(a.size+3)/4);var x=0,S=o.offset/4,w=Math.floor((a.size+3)/4);for(r=0;r<h;++r){for(n=0;n<w;++n)y[S+n]=m[x+n];x+=v,S+=g}}return _.unlock(),_})(e,d),n[h]=c}return c},D_=(e,t,i,s,r,n,a,o,l)=>{var h=[];return t.primitives.forEach((c=>{var d;if(null==(d=c.extensions)?void 0:d.KHR_draco_mesh_compression)h.push(((e,t,i,s,r,n,a)=>{var o,l=new Gh(e);l.aabb=T_(i[t.attributes.POSITION]);var h=[];for(var[c,d]of Object.entries(t.attributes)){var u,f=i[d],p=b_[c],m=v_(f.componentType);h.push({semantic:p,components:g_(f.type),type:m,normalize:null!=(u=f.normalized)?u:p===is&&(1===m||3===m)})}if(a.push(new Promise(((i,r)=>{var n=t.extensions.KHR_draco_mesh_compression;d_(s[n.bufferView].slice().buffer,((s,a)=>{if(s)console.log(s),r(s);else{var o,c={};for(var[d,u]of Object.entries(n.attributes))c[b_[d]]=a.attributes.indexOf(u);h.sort(((e,t)=>c[e.semantic]-c[t.semantic])),(null==(o=t.attributes)?void 0:o.NORMAL)||h.splice(1,0,{semantic:"NORMAL",components:3,type:6});var f=new Nr(e,h),p=a.vertices.byteLength/f.size,m=p<=65535?1:2,g=a.indices.byteLength/(p<=65535?2:4),v=new Ir(e,f,p,{data:a.vertices}),_=new Eo(e,m,g,0,a.indices);l.vertexBuffer=v,l.indexBuffer[0]=_,l.primitive[0].type=C_(t),l.primitive[0].base=0,l.primitive[0].count=_?g:p,l.primitive[0].indexed=!!_,i()}}))}))),null==t||null==(o=t.extensions)?void 0:o.KHR_materials_variants){var g=t.extensions.KHR_materials_variants,v={};g.mappings.forEach((e=>{e.variants.forEach((t=>{v[t]=e.material}))})),r[l.id]=v}return n[l.id]=t.material,l})(e,c,i,s,n,a,l));else{var u=c.hasOwnProperty("indices")?S_(i[c.indices],s,!0):null,f=P_(e,c.attributes,u,i,s,r),p=C_(c),m=new Gh(e);if(m.vertexBuffer=f,m.primitive[0].type=p,m.primitive[0].base=0,m.primitive[0].indexed=null!==u,null!==u){var g;0===(g=u instanceof Uint8Array?0:u instanceof Uint16Array?1:2)&&e.isWebGPU&&(g=1,u=new Uint16Array(u));var v=new Eo(e,g,u.length,0,u);m.indexBuffer[0]=v,m.primitive[0].count=u.length}else m.primitive[0].count=f.numVertices;if(c.hasOwnProperty("extensions")&&c.extensions.hasOwnProperty("KHR_materials_variants")){var _=c.extensions.KHR_materials_variants,b={};_.mappings.forEach((e=>{e.variants.forEach((t=>{b[t]=e.material}))})),n[m.id]=b}a[m.id]=c.material;var y=i[c.attributes.POSITION];if(m.aabb=T_(y),c.hasOwnProperty("targets")){var x=[];c.targets.forEach(((e,r)=>{var n={};e.hasOwnProperty("POSITION")&&(y=i[e.POSITION],n.deltaPositions=w_(y,s),n.aabb=T_(y)),e.hasOwnProperty("NORMAL")&&(y=i[e.NORMAL],n.deltaNormals=w_(y,s)),t.hasOwnProperty("extras")&&t.extras.hasOwnProperty("targetNames")?n.name=t.extras.targetNames[r]:n.name=r.toString(10),t.hasOwnProperty("weights")&&(n.defaultWeight=t.weights[r]),n.preserveData=o.morphPreserveData,x.push(new zu(n))})),m.morph=new Nu(x,e,{preferHighPrecision:o.morphPreferHighPrecision})}h.push(m)}})),h},L_=(e,t,i)=>{var s,r,n=e.texCoord;if(n)for(r=0;r<i.length;++r)t[i[r]+"MapUv"]=n;var a=null==(s=e.extensions)?void 0:s.KHR_texture_transform;if(a){var o=a.offset||[0,0],l=a.scale||[1,1],h=a.rotation?-a.rotation*ti.RAD_TO_DEG:0,c=new di(l[0],l[1]),d=new di(o[0],1-l[1]-o[1]);for(r=0;r<i.length;++r)t[i[r]+"MapTiling"]=c,t[i[r]+"MapOffset"]=d,t[i[r]+"MapRotation"]=h}},M_=(e,t,i)=>{var s,r;if(e.hasOwnProperty("diffuseFactor")?(s=e.diffuseFactor,t.diffuse.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2)),t.opacity=s[3]):(t.diffuse.set(1,1,1),t.opacity=1),e.hasOwnProperty("diffuseTexture")){var n=e.diffuseTexture;r=i[n.index],t.diffuseMap=r,t.diffuseMapChannel="rgb",t.opacityMap=r,t.opacityMapChannel="a",L_(n,t,["diffuse","opacity"])}if(t.useMetalness=!1,e.hasOwnProperty("specularFactor")?(s=e.specularFactor,t.specular.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2))):t.specular.set(1,1,1),e.hasOwnProperty("glossinessFactor")?t.gloss=e.glossinessFactor:t.gloss=1,e.hasOwnProperty("specularGlossinessTexture")){var a=e.specularGlossinessTexture;t.specularMap=t.glossMap=i[a.index],t.specularMapChannel="rgb",t.glossMapChannel="a",L_(a,t,["gloss","metalness"])}},I_=(e,t,i)=>{if(e.hasOwnProperty("clearcoatFactor")?t.clearCoat=.25*e.clearcoatFactor:t.clearCoat=0,e.hasOwnProperty("clearcoatTexture")){var s=e.clearcoatTexture;t.clearCoatMap=i[s.index],t.clearCoatMapChannel="r",L_(s,t,["clearCoat"])}if(e.hasOwnProperty("clearcoatRoughnessFactor")?t.clearCoatGloss=e.clearcoatRoughnessFactor:t.clearCoatGloss=0,e.hasOwnProperty("clearcoatRoughnessTexture")){var r=e.clearcoatRoughnessTexture;t.clearCoatGlossMap=i[r.index],t.clearCoatGlossMapChannel="g",L_(r,t,["clearCoatGloss"])}if(e.hasOwnProperty("clearcoatNormalTexture")){var n=e.clearcoatNormalTexture;t.clearCoatNormalMap=i[n.index],L_(n,t,["clearCoatNormal"]),n.hasOwnProperty("scale")?t.clearCoatBumpiness=n.scale:t.clearCoatBumpiness=1}t.clearCoatGlossInvert=!0},R_=(e,t,i)=>{t.useLighting=!1,t.emissive.copy(t.diffuse),t.emissiveMap=t.diffuseMap,t.emissiveMapUv=t.diffuseMapUv,t.emissiveMapTiling.copy(t.diffuseMapTiling),t.emissiveMapOffset.copy(t.diffuseMapOffset),t.emissiveMapRotation=t.diffuseMapRotation,t.emissiveMapChannel=t.diffuseMapChannel,t.emissiveVertexColor=t.diffuseVertexColor,t.emissiveVertexColorChannel=t.diffuseVertexColorChannel,t.useLighting=!1,t.useSkybox=!1,t.diffuse.set(1,1,1),t.diffuseMap=null,t.diffuseVertexColor=!1},k_=(e,t,i)=>{if(t.useMetalnessSpecularColor=!0,e.hasOwnProperty("specularColorTexture")&&(t.specularMap=i[e.specularColorTexture.index],t.specularMapChannel="rgb",L_(e.specularColorTexture,t,["specular"])),e.hasOwnProperty("specularColorFactor")){var s=e.specularColorFactor;t.specular.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2))}else t.specular.set(1,1,1);e.hasOwnProperty("specularFactor")?t.specularityFactor=e.specularFactor:t.specularityFactor=1,e.hasOwnProperty("specularTexture")&&(t.specularityFactorMapChannel="a",t.specularityFactorMap=i[e.specularTexture.index],L_(e.specularTexture,t,["specularityFactor"]))},O_=(e,t,i)=>{e.hasOwnProperty("ior")&&(t.refractionIndex=1/e.ior)},F_=(e,t,i)=>{e.hasOwnProperty("dispersion")&&(t.dispersion=e.dispersion)},B_=(e,t,i)=>{t.blendType=2,t.useDynamicRefraction=!0,e.hasOwnProperty("transmissionFactor")&&(t.refraction=e.transmissionFactor),e.hasOwnProperty("transmissionTexture")&&(t.refractionMapChannel="r",t.refractionMap=i[e.transmissionTexture.index],L_(e.transmissionTexture,t,["refraction"]))},N_=(e,t,i)=>{if(t.useSheen=!0,e.hasOwnProperty("sheenColorFactor")){var s=e.sheenColorFactor;t.sheen.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2))}else t.sheen.set(1,1,1);e.hasOwnProperty("sheenColorTexture")&&(t.sheenMap=i[e.sheenColorTexture.index],L_(e.sheenColorTexture,t,["sheen"])),t.sheenGloss=e.hasOwnProperty("sheenRoughnessFactor")?e.sheenRoughnessFactor:0,e.hasOwnProperty("sheenRoughnessTexture")&&(t.sheenGlossMap=i[e.sheenRoughnessTexture.index],t.sheenGlossMapChannel="a",L_(e.sheenRoughnessTexture,t,["sheenGloss"])),t.sheenGlossInvert=!0},z_=(e,t,i)=>{if(t.blendType=2,t.useDynamicRefraction=!0,e.hasOwnProperty("thicknessFactor")&&(t.thickness=e.thicknessFactor),e.hasOwnProperty("thicknessTexture")&&(t.thicknessMap=i[e.thicknessTexture.index],t.thicknessMapChannel="g",L_(e.thicknessTexture,t,["thickness"])),e.hasOwnProperty("attenuationDistance")&&(t.attenuationDistance=e.attenuationDistance),e.hasOwnProperty("attenuationColor")){var s=e.attenuationColor;t.attenuation.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2))}},U_=(e,t,i)=>{e.hasOwnProperty("emissiveStrength")&&(t.emissiveIntensity=e.emissiveStrength)},V_=(e,t,i)=>{t.useIridescence=!0,e.hasOwnProperty("iridescenceFactor")&&(t.iridescence=e.iridescenceFactor),e.hasOwnProperty("iridescenceTexture")&&(t.iridescenceMapChannel="r",t.iridescenceMap=i[e.iridescenceTexture.index],L_(e.iridescenceTexture,t,["iridescence"])),e.hasOwnProperty("iridescenceIor")&&(t.iridescenceRefractionIndex=e.iridescenceIor),e.hasOwnProperty("iridescenceThicknessMinimum")&&(t.iridescenceThicknessMin=e.iridescenceThicknessMinimum),e.hasOwnProperty("iridescenceThicknessMaximum")&&(t.iridescenceThicknessMax=e.iridescenceThicknessMaximum),e.hasOwnProperty("iridescenceThicknessTexture")&&(t.iridescenceThicknessMapChannel="g",t.iridescenceThicknessMap=i[e.iridescenceThicknessTexture.index],L_(e.iridescenceThicknessTexture,t,["iridescenceThickness"]))},H_=(e,t)=>{var i,s,r=new sp;if(e.hasOwnProperty("name")&&(r.name=e.name),r.occludeSpecular=1,r.diffuseVertexColor=!0,r.specularTint=!0,r.specularVertexColor=!0,r.specular.set(1,1,1),r.gloss=1,r.glossInvert=!0,r.useMetalness=!0,e.hasOwnProperty("pbrMetallicRoughness")){var n=e.pbrMetallicRoughness;if(n.hasOwnProperty("baseColorFactor")&&(i=n.baseColorFactor,r.diffuse.set(Math.pow(i[0],1/2.2),Math.pow(i[1],1/2.2),Math.pow(i[2],1/2.2)),r.opacity=i[3]),n.hasOwnProperty("baseColorTexture")){var a=n.baseColorTexture;s=t[a.index],r.diffuseMap=s,r.diffuseMapChannel="rgb",r.opacityMap=s,r.opacityMapChannel="a",L_(a,r,["diffuse","opacity"])}if(n.hasOwnProperty("metallicFactor")&&(r.metalness=n.metallicFactor),n.hasOwnProperty("roughnessFactor")&&(r.gloss=n.roughnessFactor),n.hasOwnProperty("metallicRoughnessTexture")){var o=n.metallicRoughnessTexture;r.metalnessMap=r.glossMap=t[o.index],r.metalnessMapChannel="b",r.glossMapChannel="g",L_(o,r,["gloss","metalness"])}}if(e.hasOwnProperty("normalTexture")){var l=e.normalTexture;r.normalMap=t[l.index],L_(l,r,["normal"]),l.hasOwnProperty("scale")&&(r.bumpiness=l.scale)}if(e.hasOwnProperty("occlusionTexture")){var h=e.occlusionTexture;r.aoMap=t[h.index],r.aoMapChannel="r",L_(h,r,["ao"])}if(e.hasOwnProperty("emissiveFactor")&&(i=e.emissiveFactor,r.emissive.set(Math.pow(i[0],1/2.2),Math.pow(i[1],1/2.2),Math.pow(i[2],1/2.2))),e.hasOwnProperty("emissiveTexture")){var c=e.emissiveTexture;r.emissiveMap=t[c.index],L_(c,r,["emissive"])}if(e.hasOwnProperty("alphaMode"))switch(e.alphaMode){case"MASK":r.blendType=3,e.hasOwnProperty("alphaCutoff")?r.alphaTest=e.alphaCutoff:r.alphaTest=.5;break;case"BLEND":r.blendType=2,r.depthWrite=!1;break;default:r.blendType=3}else r.blendType=3;e.hasOwnProperty("doubleSided")?(r.twoSidedLighting=e.doubleSided,r.cull=e.doubleSided?0:1):(r.twoSidedLighting=!1,r.cull=1);var d={KHR_materials_clearcoat:I_,KHR_materials_emissive_strength:U_,KHR_materials_ior:O_,KHR_materials_dispersion:F_,KHR_materials_iridescence:V_,KHR_materials_pbrSpecularGlossiness:M_,KHR_materials_sheen:N_,KHR_materials_specular:k_,KHR_materials_transmission:B_,KHR_materials_unlit:R_,KHR_materials_volume:z_};if(e.hasOwnProperty("extensions"))for(var u in e.extensions){var f=d[u];void 0!==f&&f(e.extensions[u],r,t)}return r.update(),r},G_=new _i,W_=new hi,j_=(e,t,i)=>{var s=new Lc;if(e.hasOwnProperty("name")&&e.name.length>0?s.name=e.name:s.name="node_"+t,e.hasOwnProperty("matrix")&&(G_.data.set(e.matrix),G_.getTranslation(W_),s.setLocalPosition(W_),G_.getEulerAngles(W_),s.setLocalEulerAngles(W_),G_.getScale(W_),s.setLocalScale(W_)),e.hasOwnProperty("rotation")){var r=e.rotation;s.setLocalRotation(r[0],r[1],r[2],r[3])}if(e.hasOwnProperty("translation")){var n=e.translation;s.setLocalPosition(n[0],n[1],n[2])}if(e.hasOwnProperty("scale")){var a=e.scale;s.setLocalScale(a[0],a[1],a[2])}return e.hasOwnProperty("extensions")&&e.extensions.EXT_mesh_gpu_instancing&&i.set(e,{ext:e.extensions.EXT_mesh_gpu_instancing}),s},q_=(e,t)=>{var i="orthographic"===e.type?1:0,s=1===i?e.orthographic:e.perspective,r={enabled:!1,projection:i,nearClip:s.znear,aspectRatioMode:0};s.zfar&&(r.farClip=s.zfar),1===i?(r.orthoHeight=.5*s.ymag,s.ymag&&(r.aspectRatioMode=1,r.aspectRatio=s.xmag/s.ymag)):(r.fov=s.yfov*ti.RAD_TO_DEG,s.aspectRatio&&(r.aspectRatioMode=1,r.aspectRatio=s.aspectRatio));var n=new Lm(e.name);return n.addComponent("camera",r),n},X_=(e,t)=>{var i={enabled:!1,type:"point"===e.type?"omni":e.type,color:e.hasOwnProperty("color")?new ii(e.color):ii.WHITE,range:e.hasOwnProperty("range")?e.range:9999,falloffMode:1,intensity:e.hasOwnProperty("intensity")?ti.clamp(e.intensity,0,2):1};e.hasOwnProperty("spot")&&(i.innerConeAngle=e.spot.hasOwnProperty("innerConeAngle")?e.spot.innerConeAngle*ti.RAD_TO_DEG:0,i.outerConeAngle=e.spot.hasOwnProperty("outerConeAngle")?e.spot.outerConeAngle*ti.RAD_TO_DEG:Math.PI/4),e.hasOwnProperty("intensity")&&(i.luminance=e.intensity*Ru.getLightUnitConversion(Pu[i.type],i.outerConeAngle,i.innerConeAngle));var s=new Lm(t.name);return s.rotateLocal(90,0,0),s.addComponent("light",i),s},K_=(e,t,i,s)=>{if(!t.hasOwnProperty("skins")||0===t.skins.length)return[];var r=new Map;return t.skins.map((n=>((e,t,i,s,r,n)=>{var a,o,l,h=t.joints,c=h.length,d=[];if(t.hasOwnProperty("inverseBindMatrices")){var u=t.inverseBindMatrices,f=S_(i[u],s,!0),p=[];for(a=0;a<c;a++){for(o=0;o<16;o++)p[o]=f[16*a+o];(l=new _i).set(p),d.push(l)}}else for(a=0;a<c;a++)l=new _i,d.push(l);var m=[];for(a=0;a<c;a++)m[a]=r[h[a]].name;var g=m.join("#"),v=n.get(g);return v||(v=new If(e,d,m),n.set(g,v)),v})(e,n,t.accessors,s,i,r)))},Y_=(e,t,i,s)=>{var r,n;if(!e.hasOwnProperty("animations")||0===e.animations.length)return[];var a=null==s||null==(r=s.animation)?void 0:r.preprocess,o=null==s||null==(n=s.animation)?void 0:n.postprocess;return e.animations.map(((s,r)=>{a&&a(s);var n=((e,t,i,s,r,n,a)=>{var o,l=e=>new a_(g_(e.type),w_(e,s)),h={STEP:0,LINEAR:1,CUBICSPLINE:2},c={},d={},u={},f=1;for(o=0;o<e.samplers.length;++o){var p=e.samplers[o];c.hasOwnProperty(p.input)||(c[p.input]=l(i[p.input])),d.hasOwnProperty(p.output)||(d[p.output]=l(i[p.output]));var m=p.hasOwnProperty("interpolation")&&h.hasOwnProperty(p.interpolation)?h[p.interpolation]:1,g={paths:[],input:p.input,output:p.output,interpolation:m};u[o]=g}var v=[],_={translation:"localPosition",rotation:"localRotation",scale:"localScale"},b=e=>{for(var t=[];e;)t.unshift(e.name),e=e.parent;return t},y=(e,t,i)=>{var s=d[e.output];if(s){var r;if(n&&n[t.mesh]){var a=n[t.mesh];a.hasOwnProperty("extras")&&a.extras.hasOwnProperty("targetNames")&&(r=a.extras.targetNames)}for(var l=s.data,h=l.length/c[e.input].data.length,p=l.length/h,m=4*p,g=new ArrayBuffer(m*h),v=0;v<h;v++){for(var _=new Float32Array(g,m*v,p),b=0;b<p;b++)_[b]=l[b*h+v];var y=new a_(1,_),x=(null==r?void 0:r[v])?"name."+r[v]:v;d[-f]=y;var S={paths:[{entityPath:i,component:"graph",propertyPath:["weight."+x]}],input:e.input,output:-f,interpolation:e.interpolation};f++,u["morphCurve-"+o+"-"+v]=S}}};for(o=0;o<e.channels.length;++o){var x=e.channels[o],S=x.target,w=u[x.sampler],T=r[S.node],C=a[S.node],E=b(T);S.path.startsWith("weights")?(y(w,C,E),u[x.sampler].morphCurve=!0):w.paths.push({entityPath:E,component:"graph",propertyPath:[_[S.path]]})}var A=[],P=[],D=[];for(var L in c)A.push(c[L]),c[L]=A.length-1;for(var M in d)P.push(d[M]),d[M]=P.length-1;for(var I in u){var R=u[I];R.morphCurve||(D.push(new n_(R.paths,c[R.input],d[R.output],R.interpolation)),R.paths.length>0&&"localRotation"===R.paths[0].propertyPath[0]&&2!==R.interpolation&&v.push(D[D.length-1].output))}v.sort();var k,O=null;for(o=0;o<v.length;++o){var F=v[o];if(0===o||F!==O){if(4===(k=P[F]).components)for(var B=k.data,N=B.length-4,z=0;z<N;z+=4)B[z+0]*B[z+4]+B[z+1]*B[z+5]+B[z+2]*B[z+6]+B[z+3]*B[z+7]<0&&(B[z+4]*=-1,B[z+5]*=-1,B[z+6]*=-1,B[z+7]*=-1);O=F}}var U=0;for(o=0;o<A.length;o++)k=A[o]._data,U=Math.max(U,0===k.length?0:k[k.length-1]);return new vg(e.hasOwnProperty("name")?e.name:"animation_"+t,U,A,P,D)})(s,r,e.accessors,i,t,e.meshes,e.nodes);return o&&o(s,n),n}))},Q_=f_((function*(e,t,i,s,r){var n,a,o=null==r||null==(n=r.global)?void 0:n.preprocess,l=null==r||null==(a=r.global)?void 0:a.postprocess;o&&o(t);var h=new Map,c=((e,t,i)=>{var s,r,n;if(!e.hasOwnProperty("nodes")||0===e.nodes.length)return[];for(var a,o=null==t||null==(s=t.node)?void 0:s.preprocess,l=null!=(a=null==t||null==(r=t.node)?void 0:r.process)?a:j_,h=null==t||null==(n=t.node)?void 0:n.postprocess,c=e.nodes.map(((e,t)=>{o&&o(e);var s=l(e,t,i);return h&&h(e,s),s})),d=0;d<e.nodes.length;++d){var u=e.nodes[d];if(u.hasOwnProperty("children"))for(var f=c[d],p={},m=0;m<u.children.length;++m){var g=c[u.children[m]];g.parent||(p.hasOwnProperty(g.name)?g.name+=p[g.name]++:p[g.name]=1,f.addChild(g))}}return c})(t,r,h),d=((e,t)=>{var i,s=[],r=e.scenes.length;if(1===r&&1===(null==(i=e.scenes[0].nodes)?void 0:i.length)){var n=e.scenes[0].nodes[0];s.push(t[n])}else for(var a=0;a<r;a++){var o=e.scenes[a];if(o.nodes){for(var l=new Lc(o.name),h=0;h<o.nodes.length;h++){var c=t[o.nodes[h]];l.addChild(c)}s.push(l)}}return s})(t,c),u=((e,t,i)=>{var s=null;if(e.hasOwnProperty("nodes")&&e.hasOwnProperty("extensions")&&e.extensions.hasOwnProperty("KHR_lights_punctual")&&e.extensions.KHR_lights_punctual.hasOwnProperty("lights")){var r=e.extensions.KHR_lights_punctual.lights;if(r.length){var n,a,o,l,h=null==i||null==(n=i.light)?void 0:n.preprocess,c=null!=(l=null==i||null==(a=i.light)?void 0:a.process)?l:X_,d=null==i||null==(o=i.light)?void 0:o.postprocess;e.nodes.forEach(((e,i)=>{if(e.hasOwnProperty("extensions")&&e.extensions.hasOwnProperty("KHR_lights_punctual")&&e.extensions.KHR_lights_punctual.hasOwnProperty("light")){var n=e.extensions.KHR_lights_punctual.light,a=r[n];if(a){h&&h(a);var o=c(a,t[i]);d&&d(a,o),o&&(s||(s=new Map),s.set(e,o))}}}))}}return s})(t,c,r),f=((e,t,i)=>{var s=null;if(e.hasOwnProperty("nodes")&&e.hasOwnProperty("cameras")&&e.cameras.length>0){var r,n,a,o,l=null==i||null==(r=i.camera)?void 0:r.preprocess,h=null!=(o=null==i||null==(n=i.camera)?void 0:n.process)?o:q_,c=null==i||null==(a=i.camera)?void 0:a.postprocess;e.nodes.forEach(((i,r)=>{if(i.hasOwnProperty("camera")){var n=e.cameras[i.camera];if(n){l&&l(n);var a=h(n,t[r]);c&&c(n,a),a&&(s||(s=new Map),s.set(i,a))}}}))}return s})(t,c,r),p=(e=>{if(!e.hasOwnProperty("extensions")||!e.extensions.hasOwnProperty("KHR_materials_variants"))return null;for(var t=e.extensions.KHR_materials_variants.variants,i={},s=0;s<t.length;s++)i[t[s].name]=s;return i})(t),m=yield Promise.all(i),{meshes:g,meshVariants:v,meshDefaultMaterials:_,promises:b}=((e,t,i,s)=>{var r,n,a,o={},l={},h={},c=[];return{meshes:!s.skipMeshes&&(null==t||null==(r=t.meshes)?void 0:r.length)&&(null==t||null==(n=t.accessors)?void 0:n.length)&&(null==t||null==(a=t.bufferViews)?void 0:a.length)?t.meshes.map((r=>D_(e,r,t.accessors,i,o,l,h,s,c))):[],meshVariants:l,meshDefaultMaterials:h,promises:c}})(e,t,m,r),y=Y_(t,c,m,r);((e,t,i,s)=>{var r=t.accessors;i.forEach(((e,t)=>{var i,n,a,o=e.ext.attributes;if(o.hasOwnProperty("TRANSLATION")){var l=r[o.TRANSLATION];i=w_(l,s)}if(o.hasOwnProperty("ROTATION")){var h=r[o.ROTATION];n=w_(h,s)}if(o.hasOwnProperty("SCALE")){var c=r[o.SCALE];a=w_(c,s)}var d=(i?i.length/3:0)||(n?n.length/4:0)||(a?a.length/3:0);if(d){for(var u=new Float32Array(16*d),f=new hi,p=new bi,m=new hi(1,1,1),g=new _i,v=0,_=0;_<d;_++){var b=3*_;if(i&&f.set(i[b],i[b+1],i[b+2]),n){var y=4*_;p.set(n[y],n[y+1],n[y+2],n[y+3])}a&&m.set(a[b],a[b+1],a[b+2]),g.setTRS(f,p,m);for(var x=0;x<16;x++)u[v++]=g.data[x]}e.matrices=u}}))})(0,t,h,m);for(var x=yield Promise.all(s),S=((e,t,i)=>{var s,r,n;if(!e.hasOwnProperty("materials")||0===e.materials.length)return[];var a,o=null==i||null==(s=i.material)?void 0:s.preprocess,l=null!=(a=null==i||null==(r=i.material)?void 0:r.process)?a:H_,h=null==i||null==(n=i.material)?void 0:n.postprocess;return e.materials.map((e=>{o&&o(e);var i=l(e,t);return h&&h(e,i),i}))})(t,x.map((e=>e.resource)),r),w=K_(e,t,c,m),T=[],C=0;C<g.length;C++)T[C]=new e_,T[C].meshes=g[C];((e,t,i)=>{e.nodes.forEach((e=>{e.hasOwnProperty("mesh")&&e.hasOwnProperty("skin")&&t[e.mesh].meshes.forEach((t=>{t.skin=i[e.skin]}))}))})(t,T,w);var E=new p_;return E.gltf=t,E.nodes=c,E.scenes=d,E.animations=y,E.textures=x,E.materials=S,E.variants=p,E.meshVariants=v,E.meshDefaultMaterials=_,E.renders=T,E.skins=w,E.lights=u,E.cameras=f,E.nodeInstancingMap=h,l&&l(t,E),yield Promise.all(b),E})),J_=0,$_=e=>{var t,i,s,r,n,a;return null!=(a=null!=(n=null==(i=e.extensions)||null==(t=i.KHR_texture_basisu)?void 0:t.source)?n:null==(r=e.extensions)||null==(s=r.EXT_texture_webp)?void 0:s.source)?a:e.source},Z_=(e,t,i)=>{e&&e.toLowerCase().endsWith(".glb")||(()=>{var e=new Uint8Array(t);return 103===e[0]&&108===e[1]&&84===e[2]&&70===e[3]})()?((e,t)=>{var i=e instanceof ArrayBuffer?new DataView(e):new DataView(e.buffer,e.byteOffset,e.byteLength),s=i.getUint32(0,!0),r=i.getUint32(4,!0),n=i.getUint32(8,!0);if(1179937895===s)if(2===r)if(n<=0||n>i.byteLength)t("Invalid length found in glb header. Found "+n);else{for(var a=[],o=12;o<n;){var l=i.getUint32(o,!0);o+l+8>i.byteLength&&t("Invalid chunk length found in glb. Found "+l);var h=i.getUint32(o+4,!0),c=new Uint8Array(i.buffer,i.byteOffset+o+8,l);a.push({length:l,type:h,data:c}),o+=l+8}1===a.length||2===a.length?1313821514===a[0].type?a.length>1&&5130562!==a[1].type?t("Invalid chunk type found in glb file. Expected 0x004E4942, found 0x"+a[1].type.toString(16)):t(null,{gltfChunk:a[0].data,binaryChunk:2===a.length?a[1].data:null}):t("Invalid chunk type found in glb file. Expected 0x4E4F534A, found 0x"+a[0].type.toString(16)):t("Invalid number of chunks found in glb file.")}else t("Invalid version number found in glb header. Expected 2, found "+r);else t("Invalid magic number found in glb header. Expected 0x46546C67, found 0x"+s.toString(16))})(t,i):i(null,{gltfChunk:t,binaryChunk:null})};class eb{static parse(e,t,i,s,r,n,a){Z_(e,i,((e,i)=>{e?a(e):((e,t)=>{var i=JSON.parse((e=>{if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);for(var t="",i=0;i<e.length;i++)t+=String.fromCharCode(e[i]);return decodeURIComponent(escape(t))})(e));i.asset&&i.asset.version&&parseFloat(i.asset.version)<2?t("Invalid gltf version. Expected version 2.0 or above but found version '"+i.asset.version+"'."):t(null,i)})(i.gltfChunk,((e,o)=>{if(e)a(e);else{var l=((e,t,i,s)=>{var r,n,a;if(!e.buffers||0===e.buffers.length)return[];var o=null==s||null==(r=s.buffer)?void 0:r.preprocess,l=null==s||null==(n=s.buffer)?void 0:n.processAsync,h=null==s||null==(a=s.buffer)?void 0:a.postprocess;return e.buffers.map(((s,r)=>{var n;return o&&o(s),n=new Promise(l?(e,t)=>{l(s,((i,s)=>{i?t(i):e(s)}))}:e=>{e(null)}),n=n.then((e=>{if(e)return e;if(s.hasOwnProperty("uri")){if(m_(s.uri)){for(var r=atob(s.uri.split(",")[1]),n=new Uint8Array(r.length),a=0;a<r.length;a++)n[a]=r.charCodeAt(a);return n}return new Promise(((e,t)=>{il.get(lm.test(s.uri)?s.uri:kt.join(i,s.uri),{cache:!0,responseType:"arraybuffer",retry:!1},((i,s)=>{i?t(i):e(new Uint8Array(s))}))}))}return t})),h&&(n=n.then((t=>(h(e.buffers[r],t),t)))),n}))})(o,i.binaryChunk,t,n),h=((e,t,i)=>{var s,r,n,a,o=function(i){var s=e.bufferViews[i];h&&h(s);var r=void 0;r=new Promise(c?(e,i)=>{c(s,t,((t,s)=>{t?i(t):e(s)}))}:e=>{e(null)}),r=r.then((e=>e||t[s.buffer].then((e=>new Uint8Array(e.buffer,e.byteOffset+(s.byteOffset||0),s.byteLength))))),s.hasOwnProperty("byteStride")&&(r=r.then((e=>(e.byteStride=s.byteStride,e)))),d&&(r=r.then((e=>(d(s,e),e)))),l.push(r)},l=[],h=null==i||null==(s=i.bufferView)?void 0:s.preprocess,c=null==i||null==(r=i.bufferView)?void 0:r.processAsync,d=null==i||null==(n=i.bufferView)?void 0:n.postprocess;if(!(null==(a=e.bufferViews)?void 0:a.length))return l;for(var u=0;u<e.bufferViews.length;++u)o(u);return l})(o,l,n),c=((e,t,i,s,r)=>{var n,a,o;if(!e.images||0===e.images.length)return[];var l=null==r||null==(n=r.image)?void 0:n.preprocess,h=null==r||null==(a=r.image)?void 0:a.processAsync,c=null==r||null==(o=r.image)?void 0:o.postprocess,d={"image/png":"png","image/jpeg":"jpg","image/basis":"basis","image/ktx":"ktx","image/ktx2":"ktx2","image/vnd-ms.dds":"dds"},u=(e,t,i,r,n,a)=>new Promise(((o,l)=>{var h=i=>{var h=(e.name||"gltf-texture")+"-"+J_++,c={url:t||h};if(i&&(c.contents=i.slice(0).buffer),r){var u=d[r];u&&(c.filename=c.url+"."+u)}var f=new fm(h,"texture",c,{srgb:a},n);f.on("load",(e=>o(e))),f.on("error",(e=>l(e))),s.add(f),s.load(f)};i?i.then((e=>h(e))):h(null)})),f=(e=>{var t=new Set;return e.hasOwnProperty("materials")&&e.materials.forEach((i=>{if(i.hasOwnProperty("pbrMetallicRoughness")){var s=i.pbrMetallicRoughness;if(s.hasOwnProperty("baseColorTexture")){var r=e.textures[s.baseColorTexture.index];t.add($_(r))}}if(i.hasOwnProperty("emissiveTexture")){var n=e.textures[i.emissiveTexture.index];t.add($_(n))}if(i.hasOwnProperty("extensions")){var a=i.extensions.KHR_materials_sheen;if(a&&a.hasOwnProperty("sheenColorTexture")){var o=e.textures[a.sheenColorTexture.index];t.add($_(o))}var l=i.extensions.KHR_materials_pbrSpecularGlossiness;if(l&&l.hasOwnProperty("specularGlossinessTexture")){var h=e.textures[l.specularGlossinessTexture.index];t.add($_(h))}var c=i.extensions.KHR_materials_specular;if(c&&c.hasOwnProperty("specularColorTexture")){var d=e.textures[c.specularColorTexture.index];t.add($_(d))}}})),t})(e);return e.images.map(((e,s)=>{var r;return l&&l(e),r=new Promise(h?(t,i)=>{h(e,((e,s)=>{e?i(e):t(s)}))}:e=>{e(null)}),r=r.then((r=>{var n,a=f.has(s);return r||(e.hasOwnProperty("uri")?m_(e.uri)?u(e,e.uri,null,(n=e.uri).substring(n.indexOf(":")+1,n.indexOf(";")),null,a):u(e,lm.test(e.uri)?e.uri:kt.join(i,e.uri),null,null,{crossOrigin:"anonymous"},a):e.hasOwnProperty("bufferView")&&e.hasOwnProperty("mimeType")?u(e,null,t[e.bufferView],e.mimeType,null,a):Promise.reject(new Error("Invalid image found in gltf (neither uri or bufferView found). index="+s)))})),c&&(r=r.then((t=>(c(e,t),t)))),r}))})(o,h,t,r,n),d=((e,t,i)=>{var s,r,n,a,o;if(!(null==e||null==(s=e.images)?void 0:s.length)||!(null==e||null==(r=e.textures)?void 0:r.length))return[];var l=null==i||null==(n=i.texture)?void 0:n.preprocess,h=null==i||null==(a=i.texture)?void 0:a.processAsync,c=null==i||null==(o=i.texture)?void 0:o.postprocess,d=new Set;return e.textures.map((i=>{var s;return l&&l(i),s=new Promise(h?(t,s)=>{h(i,e.images,((e,i)=>{e?s(e):t(i)}))}:e=>{e(null)}),s=s.then((s=>{s=null!=s?s:$_(i);var r=d.has(s);return d.add(s),t[s].then((t=>{var s,n,a,o,l,h=r?A_(t):t;return n=h.resource,a=(null!=(s=e.samplers)?s:[])[i.sampler],o=(e,t)=>{switch(e){case 9728:return 0;case 9729:return 1;case 9984:return 2;case 9985:return 4;case 9986:return 3;case 9987:return 5;default:return t}},l=(e,t)=>{switch(e){case 33071:return 1;case 33648:return 2;case 10497:return 0;default:return t}},n&&(a=null!=a?a:{},n.minFilter=o(a.minFilter,5),n.magFilter=o(a.magFilter,1),n.addressU=l(a.wrapS,0),n.addressV=l(a.wrapT,0)),h}))})),c&&(s=s.then((e=>(c(i,e),e)))),s}))})(o,c,n);Q_(s,o,h,d,n).then((e=>a(null,e))).catch((e=>a(e)))}}))}))}static createDefaultMaterial(){return H_({name:"defaultGlbMaterial"},[])}}class tb extends ym{load(e,t){"string"==typeof e&&(e={load:e,original:e});var i={retry:this.maxRetries>0,maxRetries:this.maxRetries};e.load.startsWith("blob:")&&(i.responseType=tl.ResponseType.JSON),il.get(e.load,i,((i,s)=>{i?t("Error loading animation clip resource: "+e.original+" ["+i+"]"):t(null,s)}))}open(e,t){var i=t.name,s=t.duration,r=t.inputs.map((e=>new a_(1,e))),n=t.outputs.map((e=>new a_(e.components,e.data))),a=t.curves.map((e=>new n_([e.path],e.inputIndex,e.outputIndex,e.interpolation)));return new vg(i,s,r,n,a)}constructor(e){super(e,"animclip")}}class ib extends ym{load(e,t){"string"==typeof e&&(e={load:e,original:e});var i={retry:this.maxRetries>0,maxRetries:this.maxRetries};e.load.startsWith("blob:")&&(i.responseType=tl.ResponseType.JSON),il.get(e.load,i,((i,s)=>{i?t("Error loading animation state graph resource: "+e.original+" ["+i+"]"):t(null,s)}))}open(e,t){return new Ng(t)}constructor(e){super(e,"animstategraph")}}class sb extends ym{load(e,t){"string"==typeof e&&(e={load:e,original:e}),il.get(e.load,{responseType:tl.ResponseType.ARRAY_BUFFER,retry:this.maxRetries>0,maxRetries:this.maxRetries},((i,s)=>{i?t("Error loading binary resource: "+e.original+" ["+i+"]"):t(null,s)}))}openBinary(e){return e.buffer}constructor(e){super(e,"binary")}}class rb{get model(){if(!this._model){var e=rb.createModel(this.data,this._defaultMaterial),t=rb.createAsset(this._assetName,"model",e,0);this._assets.add(t),this._model=t}return this._model}static createAsset(e,t,i,s){var r=new fm(e+"/"+t+"/"+s,t,{url:""});return r.resource=i,r.loaded=!0,r}instantiateModelEntity(e){var t=new Lm(void 0,this._assets._loader._app);return t.addComponent("model",Object.assign({type:"asset",asset:this.model},e)),t}instantiateRenderEntity(e){var t=this._defaultMaterial,i=[],s=function(e,s,r,n,a,o,l,h){var c=a[r.id],d=void 0===c?t:n[c],u=new tc(r,d);r.morph&&(u.morphInstance=new Fu(r.morph)),l.hasOwnProperty("skin")&&i.push({meshInstance:u,rootBone:e,entity:s});var f=h.get(l);if(f){var p=f.matrices,m=Nr.getDefaultInstancingFormat(r.device),g=new Ir(r.device,m,p.length/16,{data:p});u.setInstancing(g),u.instancingData._destroyVertexBuffer=!0}return u},r=(t,i,n)=>{var a=new Lm(void 0,this._assets._loader._app);i._cloneInternal(a),t||(t=a);for(var o=null,l=null,h=0;h<n.nodes.length;h++){if(n.nodes[h]===i){var c=n.gltf.nodes[h];if(c.hasOwnProperty("mesh")){var d=n.renders[c.mesh].meshes;l=this.renders[c.mesh];for(var u=0;u<d.length;u++){var f=d[u];if(f){var p=s(t,a,f,n.materials,n.meshDefaultMaterials,n.skins,c,n.nodeInstancingMap);o||(o=[]),o.push(p)}}}if(n.lights){var m=n.lights.get(c);m&&a.addChild(m.clone())}if(n.cameras){var g=n.cameras.get(c);g&&g.camera.system.cloneComponent(g,a)}}}o&&(a.addComponent("render",Object.assign({type:"asset",meshInstances:o},e)),a.render.assignAsset(l));for(var v=i.children,_=0;_<v.length;_++){var b=r(t,v[_],n);a.addChild(b)}return a},n=[];for(var a of this.data.scenes)n.push(r(null,a,this.data));return i.forEach((e=>{e.meshInstance.skinInstance=Jg.createCachedSkinInstance(e.meshInstance.mesh.skin,e.rootBone,e.entity),e.meshInstance.node.render.rootBone=e.rootBone})),rb.createSceneHierarchy(n,Lm)}getMaterialVariants(){return this.data.variants?Object.keys(this.data.variants):[]}applyMaterialVariant(e,t){var i=t?this.data.variants[t]:null;if(void 0!==i)for(var s=e.findComponents("render"),r=0;r<s.length;r++){var n=s[r];this._applyMaterialVariant(i,n.meshInstances)}}applyMaterialVariantInstances(e,t){var i=t?this.data.variants[t]:null;void 0!==i&&this._applyMaterialVariant(i,e)}_applyMaterialVariant(e,t){t.forEach((t=>{if(null===e)t.material=this._defaultMaterial;else{var i=this.data.meshVariants[t.mesh.id];i&&(t.material=this.data.materials[i[e]])}}))}static createSceneHierarchy(e,t){var i=null;if(1===e.length)i=e[0];else for(var s of(i=new t("SceneGroup"),e))i.addChild(s);return i}static createModel(e,t){var i=function(i,s,r,n,a,o,l){var h=e.meshDefaultMaterials[s.id],c=void 0===h?t:a[h],d=new tc(s,c,o);if(s.morph){var u=new Fu(s.morph);d.morphInstance=u,i.morphInstances.push(u)}if(l.hasOwnProperty("skin")){var f=l.skin,p=r[f];s.skin=p;var m=n[f];d.skinInstance=m,i.skinInstances.push(m)}i.meshInstances.push(d)},s=new Bu,r=[];for(var n of e.skins){var a=new zh(n);a.bones=n.bones,r.push(a)}s.graph=rb.createSceneHierarchy(e.scenes,Lc);for(var o=0;o<e.nodes.length;o++){var l=e.nodes[o];if(l.root===s.graph){var h=e.gltf.nodes[o];if(h.hasOwnProperty("mesh"))for(var c=e.renders[h.mesh].meshes,d=0;d<c.length;d++){var u=c[d];u&&i(s,u,e.skins,r,e.materials,l,h)}}}return s}destroy(){var e=this._assets,t=function(t){e.remove(t),t.unload()},i=function(e){e.forEach((e=>{t(e)}))};this.animations&&(i(this.animations),this.animations=null),this.textures&&(i(this.textures),this.textures=null),this.materials&&(i(this.materials),this.materials=null),this.renders&&(i(this.renders),this.renders=null),this._model&&(t(this._model),this._model=null),this.data=null,this.assets=null}constructor(e,t,i,s){for(var r=function(e,s,r){var n=rb.createAsset(t.name,e,s,r);return i.add(n),n},n=[],a=0;a<e.renders.length;++a)n.push(r("render",e.renders[a],a));for(var o=[],l=0;l<e.materials.length;++l)o.push(r("material",e.materials[l],l));for(var h=[],c=0;c<e.animations.length;++c)h.push(r("animation",e.animations[c],c));this.data=e,this._model=null,this._assetName=t.name,this._assets=i,this._defaultMaterial=s,this.renders=n,this.materials=o,this.textures=e.textures,this.animations=h}}class nb{_getUrlWithoutParams(e){return e.indexOf("?")>=0?e.split("?")[0]:e}load(e,t,i){fm.fetchArrayBuffer(e.load,((s,r)=>{s?t(s):eb.parse(this._getUrlWithoutParams(e.original),kt.extractPath(e.load),r,this._device,i.registry,i.options,((e,s)=>{e?t(e):t(null,new rb(s,i,this._assets,this._defaultMaterial))}))}),i,this.maxRetries)}open(e,t,i){return t}patch(e,t){}constructor(e,t,i){this._device=e,this._assets=t,this._defaultMaterial=eb.createDefaultMaterial(),this.maxRetries=i}}class ab extends ym{set maxRetries(e){for(var t in this.glbContainerParser.maxRetries=e,this.parsers)this.parsers.hasOwnProperty(t)&&(this.parsers[t].maxRetries=e)}get maxRetries(){return this.glbContainerParser.maxRetries}_getUrlWithoutParams(e){return e.indexOf("?")>=0?e.split("?")[0]:e}_getParser(e){var t=e?kt.getExtension(this._getUrlWithoutParams(e)).toLowerCase().replace(".",""):null;return this.parsers[t]||this.glbContainerParser}load(e,t,i){"string"==typeof e&&(e={load:e,original:e}),this._getParser(e.original).load(e,t,i)}open(e,t,i){return this._getParser(e).open(e,t,i)}constructor(e){super(e,"container"),this.glbContainerParser=new nb(e.graphicsDevice,e.assets,0),this.parsers={}}}class ob extends ym{load(e,t,i){this.loadAssets(i,t)}open(e,t,i){return i?i.resource:null}patch(e,t){this.loadAssets(e,((i,s)=>{i&&(t.fire("error",e),t.fire("error:"+e.id,i,e),e.fire("error",e))}))}getAssetIds(e){var t=[];if(t[0]=e.file,(e.loadFaces||!e.file)&&e.data&&e.data.textures)for(var i=0;i<6;++i)t[i+1]=e.data.textures[i];else t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=null;return t}compareAssetIds(e,t){return e&&t?parseInt(e,10)===e||"string"==typeof e?e===t:e.url===t.url:null!==e==(null!==t)}update(e,t,i){var s,r,n,a=e.data||{},o=e._handlerState.assets,l=e._resources,h=[null,null,null,null,null,null,null],c=function(){return a.hasOwnProperty("type")?a.type:a.hasOwnProperty("rgbm")?a.rgbm?bs:_s:null};if(e.loaded&&i[0]===o[0])h[1]=l[1]||null,h[2]=l[2]||null,h[3]=l[3]||null,h[4]=l[4]||null,h[5]=l[5]||null,h[6]=l[6]||null;else if(i[0])if((s=i[0].resource).cubemap)for(n=0;n<6;++n)h[n+1]=new ur(this._device,{name:e.name+"_prelitCubemap"+(s.width>>n),cubemap:!0,type:c()||s.type,width:s.width>>n,height:s.height>>n,format:s.format,levels:[s._levels[n]],addressU:1,addressV:1,mipmaps:0===n});else h[1]=s;var d=i.slice(1);if(e.loaded&&this.cmpArrays(d,o.slice(1)))h[0]=l[0]||null;else if(-1===d.indexOf(null)){var u=d.map((e=>e.resource)),f=[];for(r=0;r<u[0]._levels.length;++r)f.push(u.map((e=>e._levels[r])));var p,m=u[0].format,g=new ur(this._device,{name:e.name+"_faces",cubemap:!0,type:c()||u[0].type,width:u[0].width,height:u[0].height,format:6===m?7:m,mipmaps:null==(p=a.mipmaps)||p,levels:f,minFilter:a.hasOwnProperty("minFilter")?a.minFilter:u[0].minFilter,magFilter:a.hasOwnProperty("magFilter")?a.magFilter:u[0].magFilter,anisotropy:a.hasOwnProperty("anisotropy")?a.anisotropy:1,addressU:1,addressV:1});h[0]=g}if(!this.cmpArrays(h,l))for(e.resources=h,e._handlerState.assetIds=t,e._handlerState.assets=i,n=0;n<l.length;++n)null!==l[n]&&-1===h.indexOf(l[n])&&l[n].destroy();for(n=0;n<o.length;++n)null!==o[n]&&-1===i.indexOf(o[n])&&o[n].unload()}cmpArrays(e,t){if(e.length!==t.length)return!1;for(var i=0;i<e.length;++i)if(e[i]!==t[i])return!1;return!0}resolveId(e){var t=parseInt(e,10);return t===e||t.toString()===e?t:e}loadAssets(e,t){e.hasOwnProperty("_handlerState")||(e._handlerState={assetIds:[null,null,null,null,null,null,null],assets:[null,null,null,null,null,null,null]});for(var i,s=this,r=s.getAssetIds(e),n=[null,null,null,null,null,null,null],a=e._handlerState.assetIds,o=e._handlerState.assets,l=s._registry,h=7,c=function(i,a){n[i]=a,0===--h&&(s.update(e,r,n),t(null,e.resources))},d=function(e,i,s){t(i)},u=function(e,t){t.loaded?c(e,t):(l.once("load:"+t.id,c.bind(s,e)),l.once("error:"+t.id,d.bind(s,e)),t.loading||l.load(t))},f=0;f<7;++f){var p=this.resolveId(r[f]);if(p)if(s.compareAssetIds(p,a[f]))u(f,o[f]);else if(parseInt(p,10)===p)(i=l.get(p))?u(f,i):setTimeout(((e,t)=>{var i=l.get(t);i?u(e,i):d(0,"failed to find dependent cubemap asset="+t)}).bind(null,f,p));else{var m="string"==typeof p?{url:p,filename:p}:p,g=-1===m.url.search(".dds")?{type:"rgbp",addressu:"clamp",addressv:"clamp",mipmaps:!1}:null;i=new fm(e.name+"_part_"+f,"texture",m,g),l.add(i),u(f,i)}else c(f,null)}}constructor(e){super(e,"cubemap"),this._device=e.graphicsDevice,this._registry=e.assets,this._loader=e.loader}}var lb=.28209479177387814;class hb{constructor(e,t,i,s,r,n){var a=(e,t)=>{var i=(1<<t)-1;return(e&i)/i},o=(e,t)=>{e.x=a(t>>>21,11),e.y=a(t>>>11,10),e.z=a(t,11)},l=(e,t,i)=>e*(1-i)+t*i,{chunkData:h,chunkSize:c,vertexData:d,shData0:u,shData1:f,shData2:p,shBands:m}=e,g=[3,8,15][m-1];this.read=e=>{var v=Math.floor(e/256)*c;if(t&&(o(t,d[4*e+0]),t.x=l(h[v+0],h[v+3],t.x),t.y=l(h[v+1],h[v+4],t.y),t.z=l(h[v+2],h[v+5],t.z)),i&&((e,t)=>{var i=1/(.5*Math.sqrt(2)),s=(a(t>>>20,10)-.5)*i,r=(a(t>>>10,10)-.5)*i,n=(a(t,10)-.5)*i,o=Math.sqrt(1-(s*s+r*r+n*n));switch(t>>>30){case 0:e.set(s,r,n,o);break;case 1:e.set(o,r,n,s);break;case 2:e.set(r,o,n,s);break;case 3:e.set(r,n,o,s)}})(i,d[4*e+1]),s&&(o(s,d[4*e+2]),s.x=l(h[v+6],h[v+9],s.x),s.y=l(h[v+7],h[v+10],s.y),s.z=l(h[v+8],h[v+11],s.z)),r&&(((e,t)=>{e.x=a(t>>>24,8),e.y=a(t>>>16,8),e.z=a(t>>>8,8),e.w=a(t,8)})(r,d[4*e+3]),c>12&&(r.x=l(h[v+12],h[v+15],r.x),r.y=l(h[v+13],h[v+16],r.y),r.z=l(h[v+14],h[v+17],r.z))),n&&m>0)for(var _=[u,f,p],b=0;b<3;++b)for(var y=0;y<15;++y)n[15*b+y]=y<g?_[b][16*e+y]*(8/255)-4:0}}}class cb{createIter(e,t,i,s,r){return new hb(this,e,t,i,s,r)}calcAabb(e){for(var{chunkData:t,numChunks:i,chunkSize:s}=this,r=Math.exp(Math.max(t[9],t[10],t[11])),n=t[0]-r,a=t[1]-r,o=t[2]-r,l=t[3]+r,h=t[4]+r,c=t[5]+r,d=1;d<i;++d){var u=d*s;r=Math.exp(Math.max(t[u+9],t[u+10],t[u+11])),n=Math.min(n,t[u+0]-r),a=Math.min(a,t[u+1]-r),o=Math.min(o,t[u+2]-r),l=Math.max(l,t[u+3]+r),h=Math.max(h,t[u+4]+r),c=Math.max(c,t[u+5]+r)}return e.center.set(.5*(n+l),.5*(a+h),.5*(o+c)),e.halfExtents.set(.5*(l-n),.5*(h-a),.5*(c-o)),!0}getCenters(e){for(var t,i,s,r,n,a,{vertexData:o,chunkData:l,numChunks:h,chunkSize:c}=this,d=0;d<h;++d){var u=d*c;t=l[u+0],i=l[u+1],s=l[u+2],r=l[u+3],n=l[u+4],a=l[u+5];for(var f=Math.min(this.numSplats,256*(d+1)),p=256*d;p<f;++p){var m=o[4*p],g=(m>>>21)/2047,v=(m>>>11&1023)/1023,_=(2047&m)/2047;e[3*p+0]=(1-g)*t+g*r,e[3*p+1]=(1-v)*i+v*n,e[3*p+2]=(1-_)*s+_*a}}}getChunks(e){for(var t,i,s,r,n,a,{chunkData:o,numChunks:l,chunkSize:h}=this,c=0;c<l;++c){var d=c*h;t=o[d+0],i=o[d+1],s=o[d+2],r=o[d+3],n=o[d+4],a=o[d+5],e[6*c+0]=t,e[6*c+1]=i,e[6*c+2]=s,e[6*c+3]=r,e[6*c+4]=n,e[6*c+5]=a}}calcFocalPoint(e){var{chunkData:t,numChunks:i,chunkSize:s}=this;e.x=0,e.y=0,e.z=0;for(var r=0;r<i;++r){var n=r*s;e.x+=t[n+0]+t[n+3],e.y+=t[n+1]+t[n+4],e.z+=t[n+2]+t[n+5]}e.mulScalar(.5/i)}get isCompressed(){return!0}get numChunks(){return Math.ceil(this.numSplats/256)}get chunkSize(){return this.chunkData.length/this.numChunks}decompress(){var e=["x","y","z","f_dc_0","f_dc_1","f_dc_2","opacity","scale_0","scale_1","scale_2","rot_0","rot_1","rot_2","rot_3"],{shBands:t}=this;if(t>0){for(var i=[],s=0;s<45;++s)i.push("f_rest_"+s);e.splice(e.indexOf("f_dc_0")+1,0,...i)}var r={};e.forEach((e=>{r[e]=new Float32Array(this.numSplats)}));for(var n=new hi,a=new bi,o=new hi,l=new ui,h=t>0?new Float32Array(45):null,c=this.createIter(n,a,o,l,h),d=0;d<this.numSplats;++d)if(c.read(d),r.x[d]=n.x,r.y[d]=n.y,r.z[d]=n.z,r.rot_1[d]=a.x,r.rot_2[d]=a.y,r.rot_3[d]=a.z,r.rot_0[d]=a.w,r.scale_0[d]=o.x,r.scale_1[d]=o.y,r.scale_2[d]=o.z,r.f_dc_0[d]=(l.x-.5)/lb,r.f_dc_1[d]=(l.y-.5)/lb,r.f_dc_2[d]=(l.z-.5)/lb,r.opacity[d]=l.w<=0?-40:l.w>=1?40:-Math.log(1/l.w-1),h)for(var u=0;u<45;++u)r["f_rest_"+u][d]=h[u];return new Op([{name:"vertex",count:this.numSplats,properties:e.map((e=>({name:e,type:"float",byteSize:4,storage:r[e]})))}])}}function db(){return db=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var s in i)Object.prototype.hasOwnProperty.call(i,s)&&(e[s]=i[s])}return e},db.apply(this,arguments)}class ub{destroy(){var e,t,i,s,r;null==(e=this.packedTexture)||e.destroy(),null==(t=this.chunkTexture)||t.destroy(),null==(i=this.shTexture0)||i.destroy(),null==(s=this.shTexture1)||s.destroy(),null==(r=this.shTexture2)||r.destroy()}createMaterial(e){var t=Fp(e);return t.setDefine("GSPLAT_COMPRESSED_DATA",!0),t.setParameter("packedTexture",this.packedTexture),t.setParameter("chunkTexture",this.chunkTexture),t.setParameter("numSplats",this.numSplatsVisible),this.shTexture0?(t.setDefine("SH_BANDS",3),t.setParameter("shTexture0",this.shTexture0),t.setParameter("shTexture1",this.shTexture1),t.setParameter("shTexture2",this.shTexture2)):t.setDefine("SH_BANDS",0),t}evalTextureSize(e){var t=Math.ceil(Math.sqrt(e)),i=Math.ceil(e/t);return new di(t,i)}createTexture(e,t,i,s){return new ur(this.device,db({name:e,width:i.x,height:i.y,format:t,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1},s?{levels:[s]}:{}))}constructor(e,t){var{chunkData:i,chunkSize:s,numChunks:r,numSplats:n,vertexData:a,shBands:o}=t;this.device=e,this.numSplats=n,this.numSplatsVisible=n,this.aabb=new Ci,t.calcAabb(this.aabb),this.centers=new Float32Array(3*n),t.getCenters(this.centers),this.chunks=new Float32Array(6*r),t.getChunks(this.chunks),this.packedTexture=this.createTexture("packedData",Gi,this.evalTextureSize(n),a);var l=this.evalTextureSize(r);l.x*=5,this.chunkTexture=this.createTexture("chunkData",ki,l);var h=this.chunkTexture.lock();if(((e,t,i,s,r)=>{for(var n=0;n<r;++n)for(var a=0;a<s;++a)e[n*t+a]=i[n*s+a]})(h,20,i,s,r),12===s)for(var c=0;c<r;++c)h[20*c+15]=1,h[20*c+16]=1,h[20*c+17]=1;if(this.chunkTexture.unlock(),o>0){var d=this.evalTextureSize(n);this.shTexture0=this.createTexture("shTexture0",Gi,d,new Uint32Array(t.shData0.buffer)),this.shTexture1=this.createTexture("shTexture1",Gi,d,new Uint32Array(t.shData1.buffer)),this.shTexture2=this.createTexture("shTexture2",Gi,d,new Uint32Array(t.shData2.buffer))}else this.shTexture0=null,this.shTexture1=null,this.shTexture2=null}}class fb{destroy(){}createMaterial(e){var{gsplatData:t}=this,i=Fp(e);return i.setDefine("GSPLAT_SOGS_DATA",!0),i.setDefine("SH_BANDS",this.gsplatData.shBands),["means_l","means_u","quats","scales","opacities","sh0","sh_centroids","sh_labels_u","sh_labels_l"].forEach((e=>{i.setParameter(e,t[e])})),["means","quats","scales","opacities","sh0","shN"].forEach((e=>{var s=t.meta[e];s&&(i.setParameter(e+"_mins",s.mins),i.setParameter(e+"_maxs",s.maxs))})),i}evalTextureSize(e){return new di(this.gsplatData.means_l.width,this.gsplatData.means_l.height)}createTexture(e,t,i){return new ur(this.device,{name:e,width:i.x,height:i.y,format:t,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1})}constructor(e,t){this.device=e,this.gsplatData=t;var{meta:i}=t;this.numSplats=i.means.shape[0],this.numSplatsVisible=this.numSplats,this.aabb=new Ci,t.calcAabb(this.aabb),this.centers=new Float32Array(3*this.numSplats),t.getCenters(this.centers)}}class pb{destroy(){var e;this.app=null,this.splatData=null,null==(e=this.splat)||e.destroy(),this.splat=null}createSplat(){if(!this.splat){var{app:e,splatData:t}=this,i=t.isCompressed?ub:t.isSogs?fb:Bp;this.splat=new i(e.graphicsDevice,t)}return this.splat}instantiate(e){void 0===e&&(e={});var t=this.createInstance(e),i=new Lm(void 0,this.app),s=i.addComponent("gsplat",{instance:t});return i.setLocalEulerAngles(0,0,180),s.customAabb=t.splat.aabb.clone(),i}createInstance(e){void 0===e&&(e={});var t=this.createSplat();return new Wp(t,e)}constructor(e,t,i){this.splat=null,this.comments=null,this.app=e,this.splatData=t,this.comments=i}}function mb(e,t,i,s,r,n,a){try{var o=e[n](a),l=o.value}catch(e){return void i(e)}o.done?t(l):Promise.resolve(l).then(s,r)}function gb(e){return function(){var t=this,i=arguments;return new Promise((function(s,r){var n=e.apply(t,i);function a(e){mb(n,s,r,a,o,"next",e)}function o(e){mb(n,s,r,a,o,"throw",e)}a(void 0)}))}}var vb=new Uint8Array([112,108,121,10]),_b=new Uint8Array([10,101,110,100,95,104,101,97,100,101,114,10]),bb=new Map([["char",Int8Array],["uchar",Uint8Array],["short",Int16Array],["ushort",Uint16Array],["int",Int32Array],["uint",Uint32Array],["float",Float32Array],["double",Float64Array]]);class yb{read(){var e=this;return gb((function*(){var{value:t,done:i}=yield e.reader.read();if(i)throw new Error("Stream finished before end of header");e.push(t),null==e.progressFunc||e.progressFunc.call(e,t.byteLength)}))()}push(e){if(this.data){var t=this.tail-this.head,i=t+e.length;if(this.data.length>=i)this.head>0?(this.data.copyWithin(0,this.head,this.tail),this.data.set(e,t),this.head=0,this.tail=i):(this.data.set(e,this.tail),this.tail+=e.length);else{var s=new Uint8Array(i);this.head>0||this.tail<this.data.length?s.set(this.data.subarray(this.head,this.tail),0):s.set(this.data,0),s.set(e,t),this.data=s,this.view=new DataView(this.data.buffer),this.head=0,this.tail=i}}else this.data=e,this.view=new DataView(this.data.buffer),this.tail=e.length}compact(){this.head>0&&(this.data.copyWithin(0,this.head,this.tail),this.tail-=this.head,this.head=0)}get remaining(){return this.tail-this.head}getInt8(){var e=this.view.getInt8(this.head);return this.head++,e}getUint8(){var e=this.view.getUint8(this.head);return this.head++,e}getInt16(){var e=this.view.getInt16(this.head,!0);return this.head+=2,e}getUint16(){var e=this.view.getUint16(this.head,!0);return this.head+=2,e}getInt32(){var e=this.view.getInt32(this.head,!0);return this.head+=4,e}getUint32(){var e=this.view.getUint32(this.head,!0);return this.head+=4,e}getFloat32(){var e=this.view.getFloat32(this.head,!0);return this.head+=4,e}getFloat64(){var e=this.view.getFloat64(this.head,!0);return this.head+=8,e}constructor(e,t){this.head=0,this.tail=0,this.reader=e,this.progressFunc=t}}var xb=gb((function*(e,t){var i,s,r=new cb,n=t[0].count,a=t[0].properties.length,o=t[1].count,l=(i=o,(s=Math.ceil(Math.sqrt(i)))*Math.ceil(i/s));r.numSplats=o,r.chunkData=new Float32Array(n*a),r.vertexData=new Uint32Array(4*l);var h=gb((function*(t,i){for(var s=new Uint8Array(t),r=0;r<i;){for(;0===e.remaining;)yield e.read();for(var n=Math.min(i-r,e.remaining),a=e.data,o=0;o<n;++o)s[r++]=a[e.head++]}}));if(yield h(r.chunkData.buffer,n*a*4),yield h(r.vertexData.buffer,4*o*4),3===t.length){for(var c=16*l,d=new Uint8Array(c),u=new Uint8Array(c),f=new Uint8Array(c),p=1024,m=t[2].properties.length/3,g=new Uint8Array(p*m*3),v=0;v<r.numSplats;v+=p){var _=Math.min(p,r.numSplats-v);yield h(g.buffer,_*m*3);for(var b=0;b<_;++b)for(var y=0;y<15;++y){var x=16*(v+b)+y;y<m?(d[x]=g[(3*b+0)*m+y],u[x]=g[(3*b+1)*m+y],f[x]=g[(3*b+2)*m+y]):(d[x]=127,u[x]=127,f[x]=127)}}r.shData0=d,r.shData1=u,r.shData2=f,r.shBands={3:1,8:2,15:3}[m]}else r.shBands=0;return r})),Sb=gb((function*(e,t){var i,s=t[0],r=s.properties,n=r.length,a=r.map((e=>e.storage)),o=r.reduce(((e,t)=>e+t.byteSize),0),l=0,h=()=>{var t=e.data.buffer;(null==i?void 0:i.buffer)!==t&&(i=new Float32Array(t,0,t.byteLength/4))};for(h();l<s.count;){for(;e.remaining<o;)yield e.read(),h();for(var c=Math.min(s.count-l,Math.floor(e.remaining/o)),d=0;d<n;++d)for(var u=a[d],f=0;f<c;++f)u[f+l]=i[f*n+d];l+=c,e.head+=c*o}return new Op(t)})),wb=gb((function*(e,t){for(var i=0;i<t.length;++i)for(var s=t[i],r=s.properties.reduce(((e,t)=>e+t.byteSize),0),n=s.properties.map((e=>{if(!e.storage)return t=>{t.head+=e.byteSize};switch(e.type){case"char":return(t,i)=>{e.storage[i]=t.getInt8()};case"uchar":return(t,i)=>{e.storage[i]=t.getUint8()};case"short":return(t,i)=>{e.storage[i]=t.getInt16()};case"ushort":return(t,i)=>{e.storage[i]=t.getUint16()};case"int":return(t,i)=>{e.storage[i]=t.getInt32()};case"uint":return(t,i)=>{e.storage[i]=t.getUint32()};case"float":return(t,i)=>{e.storage[i]=t.getFloat32()};case"double":return(t,i)=>{e.storage[i]=t.getFloat64()};default:throw new Error("Unsupported property data type '"+e.type+"' in ply header")}})),a=0;a<s.count;){for(;e.remaining<r;)yield e.read();for(var o=Math.min(s.count-a,Math.floor(e.remaining/r)),l=0;l<o;++l){for(var h=0;h<s.properties.length;++h)n[h](e,a);a++}}return new Op(t)})),Tb=gb((function*(e,t,i){void 0===t&&(t=null),void 0===i&&(i=null);for(var s,r=(e,t)=>{var i,s,r=e.length-t.length;for(i=0;i<=r;++i){for(s=0;s<t.length&&e[i+s]===t[s];++s);if(s===t.length)return i}return-1},n=(e,t)=>{if(e.length<t.length)return!1;for(var i=0;i<t.length;++i)if(e[i]!==t[i])return!1;return!0},a=new yb(e,i);;){if(yield a.read(),a.tail>=vb.length&&!n(a.data,vb))throw new Error("Invalid ply header");if(-1!==(s=r(a.data,_b)))break}var o=new TextDecoder("ascii").decode(a.data.subarray(0,s)).split("\n"),{elements:l,format:h,comments:c}=(e=>{for(var t,i=[],s=[],r=1;r<e.length;++r){var n=e[r].split(" ");switch(n[0]){case"comment":s.push(n.slice(1).join(" "));break;case"format":t=n[1];break;case"element":i.push({name:n[1],count:parseInt(n[2],10),properties:[]});break;case"property":if(!bb.has(n[1]))throw new Error("Unrecognized property data type '"+n[1]+"' in ply header");i[i.length-1].properties.push({type:n[1],name:n[2],storage:null,byteSize:bb.get(n[1]).BYTES_PER_ELEMENT});break;default:throw new Error("Unrecognized header value '"+n[0]+"' in ply header")}}return{elements:i,format:t,comments:s}})(o);if("binary_little_endian"!==h)throw new Error("Unsupported ply format");a.head=s+_b.length,a.compact();var d=gb((function*(){return(e=>{var t=["min_x","min_y","min_z","max_x","max_y","max_z","min_scale_x","min_scale_y","min_scale_z","max_scale_x","max_scale_y","max_scale_z","min_r","min_g","min_b","max_r","max_g","max_b"],i=["packed_position","packed_rotation","packed_scale","packed_color"],s=new Array(45).fill("").map(((e,t)=>"f_rest_"+t)),r=()=>"chunk"===e[0].name&&e[0].properties.every(((e,i)=>e.name===t[i]&&"float"===e.type))&&"vertex"===e[1].name&&e[1].properties.every(((e,t)=>e.name===i[t]&&"uint"===e.type));return 2===e.length&&r()||3===e.length&&r()&&"sh"===e[2].name&&-1!==[9,24,45].indexOf(e[2].properties.length)&&e[2].properties.every(((e,t)=>e.name===s[t]&&"uchar"===e.type))})(l)?yield xb(a,l):(l.forEach((e=>{e.properties.forEach((i=>{var s=bb.get(i.type);if(s){var r=!t||t(i.name)?new s(e.count):null;i.storage=r}}))})),(e=>1===e.length&&"vertex"===e[0].name&&e[0].properties.every((e=>"float"===e.type)))(l)?yield Sb(a,l):yield wb(a,l))}));return{data:yield d(),comments:c}})),Cb=e=>!0;class Eb{load(e,t,i){var s=this;return gb((function*(){try{var r,n,a=yield null!=(n=null==(r=i.file)?void 0:r.contents)?n:fetch(e.load);if(a&&a.body){var o,l,h,c=parseInt(null!=(o=a.headers.get("content-length"))?o:"0",10),d=0,{data:u,comments:f}=yield Tb(a.body.getReader(),null!=(l=i.data.elementFilter)?l:Cb,(e=>{d+=e,i&&i.fire("progress",d,c)}));if(!u.isCompressed)(null==(h=i.data.reorder)||h)&&u.reorderData();var p=new pb(s.app,u.isCompressed&&i.data.decompress?u.decompress():u,f);t(null,p)}else t("Error loading resource",null)}catch(e){t(e,null)}}))()}open(e,t){return t}constructor(e,t){this.app=e,this.maxRetries=t}}var Ab=null,Pb=null,Db=e=>(Ab&&Ab.width===e.width&&Ab.height===e.height||(Ab=new OffscreenCanvas(e.width,e.height),(Pb=Ab.getContext("2d")).globalCompositeOperation="copy"),Pb.drawImage(e,0,0),Pb.getImageData(0,0,e.width,e.height).data),Lb=.28209479177387814;class Mb{constructor(e,t,i,s,r,n){var a=(e,t,i)=>e*(1-i)+t*i,{meta:o}=e,{means:l,quats:h,scales:c,opacities:d,sh0:u,shN:f}=o,p=t&&Db(e.means_l._levels[0]),m=t&&Db(e.means_u._levels[0]),g=i&&Db(e.quats._levels[0]),v=s&&Db(e.scales._levels[0]),_=r&&Db(e.opacities._levels[0]),b=r&&Db(e.sh0._levels[0]),y=n&&Db(e.sh_labels_l._levels[0]),x=n&&Db(e.sh_labels_u._levels[0]),S=n&&Db(e.sh_centroids._levels[0]);this.read=o=>{if(t){var w=a(l.mins[0],l.maxs[0],((m[4*o+0]<<8)+p[4*o+0])/65535),T=a(l.mins[1],l.maxs[1],((m[4*o+1]<<8)+p[4*o+1])/65535),C=a(l.mins[2],l.maxs[2],((m[4*o+2]<<8)+p[4*o+2])/65535);t.x=Math.sign(w)*(Math.exp(Math.abs(w))-1),t.y=Math.sign(T)*(Math.exp(Math.abs(T))-1),t.z=Math.sign(C)*(Math.exp(Math.abs(C))-1)}if(i){var E=a(h.mins[0],h.maxs[0],g[4*o+0]/255),A=a(h.mins[1],h.maxs[1],g[4*o+1]/255),P=a(h.mins[2],h.maxs[2],g[4*o+2]/255),D=Math.sqrt(Math.max(0,1-(E*E+A*A+P*P)));i.set(A,P,D,E)}if(s){var L=a(c.mins[0],c.maxs[0],v[4*o+0]/255),M=a(c.mins[1],c.maxs[1],v[4*o+1]/255),I=a(c.mins[2],c.maxs[2],v[4*o+2]/255);s.set(L,M,I)}if(r){var R=a(u.mins[0],u.maxs[0],b[4*o+0]/255),k=a(u.mins[1],u.maxs[1],b[4*o+1]/255),O=a(u.mins[2],u.maxs[2],b[4*o+2]/255),F=a(d.mins[0],d.maxs[0],_[4*o+0]/255);r.set(.5+R*Lb,.5+k*Lb,.5+O*Lb,1/(1+Math.exp(-1*F)))}if(n)for(var B=y[4*o+0]+(x[4*o+0]<<8),N=B%64*15,z=Math.floor(B/64),U=0;U<3;++U)for(var V=0;V<15;++V)n[15*U+V]=a(f.mins,f.maxs,S[4*(N+V)+U+z*e.sh_centroids.width*4]/255)}}}class Ib{createIter(e,t,i,s,r){return new Mb(this,e,t,i,s,r)}calcAabb(e){var{mins:t,maxs:i}=this.meta.means,s=e=>Math.sign(e)*(Math.exp(Math.abs(e))-1);e.center.set(.5*(s(t[0])+s(i[0])),.5*(s(t[1])+s(i[1])),.5*(s(t[2])+s(i[2]))),e.halfExtents.set(.5*(s(i[0])-s(t[0])),.5*(s(i[1])-s(t[1])),.5*(s(i[2])-s(t[2])))}getCenters(e){for(var t=new hi,i=this.createIter(t),s=0;s<this.numSplats;s++)i.read(s),e[3*s+0]=t.x,e[3*s+1]=t.y,e[3*s+2]=t.z}calcFocalPoint(e,t){e.set(0,0,0)}get isSogs(){return!0}decompress(){var e=["x","y","z","f_dc_0","f_dc_1","f_dc_2","opacity","scale_0","scale_1","scale_2","rot_0","rot_1","rot_2","rot_3"],{shBands:t}=this;if(t>0){for(var i=[],s=0;s<45;++s)i.push("f_rest_"+s);e.splice(e.indexOf("f_dc_0")+1,0,...i)}var r={};e.forEach((e=>{r[e]=new Float32Array(this.numSplats)}));for(var n=new hi,a=new bi,o=new hi,l=new ui,h=t>0?new Float32Array(45):null,c=this.createIter(n,a,o,l,h),d=0;d<this.numSplats;++d)if(c.read(d),r.x[d]=n.x,r.y[d]=n.y,r.z[d]=n.z,r.rot_1[d]=a.x,r.rot_2[d]=a.y,r.rot_3[d]=a.z,r.rot_0[d]=a.w,r.scale_0[d]=o.x,r.scale_1[d]=o.y,r.scale_2[d]=o.z,r.f_dc_0[d]=(l.x-.5)/Lb,r.f_dc_1[d]=(l.y-.5)/Lb,r.f_dc_2[d]=(l.z-.5)/Lb,r.opacity[d]=l.w<=0?-40:l.w>=1?40:-Math.log(1/l.w-1),h)for(var u=0;u<45;++u)r["f_rest_"+u][d]=h[u];return new Op([{name:"vertex",count:this.numSplats,properties:e.map((e=>({name:e,type:"float",byteSize:4,storage:r[e]})))}])}}function Rb(e,t,i,s,r,n,a){try{var o=e[n](a),l=o.value}catch(e){return void i(e)}o.done?t(l):Promise.resolve(l).then(s,r)}class kb{loadTextures(e,t,i,s){var r,n=this;return(r=function*(){var r,a,o,l,h,c,d,u,f,p,{assets:m}=n.app,g={},v=[];["means","opacities","quats","scales","sh0","shN"].forEach((t=>{var r,n,a=null!=(n=null==(r=s[t])?void 0:r.files)?n:[];g[t]=a.map((t=>{var s,r,n,a=new fm(t,"texture",{url:null!=(n=null==(r=i.options)||null==(s=r.mapUrl)?void 0:s.call(r,t))?n:new URL(t,e.load).toString(),filename:t},{mipmaps:!1}),o=new Promise(((e,t)=>{a.on("load",(()=>e(null))),a.on("error",(e=>t(e)))}));return m.add(a),m.load(a),v.push(o),a}))})),yield Promise.allSettled(v);var _,b=new Ib;b.meta=s,b.numSplats=s.means.shape[0],b.shBands=null!=(_={192:1,512:2,960:3}[null==(o=g.shN)||null==(a=o[0])||null==(r=a.resource)?void 0:r.width])?_:0,b.means_l=g.means[0].resource,b.means_u=g.means[1].resource,b.opacities=g.opacities[0].resource,b.quats=g.quats[0].resource,b.scales=g.scales[0].resource,b.sh0=g.sh0[0].resource,b.sh_centroids=null==(h=g.shN)||null==(l=h[0])?void 0:l.resource,b.sh_labels_l=null==(d=g.shN)||null==(c=d[1])?void 0:c.resource,b.sh_labels_u=null==(f=g.shN)||null==(u=f[2])?void 0:u.resource;var y=new pb(n.app,(null==(p=i.data)?void 0:p.decompress)?b.decompress():b,[]);t(null,y)},function(){var e=this,t=arguments;return new Promise((function(i,s){var n=r.apply(e,t);function a(e){Rb(n,i,s,a,o,"next",e)}function o(e){Rb(n,i,s,a,o,"throw",e)}a(void 0)}))})()}load(e,t,i){var s;if(null==(s=i.data)?void 0:s.means)this.loadTextures(e,t,i,i.data);else{"string"==typeof e&&(e={load:e,original:e});var r={retry:this.maxRetries>0,maxRetries:this.maxRetries,responseType:tl.ResponseType.JSON};il.get(e.load,r,((s,r)=>{s?t("Error loading gsplat meta: "+e.original+" ["+s+"]"):this.loadTextures(e,t,i,r)}))}}constructor(e,t){this.app=e,this.maxRetries=t}}class Ob extends ym{_getUrlWithoutParams(e){return e.indexOf("?")>=0?e.split("?")[0]:e}_getParser(e){var t=kt.getExtension(this._getUrlWithoutParams(e)).toLowerCase().replace(".","");return this.parsers[t]||this.parsers.ply}load(e,t,i){"string"==typeof e&&(e={load:e,original:e}),this._getParser(e.original).load(e,t,i)}open(e,t,i){return t}constructor(e){super(e,"gsplat"),this.parsers={ply:new Eb(e,3),json:new kb(e,3)}}}function Fb(){var e,t,i,s=0,r=1,n=2,a=3,o=8,l=9,h=10,c=11,d=12,u=13,f=14,p=16,m={astc:h,dxt:n,etc1:s,etc2:s,pvr:o,atc:c,none:f},g={astc:h,dxt:a,etc1:p,etc2:r,pvr:l,atc:d,none:p},v=21,_=22,b=23,y=8,x=10,S=26,w=27,T=28,C=29,E=30,A=7,P=3,D=5,L=(e,t)=>{switch(e){case s:return t.formats.etc2?_:v;case r:return b;case n:return y;case a:return x;case o:return S;case l:return w;case h:return T;case c:return C;case d:return E;case u:return A;case f:return P;case p:return D}},M=e=>{for(var t=function(e,t){var i=e*(2/255)-1,s=t*(2/255)-1,r=Math.sqrt(1-Math.min(1,i*i+s*s));return Math.max(0,Math.min(255,Math.floor(.5*(r+1)*255)))},i=0;i<e.length;i+=4){var s=e[i+3],r=e[i+1];e[i+0]=s,e[i+2]=t(s,r),e[i+3]=255}return e},I=e=>{for(var t=new Uint16Array(e.length/4),i=0;i<e.length;i+=4){var s=e[i+0],r=e[i+1],n=e[i+2];t[i/4]=(248&s)<<8|(252&r)<<3|n>>3}return t},R=()=>"undefined"!=typeof performance?performance.now():0,k=(e,s,r)=>{if(r){if(e.formats.astc)return"astc"}else if(s){if(e.formats.etc2)return"etc2"}else{if(e.formats.etc2)return"etc2";if(e.formats.etc1)return"etc1"}return(t=>{for(var i=0;i<t.length;++i){var s=t[i];if(e.formats[s])return s}return"none"})(s?i:t)},O=(e,t,i)=>{switch(i){case s:case r:return!0;case n:case a:return!(3&e||3&t);case o:case l:return((e,t)=>!(e&e-1||t&t-1))(e,t);case h:case c:case d:return!0}return!1},F=(t,i,s)=>s.isKTX2?((t,i,s)=>{if(!e.KTX2File)throw new Error("Basis transcoder module does not include support for KTX2.");var r=R(),n=new e.KTX2File(new Uint8Array(i)),a=n.getWidth(),o=n.getHeight(),l=n.getLevels(),h=!!n.getHasAlpha(),c=n.isUASTC&&n.isUASTC();if(!a||!o||!l)throw n.close(),n.delete(),new Error("Invalid image dimensions url="+t+" width="+a+" height="+o+" levels="+l);var d,v,_=k(s.deviceDetails,h,c),b=!!s.isGGGR&&"pvr"===_;if(b?d=u:O(a,o,d=h?g[_]:m[_])||(d=h?u:f),!n.startTranscoding())throw n.close(),n.delete(),new Error("Failed to start transcoding url="+t);for(var y=[],x=0;x<l;++x){var S=n.getImageTranscodedSizeInBytes(x,0,0,d),w=new Uint8Array(S);if(!n.transcodeImage(w,x,0,0,d,0,-1,-1))throw n.close(),n.delete(),new Error("Failed to transcode image url="+t);var T=d===f||d===p;y.push(T?new Uint16Array(w.buffer):w)}if(n.close(),n.delete(),b)for(d=f,v=0;v<y.length;++v)y[v]=I(M(y[v]));return{format:L(d,s.deviceDetails),width:a,height:o,levels:y,cubemap:!1,transcodeTime:R()-r,url:t,unswizzledGGGR:b}})(t,i,s):((t,i,s)=>{var r=R(),n=new e.BasisFile(new Uint8Array(i)),a=n.getImageWidth(0,0),o=n.getImageHeight(0,0),l=n.getNumImages(),h=n.getNumLevels(0),c=!!n.getHasAlpha(),d=n.isUASTC&&n.isUASTC();if(!(a&&o&&l&&h))throw n.close(),n.delete(),new Error("Invalid image dimensions url="+t+" width="+a+" height="+o+" images="+l+" levels="+h);var v,_,b=k(s.deviceDetails,c,d),y=!!s.isGGGR&&"pvr"===b;if(y?v=u:O(a,o,v=c?g[b]:m[b])||(v=c?u:f),!n.startTranscoding())throw n.close(),n.delete(),new Error("Failed to start transcoding url="+t);for(var x=[],S=0;S<h;++S){var w=n.getImageTranscodedSizeInBytes(0,S,v),T=new Uint8Array(w);if(!n.transcodeImage(T,0,S,v,0,0)){if(S!==h-1||w!==x[S-1].buffer.byteLength)throw n.close(),n.delete(),new Error("Failed to transcode image url="+t);T.set(new Uint8Array(x[S-1].buffer)),console.warn("Failed to transcode last mipmap level, using previous level instead url="+t)}var C=v===f||v===p;x.push(C?new Uint16Array(T.buffer):T)}if(n.close(),n.delete(),y)for(v=f,_=0;_<x.length;++_)x[_]=I(M(x[_]));return{format:L(v,s.deviceDetails),width:a,height:o,levels:x,cubemap:!1,transcodeTime:R()-r,url:t,unswizzledGGGR:y}})(t,i,s),B=(e,t,i)=>{try{var s=F(e,t,i);s.levels=s.levels.map((e=>e.buffer)),self.postMessage({url:e,data:s},s.levels)}catch(t){self.postMessage({url:e,err:t},null)}},N=[];self.onmessage=s=>{var r,n,a=s.data;switch(a.type){case"init":r=a.config,n=()=>{for(var e=0;e<N.length;++e)B(N[e].url,N[e].data,N[e].options);N.length=0},self.BASIS(r.module?{instantiateWasm:(e,t)=>(WebAssembly.instantiate(r.module,e).then((e=>{t(e)})).catch((e=>{console.error("instantiate failed + "+e)})),{})}:null).then((s=>{s.initializeBasis(),e=s,t=r.rgbPriority,i=r.rgbaPriority,n(null)}));break;case"transcode":e?B(a.url,a.data,a.options):N.push(a)}}}var Bb=e=>({astc:!!e.extCompressedTextureASTC,atc:!!e.extCompressedTextureATC,dxt:!!e.extCompressedTextureS3TC,etc1:!!e.extCompressedTextureETC1,etc2:!!e.extCompressedTextureETC,pvr:!!e.extCompressedTexturePVRTC});class Nb{run(e){var t=[];e.data instanceof ArrayBuffer&&t.push(e.data),this.worker.postMessage({type:"transcode",url:e.url,format:e.format,data:e.data,options:e.options},t),this.eager&&this.queue.enqueueClient(this)}constructor(e,t,i){this.queue=e,this.worker=new Worker(t.workerUrl),this.worker.addEventListener("message",(e=>{var t=e.data;this.queue.handleResponse(t.url,t.err,t.data),this.eager||this.queue.enqueueClient(this)})),this.worker.postMessage({type:"init",config:t}),this.eager=i}}var zb=["etc2","etc1","astc","dxt","pvr","atc"],Ub=["astc","dxt","etc2","pvr","atc"],Vb=new class{enqueueJob(e,t,i,s){if(this.callbacks.hasOwnProperty(e))this.callbacks[e].push(i);else{this.callbacks[e]=[i];var r={url:e,data:t,options:s};this.clients.length>0?this.clients.shift().run(r):this.queue.push(r)}}enqueueClient(e){this.queue.length>0?e.run(this.queue.shift()):this.clients.push(e)}handleResponse(e,t,i){var s=this.callbacks[e];if(t)for(var r=0;r<s.length;++r)s[r](t);else{3===i.format||5===i.format?i.levels=i.levels.map((e=>new Uint16Array(e))):i.levels=i.levels.map((e=>new Uint8Array(e)));for(var n=0;n<s.length;++n)s[n](null,i)}delete this.callbacks[e]}constructor(){this.callbacks={},this.queue=[],this.clients=[]}},Hb=null,Gb=!1;function Wb(e){if(!Gb){if(e){if(e.lazyInit)return void(Hb=e)}else e=Hb||{};if(!e.glueUrl||!e.wasmUrl||!e.fallbackUrl){var t=Xt.getConfig("BASIS");t&&(e={glueUrl:t.glueUrl,wasmUrl:t.wasmUrl,fallbackUrl:t.fallbackUrl,numWorkers:t.numWorkers})}if(e.glueUrl||e.wasmUrl||e.fallbackUrl){Gb=!0;var i=Math.max(1,Math.min(16,e.numWorkers||1)),s=1===e.numWorkers||!e.hasOwnProperty("eagerWorkers")||e.eagerWorkers;e.rgbPriority=e.rgbPriority||zb,e.rgbaPriority=e.rgbaPriority||Ub,e.maxRetries=e.hasOwnProperty("maxRetries")?e.maxRetries:5,((e,t)=>{var i=e=>{var t=["/* basis */",e,"","("+Fb.toString()+")()\n\n"].join("\n");return new Blob([t],{type:"application/javascript"})},s=(s,r)=>{t(null,{workerUrl:URL.createObjectURL(i(s)),module:r,rgbPriority:e.rgbPriority,rgbaPriority:e.rgbaPriority})},r={cache:!0,responseType:"text",retry:e.maxRetries>0,maxRetries:e.maxRetries};if(e.glueUrl&&e.wasmUrl&&(()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){var e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){}return!1})()){var n=null,a=null;il.get(e.glueUrl,r,((e,i)=>{e?t(e):a?s(i,a):n=i}));var o=fetch(e.wasmUrl),l=()=>{o.then((e=>e.arrayBuffer())).then((e=>WebAssembly.compile(e))).then((e=>{n?s(n,e):a=e})).catch((e=>{t(e,null)}))};WebAssembly.compileStreaming?WebAssembly.compileStreaming(o).then((e=>{n?s(n,e):a=e})).catch((e=>{l()})):l()}else il.get(e.fallbackUrl,r,((e,i)=>{e?t(e,null):s(i,null)}))})(e,((e,t)=>{if(e)console.error("failed to initialize basis worker: "+e);else for(var r=0;r<i;++r)Vb.enqueueClient(new Nb(Vb,t,s))}))}}}var jb=null;function qb(e,t,i,s,r){return Wb(),jb||(jb={formats:Bb(e)}),Vb.enqueueJob(t,i,s,{deviceDetails:jb,isGGGR:!!(null==r?void 0:r.isGGGR),isKTX2:!!(null==r?void 0:r.isKTX2)}),Gb}class Xb{load(e,t,i){throw new Error("not implemented")}open(e,t,i){throw new Error("not implemented")}}function Kb(){return Kb=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var s in i)Object.prototype.hasOwnProperty.call(i,s)&&(e[s]=i[s])}return e},Kb.apply(this,arguments)}class Yb extends Xb{load(e,t,i){var s=this.device;fm.fetchArrayBuffer(e.load,((r,n)=>{r?t(r):(r=>{var n,a,o;qb(s,e.load,r,t,{isGGGR:!!(8&(null==i||null==(o=i.file)||null==(a=o.variants)||null==(n=a.basis)?void 0:n.opt))})||t("Basis module not found. Asset ["+i.name+"]("+i.getFileUrl()+") basis texture variant will not be loaded.")})(n)}),i,this.maxRetries)}open(e,t,i,s){void 0===s&&(s={});var r=s.srgb?Yi(t.format):t.format,n=new ur(i,Kb({name:e,addressU:t.cubemap?1:0,addressV:t.cubemap?1:0,width:t.width,height:t.height,format:r,cubemap:t.cubemap,levels:t.levels},s));return n.upload(),n}constructor(e,t){super(),this.device=t,this.maxRetries=0}}function Qb(){return Qb=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var s in i)Object.prototype.hasOwnProperty.call(i,s)&&(e[s]=i[s])}return e},Qb.apply(this,arguments)}class Jb extends Xb{load(e,t,i){var s,r=!!(null==i||null==(s=i.file)?void 0:s.contents);if(r){if(this.device.supportsImageBitmap)return void this._loadImageBitmapFromBlob(new Blob([i.file.contents]),t);e={load:URL.createObjectURL(new Blob([i.file.contents])),original:e.original}}var n,a=(i,s)=>{r&&URL.revokeObjectURL(e.load),t(i,s)};i&&i.options&&i.options.hasOwnProperty("crossOrigin")?n=i.options.crossOrigin:lm.test(e.load)&&(n=this.crossOrigin),this.device.supportsImageBitmap?this._loadImageBitmap(e.load,e.original,n,a):this._loadImage(e.load,e.original,n,a)}open(e,t,i,s){void 0===s&&(s={});var r=new ur(i,Qb({name:e,width:t.width,height:t.height,format:s.srgb?zi:7},s));return r.setSource(t),r}_loadImage(e,t,i,s){var r=new Image;i&&(r.crossOrigin=i);var n,a=0,o=this.maxRetries;r.onload=function(){s(null,r)},r.onerror=function(){if(!n)if(o>0&&++a<=o){var i=100*Math.pow(2,a);console.log("Error loading Texture from: '"+t+"' - Retrying in "+i+"ms...");var l=e.indexOf("?")>=0?"&":"?";n=setTimeout((()=>{r.src=e+l+"retry="+Date.now(),n=null}),i)}else s("Error loading Texture from: '"+t+"'")},r.src=e}_loadImageBitmap(e,t,i,s){var r={cache:!0,responseType:"blob",retry:this.maxRetries>0,maxRetries:this.maxRetries};il.get(e,r,((e,t)=>{e?s(e):this._loadImageBitmapFromBlob(t,s)}))}_loadImageBitmapFromBlob(e,t){createImageBitmap(e,{premultiplyAlpha:"none",colorSpaceConversion:"none"}).then((e=>t(null,e))).catch((e=>t(e)))}constructor(e,t){super(),this.crossOrigin=e.prefix?"anonymous":null,this.maxRetries=0,this.device=t}}function $b(){return $b=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var s in i)Object.prototype.hasOwnProperty.call(i,s)&&(e[s]=i[s])}return e},$b.apply(this,arguments)}var Zb=[1481919403,3140563232,169478669],ey={33776:8,33778:9,33779:Ii,36196:21,37492:22,37496:23,35840:26,35841:Ui,35842:27,35843:Vi,32849:6,32856:7,35905:19,35907:zi,35898:Ni,34843:11,34842:Ri};class ty extends Xb{load(e,t,i){fm.fetchArrayBuffer(e.load,t,i,this.maxRetries)}open(e,t,i,s){void 0===s&&(s={});var r=this.parse(t);if(!r)return null;var n=s.srgb?Yi(r.format):r.format,a=new ur(i,$b({name:e,addressU:r.cubemap?1:0,addressV:r.cubemap?1:0,width:r.width,height:r.height,format:n,cubemap:r.cubemap,levels:r.levels},s));return a.upload(),a}parse(e){var t=new Uint32Array(e);if(Zb[0]!==t[0]||Zb[1]!==t[1]||Zb[2]!==t[2])return null;var i={glInternalFormat:t[7],pixelWidth:t[9],pixelHeight:t[10],pixelDepth:t[11],numberOfArrayElements:t[12],numberOfFaces:t[13],numberOfMipmapLevels:t[14],bytesOfKeyValueData:t[15]};if(i.pixelDepth>1)return null;if(0!==i.numberOfArrayElements)return null;var s=ey[i.glInternalFormat];if(void 0===s)return null;for(var r,n,a,o=16+i.bytesOfKeyValueData/4,l=i.numberOfFaces>1,h=[],c=0;c<(i.numberOfMipmapLevels||1);c++){var d=t[o++];l&&h.push([]);for(var u=l?h[c]:h,f=0;f<(l?6:1);++f)u.push((r=e,n=4*o,a=d,s===Ni?new Uint32Array(r,n,a/4):new Uint8Array(r,n,a))),o+=d+3>>2}return{format:s,width:i.pixelWidth,height:i.pixelHeight,levels:h,cubemap:l}}constructor(e){super(),this.maxRetries=0}}function iy(){return iy=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var s in i)Object.prototype.hasOwnProperty.call(i,s)&&(e[s]=i[s])}return e},iy.apply(this,arguments)}var sy=166;class ry extends Xb{load(e,t,i){fm.fetchArrayBuffer(e.load,((s,r)=>{s?t(s,r):this.parse(r,e,t,i)}),i,this.maxRetries)}open(e,t,i,s){void 0===s&&(s={});var r=s.srgb?Yi(t.format):t.format,n=new ur(i,iy({name:e,addressU:t.cubemap?1:0,addressV:t.cubemap?1:0,width:t.width,height:t.height,format:r,cubemap:t.cubemap,levels:t.levels},s));return n.upload(),n}parse(e,t,i,s){var r=new Kt(e),n=[r.readU32be(),r.readU32be(),r.readU32be()];if(2873840728!==n[0]||540160187!==n[1]||218765834!==n[2])return null;for(var a={vkFormat:r.readU32(),typeSize:r.readU32(),pixelWidth:r.readU32(),pixelHeight:r.readU32(),pixelDepth:r.readU32(),layerCount:r.readU32(),faceCount:r.readU32(),levelCount:r.readU32(),supercompressionScheme:r.readU32()},o={dfdByteOffset:r.readU32(),dfdByteLength:r.readU32(),kvdByteOffset:r.readU32(),kvdByteLength:r.readU32(),sgdByteOffset:r.readU64(),sgdByteLength:r.readU64()},l=[],h=0;h<Math.max(1,a.levelCount);++h)l.push({byteOffset:r.readU64(),byteLength:r.readU64(),uncompressedByteLength:r.readU64()});if(r.readU32()!==o.kvdByteOffset-o.dfdByteOffset)return null;r.skip(8);var c,d,u,f=r.readU8();(r.skip(o.dfdByteLength-9),r.skip(o.kvdByteLength),1===a.supercompressionScheme||f===sy)?qb(this.device,t.load,e,i,{isGGGR:!!(8&(null==s||null==(u=s.file)||null==(d=u.variants)||null==(c=d.basis)?void 0:c.opt)),isKTX2:!0})||i("Basis module not found. Asset ["+s.name+"]("+s.getFileUrl()+") basis texture variant will not be loaded."):i("unsupported KTX2 pixel format")}constructor(e,t){super(),this.maxRetries=0,this.device=t}}function ny(){return ny=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var s in i)Object.prototype.hasOwnProperty.call(i,s)&&(e[s]=i[s])}return e},ny.apply(this,arguments)}class ay extends Xb{load(e,t,i){fm.fetchArrayBuffer(e.load,t,i,this.maxRetries)}open(e,t,i,s){void 0===s&&(s={});var r,n=new Uint32Array(t,0,32),a=n[4],o=n[3],l=Math.max(n[7],1),h=4===n[20],c=n[21],d=n[22],u=65024===n[28],f=827611204,p=825438800,m=825439312,g=!1,v=!1,_=!1,b=!1,y=null,x=1;if(h?c===f?(y=8,g=!0):894720068===c?(y=Ii,g=!0):113===c?(y=Ri,x=2):116===c?(y=ki,x=4):826496069===c?(y=21,g=!0,v=!0):c===p||825504336===c?(y=c===p?Ui:Vi,g=!0,_=!0):c!==m&&825504848!==c||(y=c===m?26:27,g=!0,b=!0):32===d&&(y=7),!y)return r=new ur(i,{width:4,height:4,format:6,name:"dds-legacy-empty"});r=new ur(i,ny({name:e,addressU:u?1:0,addressV:u?1:0,width:a,height:o,format:y,cubemap:u,mipmaps:l>1},s));for(var S,w=128,T=u?6:1,C=c===f?8:16,E=0;E<T;E++)for(var A=a,P=o,D=0;D<l;D++){S=g?v?Math.floor((A+3)/4)*Math.floor((P+3)/4)*8:_?Math.max(A,16)*Math.max(P,8)/4:b?Math.max(A,8)*Math.max(P,8)/2:Math.floor((A+4-1)/4)*Math.floor((P+4-1)/4)*C:A*P*4;var L=y===ki?new Float32Array(t,w,S):y===Ri?new Uint16Array(t,w,S):new Uint8Array(t,w,S);u?(r._levels[D]||(r._levels[D]=[]),r._levels[D][E]=L):r._levels[D]=L,w+=S*x,A=Math.max(.5*A,1),P=Math.max(.5*P,1)}return r.upload(),r}constructor(e){super(),this.maxRetries=0}}function oy(){return oy=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var s in i)Object.prototype.hasOwnProperty.call(i,s)&&(e[s]=i[s])}return e},oy.apply(this,arguments)}class ly extends Xb{load(e,t,i){fm.fetchArrayBuffer(e.load,t,i,this.maxRetries),i.data&&!i.data.type&&(i.data.type=ys)}open(e,t,i,s){void 0===s&&(s={});var r=this.parse(t);if(!r)return null;var n=new ur(i,oy({name:e,addressU:0,addressV:1,minFilter:0,magFilter:0,width:r.width,height:r.height,levels:r.levels,format:7,type:ys,mipmaps:!1},s));return n.upload(),n}parse(e){var t=new Kt(e);if(!t.readLine().startsWith("#?RADIANCE"))return null;for(var i={};;){var s=t.readLine();if(0===s.length)break;var r=s.split("=");2===r.length&&(i[r[0]]=r[1])}if(!i.hasOwnProperty("FORMAT"))return null;var n=t.readLine().split(" ");if(4!==n.length)return null;var a=parseInt(n[1],10),o=parseInt(n[3],10),l=this._readPixels(t,o,a,"-Y"===n[0]);return l?{width:o,height:a,levels:[l]}:null}_readPixels(e,t,i,s){if(t<8||t>32767)return this._readPixelsFlat(e,t,i);var r=[0,0,0,0];if(e.readArray(r),2!==r[0]||2!==r[1]||128&r[2])return e.skip(-4),this._readPixelsFlat(e,t,i);var n,a,o,l,h,c,d=new ArrayBuffer(t*i*4),u=new Uint8Array(d),f=s?0:4*t*(i-1);for(a=0;a<i;++a){if(a&&e.readArray(r),(r[2]<<8)+r[3]!==t)return null;for(l=0;l<4;++l)for(n=0;n<t;)if((h=e.readU8())>128){if(n+(h-=128)>t)return null;for(c=e.readU8(),o=0;o<h;++o)u[f+l+4*n++]=c}else{if(0===h||n+h>t)return null;for(o=0;o<h;++o)u[f+l+4*n++]=e.readU8()}f+=4*t*(s?1:-1)}return u}_readPixelsFlat(e,t,i){return e.remainingBytes===t*i*4?new Uint8Array(e.arraybuffer,e.offset):null}constructor(e){super(),this.maxRetries=0}}var hy={repeat:0,clamp:1,mirror:2},cy={nearest:0,linear:1,nearest_mip_nearest:2,linear_mip_nearest:4,nearest_mip_linear:3,linear_mip_linear:5},dy={default:_s,rgbm:bs,rgbe:ys,rgbp:xs,swizzleGGGR:Ss};class uy extends ym{set crossOrigin(e){this.imgParser.crossOrigin=e}get crossOrigin(){return this.imgParser.crossOrigin}set maxRetries(e){for(var t in this.imgParser.maxRetries=e,this.parsers)this.parsers.hasOwnProperty(t)&&(this.parsers[t].maxRetries=e)}get maxRetries(){return this.imgParser.maxRetries}_getUrlWithoutParams(e){return e.indexOf("?")>=0?e.split("?")[0]:e}_getParser(e){var t=kt.getExtension(this._getUrlWithoutParams(e)).toLowerCase().replace(".","");return this.parsers[t]||this.imgParser}_getTextureOptions(e){var t={};if(e){var i;(null==(i=e.name)?void 0:i.length)>0&&(t.name=e.name);var s=e.data;s.hasOwnProperty("minfilter")&&(t.minFilter=cy[s.minfilter]),s.hasOwnProperty("magfilter")&&(t.magFilter=cy[s.magfilter]),s.hasOwnProperty("addressu")&&(t.addressU=hy[s.addressu]),s.hasOwnProperty("addressv")&&(t.addressV=hy[s.addressv]),s.hasOwnProperty("mipmaps")&&(t.mipmaps=s.mipmaps),s.hasOwnProperty("anisotropy")&&(t.anisotropy=s.anisotropy),s.hasOwnProperty("flipY")&&(t.flipY=!!s.flipY),s.hasOwnProperty("srgb")&&(t.srgb=!!s.srgb),t.type=_s,s.hasOwnProperty("type")?t.type=dy[s.type]:s.hasOwnProperty("rgbm")&&s.rgbm?t.type=bs:e.file&&8&e.file.opt&&(t.type=Ss)}return t}load(e,t,i){"string"==typeof e&&(e={load:e,original:e}),this._getParser(e.original).load(e,t,i)}open(e,t,i){if(e){var s=this._getTextureOptions(i),r=this._getParser(e).open(e,t,this._device,s);return null===r?r=new ur(this._device,{width:4,height:4,format:6}):(!function(e){var t=cr.calcMipLevelsCount(e._width,e._height);if(!(7!==e._format&&e._format!==ki||e._volume||e._compressed||1===e._levels.length||e._levels.length===t||(i=e._cubemap?e._levels[0][0]:e._levels[0],i instanceof HTMLCanvasElement||i instanceof HTMLImageElement||i instanceof HTMLVideoElement))){for(var i,s=function(e,t,i){for(var s=Math.max(1,e>>1),r=Math.max(1,t>>1),n=new i.constructor(s*r*4),a=Math.floor(e/s),o=Math.floor(t/r),l=a*o,h=0;h<r;++h)for(var c=0;c<s;++c)for(var d=0;d<4;++d){for(var u=0,f=0;f<o;++f)for(var p=0;p<a;++p)u+=i[4*(c*a+p+(h*o+f)*e)+d];n[4*(c+h*s)+d]=u/l}return n},r=e._levels.length;r<t;++r){var n=Math.max(1,e._width>>r-1),a=Math.max(1,e._height>>r-1);if(e._cubemap){for(var o=[],l=0;l<6;++l)o.push(s(n,a,e._levels[r-1][l]));e._levels.push(o)}else e._levels.push(s(n,a,e._levels[r-1]))}e._levelsUpdated=e._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0]}}(r),t.unswizzledGGGR&&(i.file.variants.basis.opt&=-9)),r}}patch(e,t){var i=e.resource;if(i){var s=this._getTextureOptions(e);for(var r of Object.keys(s))i[r]=s[r]}}constructor(e){super(e,"texture");var t=e.assets,i=e.graphicsDevice;this._device=i,this._assets=t,this.imgParser=new Jb(t,i),this.parsers={dds:new ay(t),ktx:new ty(t),ktx2:new ry(t,i),basis:new Yb(t,i),hdr:new ly(t)}}}var fy="immersive-ar",py="viewer",my="point",gy="plane",vy="mesh",_y="gpu-optimized",by="luminance-alpha",yy="unsigned-short",xy="float32";class Sy{get supported(){return this._supported}get available(){return this._supported&&this._manager.active&&null!==this._manager._session.domOverlayState}get state(){return this._supported&&this._manager.active&&this._manager._session.domOverlayState?this._manager._session.domOverlayState.type:null}set root(e){this._supported&&!this._manager.active&&(this._root=e)}get root(){return this._root}constructor(e){this._supported=Ut.browser&&!!window.XRDOMOverlayState,this._root=null,this._manager=e}}var wy=[],Ty=[];class Cy extends Ht{remove(){if(this._xrHitTestSource){var e=this.manager.hitTest.sources,t=e.indexOf(this);-1!==t&&e.splice(t,1),this.onStop()}}onStop(){this._xrHitTestSource.cancel(),this._xrHitTestSource=null,this.fire("remove"),this.manager.hitTest.fire("remove",this)}update(e){if(this._transient)for(var t=e.getHitTestResultsForTransientInput(this._xrHitTestSource),i=0;i<t.length;i++){var s=t[i];if(s.results.length){var r=void 0;s.inputSource&&(r=this.manager.input._getByInputSource(s.inputSource)),this.updateHitResults(s.results,r)}}else{var n=e.getHitTestResults(this._xrHitTestSource);if(!n.length)return;this.updateHitResults(n)}}updateHitResults(e,t){if(!this._inputSource||this._inputSource===t){var i,s=null!=(i=wy.pop())?i:new hi;t?s.copy(t.getOrigin()):s.copy(this.manager.camera.getPosition());for(var r,n,a=1/0,o=null,l=null!=(r=wy.pop())?r:new hi,h=null!=(n=Ty.pop())?n:new bi,c=0;c<e.length;c++){var d=e[c].getPose(this.manager._referenceSpace),u=s.distance(d.transform.position);u>=a||(a=u,o=e[c],l.copy(d.transform.position),h.copy(d.transform.orientation))}this.fire("result",l,h,t||this._inputSource,o),this.manager.hitTest.fire("result",this,l,h,t||this._inputSource,o),wy.push(s),wy.push(l),Ty.push(h)}}constructor(e,t,i,s=null){super(),this.manager=e,this._xrHitTestSource=t,this._transient=i,this._inputSource=s}}Cy.EVENT_REMOVE="remove",Cy.EVENT_RESULT="result";class Ey extends Ht{_onSessionStart(){if(this.manager.session.enabledFeatures){var e=-1!==this.manager.session.enabledFeatures.indexOf("hit-test");if(!e)return;this._available=e,this.fire("available")}else this._checkingAvailability||(this._checkingAvailability=!0,this.manager.session.requestReferenceSpace(py).then((e=>{this.manager.session.requestHitTestSource({space:e}).then((e=>{e.cancel(),this.manager.active&&(this._available=!0,this.fire("available"))})).catch((()=>{}))})).catch((()=>{})))}_onSessionEnd(){if(this._available){this._available=!1;for(var e=0;e<this.sources.length;e++)this.sources[e].onStop();this.sources=[],this.fire("unavailable")}}start(e){if(void 0===e&&(e={}),this._supported)if(this._available){var t;e.profile||e.spaceType||(e.spaceType=py);var i=e.offsetRay;if(i){var s=new DOMPoint(i.origin.x,i.origin.y,i.origin.z,1),r=new DOMPoint(i.direction.x,i.direction.y,i.direction.z,0);t=new XRRay(s,r)}var n=e.callback;e.spaceType?this.manager.session.requestReferenceSpace(e.spaceType).then((i=>{if(!this.manager.session){var s=new Error("XR Session is not started (2)");return n&&n(s),void this.fire("error",s)}this.manager.session.requestHitTestSource({space:i,entityTypes:e.entityTypes||void 0,offsetRay:t}).then((t=>{this._onHitTestSource(t,!1,e.inputSource,n)})).catch((e=>{n&&n(e),this.fire("error",e)}))})).catch((e=>{n&&n(e),this.fire("error",e)})):this.manager.session.requestHitTestSourceForTransientInput({profile:e.profile,entityTypes:e.entityTypes||void 0,offsetRay:t}).then((t=>{this._onHitTestSource(t,!0,e.inputSource,n)})).catch((e=>{n&&n(e),this.fire("error",e)}))}else null==e.callback||e.callback.call(e,new Error("XR HitTest is not available"),null);else null==e.callback||e.callback.call(e,new Error("XR HitTest is not supported"),null)}_onHitTestSource(e,t,i,s){if(!this.manager.session){e.cancel();var r=new Error("XR Session is not started (3)");return s&&s(r),void this.fire("error",r)}var n=new Cy(this.manager,e,t,null!=i?i:null);this.sources.push(n),s&&s(null,n),this.fire("add",n)}update(e){if(this._available)for(var t=0;t<this.sources.length;t++)this.sources[t].update(e)}get supported(){return this._supported}get available(){return this._available}constructor(e){super(),this._supported=Ut.browser&&!(!window.XRSession||!window.XRSession.prototype.requestHitTestSource),this._available=!1,this._checkingAvailability=!1,this.sources=[],this.manager=e,this._supported&&(this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this))}}Ey.EVENT_AVAILABLE="available",Ey.EVENT_UNAVAILABLE="unavailable",Ey.EVENT_ADD="add",Ey.EVENT_REMOVE="remove",Ey.EVENT_RESULT="result",Ey.EVENT_ERROR="error";class Ay extends Ht{get image(){return this._image}set width(e){this._width=e}get width(){return this._width}get trackable(){return this._trackable}get tracking(){return this._tracking}get emulated(){return this._emulated}prepare(){return this._bitmap?{image:this._bitmap,widthInMeters:this._width}:createImageBitmap(this._image).then((e=>(this._bitmap=e,{image:this._bitmap,widthInMeters:this._width})))}destroy(){this._image=null,this._pose=null,this._bitmap&&(this._bitmap.close(),this._bitmap=null)}getPosition(){return this._pose&&this._position.copy(this._pose.transform.position),this._position}getRotation(){return this._pose&&this._rotation.copy(this._pose.transform.orientation),this._rotation}constructor(e,t){super(),this._bitmap=null,this._measuredWidth=0,this._trackable=!1,this._tracking=!1,this._emulated=!1,this._pose=null,this._position=new hi,this._rotation=new bi,this._image=e,this._width=t}}Ay.EVENT_TRACKED="tracked",Ay.EVENT_UNTRACKED="untracked";class Py extends Ht{add(e,t){if(!this._supported||this._manager.active)return null;var i=new Ay(e,t);return this._images.push(i),i}remove(e){if(!this._manager.active){var t=this._images.indexOf(e);-1!==t&&(e.destroy(),this._images.splice(t,1))}}_onSessionStart(){this._manager.session.getTrackedImageScores().then((e=>{this._available=!0;for(var t=0;t<e.length;t++)this._images[t]._trackable="trackable"===e[t]})).catch((e=>{this._available=!1,this.fire("error",e)}))}_onSessionEnd(){this._available=!1;for(var e=0;e<this._images.length;e++){var t=this._images[e];t._pose=null,t._measuredWidth=0,t._tracking&&(t._tracking=!1,t.fire("untracked"))}}prepareImages(e){this._images.length?Promise.all(this._images.map((e=>e.prepare()))).then((t=>{e(null,t)})).catch((t=>{e(t,null)})):e(null,null)}update(e){if(this._available){for(var t=e.getImageTrackingResults(),i={},s=0;s<t.length;s++){i[t[s].index]=t[s];var r=this._images[t[s].index];r._emulated="emulated"===t[s].trackingState,r._measuredWidth=t[s].measuredWidthInMeters,r._pose=e.getPose(t[s].imageSpace,this._manager._referenceSpace)}for(var n=0;n<this._images.length;n++)this._images[n]._tracking&&!i[n]?(this._images[n]._tracking=!1,this._images[n].fire("untracked")):!this._images[n]._tracking&&i[n]&&(this._images[n]._tracking=!0,this._images[n].fire("tracked"))}}get supported(){return this._supported}get available(){return this._available}get images(){return this._images}constructor(e){super(),this._supported=Ut.browser&&!!window.XRImageTrackingResult,this._available=!1,this._images=[],this._manager=e,this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}}Py.EVENT_ERROR="error";class Dy{get index(){return this._index}get hand(){return this._hand}get joints(){return this._joints}get tip(){return this._tip}constructor(e,t){this._joints=[],this._tip=null,this._index=e,this._hand=t,this._hand._fingers.push(this)}}for(var Ly=Ut.browser&&window.XRHand?["thumb-tip","index-finger-tip","middle-finger-tip","ring-finger-tip","pinky-finger-tip"]:[],My={},Iy=0;Iy<Ly.length;Iy++)My[Ly[Iy]]=!0;class Ry{update(e){this._dirtyLocal=!0,this._radius=e.radius,this._localPosition.copy(e.transform.position),this._localRotation.copy(e.transform.orientation)}_updateTransforms(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,hi.ONE));var e=this._hand._manager.camera.parent;e?this._worldTransform.mul2(e.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)}getPosition(){return this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position}getRotation(){return this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation}get id(){return this._id}get index(){return this._index}get hand(){return this._hand}get finger(){return this._finger}get wrist(){return this._wrist}get tip(){return this._tip}get radius(){return this._radius||.005}constructor(e,t,i,s=null){this._radius=null,this._localTransform=new _i,this._worldTransform=new _i,this._localPosition=new hi,this._localRotation=new bi,this._position=new hi,this._rotation=new bi,this._dirtyLocal=!0,this._index=e,this._id=t,this._hand=i,this._finger=s,this._wrist="wrist"===t,this._tip=this._finger&&!!My[t]}}var ky=[],Oy=new hi,Fy=new hi,By=new hi;Ut.browser&&window.XRHand&&(ky=[["thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip"],["index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip"],["middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip"],["ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip"],["pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"]]);class Ny extends Ht{update(e){for(var t=this._inputSource._xrInputSource,i=0;i<this._joints.length;i++){var s=this._joints[i],r=t.hand.get(s._id);if(r){var n=void 0;if("hidden"!==e.session.visibilityState&&(n=e.getJointPose(r,this._manager._referenceSpace)),n)s.update(n),s.wrist&&!this._tracking&&(this._tracking=!0,this.fire("tracking"));else if(s.wrist){this._tracking&&(this._tracking=!1,this.fire("trackinglost"));break}}}var a=this._jointsById["thumb-metacarpal"],o=this._jointsById["thumb-tip"],l=this._jointsById["index-finger-phalanx-proximal"],h=this._jointsById["index-finger-tip"],c=this._jointsById["ring-finger-phalanx-proximal"],d=this._jointsById["pinky-finger-phalanx-proximal"];if(a&&o&&l&&h&&c&&d){this._inputSource._dirtyRay=!0,this._inputSource._rayLocal.origin.lerp(o._localPosition,h._localPosition,.5);var u=a,f=d;if("left"===this._inputSource.handedness){var p=u;u=f,f=p}Oy.sub2(u._localPosition,this._wrist._localPosition),Fy.sub2(f._localPosition,this._wrist._localPosition),By.cross(Oy,Fy).normalize(),Oy.lerp(l._localPosition,c._localPosition,.5),Oy.sub(this._wrist._localPosition).normalize(),this._inputSource._rayLocal.direction.lerp(By,Oy,.5).normalize()}this._fingerIsClosed(1)&&this._fingerIsClosed(2)&&this._fingerIsClosed(3)&&this._fingerIsClosed(4)?this._inputSource._squeezing||(this._inputSource._squeezing=!0,this._inputSource.fire("squeezestart"),this._manager.input.fire("squeezestart",this._inputSource)):this._inputSource._squeezing&&(this._inputSource._squeezing=!1,this._inputSource.fire("squeeze"),this._manager.input.fire("squeeze",this._inputSource),this._inputSource.fire("squeezeend"),this._manager.input.fire("squeezeend",this._inputSource))}_fingerIsClosed(e){var t=this._fingers[e];return Oy.sub2(t.joints[0]._localPosition,t.joints[1]._localPosition).normalize(),Fy.sub2(t.joints[2]._localPosition,t.joints[3]._localPosition).normalize(),Oy.dot(Fy)<-.8}getJointById(e){return this._jointsById[e]||null}get fingers(){return this._fingers}get joints(){return this._joints}get tips(){return this._tips}get wrist(){return this._wrist}get tracking(){return this._tracking}constructor(e){super(),this._tracking=!1,this._fingers=[],this._joints=[],this._jointsById={},this._tips=[],this._wrist=null;var t=e._xrInputSource.hand;if(this._manager=e._manager,this._inputSource=e,t.get("wrist")){var i=new Ry(0,"wrist",this,null);this._wrist=i,this._joints.push(i),this._jointsById.wrist=i}for(var s=0;s<ky.length;s++)for(var r=new Dy(s,this),n=0;n<ky[s].length;n++){var a=ky[s][n];if(t.get(a)){var o=new Ry(n,a,this,r);this._joints.push(o),this._jointsById[a]=o,o.tip&&(this._tips.push(o),r._tip=o),r._joints.push(o)}}}}Ny.EVENT_TRACKING="tracking",Ny.EVENT_TRACKINGLOST="trackinglost";var zy=new hi,Uy=new bi,Vy=0;class Hy extends Ht{get id(){return this._id}get inputSource(){return this._xrInputSource}get targetRayMode(){return this._xrInputSource.targetRayMode}get handedness(){return this._xrInputSource.handedness}get profiles(){return this._xrInputSource.profiles}get grip(){return this._grip}get hand(){return this._hand}get gamepad(){return this._xrInputSource.gamepad||null}get selecting(){return this._selecting}get squeezing(){return this._squeezing}set elementInput(e){this._elementInput!==e&&(this._elementInput=e,this._elementInput||(this._elementEntity=null))}get elementInput(){return this._elementInput}get elementEntity(){return this._elementEntity}get hitTestSources(){return this._hitTestSources}update(e){if(this._hand)this._hand.update(e);else{var t=this._xrInputSource.gripSpace;if(t){var i=e.getPose(t,this._manager._referenceSpace);if(i){this._grip||(this._grip=!0,this._localTransform=new _i,this._worldTransform=new _i,this._localPositionLast=new hi,this._localPosition=new hi,this._localRotation=new bi,this._linearVelocity=new hi);var s=Jt(),r=(s-this._velocitiesTimestamp)/1e3;this._velocitiesTimestamp=s,this._dirtyLocal=!0,this._localPositionLast.copy(this._localPosition),this._localPosition.copy(i.transform.position),this._localRotation.copy(i.transform.orientation),this._velocitiesAvailable=!0,this._manager.input.velocitiesSupported&&i.linearVelocity?this._linearVelocity.copy(i.linearVelocity):r>0&&(zy.sub2(this._localPosition,this._localPositionLast).divScalar(r),this._linearVelocity.lerp(this._linearVelocity,zy,.15))}else this._velocitiesAvailable=!1}var n=e.getPose(this._xrInputSource.targetRaySpace,this._manager._referenceSpace);n&&(this._dirtyRay=!0,this._rayLocal.origin.copy(n.transform.position),this._rayLocal.direction.set(0,0,-1),Uy.copy(n.transform.orientation),Uy.transformVector(this._rayLocal.direction,this._rayLocal.direction))}}_updateTransforms(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,hi.ONE));var e=this._manager.camera.parent;e?this._worldTransform.mul2(e.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)}_updateRayTransforms(){var e=this._dirtyRay;if(this._dirtyRay=!1,this._manager.camera.parent){var t=this._manager.camera.parent.getWorldTransform();t.getTranslation(this._position),this._rotation.setFromMat4(t),this._rotation.transformVector(this._rayLocal.origin,this._ray.origin),this._ray.origin.add(this._position),this._rotation.transformVector(this._rayLocal.direction,this._ray.direction)}else e&&(this._ray.origin.copy(this._rayLocal.origin),this._ray.direction.copy(this._rayLocal.direction))}getPosition(){return this._position?(this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position):null}getLocalPosition(){return this._localPosition}getRotation(){return this._rotation?(this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation):null}getLocalRotation(){return this._localRotation}getLinearVelocity(){return this._velocitiesAvailable?this._linearVelocity:null}getOrigin(){return this._updateRayTransforms(),this._ray.origin}getDirection(){return this._updateRayTransforms(),this._ray.direction}hitTestStart(e){void 0===e&&(e={}),e.inputSource=this,e.profile=this._xrInputSource.profiles[0];var t=e.callback;e.callback=(e,i)=>{i&&this.onHitTestSourceAdd(i),t&&t(e,i)},this._manager.hitTest.start(e)}onHitTestSourceAdd(e){this._hitTestSources.push(e),this.fire("hittest:add",e),e.on("result",((t,i,s,r)=>{s===this&&this.fire("hittest:result",e,t,i,r)})),e.once("remove",(()=>{this.onHitTestSourceRemove(e),this.fire("hittest:remove",e)}))}onHitTestSourceRemove(e){var t=this._hitTestSources.indexOf(e);-1!==t&&this._hitTestSources.splice(t,1)}constructor(e,t){super(),this._ray=new Mi,this._rayLocal=new Mi,this._grip=!1,this._hand=null,this._velocitiesAvailable=!1,this._velocitiesTimestamp=Jt(),this._localTransform=null,this._worldTransform=null,this._position=new hi,this._rotation=new bi,this._localPosition=null,this._localPositionLast=null,this._localRotation=null,this._linearVelocity=null,this._dirtyLocal=!0,this._dirtyRay=!1,this._selecting=!1,this._squeezing=!1,this._elementInput=!0,this._elementEntity=null,this._hitTestSources=[],this._id=++Vy,this._manager=e,this._xrInputSource=t,t.hand&&(this._hand=new Ny(this))}}Hy.EVENT_REMOVE="remove",Hy.EVENT_SELECT="select",Hy.EVENT_SELECTSTART="selectstart",Hy.EVENT_SELECTEND="selectend",Hy.EVENT_SQUEEZE="squeeze",Hy.EVENT_SQUEEZESTART="squeezestart",Hy.EVENT_SQUEEZEEND="squeezeend",Hy.EVENT_HITTESTADD="hittest:add",Hy.EVENT_HITTESTREMOVE="hittest:remove",Hy.EVENT_HITTESTRESULT="hittest:result";class Gy extends Ht{_onSessionStart(){var e=this.manager.session;e.addEventListener("inputsourceschange",this._onInputSourcesChangeEvt),e.addEventListener("select",(e=>{var t=this._getByInputSource(e.inputSource);t.update(e.frame),t.fire("select",e),this.fire("select",t,e)})),e.addEventListener("selectstart",(e=>{var t=this._getByInputSource(e.inputSource);t.update(e.frame),t._selecting=!0,t.fire("selectstart",e),this.fire("selectstart",t,e)})),e.addEventListener("selectend",(e=>{var t=this._getByInputSource(e.inputSource);t.update(e.frame),t._selecting=!1,t.fire("selectend",e),this.fire("selectend",t,e)})),e.addEventListener("squeeze",(e=>{var t=this._getByInputSource(e.inputSource);t.update(e.frame),t.fire("squeeze",e),this.fire("squeeze",t,e)})),e.addEventListener("squeezestart",(e=>{var t=this._getByInputSource(e.inputSource);t.update(e.frame),t._squeezing=!0,t.fire("squeezestart",e),this.fire("squeezestart",t,e)})),e.addEventListener("squeezeend",(e=>{var t=this._getByInputSource(e.inputSource);t.update(e.frame),t._squeezing=!1,t.fire("squeezeend",e),this.fire("squeezeend",t,e)}));for(var t=e.inputSources,i=0;i<t.length;i++)this._addInputSource(t[i])}_onSessionEnd(){for(var e=this._inputSources.length;e--;){var t=this._inputSources[e];this._inputSources.splice(e,1),t.fire("remove"),this.fire("remove",t)}this.manager.session.removeEventListener("inputsourceschange",this._onInputSourcesChangeEvt)}_onInputSourcesChange(e){for(var t=0;t<e.removed.length;t++)this._removeInputSource(e.removed[t]);for(var i=0;i<e.added.length;i++)this._addInputSource(e.added[i])}_getByInputSource(e){for(var t=0;t<this._inputSources.length;t++)if(this._inputSources[t].inputSource===e)return this._inputSources[t];return null}_addInputSource(e){if(!this._getByInputSource(e)){var t=new Hy(this.manager,e);this._inputSources.push(t),this.fire("add",t)}}_removeInputSource(e){for(var t=0;t<this._inputSources.length;t++)if(this._inputSources[t].inputSource===e){var i=this._inputSources[t];this._inputSources.splice(t,1);for(var s=i.hitTestSources.length;s--;)i.hitTestSources[s].remove();return i.fire("remove"),void this.fire("remove",i)}}update(e){for(var t=0;t<this._inputSources.length;t++)this._inputSources[t].update(e)}get inputSources(){return this._inputSources}constructor(e){var t,i;super(),this._inputSources=[],this.velocitiesSupported=!1,this.manager=e,this.velocitiesSupported=!(!Ut.browser||!(null==(i=window.XRPose)||null==(t=i.prototype)?void 0:t.hasOwnProperty("linearVelocity"))),this._onInputSourcesChangeEvt=e=>{this._onInputSourcesChange(e)},this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this)}}Gy.EVENT_ADD="add",Gy.EVENT_REMOVE="remove",Gy.EVENT_SELECT="select",Gy.EVENT_SELECTSTART="selectstart",Gy.EVENT_SELECTEND="selectend",Gy.EVENT_SQUEEZE="squeeze",Gy.EVENT_SQUEEZESTART="squeezestart",Gy.EVENT_SQUEEZEEND="squeezeend";var Wy=new hi,jy=new hi,qy=new _i,Xy=new _i;class Ky extends Ht{_onSessionStart(){!!this._manager.session.requestLightProbe&&(this._supported=!0)}_onSessionEnd(){this._supported=!1,this._available=!1,this._lightProbeRequested=!1,this._lightProbe=null}start(){var e;this._manager.session||(e=new Error("XR session is not running")),e||this._manager.type===fy||(e=new Error("XR session type is not AR")),e||this._supported||(e=new Error("light-estimation is not supported")),(!e&&this._lightProbe||this._lightProbeRequested)&&(e=new Error("light estimation is already requested")),e?this.fire("error",e):(this._lightProbeRequested=!0,this._manager.session.requestLightProbe().then((e=>{var t=this._lightProbeRequested;this._lightProbeRequested=!1,this._manager.active?t&&(this._lightProbe=e):this.fire("error",new Error("XR session is not active"))})).catch((e=>{this._lightProbeRequested=!1,this.fire("error",e)})))}end(){this._lightProbeRequested=!1,this._lightProbe=null,this._available=!1}update(e){if(this._lightProbe){var t=e.getLightEstimate(this._lightProbe);if(t){this._available||(this._available=!0,this.fire("available"));var i=t.primaryLightIntensity;this._intensity=Math.max(1,Math.max(i.x,Math.max(i.y,i.z))),Wy.copy(i).mulScalar(1/this._intensity),this._color.set(Wy.x,Wy.y,Wy.z),Wy.set(0,0,0),jy.copy(t.primaryLightDirection),qy.setLookAt(jy,Wy,hi.UP),Xy.setFromAxisAngle(hi.RIGHT,90),qy.mul(Xy),this._rotation.setFromMat4(qy),this._sphericalHarmonics.set(t.sphericalHarmonicsCoefficients)}}}get supported(){return this._supported}get available(){return this._available}get intensity(){return this._available?this._intensity:null}get color(){return this._available?this._color:null}get rotation(){return this._available?this._rotation:null}get sphericalHarmonics(){return this._available?this._sphericalHarmonics:null}constructor(e){super(),this._supported=!1,this._available=!1,this._lightProbeRequested=!1,this._lightProbe=null,this._intensity=0,this._rotation=new bi,this._color=new ii,this._sphericalHarmonics=new Float32Array(27),this._manager=e,this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this)}}Ky.EVENT_AVAILABLE="available",Ky.EVENT_ERROR="error";var Yy=0;class Qy extends Ht{destroy(){this._xrPlane&&(this._xrPlane=null,this.fire("remove"))}update(e){var t=this._planeDetection._manager,i=e.getPose(this._xrPlane.planeSpace,t._referenceSpace);i&&(this._position.copy(i.transform.position),this._rotation.copy(i.transform.orientation)),this._lastChangedTime!==this._xrPlane.lastChangedTime&&(this._lastChangedTime=this._xrPlane.lastChangedTime,this.fire("change"))}getPosition(){return this._position}getRotation(){return this._rotation}get id(){return this._id}get orientation(){return this._orientation}get points(){return this._xrPlane.polygon}get label(){return this._xrPlane.semanticLabel||""}constructor(e,t){super(),this._position=new hi,this._rotation=new bi,this._id=++Yy,this._planeDetection=e,this._xrPlane=t,this._lastChangedTime=t.lastChangedTime,this._orientation=t.orientation}}Qy.EVENT_REMOVE="remove",Qy.EVENT_CHANGE="change";class Jy extends Ht{_onSessionStart(){this._manager.session.enabledFeatures&&(-1!==this._manager.session.enabledFeatures.indexOf("plane-detection")&&(this._available=!0,this.fire("available")))}_onSessionEnd(){for(var e=0;e<this._planes.length;e++)this._planes[e].destroy(),this.fire("remove",this._planes[e]);this._planesIndex.clear(),this._planes.length=0,this._available&&(this._available=!1,this.fire("unavailable"))}update(e){if(!this._available){if(this._manager.session.enabledFeatures||!e.detectedPlanes.size)return;this._available=!0,this.fire("available")}var t=e.detectedPlanes;for(var[i,s]of this._planesIndex)t.has(i)||(this._planesIndex.delete(i),this._planes.splice(this._planes.indexOf(s),1),s.destroy(),this.fire("remove",s));for(var r of t){var n=this._planesIndex.get(r);n?n.update(e):(n=new Qy(this,r),this._planesIndex.set(r,n),this._planes.push(n),n.update(e),this.fire("add",n))}}get supported(){return this._supported}get available(){return this._available}get planes(){return this._planes}constructor(e){super(),this._supported=Ut.browser&&!!window.XRPlane,this._available=!1,this._planesIndex=new Map,this._planes=[],this._manager=e,this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}}Jy.EVENT_AVAILABLE="available",Jy.EVENT_UNAVAILABLE="unavailable",Jy.EVENT_ADD="add",Jy.EVENT_REMOVE="remove";class $y extends Ht{destroy(){if(this._xrAnchor){var e=this._xrAnchor;this._xrAnchor.delete(),this._xrAnchor=null,this.fire("destroy",e,this)}}update(e){if(this._xrAnchor){var t=e.getPose(this._xrAnchor.anchorSpace,this._anchors.manager._referenceSpace);if(t){if(this._position.equals(t.transform.position)&&this._rotation.equals(t.transform.orientation))return;this._position.copy(t.transform.position),this._rotation.copy(t.transform.orientation),this.fire("change")}}}getPosition(){return this._position}getRotation(){return this._rotation}persist(e){this._anchors.persistence?this._uuid?null==e||e(null,this._uuid):this._uuidRequests?e&&this._uuidRequests.push(e):(this._uuidRequests=[],this._xrAnchor.requestPersistentHandle().then((t=>{for(var i of(this._uuid=t,this._anchors._indexByUuid.set(this._uuid,this),null==e||e(null,t),this._uuidRequests))i(null,t);this._uuidRequests=null,this.fire("persist",t)})).catch((t=>{for(var i of(null==e||e(t,null),this._uuidRequests))i(t,null);this._uuidRequests=null}))):null==e||e(new Error("Persistent Anchors are not supported"),null)}forget(e){this._uuid?this._anchors.forget(this._uuid,(t=>{this._uuid=null,null==e||e(t),this.fire("forget")})):null==e||e(new Error("Anchor is not persistent"))}get uuid(){return this._uuid}get persistent(){return!!this._uuid}constructor(e,t,i=null){super(),this._position=new hi,this._rotation=new bi,this._uuid=null,this._uuidRequests=null,this._anchors=e,this._xrAnchor=t,this._uuid=i}}$y.EVENT_DESTROY="destroy",$y.EVENT_CHANGE="change",$y.EVENT_PERSIST="persist",$y.EVENT_FORGET="forget";class Zy extends Ht{_onSessionStart(){var e=-1!==this.manager.session.enabledFeatures.indexOf("anchors");e&&(this._available=e,this.fire("available"))}_onSessionEnd(){if(this._available){this._available=!1;for(var e=0;e<this._creationQueue.length;e++)this._creationQueue[e].callback&&this._creationQueue[e].callback(new Error("session ended"),null);this._creationQueue.length=0,this._index.clear(),this._indexByUuid.clear();for(var t=this._list.length;t--;)this._list[t].destroy();this._list.length=0,this.fire("unavailable")}}_createAnchor(e,t){void 0===t&&(t=null);var i=new $y(this,e,t);return this._index.set(e,i),t&&this._indexByUuid.set(t,i),this._list.push(i),i.once("destroy",this._onAnchorDestroy,this),i}_onAnchorDestroy(e,t){this._index.delete(e),t.uuid&&this._indexByUuid.delete(t.uuid);var i=this._list.indexOf(t);-1!==i&&this._list.splice(i,1),this.fire("destroy",t)}create(e,t,i){if(this._available)if(window.XRHitTestResult&&e instanceof XRHitTestResult){var s=e;if(i=t,!this._supported)return void(null==i||i(new Error("Anchors API is not supported"),null));if(!s.createAnchor)return void(null==i||i(new Error("Creating Anchor from Hit Test is not supported"),null));s.createAnchor().then((e=>{var t=this._createAnchor(e);null==i||i(null,t),this.fire("add",t)})).catch((e=>{null==i||i(e,null),this.fire("error",e)}))}else this._creationQueue.push({transform:new XRRigidTransform(e,t),callback:i});else null==i||i(new Error("Anchors API is not available"),null)}restore(e,t){this._available?this._persistence?this.manager.active?this.manager.session.restorePersistentAnchor(e).then((i=>{var s=this._createAnchor(i,e);null==t||t(null,s),this.fire("add",s)})).catch((e=>{null==t||t(e,null),this.fire("error",e)})):null==t||t(new Error("WebXR session is not active"),null):null==t||t(new Error("Anchor Persistence is not supported"),null):null==t||t(new Error("Anchors API is not available"),null)}forget(e,t){this._available?this._persistence?this.manager.active?this.manager.session.deletePersistentAnchor(e).then((()=>{null==t||t(null)})).catch((e=>{null==t||t(e),this.fire("error",e)})):null==t||t(new Error("WebXR session is not active")):null==t||t(new Error("Anchor Persistence is not supported")):null==t||t(new Error("Anchors API is not available"))}update(e){if(this._available){if(this._creationQueue.length){for(var t,i=function(i){var s=t._creationQueue[i];e.createAnchor(s.transform,t.manager._referenceSpace).then((e=>{s.callback&&t._callbacksAnchors.set(e,s.callback)})).catch((e=>{s.callback&&s.callback(e,null),t.fire("error",e)}))},s=0;s<this._creationQueue.length;s++)t=this,i(s);this._creationQueue.length=0}for(var[r,n]of this._index)e.trackedAnchors.has(r)||(this._index.delete(r),n.destroy());for(var a=0;a<this._list.length;a++)this._list[a].update(e);for(var o of e.trackedAnchors)if(!this._index.has(o)){var l=this._createAnchor(o);l.update(e);var h=this._callbacksAnchors.get(o);h&&(this._callbacksAnchors.delete(o),h(null,l)),this.fire("add",l)}}else this.manager.session.enabledFeatures||this._checkingAvailability||(this._checkingAvailability=!0,e.createAnchor(new XRRigidTransform,this.manager._referenceSpace).then((e=>{e.delete(),this.manager.active&&(this._available=!0,this.fire("available"))})).catch((()=>{})))}get supported(){return this._supported}get available(){return this._available}get persistence(){return this._persistence}get uuids(){return this._available&&this._persistence&&this.manager.active?this.manager.session.persistentAnchors:null}get list(){return this._list}constructor(e){var t,i;super(),this._supported=Ut.browser&&!!window.XRAnchor,this._available=!1,this._checkingAvailability=!1,this._persistence=Ut.browser&&!!(null==(i=window)||null==(t=i.XRSession)?void 0:t.prototype.restorePersistentAnchor),this._creationQueue=[],this._index=new Map,this._indexByUuid=new Map,this._list=[],this._callbacksAnchors=new Map,this.manager=e,this._supported&&(this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this))}}Zy.EVENT_AVAILABLE="available",Zy.EVENT_UNAVAILABLE="unavailable",Zy.EVENT_ERROR="error",Zy.EVENT_ADD="add",Zy.EVENT_DESTROY="destroy";class ex extends Ht{get xrMesh(){return this._xrMesh}get label(){return this._xrMesh.semanticLabel||""}get vertices(){return this._xrMesh.vertices}get indices(){return this._xrMesh.indices}destroy(){this._xrMesh&&(this._xrMesh=null,this.fire("remove"))}update(e){var t=this._meshDetection._manager,i=e.getPose(this._xrMesh.meshSpace,t._referenceSpace);i&&(this._position.copy(i.transform.position),this._rotation.copy(i.transform.orientation)),this._lastChanged!==this._xrMesh.lastChangedTime&&(this._lastChanged=this._xrMesh.lastChangedTime,this.fire("change"))}getPosition(){return this._position}getRotation(){return this._rotation}constructor(e,t){super(),this._lastChanged=0,this._position=new hi,this._rotation=new bi,this._meshDetection=e,this._xrMesh=t,this._lastChanged=this._xrMesh.lastChangedTime}}ex.EVENT_REMOVE="remove",ex.EVENT_CHANGE="change";class tx extends Ht{update(e){if(!this._available){if(this._manager.session.enabledFeatures||!e.detectedMeshes.size)return;this._available=!0,this.fire("available")}for(var t of e.detectedMeshes){var i=this._index.get(t);i?i.update(e):(i=new ex(this,t),this._index.set(t,i),this._list.push(i),i.update(e),this.fire("add",i))}for(var s of this._index.values())e.detectedMeshes.has(s.xrMesh)||this._removeMesh(s)}_removeMesh(e){this._index.delete(e.xrMesh),this._list.splice(this._list.indexOf(e),1),e.destroy(),this.fire("remove",e)}_onSessionStart(){if(this._manager.session.enabledFeatures){var e=-1!==this._manager.session.enabledFeatures.indexOf("mesh-detection");if(!e)return;this._available=e,this.fire("available")}}_onSessionEnd(){if(this._available){for(var e of(this._available=!1,this._index.values()))this._removeMesh(e);this.fire("unavailable")}}get supported(){return this._supported}get available(){return this._available}get meshes(){return this._list}constructor(e){super(),this._supported=Ut.browser&&!!window.XRMesh,this._available=!1,this._index=new Map,this._list=[],this._manager=e,this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}}tx.EVENT_AVAILABLE="available",tx.EVENT_UNAVAILABLE="unavailable",tx.EVENT_ADD="add",tx.EVENT_REMOVE="remove";class ix extends Ht{get textureColor(){return this._textureColor}get textureDepth(){return this._textureDepth}get depthUvMatrix(){return this._depthMatrix}get depthValueToMeters(){var e;return(null==(e=this._depthInfo)?void 0:e.rawValueToMeters)||0}get eye(){return this._xrView.eye}get viewport(){return this._viewport}get projMat(){return this._projMat}get projViewOffMat(){return this._projViewOffMat}get viewOffMat(){return this._viewOffMat}get viewInvOffMat(){return this._viewInvOffMat}get viewMat3(){return this._viewMat3}get positionData(){return this._positionData}update(e,t){this._xrView=t,this._manager.views.availableColor&&(this._xrCamera=this._xrView.camera);var i=e.session.renderState.baseLayer.getViewport(this._xrView);this._viewport.x=i.x,this._viewport.y=i.y,this._viewport.z=i.width,this._viewport.w=i.height,this._projMat.set(this._xrView.projectionMatrix),this._viewMat.set(this._xrView.transform.inverse.matrix),this._viewInvMat.set(this._xrView.transform.matrix),this._updateTextureColor(),this._updateDepth(e)}_updateTextureColor(){if(this._manager.views.availableColor&&this._xrCamera&&this._textureColor){var e=this._manager.webglBinding;if(e){var t=e.getCameraImage(this._xrCamera);if(t){var i=this._manager.app.graphicsDevice,s=i.gl;if(this._frameBufferSource){var r=s.COLOR_ATTACHMENT0,n=this._xrCamera.width,a=this._xrCamera.height;i.setFramebuffer(this._frameBufferSource),s.framebufferTexture2D(s.FRAMEBUFFER,r,s.TEXTURE_2D,t,0),i.setFramebuffer(this._frameBuffer),s.framebufferTexture2D(s.FRAMEBUFFER,r,s.TEXTURE_2D,this._textureColor.impl._glTexture,0),s.bindFramebuffer(s.READ_FRAMEBUFFER,this._frameBufferSource),s.bindFramebuffer(s.DRAW_FRAMEBUFFER,this._frameBuffer),s.blitFramebuffer(0,a,n,0,0,0,n,a,s.COLOR_BUFFER_BIT,s.NEAREST)}else this._frameBufferSource=s.createFramebuffer(),this._frameBuffer=s.createFramebuffer()}}}}_updateDepth(e){var t,i;if(this._manager.views.availableDepth&&this._textureDepth){var s=this._manager.views.depthGpuOptimized,r=s?this._manager.webglBinding:e;if(r){var n=r.getDepthInformation(this._xrView);if(n){var a=!this._depthInfo!=!n;this._depthInfo=n;var o=(null==(t=this._depthInfo)?void 0:t.width)||4,l=(null==(i=this._depthInfo)?void 0:i.height)||4,h=!1;if(this._textureDepth.width===o&&this._textureDepth.height===l||(this._textureDepth._width=o,this._textureDepth._height=l,a=!0,h=!0),a&&(this._depthInfo?this._depthMatrix.data.set(this._depthInfo.normDepthBufferFromNormView.matrix):this._depthMatrix.setIdentity()),this._depthInfo)if(s){if(this._depthInfo.texture){var c=this._manager.app.graphicsDevice.gl;switch(this._textureDepth.impl._glTexture=this._depthInfo.texture,"texture-array"===this._depthInfo.textureType?this._textureDepth.impl._glTarget=c.TEXTURE_2D_ARRAY:this._textureDepth.impl._glTarget=c.TEXTURE_2D,this._manager.views.depthPixelFormat){case Oi:this._textureDepth.impl._glInternalFormat=c.R32F,this._textureDepth.impl._glPixelType=c.FLOAT,this._textureDepth.impl._glFormat=c.RED;break;case Fi:this._textureDepth.impl._glInternalFormat=c.DEPTH_COMPONENT16,this._textureDepth.impl._glPixelType=c.UNSIGNED_SHORT,this._textureDepth.impl._glFormat=c.DEPTH_COMPONENT}this._textureDepth.impl._glCreated=!0}}else this._textureDepth._levels[0]=new Uint8Array(this._depthInfo.data),this._textureDepth.upload();else this._textureDepth._levels[0]=this._emptyDepthBuffer,this._textureDepth.upload();h&&this.fire("depth:resize",o,l)}else this._depthInfo=null}else this._depthInfo=null}}updateTransforms(e){e?(this._viewInvOffMat.mul2(e,this._viewInvMat),this.viewOffMat.copy(this._viewInvOffMat).invert()):(this._viewInvOffMat.copy(this._viewInvMat),this.viewOffMat.copy(this._viewMat)),this._viewMat3.setFromMat4(this._viewOffMat),this._projViewOffMat.mul2(this._projMat,this._viewOffMat),this._positionData[0]=this._viewInvOffMat.data[12],this._positionData[1]=this._viewInvOffMat.data[13],this._positionData[2]=this._viewInvOffMat.data[14]}_onDeviceLost(){this._frameBufferSource=null,this._frameBuffer=null,this._depthInfo=null}getDepth(e,t){var i,s;return this._manager.views.depthGpuOptimized?null:null!=(s=null==(i=this._depthInfo)?void 0:i.getDepthInMeters(e,t))?s:null}destroy(){if(this._depthInfo=null,this._textureColor&&(this._textureColor.destroy(),this._textureColor=null),this._textureDepth&&(this._textureDepth.destroy(),this._textureDepth=null),this._frameBufferSource){var e=this._manager.app.graphicsDevice.gl;e.deleteFramebuffer(this._frameBufferSource),this._frameBufferSource=null,e.deleteFramebuffer(this._frameBuffer),this._frameBuffer=null}}constructor(e,t,i){super(),this._positionData=new Float32Array(3),this._viewport=new ui,this._projMat=new _i,this._projViewOffMat=new _i,this._viewMat=new _i,this._viewOffMat=new _i,this._viewMat3=new ci,this._viewInvMat=new _i,this._viewInvOffMat=new _i,this._xrCamera=null,this._textureColor=null,this._textureDepth=null,this._depthInfo=null,this._emptyDepthBuffer=new Uint8Array(32),this._depthMatrix=new _i,this._manager=e,this._xrView=t;var s=this._manager.app.graphicsDevice;if(this._manager.views.supportedColor&&(this._xrCamera=this._xrView.camera,this._manager.views.availableColor&&this._xrCamera&&(this._textureColor=new ur(s,{format:6,mipmaps:!1,addressU:1,addressV:1,minFilter:1,magFilter:1,width:this._xrCamera.width,height:this._xrCamera.height,name:"XrView-"+this._xrView.eye+"-Color"}))),this._manager.views.supportedDepth&&this._manager.views.availableDepth){var r=this._manager.views.depthGpuOptimized?0:1;this._textureDepth=new ur(s,{format:this._manager.views.depthPixelFormat,arrayLength:1===i?0:i,mipmaps:!1,addressU:1,addressV:1,minFilter:r,magFilter:r,width:4,height:4,name:"XrView-"+this._xrView.eye+"-Depth"});for(var n=0;n<this._textureDepth._levels.length;n++)this._textureDepth._levels[n]=this._emptyDepthBuffer;this._textureDepth.upload()}(this._textureColor||this._textureDepth)&&s.on("devicelost",this._onDeviceLost,this)}}ix.EVENT_DEPTHRESIZE="depth:resize";class sx extends Ht{get list(){return this._list}get supportedColor(){return this._supportedColor}get supportedDepth(){return this._supportedDepth}get availableColor(){return this._availableColor}get availableDepth(){return this._availableDepth}get depthUsage(){return this._depthUsage}get depthGpuOptimized(){return this._depthUsage===_y}get depthFormat(){return this._depthFormat}get depthPixelFormat(){var e;return null!=(e=this._depthFormats[this._depthFormat])?e:null}update(e,t){for(var i=0;i<t.length;i++)this._indexTmp.set(t[i].eye,t[i]);for(var[s,r]of this._indexTmp){var n=this._index.get(s);n?n.update(e,r):(n=new ix(this._manager,r,t.length),this._index.set(s,n),this._list.push(n),n.update(e,r),this.fire("add",n))}for(var[a,o]of this._index)if(!this._indexTmp.has(a)){o.destroy(),this._index.delete(a);var l=this._list.indexOf(o);-1!==l&&this._list.splice(l,1),this.fire("remove",o)}this._indexTmp.clear()}get(e){return this._index.get(e)||null}_onSessionStart(){if(this._manager.type===fy&&this._manager.session.enabledFeatures&&(this._availableColor=-1!==this._manager.session.enabledFeatures.indexOf("camera-access"),this._availableDepth=-1!==this._manager.session.enabledFeatures.indexOf("depth-sensing"),this._availableDepth)){var e=this._manager.session;this._depthUsage=e.depthUsage,this._depthFormat=e.depthDataFormat}}_onSessionEnd(){for(var e of this._index.values())e.destroy();this._index.clear(),this._availableColor=!1,this._availableDepth=!1,this._depthUsage="",this._depthFormat="",this._list.length=0}constructor(e){super(),this._index=new Map,this._indexTmp=new Map,this._list=[],this._supportedColor=Ut.browser&&!!window.XRCamera&&!!window.XRWebGLBinding,this._supportedDepth=Ut.browser&&!!window.XRDepthInformation,this._availableColor=!1,this._availableDepth=!1,this._depthUsage="",this._depthFormat="",this._depthFormats={[by]:2,[yy]:Fi,[xy]:Oi},this._manager=e,this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this)}}sx.EVENT_ADD="add",sx.EVENT_REMOVE="remove";class rx extends Ht{destroy(){}start(e,t,i,s){var r,n=s;if("object"==typeof s&&(n=s.callback),this._available[t])if(this._session)n&&n(new Error("XR session is already started"));else{var a;this._camera=e,this._camera.camera.xr=this,this._type=t,this._spaceType=i,this._framebufferScaleFactor=null!=(a=null==s?void 0:s.framebufferScaleFactor)?a:1,this._setClipPlanes(e.nearClip,e.farClip);var o={requiredFeatures:[i],optionalFeatures:[]},l=null==(r=this.app.graphicsDevice)?void 0:r.isWebGL2;if(t===fy){if(o.optionalFeatures.push("light-estimation"),o.optionalFeatures.push("hit-test"),s&&(s.imageTracking&&this.imageTracking.supported&&o.optionalFeatures.push("image-tracking"),s.planeDetection&&o.optionalFeatures.push("plane-detection"),s.meshDetection&&o.optionalFeatures.push("mesh-detection")),this.domOverlay.supported&&this.domOverlay.root&&(o.optionalFeatures.push("dom-overlay"),o.domOverlay={root:this.domOverlay.root}),s&&s.anchors&&this.anchors.supported&&o.optionalFeatures.push("anchors"),s&&s.depthSensing&&this.views.supportedDepth){o.optionalFeatures.push("depth-sensing");var h=[],c=[];if(h.push(_y,"cpu-optimized"),c.push(xy,by,yy),s.depthSensing.usagePreference){var d=h.indexOf(s.depthSensing.usagePreference);-1!==d&&h.splice(d,1),h.unshift(s.depthSensing.usagePreference)}if(s.depthSensing.dataFormatPreference){var u=c.indexOf(s.depthSensing.dataFormatPreference);-1!==u&&c.splice(u,1),c.unshift(s.depthSensing.dataFormatPreference)}o.depthSensing={usagePreference:h,dataFormatPreference:c}}l&&s&&s.cameraColor&&this.views.supportedColor&&o.optionalFeatures.push("camera-access")}o.optionalFeatures.push("hand-tracking"),s&&s.optionalFeatures&&(o.optionalFeatures=o.optionalFeatures.concat(s.optionalFeatures)),this.imageTracking.supported&&this.imageTracking.images.length?this.imageTracking.prepareImages(((e,s)=>{if(e)return n&&n(e),void this.fire("error",e);null!==s&&(o.trackedImages=s),this._onStartOptionsReady(t,i,o,n)})):this._onStartOptionsReady(t,i,o,n)}else n&&n(new Error("XR is not available"))}_onStartOptionsReady(e,t,i,s){navigator.xr.requestSession(e,i).then((e=>{this._onSessionStart(e,t,s)})).catch((e=>{this._camera.camera.xr=null,this._camera=null,this._type=null,this._spaceType=null,s&&s(e),this.fire("error",e)}))}end(e){this._session?(this.webglBinding=null,e&&this.once("end",e),this._session.end()):e&&e(new Error("XR Session is not initialized"))}isAvailable(e){return this._available[e]}_deviceAvailabilityCheck(){for(var e in this._available)this._sessionSupportCheck(e)}initiateRoomCapture(e){this._session?this._session.initiateRoomCapture?this._session.initiateRoomCapture().then((()=>{e&&e(null)})).catch((t=>{e&&e(t)})):e(new Error("Session does not support manual room capture")):e(new Error("Session is not active"))}updateTargetFrameRate(e,t){var i;(null==(i=this._session)?void 0:i.updateTargetFrameRate)?this._session.updateTargetFrameRate(e).then((()=>{null==t||t()})).catch((e=>{null==t||t(e)})):null==t||t(new Error("unable to update frameRate"))}_sessionSupportCheck(e){navigator.xr.isSessionSupported(e).then((t=>{this._available[e]!==t&&(this._available[e]=t,this.fire("available",e,t),this.fire("available:"+e,t))})).catch((e=>{this.fire("error",e)}))}_onSessionStart(e,t,i){var s=!1;this._session=e;var r=()=>{this.fire("visibility:change",e.visibilityState)},n=()=>{this._setClipPlanes(this._camera.nearClip,this._camera.farClip)},a=()=>{this._camera&&(this._camera.off("set_nearClip",n),this._camera.off("set_farClip",n),this._camera.camera.xr=null,this._camera=null),e.removeEventListener("end",a),e.removeEventListener("visibilitychange",r),s||this.fire("end"),this._session=null,this._referenceSpace=null,this._width=0,this._height=0,this._type=null,this._spaceType=null,this.app.systems&&this.app.tick()};e.addEventListener("end",a),e.addEventListener("visibilitychange",r),this._camera.on("set_nearClip",n),this._camera.on("set_farClip",n),this._createBaseLayer(),this.session.supportedFrameRates?this._supportedFrameRates=Array.from(this.session.supportedFrameRates):this._supportedFrameRates=null,this._session.addEventListener("frameratechange",(()=>{var e;this.fire("frameratechange",null==(e=this._session)?void 0:e.frameRate)})),e.requestReferenceSpace(t).then((e=>{this._referenceSpace=e,this.app.tick(),i&&i(null),this.fire("start")})).catch((t=>{s=!0,e.end(),i&&i(t),this.fire("error",t)}))}_setClipPlanes(e,t){this._depthNear===e&&this._depthFar===t||(this._depthNear=e,this._depthFar=t,this._session&&this._session.updateRenderState({depthNear:this._depthNear,depthFar:this._depthFar}))}_createBaseLayer(){var e=this.app.graphicsDevice,t=e.maxPixelRatio/window.devicePixelRatio*this._framebufferScaleFactor;if(this._baseLayer=new XRWebGLLayer(this._session,e.gl,{alpha:!0,depth:!0,stencil:!0,framebufferScaleFactor:t,antialias:!1}),(null==e?void 0:e.isWebGL2)&&window.XRWebGLBinding)try{this.webglBinding=new XRWebGLBinding(this._session,e.gl)}catch(e){this.fire("error",e)}this._session.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar})}_onDeviceLost(){this._session&&(this.webglBinding&&(this.webglBinding=null),this._baseLayer=null,this._session.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar}))}_onDeviceRestored(){this._session&&setTimeout((()=>{this.app.graphicsDevice.gl.makeXRCompatible().then((()=>{this._createBaseLayer()})).catch((e=>{this.fire("error",e)}))}),0)}update(e){if(!this._session)return!1;var t=e.session.renderState.baseLayer.framebufferWidth,i=e.session.renderState.baseLayer.framebufferHeight;this._width===t&&this._height===i||(this._width=t,this._height=i,this.app.graphicsDevice.setResolution(t,i));var s=e.getViewerPose(this._referenceSpace);if(!s)return!1;var r=this.views.list.length;this.views.update(e,s.views);var n=s.transform.position,a=s.transform.orientation;if(this._localPosition.set(n.x,n.y,n.z),this._localRotation.set(a.x,a.y,a.z,a.w),0===r&&this.views.list.length>0){var o=new _i,l=this.views.list[0];o.copy(l.projMat);var h=o.data,c=2*Math.atan(1/h[5])*180/Math.PI,d=h[5]/h[0],u=h[14]/(h[10]+1),f=h[14]/(h[10]-1);this._camera.camera.setXrProperties({aspectRatio:d,farClip:u,fov:c,horizontalFov:!1,nearClip:f})}return this._camera.camera._node.setLocalPosition(this._localPosition),this._camera.camera._node.setLocalRotation(this._localRotation),this.input.update(e),this._type===fy&&(this.hitTest.supported&&this.hitTest.update(e),this.lightEstimation.supported&&this.lightEstimation.update(e),this.imageTracking.supported&&this.imageTracking.update(e),this.anchors.supported&&this.anchors.update(e),this.planeDetection.supported&&this.planeDetection.update(e),this.meshDetection.supported&&this.meshDetection.update(e)),this.fire("update",e),!0}get supported(){return this._supported}get active(){return!!this._session}get type(){return this._type}get spaceType(){return this._spaceType}get session(){return this._session}get frameRate(){var e,t;return null!=(t=null==(e=this._session)?void 0:e.frameRate)?t:null}get supportedFrameRates(){return this._supportedFrameRates}get framebufferScaleFactor(){return this._framebufferScaleFactor}set fixedFoveation(e){var t,i;null!==(null!=(i=null==(t=this._baseLayer)?void 0:t.fixedFoveation)?i:null)&&(this._baseLayer.fixedFoveation=e)}get fixedFoveation(){var e,t;return null!=(t=null==(e=this._baseLayer)?void 0:e.fixedFoveation)?t:null}get camera(){return this._camera?this._camera.entity:null}get visibilityState(){return this._session?this._session.visibilityState:null}constructor(e){super(),this._supported=Ut.browser&&!!navigator.xr,this._available={},this._type=null,this._spaceType=null,this._session=null,this._baseLayer=null,this.webglBinding=null,this._referenceSpace=null,this._camera=null,this._localPosition=new hi,this._localRotation=new bi,this._depthNear=.1,this._depthFar=1e3,this._supportedFrameRates=null,this._width=0,this._height=0,this._framebufferScaleFactor=1,this.app=e,this._available.inline=!1,this._available["immersive-vr"]=!1,this._available[fy]=!1,this.views=new sx(this),this.domOverlay=new Sy(this),this.hitTest=new Ey(this),this.imageTracking=new Py(this),this.planeDetection=new Jy(this),this.meshDetection=new tx(this),this.input=new Gy(this),this.lightEstimation=new Ky(this),this.anchors=new Zy(this),this.views=new sx(this),this._supported&&(navigator.xr.addEventListener("devicechange",(()=>{this._deviceAvailabilityCheck()})),this._deviceAvailabilityCheck(),this.app.graphicsDevice.on("devicelost",this._onDeviceLost,this),this.app.graphicsDevice.on("devicerestored",this._onDeviceRestored,this))}}rx.EVENT_AVAILABLE="available",rx.EVENT_START="start",rx.EVENT_END="end",rx.EVENT_UPDATE="update",rx.EVENT_ERROR="error";var nx=[],ax=[[],[],[]];class ox extends Do{destroy(){this.viewBindGroups.forEach((e=>{e.defaultUniformBuffer.destroy(),e.destroy()})),this.viewBindGroups.length=0}update(e,t,i,s){this.camera=e,this.scene=t,this.layers=i,this.mapping=s}execute(){for(var e=this.device,{renderer:t,camera:i,scene:s,layers:r,mapping:n,renderTarget:a}=this,o=s.layers.layerList,l=s.layers.subLayerEnabled,h=s.layers.subLayerList,c=0;c<o.length;c++){var d=o[c];if(!(r&&r.indexOf(d)<0)&&(d.enabled&&l[c]&&d.camerasSet.has(i.camera))){var u=h[c];d._clearDepthBuffer&&t.clear(i.camera,!1,!0,!1);for(var f=d.meshInstances,p=0;p<f.length;p++){var m=f[p];m.pick&&m.transparent===u&&(nx.push(m),n.set(m.id,m))}if(nx.length>0){if(s.clusteredLightingEnabled)t.worldClustersAllocator.empty.activate();t.setCameraUniforms(i.camera,a),e.supportsUniformBuffers&&t.setupViewUniformBuffers(this.viewBindGroups,t.viewUniformFormat,t.viewBindGroupFormat,1),t.renderForward(i.camera,a,nx,ax,3,(t=>{e.setBlendState(Sr.NOBLEND)})),nx.length=0}}}}constructor(e,t){super(e),this.viewBindGroups=[],this.renderer=t}}var lx=new Set,hx=new ui;let cx=class{getSelection(e,t,i,s){void 0===i&&(i=1),void 0===s&&(s=1);var r=this.device;if(r.isWebGPU)return[];t=this.renderTarget.height-(t+s);var n=this.sanitizeRect(e,t,i,s);r.setRenderTarget(this.renderTarget),r.updateBegin();var a=new Uint8Array(4*n.z*n.w);return r.readPixels(n.x,n.y,n.z,n.w,a),r.updateEnd(),this.decodePixels(a,this.mapping)}getSelectionAsync(e,t,i,s){var r;void 0===i&&(i=1),void 0===s&&(s=1),(null==(r=this.device)?void 0:r.isWebGL2)&&(t=this.renderTarget.height-(t+s));var n=this.sanitizeRect(e,t,i,s);return this.renderTarget.colorBuffer.read(n.x,n.y,n.z,n.w,{renderTarget:this.renderTarget,immediate:!0}).then((e=>this.decodePixels(e,this.mapping)))}sanitizeRect(e,t,i,s){var r=this.renderTarget.width,n=this.renderTarget.height;return e=ti.clamp(Math.floor(e),0,r-1),t=ti.clamp(Math.floor(t),0,n-1),i=Math.floor(Math.max(i,1)),i=Math.min(i,r-e),s=Math.floor(Math.max(s,1)),s=Math.min(s,n-t),hx.set(e,t,i,s)}decodePixels(e,t){var i=[];if(this.deviceValid){for(var s=e.length,r=0;r<s;r+=4){var n=e[r+0],a=e[r+1],o=e[r+2],l=(e[r+3]<<24|n<<16|a<<8|o)>>>0;4294967295!==l&&lx.add(t.get(l))}lx.forEach((e=>{e&&i.push(e)})),lx.clear()}return i}allocateRenderTarget(){var e=new ur(this.device,{format:7,width:this.width,height:this.height,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1,name:"pick"});this.renderTarget=new Wr({colorBuffer:e,depth:!0})}releaseRenderTarget(){this.renderTarget&&(this.renderTarget.destroyTextureBuffers(),this.renderTarget.destroy(),this.renderTarget=null)}prepare(e,t,i){i instanceof yu&&(i=[i]),this.renderTarget&&this.width===this.renderTarget.width&&this.height===this.renderTarget.height||(this.releaseRenderTarget(),this.allocateRenderTarget()),this.mapping.clear();var s=this.renderPass;s.init(this.renderTarget),s.colorOps.clearValue=ii.WHITE,s.colorOps.clear=!0,s.depthStencilOps.clearDepth=!0,s.update(e,t,i,this.mapping),s.render()}resize(e,t){this.width=Math.floor(e),this.height=Math.floor(t)}constructor(e,t,i){this.renderTarget=null,this.mapping=new Map,this.deviceValid=!0,this.renderer=e.renderer,this.device=e.graphicsDevice,this.renderPass=new ox(this.device,e.renderer),this.width=0,this.height=0,this.resize(t,i),this.device.on("destroy",(()=>{this.deviceValid=!1}))}};di.prototype.scale=di.prototype.mulScalar,hi.prototype.scale=hi.prototype.mulScalar,ui.prototype.scale=ui.prototype.mulScalar;Object.keys({"ambientPrefilteredCube.frag":"ambientEnv.frag","ambientPrefilteredCubeLod.frag":"ambientEnv.frag","dpAtlasQuad.frag":null,"genParaboloid.frag":null,"prefilterCubemap.frag":null,"reflectionDpAtlas.frag":"reflectionEnv.frag","reflectionPrefilteredCube.frag":"reflectionEnv.frag","reflectionPrefilteredCubeLod.frag":"reflectionEnv.frag"}).forEach((e=>{Object.defineProperty(_h,e,{get:function(){return null},set:function(){}})})),Object.defineProperties(Wr.prototype,{_glFrameBuffer:{get:function(){return this.impl._glFrameBuffer},set:function(e){}}}),Object.defineProperty(Nr,"defaultInstancingFormat",{get:function(){return null}}),Object.defineProperties(ur.prototype,{rgbm:{get:function(){return this.type===bs},set:function(e){this.type=e?bs:_s}},swizzleGGGR:{get:function(){return this.type===Ss},set:function(e){this.type=e?Ss:_s}},_glTexture:{get:function(){return this.impl._glTexture}}}),Object.defineProperty(Hr.prototype,"boneLimit",{get:function(){return 1024}}),Object.defineProperty(Hr.prototype,"webgl2",{get:function(){return this.isWebGL2}}),Object.defineProperty(Hr.prototype,"textureFloatHighPrecision",{get:function(){return!0}}),Object.defineProperty(Hr.prototype,"extBlendMinmax",{get:function(){return!0}}),Object.defineProperty(Hr.prototype,"extTextureHalfFloat",{get:function(){return!0}}),Object.defineProperty(Hr.prototype,"extTextureLod",{get:function(){return!0}}),Object.defineProperty(Hr.prototype,"textureHalfFloatFilterable",{get:function(){return!0}}),Object.defineProperty(Hr.prototype,"supportsMrt",{get:function(){return!0}}),Object.defineProperty(Hr.prototype,"supportsVolumeTextures",{get:function(){return!0}}),Object.defineProperty(Hr.prototype,"supportsInstancing",{get:function(){return!0}}),Object.defineProperty(Hr.prototype,"textureHalfFloatUpdatable",{get:function(){return!0}}),Object.defineProperty(Hr.prototype,"extTextureFloat",{get:function(){return!0}}),Object.defineProperty(Hr.prototype,"extStandardDerivatives",{get:function(){return!0}}),Sr.DEFAULT=Object.freeze(new Sr);var dx=new Sr,ux=new Cr;function fx(e,t,i){Object.defineProperty(e.prototype,t,{set:function(e){},get:function(){}})}function px(e,t){Object.defineProperty(sp.prototype,t,{get:function(){return this[e]},set:function(t){this[e]=t}})}function mx(e){Object.defineProperty(sp.prototype,e,{get:function(){return!0},set:function(e){}})}function gx(e,t){"pass"!==e&&Object.defineProperty(zf.prototype,e,{get:function(){return this.litOptions[t||e]},set:function(i){this.litOptions[t||e]=i}})}Hr.prototype.setBlendFunction=function(e,t){var i=this.blendState;dx.copy(i),dx.setColorBlend(i.colorOp,e,t),dx.setAlphaBlend(i.alphaOp,e,t),this.setBlendState(dx)},Hr.prototype.setBlendFunctionSeparate=function(e,t,i,s){var r=this.blendState;dx.copy(r),dx.setColorBlend(r.colorOp,e,t),dx.setAlphaBlend(r.alphaOp,i,s),this.setBlendState(dx)},Hr.prototype.setBlendEquation=function(e){var t=this.blendState;dx.copy(t),dx.setColorBlend(e,t.colorSrcFactor,t.colorDstFactor),dx.setAlphaBlend(e,t.alphaSrcFactor,t.alphaDstFactor),this.setBlendState(dx)},Hr.prototype.setBlendEquationSeparate=function(e,t){var i=this.blendState;dx.copy(i),dx.setColorBlend(e,i.colorSrcFactor,i.colorDstFactor),dx.setAlphaBlend(t,i.alphaSrcFactor,i.alphaDstFactor),this.setBlendState(dx)},Hr.prototype.setColorWrite=function(e,t,i,s){var r=this.blendState;dx.copy(r),dx.setColorWrite(e,t,i,s),this.setBlendState(dx)},Hr.prototype.getBlending=function(){return this.blendState.blend},Hr.prototype.setBlending=function(e){dx.copy(this.blendState),dx.blend=e,this.setBlendState(dx)},Hr.prototype.setDepthWrite=function(e){ux.copy(this.depthState),ux.write=e,this.setDepthState(ux)},Hr.prototype.setDepthFunc=function(e){ux.copy(this.depthState),ux.func=e,this.setDepthState(ux)},Hr.prototype.setDepthTest=function(e){ux.copy(this.depthState),ux.test=e,this.setDepthState(ux)},Hr.prototype.getCullMode=function(){return this.cullMode},Object.defineProperty(Mf.prototype,"defaultMaterial",{get:function(){return jh(Kp().graphicsDevice)}}),Object.defineProperty(Mf.prototype,"fogColor",{set:function(e){this.fog.color=e},get:function(){return this.fog.color}}),Object.defineProperty(Mf.prototype,"fogEnd",{set:function(e){this.fog.end=e},get:function(){return this.fog.end}}),Object.defineProperty(Mf.prototype,"fogStart",{set:function(e){this.fog.start=e},get:function(){return this.fog.start}}),Object.defineProperty(Mf.prototype,"fogDensity",{set:function(e){this.fog.density=e},get:function(){return this.fog.density}}),Object.defineProperty(Mf.prototype,"toneMapping",{set:function(e){},get:function(){}}),Object.defineProperty(Mf.prototype,"gammaCorrection",{set:function(e){},get:function(){}}),Object.defineProperty(Mf.prototype,"rendering",{set:function(e){},get:function(){}}),Object.defineProperty(wu.prototype,"_meshInstances",{get:function(){return null}}),Object.defineProperty(Mf.prototype,"drawCalls",{get:function(){return null}}),["128","64","32","16","8","4"].forEach(((e,t)=>{Object.defineProperty(Mf.prototype,"skyboxPrefiltered"+e,{get:function(){return this._prefilteredCubemaps[t]},set:function(e){this._prefilteredCubemaps[t]=e,this.updateShaders=!0}})})),Object.defineProperty(Mf.prototype,"models",{get:function(){return this._models||(this._models=[]),this._models}}),fx(yu,"renderTarget"),fx(yu,"onPreCull"),fx(yu,"onPreRender"),fx(yu,"onPreRenderOpaque"),fx(yu,"onPreRenderTransparent"),fx(yu,"onPostCull"),fx(yu,"onPostRender"),fx(yu,"onPostRenderOpaque"),fx(yu,"onPostRenderTransparent"),fx(yu,"onDrawCall"),fx(yu,"layerReference"),fx(Tv,"onPreCull"),fx(Tv,"onPostCull"),fx(Tv,"onPreRender"),fx(Tv,"onPostRender"),fx(Tv,"onPreRenderLayer"),fx(Tv,"onPostRenderLayer"),pu.prototype.renderComposition=function(e){Kp().renderComposition(e)},tc.prototype.syncAabb=function(){},Nu.prototype.getTarget=function(e){return this.targets[e]},Lc.prototype.getChildren=function(){return this.children},Lc.prototype.getName=function(){return this.name},Lc.prototype.getPath=function(){return this.path},Lc.prototype.getRoot=function(){return this.root},Lc.prototype.getParent=function(){return this.parent},Lc.prototype.setName=function(e){this.name=e},Object.defineProperty(fd.prototype,"shader",{set:function(e){},get:function(){return null}}),Object.defineProperty(fd.prototype,"blend",{set:function(e){this.blendState.blend=e},get:function(){return this.blendState.blend}}),Object.defineProperty(sp.prototype,"shininess",{get:function(){return 100*this.gloss},set:function(e){this.gloss=.01*e}}),Object.defineProperty(sp.prototype,"useGammaTonemap",{get:function(){return this.useTonemap},set:function(e){this.useTonemap=e}}),mx("sheenTint"),mx("diffuseTint"),mx("emissiveTint"),mx("ambientTint"),px("specularTint","specularMapTint"),px("aoVertexColor","aoMapVertexColor"),px("diffuseVertexColor","diffuseMapVertexColor"),px("specularVertexColor","specularMapVertexColor"),px("emissiveVertexColor","emissiveMapVertexColor"),px("metalnessVertexColor","metalnessMapVertexColor"),px("glossVertexColor","glossMapVertexColor"),px("opacityVertexColor","opacityMapVertexColor"),px("lightVertexColor","lightMapVertexColor"),px("sheenGloss","sheenGlossiess"),px("clearCoatGloss","clearCostGlossiness"),gx("refraction","useRefraction");var vx=new Rf,_x=Object.getOwnPropertyNames(vx);for(var bx in _x)gx(_x[bx]);mm.prototype.getAssetById=function(e){return this.get(e)},Object.defineProperty(Hy.prototype,"ray",{get:function(){return this._rayLocal}}),Object.defineProperty(Hy.prototype,"position",{get:function(){return this._localPosition}}),Object.defineProperty(Hy.prototype,"rotation",{get:function(){return this._localRotation}});Object.defineProperty(Qo.prototype,"wheel",{get:function(){return-2*this.wheelDelta}}),Om.prototype.isFullscreen=function(){return!!document.fullscreenElement},Om.prototype.enableFullscreen=function(e,t,i){e=e||this.graphicsDevice.canvas;var s=function(){t(),document.removeEventListener("fullscreenchange",s)},r=function(){i(),document.removeEventListener("fullscreenerror",r)};t&&document.addEventListener("fullscreenchange",s,!1),i&&document.addEventListener("fullscreenerror",r,!1),e.requestFullscreen?e.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT):i()},Om.prototype.disableFullscreen=function(e){var t=function(){e(),document.removeEventListener("fullscreenchange",t)};e&&document.addEventListener("fullscreenchange",t,!1),document.exitFullscreen()},Om.prototype.getSceneUrl=function(e){var t=this.scenes.find(e);return t?t.url:null},Om.prototype.loadScene=function(e,t){this.scenes.loadScene(e,t)},Om.prototype.loadSceneHierarchy=function(e,t){this.scenes.loadSceneHierarchy(e,t)},Om.prototype.loadSceneSettings=function(e,t){this.scenes.loadSceneSettings(e,t)},class extends Qm{set meshInstances(e){this._model&&(this._model.meshInstances=e)}get meshInstances(){return this._model?this._model.meshInstances:null}set customAabb(e){if(this._customAabb=e,this._model){var t=this._model.meshInstances;if(t)for(var i=0;i<t.length;i++)t[i].setCustomAabb(this._customAabb)}}get customAabb(){return this._customAabb}set type(e){if(this._type!==e)if(this._area=null,this._type=e,"asset"===e)null!==this._asset?this._bindModelAsset(this._asset):this.model=null;else{var t=Yg(this.system.app.graphicsDevice,e);this._area=t.area;var i=t.mesh,s=new Lc,r=new Bu;r.graph=s,r.meshInstances=[new tc(i,this._material,s)],this.model=r,this._asset=null}}get type(){return this._type}set asset(e){var t=this.system.app.assets,i=e;if(e instanceof fm&&(i=e.id),this._asset!==i){if(this._asset){t.off("add:"+this._asset,this._onModelAssetAdded,this);var s=t.get(this._asset);s&&this._unbindModelAsset(s)}if(this._asset=i,this._asset){var r=t.get(this._asset);r?this._bindModelAsset(r):(this.model=null,t.on("add:"+this._asset,this._onModelAssetAdded,this))}else this.model=null}}get asset(){return this._asset}set model(e){if(this._model!==e&&(!e||!e._immutable)&&(this._model&&(this._model._immutable=!1,this.removeModelFromLayers(),this._model.getGraph().destroy(),delete this._model._entity,this._clonedModel&&(this._model.destroy(),this._clonedModel=!1)),this._model=e,this._model)){this._model._immutable=!0;for(var t=this._model.meshInstances,i=0;i<t.length;i++)t[i].castShadow=this._castShadows,t[i].receiveShadow=this._receiveShadows,t[i].setCustomAabb(this._customAabb);this.lightmapped=this._lightmapped,this.entity.addChild(this._model.graph),this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._model._entity=this.entity,this.entity.animation&&this.entity.animation.setModel(this._model),this.entity.anim&&this.entity.anim.rebind(),"asset"===this.type?this.mapping=this._mapping:this._unsetMaterialEvents()}}get model(){return this._model}set lightmapped(e){if(e!==this._lightmapped&&(this._lightmapped=e,this._model))for(var t=this._model.meshInstances,i=0;i<t.length;i++)t[i].setLightmapped(e)}get lightmapped(){return this._lightmapped}set castShadows(e){if(this._castShadows!==e){var t=this._model;if(t){var i=this.layers,s=this.system.app.scene;if(this._castShadows&&!e)for(var r=0;r<i.length;r++){var n=this.system.app.scene.layers.getLayerById(this.layers[r]);n&&n.removeShadowCasters(t.meshInstances)}for(var a=t.meshInstances,o=0;o<a.length;o++)a[o].castShadow=e;if(!this._castShadows&&e)for(var l=0;l<i.length;l++){var h=s.layers.getLayerById(i[l]);h&&h.addShadowCasters(t.meshInstances)}}this._castShadows=e}}get castShadows(){return this._castShadows}set receiveShadows(e){if(this._receiveShadows!==e&&(this._receiveShadows=e,this._model))for(var t=this._model.meshInstances,i=0,s=t.length;i<s;i++)t[i].receiveShadow=e}get receiveShadows(){return this._receiveShadows}set castShadowsLightmap(e){this._castShadowsLightmap=e}get castShadowsLightmap(){return this._castShadowsLightmap}set lightmapSizeMultiplier(e){this._lightmapSizeMultiplier=e}get lightmapSizeMultiplier(){return this._lightmapSizeMultiplier}set layers(e){var t=this.system.app.scene.layers;if(this.meshInstances)for(var i=0;i<this._layers.length;i++){var s=t.getLayerById(this._layers[i]);s&&s.removeMeshInstances(this.meshInstances)}this._layers.length=0;for(var r=0;r<e.length;r++)this._layers[r]=e[r];if(this.enabled&&this.entity.enabled&&this.meshInstances)for(var n=0;n<this._layers.length;n++){var a=t.getLayerById(this._layers[n]);a&&a.addMeshInstances(this.meshInstances)}}get layers(){return this._layers}set batchGroupId(e){if(this._batchGroupId!==e){var t,i;if(this.entity.enabled&&this._batchGroupId>=0)null==(t=this.system.app.batcher)||t.remove(Bh.MODEL,this.batchGroupId,this.entity);if(this.entity.enabled&&e>=0)null==(i=this.system.app.batcher)||i.insert(Bh.MODEL,e,this.entity);e<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._batchGroupId=e}}get batchGroupId(){return this._batchGroupId}set materialAsset(e){var t=e;e instanceof fm&&(t=e.id);var i=this.system.app.assets;if(t!==this._materialAsset){if(this._materialAsset){i.off("add:"+this._materialAsset,this._onMaterialAssetAdd,this);var s=i.get(this._materialAsset);s&&this._unbindMaterialAsset(s)}if(this._materialAsset=t,this._materialAsset){var r=i.get(this._materialAsset);r?this._bindMaterialAsset(r):(this._setMaterial(this.system.defaultMaterial),i.on("add:"+this._materialAsset,this._onMaterialAssetAdd,this))}else this._setMaterial(this.system.defaultMaterial)}}get materialAsset(){return this._materialAsset}set material(e){this._material!==e&&(this.materialAsset=null,this._setMaterial(e))}get material(){return this._material}set mapping(e){if("asset"===this._type&&(this._unsetMaterialEvents(),e||(e={}),this._mapping=e,this._model))for(var t=this._model.meshInstances,i=this.asset?this.system.app.assets.get(this.asset):null,s=i?i.data.mapping:null,r=null,n=0,a=t.length;n<a;n++)if(void 0!==e[n])e[n]?(r=this.system.app.assets.get(e[n]),this._loadAndSetMeshInstanceMaterial(r,t[n],n)):t[n].material=this.system.defaultMaterial;else if(s)if(s[n]&&(s[n].material||s[n].path)){if(void 0!==s[n].material)r=this.system.app.assets.get(s[n].material);else if(void 0!==s[n].path){var o=this._getMaterialAssetUrl(s[n].path);o&&(r=this.system.app.assets.getByUrl(o))}this._loadAndSetMeshInstanceMaterial(r,t[n],n)}else t[n].material=this.system.defaultMaterial}get mapping(){return this._mapping}addModelToLayers(){for(var e=this.system.app.scene.layers,t=0;t<this._layers.length;t++){var i=e.getLayerById(this._layers[t]);i&&i.addMeshInstances(this.meshInstances)}}removeModelFromLayers(){for(var e=this.system.app.scene.layers,t=0;t<this._layers.length;t++){var i=e.getLayerById(this._layers[t]);i&&i.removeMeshInstances(this.meshInstances)}}onRemoveChild(){this._model&&this.removeModelFromLayers()}onInsertChild(){this._model&&this.enabled&&this.entity.enabled&&this.addModelToLayers()}onRemove(){this.asset=null,this.model=null,this.materialAsset=null,this._unsetMaterialEvents(),this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(e,t){this.addModelToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||e.addMeshInstances(this.meshInstances)}onLayerRemoved(e){this.layers.indexOf(e.id)<0||e.removeMeshInstances(this.meshInstances)}_setMaterialEvent(e,t,i,s){var r=t+":"+i;this.system.app.assets.on(r,s,this),this._materialEvents||(this._materialEvents=[]),this._materialEvents[e]||(this._materialEvents[e]={}),this._materialEvents[e][r]={id:i,handler:s}}_unsetMaterialEvents(){var e=this.system.app.assets,t=this._materialEvents;if(t){for(var i=0,s=t.length;i<s;i++)if(t[i]){var r=t[i];for(var n in r)e.off(n,r[n].handler,this)}this._materialEvents=null}}_getAssetByIdOrPath(e){var t=null;if(isNaN(parseInt(e,10))){if(this.asset){var i=this._getMaterialAssetUrl(e);i&&(t=this.system.app.assets.getByUrl(i))}}else t=this.system.app.assets.get(e);return t}_getMaterialAssetUrl(e){if(!this.asset)return null;var t=this.system.app.assets.get(this.asset);return t?t.getAbsoluteUrl(e):null}_loadAndSetMeshInstanceMaterial(e,t,i){var s=this.system.app.assets;e&&(e.resource?(t.material=e.resource,this._setMaterialEvent(i,"remove",e.id,(function(){t.material=this.system.defaultMaterial}))):(this._setMaterialEvent(i,"load",e.id,(function(s){t.material=s.resource,this._setMaterialEvent(i,"remove",e.id,(function(){t.material=this.system.defaultMaterial}))})),this.enabled&&this.entity.enabled&&s.load(e)))}onEnable(){var e=this.system.app,t=e.scene,i=null==t?void 0:t.layers;this._evtLayersChanged=t.on("set:layers",this.onLayersChanged,this),i&&(this._evtLayerAdded=i.on("add",this.onLayerAdded,this),this._evtLayerRemoved=i.on("remove",this.onLayerRemoved,this));var s,r,n="asset"===this._type;if(this._model?this.addModelToLayers():n&&this._asset&&(s=e.assets.get(this._asset))&&s.resource!==this._model&&this._bindModelAsset(s),this._materialAsset&&(s=e.assets.get(this._materialAsset))&&s.resource!==this._material&&this._bindMaterialAsset(s),n&&this._mapping)for(var a in this._mapping)this._mapping[a]&&(s=this._getAssetByIdOrPath(this._mapping[a]))&&!s.resource&&e.assets.load(s);this._batchGroupId>=0&&(null==(r=e.batcher)||r.insert(Bh.MODEL,this.batchGroupId,this.entity))}onDisable(){var e,t,i,s,r=this.system.app,n=r.scene.layers;(null==(e=this._evtLayersChanged)||e.off(),this._evtLayersChanged=null,n)&&(null==(t=this._evtLayerAdded)||t.off(),this._evtLayerAdded=null,null==(i=this._evtLayerRemoved)||i.off(),this._evtLayerRemoved=null);this._batchGroupId>=0&&(null==(s=r.batcher)||s.remove(Bh.MODEL,this.batchGroupId,this.entity));this._model&&this.removeModelFromLayers()}hide(){if(this._model)for(var e=this._model.meshInstances,t=0,i=e.length;t<i;t++)e[t].visible=!1}show(){if(this._model)for(var e=this._model.meshInstances,t=0,i=e.length;t<i;t++)e[t].visible=!0}_bindMaterialAsset(e){if(e.on("load",this._onMaterialAssetLoad,this),e.on("unload",this._onMaterialAssetUnload,this),e.on("remove",this._onMaterialAssetRemove,this),e.on("change",this._onMaterialAssetChange,this),e.resource)this._onMaterialAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}}_unbindMaterialAsset(e){e.off("load",this._onMaterialAssetLoad,this),e.off("unload",this._onMaterialAssetUnload,this),e.off("remove",this._onMaterialAssetRemove,this),e.off("change",this._onMaterialAssetChange,this)}_onMaterialAssetAdd(e){this.system.app.assets.off("add:"+e.id,this._onMaterialAssetAdd,this),this._materialAsset===e.id&&this._bindMaterialAsset(e)}_onMaterialAssetLoad(e){this._setMaterial(e.resource)}_onMaterialAssetUnload(e){this._setMaterial(this.system.defaultMaterial)}_onMaterialAssetRemove(e){this._onMaterialAssetUnload(e)}_onMaterialAssetChange(e){}_bindModelAsset(e){if(this._unbindModelAsset(e),e.on("load",this._onModelAssetLoad,this),e.on("unload",this._onModelAssetUnload,this),e.on("change",this._onModelAssetChange,this),e.on("remove",this._onModelAssetRemove,this),e.resource)this._onModelAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}}_unbindModelAsset(e){e.off("load",this._onModelAssetLoad,this),e.off("unload",this._onModelAssetUnload,this),e.off("change",this._onModelAssetChange,this),e.off("remove",this._onModelAssetRemove,this)}_onModelAssetAdded(e){this.system.app.assets.off("add:"+e.id,this._onModelAssetAdded,this),e.id===this._asset&&this._bindModelAsset(e)}_onModelAssetLoad(e){this.model=e.resource.clone(),this._clonedModel=!0}_onModelAssetUnload(e){this.model=null}_onModelAssetChange(e,t,i,s){"data"===t&&(this.mapping=this._mapping)}_onModelAssetRemove(e){this.model=null}_setMaterial(e){if(this._material!==e){this._material=e;var t=this._model;if(t&&"asset"!==this._type)for(var i=t.meshInstances,s=0,r=i.length;s<r;s++)i[s].material=e}}constructor(e,t){super(e,t),this._type="asset",this._asset=null,this._model=null,this._mapping={},this._castShadows=!0,this._receiveShadows=!0,this._materialAsset=null,this._castShadowsLightmap=!0,this._lightmapped=!1,this._lightmapSizeMultiplier=1,this.isStatic=!1,this._layers=[0],this._batchGroupId=-1,this._customAabb=null,this._area=null,this._materialEvents=null,this._clonedModel=!1,this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._material=e.defaultMaterial,t.on("remove",this.onRemoveChild,this),t.on("removehierarchy",this.onRemoveChild,this),t.on("insert",this.onInsertChild,this),t.on("inserthierarchy",this.onInsertChild,this)}}.prototype.setVisible=function(e){this.enabled=e},Object.defineProperty(pv.prototype,"bodyType",{get:function(){return this.type},set:function(e){this.type=e}}),pv.prototype.syncBodyToEntity=function(){this._updateDynamic()},xv.prototype.setGravity=function(){1===arguments.length?this.gravity.copy(arguments[0]):this.gravity.set(arguments[0],arguments[1],arguments[2])};class yx{begin(e){if(this.enabled){this._frameIndex<this._frameTimings.length&&this._frameTimings.splice(this._frameIndex);var t=this._prevTimings;this._prevTimings=this._timings,this._timings=this._frameTimings,this._frameTimings=t,this._frameIndex=0,this.mark(e)}}mark(e){if(this.enabled){var t=Jt();if(this._frameIndex>0){var i=this._frameTimings[this._frameIndex-1];i[1]=t-i[1]}else if(this._timings.length>0){var s=this._timings[this._timings.length-1];s[1]=t-s[1]}if(this._frameIndex>=this._frameTimings.length)this._frameTimings.push([e,t]);else{var r=this._frameTimings[this._frameIndex];r[0]=e,r[1]=t}this._frameIndex++}}get timings(){return this._timings.slice(0,-1).map((e=>e[1]))}constructor(e){this._frameIndex=0,this._frameTimings=[],this._timings=[],this._prevTimings=[],this.unitsName="ms",this.decimalPlaces=1,this.enabled=!0,e.on("frameupdate",this.begin.bind(this,"update")),e.on("framerender",this.mark.bind(this,"render")),e.on("frameend",this.mark.bind(this,"other"))}}class xx{get timings(){return this._timings[0]=this.device.gpuProfiler._frameTime,this._timings}constructor(e){this.device=e,e.gpuProfiler.enabled=!0,this.enabled=!0,this.unitsName="ms",this.decimalPlaces=1,this._timings=[]}}class Sx{get timings(){return this.values}constructor(e,t,i,s,r){this.app=e,this.values=[],this.statNames=t,this.statNames.length>3&&(this.statNames.length=3),this.unitsName=s,this.decimalPlaces=i,this.multiplier=r||1;var n=(e,t)=>e.split(".").reduce(((e,t)=>e?e[t]:null),t||this);e.on("frameupdate",(e=>{for(var t=0;t<this.statNames.length;t++)this.values[t]=n(this.statNames[t],this.app.stats)*this.multiplier}))}}class wx{destroy(){this.app.off("frameupdate",this.update,this)}loseContext(){this.timer&&"function"==typeof this.timer.loseContext&&this.timer.loseContext()}update(e){var t=this.timer.timings,i=t.reduce(((e,t)=>e+t),0);if(this.avgTotal+=i,this.avgTimer+=e,this.avgCount++,this.avgTimer>this.textRefreshRate&&(this.timingText=(this.avgTotal/this.avgCount).toFixed(this.timer.decimalPlaces),this.avgTimer=0,this.avgTotal=0,this.avgCount=0),this.enabled){for(var s=0,r=1.5*this.watermark,n=0;n<t.length;++n)s+=Math.floor(t[n]/r*255),this.sample[n]=s;this.sample[3]=this.watermark/r*255,this.texture.lock().set(this.sample,4*(this.cursor+this.yOffset*this.texture.width)),this.texture.unlock(),this.cursor++,this.cursor===this.texture.width&&(this.cursor=0)}}render(e,t,i,s,r){e.quad(t+s,i,-s,r,this.enabled?this.cursor:0,this.enabled?.5+this.yOffset:this.texture.height-1,-s,0,this.texture,0)}constructor(e,t,i,s,r){this.app=t,this.name=e,this.device=t.graphicsDevice,this.timer=r,this.watermark=i,this.enabled=!1,this.textRefreshRate=s,this.avgTotal=0,this.avgTimer=0,this.avgCount=0,this.timingText="",this.texture=null,this.yOffset=0,this.cursor=0,this.sample=new Uint8ClampedArray(4),this.sample.set([0,0,0,255]),this.counter=0,this.app.on("frameupdate",this.update,this)}}class Tx{destroy(){this.texture.destroy(),this.texture=null}render(e,t,i,s){var r=this.placements.get(t);if(r){return e.quad(i+r.l-1,s-r.d+1,r.w+2,r.h+2,r.x-1,this.texture.height-r.y-r.h-1,void 0,void 0,this.texture,1),r.w}return 0}constructor(e,t){var i=e=>{e.font='10px "Lucida Console", Monaco, monospace',e.textAlign="left",e.textBaseline="alphabetic"},s=document.createElement("canvas"),r=s.getContext("2d",{alpha:!0});i(r);var n=new Map,a=5,o=5;t.forEach((e=>{var t=r.measureText(e),i=Math.ceil(-t.actualBoundingBoxLeft),s=Math.ceil(t.actualBoundingBoxRight),l=Math.ceil(t.actualBoundingBoxAscent),h=Math.ceil(t.actualBoundingBoxDescent),c=i+s,d=l+h;a+c+5>=512&&(a=5,o+=16),n.set(e,{l:i,r:s,a:l,d:h,w:c,h:d,x:a,y:o}),a+=c+5})),s.width=512,s.height=ti.nextPowerOfTwo(o+16+5),i(r),r.fillStyle="rgb(0, 0, 0)",r.fillRect(0,0,s.width,s.height),n.forEach(((e,t)=>{r.fillStyle=(e=>"."===e||1===e.length&&e.charCodeAt(0)>=48&&e.charCodeAt(0)<=57)(t)?"rgb(255, 255, 255)":"rgb(170, 170, 170)",r.fillText(t,e.x-e.l,e.y+e.a)})),this.placements=n;for(var l=r.getImageData(0,0,s.width,s.height).data,h=0;h<l.length;h+=4)l[h+3]=l[h+0],l[h+0]=255,l[h+1]=255,l[h+2]=255;this.texture=new ur(e,{name:"mini-stats-word-atlas",width:s.width,height:s.height,mipmaps:!1,minFilter:0,magFilter:0,levels:[l]})}}class Cx{quad(e,t,i,s,r,n,a,o,l,h){void 0===h&&(h=0);var c=this.targetSize.width,d=this.targetSize.height,u=e/c,f=t/d,p=(e+i)/c,m=(t+s)/d,g=l.width,v=l.height,_=r/g,b=n/v,y=(r+(null!=a?a:i))/g,x=(n+(null!=o?o:s))/v;this.data.set([u,f,h,_,b,0,0,p,f,h,y,b,1,0,p,m,h,y,x,1,1,u,m,h,_,x,0,1],28*this.quads),this.quads++,this.prim.count+=6}startFrame(){this.quads=0,this.prim.count=0,this.targetSize.width=this.device.canvas.scrollWidth,this.targetSize.height=this.device.canvas.scrollHeight}render(e,t,i,s,r,n){this.buffer.setData(this.data.buffer),this.uniforms.clr.set(r,0),this.material.setParameter("clr",this.uniforms.clr),this.material.setParameter("graphTex",i),this.material.setParameter("wordsTex",s),e.drawMeshInstance(this.meshInstance,t)}constructor(e,t=512){for(var i=new Nr(e,[{semantic:Ji,components:3,type:6},{semantic:rs,components:4,type:6}]),s=new Uint16Array(6*t),r=0;r<t;++r)s[6*r+0]=4*r,s[6*r+1]=4*r+1,s[6*r+2]=4*r+2,s[6*r+3]=4*r,s[6*r+4]=4*r+2,s[6*r+5]=4*r+3;this.device=e,this.buffer=new Ir(e,i,4*t,{usage:2}),this.data=new Float32Array(this.buffer.numBytes/4),this.indexBuffer=new Eo(e,1,6*t,0,s),this.prim={type:4,indexed:!0,base:0,count:0},this.quads=0,this.mesh=new Gh(e),this.mesh.vertexBuffer=this.buffer,this.mesh.indexBuffer[0]=this.indexBuffer,this.mesh.primitive=[this.prim];var n=new Hu({uniqueName:"MiniStats",vertexGLSL:"\n\tattribute vec3 vertex_position;\n\tattribute vec4 vertex_texCoord0;\n\tvarying vec4 uv0;\n\tvarying float wordFlag;\n\tvoid main(void) {\n\t\tgl_Position = vec4(vertex_position.xy * 2.0 - 1.0, 0.5, 1.0);\n\t\tuv0 = vertex_texCoord0;\n\t\twordFlag = vertex_position.z;\n\t}\n",fragmentGLSL:"\n\tvarying vec4 uv0;\n\tvarying float wordFlag;\n\tuniform vec4 clr;\n\tuniform sampler2D graphTex;\n\tuniform sampler2D wordsTex;\n\tvoid main (void) {\n\t\tvec4 graphSample = texture2D(graphTex, uv0.xy);\n\t\tvec4 graph;\n\t\tif (uv0.w < graphSample.r)\n\t\t\tgraph = vec4(0.7, 0.2, 0.2, 1.0);\n\t\telse if (uv0.w < graphSample.g)\n\t\t\tgraph = vec4(0.2, 0.7, 0.2, 1.0);\n\t\telse if (uv0.w < graphSample.b)\n\t\t\tgraph = vec4(0.2, 0.2, 0.7, 1.0);\n\t\telse\n\t\t\tgraph = vec4(0.0, 0.0, 0.0, 1.0 - 0.25 * sin(uv0.w * 3.14159));\n\t\tvec4 words = texture2D(wordsTex, vec2(uv0.x, 1.0 - uv0.y));\n\t\tgl_FragColor = mix(graph, words, wordFlag) * clr;\n\t}\n",vertexWGSL:"\n    attribute vertex_position: vec3f;         // unnormalized xy, word flag\n    attribute vertex_texCoord0: vec4f;        // unnormalized texture space uv, normalized uv\n\n    varying uv0: vec4f;\n    varying wordFlag: f32;\n\n    @vertex fn vertexMain(input : VertexInput) -> VertexOutput {\n        var output : VertexOutput;\n        output.position = vec4(input.vertex_position.xy * 2.0 - 1.0, 0.5, 1.0);\n        output.uv0 = input.vertex_texCoord0;\n        output.wordFlag = input.vertex_position.z;\n        return output;\n    }\n",fragmentWGSL:"\n    varying uv0: vec4f;\n    varying wordFlag: f32;\n\n    uniform clr: vec4f;\n\n    var graphTex : texture_2d<f32>;\n    var graphTex_sampler : sampler;\n\n    var wordsTex : texture_2d<f32>;\n    var wordsTex_sampler : sampler;\n\n    @fragment fn fragmentMain(input : FragmentInput) -> FragmentOutput {\n        var uv0: vec4f = input.uv0;\n        var graphSample: vec4f = textureSample(graphTex, graphTex_sampler, uv0.xy);\n\n        var graph: vec4f;\n        if (uv0.w < graphSample.r) {\n            graph = vec4f(0.7, 0.2, 0.2, 1.0);\n        } else if (uv0.w < graphSample.g) {\n            graph = vec4f(0.2, 0.7, 0.2, 1.0);\n        } else if (uv0.w < graphSample.b) {\n            graph = vec4f(0.2, 0.2, 0.7, 1.0);\n        } else {\n            graph = vec4f(0.0, 0.0, 0.0, 1.0 - 0.25 * sin(uv0.w * 3.14159));\n        }\n\n        var words: vec4f = textureSample(wordsTex, wordsTex_sampler, vec2f(uv0.x, 1.0 - uv0.y));\n\n        var output: FragmentOutput;\n        output.color = mix(graph, words, input.wordFlag) * uniform.clr;\n        return output;\n    }\n",attributes:{vertex_position:Ji,vertex_texCoord0:rs}});this.material=n,n.cull=0,n.depthState=Cr.NODEPTH,n.blendState=new Sr(!0,0,6,8,0,1,1),n.update(),this.meshInstance=new tc(this.mesh,n,new Lc("MiniStatsMesh")),this.uniforms={clr:new Float32Array(4)},this.targetSize={width:e.width,height:e.height}}}class Ex{destroy(){this.device.off("resizecanvas",this.updateDiv,this),this.device.off("losecontext",this.loseContext,this),this.app.off("postrender",this.postRender,this),this.graphs.forEach((e=>e.destroy())),this.wordAtlas.destroy(),this.texture.destroy()}static getDefaultOptions(){return{sizes:[{width:100,height:16,spacing:0,graphs:!1},{width:128,height:32,spacing:2,graphs:!0},{width:256,height:64,spacing:2,graphs:!0}],startSizeIndex:0,textRefreshRate:500,cpu:{enabled:!0,watermark:33},gpu:{enabled:!0,watermark:33},stats:[{name:"Frame",stats:["frame.ms"],decimalPlaces:1,unitsName:"ms",watermark:33},{name:"DrawCalls",stats:["drawCalls.total"],watermark:1e3}]}}set activeSizeIndex(e){this._activeSizeIndex=e,this.gspacing=this.sizes[e].spacing,this.resize(this.sizes[e].width,this.sizes[e].height,this.sizes[e].graphs)}get activeSizeIndex(){return this._activeSizeIndex}set opacity(e){this.clr[3]=e}get opacity(){return this.clr[3]}get overallHeight(){var e=this.graphs,t=this.gspacing;return this.height*e.length+t*(e.length-1)}set enabled(e){if(e!==this._enabled){this._enabled=e;for(var t=0;t<this.graphs.length;++t)this.graphs[t].enabled=e,this.graphs[t].timer.enabled=e}}get enabled(){return this._enabled}initGraphs(e,t,i){if(this.graphs=[],i.cpu.enabled){var s=new yx(e),r=new wx("CPU",e,i.cpu.watermark,i.textRefreshRate,s);this.graphs.push(r)}if(i.gpu.enabled){var n=new xx(t),a=new wx("GPU",e,i.gpu.watermark,i.textRefreshRate,n);this.graphs.push(a)}i.stats&&i.stats.forEach((t=>{var s=new Sx(e,t.stats,t.decimalPlaces,t.unitsName,t.multiplier),r=new wx(t.name,e,t.watermark,i.textRefreshRate,s);this.graphs.push(r)}));var o=i.sizes.reduce(((e,t)=>t.width>e?t.width:e),0);this.texture=new ur(t,{name:"mini-stats-graph-texture",width:ti.nextPowerOfTwo(o),height:ti.nextPowerOfTwo(this.graphs.length),mipmaps:!1,minFilter:0,magFilter:0,addressU:0,addressV:0}),this.graphs.forEach(((e,t)=>{e.texture=this.texture,e.yOffset=t}))}render(){var e=this.graphs,t=this.wordAtlas,i=this.render2d,s=this.width,r=this.height,n=this.gspacing;i.startFrame();for(var a=0;a<e.length;++a){var o=e[a],l=a*(r+n);o.render(i,0,l,s,r);var h=1;l+=r-13,h+=t.render(i,o.name,h,l)+10;for(var c=o.timingText,d=0;d<c.length;++d)h+=t.render(i,c[d],h,l);o.timer.unitsName&&(h+=3,t.render(i,o.timer.unitsName,h,l))}i.render(this.app,this.drawLayer,this.texture,this.wordAtlas.texture,this.clr,r)}resize(e,t,i){for(var s=this.graphs,r=0;r<s.length;++r)s[r].enabled=i;this.width=e,this.height=t,this.updateDiv()}updateDiv(){var e=this.device.canvas.getBoundingClientRect();this.div.style.left=e.left+"px",this.div.style.bottom=window.innerHeight-e.bottom+"px",this.div.style.width=this.width+"px",this.div.style.height=this.overallHeight+"px"}loseContext(){this.graphs.forEach((e=>e.loseContext()))}postRender(){this._enabled&&this.render()}constructor(e,t){var i=e.graphicsDevice;t=t||Ex.getDefaultOptions(),this.initGraphs(e,i,t);var s=new Set(["","ms","0","1","2","3","4","5","6","7","8","9","."].concat(this.graphs.map((e=>e.name))).concat(t.stats?t.stats.map((e=>e.unitsName)):[]).filter((e=>!!e)));this.wordAtlas=new Tx(i,s),this.sizes=t.sizes,this._activeSizeIndex=t.startSizeIndex;var r=document.createElement("div");r.setAttribute("id","mini-stats"),r.style.cssText="position:fixed;bottom:0;left:0;background:transparent;",document.body.appendChild(r),r.addEventListener("mouseenter",(e=>{this.opacity=1})),r.addEventListener("mouseleave",(e=>{this.opacity=.7})),r.addEventListener("click",(e=>{e.preventDefault(),this._enabled&&(this.activeSizeIndex=(this.activeSizeIndex+1)%this.sizes.length,this.resize(this.sizes[this.activeSizeIndex].width,this.sizes[this.activeSizeIndex].height,this.sizes[this.activeSizeIndex].graphs))})),i.on("resizecanvas",this.updateDiv,this),i.on("losecontext",this.loseContext,this),e.on("postrender",this.postRender,this),this.app=e,this.drawLayer=e.scene.layers.getLayerById(4),this.device=i,this.render2d=new Cx(i),this.div=r,this.width=0,this.height=0,this.gspacing=2,this.clr=[1,1,1,.5],this._enabled=!0,this.activeSizeIndex=this._activeSizeIndex}}class Ax{textureToCanvas(e,t){void 0===t&&(t={});var i=e.getSource();if("undefined"!=typeof HTMLImageElement&&i instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&i instanceof HTMLCanvasElement||"undefined"!=typeof OffscreenCanvas&&i instanceof OffscreenCanvas||"undefined"!=typeof ImageBitmap&&i instanceof ImageBitmap){var{width:s,height:r}=this.calcTextureSize(i.width,i.height,t.maxTextureSize),n=document.createElement("canvas");n.width=s,n.height=r;var a=n.getContext("2d");if(null===a)return Promise.resolve(void 0);if(a.drawImage(i,0,0,n.width,n.height),t.color){for(var{r:o,g:l,b:h}=t.color,c=a.getImageData(0,0,s,r),d=c.data,u=0;u<d.length;u+=4)d[u+0]=d[u+0]*o,d[u+1]=d[u+1]*l,d[u+2]=d[u+2]*h;a.putImageData(c,0,0)}return Promise.resolve(n)}var f=e.device,{width:p,height:m}=this.calcTextureSize(e.width,e.height,t.maxTextureSize),g=qi(e.format)?7:e.format,v=new ur(f,{name:"ExtractedTexture",width:p,height:m,format:g,cubemap:!1,mipmaps:!1,minFilter:1,magFilter:1,addressU:1,addressV:1}),_=new Wr({colorBuffer:v,depth:!1}),b=Eh(f,"\n\tattribute vec2 vertex_position;\n\tvarying vec2 uv0;\n\tvoid main(void) {\n\t\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\t\tuv0 = vertex_position.xy * 0.5 + 0.5;\n\t}","\n\tvarying vec2 uv0;\n\tuniform sampler2D blitTexture;\n\tvoid main(void) {\n\t\tgl_FragColor = texture2D(blitTexture, uv0);\n\t}","ShaderCoreExporterBlit");return f.scope.resolve("blitTexture").setValue(e),f.setBlendState(Sr.NOBLEND),Fh(f,_,b),v.read(0,0,p,m,{renderTarget:_,immediate:!0}).then((e=>{v.destroy(),_.destroy();var t=new Uint8ClampedArray(p*m*4);t.set(e);var i=new ImageData(t,p,m),s=document.createElement("canvas");s.width=p,s.height=m;var r=s.getContext("2d");return r?(r.putImageData(i,0,0),Promise.resolve(s)):Promise.resolve(void 0)}))}calcTextureSize(e,t,i){if(i){var s=Math.min(i/Math.max(e,t),1);e=Math.round(e*s),t=Math.round(t*s)}return{width:e,height:t}}constructor(){}}var Px=Uint8Array,Dx=Uint16Array,Lx=Int32Array,Mx=new Px([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Ix=new Px([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Rx=new Px([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),kx=function(e,t){for(var i=new Dx(31),s=0;s<31;++s)i[s]=t+=1<<e[s-1];var r=new Lx(i[30]);for(s=1;s<30;++s)for(var n=i[s];n<i[s+1];++n)r[n]=n-i[s]<<5|s;return{b:i,r:r}},Ox=kx(Mx,2),Fx=Ox.b,Bx=Ox.r;Fx[28]=258,Bx[258]=28;for(var Nx=kx(Ix,0).r,zx=new Dx(32768),Ux=0;Ux<32768;++Ux){var Vx=(43690&Ux)>>1|(21845&Ux)<<1;Vx=(61680&(Vx=(52428&Vx)>>2|(13107&Vx)<<2))>>4|(3855&Vx)<<4,zx[Ux]=((65280&Vx)>>8|(255&Vx)<<8)>>1}var Hx=function(e,t,i){for(var s=e.length,r=0,n=new Dx(t);r<s;++r)e[r]&&++n[e[r]-1];var a,o=new Dx(t);for(r=1;r<t;++r)o[r]=o[r-1]+n[r-1]<<1;if(i){a=new Dx(1<<t);var l=15-t;for(r=0;r<s;++r)if(e[r])for(var h=r<<4|e[r],c=t-e[r],d=o[e[r]-1]++<<c,u=d|(1<<c)-1;d<=u;++d)a[zx[d]>>l]=h}else for(a=new Dx(s),r=0;r<s;++r)e[r]&&(a[r]=zx[o[e[r]-1]++]>>15-e[r]);return a},Gx=new Px(288);for(Ux=0;Ux<144;++Ux)Gx[Ux]=8;for(Ux=144;Ux<256;++Ux)Gx[Ux]=9;for(Ux=256;Ux<280;++Ux)Gx[Ux]=7;for(Ux=280;Ux<288;++Ux)Gx[Ux]=8;var Wx=new Px(32);for(Ux=0;Ux<32;++Ux)Wx[Ux]=5;var jx=Hx(Gx,9,0);Hx(Gx,9,1);var qx=Hx(Wx,5,0);Hx(Wx,5,1);var Xx=function(e){return(e+7)/8|0},Kx=function(e,t,i){return(null==i||i>e.length)&&(i=e.length),new Px(e.subarray(t,i))},Yx=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],Qx=function(e,t,i){var s=new Error(t||Yx[e]);if(s.code=e,Error.captureStackTrace&&Error.captureStackTrace(s,Qx),!i)throw s;return s},Jx=function(e,t,i){i<<=7&t;var s=t/8|0;e[s]|=i,e[s+1]|=i>>8},$x=function(e,t,i){i<<=7&t;var s=t/8|0;e[s]|=i,e[s+1]|=i>>8,e[s+2]|=i>>16},Zx=function(e,t){for(var i=[],s=0;s<e.length;++s)e[s]&&i.push({s:s,f:e[s]});var r=i.length,n=i.slice();if(!r)return{t:aS,l:0};if(1==r){var a=new Px(i[0].s+1);return a[i[0].s]=1,{t:a,l:1}}i.sort((function(e,t){return e.f-t.f})),i.push({s:-1,f:25001});var o=i[0],l=i[1],h=0,c=1,d=2;for(i[0]={s:-1,f:o.f+l.f,l:o,r:l};c!=r-1;)o=i[i[h].f<i[d].f?h++:d++],l=i[h!=c&&i[h].f<i[d].f?h++:d++],i[c++]={s:-1,f:o.f+l.f,l:o,r:l};var u=n[0].s;for(s=1;s<r;++s)n[s].s>u&&(u=n[s].s);var f=new Dx(u+1),p=eS(i[c-1],f,0);if(p>t){s=0;var m=0,g=p-t,v=1<<g;for(n.sort((function(e,t){return f[t.s]-f[e.s]||e.f-t.f}));s<r;++s){var _=n[s].s;if(!(f[_]>t))break;m+=v-(1<<p-f[_]),f[_]=t}for(m>>=g;m>0;){var b=n[s].s;f[b]<t?m-=1<<t-f[b]++-1:++s}for(;s>=0&&m;--s){var y=n[s].s;f[y]==t&&(--f[y],++m)}p=t}return{t:new Px(f),l:p}},eS=function(e,t,i){return-1==e.s?Math.max(eS(e.l,t,i+1),eS(e.r,t,i+1)):t[e.s]=i},tS=function(e){for(var t=e.length;t&&!e[--t];);for(var i=new Dx(++t),s=0,r=e[0],n=1,a=function(e){i[s++]=e},o=1;o<=t;++o)if(e[o]==r&&o!=t)++n;else{if(!r&&n>2){for(;n>138;n-=138)a(32754);n>2&&(a(n>10?n-11<<5|28690:n-3<<5|12305),n=0)}else if(n>3){for(a(r),--n;n>6;n-=6)a(8304);n>2&&(a(n-3<<5|8208),n=0)}for(;n--;)a(r);n=1,r=e[o]}return{c:i.subarray(0,s),n:t}},iS=function(e,t){for(var i=0,s=0;s<t.length;++s)i+=e[s]*t[s];return i},sS=function(e,t,i){var s=i.length,r=Xx(t+2);e[r]=255&s,e[r+1]=s>>8,e[r+2]=255^e[r],e[r+3]=255^e[r+1];for(var n=0;n<s;++n)e[r+n+4]=i[n];return 8*(r+4+s)},rS=function(e,t,i,s,r,n,a,o,l,h,c){Jx(t,c++,i),++r[256];for(var d=Zx(r,15),u=d.t,f=d.l,p=Zx(n,15),m=p.t,g=p.l,v=tS(u),_=v.c,b=v.n,y=tS(m),x=y.c,S=y.n,w=new Dx(19),T=0;T<_.length;++T)++w[31&_[T]];for(T=0;T<x.length;++T)++w[31&x[T]];for(var C=Zx(w,7),E=C.t,A=C.l,P=19;P>4&&!E[Rx[P-1]];--P);var D,L,M,I,R=h+5<<3,k=iS(r,Gx)+iS(n,Wx)+a,O=iS(r,u)+iS(n,m)+a+14+3*P+iS(w,E)+2*w[16]+3*w[17]+7*w[18];if(l>=0&&R<=k&&R<=O)return sS(t,c,e.subarray(l,l+h));if(Jx(t,c,1+(O<k)),c+=2,O<k){D=Hx(u,f,0),L=u,M=Hx(m,g,0),I=m;var F=Hx(E,A,0);Jx(t,c,b-257),Jx(t,c+5,S-1),Jx(t,c+10,P-4),c+=14;for(T=0;T<P;++T)Jx(t,c+3*T,E[Rx[T]]);c+=3*P;for(var B=[_,x],N=0;N<2;++N){var z=B[N];for(T=0;T<z.length;++T){var U=31&z[T];Jx(t,c,F[U]),c+=E[U],U>15&&(Jx(t,c,z[T]>>5&127),c+=z[T]>>12)}}}else D=jx,L=Gx,M=qx,I=Wx;for(T=0;T<o;++T){var V=s[T];if(V>255){$x(t,c,D[(U=V>>18&31)+257]),c+=L[U+257],U>7&&(Jx(t,c,V>>23&31),c+=Mx[U]);var H=31&V;$x(t,c,M[H]),c+=I[H],H>3&&($x(t,c,V>>5&8191),c+=Ix[H])}else $x(t,c,D[V]),c+=L[V]}return $x(t,c,D[256]),c+L[256]},nS=new Lx([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),aS=new Px(0),oS=function(){for(var e=new Int32Array(256),t=0;t<256;++t){for(var i=t,s=9;--s;)i=(1&i&&-306674912)^i>>>1;e[t]=i}return e}(),lS=function(){var e=-1;return{p:function(t){for(var i=e,s=0;s<t.length;++s)i=oS[255&i^t[s]]^i>>>8;e=i},d:function(){return~e}}},hS=function(e,t,i,s,r){if(!r&&(r={l:1},t.dictionary)){var n=t.dictionary.subarray(-32768),a=new Px(n.length+e.length);a.set(n),a.set(e,n.length),e=a,r.w=n.length}return function(e,t,i,s,r,n){var a=n.z||e.length,o=new Px(s+a+5*(1+Math.ceil(a/7e3))+r),l=o.subarray(s,o.length-r),h=n.l,c=7&(n.r||0);if(t){c&&(l[0]=n.r>>3);for(var d=nS[t-1],u=d>>13,f=8191&d,p=(1<<i)-1,m=n.p||new Dx(32768),g=n.h||new Dx(p+1),v=Math.ceil(i/3),_=2*v,b=function(t){return(e[t]^e[t+1]<<v^e[t+2]<<_)&p},y=new Lx(25e3),x=new Dx(288),S=new Dx(32),w=0,T=0,C=n.i||0,E=0,A=n.w||0,P=0;C+2<a;++C){var D=b(C),L=32767&C,M=g[D];if(m[L]=M,g[D]=L,A<=C){var I=a-C;if((w>7e3||E>24576)&&(I>423||!h)){c=rS(e,l,0,y,x,S,T,E,P,C-P,c),E=w=T=0,P=C;for(var R=0;R<286;++R)x[R]=0;for(R=0;R<30;++R)S[R]=0}var k=2,O=0,F=f,B=L-M&32767;if(I>2&&D==b(C-B))for(var N=Math.min(u,I)-1,z=Math.min(32767,C),U=Math.min(258,I);B<=z&&--F&&L!=M;){if(e[C+k]==e[C+k-B]){for(var V=0;V<U&&e[C+V]==e[C+V-B];++V);if(V>k){if(k=V,O=B,V>N)break;var H=Math.min(B,V-2),G=0;for(R=0;R<H;++R){var W=C-B+R&32767,j=W-m[W]&32767;j>G&&(G=j,M=W)}}}B+=(L=M)-(M=m[L])&32767}if(O){y[E++]=268435456|Bx[k]<<18|Nx[O];var q=31&Bx[k],X=31&Nx[O];T+=Mx[q]+Ix[X],++x[257+q],++S[X],A=C+k,++w}else y[E++]=e[C],++x[e[C]]}}for(C=Math.max(C,A);C<a;++C)y[E++]=e[C],++x[e[C]];c=rS(e,l,h,y,x,S,T,E,P,C-P,c),h||(n.r=7&c|l[c/8|0]<<3,c-=7,n.h=g,n.p=m,n.i=C,n.w=A)}else{for(C=n.w||0;C<a+h;C+=65535){var K=C+65535;K>=a&&(l[c/8|0]=h,K=a),c=sS(l,c+1,e.subarray(C,K))}n.i=a}return Kx(o,0,s+Xx(c)+r)}(e,null==t.level?6:t.level,null==t.mem?r.l?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(e.length)))):20:12+t.mem,i,s,r)},cS=function(e,t){var i={};for(var s in e)i[s]=e[s];for(var s in t)i[s]=t[s];return i},dS=function(e,t,i){for(;i;++t)e[t]=i,i>>>=8};function uS(e,t){return hS(e,t||{},0,0)}var fS=function(e,t,i,s){for(var r in e){var n=e[r],a=t+r,o=s;Array.isArray(n)&&(o=cS(s,n[1]),n=n[0]),n instanceof Px?i[a]=[n,o]:(i[a+="/"]=[new Px(0),o],fS(n,a,i,s))}},pS="undefined"!=typeof TextEncoder&&new TextEncoder,mS="undefined"!=typeof TextDecoder&&new TextDecoder;try{mS.decode(aS,{stream:!0})}catch(e){}function gS(e,t){if(pS)return pS.encode(e);for(var i=e.length,s=new Px(e.length+(e.length>>1)),r=0,n=function(e){s[r++]=e},a=0;a<i;++a){if(r+5>s.length){var o=new Px(r+8+(i-a<<1));o.set(s),s=o}var l=e.charCodeAt(a);l<128||t?n(l):l<2048?(n(192|l>>6),n(128|63&l)):l>55295&&l<57344?(n(240|(l=65536+(1047552&l)|1023&e.charCodeAt(++a))>>18),n(128|l>>12&63),n(128|l>>6&63),n(128|63&l)):(n(224|l>>12),n(128|l>>6&63),n(128|63&l))}return Kx(s,0,r)}var vS=function(e){var t=0;if(e)for(var i in e){var s=e[i].length;s>65535&&Qx(9),t+=s+4}return t},_S=function(e,t,i,s,r,n,a,o){var l=s.length,h=i.extra,c=o&&o.length,d=vS(h);dS(e,t,null!=a?33639248:67324752),t+=4,null!=a&&(e[t++]=20,e[t++]=i.os),e[t]=20,t+=2,e[t++]=i.flag<<1|(n<0&&8),e[t++]=r&&8,e[t++]=255&i.compression,e[t++]=i.compression>>8;var u=new Date(null==i.mtime?Date.now():i.mtime),f=u.getFullYear()-1980;if((f<0||f>119)&&Qx(10),dS(e,t,f<<25|u.getMonth()+1<<21|u.getDate()<<16|u.getHours()<<11|u.getMinutes()<<5|u.getSeconds()>>1),t+=4,-1!=n&&(dS(e,t,i.crc),dS(e,t+4,n<0?-n-2:n),dS(e,t+8,i.size)),dS(e,t+12,l),dS(e,t+14,d),t+=16,null!=a&&(dS(e,t,c),dS(e,t+6,i.attrs),dS(e,t+10,a),t+=14),e.set(s,t),t+=l,d)for(var p in h){var m=h[p],g=m.length;dS(e,t,+p),dS(e,t+2,g),e.set(m,t+4),t+=4+g}return c&&(e.set(o,t),t+=c),t};function bS(e,t){t||(t={});var i={},s=[];fS(e,"",i,t);var r=0,n=0;for(var a in i){var o=i[a],l=o[0],h=o[1],c=0==h.level?0:8,d=(w=gS(a)).length,u=h.comment,f=u&&gS(u),p=f&&f.length,m=vS(h.extra);d>65535&&Qx(11);var g=c?uS(l,h):l,v=g.length,_=lS();_.p(l),s.push(cS(h,{size:l.length,crc:_.d(),c:g,f:w,m:f,u:d!=a.length||f&&u.length!=p,o:r,compression:c})),r+=30+d+m+v,n+=76+2*(d+m)+(p||0)+v}for(var b=new Px(n+22),y=r,x=n-r,S=0;S<s.length;++S){var w=s[S];_S(b,w.o,w,w.f,w.u,w.c.length);var T=30+w.f.length+vS(w.extra);b.set(w.c,w.o+T),_S(b,r,w,w.f,w.u,w.c.length,w.o,w.m),r+=16+T+(w.m?w.m.length:0)}return function(e,t,i,s,r){dS(e,t,101010256),dS(e,t+8,i),dS(e,t+10,i),dS(e,t+12,s),dS(e,t+16,r)}(b,r,s.length,x,y),b}var yS="root",xS=(e,t,i)=>"                    "+e+" inputs:"+t+" = "+i;class SS extends Ax{init(){this.meshMap=new Map,this.textureMap=new Map,this.materialMap=new Map,this.materials=[],this.files={},this.nodeNames=new Set}done(){this.meshMap=null,this.textureMap=null,this.materialMap=null,this.materials=null,this.files=null,this.nodeNames=null}build(e,t){var i,s=function(e){var t=o[e],s=i.textureToCanvas(t,a).then((e=>e?new Promise((t=>e.toBlob(t,"image/png",1))).then((e=>e.arrayBuffer())):(console.warn("Export of texture "+t.name+" is not currently supported."),new Promise((e=>e(null))))));l.push(s)};void 0===t&&(t={}),this.init(),this.addFile(null,yS);var r=[];e&&e.findComponents("render").forEach((e=>{r.push(...e.meshInstances)}));var n="";r.forEach((e=>{n+=this.buildMeshInstance(e)})),n+='\ndef "Materials"\n{\n    '+this.materials.join("\n")+"\n}\n",this.addFile(null,yS,"",n);for(var a={maxTextureSize:t.maxTextureSize},o=Array.from(this.textureMap.keys()),l=[],h=0;h<o.length;h++)i=this,s(h);var c=Promise.all(l).then((e=>{e.forEach(((e,t)=>{var i=o[t],s=this.getTextureFileIds(i);this.files[s.fileName]=new Uint8Array(e)})),this.alignFiles();var t=bS(this.files,{level:0});return this.done(),t}));return c}alignFiles(){var e=0;for(var t in this.files){var i=this.files[t],s=63&(e+=34+t.length);if(4!==s){var r=new Uint8Array(64-s);this.files[t]=[i,{extra:{12345:r}}]}e=i.length}}getFileIds(e,t,i,s){void 0===s&&(s="usda");var r=(e?e+"/":"")+t+"."+s;return{name:t,fileName:r,refName:"@./"+r+"@</"+i+">"}}getTextureFileIds(e){return this.getFileIds("texture","Texture_"+e.id,"Texture","png")}addFile(e,t,i,s){void 0===i&&(i=""),void 0===s&&(s="");var r=null;s&&(r=gS(s='#usda 1.0\n(\n    customLayerData = {\n        string creator = "PlayCanvas UsdzExporter"\n    }\n    metersPerUnit = 1\n    upAxis = "Y"\n)\n\n'+s));var n=this.getFileIds(e,t,i);return this.files[n.fileName]=r,n.refName}getMaterialRef(e){var t=this.materialMap.get(e);return t||(t=this.buildMaterial(e),this.materialMap.set(e,t)),t}getMeshRef(e){var t=this.meshMap.get(e);return t||(t=this.buildMesh(e),this.meshMap.set(e,t)),t}buildArray2(e){for(var t=[],i=e.length,s=0;s<i;s+=2)t.push("("+e[s]+", "+(1-e[s+1])+")");return t.join(", ")}buildArray3(e){for(var t=[],i=e.length,s=0;s<i;s+=3)t.push("("+e[s]+", "+e[s+1]+", "+e[s+2]+")");return t.join(", ")}buildMat4(e){for(var t=e.data,i=[],s=0;s<16;s+=4)i.push("("+t[s]+", "+t[s+1]+", "+t[s+2]+", "+t[s+3]+")");return"( "+i.join(", ")+" )"}buildMaterial(e){var t="Material_"+e.id,i="/Materials/"+t,s=e=>"<"+i+e+">",r=[],n=[],a=(t,i,a,o,l,h,c)=>{void 0===c&&(c=!1);var d=e[t];if(d){var u=this.getTextureFileIds(d);this.textureMap.set(d,u.refName);var f=e[t+"Channel"]||"rgb",p=s("/"+u.name+"_"+l+".outputs:"+f);r.push(xS(a,o+".connect",p));var m=e[t+"Tiling"],g=e[t+"Offset"],v=e[t+"Rotation"],_=1===e[t+"Uv"]?"st1":"st",b=c&&i?i:ii.WHITE;n.push(((e,t,i,r,n,a,o,l)=>'\n                def Shader "Transform2d_'+i+'" (\n                    sdrMetadata = {\n                        string role = "math"\n                    }\n                )\n                {\n                    uniform token info:id = "UsdTransform2d"\n                    float2 inputs:in.connect = '+s("/uvReader_"+r+".outputs:result")+"\n                    float inputs:rotation = "+o+"\n                    float2 inputs:scale = ("+n.x+", "+n.y+")\n                    float2 inputs:translation = ("+a.x+", "+a.y+')\n                    float2 outputs:result\n                }\n\n                def Shader "Texture_'+e.id+"_"+i+'"\n                {\n                    uniform token info:id = "UsdUVTexture"\n                    asset inputs:file = @'+t.fileName+"@\n                    float2 inputs:st.connect = "+s("/Transform2d_"+i+".outputs:result")+'\n                    token inputs:wrapS = "repeat"\n                    token inputs:wrapT = "repeat"\n                    float4 inputs:scale = ('+l.r+", "+l.g+", "+l.b+", "+l.a+")\n                    float outputs:r\n                    float outputs:g\n                    float outputs:b\n                    float3 outputs:rgb\n                    float outputs:a\n                }\n            ")(d,u,l,_,m,g,v,b))}else if(i){var y="float"===a?""+i:"("+i.r+", "+i.g+", "+i.b+")";r.push(xS(a,o,y))}};a("diffuseMap",e.diffuse,"color3f","diffuseColor","diffuse",0,!0),(e.transparent||e.alphaTest>0)&&a("opacityMap",e.opacity,"float","opacity","opacity"),a("normalMap",null,"normal3f","normal","normal"),a("emissiveMap",e.emissive,"color3f","emissiveColor","emissive",0,!0),a("aoMap",null,"float","occlusion","occlusion"),a("metalnessMap",e.metalness,"float","metallic","metallic"),a("glossMap",e.gloss,"float","roughness","roughness");var o='\n            def Material "'+t+'"\n            {\n                def Shader "PreviewSurface"\n                {\n                    uniform token info:id = "UsdPreviewSurface"\n'+r.join("\n")+"\n                    int inputs:useSpecularWorkflow = 0\n                    token outputs:surface\n                }\n\n                token outputs:surface.connect = "+s("/PreviewSurface.outputs:surface")+'\n\n                def Shader "uvReader_st"\n                {\n                    uniform token info:id = "UsdPrimvarReader_float2"\n                    token inputs:varname = "st"\n                    float2 inputs:fallback = (0.0, 0.0)\n                    float2 outputs:result\n                }\n\n                def Shader "uvReader_st1"\n                {\n                    uniform token info:id = "UsdPrimvarReader_float2"\n                    token inputs:varname = "st1"\n                    float2 inputs:fallback = (0.0, 0.0)\n                    float2 outputs:result\n                }\n\n                '+n.join("\n")+"\n            }\n        ";return this.materials.push(o),s("")}buildMesh(e){var t=[],i=[],s=[],r=[],n=[];e.getVertexStream(Ji,t),e.getVertexStream($i,s),e.getVertexStream(rs,r),e.getVertexStream(ns,n),e.getIndices(i);var a=i.length||t.length,o=Array(a/3).fill(3).join(", ");if(!i.length)for(var l=0;l<a;l++)i[l]=l;var h=t.length/3;s=s.length?s:Array(3*h).fill(0),r=r.length?r:Array(2*h).fill(0),n=n.length?n:Array(2*h).fill(0),t=this.buildArray3(t);var c=((e,t,i,s,r,n)=>'\ndef "Mesh"\n{\n    def Mesh "Mesh"\n    {\n        int[] faceVertexCounts = ['+e+"]\n        int[] faceVertexIndices = ["+t+"]\n        normal3f[] normals = ["+i+'] (\n            interpolation = "vertex"\n        )\n        point3f[] points = ['+s+"]\n        texCoord2f[] primvars:st = ["+r+'] (\n            interpolation = "vertex"\n        )\n        texCoord2f[] primvars:st1 = ['+n+'] (\n            interpolation = "vertex"\n        )\n        uniform token subdivisionScheme = "none"\n    }\n}\n')(o,i,s=this.buildArray3(s),t,r=this.buildArray2(r),n=this.buildArray2(n));return this.addFile("mesh","Mesh_"+e.id,"Mesh",c)}buildMeshInstance(e){for(var t=this.getMeshRef(e.mesh),i=this.getMaterialRef(e.material),s=this.buildMat4(e.node.getWorldTransform()),r=e.node.name.replace(/[^a-z0-9]/gi,"_"),n=r;this.nodeNames.has(n);)n=r+"_"+Math.random().toString(36).slice(2,7);return this.nodeNames.add(n),((e,t,i,s)=>'\ndef Xform "'+e+'" (\n    prepend references = '+t+"\n)\n{\n    matrix4d xformOp:transform = "+i+'\n    uniform token[] xformOpOrder = ["xformOp:transform"]\n\n    rel material:binding = '+s+"\n}\n")(n,t,s,i)}}let wS;function TS(e){if(wS.call(this,e),3===e);else this._blendState.setAlphaBlend(0,1,8)}const CS=()=>{const e=Object.getOwnPropertyDescriptor(fd.prototype,"blendType");wS=e.set,Object.defineProperty(fd.prototype,"blendType",{set(e){TS.call(this,e)},get(){return e.get.call(this)}})};var ES,AS,PS,DS,LS={exports:{}},MS={},IS={exports:{}},RS={};function kS(){return ES||(ES=1,function(e){function t(e,t){var i=e.length;e.push(t);e:for(;0<i;){var s=i-1>>>1,n=e[s];if(!(0<r(n,t)))break e;e[s]=t,e[i]=n,i=s}}function i(e){return 0===e.length?null:e[0]}function s(e){if(0===e.length)return null;var t=e[0],i=e.pop();if(i!==t){e[0]=i;e:for(var s=0,n=e.length,a=n>>>1;s<a;){var o=2*(s+1)-1,l=e[o],h=o+1,c=e[h];if(0>r(l,i))h<n&&0>r(c,l)?(e[s]=c,e[h]=i,s=h):(e[s]=l,e[o]=i,s=o);else{if(!(h<n&&0>r(c,i)))break e;e[s]=c,e[h]=i,s=h}}}return t}function r(e,t){var i=e.sortIndex-t.sortIndex;return 0!==i?i:e.id-t.id}if("object"==typeof performance&&"function"==typeof performance.now){var n=performance;e.unstable_now=function(){return n.now()}}else{var a=Date,o=a.now();e.unstable_now=function(){return a.now()-o}}var l=[],h=[],c=1,d=null,u=3,f=!1,p=!1,m=!1,g="function"==typeof setTimeout?setTimeout:null,v="function"==typeof clearTimeout?clearTimeout:null,_="undefined"!=typeof setImmediate?setImmediate:null;function b(e){for(var r=i(h);null!==r;){if(null===r.callback)s(h);else{if(!(r.startTime<=e))break;s(h),r.sortIndex=r.expirationTime,t(l,r)}r=i(h)}}function y(e){if(m=!1,b(e),!p)if(null!==i(l))p=!0,I(x);else{var t=i(h);null!==t&&R(y,t.startTime-e)}}function x(t,r){p=!1,m&&(m=!1,v(C),C=-1),f=!0;var n=u;try{for(b(r),d=i(l);null!==d&&(!(d.expirationTime>r)||t&&!P());){var a=d.callback;if("function"==typeof a){d.callback=null,u=d.priorityLevel;var o=a(d.expirationTime<=r);r=e.unstable_now(),"function"==typeof o?d.callback=o:d===i(l)&&s(l),b(r)}else s(l);d=i(l)}if(null!==d)var c=!0;else{var g=i(h);null!==g&&R(y,g.startTime-r),c=!1}return c}finally{d=null,u=n,f=!1}}"undefined"!=typeof navigator&&void 0!==navigator.scheduling&&void 0!==navigator.scheduling.isInputPending&&navigator.scheduling.isInputPending.bind(navigator.scheduling);var S,w=!1,T=null,C=-1,E=5,A=-1;function P(){return!(e.unstable_now()-A<E)}function D(){if(null!==T){var t=e.unstable_now();A=t;var i=!0;try{i=T(!0,t)}finally{i?S():(w=!1,T=null)}}else w=!1}if("function"==typeof _)S=function(){_(D)};else if("undefined"!=typeof MessageChannel){var L=new MessageChannel,M=L.port2;L.port1.onmessage=D,S=function(){M.postMessage(null)}}else S=function(){g(D,0)};function I(e){T=e,w||(w=!0,S())}function R(t,i){C=g((function(){t(e.unstable_now())}),i)}e.unstable_IdlePriority=5,e.unstable_ImmediatePriority=1,e.unstable_LowPriority=4,e.unstable_NormalPriority=3,e.unstable_Profiling=null,e.unstable_UserBlockingPriority=2,e.unstable_cancelCallback=function(e){e.callback=null},e.unstable_continueExecution=function(){p||f||(p=!0,I(x))},e.unstable_forceFrameRate=function(e){0>e||125<e?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):E=0<e?Math.floor(1e3/e):5},e.unstable_getCurrentPriorityLevel=function(){return u},e.unstable_getFirstCallbackNode=function(){return i(l)},e.unstable_next=function(e){switch(u){case 1:case 2:case 3:var t=3;break;default:t=u}var i=u;u=t;try{return e()}finally{u=i}},e.unstable_pauseExecution=function(){},e.unstable_requestPaint=function(){},e.unstable_runWithPriority=function(e,t){switch(e){case 1:case 2:case 3:case 4:case 5:break;default:e=3}var i=u;u=e;try{return t()}finally{u=i}},e.unstable_scheduleCallback=function(s,r,n){var a=e.unstable_now();switch("object"==typeof n&&null!==n?n="number"==typeof(n=n.delay)&&0<n?a+n:a:n=a,s){case 1:var o=-1;break;case 2:o=250;break;case 5:o=1073741823;break;case 4:o=1e4;break;default:o=5e3}return s={id:c++,callback:r,priorityLevel:s,startTime:n,expirationTime:o=n+o,sortIndex:-1},n>a?(s.sortIndex=n,t(h,s),null===i(l)&&s===i(h)&&(m?(v(C),C=-1):m=!0,R(y,n-a))):(s.sortIndex=o,t(l,s),p||f||(p=!0,I(x))),s},e.unstable_shouldYield=P,e.unstable_wrapCallback=function(e){var t=u;return function(){var i=u;u=t;try{return e.apply(this,arguments)}finally{u=i}}}}(RS)),RS}function OS(){return AS||(AS=1,IS.exports=kS()),IS.exports}
/**
 * @license React
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */function FS(){if(PS)return MS;PS=1;var e=c(),t=OS();function i(e){for(var t="https://reactjs.org/docs/error-decoder.html?invariant="+e,i=1;i<arguments.length;i++)t+="&args[]="+encodeURIComponent(arguments[i]);return"Minified React error #"+e+"; visit "+t+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var s=new Set,r={};function n(e,t){a(e,t),a(e+"Capture",t)}function a(e,t){for(r[e]=t,e=0;e<t.length;e++)s.add(t[e])}var o=!("undefined"==typeof window||void 0===window.document||void 0===window.document.createElement),l=Object.prototype.hasOwnProperty,h=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,d={},u={};function f(e,t,i,s,r,n,a){this.acceptsBooleans=2===t||3===t||4===t,this.attributeName=s,this.attributeNamespace=r,this.mustUseProperty=i,this.propertyName=e,this.type=t,this.sanitizeURL=n,this.removeEmptyString=a}var p={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach((function(e){p[e]=new f(e,0,!1,e,null,!1,!1)})),[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach((function(e){var t=e[0];p[t]=new f(t,1,!1,e[1],null,!1,!1)})),["contentEditable","draggable","spellCheck","value"].forEach((function(e){p[e]=new f(e,2,!1,e.toLowerCase(),null,!1,!1)})),["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach((function(e){p[e]=new f(e,2,!1,e,null,!1,!1)})),"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture disableRemotePlayback formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach((function(e){p[e]=new f(e,3,!1,e.toLowerCase(),null,!1,!1)})),["checked","multiple","muted","selected"].forEach((function(e){p[e]=new f(e,3,!0,e,null,!1,!1)})),["capture","download"].forEach((function(e){p[e]=new f(e,4,!1,e,null,!1,!1)})),["cols","rows","size","span"].forEach((function(e){p[e]=new f(e,6,!1,e,null,!1,!1)})),["rowSpan","start"].forEach((function(e){p[e]=new f(e,5,!1,e.toLowerCase(),null,!1,!1)}));var m=/[\-:]([a-z])/g;function g(e){return e[1].toUpperCase()}function v(e,t,i,s){var r=p.hasOwnProperty(t)?p[t]:null;(null!==r?0!==r.type:s||!(2<t.length)||"o"!==t[0]&&"O"!==t[0]||"n"!==t[1]&&"N"!==t[1])&&(function(e,t,i,s){if(null==t||function(e,t,i,s){if(null!==i&&0===i.type)return!1;switch(typeof t){case"function":case"symbol":return!0;case"boolean":return!s&&(null!==i?!i.acceptsBooleans:"data-"!==(e=e.toLowerCase().slice(0,5))&&"aria-"!==e);default:return!1}}(e,t,i,s))return!0;if(s)return!1;if(null!==i)switch(i.type){case 3:return!t;case 4:return!1===t;case 5:return isNaN(t);case 6:return isNaN(t)||1>t}return!1}(t,i,r,s)&&(i=null),s||null===r?function(e){return!!l.call(u,e)||!l.call(d,e)&&(h.test(e)?u[e]=!0:(d[e]=!0,!1))}(t)&&(null===i?e.removeAttribute(t):e.setAttribute(t,""+i)):r.mustUseProperty?e[r.propertyName]=null===i?3!==r.type&&"":i:(t=r.attributeName,s=r.attributeNamespace,null===i?e.removeAttribute(t):(i=3===(r=r.type)||4===r&&!0===i?"":""+i,s?e.setAttributeNS(s,t,i):e.setAttribute(t,i))))}"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach((function(e){var t=e.replace(m,g);p[t]=new f(t,1,!1,e,null,!1,!1)})),"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach((function(e){var t=e.replace(m,g);p[t]=new f(t,1,!1,e,"http://www.w3.org/1999/xlink",!1,!1)})),["xml:base","xml:lang","xml:space"].forEach((function(e){var t=e.replace(m,g);p[t]=new f(t,1,!1,e,"http://www.w3.org/XML/1998/namespace",!1,!1)})),["tabIndex","crossOrigin"].forEach((function(e){p[e]=new f(e,1,!1,e.toLowerCase(),null,!1,!1)})),p.xlinkHref=new f("xlinkHref",1,!1,"xlink:href","http://www.w3.org/1999/xlink",!0,!1),["src","href","action","formAction"].forEach((function(e){p[e]=new f(e,1,!1,e.toLowerCase(),null,!0,!0)}));var _=e.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,b=Symbol.for("react.element"),y=Symbol.for("react.portal"),x=Symbol.for("react.fragment"),S=Symbol.for("react.strict_mode"),w=Symbol.for("react.profiler"),T=Symbol.for("react.provider"),C=Symbol.for("react.context"),E=Symbol.for("react.forward_ref"),A=Symbol.for("react.suspense"),P=Symbol.for("react.suspense_list"),D=Symbol.for("react.memo"),L=Symbol.for("react.lazy"),M=Symbol.for("react.offscreen"),I=Symbol.iterator;function R(e){return null===e||"object"!=typeof e?null:"function"==typeof(e=I&&e[I]||e["@@iterator"])?e:null}var k,O=Object.assign;function F(e){if(void 0===k)try{throw Error()}catch(e){var t=e.stack.trim().match(/\n( *(at )?)/);k=t&&t[1]||""}return"\n"+k+e}var B=!1;function N(e,t){if(!e||B)return"";B=!0;var i=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{if(t)if(t=function(){throw Error()},Object.defineProperty(t.prototype,"props",{set:function(){throw Error()}}),"object"==typeof Reflect&&Reflect.construct){try{Reflect.construct(t,[])}catch(e){var s=e}Reflect.construct(e,[],t)}else{try{t.call()}catch(e){s=e}e.call(t.prototype)}else{try{throw Error()}catch(e){s=e}e()}}catch(t){if(t&&s&&"string"==typeof t.stack){for(var r=t.stack.split("\n"),n=s.stack.split("\n"),a=r.length-1,o=n.length-1;1<=a&&0<=o&&r[a]!==n[o];)o--;for(;1<=a&&0<=o;a--,o--)if(r[a]!==n[o]){if(1!==a||1!==o)do{if(a--,0>--o||r[a]!==n[o]){var l="\n"+r[a].replace(" at new "," at ");return e.displayName&&l.includes("<anonymous>")&&(l=l.replace("<anonymous>",e.displayName)),l}}while(1<=a&&0<=o);break}}}finally{B=!1,Error.prepareStackTrace=i}return(e=e?e.displayName||e.name:"")?F(e):""}function z(e){switch(e.tag){case 5:return F(e.type);case 16:return F("Lazy");case 13:return F("Suspense");case 19:return F("SuspenseList");case 0:case 2:case 15:return e=N(e.type,!1);case 11:return e=N(e.type.render,!1);case 1:return e=N(e.type,!0);default:return""}}function U(e){if(null==e)return null;if("function"==typeof e)return e.displayName||e.name||null;if("string"==typeof e)return e;switch(e){case x:return"Fragment";case y:return"Portal";case w:return"Profiler";case S:return"StrictMode";case A:return"Suspense";case P:return"SuspenseList"}if("object"==typeof e)switch(e.$$typeof){case C:return(e.displayName||"Context")+".Consumer";case T:return(e._context.displayName||"Context")+".Provider";case E:var t=e.render;return(e=e.displayName)||(e=""!==(e=t.displayName||t.name||"")?"ForwardRef("+e+")":"ForwardRef"),e;case D:return null!==(t=e.displayName||null)?t:U(e.type)||"Memo";case L:t=e._payload,e=e._init;try{return U(e(t))}catch(e){}}return null}function V(e){var t=e.type;switch(e.tag){case 24:return"Cache";case 9:return(t.displayName||"Context")+".Consumer";case 10:return(t._context.displayName||"Context")+".Provider";case 18:return"DehydratedFragment";case 11:return e=(e=t.render).displayName||e.name||"",t.displayName||(""!==e?"ForwardRef("+e+")":"ForwardRef");case 7:return"Fragment";case 5:return t;case 4:return"Portal";case 3:return"Root";case 6:return"Text";case 16:return U(t);case 8:return t===S?"StrictMode":"Mode";case 22:return"Offscreen";case 12:return"Profiler";case 21:return"Scope";case 13:return"Suspense";case 19:return"SuspenseList";case 25:return"TracingMarker";case 1:case 0:case 17:case 2:case 14:case 15:if("function"==typeof t)return t.displayName||t.name||null;if("string"==typeof t)return t}return null}function H(e){switch(typeof e){case"boolean":case"number":case"string":case"undefined":case"object":return e;default:return""}}function G(e){var t=e.type;return(e=e.nodeName)&&"input"===e.toLowerCase()&&("checkbox"===t||"radio"===t)}function W(e){e._valueTracker||(e._valueTracker=function(e){var t=G(e)?"checked":"value",i=Object.getOwnPropertyDescriptor(e.constructor.prototype,t),s=""+e[t];if(!e.hasOwnProperty(t)&&void 0!==i&&"function"==typeof i.get&&"function"==typeof i.set){var r=i.get,n=i.set;return Object.defineProperty(e,t,{configurable:!0,get:function(){return r.call(this)},set:function(e){s=""+e,n.call(this,e)}}),Object.defineProperty(e,t,{enumerable:i.enumerable}),{getValue:function(){return s},setValue:function(e){s=""+e},stopTracking:function(){e._valueTracker=null,delete e[t]}}}}(e))}function j(e){if(!e)return!1;var t=e._valueTracker;if(!t)return!0;var i=t.getValue(),s="";return e&&(s=G(e)?e.checked?"true":"false":e.value),(e=s)!==i&&(t.setValue(e),!0)}function q(e){if(void 0===(e=e||("undefined"!=typeof document?document:void 0)))return null;try{return e.activeElement||e.body}catch(t){return e.body}}function X(e,t){var i=t.checked;return O({},t,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=i?i:e._wrapperState.initialChecked})}function K(e,t){var i=null==t.defaultValue?"":t.defaultValue,s=null!=t.checked?t.checked:t.defaultChecked;i=H(null!=t.value?t.value:i),e._wrapperState={initialChecked:s,initialValue:i,controlled:"checkbox"===t.type||"radio"===t.type?null!=t.checked:null!=t.value}}function Y(e,t){null!=(t=t.checked)&&v(e,"checked",t,!1)}function Q(e,t){Y(e,t);var i=H(t.value),s=t.type;if(null!=i)"number"===s?(0===i&&""===e.value||e.value!=i)&&(e.value=""+i):e.value!==""+i&&(e.value=""+i);else if("submit"===s||"reset"===s)return void e.removeAttribute("value");t.hasOwnProperty("value")?$(e,t.type,i):t.hasOwnProperty("defaultValue")&&$(e,t.type,H(t.defaultValue)),null==t.checked&&null!=t.defaultChecked&&(e.defaultChecked=!!t.defaultChecked)}function J(e,t,i){if(t.hasOwnProperty("value")||t.hasOwnProperty("defaultValue")){var s=t.type;if(!("submit"!==s&&"reset"!==s||void 0!==t.value&&null!==t.value))return;t=""+e._wrapperState.initialValue,i||t===e.value||(e.value=t),e.defaultValue=t}""!==(i=e.name)&&(e.name=""),e.defaultChecked=!!e._wrapperState.initialChecked,""!==i&&(e.name=i)}function $(e,t,i){"number"===t&&q(e.ownerDocument)===e||(null==i?e.defaultValue=""+e._wrapperState.initialValue:e.defaultValue!==""+i&&(e.defaultValue=""+i))}var Z=Array.isArray;function ee(e,t,i,s){if(e=e.options,t){t={};for(var r=0;r<i.length;r++)t["$"+i[r]]=!0;for(i=0;i<e.length;i++)r=t.hasOwnProperty("$"+e[i].value),e[i].selected!==r&&(e[i].selected=r),r&&s&&(e[i].defaultSelected=!0)}else{for(i=""+H(i),t=null,r=0;r<e.length;r++){if(e[r].value===i)return e[r].selected=!0,void(s&&(e[r].defaultSelected=!0));null!==t||e[r].disabled||(t=e[r])}null!==t&&(t.selected=!0)}}function te(e,t){if(null!=t.dangerouslySetInnerHTML)throw Error(i(91));return O({},t,{value:void 0,defaultValue:void 0,children:""+e._wrapperState.initialValue})}function ie(e,t){var s=t.value;if(null==s){if(s=t.children,t=t.defaultValue,null!=s){if(null!=t)throw Error(i(92));if(Z(s)){if(1<s.length)throw Error(i(93));s=s[0]}t=s}null==t&&(t=""),s=t}e._wrapperState={initialValue:H(s)}}function se(e,t){var i=H(t.value),s=H(t.defaultValue);null!=i&&((i=""+i)!==e.value&&(e.value=i),null==t.defaultValue&&e.defaultValue!==i&&(e.defaultValue=i)),null!=s&&(e.defaultValue=""+s)}function re(e){var t=e.textContent;t===e._wrapperState.initialValue&&""!==t&&null!==t&&(e.value=t)}function ne(e){switch(e){case"svg":return"http://www.w3.org/2000/svg";case"math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function ae(e,t){return null==e||"http://www.w3.org/1999/xhtml"===e?ne(t):"http://www.w3.org/2000/svg"===e&&"foreignObject"===t?"http://www.w3.org/1999/xhtml":e}var oe,le,he=(le=function(e,t){if("http://www.w3.org/2000/svg"!==e.namespaceURI||"innerHTML"in e)e.innerHTML=t;else{for((oe=oe||document.createElement("div")).innerHTML="<svg>"+t.valueOf().toString()+"</svg>",t=oe.firstChild;e.firstChild;)e.removeChild(e.firstChild);for(;t.firstChild;)e.appendChild(t.firstChild)}},"undefined"!=typeof MSApp&&MSApp.execUnsafeLocalFunction?function(e,t,i,s){MSApp.execUnsafeLocalFunction((function(){return le(e,t)}))}:le);function ce(e,t){if(t){var i=e.firstChild;if(i&&i===e.lastChild&&3===i.nodeType)return void(i.nodeValue=t)}e.textContent=t}var de={animationIterationCount:!0,aspectRatio:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},ue=["Webkit","ms","Moz","O"];function fe(e,t,i){return null==t||"boolean"==typeof t||""===t?"":i||"number"!=typeof t||0===t||de.hasOwnProperty(e)&&de[e]?(""+t).trim():t+"px"}function pe(e,t){for(var i in e=e.style,t)if(t.hasOwnProperty(i)){var s=0===i.indexOf("--"),r=fe(i,t[i],s);"float"===i&&(i="cssFloat"),s?e.setProperty(i,r):e[i]=r}}Object.keys(de).forEach((function(e){ue.forEach((function(t){t=t+e.charAt(0).toUpperCase()+e.substring(1),de[t]=de[e]}))}));var me=O({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0});function ge(e,t){if(t){if(me[e]&&(null!=t.children||null!=t.dangerouslySetInnerHTML))throw Error(i(137,e));if(null!=t.dangerouslySetInnerHTML){if(null!=t.children)throw Error(i(60));if("object"!=typeof t.dangerouslySetInnerHTML||!("__html"in t.dangerouslySetInnerHTML))throw Error(i(61))}if(null!=t.style&&"object"!=typeof t.style)throw Error(i(62))}}function ve(e,t){if(-1===e.indexOf("-"))return"string"==typeof t.is;switch(e){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var _e=null;function be(e){return(e=e.target||e.srcElement||window).correspondingUseElement&&(e=e.correspondingUseElement),3===e.nodeType?e.parentNode:e}var ye=null,xe=null,Se=null;function we(e){if(e=gr(e)){if("function"!=typeof ye)throw Error(i(280));var t=e.stateNode;t&&(t=_r(t),ye(e.stateNode,e.type,t))}}function Te(e){xe?Se?Se.push(e):Se=[e]:xe=e}function Ce(){if(xe){var e=xe,t=Se;if(Se=xe=null,we(e),t)for(e=0;e<t.length;e++)we(t[e])}}function Ee(e,t){return e(t)}function Ae(){}var Pe=!1;function De(e,t,i){if(Pe)return e(t,i);Pe=!0;try{return Ee(e,t,i)}finally{Pe=!1,(null!==xe||null!==Se)&&(Ae(),Ce())}}function Le(e,t){var s=e.stateNode;if(null===s)return null;var r=_r(s);if(null===r)return null;s=r[t];e:switch(t){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(r=!r.disabled)||(r=!("button"===(e=e.type)||"input"===e||"select"===e||"textarea"===e)),e=!r;break e;default:e=!1}if(e)return null;if(s&&"function"!=typeof s)throw Error(i(231,t,typeof s));return s}var Me=!1;if(o)try{var Ie={};Object.defineProperty(Ie,"passive",{get:function(){Me=!0}}),window.addEventListener("test",Ie,Ie),window.removeEventListener("test",Ie,Ie)}catch(le){Me=!1}function Re(e,t,i,s,r,n,a,o,l){var h=Array.prototype.slice.call(arguments,3);try{t.apply(i,h)}catch(e){this.onError(e)}}var ke=!1,Oe=null,Fe=!1,Be=null,Ne={onError:function(e){ke=!0,Oe=e}};function ze(e,t,i,s,r,n,a,o,l){ke=!1,Oe=null,Re.apply(Ne,arguments)}function Ue(e){var t=e,i=e;if(e.alternate)for(;t.return;)t=t.return;else{e=t;do{!!(4098&(t=e).flags)&&(i=t.return),e=t.return}while(e)}return 3===t.tag?i:null}function Ve(e){if(13===e.tag){var t=e.memoizedState;if(null===t&&(null!==(e=e.alternate)&&(t=e.memoizedState)),null!==t)return t.dehydrated}return null}function He(e){if(Ue(e)!==e)throw Error(i(188))}function Ge(e){return e=function(e){var t=e.alternate;if(!t){if(null===(t=Ue(e)))throw Error(i(188));return t!==e?null:e}for(var s=e,r=t;;){var n=s.return;if(null===n)break;var a=n.alternate;if(null===a){if(null!==(r=n.return)){s=r;continue}break}if(n.child===a.child){for(a=n.child;a;){if(a===s)return He(n),e;if(a===r)return He(n),t;a=a.sibling}throw Error(i(188))}if(s.return!==r.return)s=n,r=a;else{for(var o=!1,l=n.child;l;){if(l===s){o=!0,s=n,r=a;break}if(l===r){o=!0,r=n,s=a;break}l=l.sibling}if(!o){for(l=a.child;l;){if(l===s){o=!0,s=a,r=n;break}if(l===r){o=!0,r=a,s=n;break}l=l.sibling}if(!o)throw Error(i(189))}}if(s.alternate!==r)throw Error(i(190))}if(3!==s.tag)throw Error(i(188));return s.stateNode.current===s?e:t}(e),null!==e?We(e):null}function We(e){if(5===e.tag||6===e.tag)return e;for(e=e.child;null!==e;){var t=We(e);if(null!==t)return t;e=e.sibling}return null}var je=t.unstable_scheduleCallback,qe=t.unstable_cancelCallback,Xe=t.unstable_shouldYield,Ke=t.unstable_requestPaint,Ye=t.unstable_now,Qe=t.unstable_getCurrentPriorityLevel,Je=t.unstable_ImmediatePriority,$e=t.unstable_UserBlockingPriority,Ze=t.unstable_NormalPriority,et=t.unstable_LowPriority,tt=t.unstable_IdlePriority,it=null,st=null;var rt=Math.clz32?Math.clz32:function(e){return e>>>=0,0===e?32:31-(nt(e)/at|0)|0},nt=Math.log,at=Math.LN2;var ot=64,lt=4194304;function ht(e){switch(e&-e){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return 4194240&e;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return 130023424&e;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 1073741824;default:return e}}function ct(e,t){var i=e.pendingLanes;if(0===i)return 0;var s=0,r=e.suspendedLanes,n=e.pingedLanes,a=268435455&i;if(0!==a){var o=a&~r;0!==o?s=ht(o):0!==(n&=a)&&(s=ht(n))}else 0!==(a=i&~r)?s=ht(a):0!==n&&(s=ht(n));if(0===s)return 0;if(0!==t&&t!==s&&!(t&r)&&((r=s&-s)>=(n=t&-t)||16===r&&4194240&n))return t;if(4&s&&(s|=16&i),0!==(t=e.entangledLanes))for(e=e.entanglements,t&=s;0<t;)r=1<<(i=31-rt(t)),s|=e[i],t&=~r;return s}function dt(e,t){switch(e){case 1:case 2:case 4:return t+250;case 8:case 16:case 32:case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return t+5e3;default:return-1}}function ut(e){return 0!==(e=-1073741825&e.pendingLanes)?e:1073741824&e?1073741824:0}function ft(){var e=ot;return!(4194240&(ot<<=1))&&(ot=64),e}function pt(e){for(var t=[],i=0;31>i;i++)t.push(e);return t}function mt(e,t,i){e.pendingLanes|=t,536870912!==t&&(e.suspendedLanes=0,e.pingedLanes=0),(e=e.eventTimes)[t=31-rt(t)]=i}function gt(e,t){var i=e.entangledLanes|=t;for(e=e.entanglements;i;){var s=31-rt(i),r=1<<s;r&t|e[s]&t&&(e[s]|=t),i&=~r}}var vt=0;function _t(e){return 1<(e&=-e)?4<e?268435455&e?16:536870912:4:1}var bt,yt,xt,St,wt,Tt=!1,Ct=[],Et=null,At=null,Pt=null,Dt=new Map,Lt=new Map,Mt=[],It="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset submit".split(" ");function Rt(e,t){switch(e){case"focusin":case"focusout":Et=null;break;case"dragenter":case"dragleave":At=null;break;case"mouseover":case"mouseout":Pt=null;break;case"pointerover":case"pointerout":Dt.delete(t.pointerId);break;case"gotpointercapture":case"lostpointercapture":Lt.delete(t.pointerId)}}function kt(e,t,i,s,r,n){return null===e||e.nativeEvent!==n?(e={blockedOn:t,domEventName:i,eventSystemFlags:s,nativeEvent:n,targetContainers:[r]},null!==t&&(null!==(t=gr(t))&&yt(t)),e):(e.eventSystemFlags|=s,t=e.targetContainers,null!==r&&-1===t.indexOf(r)&&t.push(r),e)}function Ot(e){var t=mr(e.target);if(null!==t){var i=Ue(t);if(null!==i)if(13===(t=i.tag)){if(null!==(t=Ve(i)))return e.blockedOn=t,void wt(e.priority,(function(){xt(i)}))}else if(3===t&&i.stateNode.current.memoizedState.isDehydrated)return void(e.blockedOn=3===i.tag?i.stateNode.containerInfo:null)}e.blockedOn=null}function Ft(e){if(null!==e.blockedOn)return!1;for(var t=e.targetContainers;0<t.length;){var i=Xt(e.domEventName,e.eventSystemFlags,t[0],e.nativeEvent);if(null!==i)return null!==(t=gr(i))&&yt(t),e.blockedOn=i,!1;var s=new(i=e.nativeEvent).constructor(i.type,i);_e=s,i.target.dispatchEvent(s),_e=null,t.shift()}return!0}function Bt(e,t,i){Ft(e)&&i.delete(t)}function Nt(){Tt=!1,null!==Et&&Ft(Et)&&(Et=null),null!==At&&Ft(At)&&(At=null),null!==Pt&&Ft(Pt)&&(Pt=null),Dt.forEach(Bt),Lt.forEach(Bt)}function zt(e,i){e.blockedOn===i&&(e.blockedOn=null,Tt||(Tt=!0,t.unstable_scheduleCallback(t.unstable_NormalPriority,Nt)))}function Ut(e){function t(t){return zt(t,e)}if(0<Ct.length){zt(Ct[0],e);for(var i=1;i<Ct.length;i++){var s=Ct[i];s.blockedOn===e&&(s.blockedOn=null)}}for(null!==Et&&zt(Et,e),null!==At&&zt(At,e),null!==Pt&&zt(Pt,e),Dt.forEach(t),Lt.forEach(t),i=0;i<Mt.length;i++)(s=Mt[i]).blockedOn===e&&(s.blockedOn=null);for(;0<Mt.length&&null===(i=Mt[0]).blockedOn;)Ot(i),null===i.blockedOn&&Mt.shift()}var Vt=_.ReactCurrentBatchConfig,Ht=!0;function Gt(e,t,i,s){var r=vt,n=Vt.transition;Vt.transition=null;try{vt=1,jt(e,t,i,s)}finally{vt=r,Vt.transition=n}}function Wt(e,t,i,s){var r=vt,n=Vt.transition;Vt.transition=null;try{vt=4,jt(e,t,i,s)}finally{vt=r,Vt.transition=n}}function jt(e,t,i,s){if(Ht){var r=Xt(e,t,i,s);if(null===r)Vs(e,t,s,qt,i),Rt(e,s);else if(function(e,t,i,s,r){switch(t){case"focusin":return Et=kt(Et,e,t,i,s,r),!0;case"dragenter":return At=kt(At,e,t,i,s,r),!0;case"mouseover":return Pt=kt(Pt,e,t,i,s,r),!0;case"pointerover":var n=r.pointerId;return Dt.set(n,kt(Dt.get(n)||null,e,t,i,s,r)),!0;case"gotpointercapture":return n=r.pointerId,Lt.set(n,kt(Lt.get(n)||null,e,t,i,s,r)),!0}return!1}(r,e,t,i,s))s.stopPropagation();else if(Rt(e,s),4&t&&-1<It.indexOf(e)){for(;null!==r;){var n=gr(r);if(null!==n&&bt(n),null===(n=Xt(e,t,i,s))&&Vs(e,t,s,qt,i),n===r)break;r=n}null!==r&&s.stopPropagation()}else Vs(e,t,s,null,i)}}var qt=null;function Xt(e,t,i,s){if(qt=null,null!==(e=mr(e=be(s))))if(null===(t=Ue(e)))e=null;else if(13===(i=t.tag)){if(null!==(e=Ve(t)))return e;e=null}else if(3===i){if(t.stateNode.current.memoizedState.isDehydrated)return 3===t.tag?t.stateNode.containerInfo:null;e=null}else t!==e&&(e=null);return qt=e,null}function Kt(e){switch(e){case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 1;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"toggle":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 4;case"message":switch(Qe()){case Je:return 1;case $e:return 4;case Ze:case et:return 16;case tt:return 536870912;default:return 16}default:return 16}}var Yt=null,Qt=null,Jt=null;function $t(){if(Jt)return Jt;var e,t,i=Qt,s=i.length,r="value"in Yt?Yt.value:Yt.textContent,n=r.length;for(e=0;e<s&&i[e]===r[e];e++);var a=s-e;for(t=1;t<=a&&i[s-t]===r[n-t];t++);return Jt=r.slice(e,1<t?1-t:void 0)}function Zt(e){var t=e.keyCode;return"charCode"in e?0===(e=e.charCode)&&13===t&&(e=13):e=t,10===e&&(e=13),32<=e||13===e?e:0}function ei(){return!0}function ti(){return!1}function ii(e){function t(t,i,s,r,n){for(var a in this._reactName=t,this._targetInst=s,this.type=i,this.nativeEvent=r,this.target=n,this.currentTarget=null,e)e.hasOwnProperty(a)&&(t=e[a],this[a]=t?t(r):r[a]);return this.isDefaultPrevented=(null!=r.defaultPrevented?r.defaultPrevented:!1===r.returnValue)?ei:ti,this.isPropagationStopped=ti,this}return O(t.prototype,{preventDefault:function(){this.defaultPrevented=!0;var e=this.nativeEvent;e&&(e.preventDefault?e.preventDefault():"unknown"!=typeof e.returnValue&&(e.returnValue=!1),this.isDefaultPrevented=ei)},stopPropagation:function(){var e=this.nativeEvent;e&&(e.stopPropagation?e.stopPropagation():"unknown"!=typeof e.cancelBubble&&(e.cancelBubble=!0),this.isPropagationStopped=ei)},persist:function(){},isPersistent:ei}),t}var si,ri,ni,ai={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(e){return e.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},oi=ii(ai),li=O({},ai,{view:0,detail:0}),hi=ii(li),ci=O({},li,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:Si,button:0,buttons:0,relatedTarget:function(e){return void 0===e.relatedTarget?e.fromElement===e.srcElement?e.toElement:e.fromElement:e.relatedTarget},movementX:function(e){return"movementX"in e?e.movementX:(e!==ni&&(ni&&"mousemove"===e.type?(si=e.screenX-ni.screenX,ri=e.screenY-ni.screenY):ri=si=0,ni=e),si)},movementY:function(e){return"movementY"in e?e.movementY:ri}}),di=ii(ci),ui=ii(O({},ci,{dataTransfer:0})),fi=ii(O({},li,{relatedTarget:0})),pi=ii(O({},ai,{animationName:0,elapsedTime:0,pseudoElement:0})),mi=O({},ai,{clipboardData:function(e){return"clipboardData"in e?e.clipboardData:window.clipboardData}}),gi=ii(mi),vi=ii(O({},ai,{data:0})),_i={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},bi={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},yi={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function xi(e){var t=this.nativeEvent;return t.getModifierState?t.getModifierState(e):!!(e=yi[e])&&!!t[e]}function Si(){return xi}var wi=O({},li,{key:function(e){if(e.key){var t=_i[e.key]||e.key;if("Unidentified"!==t)return t}return"keypress"===e.type?13===(e=Zt(e))?"Enter":String.fromCharCode(e):"keydown"===e.type||"keyup"===e.type?bi[e.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:Si,charCode:function(e){return"keypress"===e.type?Zt(e):0},keyCode:function(e){return"keydown"===e.type||"keyup"===e.type?e.keyCode:0},which:function(e){return"keypress"===e.type?Zt(e):"keydown"===e.type||"keyup"===e.type?e.keyCode:0}}),Ti=ii(wi),Ci=ii(O({},ci,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0})),Ei=ii(O({},li,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:Si})),Ai=ii(O({},ai,{propertyName:0,elapsedTime:0,pseudoElement:0})),Pi=O({},ci,{deltaX:function(e){return"deltaX"in e?e.deltaX:"wheelDeltaX"in e?-e.wheelDeltaX:0},deltaY:function(e){return"deltaY"in e?e.deltaY:"wheelDeltaY"in e?-e.wheelDeltaY:"wheelDelta"in e?-e.wheelDelta:0},deltaZ:0,deltaMode:0}),Di=ii(Pi),Li=[9,13,27,32],Mi=o&&"CompositionEvent"in window,Ii=null;o&&"documentMode"in document&&(Ii=document.documentMode);var Ri=o&&"TextEvent"in window&&!Ii,ki=o&&(!Mi||Ii&&8<Ii&&11>=Ii),Oi=String.fromCharCode(32),Fi=!1;function Bi(e,t){switch(e){case"keyup":return-1!==Li.indexOf(t.keyCode);case"keydown":return 229!==t.keyCode;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function Ni(e){return"object"==typeof(e=e.detail)&&"data"in e?e.data:null}var zi=!1;var Ui={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function Vi(e){var t=e&&e.nodeName&&e.nodeName.toLowerCase();return"input"===t?!!Ui[e.type]:"textarea"===t}function Hi(e,t,i,s){Te(s),0<(t=Gs(t,"onChange")).length&&(i=new oi("onChange","change",null,i,s),e.push({event:i,listeners:t}))}var Gi=null,Wi=null;function ji(e){Os(e,0)}function qi(e){if(j(vr(e)))return e}function Xi(e,t){if("change"===e)return t}var Ki=!1;if(o){var Yi;if(o){var Qi="oninput"in document;if(!Qi){var Ji=document.createElement("div");Ji.setAttribute("oninput","return;"),Qi="function"==typeof Ji.oninput}Yi=Qi}else Yi=!1;Ki=Yi&&(!document.documentMode||9<document.documentMode)}function $i(){Gi&&(Gi.detachEvent("onpropertychange",Zi),Wi=Gi=null)}function Zi(e){if("value"===e.propertyName&&qi(Wi)){var t=[];Hi(t,Wi,e,be(e)),De(ji,t)}}function es(e,t,i){"focusin"===e?($i(),Wi=i,(Gi=t).attachEvent("onpropertychange",Zi)):"focusout"===e&&$i()}function ts(e){if("selectionchange"===e||"keyup"===e||"keydown"===e)return qi(Wi)}function is(e,t){if("click"===e)return qi(t)}function ss(e,t){if("input"===e||"change"===e)return qi(t)}var rs="function"==typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e==1/t)||e!=e&&t!=t};function ns(e,t){if(rs(e,t))return!0;if("object"!=typeof e||null===e||"object"!=typeof t||null===t)return!1;var i=Object.keys(e),s=Object.keys(t);if(i.length!==s.length)return!1;for(s=0;s<i.length;s++){var r=i[s];if(!l.call(t,r)||!rs(e[r],t[r]))return!1}return!0}function as(e){for(;e&&e.firstChild;)e=e.firstChild;return e}function os(e,t){var i,s=as(e);for(e=0;s;){if(3===s.nodeType){if(i=e+s.textContent.length,e<=t&&i>=t)return{node:s,offset:t-e};e=i}e:{for(;s;){if(s.nextSibling){s=s.nextSibling;break e}s=s.parentNode}s=void 0}s=as(s)}}function ls(e,t){return!(!e||!t)&&(e===t||(!e||3!==e.nodeType)&&(t&&3===t.nodeType?ls(e,t.parentNode):"contains"in e?e.contains(t):!!e.compareDocumentPosition&&!!(16&e.compareDocumentPosition(t))))}function hs(){for(var e=window,t=q();t instanceof e.HTMLIFrameElement;){try{var i="string"==typeof t.contentWindow.location.href}catch(e){i=!1}if(!i)break;t=q((e=t.contentWindow).document)}return t}function cs(e){var t=e&&e.nodeName&&e.nodeName.toLowerCase();return t&&("input"===t&&("text"===e.type||"search"===e.type||"tel"===e.type||"url"===e.type||"password"===e.type)||"textarea"===t||"true"===e.contentEditable)}function ds(e){var t=hs(),i=e.focusedElem,s=e.selectionRange;if(t!==i&&i&&i.ownerDocument&&ls(i.ownerDocument.documentElement,i)){if(null!==s&&cs(i))if(t=s.start,void 0===(e=s.end)&&(e=t),"selectionStart"in i)i.selectionStart=t,i.selectionEnd=Math.min(e,i.value.length);else if((e=(t=i.ownerDocument||document)&&t.defaultView||window).getSelection){e=e.getSelection();var r=i.textContent.length,n=Math.min(s.start,r);s=void 0===s.end?n:Math.min(s.end,r),!e.extend&&n>s&&(r=s,s=n,n=r),r=os(i,n);var a=os(i,s);r&&a&&(1!==e.rangeCount||e.anchorNode!==r.node||e.anchorOffset!==r.offset||e.focusNode!==a.node||e.focusOffset!==a.offset)&&((t=t.createRange()).setStart(r.node,r.offset),e.removeAllRanges(),n>s?(e.addRange(t),e.extend(a.node,a.offset)):(t.setEnd(a.node,a.offset),e.addRange(t)))}for(t=[],e=i;e=e.parentNode;)1===e.nodeType&&t.push({element:e,left:e.scrollLeft,top:e.scrollTop});for("function"==typeof i.focus&&i.focus(),i=0;i<t.length;i++)(e=t[i]).element.scrollLeft=e.left,e.element.scrollTop=e.top}}var us=o&&"documentMode"in document&&11>=document.documentMode,fs=null,ps=null,ms=null,gs=!1;function vs(e,t,i){var s=i.window===i?i.document:9===i.nodeType?i:i.ownerDocument;gs||null==fs||fs!==q(s)||("selectionStart"in(s=fs)&&cs(s)?s={start:s.selectionStart,end:s.selectionEnd}:s={anchorNode:(s=(s.ownerDocument&&s.ownerDocument.defaultView||window).getSelection()).anchorNode,anchorOffset:s.anchorOffset,focusNode:s.focusNode,focusOffset:s.focusOffset},ms&&ns(ms,s)||(ms=s,0<(s=Gs(ps,"onSelect")).length&&(t=new oi("onSelect","select",null,t,i),e.push({event:t,listeners:s}),t.target=fs)))}function _s(e,t){var i={};return i[e.toLowerCase()]=t.toLowerCase(),i["Webkit"+e]="webkit"+t,i["Moz"+e]="moz"+t,i}var bs={animationend:_s("Animation","AnimationEnd"),animationiteration:_s("Animation","AnimationIteration"),animationstart:_s("Animation","AnimationStart"),transitionend:_s("Transition","TransitionEnd")},ys={},xs={};function Ss(e){if(ys[e])return ys[e];if(!bs[e])return e;var t,i=bs[e];for(t in i)if(i.hasOwnProperty(t)&&t in xs)return ys[e]=i[t];return e}o&&(xs=document.createElement("div").style,"AnimationEvent"in window||(delete bs.animationend.animation,delete bs.animationiteration.animation,delete bs.animationstart.animation),"TransitionEvent"in window||delete bs.transitionend.transition);var ws=Ss("animationend"),Ts=Ss("animationiteration"),Cs=Ss("animationstart"),Es=Ss("transitionend"),As=new Map,Ps="abort auxClick cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");function Ds(e,t){As.set(e,t),n(t,[e])}for(var Ls=0;Ls<Ps.length;Ls++){var Ms=Ps[Ls];Ds(Ms.toLowerCase(),"on"+(Ms[0].toUpperCase()+Ms.slice(1)))}Ds(ws,"onAnimationEnd"),Ds(Ts,"onAnimationIteration"),Ds(Cs,"onAnimationStart"),Ds("dblclick","onDoubleClick"),Ds("focusin","onFocus"),Ds("focusout","onBlur"),Ds(Es,"onTransitionEnd"),a("onMouseEnter",["mouseout","mouseover"]),a("onMouseLeave",["mouseout","mouseover"]),a("onPointerEnter",["pointerout","pointerover"]),a("onPointerLeave",["pointerout","pointerover"]),n("onChange","change click focusin focusout input keydown keyup selectionchange".split(" ")),n("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" ")),n("onBeforeInput",["compositionend","keypress","textInput","paste"]),n("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" ")),n("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" ")),n("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var Is="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Rs=new Set("cancel close invalid load scroll toggle".split(" ").concat(Is));function ks(e,t,s){var r=e.type||"unknown-event";e.currentTarget=s,function(e,t,s,r,n,a,o,l,h){if(ze.apply(this,arguments),ke){if(!ke)throw Error(i(198));var c=Oe;ke=!1,Oe=null,Fe||(Fe=!0,Be=c)}}(r,t,void 0,e),e.currentTarget=null}function Os(e,t){t=!!(4&t);for(var i=0;i<e.length;i++){var s=e[i],r=s.event;s=s.listeners;e:{var n=void 0;if(t)for(var a=s.length-1;0<=a;a--){var o=s[a],l=o.instance,h=o.currentTarget;if(o=o.listener,l!==n&&r.isPropagationStopped())break e;ks(r,o,h),n=l}else for(a=0;a<s.length;a++){if(l=(o=s[a]).instance,h=o.currentTarget,o=o.listener,l!==n&&r.isPropagationStopped())break e;ks(r,o,h),n=l}}}if(Fe)throw e=Be,Fe=!1,Be=null,e}function Fs(e,t){var i=t[ur];void 0===i&&(i=t[ur]=new Set);var s=e+"__bubble";i.has(s)||(Us(t,e,2,!1),i.add(s))}function Bs(e,t,i){var s=0;t&&(s|=4),Us(i,e,s,t)}var Ns="_reactListening"+Math.random().toString(36).slice(2);function zs(e){if(!e[Ns]){e[Ns]=!0,s.forEach((function(t){"selectionchange"!==t&&(Rs.has(t)||Bs(t,!1,e),Bs(t,!0,e))}));var t=9===e.nodeType?e:e.ownerDocument;null===t||t[Ns]||(t[Ns]=!0,Bs("selectionchange",!1,t))}}function Us(e,t,i,s){switch(Kt(t)){case 1:var r=Gt;break;case 4:r=Wt;break;default:r=jt}i=r.bind(null,t,i,e),r=void 0,!Me||"touchstart"!==t&&"touchmove"!==t&&"wheel"!==t||(r=!0),s?void 0!==r?e.addEventListener(t,i,{capture:!0,passive:r}):e.addEventListener(t,i,!0):void 0!==r?e.addEventListener(t,i,{passive:r}):e.addEventListener(t,i,!1)}function Vs(e,t,i,s,r){var n=s;if(!(1&t||2&t||null===s))e:for(;;){if(null===s)return;var a=s.tag;if(3===a||4===a){var o=s.stateNode.containerInfo;if(o===r||8===o.nodeType&&o.parentNode===r)break;if(4===a)for(a=s.return;null!==a;){var l=a.tag;if((3===l||4===l)&&((l=a.stateNode.containerInfo)===r||8===l.nodeType&&l.parentNode===r))return;a=a.return}for(;null!==o;){if(null===(a=mr(o)))return;if(5===(l=a.tag)||6===l){s=n=a;continue e}o=o.parentNode}}s=s.return}De((function(){var s=n,r=be(i),a=[];e:{var o=As.get(e);if(void 0!==o){var l=oi,h=e;switch(e){case"keypress":if(0===Zt(i))break e;case"keydown":case"keyup":l=Ti;break;case"focusin":h="focus",l=fi;break;case"focusout":h="blur",l=fi;break;case"beforeblur":case"afterblur":l=fi;break;case"click":if(2===i.button)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":l=di;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":l=ui;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":l=Ei;break;case ws:case Ts:case Cs:l=pi;break;case Es:l=Ai;break;case"scroll":l=hi;break;case"wheel":l=Di;break;case"copy":case"cut":case"paste":l=gi;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":l=Ci}var c=!!(4&t),d=!c&&"scroll"===e,u=c?null!==o?o+"Capture":null:o;c=[];for(var f,p=s;null!==p;){var m=(f=p).stateNode;if(5===f.tag&&null!==m&&(f=m,null!==u&&(null!=(m=Le(p,u))&&c.push(Hs(p,m,f)))),d)break;p=p.return}0<c.length&&(o=new l(o,h,null,i,r),a.push({event:o,listeners:c}))}}if(!(7&t)){if(l="mouseout"===e||"pointerout"===e,(!(o="mouseover"===e||"pointerover"===e)||i===_e||!(h=i.relatedTarget||i.fromElement)||!mr(h)&&!h[dr])&&(l||o)&&(o=r.window===r?r:(o=r.ownerDocument)?o.defaultView||o.parentWindow:window,l?(l=s,null!==(h=(h=i.relatedTarget||i.toElement)?mr(h):null)&&(h!==(d=Ue(h))||5!==h.tag&&6!==h.tag)&&(h=null)):(l=null,h=s),l!==h)){if(c=di,m="onMouseLeave",u="onMouseEnter",p="mouse","pointerout"!==e&&"pointerover"!==e||(c=Ci,m="onPointerLeave",u="onPointerEnter",p="pointer"),d=null==l?o:vr(l),f=null==h?o:vr(h),(o=new c(m,p+"leave",l,i,r)).target=d,o.relatedTarget=f,m=null,mr(r)===s&&((c=new c(u,p+"enter",h,i,r)).target=f,c.relatedTarget=d,m=c),d=m,l&&h)e:{for(u=h,p=0,f=c=l;f;f=Ws(f))p++;for(f=0,m=u;m;m=Ws(m))f++;for(;0<p-f;)c=Ws(c),p--;for(;0<f-p;)u=Ws(u),f--;for(;p--;){if(c===u||null!==u&&c===u.alternate)break e;c=Ws(c),u=Ws(u)}c=null}else c=null;null!==l&&js(a,o,l,c,!1),null!==h&&null!==d&&js(a,d,h,c,!0)}if("select"===(l=(o=s?vr(s):window).nodeName&&o.nodeName.toLowerCase())||"input"===l&&"file"===o.type)var g=Xi;else if(Vi(o))if(Ki)g=ss;else{g=ts;var v=es}else(l=o.nodeName)&&"input"===l.toLowerCase()&&("checkbox"===o.type||"radio"===o.type)&&(g=is);switch(g&&(g=g(e,s))?Hi(a,g,i,r):(v&&v(e,o,s),"focusout"===e&&(v=o._wrapperState)&&v.controlled&&"number"===o.type&&$(o,"number",o.value)),v=s?vr(s):window,e){case"focusin":(Vi(v)||"true"===v.contentEditable)&&(fs=v,ps=s,ms=null);break;case"focusout":ms=ps=fs=null;break;case"mousedown":gs=!0;break;case"contextmenu":case"mouseup":case"dragend":gs=!1,vs(a,i,r);break;case"selectionchange":if(us)break;case"keydown":case"keyup":vs(a,i,r)}var _;if(Mi)e:{switch(e){case"compositionstart":var b="onCompositionStart";break e;case"compositionend":b="onCompositionEnd";break e;case"compositionupdate":b="onCompositionUpdate";break e}b=void 0}else zi?Bi(e,i)&&(b="onCompositionEnd"):"keydown"===e&&229===i.keyCode&&(b="onCompositionStart");b&&(ki&&"ko"!==i.locale&&(zi||"onCompositionStart"!==b?"onCompositionEnd"===b&&zi&&(_=$t()):(Qt="value"in(Yt=r)?Yt.value:Yt.textContent,zi=!0)),0<(v=Gs(s,b)).length&&(b=new vi(b,e,null,i,r),a.push({event:b,listeners:v}),_?b.data=_:null!==(_=Ni(i))&&(b.data=_))),(_=Ri?function(e,t){switch(e){case"compositionend":return Ni(t);case"keypress":return 32!==t.which?null:(Fi=!0,Oi);case"textInput":return(e=t.data)===Oi&&Fi?null:e;default:return null}}(e,i):function(e,t){if(zi)return"compositionend"===e||!Mi&&Bi(e,t)?(e=$t(),Jt=Qt=Yt=null,zi=!1,e):null;switch(e){case"paste":default:return null;case"keypress":if(!(t.ctrlKey||t.altKey||t.metaKey)||t.ctrlKey&&t.altKey){if(t.char&&1<t.char.length)return t.char;if(t.which)return String.fromCharCode(t.which)}return null;case"compositionend":return ki&&"ko"!==t.locale?null:t.data}}(e,i))&&(0<(s=Gs(s,"onBeforeInput")).length&&(r=new vi("onBeforeInput","beforeinput",null,i,r),a.push({event:r,listeners:s}),r.data=_))}Os(a,t)}))}function Hs(e,t,i){return{instance:e,listener:t,currentTarget:i}}function Gs(e,t){for(var i=t+"Capture",s=[];null!==e;){var r=e,n=r.stateNode;5===r.tag&&null!==n&&(r=n,null!=(n=Le(e,i))&&s.unshift(Hs(e,n,r)),null!=(n=Le(e,t))&&s.push(Hs(e,n,r))),e=e.return}return s}function Ws(e){if(null===e)return null;do{e=e.return}while(e&&5!==e.tag);return e||null}function js(e,t,i,s,r){for(var n=t._reactName,a=[];null!==i&&i!==s;){var o=i,l=o.alternate,h=o.stateNode;if(null!==l&&l===s)break;5===o.tag&&null!==h&&(o=h,r?null!=(l=Le(i,n))&&a.unshift(Hs(i,l,o)):r||null!=(l=Le(i,n))&&a.push(Hs(i,l,o))),i=i.return}0!==a.length&&e.push({event:t,listeners:a})}var qs=/\r\n?/g,Xs=/\u0000|\uFFFD/g;function Ks(e){return("string"==typeof e?e:""+e).replace(qs,"\n").replace(Xs,"")}function Ys(e,t,s){if(t=Ks(t),Ks(e)!==t&&s)throw Error(i(425))}function Qs(){}var Js=null,$s=null;function Zs(e,t){return"textarea"===e||"noscript"===e||"string"==typeof t.children||"number"==typeof t.children||"object"==typeof t.dangerouslySetInnerHTML&&null!==t.dangerouslySetInnerHTML&&null!=t.dangerouslySetInnerHTML.__html}var er="function"==typeof setTimeout?setTimeout:void 0,tr="function"==typeof clearTimeout?clearTimeout:void 0,ir="function"==typeof Promise?Promise:void 0,sr="function"==typeof queueMicrotask?queueMicrotask:void 0!==ir?function(e){return ir.resolve(null).then(e).catch(rr)}:er;function rr(e){setTimeout((function(){throw e}))}function nr(e,t){var i=t,s=0;do{var r=i.nextSibling;if(e.removeChild(i),r&&8===r.nodeType)if("/$"===(i=r.data)){if(0===s)return e.removeChild(r),void Ut(t);s--}else"$"!==i&&"$?"!==i&&"$!"!==i||s++;i=r}while(i);Ut(t)}function ar(e){for(;null!=e;e=e.nextSibling){var t=e.nodeType;if(1===t||3===t)break;if(8===t){if("$"===(t=e.data)||"$!"===t||"$?"===t)break;if("/$"===t)return null}}return e}function or(e){e=e.previousSibling;for(var t=0;e;){if(8===e.nodeType){var i=e.data;if("$"===i||"$!"===i||"$?"===i){if(0===t)return e;t--}else"/$"===i&&t++}e=e.previousSibling}return null}var lr=Math.random().toString(36).slice(2),hr="__reactFiber$"+lr,cr="__reactProps$"+lr,dr="__reactContainer$"+lr,ur="__reactEvents$"+lr,fr="__reactListeners$"+lr,pr="__reactHandles$"+lr;function mr(e){var t=e[hr];if(t)return t;for(var i=e.parentNode;i;){if(t=i[dr]||i[hr]){if(i=t.alternate,null!==t.child||null!==i&&null!==i.child)for(e=or(e);null!==e;){if(i=e[hr])return i;e=or(e)}return t}i=(e=i).parentNode}return null}function gr(e){return!(e=e[hr]||e[dr])||5!==e.tag&&6!==e.tag&&13!==e.tag&&3!==e.tag?null:e}function vr(e){if(5===e.tag||6===e.tag)return e.stateNode;throw Error(i(33))}function _r(e){return e[cr]||null}var br=[],yr=-1;function xr(e){return{current:e}}function Sr(e){0>yr||(e.current=br[yr],br[yr]=null,yr--)}function wr(e,t){yr++,br[yr]=e.current,e.current=t}var Tr={},Cr=xr(Tr),Er=xr(!1),Ar=Tr;function Pr(e,t){var i=e.type.contextTypes;if(!i)return Tr;var s=e.stateNode;if(s&&s.__reactInternalMemoizedUnmaskedChildContext===t)return s.__reactInternalMemoizedMaskedChildContext;var r,n={};for(r in i)n[r]=t[r];return s&&((e=e.stateNode).__reactInternalMemoizedUnmaskedChildContext=t,e.__reactInternalMemoizedMaskedChildContext=n),n}function Dr(e){return null!=(e=e.childContextTypes)}function Lr(){Sr(Er),Sr(Cr)}function Mr(e,t,s){if(Cr.current!==Tr)throw Error(i(168));wr(Cr,t),wr(Er,s)}function Ir(e,t,s){var r=e.stateNode;if(t=t.childContextTypes,"function"!=typeof r.getChildContext)return s;for(var n in r=r.getChildContext())if(!(n in t))throw Error(i(108,V(e)||"Unknown",n));return O({},s,r)}function Rr(e){return e=(e=e.stateNode)&&e.__reactInternalMemoizedMergedChildContext||Tr,Ar=Cr.current,wr(Cr,e),wr(Er,Er.current),!0}function kr(e,t,s){var r=e.stateNode;if(!r)throw Error(i(169));s?(e=Ir(e,t,Ar),r.__reactInternalMemoizedMergedChildContext=e,Sr(Er),Sr(Cr),wr(Cr,e)):Sr(Er),wr(Er,s)}var Or=null,Fr=!1,Br=!1;function Nr(e){null===Or?Or=[e]:Or.push(e)}function zr(){if(!Br&&null!==Or){Br=!0;var e=0,t=vt;try{var i=Or;for(vt=1;e<i.length;e++){var s=i[e];do{s=s(!0)}while(null!==s)}Or=null,Fr=!1}catch(t){throw null!==Or&&(Or=Or.slice(e+1)),je(Je,zr),t}finally{vt=t,Br=!1}}return null}var Ur=[],Vr=0,Hr=null,Gr=0,Wr=[],jr=0,qr=null,Xr=1,Kr="";function Yr(e,t){Ur[Vr++]=Gr,Ur[Vr++]=Hr,Hr=e,Gr=t}function Qr(e,t,i){Wr[jr++]=Xr,Wr[jr++]=Kr,Wr[jr++]=qr,qr=e;var s=Xr;e=Kr;var r=32-rt(s)-1;s&=~(1<<r),i+=1;var n=32-rt(t)+r;if(30<n){var a=r-r%5;n=(s&(1<<a)-1).toString(32),s>>=a,r-=a,Xr=1<<32-rt(t)+r|i<<r|s,Kr=n+e}else Xr=1<<n|i<<r|s,Kr=e}function Jr(e){null!==e.return&&(Yr(e,1),Qr(e,1,0))}function $r(e){for(;e===Hr;)Hr=Ur[--Vr],Ur[Vr]=null,Gr=Ur[--Vr],Ur[Vr]=null;for(;e===qr;)qr=Wr[--jr],Wr[jr]=null,Kr=Wr[--jr],Wr[jr]=null,Xr=Wr[--jr],Wr[jr]=null}var Zr=null,en=null,tn=!1,sn=null;function rn(e,t){var i=Dh(5,null,null,0);i.elementType="DELETED",i.stateNode=t,i.return=e,null===(t=e.deletions)?(e.deletions=[i],e.flags|=16):t.push(i)}function nn(e,t){switch(e.tag){case 5:var i=e.type;return null!==(t=1!==t.nodeType||i.toLowerCase()!==t.nodeName.toLowerCase()?null:t)&&(e.stateNode=t,Zr=e,en=ar(t.firstChild),!0);case 6:return null!==(t=""===e.pendingProps||3!==t.nodeType?null:t)&&(e.stateNode=t,Zr=e,en=null,!0);case 13:return null!==(t=8!==t.nodeType?null:t)&&(i=null!==qr?{id:Xr,overflow:Kr}:null,e.memoizedState={dehydrated:t,treeContext:i,retryLane:1073741824},(i=Dh(18,null,null,0)).stateNode=t,i.return=e,e.child=i,Zr=e,en=null,!0);default:return!1}}function an(e){return!(!(1&e.mode)||128&e.flags)}function on(e){if(tn){var t=en;if(t){var s=t;if(!nn(e,t)){if(an(e))throw Error(i(418));t=ar(s.nextSibling);var r=Zr;t&&nn(e,t)?rn(r,s):(e.flags=-4097&e.flags|2,tn=!1,Zr=e)}}else{if(an(e))throw Error(i(418));e.flags=-4097&e.flags|2,tn=!1,Zr=e}}}function ln(e){for(e=e.return;null!==e&&5!==e.tag&&3!==e.tag&&13!==e.tag;)e=e.return;Zr=e}function hn(e){if(e!==Zr)return!1;if(!tn)return ln(e),tn=!0,!1;var t;if((t=3!==e.tag)&&!(t=5!==e.tag)&&(t="head"!==(t=e.type)&&"body"!==t&&!Zs(e.type,e.memoizedProps)),t&&(t=en)){if(an(e))throw cn(),Error(i(418));for(;t;)rn(e,t),t=ar(t.nextSibling)}if(ln(e),13===e.tag){if(!(e=null!==(e=e.memoizedState)?e.dehydrated:null))throw Error(i(317));e:{for(e=e.nextSibling,t=0;e;){if(8===e.nodeType){var s=e.data;if("/$"===s){if(0===t){en=ar(e.nextSibling);break e}t--}else"$"!==s&&"$!"!==s&&"$?"!==s||t++}e=e.nextSibling}en=null}}else en=Zr?ar(e.stateNode.nextSibling):null;return!0}function cn(){for(var e=en;e;)e=ar(e.nextSibling)}function dn(){en=Zr=null,tn=!1}function un(e){null===sn?sn=[e]:sn.push(e)}var fn=_.ReactCurrentBatchConfig;function pn(e,t,s){if(null!==(e=s.ref)&&"function"!=typeof e&&"object"!=typeof e){if(s._owner){if(s=s._owner){if(1!==s.tag)throw Error(i(309));var r=s.stateNode}if(!r)throw Error(i(147,e));var n=r,a=""+e;return null!==t&&null!==t.ref&&"function"==typeof t.ref&&t.ref._stringRef===a?t.ref:(t=function(e){var t=n.refs;null===e?delete t[a]:t[a]=e},t._stringRef=a,t)}if("string"!=typeof e)throw Error(i(284));if(!s._owner)throw Error(i(290,e))}return e}function mn(e,t){throw e=Object.prototype.toString.call(t),Error(i(31,"[object Object]"===e?"object with keys {"+Object.keys(t).join(", ")+"}":e))}function gn(e){return(0,e._init)(e._payload)}function vn(e){function t(t,i){if(e){var s=t.deletions;null===s?(t.deletions=[i],t.flags|=16):s.push(i)}}function s(i,s){if(!e)return null;for(;null!==s;)t(i,s),s=s.sibling;return null}function r(e,t){for(e=new Map;null!==t;)null!==t.key?e.set(t.key,t):e.set(t.index,t),t=t.sibling;return e}function n(e,t){return(e=Mh(e,t)).index=0,e.sibling=null,e}function a(t,i,s){return t.index=s,e?null!==(s=t.alternate)?(s=s.index)<i?(t.flags|=2,i):s:(t.flags|=2,i):(t.flags|=1048576,i)}function o(t){return e&&null===t.alternate&&(t.flags|=2),t}function l(e,t,i,s){return null===t||6!==t.tag?((t=Oh(i,e.mode,s)).return=e,t):((t=n(t,i)).return=e,t)}function h(e,t,i,s){var r=i.type;return r===x?d(e,t,i.props.children,s,i.key):null!==t&&(t.elementType===r||"object"==typeof r&&null!==r&&r.$$typeof===L&&gn(r)===t.type)?((s=n(t,i.props)).ref=pn(e,t,i),s.return=e,s):((s=Ih(i.type,i.key,i.props,null,e.mode,s)).ref=pn(e,t,i),s.return=e,s)}function c(e,t,i,s){return null===t||4!==t.tag||t.stateNode.containerInfo!==i.containerInfo||t.stateNode.implementation!==i.implementation?((t=Fh(i,e.mode,s)).return=e,t):((t=n(t,i.children||[])).return=e,t)}function d(e,t,i,s,r){return null===t||7!==t.tag?((t=Rh(i,e.mode,s,r)).return=e,t):((t=n(t,i)).return=e,t)}function u(e,t,i){if("string"==typeof t&&""!==t||"number"==typeof t)return(t=Oh(""+t,e.mode,i)).return=e,t;if("object"==typeof t&&null!==t){switch(t.$$typeof){case b:return(i=Ih(t.type,t.key,t.props,null,e.mode,i)).ref=pn(e,null,t),i.return=e,i;case y:return(t=Fh(t,e.mode,i)).return=e,t;case L:return u(e,(0,t._init)(t._payload),i)}if(Z(t)||R(t))return(t=Rh(t,e.mode,i,null)).return=e,t;mn(e,t)}return null}function f(e,t,i,s){var r=null!==t?t.key:null;if("string"==typeof i&&""!==i||"number"==typeof i)return null!==r?null:l(e,t,""+i,s);if("object"==typeof i&&null!==i){switch(i.$$typeof){case b:return i.key===r?h(e,t,i,s):null;case y:return i.key===r?c(e,t,i,s):null;case L:return f(e,t,(r=i._init)(i._payload),s)}if(Z(i)||R(i))return null!==r?null:d(e,t,i,s,null);mn(e,i)}return null}function p(e,t,i,s,r){if("string"==typeof s&&""!==s||"number"==typeof s)return l(t,e=e.get(i)||null,""+s,r);if("object"==typeof s&&null!==s){switch(s.$$typeof){case b:return h(t,e=e.get(null===s.key?i:s.key)||null,s,r);case y:return c(t,e=e.get(null===s.key?i:s.key)||null,s,r);case L:return p(e,t,i,(0,s._init)(s._payload),r)}if(Z(s)||R(s))return d(t,e=e.get(i)||null,s,r,null);mn(t,s)}return null}function m(i,n,o,l){for(var h=null,c=null,d=n,m=n=0,g=null;null!==d&&m<o.length;m++){d.index>m?(g=d,d=null):g=d.sibling;var v=f(i,d,o[m],l);if(null===v){null===d&&(d=g);break}e&&d&&null===v.alternate&&t(i,d),n=a(v,n,m),null===c?h=v:c.sibling=v,c=v,d=g}if(m===o.length)return s(i,d),tn&&Yr(i,m),h;if(null===d){for(;m<o.length;m++)null!==(d=u(i,o[m],l))&&(n=a(d,n,m),null===c?h=d:c.sibling=d,c=d);return tn&&Yr(i,m),h}for(d=r(i,d);m<o.length;m++)null!==(g=p(d,i,m,o[m],l))&&(e&&null!==g.alternate&&d.delete(null===g.key?m:g.key),n=a(g,n,m),null===c?h=g:c.sibling=g,c=g);return e&&d.forEach((function(e){return t(i,e)})),tn&&Yr(i,m),h}function g(n,o,l,h){var c=R(l);if("function"!=typeof c)throw Error(i(150));if(null==(l=c.call(l)))throw Error(i(151));for(var d=c=null,m=o,g=o=0,v=null,_=l.next();null!==m&&!_.done;g++,_=l.next()){m.index>g?(v=m,m=null):v=m.sibling;var b=f(n,m,_.value,h);if(null===b){null===m&&(m=v);break}e&&m&&null===b.alternate&&t(n,m),o=a(b,o,g),null===d?c=b:d.sibling=b,d=b,m=v}if(_.done)return s(n,m),tn&&Yr(n,g),c;if(null===m){for(;!_.done;g++,_=l.next())null!==(_=u(n,_.value,h))&&(o=a(_,o,g),null===d?c=_:d.sibling=_,d=_);return tn&&Yr(n,g),c}for(m=r(n,m);!_.done;g++,_=l.next())null!==(_=p(m,n,g,_.value,h))&&(e&&null!==_.alternate&&m.delete(null===_.key?g:_.key),o=a(_,o,g),null===d?c=_:d.sibling=_,d=_);return e&&m.forEach((function(e){return t(n,e)})),tn&&Yr(n,g),c}return function e(i,r,a,l){if("object"==typeof a&&null!==a&&a.type===x&&null===a.key&&(a=a.props.children),"object"==typeof a&&null!==a){switch(a.$$typeof){case b:e:{for(var h=a.key,c=r;null!==c;){if(c.key===h){if((h=a.type)===x){if(7===c.tag){s(i,c.sibling),(r=n(c,a.props.children)).return=i,i=r;break e}}else if(c.elementType===h||"object"==typeof h&&null!==h&&h.$$typeof===L&&gn(h)===c.type){s(i,c.sibling),(r=n(c,a.props)).ref=pn(i,c,a),r.return=i,i=r;break e}s(i,c);break}t(i,c),c=c.sibling}a.type===x?((r=Rh(a.props.children,i.mode,l,a.key)).return=i,i=r):((l=Ih(a.type,a.key,a.props,null,i.mode,l)).ref=pn(i,r,a),l.return=i,i=l)}return o(i);case y:e:{for(c=a.key;null!==r;){if(r.key===c){if(4===r.tag&&r.stateNode.containerInfo===a.containerInfo&&r.stateNode.implementation===a.implementation){s(i,r.sibling),(r=n(r,a.children||[])).return=i,i=r;break e}s(i,r);break}t(i,r),r=r.sibling}(r=Fh(a,i.mode,l)).return=i,i=r}return o(i);case L:return e(i,r,(c=a._init)(a._payload),l)}if(Z(a))return m(i,r,a,l);if(R(a))return g(i,r,a,l);mn(i,a)}return"string"==typeof a&&""!==a||"number"==typeof a?(a=""+a,null!==r&&6===r.tag?(s(i,r.sibling),(r=n(r,a)).return=i,i=r):(s(i,r),(r=Oh(a,i.mode,l)).return=i,i=r),o(i)):s(i,r)}}var _n=vn(!0),bn=vn(!1),yn=xr(null),xn=null,Sn=null,wn=null;function Tn(){wn=Sn=xn=null}function Cn(e){var t=yn.current;Sr(yn),e._currentValue=t}function En(e,t,i){for(;null!==e;){var s=e.alternate;if((e.childLanes&t)!==t?(e.childLanes|=t,null!==s&&(s.childLanes|=t)):null!==s&&(s.childLanes&t)!==t&&(s.childLanes|=t),e===i)break;e=e.return}}function An(e,t){xn=e,wn=Sn=null,null!==(e=e.dependencies)&&null!==e.firstContext&&(!!(e.lanes&t)&&(vo=!0),e.firstContext=null)}function Pn(e){var t=e._currentValue;if(wn!==e)if(e={context:e,memoizedValue:t,next:null},null===Sn){if(null===xn)throw Error(i(308));Sn=e,xn.dependencies={lanes:0,firstContext:e}}else Sn=Sn.next=e;return t}var Dn=null;function Ln(e){null===Dn?Dn=[e]:Dn.push(e)}function Mn(e,t,i,s){var r=t.interleaved;return null===r?(i.next=i,Ln(t)):(i.next=r.next,r.next=i),t.interleaved=i,In(e,s)}function In(e,t){e.lanes|=t;var i=e.alternate;for(null!==i&&(i.lanes|=t),i=e,e=e.return;null!==e;)e.childLanes|=t,null!==(i=e.alternate)&&(i.childLanes|=t),i=e,e=e.return;return 3===i.tag?i.stateNode:null}var Rn=!1;function kn(e){e.updateQueue={baseState:e.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,interleaved:null,lanes:0},effects:null}}function On(e,t){e=e.updateQueue,t.updateQueue===e&&(t.updateQueue={baseState:e.baseState,firstBaseUpdate:e.firstBaseUpdate,lastBaseUpdate:e.lastBaseUpdate,shared:e.shared,effects:e.effects})}function Fn(e,t){return{eventTime:e,lane:t,tag:0,payload:null,callback:null,next:null}}function Bn(e,t,i){var s=e.updateQueue;if(null===s)return null;if(s=s.shared,2&El){var r=s.pending;return null===r?t.next=t:(t.next=r.next,r.next=t),s.pending=t,In(e,i)}return null===(r=s.interleaved)?(t.next=t,Ln(s)):(t.next=r.next,r.next=t),s.interleaved=t,In(e,i)}function Nn(e,t,i){if(null!==(t=t.updateQueue)&&(t=t.shared,4194240&i)){var s=t.lanes;i|=s&=e.pendingLanes,t.lanes=i,gt(e,i)}}function zn(e,t){var i=e.updateQueue,s=e.alternate;if(null!==s&&i===(s=s.updateQueue)){var r=null,n=null;if(null!==(i=i.firstBaseUpdate)){do{var a={eventTime:i.eventTime,lane:i.lane,tag:i.tag,payload:i.payload,callback:i.callback,next:null};null===n?r=n=a:n=n.next=a,i=i.next}while(null!==i);null===n?r=n=t:n=n.next=t}else r=n=t;return i={baseState:s.baseState,firstBaseUpdate:r,lastBaseUpdate:n,shared:s.shared,effects:s.effects},void(e.updateQueue=i)}null===(e=i.lastBaseUpdate)?i.firstBaseUpdate=t:e.next=t,i.lastBaseUpdate=t}function Un(e,t,i,s){var r=e.updateQueue;Rn=!1;var n=r.firstBaseUpdate,a=r.lastBaseUpdate,o=r.shared.pending;if(null!==o){r.shared.pending=null;var l=o,h=l.next;l.next=null,null===a?n=h:a.next=h,a=l;var c=e.alternate;null!==c&&((o=(c=c.updateQueue).lastBaseUpdate)!==a&&(null===o?c.firstBaseUpdate=h:o.next=h,c.lastBaseUpdate=l))}if(null!==n){var d=r.baseState;for(a=0,c=h=l=null,o=n;;){var u=o.lane,f=o.eventTime;if((s&u)===u){null!==c&&(c=c.next={eventTime:f,lane:0,tag:o.tag,payload:o.payload,callback:o.callback,next:null});e:{var p=e,m=o;switch(u=t,f=i,m.tag){case 1:if("function"==typeof(p=m.payload)){d=p.call(f,d,u);break e}d=p;break e;case 3:p.flags=-65537&p.flags|128;case 0:if(null==(u="function"==typeof(p=m.payload)?p.call(f,d,u):p))break e;d=O({},d,u);break e;case 2:Rn=!0}}null!==o.callback&&0!==o.lane&&(e.flags|=64,null===(u=r.effects)?r.effects=[o]:u.push(o))}else f={eventTime:f,lane:u,tag:o.tag,payload:o.payload,callback:o.callback,next:null},null===c?(h=c=f,l=d):c=c.next=f,a|=u;if(null===(o=o.next)){if(null===(o=r.shared.pending))break;o=(u=o).next,u.next=null,r.lastBaseUpdate=u,r.shared.pending=null}}if(null===c&&(l=d),r.baseState=l,r.firstBaseUpdate=h,r.lastBaseUpdate=c,null!==(t=r.shared.interleaved)){r=t;do{a|=r.lane,r=r.next}while(r!==t)}else null===n&&(r.shared.lanes=0);kl|=a,e.lanes=a,e.memoizedState=d}}function Vn(e,t,s){if(e=t.effects,t.effects=null,null!==e)for(t=0;t<e.length;t++){var r=e[t],n=r.callback;if(null!==n){if(r.callback=null,r=s,"function"!=typeof n)throw Error(i(191,n));n.call(r)}}}var Hn={},Gn=xr(Hn),Wn=xr(Hn),jn=xr(Hn);function qn(e){if(e===Hn)throw Error(i(174));return e}function Xn(e,t){switch(wr(jn,t),wr(Wn,e),wr(Gn,Hn),e=t.nodeType){case 9:case 11:t=(t=t.documentElement)?t.namespaceURI:ae(null,"");break;default:t=ae(t=(e=8===e?t.parentNode:t).namespaceURI||null,e=e.tagName)}Sr(Gn),wr(Gn,t)}function Kn(){Sr(Gn),Sr(Wn),Sr(jn)}function Yn(e){qn(jn.current);var t=qn(Gn.current),i=ae(t,e.type);t!==i&&(wr(Wn,e),wr(Gn,i))}function Qn(e){Wn.current===e&&(Sr(Gn),Sr(Wn))}var Jn=xr(0);function $n(e){for(var t=e;null!==t;){if(13===t.tag){var i=t.memoizedState;if(null!==i&&(null===(i=i.dehydrated)||"$?"===i.data||"$!"===i.data))return t}else if(19===t.tag&&void 0!==t.memoizedProps.revealOrder){if(128&t.flags)return t}else if(null!==t.child){t.child.return=t,t=t.child;continue}if(t===e)break;for(;null===t.sibling;){if(null===t.return||t.return===e)return null;t=t.return}t.sibling.return=t.return,t=t.sibling}return null}var Zn=[];function ea(){for(var e=0;e<Zn.length;e++)Zn[e]._workInProgressVersionPrimary=null;Zn.length=0}var ta=_.ReactCurrentDispatcher,ia=_.ReactCurrentBatchConfig,sa=0,ra=null,na=null,aa=null,oa=!1,la=!1,ha=0,ca=0;function da(){throw Error(i(321))}function ua(e,t){if(null===t)return!1;for(var i=0;i<t.length&&i<e.length;i++)if(!rs(e[i],t[i]))return!1;return!0}function fa(e,t,s,r,n,a){if(sa=a,ra=t,t.memoizedState=null,t.updateQueue=null,t.lanes=0,ta.current=null===e||null===e.memoizedState?Qa:Ja,e=s(r,n),la){a=0;do{if(la=!1,ha=0,25<=a)throw Error(i(301));a+=1,aa=na=null,t.updateQueue=null,ta.current=$a,e=s(r,n)}while(la)}if(ta.current=Ya,t=null!==na&&null!==na.next,sa=0,aa=na=ra=null,oa=!1,t)throw Error(i(300));return e}function pa(){var e=0!==ha;return ha=0,e}function ma(){var e={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return null===aa?ra.memoizedState=aa=e:aa=aa.next=e,aa}function ga(){if(null===na){var e=ra.alternate;e=null!==e?e.memoizedState:null}else e=na.next;var t=null===aa?ra.memoizedState:aa.next;if(null!==t)aa=t,na=e;else{if(null===e)throw Error(i(310));e={memoizedState:(na=e).memoizedState,baseState:na.baseState,baseQueue:na.baseQueue,queue:na.queue,next:null},null===aa?ra.memoizedState=aa=e:aa=aa.next=e}return aa}function va(e,t){return"function"==typeof t?t(e):t}function _a(e){var t=ga(),s=t.queue;if(null===s)throw Error(i(311));s.lastRenderedReducer=e;var r=na,n=r.baseQueue,a=s.pending;if(null!==a){if(null!==n){var o=n.next;n.next=a.next,a.next=o}r.baseQueue=n=a,s.pending=null}if(null!==n){a=n.next,r=r.baseState;var l=o=null,h=null,c=a;do{var d=c.lane;if((sa&d)===d)null!==h&&(h=h.next={lane:0,action:c.action,hasEagerState:c.hasEagerState,eagerState:c.eagerState,next:null}),r=c.hasEagerState?c.eagerState:e(r,c.action);else{var u={lane:d,action:c.action,hasEagerState:c.hasEagerState,eagerState:c.eagerState,next:null};null===h?(l=h=u,o=r):h=h.next=u,ra.lanes|=d,kl|=d}c=c.next}while(null!==c&&c!==a);null===h?o=r:h.next=l,rs(r,t.memoizedState)||(vo=!0),t.memoizedState=r,t.baseState=o,t.baseQueue=h,s.lastRenderedState=r}if(null!==(e=s.interleaved)){n=e;do{a=n.lane,ra.lanes|=a,kl|=a,n=n.next}while(n!==e)}else null===n&&(s.lanes=0);return[t.memoizedState,s.dispatch]}function ba(e){var t=ga(),s=t.queue;if(null===s)throw Error(i(311));s.lastRenderedReducer=e;var r=s.dispatch,n=s.pending,a=t.memoizedState;if(null!==n){s.pending=null;var o=n=n.next;do{a=e(a,o.action),o=o.next}while(o!==n);rs(a,t.memoizedState)||(vo=!0),t.memoizedState=a,null===t.baseQueue&&(t.baseState=a),s.lastRenderedState=a}return[a,r]}function ya(){}function xa(e,t){var s=ra,r=ga(),n=t(),a=!rs(r.memoizedState,n);if(a&&(r.memoizedState=n,vo=!0),r=r.queue,Ra(Ta.bind(null,s,r,e),[e]),r.getSnapshot!==t||a||null!==aa&&1&aa.memoizedState.tag){if(s.flags|=2048,Pa(9,wa.bind(null,s,r,n,t),void 0,null),null===Al)throw Error(i(349));30&sa||Sa(s,t,n)}return n}function Sa(e,t,i){e.flags|=16384,e={getSnapshot:t,value:i},null===(t=ra.updateQueue)?(t={lastEffect:null,stores:null},ra.updateQueue=t,t.stores=[e]):null===(i=t.stores)?t.stores=[e]:i.push(e)}function wa(e,t,i,s){t.value=i,t.getSnapshot=s,Ca(t)&&Ea(e)}function Ta(e,t,i){return i((function(){Ca(t)&&Ea(e)}))}function Ca(e){var t=e.getSnapshot;e=e.value;try{var i=t();return!rs(e,i)}catch(e){return!0}}function Ea(e){var t=In(e,1);null!==t&&eh(t,e,1,-1)}function Aa(e){var t=ma();return"function"==typeof e&&(e=e()),t.memoizedState=t.baseState=e,e={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:va,lastRenderedState:e},t.queue=e,e=e.dispatch=ja.bind(null,ra,e),[t.memoizedState,e]}function Pa(e,t,i,s){return e={tag:e,create:t,destroy:i,deps:s,next:null},null===(t=ra.updateQueue)?(t={lastEffect:null,stores:null},ra.updateQueue=t,t.lastEffect=e.next=e):null===(i=t.lastEffect)?t.lastEffect=e.next=e:(s=i.next,i.next=e,e.next=s,t.lastEffect=e),e}function Da(){return ga().memoizedState}function La(e,t,i,s){var r=ma();ra.flags|=e,r.memoizedState=Pa(1|t,i,void 0,void 0===s?null:s)}function Ma(e,t,i,s){var r=ga();s=void 0===s?null:s;var n=void 0;if(null!==na){var a=na.memoizedState;if(n=a.destroy,null!==s&&ua(s,a.deps))return void(r.memoizedState=Pa(t,i,n,s))}ra.flags|=e,r.memoizedState=Pa(1|t,i,n,s)}function Ia(e,t){return La(8390656,8,e,t)}function Ra(e,t){return Ma(2048,8,e,t)}function ka(e,t){return Ma(4,2,e,t)}function Oa(e,t){return Ma(4,4,e,t)}function Fa(e,t){return"function"==typeof t?(e=e(),t(e),function(){t(null)}):null!=t?(e=e(),t.current=e,function(){t.current=null}):void 0}function Ba(e,t,i){return i=null!=i?i.concat([e]):null,Ma(4,4,Fa.bind(null,t,e),i)}function Na(){}function za(e,t){var i=ga();t=void 0===t?null:t;var s=i.memoizedState;return null!==s&&null!==t&&ua(t,s[1])?s[0]:(i.memoizedState=[e,t],e)}function Ua(e,t){var i=ga();t=void 0===t?null:t;var s=i.memoizedState;return null!==s&&null!==t&&ua(t,s[1])?s[0]:(e=e(),i.memoizedState=[e,t],e)}function Va(e,t,i){return 21&sa?(rs(i,t)||(i=ft(),ra.lanes|=i,kl|=i,e.baseState=!0),t):(e.baseState&&(e.baseState=!1,vo=!0),e.memoizedState=i)}function Ha(e,t){var i=vt;vt=0!==i&&4>i?i:4,e(!0);var s=ia.transition;ia.transition={};try{e(!1),t()}finally{vt=i,ia.transition=s}}function Ga(){return ga().memoizedState}function Wa(e,t,i){var s=Zl(e);if(i={lane:s,action:i,hasEagerState:!1,eagerState:null,next:null},qa(e))Xa(t,i);else if(null!==(i=Mn(e,t,i,s))){eh(i,e,s,$l()),Ka(i,t,s)}}function ja(e,t,i){var s=Zl(e),r={lane:s,action:i,hasEagerState:!1,eagerState:null,next:null};if(qa(e))Xa(t,r);else{var n=e.alternate;if(0===e.lanes&&(null===n||0===n.lanes)&&null!==(n=t.lastRenderedReducer))try{var a=t.lastRenderedState,o=n(a,i);if(r.hasEagerState=!0,r.eagerState=o,rs(o,a)){var l=t.interleaved;return null===l?(r.next=r,Ln(t)):(r.next=l.next,l.next=r),void(t.interleaved=r)}}catch(e){}null!==(i=Mn(e,t,r,s))&&(eh(i,e,s,r=$l()),Ka(i,t,s))}}function qa(e){var t=e.alternate;return e===ra||null!==t&&t===ra}function Xa(e,t){la=oa=!0;var i=e.pending;null===i?t.next=t:(t.next=i.next,i.next=t),e.pending=t}function Ka(e,t,i){if(4194240&i){var s=t.lanes;i|=s&=e.pendingLanes,t.lanes=i,gt(e,i)}}var Ya={readContext:Pn,useCallback:da,useContext:da,useEffect:da,useImperativeHandle:da,useInsertionEffect:da,useLayoutEffect:da,useMemo:da,useReducer:da,useRef:da,useState:da,useDebugValue:da,useDeferredValue:da,useTransition:da,useMutableSource:da,useSyncExternalStore:da,useId:da,unstable_isNewReconciler:!1},Qa={readContext:Pn,useCallback:function(e,t){return ma().memoizedState=[e,void 0===t?null:t],e},useContext:Pn,useEffect:Ia,useImperativeHandle:function(e,t,i){return i=null!=i?i.concat([e]):null,La(4194308,4,Fa.bind(null,t,e),i)},useLayoutEffect:function(e,t){return La(4194308,4,e,t)},useInsertionEffect:function(e,t){return La(4,2,e,t)},useMemo:function(e,t){var i=ma();return t=void 0===t?null:t,e=e(),i.memoizedState=[e,t],e},useReducer:function(e,t,i){var s=ma();return t=void 0!==i?i(t):t,s.memoizedState=s.baseState=t,e={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:e,lastRenderedState:t},s.queue=e,e=e.dispatch=Wa.bind(null,ra,e),[s.memoizedState,e]},useRef:function(e){return e={current:e},ma().memoizedState=e},useState:Aa,useDebugValue:Na,useDeferredValue:function(e){return ma().memoizedState=e},useTransition:function(){var e=Aa(!1),t=e[0];return e=Ha.bind(null,e[1]),ma().memoizedState=e,[t,e]},useMutableSource:function(){},useSyncExternalStore:function(e,t,s){var r=ra,n=ma();if(tn){if(void 0===s)throw Error(i(407));s=s()}else{if(s=t(),null===Al)throw Error(i(349));30&sa||Sa(r,t,s)}n.memoizedState=s;var a={value:s,getSnapshot:t};return n.queue=a,Ia(Ta.bind(null,r,a,e),[e]),r.flags|=2048,Pa(9,wa.bind(null,r,a,s,t),void 0,null),s},useId:function(){var e=ma(),t=Al.identifierPrefix;if(tn){var i=Kr;t=":"+t+"R"+(i=(Xr&~(1<<32-rt(Xr)-1)).toString(32)+i),0<(i=ha++)&&(t+="H"+i.toString(32)),t+=":"}else t=":"+t+"r"+(i=ca++).toString(32)+":";return e.memoizedState=t},unstable_isNewReconciler:!1},Ja={readContext:Pn,useCallback:za,useContext:Pn,useEffect:Ra,useImperativeHandle:Ba,useInsertionEffect:ka,useLayoutEffect:Oa,useMemo:Ua,useReducer:_a,useRef:Da,useState:function(){return _a(va)},useDebugValue:Na,useDeferredValue:function(e){return Va(ga(),na.memoizedState,e)},useTransition:function(){return[_a(va)[0],ga().memoizedState]},useMutableSource:ya,useSyncExternalStore:xa,useId:Ga,unstable_isNewReconciler:!1},$a={readContext:Pn,useCallback:za,useContext:Pn,useEffect:Ra,useImperativeHandle:Ba,useInsertionEffect:ka,useLayoutEffect:Oa,useMemo:Ua,useReducer:ba,useRef:Da,useState:function(){return ba(va)},useDebugValue:Na,useDeferredValue:function(e){var t=ga();return null===na?t.memoizedState=e:Va(t,na.memoizedState,e)},useTransition:function(){return[ba(va)[0],ga().memoizedState]},useMutableSource:ya,useSyncExternalStore:xa,useId:Ga,unstable_isNewReconciler:!1};function Za(e,t){if(e&&e.defaultProps){for(var i in t=O({},t),e=e.defaultProps)void 0===t[i]&&(t[i]=e[i]);return t}return t}function eo(e,t,i,s){i=null==(i=i(s,t=e.memoizedState))?t:O({},t,i),e.memoizedState=i,0===e.lanes&&(e.updateQueue.baseState=i)}var to={isMounted:function(e){return!!(e=e._reactInternals)&&Ue(e)===e},enqueueSetState:function(e,t,i){e=e._reactInternals;var s=$l(),r=Zl(e),n=Fn(s,r);n.payload=t,null!=i&&(n.callback=i),null!==(t=Bn(e,n,r))&&(eh(t,e,r,s),Nn(t,e,r))},enqueueReplaceState:function(e,t,i){e=e._reactInternals;var s=$l(),r=Zl(e),n=Fn(s,r);n.tag=1,n.payload=t,null!=i&&(n.callback=i),null!==(t=Bn(e,n,r))&&(eh(t,e,r,s),Nn(t,e,r))},enqueueForceUpdate:function(e,t){e=e._reactInternals;var i=$l(),s=Zl(e),r=Fn(i,s);r.tag=2,null!=t&&(r.callback=t),null!==(t=Bn(e,r,s))&&(eh(t,e,s,i),Nn(t,e,s))}};function io(e,t,i,s,r,n,a){return"function"==typeof(e=e.stateNode).shouldComponentUpdate?e.shouldComponentUpdate(s,n,a):!t.prototype||!t.prototype.isPureReactComponent||(!ns(i,s)||!ns(r,n))}function so(e,t,i){var s=!1,r=Tr,n=t.contextType;return"object"==typeof n&&null!==n?n=Pn(n):(r=Dr(t)?Ar:Cr.current,n=(s=null!=(s=t.contextTypes))?Pr(e,r):Tr),t=new t(i,n),e.memoizedState=null!==t.state&&void 0!==t.state?t.state:null,t.updater=to,e.stateNode=t,t._reactInternals=e,s&&((e=e.stateNode).__reactInternalMemoizedUnmaskedChildContext=r,e.__reactInternalMemoizedMaskedChildContext=n),t}function ro(e,t,i,s){e=t.state,"function"==typeof t.componentWillReceiveProps&&t.componentWillReceiveProps(i,s),"function"==typeof t.UNSAFE_componentWillReceiveProps&&t.UNSAFE_componentWillReceiveProps(i,s),t.state!==e&&to.enqueueReplaceState(t,t.state,null)}function no(e,t,i,s){var r=e.stateNode;r.props=i,r.state=e.memoizedState,r.refs={},kn(e);var n=t.contextType;"object"==typeof n&&null!==n?r.context=Pn(n):(n=Dr(t)?Ar:Cr.current,r.context=Pr(e,n)),r.state=e.memoizedState,"function"==typeof(n=t.getDerivedStateFromProps)&&(eo(e,t,n,i),r.state=e.memoizedState),"function"==typeof t.getDerivedStateFromProps||"function"==typeof r.getSnapshotBeforeUpdate||"function"!=typeof r.UNSAFE_componentWillMount&&"function"!=typeof r.componentWillMount||(t=r.state,"function"==typeof r.componentWillMount&&r.componentWillMount(),"function"==typeof r.UNSAFE_componentWillMount&&r.UNSAFE_componentWillMount(),t!==r.state&&to.enqueueReplaceState(r,r.state,null),Un(e,i,r,s),r.state=e.memoizedState),"function"==typeof r.componentDidMount&&(e.flags|=4194308)}function ao(e,t){try{var i="",s=t;do{i+=z(s),s=s.return}while(s);var r=i}catch(e){r="\nError generating stack: "+e.message+"\n"+e.stack}return{value:e,source:t,stack:r,digest:null}}function oo(e,t,i){return{value:e,source:null,stack:null!=i?i:null,digest:null!=t?t:null}}function lo(e,t){try{console.error(t.value)}catch(e){setTimeout((function(){throw e}))}}var ho="function"==typeof WeakMap?WeakMap:Map;function co(e,t,i){(i=Fn(-1,i)).tag=3,i.payload={element:null};var s=t.value;return i.callback=function(){Hl||(Hl=!0,Gl=s),lo(0,t)},i}function uo(e,t,i){(i=Fn(-1,i)).tag=3;var s=e.type.getDerivedStateFromError;if("function"==typeof s){var r=t.value;i.payload=function(){return s(r)},i.callback=function(){lo(0,t)}}var n=e.stateNode;return null!==n&&"function"==typeof n.componentDidCatch&&(i.callback=function(){lo(0,t),"function"!=typeof s&&(null===Wl?Wl=new Set([this]):Wl.add(this));var e=t.stack;this.componentDidCatch(t.value,{componentStack:null!==e?e:""})}),i}function fo(e,t,i){var s=e.pingCache;if(null===s){s=e.pingCache=new ho;var r=new Set;s.set(t,r)}else void 0===(r=s.get(t))&&(r=new Set,s.set(t,r));r.has(i)||(r.add(i),e=wh.bind(null,e,t,i),t.then(e,e))}function po(e){do{var t;if((t=13===e.tag)&&(t=null===(t=e.memoizedState)||null!==t.dehydrated),t)return e;e=e.return}while(null!==e);return null}function mo(e,t,i,s,r){return 1&e.mode?(e.flags|=65536,e.lanes=r,e):(e===t?e.flags|=65536:(e.flags|=128,i.flags|=131072,i.flags&=-52805,1===i.tag&&(null===i.alternate?i.tag=17:((t=Fn(-1,1)).tag=2,Bn(i,t,1))),i.lanes|=1),e)}var go=_.ReactCurrentOwner,vo=!1;function _o(e,t,i,s){t.child=null===e?bn(t,null,i,s):_n(t,e.child,i,s)}function bo(e,t,i,s,r){i=i.render;var n=t.ref;return An(t,r),s=fa(e,t,i,s,n,r),i=pa(),null===e||vo?(tn&&i&&Jr(t),t.flags|=1,_o(e,t,s,r),t.child):(t.updateQueue=e.updateQueue,t.flags&=-2053,e.lanes&=~r,Ho(e,t,r))}function yo(e,t,i,s,r){if(null===e){var n=i.type;return"function"!=typeof n||Lh(n)||void 0!==n.defaultProps||null!==i.compare||void 0!==i.defaultProps?((e=Ih(i.type,null,s,t,t.mode,r)).ref=t.ref,e.return=t,t.child=e):(t.tag=15,t.type=n,xo(e,t,n,s,r))}if(n=e.child,!(e.lanes&r)){var a=n.memoizedProps;if((i=null!==(i=i.compare)?i:ns)(a,s)&&e.ref===t.ref)return Ho(e,t,r)}return t.flags|=1,(e=Mh(n,s)).ref=t.ref,e.return=t,t.child=e}function xo(e,t,i,s,r){if(null!==e){var n=e.memoizedProps;if(ns(n,s)&&e.ref===t.ref){if(vo=!1,t.pendingProps=s=n,!(e.lanes&r))return t.lanes=e.lanes,Ho(e,t,r);131072&e.flags&&(vo=!0)}}return To(e,t,i,s,r)}function So(e,t,i){var s=t.pendingProps,r=s.children,n=null!==e?e.memoizedState:null;if("hidden"===s.mode)if(1&t.mode){if(!(1073741824&i))return e=null!==n?n.baseLanes|i:i,t.lanes=t.childLanes=1073741824,t.memoizedState={baseLanes:e,cachePool:null,transitions:null},t.updateQueue=null,wr(Ml,Ll),Ll|=e,null;t.memoizedState={baseLanes:0,cachePool:null,transitions:null},s=null!==n?n.baseLanes:i,wr(Ml,Ll),Ll|=s}else t.memoizedState={baseLanes:0,cachePool:null,transitions:null},wr(Ml,Ll),Ll|=i;else null!==n?(s=n.baseLanes|i,t.memoizedState=null):s=i,wr(Ml,Ll),Ll|=s;return _o(e,t,r,i),t.child}function wo(e,t){var i=t.ref;(null===e&&null!==i||null!==e&&e.ref!==i)&&(t.flags|=512,t.flags|=2097152)}function To(e,t,i,s,r){var n=Dr(i)?Ar:Cr.current;return n=Pr(t,n),An(t,r),i=fa(e,t,i,s,n,r),s=pa(),null===e||vo?(tn&&s&&Jr(t),t.flags|=1,_o(e,t,i,r),t.child):(t.updateQueue=e.updateQueue,t.flags&=-2053,e.lanes&=~r,Ho(e,t,r))}function Co(e,t,i,s,r){if(Dr(i)){var n=!0;Rr(t)}else n=!1;if(An(t,r),null===t.stateNode)Vo(e,t),so(t,i,s),no(t,i,s,r),s=!0;else if(null===e){var a=t.stateNode,o=t.memoizedProps;a.props=o;var l=a.context,h=i.contextType;"object"==typeof h&&null!==h?h=Pn(h):h=Pr(t,h=Dr(i)?Ar:Cr.current);var c=i.getDerivedStateFromProps,d="function"==typeof c||"function"==typeof a.getSnapshotBeforeUpdate;d||"function"!=typeof a.UNSAFE_componentWillReceiveProps&&"function"!=typeof a.componentWillReceiveProps||(o!==s||l!==h)&&ro(t,a,s,h),Rn=!1;var u=t.memoizedState;a.state=u,Un(t,s,a,r),l=t.memoizedState,o!==s||u!==l||Er.current||Rn?("function"==typeof c&&(eo(t,i,c,s),l=t.memoizedState),(o=Rn||io(t,i,o,s,u,l,h))?(d||"function"!=typeof a.UNSAFE_componentWillMount&&"function"!=typeof a.componentWillMount||("function"==typeof a.componentWillMount&&a.componentWillMount(),"function"==typeof a.UNSAFE_componentWillMount&&a.UNSAFE_componentWillMount()),"function"==typeof a.componentDidMount&&(t.flags|=4194308)):("function"==typeof a.componentDidMount&&(t.flags|=4194308),t.memoizedProps=s,t.memoizedState=l),a.props=s,a.state=l,a.context=h,s=o):("function"==typeof a.componentDidMount&&(t.flags|=4194308),s=!1)}else{a=t.stateNode,On(e,t),o=t.memoizedProps,h=t.type===t.elementType?o:Za(t.type,o),a.props=h,d=t.pendingProps,u=a.context,"object"==typeof(l=i.contextType)&&null!==l?l=Pn(l):l=Pr(t,l=Dr(i)?Ar:Cr.current);var f=i.getDerivedStateFromProps;(c="function"==typeof f||"function"==typeof a.getSnapshotBeforeUpdate)||"function"!=typeof a.UNSAFE_componentWillReceiveProps&&"function"!=typeof a.componentWillReceiveProps||(o!==d||u!==l)&&ro(t,a,s,l),Rn=!1,u=t.memoizedState,a.state=u,Un(t,s,a,r);var p=t.memoizedState;o!==d||u!==p||Er.current||Rn?("function"==typeof f&&(eo(t,i,f,s),p=t.memoizedState),(h=Rn||io(t,i,h,s,u,p,l)||!1)?(c||"function"!=typeof a.UNSAFE_componentWillUpdate&&"function"!=typeof a.componentWillUpdate||("function"==typeof a.componentWillUpdate&&a.componentWillUpdate(s,p,l),"function"==typeof a.UNSAFE_componentWillUpdate&&a.UNSAFE_componentWillUpdate(s,p,l)),"function"==typeof a.componentDidUpdate&&(t.flags|=4),"function"==typeof a.getSnapshotBeforeUpdate&&(t.flags|=1024)):("function"!=typeof a.componentDidUpdate||o===e.memoizedProps&&u===e.memoizedState||(t.flags|=4),"function"!=typeof a.getSnapshotBeforeUpdate||o===e.memoizedProps&&u===e.memoizedState||(t.flags|=1024),t.memoizedProps=s,t.memoizedState=p),a.props=s,a.state=p,a.context=l,s=h):("function"!=typeof a.componentDidUpdate||o===e.memoizedProps&&u===e.memoizedState||(t.flags|=4),"function"!=typeof a.getSnapshotBeforeUpdate||o===e.memoizedProps&&u===e.memoizedState||(t.flags|=1024),s=!1)}return Eo(e,t,i,s,n,r)}function Eo(e,t,i,s,r,n){wo(e,t);var a=!!(128&t.flags);if(!s&&!a)return r&&kr(t,i,!1),Ho(e,t,n);s=t.stateNode,go.current=t;var o=a&&"function"!=typeof i.getDerivedStateFromError?null:s.render();return t.flags|=1,null!==e&&a?(t.child=_n(t,e.child,null,n),t.child=_n(t,null,o,n)):_o(e,t,o,n),t.memoizedState=s.state,r&&kr(t,i,!0),t.child}function Ao(e){var t=e.stateNode;t.pendingContext?Mr(0,t.pendingContext,t.pendingContext!==t.context):t.context&&Mr(0,t.context,!1),Xn(e,t.containerInfo)}function Po(e,t,i,s,r){return dn(),un(r),t.flags|=256,_o(e,t,i,s),t.child}var Do,Lo,Mo,Io,Ro={dehydrated:null,treeContext:null,retryLane:0};function ko(e){return{baseLanes:e,cachePool:null,transitions:null}}function Oo(e,t,s){var r,n=t.pendingProps,a=Jn.current,o=!1,l=!!(128&t.flags);if((r=l)||(r=(null===e||null!==e.memoizedState)&&!!(2&a)),r?(o=!0,t.flags&=-129):null!==e&&null===e.memoizedState||(a|=1),wr(Jn,1&a),null===e)return on(t),null!==(e=t.memoizedState)&&null!==(e=e.dehydrated)?(1&t.mode?"$!"===e.data?t.lanes=8:t.lanes=1073741824:t.lanes=1,null):(l=n.children,e=n.fallback,o?(n=t.mode,o=t.child,l={mode:"hidden",children:l},1&n||null===o?o=kh(l,n,0,null):(o.childLanes=0,o.pendingProps=l),e=Rh(e,n,s,null),o.return=t,e.return=t,o.sibling=e,t.child=o,t.child.memoizedState=ko(s),t.memoizedState=Ro,e):Fo(t,l));if(null!==(a=e.memoizedState)&&null!==(r=a.dehydrated))return function(e,t,s,r,n,a,o){if(s)return 256&t.flags?(t.flags&=-257,Bo(e,t,o,r=oo(Error(i(422))))):null!==t.memoizedState?(t.child=e.child,t.flags|=128,null):(a=r.fallback,n=t.mode,r=kh({mode:"visible",children:r.children},n,0,null),(a=Rh(a,n,o,null)).flags|=2,r.return=t,a.return=t,r.sibling=a,t.child=r,1&t.mode&&_n(t,e.child,null,o),t.child.memoizedState=ko(o),t.memoizedState=Ro,a);if(!(1&t.mode))return Bo(e,t,o,null);if("$!"===n.data){if(r=n.nextSibling&&n.nextSibling.dataset)var l=r.dgst;return r=l,Bo(e,t,o,r=oo(a=Error(i(419)),r,void 0))}if(l=!!(o&e.childLanes),vo||l){if(null!==(r=Al)){switch(o&-o){case 4:n=2;break;case 16:n=8;break;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:n=32;break;case 536870912:n=268435456;break;default:n=0}0!==(n=n&(r.suspendedLanes|o)?0:n)&&n!==a.retryLane&&(a.retryLane=n,In(e,n),eh(r,e,n,-1))}return fh(),Bo(e,t,o,r=oo(Error(i(421))))}return"$?"===n.data?(t.flags|=128,t.child=e.child,t=Ch.bind(null,e),n._reactRetry=t,null):(e=a.treeContext,en=ar(n.nextSibling),Zr=t,tn=!0,sn=null,null!==e&&(Wr[jr++]=Xr,Wr[jr++]=Kr,Wr[jr++]=qr,Xr=e.id,Kr=e.overflow,qr=t),t=Fo(t,r.children),t.flags|=4096,t)}(e,t,l,n,r,a,s);if(o){o=n.fallback,l=t.mode,r=(a=e.child).sibling;var h={mode:"hidden",children:n.children};return 1&l||t.child===a?(n=Mh(a,h)).subtreeFlags=14680064&a.subtreeFlags:((n=t.child).childLanes=0,n.pendingProps=h,t.deletions=null),null!==r?o=Mh(r,o):(o=Rh(o,l,s,null)).flags|=2,o.return=t,n.return=t,n.sibling=o,t.child=n,n=o,o=t.child,l=null===(l=e.child.memoizedState)?ko(s):{baseLanes:l.baseLanes|s,cachePool:null,transitions:l.transitions},o.memoizedState=l,o.childLanes=e.childLanes&~s,t.memoizedState=Ro,n}return e=(o=e.child).sibling,n=Mh(o,{mode:"visible",children:n.children}),!(1&t.mode)&&(n.lanes=s),n.return=t,n.sibling=null,null!==e&&(null===(s=t.deletions)?(t.deletions=[e],t.flags|=16):s.push(e)),t.child=n,t.memoizedState=null,n}function Fo(e,t){return(t=kh({mode:"visible",children:t},e.mode,0,null)).return=e,e.child=t}function Bo(e,t,i,s){return null!==s&&un(s),_n(t,e.child,null,i),(e=Fo(t,t.pendingProps.children)).flags|=2,t.memoizedState=null,e}function No(e,t,i){e.lanes|=t;var s=e.alternate;null!==s&&(s.lanes|=t),En(e.return,t,i)}function zo(e,t,i,s,r){var n=e.memoizedState;null===n?e.memoizedState={isBackwards:t,rendering:null,renderingStartTime:0,last:s,tail:i,tailMode:r}:(n.isBackwards=t,n.rendering=null,n.renderingStartTime=0,n.last=s,n.tail=i,n.tailMode=r)}function Uo(e,t,i){var s=t.pendingProps,r=s.revealOrder,n=s.tail;if(_o(e,t,s.children,i),2&(s=Jn.current))s=1&s|2,t.flags|=128;else{if(null!==e&&128&e.flags)e:for(e=t.child;null!==e;){if(13===e.tag)null!==e.memoizedState&&No(e,i,t);else if(19===e.tag)No(e,i,t);else if(null!==e.child){e.child.return=e,e=e.child;continue}if(e===t)break e;for(;null===e.sibling;){if(null===e.return||e.return===t)break e;e=e.return}e.sibling.return=e.return,e=e.sibling}s&=1}if(wr(Jn,s),1&t.mode)switch(r){case"forwards":for(i=t.child,r=null;null!==i;)null!==(e=i.alternate)&&null===$n(e)&&(r=i),i=i.sibling;null===(i=r)?(r=t.child,t.child=null):(r=i.sibling,i.sibling=null),zo(t,!1,r,i,n);break;case"backwards":for(i=null,r=t.child,t.child=null;null!==r;){if(null!==(e=r.alternate)&&null===$n(e)){t.child=r;break}e=r.sibling,r.sibling=i,i=r,r=e}zo(t,!0,i,null,n);break;case"together":zo(t,!1,null,null,void 0);break;default:t.memoizedState=null}else t.memoizedState=null;return t.child}function Vo(e,t){!(1&t.mode)&&null!==e&&(e.alternate=null,t.alternate=null,t.flags|=2)}function Ho(e,t,s){if(null!==e&&(t.dependencies=e.dependencies),kl|=t.lanes,!(s&t.childLanes))return null;if(null!==e&&t.child!==e.child)throw Error(i(153));if(null!==t.child){for(s=Mh(e=t.child,e.pendingProps),t.child=s,s.return=t;null!==e.sibling;)e=e.sibling,(s=s.sibling=Mh(e,e.pendingProps)).return=t;s.sibling=null}return t.child}function Go(e,t){if(!tn)switch(e.tailMode){case"hidden":t=e.tail;for(var i=null;null!==t;)null!==t.alternate&&(i=t),t=t.sibling;null===i?e.tail=null:i.sibling=null;break;case"collapsed":i=e.tail;for(var s=null;null!==i;)null!==i.alternate&&(s=i),i=i.sibling;null===s?t||null===e.tail?e.tail=null:e.tail.sibling=null:s.sibling=null}}function Wo(e){var t=null!==e.alternate&&e.alternate.child===e.child,i=0,s=0;if(t)for(var r=e.child;null!==r;)i|=r.lanes|r.childLanes,s|=14680064&r.subtreeFlags,s|=14680064&r.flags,r.return=e,r=r.sibling;else for(r=e.child;null!==r;)i|=r.lanes|r.childLanes,s|=r.subtreeFlags,s|=r.flags,r.return=e,r=r.sibling;return e.subtreeFlags|=s,e.childLanes=i,t}function jo(e,t,s){var n=t.pendingProps;switch($r(t),t.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return Wo(t),null;case 1:case 17:return Dr(t.type)&&Lr(),Wo(t),null;case 3:return n=t.stateNode,Kn(),Sr(Er),Sr(Cr),ea(),n.pendingContext&&(n.context=n.pendingContext,n.pendingContext=null),null!==e&&null!==e.child||(hn(t)?t.flags|=4:null===e||e.memoizedState.isDehydrated&&!(256&t.flags)||(t.flags|=1024,null!==sn&&(rh(sn),sn=null))),Lo(e,t),Wo(t),null;case 5:Qn(t);var a=qn(jn.current);if(s=t.type,null!==e&&null!=t.stateNode)Mo(e,t,s,n,a),e.ref!==t.ref&&(t.flags|=512,t.flags|=2097152);else{if(!n){if(null===t.stateNode)throw Error(i(166));return Wo(t),null}if(e=qn(Gn.current),hn(t)){n=t.stateNode,s=t.type;var o=t.memoizedProps;switch(n[hr]=t,n[cr]=o,e=!!(1&t.mode),s){case"dialog":Fs("cancel",n),Fs("close",n);break;case"iframe":case"object":case"embed":Fs("load",n);break;case"video":case"audio":for(a=0;a<Is.length;a++)Fs(Is[a],n);break;case"source":Fs("error",n);break;case"img":case"image":case"link":Fs("error",n),Fs("load",n);break;case"details":Fs("toggle",n);break;case"input":K(n,o),Fs("invalid",n);break;case"select":n._wrapperState={wasMultiple:!!o.multiple},Fs("invalid",n);break;case"textarea":ie(n,o),Fs("invalid",n)}for(var l in ge(s,o),a=null,o)if(o.hasOwnProperty(l)){var h=o[l];"children"===l?"string"==typeof h?n.textContent!==h&&(!0!==o.suppressHydrationWarning&&Ys(n.textContent,h,e),a=["children",h]):"number"==typeof h&&n.textContent!==""+h&&(!0!==o.suppressHydrationWarning&&Ys(n.textContent,h,e),a=["children",""+h]):r.hasOwnProperty(l)&&null!=h&&"onScroll"===l&&Fs("scroll",n)}switch(s){case"input":W(n),J(n,o,!0);break;case"textarea":W(n),re(n);break;case"select":case"option":break;default:"function"==typeof o.onClick&&(n.onclick=Qs)}n=a,t.updateQueue=n,null!==n&&(t.flags|=4)}else{l=9===a.nodeType?a:a.ownerDocument,"http://www.w3.org/1999/xhtml"===e&&(e=ne(s)),"http://www.w3.org/1999/xhtml"===e?"script"===s?((e=l.createElement("div")).innerHTML="<script><\/script>",e=e.removeChild(e.firstChild)):"string"==typeof n.is?e=l.createElement(s,{is:n.is}):(e=l.createElement(s),"select"===s&&(l=e,n.multiple?l.multiple=!0:n.size&&(l.size=n.size))):e=l.createElementNS(e,s),e[hr]=t,e[cr]=n,Do(e,t,!1,!1),t.stateNode=e;e:{switch(l=ve(s,n),s){case"dialog":Fs("cancel",e),Fs("close",e),a=n;break;case"iframe":case"object":case"embed":Fs("load",e),a=n;break;case"video":case"audio":for(a=0;a<Is.length;a++)Fs(Is[a],e);a=n;break;case"source":Fs("error",e),a=n;break;case"img":case"image":case"link":Fs("error",e),Fs("load",e),a=n;break;case"details":Fs("toggle",e),a=n;break;case"input":K(e,n),a=X(e,n),Fs("invalid",e);break;case"option":default:a=n;break;case"select":e._wrapperState={wasMultiple:!!n.multiple},a=O({},n,{value:void 0}),Fs("invalid",e);break;case"textarea":ie(e,n),a=te(e,n),Fs("invalid",e)}for(o in ge(s,a),h=a)if(h.hasOwnProperty(o)){var c=h[o];"style"===o?pe(e,c):"dangerouslySetInnerHTML"===o?null!=(c=c?c.__html:void 0)&&he(e,c):"children"===o?"string"==typeof c?("textarea"!==s||""!==c)&&ce(e,c):"number"==typeof c&&ce(e,""+c):"suppressContentEditableWarning"!==o&&"suppressHydrationWarning"!==o&&"autoFocus"!==o&&(r.hasOwnProperty(o)?null!=c&&"onScroll"===o&&Fs("scroll",e):null!=c&&v(e,o,c,l))}switch(s){case"input":W(e),J(e,n,!1);break;case"textarea":W(e),re(e);break;case"option":null!=n.value&&e.setAttribute("value",""+H(n.value));break;case"select":e.multiple=!!n.multiple,null!=(o=n.value)?ee(e,!!n.multiple,o,!1):null!=n.defaultValue&&ee(e,!!n.multiple,n.defaultValue,!0);break;default:"function"==typeof a.onClick&&(e.onclick=Qs)}switch(s){case"button":case"input":case"select":case"textarea":n=!!n.autoFocus;break e;case"img":n=!0;break e;default:n=!1}}n&&(t.flags|=4)}null!==t.ref&&(t.flags|=512,t.flags|=2097152)}return Wo(t),null;case 6:if(e&&null!=t.stateNode)Io(e,t,e.memoizedProps,n);else{if("string"!=typeof n&&null===t.stateNode)throw Error(i(166));if(s=qn(jn.current),qn(Gn.current),hn(t)){if(n=t.stateNode,s=t.memoizedProps,n[hr]=t,(o=n.nodeValue!==s)&&null!==(e=Zr))switch(e.tag){case 3:Ys(n.nodeValue,s,!!(1&e.mode));break;case 5:!0!==e.memoizedProps.suppressHydrationWarning&&Ys(n.nodeValue,s,!!(1&e.mode))}o&&(t.flags|=4)}else(n=(9===s.nodeType?s:s.ownerDocument).createTextNode(n))[hr]=t,t.stateNode=n}return Wo(t),null;case 13:if(Sr(Jn),n=t.memoizedState,null===e||null!==e.memoizedState&&null!==e.memoizedState.dehydrated){if(tn&&null!==en&&1&t.mode&&!(128&t.flags))cn(),dn(),t.flags|=98560,o=!1;else if(o=hn(t),null!==n&&null!==n.dehydrated){if(null===e){if(!o)throw Error(i(318));if(!(o=null!==(o=t.memoizedState)?o.dehydrated:null))throw Error(i(317));o[hr]=t}else dn(),!(128&t.flags)&&(t.memoizedState=null),t.flags|=4;Wo(t),o=!1}else null!==sn&&(rh(sn),sn=null),o=!0;if(!o)return 65536&t.flags?t:null}return 128&t.flags?(t.lanes=s,t):((n=null!==n)!==(null!==e&&null!==e.memoizedState)&&n&&(t.child.flags|=8192,1&t.mode&&(null===e||1&Jn.current?0===Il&&(Il=3):fh())),null!==t.updateQueue&&(t.flags|=4),Wo(t),null);case 4:return Kn(),Lo(e,t),null===e&&zs(t.stateNode.containerInfo),Wo(t),null;case 10:return Cn(t.type._context),Wo(t),null;case 19:if(Sr(Jn),null===(o=t.memoizedState))return Wo(t),null;if(n=!!(128&t.flags),null===(l=o.rendering))if(n)Go(o,!1);else{if(0!==Il||null!==e&&128&e.flags)for(e=t.child;null!==e;){if(null!==(l=$n(e))){for(t.flags|=128,Go(o,!1),null!==(n=l.updateQueue)&&(t.updateQueue=n,t.flags|=4),t.subtreeFlags=0,n=s,s=t.child;null!==s;)e=n,(o=s).flags&=14680066,null===(l=o.alternate)?(o.childLanes=0,o.lanes=e,o.child=null,o.subtreeFlags=0,o.memoizedProps=null,o.memoizedState=null,o.updateQueue=null,o.dependencies=null,o.stateNode=null):(o.childLanes=l.childLanes,o.lanes=l.lanes,o.child=l.child,o.subtreeFlags=0,o.deletions=null,o.memoizedProps=l.memoizedProps,o.memoizedState=l.memoizedState,o.updateQueue=l.updateQueue,o.type=l.type,e=l.dependencies,o.dependencies=null===e?null:{lanes:e.lanes,firstContext:e.firstContext}),s=s.sibling;return wr(Jn,1&Jn.current|2),t.child}e=e.sibling}null!==o.tail&&Ye()>Ul&&(t.flags|=128,n=!0,Go(o,!1),t.lanes=4194304)}else{if(!n)if(null!==(e=$n(l))){if(t.flags|=128,n=!0,null!==(s=e.updateQueue)&&(t.updateQueue=s,t.flags|=4),Go(o,!0),null===o.tail&&"hidden"===o.tailMode&&!l.alternate&&!tn)return Wo(t),null}else 2*Ye()-o.renderingStartTime>Ul&&1073741824!==s&&(t.flags|=128,n=!0,Go(o,!1),t.lanes=4194304);o.isBackwards?(l.sibling=t.child,t.child=l):(null!==(s=o.last)?s.sibling=l:t.child=l,o.last=l)}return null!==o.tail?(t=o.tail,o.rendering=t,o.tail=t.sibling,o.renderingStartTime=Ye(),t.sibling=null,s=Jn.current,wr(Jn,n?1&s|2:1&s),t):(Wo(t),null);case 22:case 23:return hh(),n=null!==t.memoizedState,null!==e&&null!==e.memoizedState!==n&&(t.flags|=8192),n&&1&t.mode?!!(1073741824&Ll)&&(Wo(t),6&t.subtreeFlags&&(t.flags|=8192)):Wo(t),null;case 24:case 25:return null}throw Error(i(156,t.tag))}function qo(e,t){switch($r(t),t.tag){case 1:return Dr(t.type)&&Lr(),65536&(e=t.flags)?(t.flags=-65537&e|128,t):null;case 3:return Kn(),Sr(Er),Sr(Cr),ea(),65536&(e=t.flags)&&!(128&e)?(t.flags=-65537&e|128,t):null;case 5:return Qn(t),null;case 13:if(Sr(Jn),null!==(e=t.memoizedState)&&null!==e.dehydrated){if(null===t.alternate)throw Error(i(340));dn()}return 65536&(e=t.flags)?(t.flags=-65537&e|128,t):null;case 19:return Sr(Jn),null;case 4:return Kn(),null;case 10:return Cn(t.type._context),null;case 22:case 23:return hh(),null;default:return null}}Do=function(e,t){for(var i=t.child;null!==i;){if(5===i.tag||6===i.tag)e.appendChild(i.stateNode);else if(4!==i.tag&&null!==i.child){i.child.return=i,i=i.child;continue}if(i===t)break;for(;null===i.sibling;){if(null===i.return||i.return===t)return;i=i.return}i.sibling.return=i.return,i=i.sibling}},Lo=function(){},Mo=function(e,t,i,s){var n=e.memoizedProps;if(n!==s){e=t.stateNode,qn(Gn.current);var a,o=null;switch(i){case"input":n=X(e,n),s=X(e,s),o=[];break;case"select":n=O({},n,{value:void 0}),s=O({},s,{value:void 0}),o=[];break;case"textarea":n=te(e,n),s=te(e,s),o=[];break;default:"function"!=typeof n.onClick&&"function"==typeof s.onClick&&(e.onclick=Qs)}for(c in ge(i,s),i=null,n)if(!s.hasOwnProperty(c)&&n.hasOwnProperty(c)&&null!=n[c])if("style"===c){var l=n[c];for(a in l)l.hasOwnProperty(a)&&(i||(i={}),i[a]="")}else"dangerouslySetInnerHTML"!==c&&"children"!==c&&"suppressContentEditableWarning"!==c&&"suppressHydrationWarning"!==c&&"autoFocus"!==c&&(r.hasOwnProperty(c)?o||(o=[]):(o=o||[]).push(c,null));for(c in s){var h=s[c];if(l=null!=n?n[c]:void 0,s.hasOwnProperty(c)&&h!==l&&(null!=h||null!=l))if("style"===c)if(l){for(a in l)!l.hasOwnProperty(a)||h&&h.hasOwnProperty(a)||(i||(i={}),i[a]="");for(a in h)h.hasOwnProperty(a)&&l[a]!==h[a]&&(i||(i={}),i[a]=h[a])}else i||(o||(o=[]),o.push(c,i)),i=h;else"dangerouslySetInnerHTML"===c?(h=h?h.__html:void 0,l=l?l.__html:void 0,null!=h&&l!==h&&(o=o||[]).push(c,h)):"children"===c?"string"!=typeof h&&"number"!=typeof h||(o=o||[]).push(c,""+h):"suppressContentEditableWarning"!==c&&"suppressHydrationWarning"!==c&&(r.hasOwnProperty(c)?(null!=h&&"onScroll"===c&&Fs("scroll",e),o||l===h||(o=[])):(o=o||[]).push(c,h))}i&&(o=o||[]).push("style",i);var c=o;(t.updateQueue=c)&&(t.flags|=4)}},Io=function(e,t,i,s){i!==s&&(t.flags|=4)};var Xo=!1,Ko=!1,Yo="function"==typeof WeakSet?WeakSet:Set,Qo=null;function Jo(e,t){var i=e.ref;if(null!==i)if("function"==typeof i)try{i(null)}catch(i){Sh(e,t,i)}else i.current=null}function $o(e,t,i){try{i()}catch(i){Sh(e,t,i)}}var Zo=!1;function el(e,t,i){var s=t.updateQueue;if(null!==(s=null!==s?s.lastEffect:null)){var r=s=s.next;do{if((r.tag&e)===e){var n=r.destroy;r.destroy=void 0,void 0!==n&&$o(t,i,n)}r=r.next}while(r!==s)}}function tl(e,t){if(null!==(t=null!==(t=t.updateQueue)?t.lastEffect:null)){var i=t=t.next;do{if((i.tag&e)===e){var s=i.create;i.destroy=s()}i=i.next}while(i!==t)}}function il(e){var t=e.ref;if(null!==t){var i=e.stateNode;e.tag,e=i,"function"==typeof t?t(e):t.current=e}}function sl(e){var t=e.alternate;null!==t&&(e.alternate=null,sl(t)),e.child=null,e.deletions=null,e.sibling=null,5===e.tag&&(null!==(t=e.stateNode)&&(delete t[hr],delete t[cr],delete t[ur],delete t[fr],delete t[pr])),e.stateNode=null,e.return=null,e.dependencies=null,e.memoizedProps=null,e.memoizedState=null,e.pendingProps=null,e.stateNode=null,e.updateQueue=null}function rl(e){return 5===e.tag||3===e.tag||4===e.tag}function nl(e){e:for(;;){for(;null===e.sibling;){if(null===e.return||rl(e.return))return null;e=e.return}for(e.sibling.return=e.return,e=e.sibling;5!==e.tag&&6!==e.tag&&18!==e.tag;){if(2&e.flags)continue e;if(null===e.child||4===e.tag)continue e;e.child.return=e,e=e.child}if(!(2&e.flags))return e.stateNode}}function al(e,t,i){var s=e.tag;if(5===s||6===s)e=e.stateNode,t?8===i.nodeType?i.parentNode.insertBefore(e,t):i.insertBefore(e,t):(8===i.nodeType?(t=i.parentNode).insertBefore(e,i):(t=i).appendChild(e),null!=(i=i._reactRootContainer)||null!==t.onclick||(t.onclick=Qs));else if(4!==s&&null!==(e=e.child))for(al(e,t,i),e=e.sibling;null!==e;)al(e,t,i),e=e.sibling}function ol(e,t,i){var s=e.tag;if(5===s||6===s)e=e.stateNode,t?i.insertBefore(e,t):i.appendChild(e);else if(4!==s&&null!==(e=e.child))for(ol(e,t,i),e=e.sibling;null!==e;)ol(e,t,i),e=e.sibling}var ll=null,hl=!1;function cl(e,t,i){for(i=i.child;null!==i;)dl(e,t,i),i=i.sibling}function dl(e,t,i){if(st&&"function"==typeof st.onCommitFiberUnmount)try{st.onCommitFiberUnmount(it,i)}catch(e){}switch(i.tag){case 5:Ko||Jo(i,t);case 6:var s=ll,r=hl;ll=null,cl(e,t,i),hl=r,null!==(ll=s)&&(hl?(e=ll,i=i.stateNode,8===e.nodeType?e.parentNode.removeChild(i):e.removeChild(i)):ll.removeChild(i.stateNode));break;case 18:null!==ll&&(hl?(e=ll,i=i.stateNode,8===e.nodeType?nr(e.parentNode,i):1===e.nodeType&&nr(e,i),Ut(e)):nr(ll,i.stateNode));break;case 4:s=ll,r=hl,ll=i.stateNode.containerInfo,hl=!0,cl(e,t,i),ll=s,hl=r;break;case 0:case 11:case 14:case 15:if(!Ko&&(null!==(s=i.updateQueue)&&null!==(s=s.lastEffect))){r=s=s.next;do{var n=r,a=n.destroy;n=n.tag,void 0!==a&&(2&n||4&n)&&$o(i,t,a),r=r.next}while(r!==s)}cl(e,t,i);break;case 1:if(!Ko&&(Jo(i,t),"function"==typeof(s=i.stateNode).componentWillUnmount))try{s.props=i.memoizedProps,s.state=i.memoizedState,s.componentWillUnmount()}catch(e){Sh(i,t,e)}cl(e,t,i);break;case 21:cl(e,t,i);break;case 22:1&i.mode?(Ko=(s=Ko)||null!==i.memoizedState,cl(e,t,i),Ko=s):cl(e,t,i);break;default:cl(e,t,i)}}function ul(e){var t=e.updateQueue;if(null!==t){e.updateQueue=null;var i=e.stateNode;null===i&&(i=e.stateNode=new Yo),t.forEach((function(t){var s=Eh.bind(null,e,t);i.has(t)||(i.add(t),t.then(s,s))}))}}function fl(e,t){var s=t.deletions;if(null!==s)for(var r=0;r<s.length;r++){var n=s[r];try{var a=e,o=t,l=o;e:for(;null!==l;){switch(l.tag){case 5:ll=l.stateNode,hl=!1;break e;case 3:case 4:ll=l.stateNode.containerInfo,hl=!0;break e}l=l.return}if(null===ll)throw Error(i(160));dl(a,o,n),ll=null,hl=!1;var h=n.alternate;null!==h&&(h.return=null),n.return=null}catch(e){Sh(n,t,e)}}if(12854&t.subtreeFlags)for(t=t.child;null!==t;)pl(t,e),t=t.sibling}function pl(e,t){var s=e.alternate,r=e.flags;switch(e.tag){case 0:case 11:case 14:case 15:if(fl(t,e),ml(e),4&r){try{el(3,e,e.return),tl(3,e)}catch(t){Sh(e,e.return,t)}try{el(5,e,e.return)}catch(t){Sh(e,e.return,t)}}break;case 1:fl(t,e),ml(e),512&r&&null!==s&&Jo(s,s.return);break;case 5:if(fl(t,e),ml(e),512&r&&null!==s&&Jo(s,s.return),32&e.flags){var n=e.stateNode;try{ce(n,"")}catch(t){Sh(e,e.return,t)}}if(4&r&&null!=(n=e.stateNode)){var a=e.memoizedProps,o=null!==s?s.memoizedProps:a,l=e.type,h=e.updateQueue;if(e.updateQueue=null,null!==h)try{"input"===l&&"radio"===a.type&&null!=a.name&&Y(n,a),ve(l,o);var c=ve(l,a);for(o=0;o<h.length;o+=2){var d=h[o],u=h[o+1];"style"===d?pe(n,u):"dangerouslySetInnerHTML"===d?he(n,u):"children"===d?ce(n,u):v(n,d,u,c)}switch(l){case"input":Q(n,a);break;case"textarea":se(n,a);break;case"select":var f=n._wrapperState.wasMultiple;n._wrapperState.wasMultiple=!!a.multiple;var p=a.value;null!=p?ee(n,!!a.multiple,p,!1):f!==!!a.multiple&&(null!=a.defaultValue?ee(n,!!a.multiple,a.defaultValue,!0):ee(n,!!a.multiple,a.multiple?[]:"",!1))}n[cr]=a}catch(t){Sh(e,e.return,t)}}break;case 6:if(fl(t,e),ml(e),4&r){if(null===e.stateNode)throw Error(i(162));n=e.stateNode,a=e.memoizedProps;try{n.nodeValue=a}catch(t){Sh(e,e.return,t)}}break;case 3:if(fl(t,e),ml(e),4&r&&null!==s&&s.memoizedState.isDehydrated)try{Ut(t.containerInfo)}catch(t){Sh(e,e.return,t)}break;case 4:default:fl(t,e),ml(e);break;case 13:fl(t,e),ml(e),8192&(n=e.child).flags&&(a=null!==n.memoizedState,n.stateNode.isHidden=a,!a||null!==n.alternate&&null!==n.alternate.memoizedState||(zl=Ye())),4&r&&ul(e);break;case 22:if(d=null!==s&&null!==s.memoizedState,1&e.mode?(Ko=(c=Ko)||d,fl(t,e),Ko=c):fl(t,e),ml(e),8192&r){if(c=null!==e.memoizedState,(e.stateNode.isHidden=c)&&!d&&1&e.mode)for(Qo=e,d=e.child;null!==d;){for(u=Qo=d;null!==Qo;){switch(p=(f=Qo).child,f.tag){case 0:case 11:case 14:case 15:el(4,f,f.return);break;case 1:Jo(f,f.return);var m=f.stateNode;if("function"==typeof m.componentWillUnmount){r=f,s=f.return;try{t=r,m.props=t.memoizedProps,m.state=t.memoizedState,m.componentWillUnmount()}catch(e){Sh(r,s,e)}}break;case 5:Jo(f,f.return);break;case 22:if(null!==f.memoizedState){bl(u);continue}}null!==p?(p.return=f,Qo=p):bl(u)}d=d.sibling}e:for(d=null,u=e;;){if(5===u.tag){if(null===d){d=u;try{n=u.stateNode,c?"function"==typeof(a=n.style).setProperty?a.setProperty("display","none","important"):a.display="none":(l=u.stateNode,o=null!=(h=u.memoizedProps.style)&&h.hasOwnProperty("display")?h.display:null,l.style.display=fe("display",o))}catch(t){Sh(e,e.return,t)}}}else if(6===u.tag){if(null===d)try{u.stateNode.nodeValue=c?"":u.memoizedProps}catch(t){Sh(e,e.return,t)}}else if((22!==u.tag&&23!==u.tag||null===u.memoizedState||u===e)&&null!==u.child){u.child.return=u,u=u.child;continue}if(u===e)break e;for(;null===u.sibling;){if(null===u.return||u.return===e)break e;d===u&&(d=null),u=u.return}d===u&&(d=null),u.sibling.return=u.return,u=u.sibling}}break;case 19:fl(t,e),ml(e),4&r&&ul(e);case 21:}}function ml(e){var t=e.flags;if(2&t){try{e:{for(var s=e.return;null!==s;){if(rl(s)){var r=s;break e}s=s.return}throw Error(i(160))}switch(r.tag){case 5:var n=r.stateNode;32&r.flags&&(ce(n,""),r.flags&=-33),ol(e,nl(e),n);break;case 3:case 4:var a=r.stateNode.containerInfo;al(e,nl(e),a);break;default:throw Error(i(161))}}catch(t){Sh(e,e.return,t)}e.flags&=-3}4096&t&&(e.flags&=-4097)}function gl(e,t,i){Qo=e,vl(e)}function vl(e,t,i){for(var s=!!(1&e.mode);null!==Qo;){var r=Qo,n=r.child;if(22===r.tag&&s){var a=null!==r.memoizedState||Xo;if(!a){var o=r.alternate,l=null!==o&&null!==o.memoizedState||Ko;o=Xo;var h=Ko;if(Xo=a,(Ko=l)&&!h)for(Qo=r;null!==Qo;)l=(a=Qo).child,22===a.tag&&null!==a.memoizedState?yl(r):null!==l?(l.return=a,Qo=l):yl(r);for(;null!==n;)Qo=n,vl(n),n=n.sibling;Qo=r,Xo=o,Ko=h}_l(e)}else 8772&r.subtreeFlags&&null!==n?(n.return=r,Qo=n):_l(e)}}function _l(e){for(;null!==Qo;){var t=Qo;if(8772&t.flags){var s=t.alternate;try{if(8772&t.flags)switch(t.tag){case 0:case 11:case 15:Ko||tl(5,t);break;case 1:var r=t.stateNode;if(4&t.flags&&!Ko)if(null===s)r.componentDidMount();else{var n=t.elementType===t.type?s.memoizedProps:Za(t.type,s.memoizedProps);r.componentDidUpdate(n,s.memoizedState,r.__reactInternalSnapshotBeforeUpdate)}var a=t.updateQueue;null!==a&&Vn(t,a,r);break;case 3:var o=t.updateQueue;if(null!==o){if(s=null,null!==t.child)switch(t.child.tag){case 5:case 1:s=t.child.stateNode}Vn(t,o,s)}break;case 5:var l=t.stateNode;if(null===s&&4&t.flags){s=l;var h=t.memoizedProps;switch(t.type){case"button":case"input":case"select":case"textarea":h.autoFocus&&s.focus();break;case"img":h.src&&(s.src=h.src)}}break;case 6:case 4:case 12:case 19:case 17:case 21:case 22:case 23:case 25:break;case 13:if(null===t.memoizedState){var c=t.alternate;if(null!==c){var d=c.memoizedState;if(null!==d){var u=d.dehydrated;null!==u&&Ut(u)}}}break;default:throw Error(i(163))}Ko||512&t.flags&&il(t)}catch(e){Sh(t,t.return,e)}}if(t===e){Qo=null;break}if(null!==(s=t.sibling)){s.return=t.return,Qo=s;break}Qo=t.return}}function bl(e){for(;null!==Qo;){var t=Qo;if(t===e){Qo=null;break}var i=t.sibling;if(null!==i){i.return=t.return,Qo=i;break}Qo=t.return}}function yl(e){for(;null!==Qo;){var t=Qo;try{switch(t.tag){case 0:case 11:case 15:var i=t.return;try{tl(4,t)}catch(e){Sh(t,i,e)}break;case 1:var s=t.stateNode;if("function"==typeof s.componentDidMount){var r=t.return;try{s.componentDidMount()}catch(e){Sh(t,r,e)}}var n=t.return;try{il(t)}catch(e){Sh(t,n,e)}break;case 5:var a=t.return;try{il(t)}catch(e){Sh(t,a,e)}}}catch(e){Sh(t,t.return,e)}if(t===e){Qo=null;break}var o=t.sibling;if(null!==o){o.return=t.return,Qo=o;break}Qo=t.return}}var xl,Sl=Math.ceil,wl=_.ReactCurrentDispatcher,Tl=_.ReactCurrentOwner,Cl=_.ReactCurrentBatchConfig,El=0,Al=null,Pl=null,Dl=0,Ll=0,Ml=xr(0),Il=0,Rl=null,kl=0,Ol=0,Fl=0,Bl=null,Nl=null,zl=0,Ul=1/0,Vl=null,Hl=!1,Gl=null,Wl=null,jl=!1,ql=null,Xl=0,Kl=0,Yl=null,Ql=-1,Jl=0;function $l(){return 6&El?Ye():-1!==Ql?Ql:Ql=Ye()}function Zl(e){return 1&e.mode?2&El&&0!==Dl?Dl&-Dl:null!==fn.transition?(0===Jl&&(Jl=ft()),Jl):0!==(e=vt)?e:e=void 0===(e=window.event)?16:Kt(e.type):1}function eh(e,t,s,r){if(50<Kl)throw Kl=0,Yl=null,Error(i(185));mt(e,s,r),2&El&&e===Al||(e===Al&&(!(2&El)&&(Ol|=s),4===Il&&nh(e,Dl)),th(e,r),1===s&&0===El&&!(1&t.mode)&&(Ul=Ye()+500,Fr&&zr()))}function th(e,t){var i=e.callbackNode;!function(e,t){for(var i=e.suspendedLanes,s=e.pingedLanes,r=e.expirationTimes,n=e.pendingLanes;0<n;){var a=31-rt(n),o=1<<a,l=r[a];-1===l?o&i&&!(o&s)||(r[a]=dt(o,t)):l<=t&&(e.expiredLanes|=o),n&=~o}}(e,t);var s=ct(e,e===Al?Dl:0);if(0===s)null!==i&&qe(i),e.callbackNode=null,e.callbackPriority=0;else if(t=s&-s,e.callbackPriority!==t){if(null!=i&&qe(i),1===t)0===e.tag?function(e){Fr=!0,Nr(e)}(ah.bind(null,e)):Nr(ah.bind(null,e)),sr((function(){!(6&El)&&zr()})),i=null;else{switch(_t(s)){case 1:i=Je;break;case 4:i=$e;break;case 16:default:i=Ze;break;case 536870912:i=tt}i=Ah(i,ih.bind(null,e))}e.callbackPriority=t,e.callbackNode=i}}function ih(e,t){if(Ql=-1,Jl=0,6&El)throw Error(i(327));var s=e.callbackNode;if(yh()&&e.callbackNode!==s)return null;var r=ct(e,e===Al?Dl:0);if(0===r)return null;if(30&r||r&e.expiredLanes||t)t=ph(e,r);else{t=r;var n=El;El|=2;var a=uh();for(Al===e&&Dl===t||(Vl=null,Ul=Ye()+500,ch(e,t));;)try{gh();break}catch(t){dh(e,t)}Tn(),wl.current=a,El=n,null!==Pl?t=0:(Al=null,Dl=0,t=Il)}if(0!==t){if(2===t&&(0!==(n=ut(e))&&(r=n,t=sh(e,n))),1===t)throw s=Rl,ch(e,0),nh(e,r),th(e,Ye()),s;if(6===t)nh(e,r);else{if(n=e.current.alternate,!(30&r||function(e){for(var t=e;;){if(16384&t.flags){var i=t.updateQueue;if(null!==i&&null!==(i=i.stores))for(var s=0;s<i.length;s++){var r=i[s],n=r.getSnapshot;r=r.value;try{if(!rs(n(),r))return!1}catch(e){return!1}}}if(i=t.child,16384&t.subtreeFlags&&null!==i)i.return=t,t=i;else{if(t===e)break;for(;null===t.sibling;){if(null===t.return||t.return===e)return!0;t=t.return}t.sibling.return=t.return,t=t.sibling}}return!0}(n)||(t=ph(e,r),2===t&&(a=ut(e),0!==a&&(r=a,t=sh(e,a))),1!==t)))throw s=Rl,ch(e,0),nh(e,r),th(e,Ye()),s;switch(e.finishedWork=n,e.finishedLanes=r,t){case 0:case 1:throw Error(i(345));case 2:case 5:bh(e,Nl,Vl);break;case 3:if(nh(e,r),(130023424&r)===r&&10<(t=zl+500-Ye())){if(0!==ct(e,0))break;if(((n=e.suspendedLanes)&r)!==r){$l(),e.pingedLanes|=e.suspendedLanes&n;break}e.timeoutHandle=er(bh.bind(null,e,Nl,Vl),t);break}bh(e,Nl,Vl);break;case 4:if(nh(e,r),(4194240&r)===r)break;for(t=e.eventTimes,n=-1;0<r;){var o=31-rt(r);a=1<<o,(o=t[o])>n&&(n=o),r&=~a}if(r=n,10<(r=(120>(r=Ye()-r)?120:480>r?480:1080>r?1080:1920>r?1920:3e3>r?3e3:4320>r?4320:1960*Sl(r/1960))-r)){e.timeoutHandle=er(bh.bind(null,e,Nl,Vl),r);break}bh(e,Nl,Vl);break;default:throw Error(i(329))}}}return th(e,Ye()),e.callbackNode===s?ih.bind(null,e):null}function sh(e,t){var i=Bl;return e.current.memoizedState.isDehydrated&&(ch(e,t).flags|=256),2!==(e=ph(e,t))&&(t=Nl,Nl=i,null!==t&&rh(t)),e}function rh(e){null===Nl?Nl=e:Nl.push.apply(Nl,e)}function nh(e,t){for(t&=~Fl,t&=~Ol,e.suspendedLanes|=t,e.pingedLanes&=~t,e=e.expirationTimes;0<t;){var i=31-rt(t),s=1<<i;e[i]=-1,t&=~s}}function ah(e){if(6&El)throw Error(i(327));yh();var t=ct(e,0);if(!(1&t))return th(e,Ye()),null;var s=ph(e,t);if(0!==e.tag&&2===s){var r=ut(e);0!==r&&(t=r,s=sh(e,r))}if(1===s)throw s=Rl,ch(e,0),nh(e,t),th(e,Ye()),s;if(6===s)throw Error(i(345));return e.finishedWork=e.current.alternate,e.finishedLanes=t,bh(e,Nl,Vl),th(e,Ye()),null}function oh(e,t){var i=El;El|=1;try{return e(t)}finally{0===(El=i)&&(Ul=Ye()+500,Fr&&zr())}}function lh(e){null!==ql&&0===ql.tag&&!(6&El)&&yh();var t=El;El|=1;var i=Cl.transition,s=vt;try{if(Cl.transition=null,vt=1,e)return e()}finally{vt=s,Cl.transition=i,!(6&(El=t))&&zr()}}function hh(){Ll=Ml.current,Sr(Ml)}function ch(e,t){e.finishedWork=null,e.finishedLanes=0;var i=e.timeoutHandle;if(-1!==i&&(e.timeoutHandle=-1,tr(i)),null!==Pl)for(i=Pl.return;null!==i;){var s=i;switch($r(s),s.tag){case 1:null!=(s=s.type.childContextTypes)&&Lr();break;case 3:Kn(),Sr(Er),Sr(Cr),ea();break;case 5:Qn(s);break;case 4:Kn();break;case 13:case 19:Sr(Jn);break;case 10:Cn(s.type._context);break;case 22:case 23:hh()}i=i.return}if(Al=e,Pl=e=Mh(e.current,null),Dl=Ll=t,Il=0,Rl=null,Fl=Ol=kl=0,Nl=Bl=null,null!==Dn){for(t=0;t<Dn.length;t++)if(null!==(s=(i=Dn[t]).interleaved)){i.interleaved=null;var r=s.next,n=i.pending;if(null!==n){var a=n.next;n.next=r,s.next=a}i.pending=s}Dn=null}return e}function dh(e,t){for(;;){var s=Pl;try{if(Tn(),ta.current=Ya,oa){for(var r=ra.memoizedState;null!==r;){var n=r.queue;null!==n&&(n.pending=null),r=r.next}oa=!1}if(sa=0,aa=na=ra=null,la=!1,ha=0,Tl.current=null,null===s||null===s.return){Il=1,Rl=t,Pl=null;break}e:{var a=e,o=s.return,l=s,h=t;if(t=Dl,l.flags|=32768,null!==h&&"object"==typeof h&&"function"==typeof h.then){var c=h,d=l,u=d.tag;if(!(1&d.mode||0!==u&&11!==u&&15!==u)){var f=d.alternate;f?(d.updateQueue=f.updateQueue,d.memoizedState=f.memoizedState,d.lanes=f.lanes):(d.updateQueue=null,d.memoizedState=null)}var p=po(o);if(null!==p){p.flags&=-257,mo(p,o,l,0,t),1&p.mode&&fo(a,c,t),h=c;var m=(t=p).updateQueue;if(null===m){var g=new Set;g.add(h),t.updateQueue=g}else m.add(h);break e}if(!(1&t)){fo(a,c,t),fh();break e}h=Error(i(426))}else if(tn&&1&l.mode){var v=po(o);if(null!==v){!(65536&v.flags)&&(v.flags|=256),mo(v,o,l,0,t),un(ao(h,l));break e}}a=h=ao(h,l),4!==Il&&(Il=2),null===Bl?Bl=[a]:Bl.push(a),a=o;do{switch(a.tag){case 3:a.flags|=65536,t&=-t,a.lanes|=t,zn(a,co(0,h,t));break e;case 1:l=h;var _=a.type,b=a.stateNode;if(!(128&a.flags||"function"!=typeof _.getDerivedStateFromError&&(null===b||"function"!=typeof b.componentDidCatch||null!==Wl&&Wl.has(b)))){a.flags|=65536,t&=-t,a.lanes|=t,zn(a,uo(a,l,t));break e}}a=a.return}while(null!==a)}_h(s)}catch(e){t=e,Pl===s&&null!==s&&(Pl=s=s.return);continue}break}}function uh(){var e=wl.current;return wl.current=Ya,null===e?Ya:e}function fh(){0!==Il&&3!==Il&&2!==Il||(Il=4),null===Al||!(268435455&kl)&&!(268435455&Ol)||nh(Al,Dl)}function ph(e,t){var s=El;El|=2;var r=uh();for(Al===e&&Dl===t||(Vl=null,ch(e,t));;)try{mh();break}catch(t){dh(e,t)}if(Tn(),El=s,wl.current=r,null!==Pl)throw Error(i(261));return Al=null,Dl=0,Il}function mh(){for(;null!==Pl;)vh(Pl)}function gh(){for(;null!==Pl&&!Xe();)vh(Pl)}function vh(e){var t=xl(e.alternate,e,Ll);e.memoizedProps=e.pendingProps,null===t?_h(e):Pl=t,Tl.current=null}function _h(e){var t=e;do{var i=t.alternate;if(e=t.return,32768&t.flags){if(null!==(i=qo(i,t)))return i.flags&=32767,void(Pl=i);if(null===e)return Il=6,void(Pl=null);e.flags|=32768,e.subtreeFlags=0,e.deletions=null}else if(null!==(i=jo(i,t,Ll)))return void(Pl=i);if(null!==(t=t.sibling))return void(Pl=t);Pl=t=e}while(null!==t);0===Il&&(Il=5)}function bh(e,t,s){var r=vt,n=Cl.transition;try{Cl.transition=null,vt=1,function(e,t,s,r){do{yh()}while(null!==ql);if(6&El)throw Error(i(327));s=e.finishedWork;var n=e.finishedLanes;if(null===s)return null;if(e.finishedWork=null,e.finishedLanes=0,s===e.current)throw Error(i(177));e.callbackNode=null,e.callbackPriority=0;var a=s.lanes|s.childLanes;if(function(e,t){var i=e.pendingLanes&~t;e.pendingLanes=t,e.suspendedLanes=0,e.pingedLanes=0,e.expiredLanes&=t,e.mutableReadLanes&=t,e.entangledLanes&=t,t=e.entanglements;var s=e.eventTimes;for(e=e.expirationTimes;0<i;){var r=31-rt(i),n=1<<r;t[r]=0,s[r]=-1,e[r]=-1,i&=~n}}(e,a),e===Al&&(Pl=Al=null,Dl=0),!(2064&s.subtreeFlags)&&!(2064&s.flags)||jl||(jl=!0,Ah(Ze,(function(){return yh(),null}))),a=!!(15990&s.flags),!!(15990&s.subtreeFlags)||a){a=Cl.transition,Cl.transition=null;var o=vt;vt=1;var l=El;El|=4,Tl.current=null,function(e,t){if(Js=Ht,cs(e=hs())){if("selectionStart"in e)var s={start:e.selectionStart,end:e.selectionEnd};else{var r=(s=(s=e.ownerDocument)&&s.defaultView||window).getSelection&&s.getSelection();if(r&&0!==r.rangeCount){s=r.anchorNode;var n=r.anchorOffset,a=r.focusNode;r=r.focusOffset;var o=0,l=-1,h=-1,c=0,d=0,u=e,f=null;e:for(;;){for(var p;u!==s||0!==n&&3!==u.nodeType||(l=o+n),u!==a||0!==r&&3!==u.nodeType||(h=o+r),3===u.nodeType&&(o+=u.nodeValue.length),null!==(p=u.firstChild);)f=u,u=p;for(;;){if(u===e)break e;if(f===s&&++c===n&&(l=o),f===a&&++d===r&&(h=o),null!==(p=u.nextSibling))break;f=(u=f).parentNode}u=p}s=-1===l||-1===h?null:{start:l,end:h}}else s=null}s=s||{start:0,end:0}}else s=null;for($s={focusedElem:e,selectionRange:s},Ht=!1,Qo=t;null!==Qo;)if(e=(t=Qo).child,1028&t.subtreeFlags&&null!==e)e.return=t,Qo=e;else for(;null!==Qo;){t=Qo;try{var m=t.alternate;if(1024&t.flags)switch(t.tag){case 0:case 11:case 15:case 5:case 6:case 4:case 17:break;case 1:if(null!==m){var g=m.memoizedProps,v=m.memoizedState,_=t.stateNode,b=_.getSnapshotBeforeUpdate(t.elementType===t.type?g:Za(t.type,g),v);_.__reactInternalSnapshotBeforeUpdate=b}break;case 3:var y=t.stateNode.containerInfo;1===y.nodeType?y.textContent="":9===y.nodeType&&y.documentElement&&y.removeChild(y.documentElement);break;default:throw Error(i(163))}}catch(e){Sh(t,t.return,e)}if(null!==(e=t.sibling)){e.return=t.return,Qo=e;break}Qo=t.return}m=Zo,Zo=!1}(e,s),pl(s,e),ds($s),Ht=!!Js,$s=Js=null,e.current=s,gl(s),Ke(),El=l,vt=o,Cl.transition=a}else e.current=s;if(jl&&(jl=!1,ql=e,Xl=n),a=e.pendingLanes,0===a&&(Wl=null),function(e){if(st&&"function"==typeof st.onCommitFiberRoot)try{st.onCommitFiberRoot(it,e,void 0,!(128&~e.current.flags))}catch(e){}}(s.stateNode),th(e,Ye()),null!==t)for(r=e.onRecoverableError,s=0;s<t.length;s++)n=t[s],r(n.value,{componentStack:n.stack,digest:n.digest});if(Hl)throw Hl=!1,e=Gl,Gl=null,e;!!(1&Xl)&&0!==e.tag&&yh(),a=e.pendingLanes,1&a?e===Yl?Kl++:(Kl=0,Yl=e):Kl=0,zr()}(e,t,s,r)}finally{Cl.transition=n,vt=r}return null}function yh(){if(null!==ql){var e=_t(Xl),t=Cl.transition,s=vt;try{if(Cl.transition=null,vt=16>e?16:e,null===ql)var r=!1;else{if(e=ql,ql=null,Xl=0,6&El)throw Error(i(331));var n=El;for(El|=4,Qo=e.current;null!==Qo;){var a=Qo,o=a.child;if(16&Qo.flags){var l=a.deletions;if(null!==l){for(var h=0;h<l.length;h++){var c=l[h];for(Qo=c;null!==Qo;){var d=Qo;switch(d.tag){case 0:case 11:case 15:el(8,d,a)}var u=d.child;if(null!==u)u.return=d,Qo=u;else for(;null!==Qo;){var f=(d=Qo).sibling,p=d.return;if(sl(d),d===c){Qo=null;break}if(null!==f){f.return=p,Qo=f;break}Qo=p}}}var m=a.alternate;if(null!==m){var g=m.child;if(null!==g){m.child=null;do{var v=g.sibling;g.sibling=null,g=v}while(null!==g)}}Qo=a}}if(2064&a.subtreeFlags&&null!==o)o.return=a,Qo=o;else e:for(;null!==Qo;){if(2048&(a=Qo).flags)switch(a.tag){case 0:case 11:case 15:el(9,a,a.return)}var _=a.sibling;if(null!==_){_.return=a.return,Qo=_;break e}Qo=a.return}}var b=e.current;for(Qo=b;null!==Qo;){var y=(o=Qo).child;if(2064&o.subtreeFlags&&null!==y)y.return=o,Qo=y;else e:for(o=b;null!==Qo;){if(2048&(l=Qo).flags)try{switch(l.tag){case 0:case 11:case 15:tl(9,l)}}catch(e){Sh(l,l.return,e)}if(l===o){Qo=null;break e}var x=l.sibling;if(null!==x){x.return=l.return,Qo=x;break e}Qo=l.return}}if(El=n,zr(),st&&"function"==typeof st.onPostCommitFiberRoot)try{st.onPostCommitFiberRoot(it,e)}catch(e){}r=!0}return r}finally{vt=s,Cl.transition=t}}return!1}function xh(e,t,i){e=Bn(e,t=co(0,t=ao(i,t),1),1),t=$l(),null!==e&&(mt(e,1,t),th(e,t))}function Sh(e,t,i){if(3===e.tag)xh(e,e,i);else for(;null!==t;){if(3===t.tag){xh(t,e,i);break}if(1===t.tag){var s=t.stateNode;if("function"==typeof t.type.getDerivedStateFromError||"function"==typeof s.componentDidCatch&&(null===Wl||!Wl.has(s))){t=Bn(t,e=uo(t,e=ao(i,e),1),1),e=$l(),null!==t&&(mt(t,1,e),th(t,e));break}}t=t.return}}function wh(e,t,i){var s=e.pingCache;null!==s&&s.delete(t),t=$l(),e.pingedLanes|=e.suspendedLanes&i,Al===e&&(Dl&i)===i&&(4===Il||3===Il&&(130023424&Dl)===Dl&&500>Ye()-zl?ch(e,0):Fl|=i),th(e,t)}function Th(e,t){0===t&&(1&e.mode?(t=lt,!(130023424&(lt<<=1))&&(lt=4194304)):t=1);var i=$l();null!==(e=In(e,t))&&(mt(e,t,i),th(e,i))}function Ch(e){var t=e.memoizedState,i=0;null!==t&&(i=t.retryLane),Th(e,i)}function Eh(e,t){var s=0;switch(e.tag){case 13:var r=e.stateNode,n=e.memoizedState;null!==n&&(s=n.retryLane);break;case 19:r=e.stateNode;break;default:throw Error(i(314))}null!==r&&r.delete(t),Th(e,s)}function Ah(e,t){return je(e,t)}function Ph(e,t,i,s){this.tag=e,this.key=i,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.ref=null,this.pendingProps=t,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=s,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function Dh(e,t,i,s){return new Ph(e,t,i,s)}function Lh(e){return!(!(e=e.prototype)||!e.isReactComponent)}function Mh(e,t){var i=e.alternate;return null===i?((i=Dh(e.tag,t,e.key,e.mode)).elementType=e.elementType,i.type=e.type,i.stateNode=e.stateNode,i.alternate=e,e.alternate=i):(i.pendingProps=t,i.type=e.type,i.flags=0,i.subtreeFlags=0,i.deletions=null),i.flags=14680064&e.flags,i.childLanes=e.childLanes,i.lanes=e.lanes,i.child=e.child,i.memoizedProps=e.memoizedProps,i.memoizedState=e.memoizedState,i.updateQueue=e.updateQueue,t=e.dependencies,i.dependencies=null===t?null:{lanes:t.lanes,firstContext:t.firstContext},i.sibling=e.sibling,i.index=e.index,i.ref=e.ref,i}function Ih(e,t,s,r,n,a){var o=2;if(r=e,"function"==typeof e)Lh(e)&&(o=1);else if("string"==typeof e)o=5;else e:switch(e){case x:return Rh(s.children,n,a,t);case S:o=8,n|=8;break;case w:return(e=Dh(12,s,t,2|n)).elementType=w,e.lanes=a,e;case A:return(e=Dh(13,s,t,n)).elementType=A,e.lanes=a,e;case P:return(e=Dh(19,s,t,n)).elementType=P,e.lanes=a,e;case M:return kh(s,n,a,t);default:if("object"==typeof e&&null!==e)switch(e.$$typeof){case T:o=10;break e;case C:o=9;break e;case E:o=11;break e;case D:o=14;break e;case L:o=16,r=null;break e}throw Error(i(130,null==e?e:typeof e,""))}return(t=Dh(o,s,t,n)).elementType=e,t.type=r,t.lanes=a,t}function Rh(e,t,i,s){return(e=Dh(7,e,s,t)).lanes=i,e}function kh(e,t,i,s){return(e=Dh(22,e,s,t)).elementType=M,e.lanes=i,e.stateNode={isHidden:!1},e}function Oh(e,t,i){return(e=Dh(6,e,null,t)).lanes=i,e}function Fh(e,t,i){return(t=Dh(4,null!==e.children?e.children:[],e.key,t)).lanes=i,t.stateNode={containerInfo:e.containerInfo,pendingChildren:null,implementation:e.implementation},t}function Bh(e,t,i,s,r){this.tag=t,this.containerInfo=e,this.finishedWork=this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.pendingContext=this.context=null,this.callbackPriority=0,this.eventTimes=pt(0),this.expirationTimes=pt(-1),this.entangledLanes=this.finishedLanes=this.mutableReadLanes=this.expiredLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=pt(0),this.identifierPrefix=s,this.onRecoverableError=r,this.mutableSourceEagerHydrationData=null}function Nh(e,t,i,s,r,n,a,o,l){return e=new Bh(e,t,i,o,l),1===t?(t=1,!0===n&&(t|=8)):t=0,n=Dh(3,null,null,t),e.current=n,n.stateNode=e,n.memoizedState={element:s,isDehydrated:i,cache:null,transitions:null,pendingSuspenseBoundaries:null},kn(n),e}function zh(e){if(!e)return Tr;e:{if(Ue(e=e._reactInternals)!==e||1!==e.tag)throw Error(i(170));var t=e;do{switch(t.tag){case 3:t=t.stateNode.context;break e;case 1:if(Dr(t.type)){t=t.stateNode.__reactInternalMemoizedMergedChildContext;break e}}t=t.return}while(null!==t);throw Error(i(171))}if(1===e.tag){var s=e.type;if(Dr(s))return Ir(e,s,t)}return t}function Uh(e,t,i,s,r,n,a,o,l){return(e=Nh(i,s,!0,e,0,n,0,o,l)).context=zh(null),i=e.current,(n=Fn(s=$l(),r=Zl(i))).callback=null!=t?t:null,Bn(i,n,r),e.current.lanes=r,mt(e,r,s),th(e,s),e}function Vh(e,t,i,s){var r=t.current,n=$l(),a=Zl(r);return i=zh(i),null===t.context?t.context=i:t.pendingContext=i,(t=Fn(n,a)).payload={element:e},null!==(s=void 0===s?null:s)&&(t.callback=s),null!==(e=Bn(r,t,a))&&(eh(e,r,a,n),Nn(e,r,a)),a}function Hh(e){return(e=e.current).child?(e.child.tag,e.child.stateNode):null}function Gh(e,t){if(null!==(e=e.memoizedState)&&null!==e.dehydrated){var i=e.retryLane;e.retryLane=0!==i&&i<t?i:t}}function Wh(e,t){Gh(e,t),(e=e.alternate)&&Gh(e,t)}xl=function(e,t,s){if(null!==e)if(e.memoizedProps!==t.pendingProps||Er.current)vo=!0;else{if(!(e.lanes&s||128&t.flags))return vo=!1,function(e,t,i){switch(t.tag){case 3:Ao(t),dn();break;case 5:Yn(t);break;case 1:Dr(t.type)&&Rr(t);break;case 4:Xn(t,t.stateNode.containerInfo);break;case 10:var s=t.type._context,r=t.memoizedProps.value;wr(yn,s._currentValue),s._currentValue=r;break;case 13:if(null!==(s=t.memoizedState))return null!==s.dehydrated?(wr(Jn,1&Jn.current),t.flags|=128,null):i&t.child.childLanes?Oo(e,t,i):(wr(Jn,1&Jn.current),null!==(e=Ho(e,t,i))?e.sibling:null);wr(Jn,1&Jn.current);break;case 19:if(s=!!(i&t.childLanes),128&e.flags){if(s)return Uo(e,t,i);t.flags|=128}if(null!==(r=t.memoizedState)&&(r.rendering=null,r.tail=null,r.lastEffect=null),wr(Jn,Jn.current),s)break;return null;case 22:case 23:return t.lanes=0,So(e,t,i)}return Ho(e,t,i)}(e,t,s);vo=!!(131072&e.flags)}else vo=!1,tn&&1048576&t.flags&&Qr(t,Gr,t.index);switch(t.lanes=0,t.tag){case 2:var r=t.type;Vo(e,t),e=t.pendingProps;var n=Pr(t,Cr.current);An(t,s),n=fa(null,t,r,e,n,s);var a=pa();return t.flags|=1,"object"==typeof n&&null!==n&&"function"==typeof n.render&&void 0===n.$$typeof?(t.tag=1,t.memoizedState=null,t.updateQueue=null,Dr(r)?(a=!0,Rr(t)):a=!1,t.memoizedState=null!==n.state&&void 0!==n.state?n.state:null,kn(t),n.updater=to,t.stateNode=n,n._reactInternals=t,no(t,r,e,s),t=Eo(null,t,r,!0,a,s)):(t.tag=0,tn&&a&&Jr(t),_o(null,t,n,s),t=t.child),t;case 16:r=t.elementType;e:{switch(Vo(e,t),e=t.pendingProps,r=(n=r._init)(r._payload),t.type=r,n=t.tag=function(e){if("function"==typeof e)return Lh(e)?1:0;if(null!=e){if((e=e.$$typeof)===E)return 11;if(e===D)return 14}return 2}(r),e=Za(r,e),n){case 0:t=To(null,t,r,e,s);break e;case 1:t=Co(null,t,r,e,s);break e;case 11:t=bo(null,t,r,e,s);break e;case 14:t=yo(null,t,r,Za(r.type,e),s);break e}throw Error(i(306,r,""))}return t;case 0:return r=t.type,n=t.pendingProps,To(e,t,r,n=t.elementType===r?n:Za(r,n),s);case 1:return r=t.type,n=t.pendingProps,Co(e,t,r,n=t.elementType===r?n:Za(r,n),s);case 3:e:{if(Ao(t),null===e)throw Error(i(387));r=t.pendingProps,n=(a=t.memoizedState).element,On(e,t),Un(t,r,null,s);var o=t.memoizedState;if(r=o.element,a.isDehydrated){if(a={element:r,isDehydrated:!1,cache:o.cache,pendingSuspenseBoundaries:o.pendingSuspenseBoundaries,transitions:o.transitions},t.updateQueue.baseState=a,t.memoizedState=a,256&t.flags){t=Po(e,t,r,s,n=ao(Error(i(423)),t));break e}if(r!==n){t=Po(e,t,r,s,n=ao(Error(i(424)),t));break e}for(en=ar(t.stateNode.containerInfo.firstChild),Zr=t,tn=!0,sn=null,s=bn(t,null,r,s),t.child=s;s;)s.flags=-3&s.flags|4096,s=s.sibling}else{if(dn(),r===n){t=Ho(e,t,s);break e}_o(e,t,r,s)}t=t.child}return t;case 5:return Yn(t),null===e&&on(t),r=t.type,n=t.pendingProps,a=null!==e?e.memoizedProps:null,o=n.children,Zs(r,n)?o=null:null!==a&&Zs(r,a)&&(t.flags|=32),wo(e,t),_o(e,t,o,s),t.child;case 6:return null===e&&on(t),null;case 13:return Oo(e,t,s);case 4:return Xn(t,t.stateNode.containerInfo),r=t.pendingProps,null===e?t.child=_n(t,null,r,s):_o(e,t,r,s),t.child;case 11:return r=t.type,n=t.pendingProps,bo(e,t,r,n=t.elementType===r?n:Za(r,n),s);case 7:return _o(e,t,t.pendingProps,s),t.child;case 8:case 12:return _o(e,t,t.pendingProps.children,s),t.child;case 10:e:{if(r=t.type._context,n=t.pendingProps,a=t.memoizedProps,o=n.value,wr(yn,r._currentValue),r._currentValue=o,null!==a)if(rs(a.value,o)){if(a.children===n.children&&!Er.current){t=Ho(e,t,s);break e}}else for(null!==(a=t.child)&&(a.return=t);null!==a;){var l=a.dependencies;if(null!==l){o=a.child;for(var h=l.firstContext;null!==h;){if(h.context===r){if(1===a.tag){(h=Fn(-1,s&-s)).tag=2;var c=a.updateQueue;if(null!==c){var d=(c=c.shared).pending;null===d?h.next=h:(h.next=d.next,d.next=h),c.pending=h}}a.lanes|=s,null!==(h=a.alternate)&&(h.lanes|=s),En(a.return,s,t),l.lanes|=s;break}h=h.next}}else if(10===a.tag)o=a.type===t.type?null:a.child;else if(18===a.tag){if(null===(o=a.return))throw Error(i(341));o.lanes|=s,null!==(l=o.alternate)&&(l.lanes|=s),En(o,s,t),o=a.sibling}else o=a.child;if(null!==o)o.return=a;else for(o=a;null!==o;){if(o===t){o=null;break}if(null!==(a=o.sibling)){a.return=o.return,o=a;break}o=o.return}a=o}_o(e,t,n.children,s),t=t.child}return t;case 9:return n=t.type,r=t.pendingProps.children,An(t,s),r=r(n=Pn(n)),t.flags|=1,_o(e,t,r,s),t.child;case 14:return n=Za(r=t.type,t.pendingProps),yo(e,t,r,n=Za(r.type,n),s);case 15:return xo(e,t,t.type,t.pendingProps,s);case 17:return r=t.type,n=t.pendingProps,n=t.elementType===r?n:Za(r,n),Vo(e,t),t.tag=1,Dr(r)?(e=!0,Rr(t)):e=!1,An(t,s),so(t,r,n),no(t,r,n,s),Eo(null,t,r,!0,e,s);case 19:return Uo(e,t,s);case 22:return So(e,t,s)}throw Error(i(156,t.tag))};var jh="function"==typeof reportError?reportError:function(e){console.error(e)};function qh(e){this._internalRoot=e}function Xh(e){this._internalRoot=e}function Kh(e){return!(!e||1!==e.nodeType&&9!==e.nodeType&&11!==e.nodeType)}function Yh(e){return!(!e||1!==e.nodeType&&9!==e.nodeType&&11!==e.nodeType&&(8!==e.nodeType||" react-mount-point-unstable "!==e.nodeValue))}function Qh(){}function Jh(e,t,i,s,r){var n=i._reactRootContainer;if(n){var a=n;if("function"==typeof r){var o=r;r=function(){var e=Hh(a);o.call(e)}}Vh(t,a,e,r)}else a=function(e,t,i,s,r){if(r){if("function"==typeof s){var n=s;s=function(){var e=Hh(a);n.call(e)}}var a=Uh(t,s,e,0,null,!1,0,"",Qh);return e._reactRootContainer=a,e[dr]=a.current,zs(8===e.nodeType?e.parentNode:e),lh(),a}for(;r=e.lastChild;)e.removeChild(r);if("function"==typeof s){var o=s;s=function(){var e=Hh(l);o.call(e)}}var l=Nh(e,0,!1,null,0,!1,0,"",Qh);return e._reactRootContainer=l,e[dr]=l.current,zs(8===e.nodeType?e.parentNode:e),lh((function(){Vh(t,l,i,s)})),l}(i,t,e,r,s);return Hh(a)}Xh.prototype.render=qh.prototype.render=function(e){var t=this._internalRoot;if(null===t)throw Error(i(409));Vh(e,t,null,null)},Xh.prototype.unmount=qh.prototype.unmount=function(){var e=this._internalRoot;if(null!==e){this._internalRoot=null;var t=e.containerInfo;lh((function(){Vh(null,e,null,null)})),t[dr]=null}},Xh.prototype.unstable_scheduleHydration=function(e){if(e){var t=St();e={blockedOn:null,target:e,priority:t};for(var i=0;i<Mt.length&&0!==t&&t<Mt[i].priority;i++);Mt.splice(i,0,e),0===i&&Ot(e)}},bt=function(e){switch(e.tag){case 3:var t=e.stateNode;if(t.current.memoizedState.isDehydrated){var i=ht(t.pendingLanes);0!==i&&(gt(t,1|i),th(t,Ye()),!(6&El)&&(Ul=Ye()+500,zr()))}break;case 13:lh((function(){var t=In(e,1);if(null!==t){var i=$l();eh(t,e,1,i)}})),Wh(e,1)}},yt=function(e){if(13===e.tag){var t=In(e,134217728);if(null!==t)eh(t,e,134217728,$l());Wh(e,134217728)}},xt=function(e){if(13===e.tag){var t=Zl(e),i=In(e,t);if(null!==i)eh(i,e,t,$l());Wh(e,t)}},St=function(){return vt},wt=function(e,t){var i=vt;try{return vt=e,t()}finally{vt=i}},ye=function(e,t,s){switch(t){case"input":if(Q(e,s),t=s.name,"radio"===s.type&&null!=t){for(s=e;s.parentNode;)s=s.parentNode;for(s=s.querySelectorAll("input[name="+JSON.stringify(""+t)+'][type="radio"]'),t=0;t<s.length;t++){var r=s[t];if(r!==e&&r.form===e.form){var n=_r(r);if(!n)throw Error(i(90));j(r),Q(r,n)}}}break;case"textarea":se(e,s);break;case"select":null!=(t=s.value)&&ee(e,!!s.multiple,t,!1)}},Ee=oh,Ae=lh;var $h={usingClientEntryPoint:!1,Events:[gr,vr,_r,Te,Ce,oh]},Zh={findFiberByHostInstance:mr,bundleType:0,version:"18.3.1",rendererPackageName:"react-dom"},ec={bundleType:Zh.bundleType,version:Zh.version,rendererPackageName:Zh.rendererPackageName,rendererConfig:Zh.rendererConfig,overrideHookState:null,overrideHookStateDeletePath:null,overrideHookStateRenamePath:null,overrideProps:null,overridePropsDeletePath:null,overridePropsRenamePath:null,setErrorHandler:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:_.ReactCurrentDispatcher,findHostInstanceByFiber:function(e){return null===(e=Ge(e))?null:e.stateNode},findFiberByHostInstance:Zh.findFiberByHostInstance||function(){return null},findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null,reconcilerVersion:"18.3.1-next-f1338f8080-20240426"};if("undefined"!=typeof __REACT_DEVTOOLS_GLOBAL_HOOK__){var tc=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!tc.isDisabled&&tc.supportsFiber)try{it=tc.inject(ec),st=tc}catch(le){}}return MS.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=$h,MS.createPortal=function(e,t){var s=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;if(!Kh(t))throw Error(i(200));return function(e,t,i){var s=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:y,key:null==s?null:""+s,children:e,containerInfo:t,implementation:i}}(e,t,null,s)},MS.createRoot=function(e,t){if(!Kh(e))throw Error(i(299));var s=!1,r="",n=jh;return null!=t&&(!0===t.unstable_strictMode&&(s=!0),void 0!==t.identifierPrefix&&(r=t.identifierPrefix),void 0!==t.onRecoverableError&&(n=t.onRecoverableError)),t=Nh(e,1,!1,null,0,s,0,r,n),e[dr]=t.current,zs(8===e.nodeType?e.parentNode:e),new qh(t)},MS.findDOMNode=function(e){if(null==e)return null;if(1===e.nodeType)return e;var t=e._reactInternals;if(void 0===t){if("function"==typeof e.render)throw Error(i(188));throw e=Object.keys(e).join(","),Error(i(268,e))}return e=null===(e=Ge(t))?null:e.stateNode},MS.flushSync=function(e){return lh(e)},MS.hydrate=function(e,t,s){if(!Yh(t))throw Error(i(200));return Jh(null,e,t,!0,s)},MS.hydrateRoot=function(e,t,s){if(!Kh(e))throw Error(i(405));var r=null!=s&&s.hydratedSources||null,n=!1,a="",o=jh;if(null!=s&&(!0===s.unstable_strictMode&&(n=!0),void 0!==s.identifierPrefix&&(a=s.identifierPrefix),void 0!==s.onRecoverableError&&(o=s.onRecoverableError)),t=Uh(t,null,e,1,null!=s?s:null,n,0,a,o),e[dr]=t.current,zs(e),r)for(e=0;e<r.length;e++)n=(n=(s=r[e])._getVersion)(s._source),null==t.mutableSourceEagerHydrationData?t.mutableSourceEagerHydrationData=[s,n]:t.mutableSourceEagerHydrationData.push(s,n);return new Xh(t)},MS.render=function(e,t,s){if(!Yh(t))throw Error(i(200));return Jh(null,e,t,!1,s)},MS.unmountComponentAtNode=function(e){if(!Yh(e))throw Error(i(40));return!!e._reactRootContainer&&(lh((function(){Jh(null,null,e,!1,(function(){e._reactRootContainer=null,e[dr]=null}))})),!0)},MS.unstable_batchedUpdates=oh,MS.unstable_renderSubtreeIntoContainer=function(e,t,s,r){if(!Yh(s))throw Error(i(200));if(null==e||void 0===e._reactInternals)throw Error(i(38));return Jh(e,t,s,!1,r)},MS.version="18.3.1-next-f1338f8080-20240426",MS}function BS(){if(DS)return LS.exports;return DS=1,function e(){if("undefined"!=typeof __REACT_DEVTOOLS_GLOBAL_HOOK__&&"function"==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE)try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(e)}catch(e){console.error(e)}}(),LS.exports=FS(),LS.exports}var NS=r(BS());const zS=e=>u.createElement(je,{class:"pcui-error",title:"Error",hidden:!e.observerData.ui.error,text:e.observerData.ui.error,icon:"E218"}),US=(e,t,i=2)=>{let s,r;const n=e=>{s=e.pageX,r=e.pageY};e.addEventListener("mousedown",n);const a=e=>{const n=Math.abs(e.pageX-s),a=Math.abs(e.pageY-r);n<i&&a<i&&t(e)};return e.addEventListener("mouseup",a),()=>{e.removeEventListener("mousedown",n),e.removeEventListener("mouseup",a)}},VS=(e,t)=>{const i=(e,t)=>{for(const i of t){if(!e.hasOwnProperty(i))return null;e=e[i]}return e},s={};for(const r of t){const t=r.split("."),n=i(e,t);let a=s;for(let e=0;e<t.length;++e){const i=t[e];e<t.length-1?(a.hasOwnProperty(i)||(a[i]={}),a=a[i]):a[i]=n}}return s},HS=e=>u.createElement(_e,{class:"panel-option"},u.createElement(qe,{class:"panel-label",text:e.label}),u.createElement(qe,{class:"panel-value",text:String(e.value)})),GS=e=>u.createElement(_e,{class:"panel-option",enabled:e.enabled??!0},u.createElement(qe,{class:"panel-label",text:e.label}),u.createElement(Dt,{class:"panel-value",dimensions:e.dimensions,value:e.value,precision:7})),WS=e=>u.createElement(_e,{class:"panel-option",enabled:e.enabled??!0},u.createElement(qe,{class:"panel-label",text:e.label}),u.createElement(ne,{class:"panel-value-boolean",type:"toggle",value:e.value,onChange:t=>e.setProperty(t)})),jS=e=>u.createElement(_e,{class:"panel-option"},u.createElement(qe,{class:"panel-label",text:e.label}),u.createElement(_e,{class:"panel-value"},u.createElement(ne,{type:"toggle",value:e.booleanValue,onChange:t=>e.setBooleanProperty(t)}),u.createElement(ve,{class:"panel-value-toggle-color",value:e.colorValue,onChange:t=>e.setColorProperty(t)}))),qS=e=>u.createElement(_e,{class:"panel-option",enabled:e.enabled??!0},u.createElement(qe,{class:"panel-label",text:e.label}),u.createElement(rt,{class:"panel-value",min:e.min,max:e.max,sliderMin:e.min,sliderMax:e.max,precision:e.precision,step:e.step??.01,onChange:t=>{e.setProperty(t)},value:e.value})),XS=e=>u.createElement(_e,{class:"panel-option",enabled:e.enabled??!0},u.createElement(qe,{class:"panel-label",text:e.label}),u.createElement(Xe,{class:"panel-value",min:e.min,max:e.max,onChange:t=>{e.setProperty(t)},value:e.value})),KS=e=>u.createElement(_e,{class:"panel-option",hidden:e.hidden,enabled:e.enabled??!0},u.createElement(qe,{class:"panel-label",text:e.label}),u.createElement(ve,{class:"panel-value",value:e.value,onChange:t=>e.setProperty(t)})),YS=e=>u.createElement(_e,{class:"panel-option",enabled:e.enabled??!0},u.createElement(qe,{class:"morph-label",flexGrow:"1",flexShrink:"1",text:e.label?e.label:e.name.substring(0,1).toUpperCase()+e.name.substring(1,e.name.length),flex:!0}),u.createElement(rt,{class:"morph-value",flexGrow:"0",flexShrink:"0",min:e.min,max:e.max,sliderMin:e.min,sliderMax:e.max,precision:e.precision,step:.01,onChange:t=>{e.setProperty(t)},value:e.value})),QS=e=>u.createElement(_e,{class:"panel-option",enabled:e.enabled??!0},u.createElement(qe,{class:"panel-label",text:e.label}),u.createElement(Ye,{class:"panel-value",type:e.type,options:e.options,value:e.value,onChange:t=>{e.setProperty(t)}})),JS=e=>u.createElement(Ye,{id:e.id,class:e.class,width:e.width,type:e.type,options:e.options,enabled:e.enabled??!0,value:e.value,onChange:t=>{e.setProperty(t)}}),$S=e=>u.createElement(rt,{id:e.id,class:e.class,width:e.width,min:e.min,max:e.max,sliderMin:e.min,sliderMax:e.max,precision:e.precision,step:.01,enabled:e.enabled??!0,value:e.value,onChange:t=>{e.setProperty(t)}});var ZS,ew={exports:{}};function tw(){return ZS?ew.exports:(ZS=1,e=function(e,t){return function(e){var t={};function i(s){if(t[s])return t[s].exports;var r=t[s]={i:s,l:!1,exports:{}};return e[s].call(r.exports,r,r.exports,i),r.l=!0,r.exports}return i.m=e,i.c=t,i.d=function(e,t,s){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)i.d(s,r,function(t){return e[t]}.bind(null,r));return s},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=4)}([function(e,t,i){e.exports=i(5)()},function(t,i){t.exports=e},function(e,i){e.exports=t},function(e,t){e.exports=function(e,t,i){var s=e.direction,r=e.value;switch(s){case"top":return i.top+r<t.top&&i.bottom>t.bottom&&i.left<t.left&&i.right>t.right;case"left":return i.left+r<t.left&&i.bottom>t.bottom&&i.top<t.top&&i.right>t.right;case"bottom":return i.bottom-r>t.bottom&&i.left<t.left&&i.right>t.right&&i.top<t.top;case"right":return i.right-r>t.right&&i.left<t.left&&i.top<t.top&&i.bottom>t.bottom}}},function(e,t,i){i.r(t),i.d(t,"default",(function(){return v}));var s=i(1),r=i.n(s),n=i(2),a=i.n(n),o=i(0),l=i.n(o),h=i(3),c=i.n(h);function d(e){return d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},d(e)}function u(e,t,i){return t&&function(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(e.prototype,t),e}function f(e){return f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},f(e)}function p(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function m(e,t){return m=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},m(e,t)}function g(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var v=function(e){function t(e){var i;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),i=function(e,t){return!t||"object"!==d(t)&&"function"!=typeof t?p(e):t}(this,f(t).call(this,e)),g(p(i),"getContainer",(function(){return i.props.containment||window})),g(p(i),"addEventListener",(function(e,t,s,r){var n;i.debounceCheck||(i.debounceCheck={});var a=function(){n=null,i.check()},o={target:e,fn:r>-1?function(){n||(n=setTimeout(a,r||0))}:function(){clearTimeout(n),n=setTimeout(a,s||0)},getLastTimeout:function(){return n}};e.addEventListener(t,o.fn),i.debounceCheck[t]=o})),g(p(i),"startWatching",(function(){i.debounceCheck||i.interval||(i.props.intervalCheck&&(i.interval=setInterval(i.check,i.props.intervalDelay)),i.props.scrollCheck&&i.addEventListener(i.getContainer(),"scroll",i.props.scrollDelay,i.props.scrollThrottle),i.props.resizeCheck&&i.addEventListener(window,"resize",i.props.resizeDelay,i.props.resizeThrottle),!i.props.delayedCall&&i.check())})),g(p(i),"stopWatching",(function(){if(i.debounceCheck)for(var e in i.debounceCheck)if(i.debounceCheck.hasOwnProperty(e)){var t=i.debounceCheck[e];clearTimeout(t.getLastTimeout()),t.target.removeEventListener(e,t.fn),i.debounceCheck[e]=null}i.debounceCheck=null,i.interval&&(i.interval=clearInterval(i.interval))})),g(p(i),"check",(function(){var e,t,s=i.node;if(!s)return i.state;if(e=function(e){return void 0===e.width&&(e.width=e.right-e.left),void 0===e.height&&(e.height=e.bottom-e.top),e}(i.roundRectDown(s.getBoundingClientRect())),i.props.containment){var r=i.props.containment.getBoundingClientRect();t={top:r.top,left:r.left,bottom:r.bottom,right:r.right}}else t={top:0,left:0,bottom:window.innerHeight||document.documentElement.clientHeight,right:window.innerWidth||document.documentElement.clientWidth};var n=i.props.offset||{};"object"===d(n)&&(t.top+=n.top||0,t.left+=n.left||0,t.bottom-=n.bottom||0,t.right-=n.right||0);var a={top:e.top>=t.top,left:e.left>=t.left,bottom:e.bottom<=t.bottom,right:e.right<=t.right},o=e.height>0&&e.width>0,l=o&&a.top&&a.left&&a.bottom&&a.right;if(o&&i.props.partialVisibility){var h=e.top<=t.bottom&&e.bottom>=t.top&&e.left<=t.right&&e.right>=t.left;"string"==typeof i.props.partialVisibility&&(h=a[i.props.partialVisibility]),l=i.props.minTopValue?h&&e.top<=t.bottom-i.props.minTopValue:h}"string"==typeof n.direction&&"number"==typeof n.value&&(console.warn("[notice] offset.direction and offset.value have been deprecated. They still work for now, but will be removed in next major version. Please upgrade to the new syntax: { %s: %d }",n.direction,n.value),l=c()(n,e,t));var u=i.state;return i.state.isVisible!==l&&(u={isVisible:l,visibilityRect:a},i.setState(u),i.props.onChange&&i.props.onChange(l)),u})),i.state={isVisible:null,visibilityRect:{}},i}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&m(e,t)}(t,e),u(t,[{key:"componentDidMount",value:function(){this.node=a.a.findDOMNode(this),this.props.active&&this.startWatching()}},{key:"componentWillUnmount",value:function(){this.stopWatching()}},{key:"componentDidUpdate",value:function(e){this.node=a.a.findDOMNode(this),this.props.active&&!e.active?(this.setState({isVisible:null,visibilityRect:{}}),this.startWatching()):this.props.active||this.stopWatching()}},{key:"roundRectDown",value:function(e){return{top:Math.floor(e.top),left:Math.floor(e.left),bottom:Math.floor(e.bottom),right:Math.floor(e.right)}}},{key:"render",value:function(){return this.props.children instanceof Function?this.props.children({isVisible:this.state.isVisible,visibilityRect:this.state.visibilityRect}):r.a.Children.only(this.props.children)}}]),t}(r.a.Component);g(v,"defaultProps",{active:!0,partialVisibility:!1,minTopValue:0,scrollCheck:!1,scrollDelay:250,scrollThrottle:-1,resizeCheck:!1,resizeDelay:250,resizeThrottle:-1,intervalCheck:!0,intervalDelay:100,delayedCall:!1,offset:{},containment:null,children:r.a.createElement("span",null)}),g(v,"propTypes",{onChange:l.a.func,active:l.a.bool,partialVisibility:l.a.oneOfType([l.a.bool,l.a.oneOf(["top","right","bottom","left"])]),delayedCall:l.a.bool,offset:l.a.oneOfType([l.a.shape({top:l.a.number,left:l.a.number,bottom:l.a.number,right:l.a.number}),l.a.shape({direction:l.a.oneOf(["top","right","bottom","left"]),value:l.a.number})]),scrollCheck:l.a.bool,scrollDelay:l.a.number,scrollThrottle:l.a.number,resizeCheck:l.a.bool,resizeDelay:l.a.number,resizeThrottle:l.a.number,intervalCheck:l.a.bool,intervalDelay:l.a.number,containment:"undefined"!=typeof window?l.a.instanceOf(window.Element):l.a.any,children:l.a.oneOfType([l.a.element,l.a.func]),minTopValue:l.a.number})},function(e,t,i){var s=i(6);function r(){}function n(){}n.resetWarningCache=r,e.exports=function(){function e(e,t,i,r,n,a){if(a!==s){var o=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw o.name="Invariant Violation",o}}function t(){return e}e.isRequired=e;var i={array:e,bool:e,func:e,number:e,object:e,string:e,symbol:e,any:e,arrayOf:t,element:e,elementType:e,instanceOf:t,node:e,objectOf:t,oneOf:t,oneOfType:t,shape:t,exact:t,checkPropTypes:n,resetWarningCache:r};return i.PropTypes=i,i}},function(e,t,i){e.exports="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED"}])},ew.exports=e(c(),BS()));var e}var iw=r(tw());class sw extends u.Component{shouldComponentUpdate(e){return JSON.stringify(e.morphs)!==JSON.stringify(this.props.morphs)}render(){const e=this.props.morphs;return e?u.createElement(Ke,{headerText:"MORPH TARGETS",class:"scene-morph-panel",collapsible:!1},Object.keys(e).map((t=>{const i=e[t];return u.createElement("div",{key:`${t}.${i.name}`},u.createElement(Ke,{headerText:i.name,collapsible:!0,class:"morph-target-panel"},Object.keys(i.targets).map((e=>{const s=i.targets[e];return u.createElement("div",{key:e},u.createElement(iw,{offset:{top:-750,bottom:-750}},(({isVisible:i})=>u.createElement("div",null,i?u.createElement(YS,{name:`${s.name}`,precision:2,min:0,max:1,value:s.weight,setProperty:i=>this.props.setProperty(`morphs.${t}.targets.${e}.weight`,i)}):u.createElement("div",{style:{width:30,height:30}})))))}))))}))):null}}const rw=()=>{const e=document.getElementById("panel-left");e&&e.classList.toggle("collapsed")};let nw;const aw=e=>{const t=["Bytes","KB","MB","GB","TB"];if(0===e)return"n/a";const i=Math.min(Math.floor(Math.log(e)/Math.log(1024)),t.length-1);return 0===i?`${e} ${t[i]}`:`${(e/1024**i).toFixed(1)} ${t[i]}`};class ow extends u.Component{shouldComponentUpdate(e){return JSON.stringify(e.sceneData.filenames)!==JSON.stringify(this.props.sceneData.filenames)||e.sceneData.loadTime!==this.props.sceneData.loadTime||e.sceneData.meshCount!==this.props.sceneData.meshCount||e.sceneData.vertexCount!==this.props.sceneData.vertexCount||e.sceneData.primitiveCount!==this.props.sceneData.primitiveCount||e.sceneData.materialCount!==this.props.sceneData.materialCount||e.sceneData.textureVRAM!==this.props.sceneData.textureVRAM||e.sceneData.meshVRAM!==this.props.sceneData.meshVRAM||e.sceneData.bounds!==this.props.sceneData.bounds||e.sceneData.variant.selected!==this.props.sceneData.variant.selected||e.sceneData.variants.list!==this.props.sceneData.variants.list}render(){const e=this.props.sceneData,t=JSON.parse(e.variants.list).map((e=>({v:e,t:e})));return u.createElement(Ke,{headerText:"SCENE",id:"scene-panel",flexShrink:"0",flexGrow:"0",collapsible:!1},u.createElement(HS,{label:"Filename",value:e.filenames.join(", ")}),u.createElement(HS,{label:"Meshes",value:e.meshCount}),u.createElement(HS,{label:"Materials",value:e.materialCount}),u.createElement(HS,{label:"Textures",value:e.textureCount}),u.createElement(HS,{label:"Primitives",value:e.primitiveCount}),u.createElement(HS,{label:"Verts",value:e.vertexCount}),u.createElement(HS,{label:"Mesh VRAM",value:aw(e.meshVRAM)}),u.createElement(HS,{label:"Texture VRAM",value:aw(e.textureVRAM)}),u.createElement(HS,{label:"Load time",value:e.loadTime}),u.createElement(GS,{label:"Bounds",dimensions:3,value:e.bounds,enabled:!1}),u.createElement(QS,{label:"Variant",type:"string",options:t,value:e.variant.selected,setProperty:e=>{this.props.setProperty("scene.variant.selected",e)},enabled:t.length>0}))}}class lw extends u.Component{shouldComponentUpdate(e){return e.sceneData.nodes!==this.props.sceneData.nodes}render(){const e=this.props.sceneData,t=JSON.parse(e.nodes),i=e=>e.map((e=>u.createElement(At,{text:`${e.name}`,key:e.path,onSelect:t=>{this.props.setProperty("scene.selectedNode.path",e.path);const i=US(document.body,(()=>{t.selected=!1,i()}),4)},onDeselect:()=>this.props.setProperty("scene.selectedNode.path","")},i(e.children))));return u.createElement(Ke,{headerText:"HIERARCHY",class:"scene-hierarchy-panel",enabled:t.length>0,collapsible:!1},t.length>0&&u.createElement(Et,{allowReordering:!1,allowDrag:!1},i(t)))}}class hw extends u.Component{shouldComponentUpdate(e){return JSON.stringify(e.observerData.runtime)!==JSON.stringify(this.props.observerData.runtime)||e.observerData.enableWebGPU!==this.props.observerData.enableWebGPU}render(){const e=this.props.observerData.runtime;return u.createElement(Ke,{headerText:"DEVICE",id:"device-panel",collapsible:!1},u.createElement(WS,{label:"Use WebGPU",value:this.props.observerData.enableWebGPU,enabled:void 0!==navigator.gpu,setProperty:e=>this.props.setProperty("enableWebGPU",e)}),u.createElement(HS,{label:"Active Device",value:"webgpu"===e.activeDeviceType?"webgpu (beta)":e.activeDeviceType}),u.createElement(HS,{label:"Viewport",value:`${e.viewportWidth} x ${e.viewportHeight}`}))}}class cw extends u.Component{isMobile;constructor(e){super(e),this.isMobile=/Android|webOS|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}shouldComponentUpdate(e){return JSON.stringify(e.observerData.scene)!==JSON.stringify(this.props.observerData.scene)||JSON.stringify(e.observerData.runtime)!==JSON.stringify(this.props.observerData.runtime)}componentDidMount(){document.getElementById("panel-toggle").addEventListener("click",(()=>{rw()})),document.getElementById("title").addEventListener("click",(()=>{rw()})),setTimeout((()=>rw()))}componentDidUpdate(e){this.isMobile||this.props.observerData.ui.fullscreen||"[]"===this.props.observerData.scene.nodes||"[]"!==e.observerData.scene.nodes||(nw||(nw=document.getElementById("panel-left")),nw&&nw.classList.contains("collapsed")&&nw.classList.remove("collapsed"))}render(){const e=this.props.observerData.scene,t=this.props.observerData.morphs;return u.createElement(_e,{flex:!0},u.createElement(ow,{sceneData:e,setProperty:this.props.setProperty}),u.createElement("div",{id:"scene-scrolly-bits"},u.createElement(lw,{sceneData:e,setProperty:this.props.setProperty}),u.createElement(sw,{progress:this.props.observerData.animation.progress,morphs:t,setProperty:this.props.setProperty})),u.createElement(hw,{observerData:this.props.observerData,setProperty:this.props.setProperty}))}}var dw="1.0.0";const uw=e=>{const[t,i]=d.useState(!1),s=d.useRef(null);return u.createElement("div",{id:"load-controls"},u.createElement(_e,{class:"load-button-panel",enabled:!0,flex:!0},u.createElement("div",{className:"header"},u.createElement("img",{src:"static/playcanvas-logo.png"}),u.createElement("div",null,u.createElement(qe,{text:`MODEL VIEWER v${dw}`})),u.createElement(ae,{onClick:()=>{window.open("https://github.com/playcanvas/model-viewer","_blank").focus()},icon:"E259"})),u.createElement("input",{type:"file",id:"file",accept:".glb,.gltf,.ply",multiple:!0,onChange:e=>{const t=window.viewer,i=e.target.files;if(t&&i.length){const e=[];for(let t=0;t<i.length;++t){const s=i[t];e.push({url:URL.createObjectURL(s),filename:s.name})}t.loadFiles(e)}},ref:s,style:{display:"none"}}),u.createElement("div",{id:"drag-drop",onClick:()=>{s.current.click()}},u.createElement(ae,{id:"drag-drop-search-icon",icon:"E129"}),u.createElement(qe,{class:"desktop",text:"Drag & drop .glb, .gltf, or .ply files, or click to open files"}),u.createElement(qe,{class:"mobile",text:"Click to open files"})),u.createElement(qe,{id:"or-text",text:"OR",class:"centered-label"}),u.createElement(ot,{class:"secondary",id:"glb-url-input",placeholder:"Enter .glb, .gltf, or .ply URL",keyChange:!0,onValidate:e=>{const t=(e=>{try{return new URL(e),!0}catch{return!1}})(e);return i(t),t}}),u.createElement(ae,{class:"secondary",id:"glb-url-button",text:"LOAD MODEL FROM URL",onClick:()=>{const e=window.viewer,t=document.getElementById("glb-url-input").ui.value,i=new URL(t).pathname.split("/").pop(),s=!!i.split(".").splice(1).pop();e.loadFiles([{url:t,filename:i+(s?"":".glb")}])},enabled:t})))};class fw extends u.Component{shouldComponentUpdate(e){return e.animationData.list!==this.props.animationData.list||e.animationData.playing!==this.props.animationData.playing||e.animationData.selectedTrack!==this.props.animationData.selectedTrack}render(){const e=this.props,t=JSON.parse(e.animationData.list).map((e=>({v:e,t:e})));return u.createElement(JS,{id:"anim-track-select",width:160,type:"string",options:t,setProperty:t=>e.setProperty("animation.selectedTrack",t),value:e.animationData.selectedTrack})}}class pw extends u.Component{shouldComponentUpdate(e){return e.animationData.speed!==this.props.animationData.speed}render(){const e=this.props;return u.createElement(JS,{id:"anim-speed-select",width:60,type:"string",setProperty:t=>e.setProperty("animation.speed",t),value:e.animationData.speed,options:[{v:"0.25",t:"0.25x"},{v:"0.5",t:"0.5x"},{v:"1",t:"1x"},{v:"1.5",t:"1.5x"},{v:"2",t:"2x"}]})}}class mw extends u.Component{animationState;shouldComponentUpdate(e){return JSON.stringify(e.animationData)!==JSON.stringify(this.props.animationData)}componentDidUpdate(){this.animationState=this.props.animationData}render(){const e=this.props;return JSON.parse(e.animationData.list).length>0?u.createElement("div",{className:"animation-controls-panel-parent"},u.createElement(ae,{class:"anim-control-button",width:30,height:30,icon:e.animationData.playing?"E376":"E286",text:"",onClick:()=>{e.setProperty("animation.playing",!this.animationState.playing)}}),u.createElement(fw,{animationData:this.props.animationData,setProperty:this.props.setProperty}),u.createElement($S,{id:"anim-scrub-slider",width:240,precision:2,min:0,max:1,setProperty:t=>{const i=this.animationState;i.playing=!1,i.progress=t,e.setProperty("animation",i)},value:e.animationData.progress}),u.createElement(pw,{animationData:this.props.animationData,setProperty:this.props.setProperty})):u.createElement("div",null)}}var gw,vw={exports:{}};function _w(){return gw||(gw=1,vw.exports=function(){var e=function(){},t=Object.prototype.hasOwnProperty,i=Array.prototype.slice;function s(t,i){var s;return"function"==typeof Object.create?s=Object.create(t):(e.prototype=t,s=new e,e.prototype=null),i&&n(!0,s,i),s}function r(e,t,i,r){var a=this;return"string"!=typeof e&&(r=i,i=t,t=e,e=null),"function"!=typeof t&&(r=i,i=t,t=function(){return a.apply(this,arguments)}),n(!1,t,a,r),t.prototype=s(a.prototype,i),t.prototype.constructor=t,t.class_=e||a.class_,t.super_=a,t}function n(e,s,r){for(var n,a,o=0,l=(r=i.call(arguments,2)).length;o<l;o++)for(n in a=r[o])e&&!t.call(a,n)||(s[n]=a[n])}var a=r;function o(){}o.class_="Nevis",o.super_=Object,o.extend=a;var l=o,h=l.extend((function(e,t,i){this.qrious=e,this.element=t,this.element.qrious=e,this.enabled=Boolean(i)}),{draw:function(e){},getElement:function(){return this.enabled||(this.enabled=!0,this.render()),this.element},getModuleSize:function(e){var t=this.qrious,i=t.padding||0,s=Math.floor((t.size-2*i)/e.width);return Math.max(1,s)},getOffset:function(e){var t=this.qrious,i=t.padding;if(null!=i)return i;var s=this.getModuleSize(e),r=Math.floor((t.size-s*e.width)/2);return Math.max(0,r)},render:function(e){this.enabled&&(this.resize(),this.reset(),this.draw(e))},reset:function(){},resize:function(){}}),c=h,d=c.extend({draw:function(e){var t,i,s=this.qrious,r=this.getModuleSize(e),n=this.getOffset(e),a=this.element.getContext("2d");for(a.fillStyle=s.foreground,a.globalAlpha=s.foregroundAlpha,t=0;t<e.width;t++)for(i=0;i<e.width;i++)e.buffer[i*e.width+t]&&a.fillRect(r*t+n,r*i+n,r,r)},reset:function(){var e=this.qrious,t=this.element.getContext("2d"),i=e.size;t.lineWidth=1,t.clearRect(0,0,i,i),t.fillStyle=e.background,t.globalAlpha=e.backgroundAlpha,t.fillRect(0,0,i,i)},resize:function(){var e=this.element;e.width=e.height=this.qrious.size}}),u=d,f=l.extend(null,{BLOCK:[0,11,15,19,23,27,31,16,18,20,22,24,26,28,20,22,24,24,26,28,28,22,24,24,26,26,28,28,24,24,26,26,26,28,28,24,26,26,26,28,28]}),p=l.extend(null,{BLOCKS:[1,0,19,7,1,0,16,10,1,0,13,13,1,0,9,17,1,0,34,10,1,0,28,16,1,0,22,22,1,0,16,28,1,0,55,15,1,0,44,26,2,0,17,18,2,0,13,22,1,0,80,20,2,0,32,18,2,0,24,26,4,0,9,16,1,0,108,26,2,0,43,24,2,2,15,18,2,2,11,22,2,0,68,18,4,0,27,16,4,0,19,24,4,0,15,28,2,0,78,20,4,0,31,18,2,4,14,18,4,1,13,26,2,0,97,24,2,2,38,22,4,2,18,22,4,2,14,26,2,0,116,30,3,2,36,22,4,4,16,20,4,4,12,24,2,2,68,18,4,1,43,26,6,2,19,24,6,2,15,28,4,0,81,20,1,4,50,30,4,4,22,28,3,8,12,24,2,2,92,24,6,2,36,22,4,6,20,26,7,4,14,28,4,0,107,26,8,1,37,22,8,4,20,24,12,4,11,22,3,1,115,30,4,5,40,24,11,5,16,20,11,5,12,24,5,1,87,22,5,5,41,24,5,7,24,30,11,7,12,24,5,1,98,24,7,3,45,28,15,2,19,24,3,13,15,30,1,5,107,28,10,1,46,28,1,15,22,28,2,17,14,28,5,1,120,30,9,4,43,26,17,1,22,28,2,19,14,28,3,4,113,28,3,11,44,26,17,4,21,26,9,16,13,26,3,5,107,28,3,13,41,26,15,5,24,30,15,10,15,28,4,4,116,28,17,0,42,26,17,6,22,28,19,6,16,30,2,7,111,28,17,0,46,28,7,16,24,30,34,0,13,24,4,5,121,30,4,14,47,28,11,14,24,30,16,14,15,30,6,4,117,30,6,14,45,28,11,16,24,30,30,2,16,30,8,4,106,26,8,13,47,28,7,22,24,30,22,13,15,30,10,2,114,28,19,4,46,28,28,6,22,28,33,4,16,30,8,4,122,30,22,3,45,28,8,26,23,30,12,28,15,30,3,10,117,30,3,23,45,28,4,31,24,30,11,31,15,30,7,7,116,30,21,7,45,28,1,37,23,30,19,26,15,30,5,10,115,30,19,10,47,28,15,25,24,30,23,25,15,30,13,3,115,30,2,29,46,28,42,1,24,30,23,28,15,30,17,0,115,30,10,23,46,28,10,35,24,30,19,35,15,30,17,1,115,30,14,21,46,28,29,19,24,30,11,46,15,30,13,6,115,30,14,23,46,28,44,7,24,30,59,1,16,30,12,7,121,30,12,26,47,28,39,14,24,30,22,41,15,30,6,14,121,30,6,34,47,28,46,10,24,30,2,64,15,30,17,4,122,30,29,14,46,28,49,10,24,30,24,46,15,30,4,18,122,30,13,32,46,28,48,14,24,30,42,32,15,30,20,4,117,30,40,7,47,28,43,22,24,30,10,67,15,30,19,6,118,30,18,31,47,28,34,34,24,30,20,61,15,30],FINAL_FORMAT:[30660,29427,32170,30877,26159,25368,27713,26998,21522,20773,24188,23371,17913,16590,20375,19104,13663,12392,16177,14854,9396,8579,11994,11245,5769,5054,7399,6608,1890,597,3340,2107],LEVELS:{L:1,M:2,Q:3,H:4}}),m=l.extend(null,{EXPONENT:[1,2,4,8,16,32,64,128,29,58,116,232,205,135,19,38,76,152,45,90,180,117,234,201,143,3,6,12,24,48,96,192,157,39,78,156,37,74,148,53,106,212,181,119,238,193,159,35,70,140,5,10,20,40,80,160,93,186,105,210,185,111,222,161,95,190,97,194,153,47,94,188,101,202,137,15,30,60,120,240,253,231,211,187,107,214,177,127,254,225,223,163,91,182,113,226,217,175,67,134,17,34,68,136,13,26,52,104,208,189,103,206,129,31,62,124,248,237,199,147,59,118,236,197,151,51,102,204,133,23,46,92,184,109,218,169,79,158,33,66,132,21,42,84,168,77,154,41,82,164,85,170,73,146,57,114,228,213,183,115,230,209,191,99,198,145,63,126,252,229,215,179,123,246,241,255,227,219,171,75,150,49,98,196,149,55,110,220,165,87,174,65,130,25,50,100,200,141,7,14,28,56,112,224,221,167,83,166,81,162,89,178,121,242,249,239,195,155,43,86,172,69,138,9,18,36,72,144,61,122,244,245,247,243,251,235,203,139,11,22,44,88,176,125,250,233,207,131,27,54,108,216,173,71,142,0],LOG:[255,0,1,25,2,50,26,198,3,223,51,238,27,104,199,75,4,100,224,14,52,141,239,129,28,193,105,248,200,8,76,113,5,138,101,47,225,36,15,33,53,147,142,218,240,18,130,69,29,181,194,125,106,39,249,185,201,154,9,120,77,228,114,166,6,191,139,98,102,221,48,253,226,152,37,179,16,145,34,136,54,208,148,206,143,150,219,189,241,210,19,92,131,56,70,64,30,66,182,163,195,72,126,110,107,58,40,84,250,133,186,61,202,94,155,159,10,21,121,43,78,212,229,172,115,243,167,87,7,112,192,247,140,128,99,13,103,74,222,237,49,197,254,24,227,165,153,119,38,184,180,124,17,68,146,217,35,32,137,46,55,63,209,91,149,188,207,205,144,135,151,178,220,252,190,97,242,86,211,171,20,42,93,158,132,60,57,83,71,109,65,162,31,45,67,216,183,123,164,118,196,23,73,236,127,12,111,246,108,161,59,82,41,157,85,170,251,96,134,177,187,204,62,90,203,89,95,176,156,169,160,81,11,245,22,235,122,117,44,215,79,174,213,233,230,231,173,232,116,214,244,234,168,80,88,175]}),g=l.extend(null,{BLOCK:[3220,1468,2713,1235,3062,1890,2119,1549,2344,2936,1117,2583,1330,2470,1667,2249,2028,3780,481,4011,142,3098,831,3445,592,2517,1776,2234,1951,2827,1070,2660,1345,3177]}),v=g,_=l.extend((function(e){var t,i,s,r,n,a=e.value.length;for(this._badness=[],this._level=p.LEVELS[e.level],this._polynomial=[],this._value=e.value,this._version=0,this._stringBuffer=[];this._version<40&&(this._version++,s=4*(this._level-1)+16*(this._version-1),r=p.BLOCKS[s++],n=p.BLOCKS[s++],t=p.BLOCKS[s++],i=p.BLOCKS[s],!(a<=(s=t*(r+n)+n-3+(this._version<=9)))););this._dataBlock=t,this._eccBlock=i,this._neccBlock1=r,this._neccBlock2=n;var o=this.width=17+4*this._version;this.buffer=_._createArray(o*o),this._ecc=_._createArray(t+(t+i)*(r+n)+n),this._mask=_._createArray((o*(o+1)+1)/2),this._insertFinders(),this._insertAlignments(),this.buffer[8+o*(o-8)]=1,this._insertTimingGap(),this._reverseMask(),this._insertTimingRowAndColumn(),this._insertVersion(),this._syncMask(),this._convertBitStream(a),this._calculatePolynomial(),this._appendEccToData(),this._interleaveBlocks(),this._pack(),this._finish()}),{_addAlignment:function(e,t){var i,s=this.buffer,r=this.width;for(s[e+r*t]=1,i=-2;i<2;i++)s[e+i+r*(t-2)]=1,s[e-2+r*(t+i+1)]=1,s[e+2+r*(t+i)]=1,s[e+i+1+r*(t+2)]=1;for(i=0;i<2;i++)this._setMask(e-1,t+i),this._setMask(e+1,t-i),this._setMask(e-i,t-1),this._setMask(e+i,t+1)},_appendData:function(e,t,i,s){var r,n,a,o=this._polynomial,l=this._stringBuffer;for(n=0;n<s;n++)l[i+n]=0;for(n=0;n<t;n++){if(255!==(r=m.LOG[l[e+n]^l[i]]))for(a=1;a<s;a++)l[i+a-1]=l[i+a]^m.EXPONENT[_._modN(r+o[s-a])];else for(a=i;a<i+s;a++)l[a]=l[a+1];l[i+s-1]=255===r?0:m.EXPONENT[_._modN(r+o[0])]}},_appendEccToData:function(){var e,t=0,i=this._dataBlock,s=this._calculateMaxLength(),r=this._eccBlock;for(e=0;e<this._neccBlock1;e++)this._appendData(t,i,s,r),t+=i,s+=r;for(e=0;e<this._neccBlock2;e++)this._appendData(t,i+1,s,r),t+=i+1,s+=r},_applyMask:function(e){var t,i,s,r,n=this.buffer,a=this.width;switch(e){case 0:for(r=0;r<a;r++)for(s=0;s<a;s++)s+r&1||this._isMasked(s,r)||(n[s+r*a]^=1);break;case 1:for(r=0;r<a;r++)for(s=0;s<a;s++)1&r||this._isMasked(s,r)||(n[s+r*a]^=1);break;case 2:for(r=0;r<a;r++)for(t=0,s=0;s<a;s++,t++)3===t&&(t=0),t||this._isMasked(s,r)||(n[s+r*a]^=1);break;case 3:for(i=0,r=0;r<a;r++,i++)for(3===i&&(i=0),t=i,s=0;s<a;s++,t++)3===t&&(t=0),t||this._isMasked(s,r)||(n[s+r*a]^=1);break;case 4:for(r=0;r<a;r++)for(t=0,i=r>>1&1,s=0;s<a;s++,t++)3===t&&(t=0,i=!i),i||this._isMasked(s,r)||(n[s+r*a]^=1);break;case 5:for(i=0,r=0;r<a;r++,i++)for(3===i&&(i=0),t=0,s=0;s<a;s++,t++)3===t&&(t=0),(s&r&1)+!(!t|!i)||this._isMasked(s,r)||(n[s+r*a]^=1);break;case 6:for(i=0,r=0;r<a;r++,i++)for(3===i&&(i=0),t=0,s=0;s<a;s++,t++)3===t&&(t=0),(s&r&1)+(t&&t===i)&1||this._isMasked(s,r)||(n[s+r*a]^=1);break;case 7:for(i=0,r=0;r<a;r++,i++)for(3===i&&(i=0),t=0,s=0;s<a;s++,t++)3===t&&(t=0),(t&&t===i)+(s+r&1)&1||this._isMasked(s,r)||(n[s+r*a]^=1)}},_calculateMaxLength:function(){return this._dataBlock*(this._neccBlock1+this._neccBlock2)+this._neccBlock2},_calculatePolynomial:function(){var e,t,i=this._eccBlock,s=this._polynomial;for(s[0]=1,e=0;e<i;e++){for(s[e+1]=1,t=e;t>0;t--)s[t]=s[t]?s[t-1]^m.EXPONENT[_._modN(m.LOG[s[t]]+e)]:s[t-1];s[0]=m.EXPONENT[_._modN(m.LOG[s[0]]+e)]}for(e=0;e<=i;e++)s[e]=m.LOG[s[e]]},_checkBadness:function(){var e,t,i,s,r,n=0,a=this._badness,o=this.buffer,l=this.width;for(r=0;r<l-1;r++)for(s=0;s<l-1;s++)(o[s+l*r]&&o[s+1+l*r]&&o[s+l*(r+1)]&&o[s+1+l*(r+1)]||!(o[s+l*r]||o[s+1+l*r]||o[s+l*(r+1)]||o[s+1+l*(r+1)]))&&(n+=_.N2);var h=0;for(r=0;r<l;r++){for(i=0,a[0]=0,e=0,s=0;s<l;s++)e===(t=o[s+l*r])?a[i]++:a[++i]=1,h+=(e=t)?1:-1;n+=this._getBadness(i)}h<0&&(h=-h);var c=0,d=h;for(d+=d<<2,d<<=1;d>l*l;)d-=l*l,c++;for(n+=c*_.N4,s=0;s<l;s++){for(i=0,a[0]=0,e=0,r=0;r<l;r++)e===(t=o[s+l*r])?a[i]++:a[++i]=1,e=t;n+=this._getBadness(i)}return n},_convertBitStream:function(e){var t,i,s=this._ecc,r=this._version;for(i=0;i<e;i++)s[i]=this._value.charCodeAt(i);var n=this._stringBuffer=s.slice(),a=this._calculateMaxLength();e>=a-2&&(e=a-2,r>9&&e--);var o=e;if(r>9){for(n[o+2]=0,n[o+3]=0;o--;)t=n[o],n[o+3]|=255&t<<4,n[o+2]=t>>4;n[2]|=255&e<<4,n[1]=e>>4,n[0]=64|e>>12}else{for(n[o+1]=0,n[o+2]=0;o--;)t=n[o],n[o+2]|=255&t<<4,n[o+1]=t>>4;n[1]|=255&e<<4,n[0]=64|e>>4}for(o=e+3-(r<10);o<a;)n[o++]=236,n[o++]=17},_getBadness:function(e){var t,i=0,s=this._badness;for(t=0;t<=e;t++)s[t]>=5&&(i+=_.N1+s[t]-5);for(t=3;t<e-1;t+=2)s[t-2]===s[t+2]&&s[t+2]===s[t-1]&&s[t-1]===s[t+1]&&3*s[t-1]===s[t]&&(0===s[t-3]||t+3>e||3*s[t-3]>=4*s[t]||3*s[t+3]>=4*s[t])&&(i+=_.N3);return i},_finish:function(){var e,t;this._stringBuffer=this.buffer.slice();var i=0,s=3e4;for(t=0;t<8&&(this._applyMask(t),(e=this._checkBadness())<s&&(s=e,i=t),7!==i);t++)this.buffer=this._stringBuffer.slice();i!==t&&this._applyMask(i),s=p.FINAL_FORMAT[i+(this._level-1<<3)];var r=this.buffer,n=this.width;for(t=0;t<8;t++,s>>=1)1&s&&(r[n-1-t+8*n]=1,t<6?r[8+n*t]=1:r[8+n*(t+1)]=1);for(t=0;t<7;t++,s>>=1)1&s&&(r[8+n*(n-7+t)]=1,t?r[6-t+8*n]=1:r[7+8*n]=1)},_interleaveBlocks:function(){var e,t,i=this._dataBlock,s=this._ecc,r=this._eccBlock,n=0,a=this._calculateMaxLength(),o=this._neccBlock1,l=this._neccBlock2,h=this._stringBuffer;for(e=0;e<i;e++){for(t=0;t<o;t++)s[n++]=h[e+t*i];for(t=0;t<l;t++)s[n++]=h[o*i+e+t*(i+1)]}for(t=0;t<l;t++)s[n++]=h[o*i+e+t*(i+1)];for(e=0;e<r;e++)for(t=0;t<o+l;t++)s[n++]=h[a+e+t*r];this._stringBuffer=s},_insertAlignments:function(){var e,t,i,s=this._version,r=this.width;if(s>1)for(e=f.BLOCK[s],i=r-7;;){for(t=r-7;t>e-3&&(this._addAlignment(t,i),!(t<e));)t-=e;if(i<=e+9)break;i-=e,this._addAlignment(6,i),this._addAlignment(i,6)}},_insertFinders:function(){var e,t,i,s,r=this.buffer,n=this.width;for(e=0;e<3;e++){for(t=0,s=0,1===e&&(t=n-7),2===e&&(s=n-7),r[s+3+n*(t+3)]=1,i=0;i<6;i++)r[s+i+n*t]=1,r[s+n*(t+i+1)]=1,r[s+6+n*(t+i)]=1,r[s+i+1+n*(t+6)]=1;for(i=1;i<5;i++)this._setMask(s+i,t+1),this._setMask(s+1,t+i+1),this._setMask(s+5,t+i),this._setMask(s+i+1,t+5);for(i=2;i<4;i++)r[s+i+n*(t+2)]=1,r[s+2+n*(t+i+1)]=1,r[s+4+n*(t+i)]=1,r[s+i+1+n*(t+4)]=1}},_insertTimingGap:function(){var e,t,i=this.width;for(t=0;t<7;t++)this._setMask(7,t),this._setMask(i-8,t),this._setMask(7,t+i-7);for(e=0;e<8;e++)this._setMask(e,7),this._setMask(e+i-8,7),this._setMask(e,i-8)},_insertTimingRowAndColumn:function(){var e,t=this.buffer,i=this.width;for(e=0;e<i-14;e++)1&e?(this._setMask(8+e,6),this._setMask(6,8+e)):(t[8+e+6*i]=1,t[6+i*(8+e)]=1)},_insertVersion:function(){var e,t,i,s,r=this.buffer,n=this._version,a=this.width;if(n>6)for(e=v.BLOCK[n-7],t=17,i=0;i<6;i++)for(s=0;s<3;s++,t--)1&(t>11?n>>t-12:e>>t)?(r[5-i+a*(2-s+a-11)]=1,r[2-s+a-11+a*(5-i)]=1):(this._setMask(5-i,2-s+a-11),this._setMask(2-s+a-11,5-i))},_isMasked:function(e,t){var i=_._getMaskBit(e,t);return 1===this._mask[i]},_pack:function(){var e,t,i,s=1,r=1,n=this.width,a=n-1,o=n-1,l=(this._dataBlock+this._eccBlock)*(this._neccBlock1+this._neccBlock2)+this._neccBlock2;for(t=0;t<l;t++)for(e=this._stringBuffer[t],i=0;i<8;i++,e<<=1){128&e&&(this.buffer[a+n*o]=1);do{r?a--:(a++,s?0!==o?o--:(s=!s,6==(a-=2)&&(a--,o=9)):o!==n-1?o++:(s=!s,6==(a-=2)&&(a--,o-=8))),r=!r}while(this._isMasked(a,o))}},_reverseMask:function(){var e,t,i=this.width;for(e=0;e<9;e++)this._setMask(e,8);for(e=0;e<8;e++)this._setMask(e+i-8,8),this._setMask(8,e);for(t=0;t<7;t++)this._setMask(8,t+i-7)},_setMask:function(e,t){var i=_._getMaskBit(e,t);this._mask[i]=1},_syncMask:function(){var e,t,i=this.width;for(t=0;t<i;t++)for(e=0;e<=t;e++)this.buffer[e+i*t]&&this._setMask(e,t)}},{_createArray:function(e){var t,i=[];for(t=0;t<e;t++)i[t]=0;return i},_getMaskBit:function(e,t){var i;return e>t&&(i=e,e=t,t=i),i=t,i+=t*t,i>>=1,i+=e},_modN:function(e){for(;e>=255;)e=((e-=255)>>8)+(255&e);return e},N1:3,N2:3,N3:40,N4:10}),b=_,y=c.extend({draw:function(){this.element.src=this.qrious.toDataURL()},reset:function(){this.element.src=""},resize:function(){var e=this.element;e.width=e.height=this.qrious.size}}),x=l.extend((function(e,t,i,s){this.name=e,this.modifiable=Boolean(t),this.defaultValue=i,this._valueTransformer=s}),{transform:function(e){var t=this._valueTransformer;return"function"==typeof t?t(e,this):e}}),S=l.extend(null,{abs:function(e){return null!=e?Math.abs(e):null},hasOwn:function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},noop:function(){},toUpperCase:function(e){return null!=e?e.toUpperCase():null}}),w=l.extend((function(e){this.options={},e.forEach((function(e){this.options[e.name]=e}),this)}),{exists:function(e){return null!=this.options[e]},get:function(e,t){return w._get(this.options[e],t)},getAll:function(e){var t,i=this.options,s={};for(t in i)S.hasOwn(i,t)&&(s[t]=w._get(i[t],e));return s},init:function(e,t,i){var s,r;for(s in"function"!=typeof i&&(i=S.noop),this.options)S.hasOwn(this.options,s)&&(r=this.options[s],w._set(r,r.defaultValue,t),w._createAccessor(r,t,i));this._setAll(e,t,!0)},set:function(e,t,i){return this._set(e,t,i)},setAll:function(e,t){return this._setAll(e,t)},_set:function(e,t,i,s){var r=this.options[e];if(!r)throw new Error("Invalid option: "+e);if(!r.modifiable&&!s)throw new Error("Option cannot be modified: "+e);return w._set(r,t,i)},_setAll:function(e,t,i){if(!e)return!1;var s,r=!1;for(s in e)S.hasOwn(e,s)&&this._set(s,e[s],t,i)&&(r=!0);return r}},{_createAccessor:function(e,t,i){var s={get:function(){return w._get(e,t)}};e.modifiable&&(s.set=function(s){w._set(e,s,t)&&i(s,e)}),Object.defineProperty(t,e.name,s)},_get:function(e,t){return t["_"+e.name]},_set:function(e,t,i){var s="_"+e.name,r=i[s],n=e.transform(null!=t?t:e.defaultValue);return i[s]=n,n!==r}}),T=w,C=l.extend((function(){this._services={}}),{getService:function(e){var t=this._services[e];if(!t)throw new Error("Service is not being managed with name: "+e);return t},setService:function(e,t){if(this._services[e])throw new Error("Service is already managed with name: "+e);t&&(this._services[e]=t)}}),E=new T([new x("background",!0,"white"),new x("backgroundAlpha",!0,1,S.abs),new x("element"),new x("foreground",!0,"black"),new x("foregroundAlpha",!0,1,S.abs),new x("level",!0,"L",S.toUpperCase),new x("mime",!0,"image/png"),new x("padding",!0,null,S.abs),new x("size",!0,100,S.abs),new x("value",!0,"")]),A=new C,P=l.extend((function(e){E.init(e,this,this.update.bind(this));var t=E.get("element",this),i=A.getService("element"),s=t&&i.isCanvas(t)?t:i.createCanvas(),r=t&&i.isImage(t)?t:i.createImage();this._canvasRenderer=new u(this,s,!0),this._imageRenderer=new y(this,r,r===t),this.update()}),{get:function(){return E.getAll(this)},set:function(e){E.setAll(e,this)&&this.update()},toDataURL:function(e){return this.canvas.toDataURL(e||this.mime)},update:function(){var e=new b({level:this.level,value:this.value});this._canvasRenderer.render(e),this._imageRenderer.render(e)}},{use:function(e){A.setService(e.getName(),e)}});Object.defineProperties(P.prototype,{canvas:{get:function(){return this._canvasRenderer.getElement()}},image:{get:function(){return this._imageRenderer.getElement()}}});var D=P,L=D,M=l.extend({getName:function(){}}).extend({createCanvas:function(){},createImage:function(){},getName:function(){return"element"},isCanvas:function(e){},isImage:function(e){}}).extend({createCanvas:function(){return document.createElement("canvas")},createImage:function(){return document.createElement("img")},isCanvas:function(e){return e instanceof HTMLCanvasElement},isImage:function(e){return e instanceof HTMLImageElement}});return L.use(new M),L}()),vw.exports}var bw=r(_w());const yw=e=>[e.r,e.g,e.b,1],xw=e=>({r:e[0],g:e[1],b:e[2]});class Sw extends u.Component{shouldComponentUpdate(e){const t=["ui","debug","animation.playing"],i=VS(e.observerData,t),s=VS(this.props.observerData,t);return JSON.stringify(i)!==JSON.stringify(s)}render(){const e=this.props;return u.createElement("div",{className:"popup-panel-parent"},u.createElement(_e,{class:"popup-panel",flex:!0,hidden:"camera"!==e.observerData.ui.active},u.createElement(qe,{text:"Camera",class:"popup-panel-heading"}),u.createElement(qS,{label:"Fov",precision:0,min:35,max:150,value:e.observerData.camera.fov,setProperty:t=>e.setProperty("camera.fov",t)}),u.createElement(QS,{label:"Tonemap",type:"string",options:["None","Linear","Neutral","Filmic","Hejl","ACES","ACES2"].map((e=>({v:e,t:e}))),value:e.observerData.camera.tonemapping,setProperty:t=>e.setProperty("camera.tonemapping",t)}),u.createElement(QS,{label:"Pixel Scale",value:e.observerData.camera.pixelScale,type:"number",options:[1,2,4,8,16].map((e=>({v:e,t:Number(e).toString()}))),setProperty:t=>e.setProperty("camera.pixelScale",t)}),u.createElement(WS,{label:"Multisample",value:e.observerData.camera.multisample,enabled:e.observerData.camera.multisampleSupported,setProperty:t=>e.setProperty("camera.multisample",t)}),u.createElement(WS,{label:"High Quality",value:e.observerData.camera.hq,enabled:!e.observerData.animation.playing&&!e.observerData.debug.stats&&"webgpu"!==e.observerData.runtime.activeDeviceType,setProperty:t=>e.setProperty("camera.hq",t)})))}}class ww extends u.Component{shouldComponentUpdate(e){return JSON.stringify(e.skyboxData)!==JSON.stringify(this.props.skyboxData)||JSON.stringify(e.uiData)!==JSON.stringify(this.props.uiData)}render(){const e=this.props;return u.createElement("div",{className:"popup-panel-parent"},u.createElement(_e,{class:"popup-panel",flex:!0,hidden:"skybox"!==e.uiData.active},u.createElement(qe,{text:"Sky",class:"popup-panel-heading"}),u.createElement(QS,{label:"Environment",type:"string",options:JSON.parse(e.skyboxData.options),value:e.skyboxData.value,setProperty:t=>e.setProperty("skybox.value",t)}),u.createElement(qS,{label:"Exposure",value:e.skyboxData.exposure,setProperty:t=>e.setProperty("skybox.exposure",t),precision:2,min:-6,max:6,enabled:"None"!==e.skyboxData.value}),u.createElement(qS,{label:"Rotation",precision:0,min:-180,max:180,value:e.skyboxData.rotation,setProperty:t=>e.setProperty("skybox.rotation",t),enabled:"None"!==e.skyboxData.value}),u.createElement(QS,{label:"Background",type:"string",options:["Solid Color","Infinite Sphere","Projective Dome","Projective Box"].map((e=>({v:e,t:e}))),value:e.skyboxData.background,setProperty:t=>e.setProperty("skybox.background",t),enabled:"None"!==e.skyboxData.value}),u.createElement(KS,{label:"Background Color",value:yw(e.skyboxData.backgroundColor),setProperty:t=>e.setProperty("skybox.backgroundColor",xw(t)),enabled:"None"===e.skyboxData.value||"Solid Color"===e.skyboxData.background}),u.createElement(qS,{label:"Blur",value:e.skyboxData.blur,setProperty:t=>e.setProperty("skybox.blur",t),enabled:"None"!==e.skyboxData.value&&"Infinite Sphere"===e.skyboxData.background,min:0,max:5,precision:0,step:1}),u.createElement(XS,{label:"Scale",value:e.skyboxData.domeProjection.domeRadius,setProperty:t=>e.setProperty("skybox.domeProjection.domeRadius",t),min:0,max:1e3,enabled:"None"!==e.skyboxData.value&&-1!==["Projective Dome","Projective Box"].indexOf(e.skyboxData.background)}),u.createElement(qS,{label:"Tripod Offset",value:e.skyboxData.domeProjection.tripodOffset,setProperty:t=>e.setProperty("skybox.domeProjection.tripodOffset",t),min:0,max:1,precision:2,enabled:"None"!==e.skyboxData.value&&-1!==["Projective Dome","Projective Box"].indexOf(e.skyboxData.background)})))}}class Tw extends u.Component{shouldComponentUpdate(e){return JSON.stringify(e.lightData)!==JSON.stringify(this.props.lightData)||JSON.stringify(e.uiData)!==JSON.stringify(this.props.uiData)}render(){const e=this.props;return u.createElement("div",{className:"popup-panel-parent"},u.createElement(_e,{class:"popup-panel",flex:!0,hidden:"light"!==e.uiData.active},u.createElement(qe,{text:"Light",class:"popup-panel-heading"}),u.createElement(WS,{label:"Enabled",value:e.lightData.enabled,setProperty:t=>e.setProperty("light.enabled",t)}),u.createElement(WS,{label:"Follow Camera",value:e.lightData.follow,setProperty:t=>e.setProperty("light.follow",t)}),u.createElement(KS,{label:"Color",value:yw(e.lightData.color),setProperty:t=>e.setProperty("light.color",xw(t))}),u.createElement(qS,{label:"Intensity",precision:2,min:0,max:6,value:e.lightData.intensity,setProperty:t=>e.setProperty("light.intensity",t)}),u.createElement(WS,{label:"Cast Shadow",value:e.lightData.shadow,setProperty:t=>e.setProperty("light.shadow",t)}),u.createElement(WS,{label:"Shadow Catcher",value:e.shadowCatcherData.enabled,setProperty:t=>e.setProperty("shadowCatcher.enabled",t)}),u.createElement(qS,{label:"Catcher Intensity",precision:2,min:0,max:1,value:e.shadowCatcherData.intensity,setProperty:t=>e.setProperty("shadowCatcher.intensity",t)})))}}class Cw extends u.Component{shouldComponentUpdate(e){return JSON.stringify(e.debugData)!==JSON.stringify(this.props.debugData)||JSON.stringify(e.uiData)!==JSON.stringify(this.props.uiData)}render(){const e=this.props;return u.createElement("div",{className:"popup-panel-parent"},u.createElement(_e,{class:"popup-panel",flex:!0,hidden:"debug"!==e.uiData.active},u.createElement(qe,{text:"Debug",class:"popup-panel-heading"}),u.createElement(QS,{label:"Render Mode",type:"string",options:[{t:"Default",v:"default"},{t:"Lighting",v:"lighting"},{t:"Albedo",v:"albedo"},{t:"Emissive",v:"emission"},{t:"WorldNormal",v:"world_normal"},{t:"Metalness",v:"metalness"},{t:"Gloss",v:"gloss"},{t:"Ao",v:"ao"},{t:"Specularity",v:"specularity"},{t:"Opacity",v:"opacity"},{t:"Uv0",v:"uv0"}],value:e.debugData.renderMode,setProperty:t=>e.setProperty("debug.renderMode",t)}),u.createElement(jS,{label:"Wireframe",booleanValue:e.debugData.wireframe,setBooleanProperty:t=>e.setProperty("debug.wireframe",t),colorValue:yw(e.debugData.wireframeColor),setColorProperty:t=>e.setProperty("debug.wireframeColor",xw(t))}),u.createElement(WS,{label:"Grid",value:e.debugData.grid,setProperty:t=>e.setProperty("debug.grid",t)}),u.createElement(WS,{label:"Axes",value:e.debugData.axes,setProperty:t=>e.setProperty("debug.axes",t)}),u.createElement(WS,{label:"Skeleton",value:e.debugData.skeleton,setProperty:t=>e.setProperty("debug.skeleton",t)}),u.createElement(WS,{label:"Bounds",value:e.debugData.bounds,setProperty:t=>e.setProperty("debug.bounds",t)}),u.createElement(qS,{label:"Normals",precision:2,min:0,max:1,setProperty:t=>e.setProperty("debug.normals",t),value:e.debugData.normals}),u.createElement(WS,{label:"Stats",value:e.debugData.stats,setProperty:t=>e.setProperty("debug.stats",t)})))}}class Ew extends u.Component{isMobile;get shareUrl(){return`${location.origin}${location.pathname}?${this.props.sceneData.urls.map((e=>`load=${e}`)).join("&")}`}constructor(e){super(e),this.isMobile=/Android|webOS|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}shouldComponentUpdate(e){return JSON.stringify(e.sceneData)!==JSON.stringify(this.props.sceneData)||JSON.stringify(e.uiData)!==JSON.stringify(this.props.uiData)}get hasQRCode(){return this.props.sceneData.urls.length>0&&!this.isMobile}updateQRCode(){const e=document.getElementById("share-qr");new bw({element:e,value:this.shareUrl,size:e.getBoundingClientRect().width*window.devicePixelRatio})}componentDidMount(){this.hasQRCode&&this.updateQRCode()}componentDidUpdate(){this.hasQRCode&&this.updateQRCode()}render(){const e=this.props;return u.createElement("div",{className:"popup-panel-parent"},u.createElement(_e,{id:"view-panel",class:"popup-panel",flex:!0,hidden:"view"!==e.uiData.active},this.hasQRCode?u.createElement(u.Fragment,null,u.createElement(qe,{text:"View and share on mobile with QR code"}),u.createElement("div",{id:"qr-wrapper"},u.createElement("canvas",{id:"share-qr"})),u.createElement(qe,{text:"View and share on mobile with URL"}),u.createElement("div",{id:"share-url-wrapper"},u.createElement(ot,{class:"secondary",value:this.shareUrl,enabled:!1}),u.createElement(ae,{id:"copy-button",icon:"E126",onClick:()=>{navigator.clipboard&&window.isSecureContext&&navigator.clipboard.writeText(this.shareUrl)}}))):null,u.createElement(ae,{class:"secondary",text:"TAKE A SNAPSHOT AS PNG",onClick:()=>{window.viewer&&window.viewer.downloadPngScreenshot()}})))}}const Aw=e=>u.createElement(u.Fragment,null,u.createElement(Sw,{setProperty:e.setProperty,observerData:e.observerData}),u.createElement(ww,{setProperty:e.setProperty,skyboxData:e.observerData.skybox,uiData:e.observerData.ui}),u.createElement(Tw,{setProperty:e.setProperty,lightData:e.observerData.light,uiData:e.observerData.ui,shadowCatcherData:e.observerData.shadowCatcher}),u.createElement(Cw,{setProperty:e.setProperty,debugData:e.observerData.debug,uiData:e.observerData.ui}),u.createElement(Ew,{setProperty:e.setProperty,sceneData:e.observerData.scene,uiData:e.observerData.ui,runtimeData:e.observerData.runtime}));class Pw extends u.Component{popupPanelElement;render(){let e;const t=t=>{this.props.setProperty("ui.active",this.props.observerData.ui.active===t?null:t),this.popupPanelElement||(this.popupPanelElement=document.getElementById("popup")),setTimeout((()=>{e&&e();e=US(document.body,(t=>{this.popupPanelElement.contains(t.target)||(this.props.setProperty("ui.active",null),e(),e=null)}),4)}))},i=e=>this.props.observerData.ui.active===e?["popup-button","selected"]:["popup-button"];return u.createElement("div",{id:"popup-buttons-parent"},u.createElement(mw,{animationData:this.props.observerData.animation,setProperty:this.props.setProperty}),u.createElement(ae,{class:i("camera"),icon:"E212",width:40,height:40,onClick:()=>t("camera")}),u.createElement(ae,{class:i("skybox"),icon:"E200",width:40,height:40,onClick:()=>t("skybox")}),u.createElement(ae,{class:i("light"),icon:"E194",width:40,height:40,onClick:()=>t("light")}),u.createElement(ae,{class:i("debug"),icon:"E134",width:40,height:40,onClick:()=>t("debug")}),u.createElement(ae,{class:i("view"),icon:"E301",width:40,height:40,onClick:()=>t("view")}))}}class Dw extends u.Component{link;usdzExporter;get hasArSupport(){return this.props.observerData.runtime.xrSupported||this.usdzExporter}constructor(e){super(e),this.link=document.getElementById("ar-link"),(this.link.relList.supports("ar")||Boolean(window.webkit?.messageHandlers)&&Boolean(/CriOS\/|EdgiOS\/|FxiOS\/|GSA\/|DuckDuckGo\//.test(navigator.userAgent)))&&(this.usdzExporter=new SS)}render(){return u.createElement("div",{id:"popup",className:"[]"===this.props.observerData.scene.nodes?"empty":null},u.createElement(Aw,{observerData:this.props.observerData,setProperty:this.props.setProperty}),u.createElement(Pw,{observerData:this.props.observerData,setProperty:this.props.setProperty}),u.createElement(ae,{class:"popup-button",id:"launch-ar-button",icon:"E189",hidden:!this.hasArSupport||"[]"===this.props.observerData.scene.nodes,width:40,height:40,onClick:()=>{if(this.usdzExporter){const e=window.viewer.app.root.findByName("sceneRoot");this.usdzExporter.build(e).then((e=>{const t=new Blob([e],{type:"application/octet-stream"});this.link.href=URL.createObjectURL(t),this.link.click()})).catch(console.error)}else window.viewer&&window.viewer.xrMode.start()}}),u.createElement("div",{id:"floating-buttons-parent"},u.createElement(ae,{class:"popup-button",id:"fullscreen-button",icon:"E127",width:40,height:40,onClick:()=>{document.getElementById("panel-left").classList.toggle("collapsed")}})))}}class Lw extends u.Component{shouldComponentUpdate(e){return e.sceneData.nodes!==this.props.sceneData.nodes||e.sceneData.selectedNode.path!==this.props.sceneData.selectedNode.path||e.sceneData.selectedNode.name!==this.props.sceneData.selectedNode.name||e.sceneData.selectedNode.position!==this.props.sceneData.selectedNode.position||e.sceneData.selectedNode.rotation!==this.props.sceneData.selectedNode.rotation||e.sceneData.selectedNode.scale!==this.props.sceneData.selectedNode.scale}render(){const e=this.props.sceneData,t="[]"!==e.nodes,i=e.selectedNode.path;return t&&i?u.createElement("div",{className:"selected-node-panel-parent"},u.createElement(_e,{class:"selected-node-panel",flex:!0},u.createElement(HS,{label:"Name",value:e.selectedNode.name}),u.createElement(GS,{label:"Position",dimensions:3,value:e.selectedNode.position,enabled:!1}),u.createElement(GS,{label:"Rotation",dimensions:3,value:e.selectedNode.rotation,enabled:!1}),u.createElement(GS,{label:"Scale",dimensions:3,value:e.selectedNode.scale,enabled:!1}))):null}}let Mw=class extends u.Component{state=null;canvasRef;constructor(e){super(e),this.canvasRef=u.createRef(),this.state=this._retrieveState(),e.observer.on("*:set",(()=>{this.setState(this._retrieveState())}))}_retrieveState=()=>{const e={};return this.props.observer._keys.forEach((t=>{e[t]=this.props.observer.get(t)})),e};_setStateProperty=(e,t)=>{this.props.observer.set(e,t)};render(){return u.createElement("div",{id:"application-container"},u.createElement(_e,{id:"panel-left",flex:!0,resizable:"right",resizeMin:220,resizeMax:800},u.createElement("div",{className:"header",style:{display:"none"}},u.createElement("div",{id:"title"},u.createElement("img",{src:"static/playcanvas-logo.png"}),u.createElement("div",null,`MODEL VIEWER v${dw}`))),u.createElement("div",{id:"panel-toggle"},u.createElement("img",{src:"static/playcanvas-logo.png"})),u.createElement(cw,{observerData:this.state,setProperty:this._setStateProperty})),u.createElement("div",{id:"canvas-wrapper"},u.createElement("div",{style:{position:"absolute",top:"10px",right:"10px",zIndex:1e4}},u.createElement("button",{style:{padding:"6px 12px",background:"#333",color:"#fff",border:"none",borderRadius:"4px",cursor:"pointer"},onClick:()=>{window.loadPLYSequence()}},"读取默认模型")),u.createElement("canvas",{id:"application-canvas",ref:this.canvasRef}),u.createElement("div",{id:"loader-progress",style:{position:"fixed",top:"60%",left:"50%",transform:"translate(-50%, -50%)",color:"white",fontSize:"18px",background:"rgba(0, 0, 0, 0.75)",padding:"10px 20px",borderRadius:"8px",zIndex:9999,display:"none"}},"加载中..."),u.createElement(uw,{setProperty:this._setStateProperty}),u.createElement(Lw,{sceneData:this.state.scene}),u.createElement(Dw,{observerData:this.state,setProperty:this._setStateProperty}),u.createElement(zS,{observerData:this.state}),u.createElement(at,{id:"spinner",size:30,hidden:!0})))}};const Iw=new di,Rw=new hi,kw=new hi,Ow=new _i,Fw=new bi,Bw=new Mi,Nw=new Di,zw={passive:!1},Uw=(e,t)=>1-Math.pow(e,1e3*t);class CameraControls extends Vv{static EVENT_CLAMP_POSITION="clamp:position";static EVENT_CLAMP_ANGLES="clamp:angles";_camera=null;_origin=new hi;_position=new hi;_dir=new di;_angles=new hi;_pitchRange=new di(-360,360);_zoomMin=0;_zoomMax=0;_zoomDist=0;_cameraDist=0;_pointerEvents=new Map;_lastPinchDist=-1;_lastPosition=new di;_dragging=!1;_orbiting=!0;_panning=!1;_flying=!1;_moving=!1;_focusing=!1;_key={forward:!1,backward:!1,left:!1,right:!1,up:!1,down:!1,sprint:!1,crouch:!1};_element=this.app.graphicsDevice.canvas;_cameraTransform=new _i;_baseTransform=new _i;sceneSize=100;enableOrbit=!0;enablePan=!0;enableFly=!0;focusDamping=.98;rotateSpeed=.2;rotateDamping=.98;moveSpeed=2;moveFastSpeed=4;moveSlowSpeed=1;moveDamping=.98;zoomSpeed=.005;zoomPinchSens=5;zoomDamping=.98;zoomScaleMin=0;initialize(){if(this._onWheel=this._onWheel.bind(this),this._onKeyDown=this._onKeyDown.bind(this),this._onKeyUp=this._onKeyUp.bind(this),this._onPointerDown=this._onPointerDown.bind(this),this._onPointerMove=this._onPointerMove.bind(this),this._onPointerUp=this._onPointerUp.bind(this),this._onContextMenu=this._onContextMenu.bind(this),!this.entity.camera)throw new Error("CameraControls script requires a camera component");this.attach(this.entity.camera),this.focusPoint=this._origin??this.focusPoint,this.pitchRange=this._pitchRange??this.pitchRange,this.zoomMin=this._zoomMin??this.zoomMin,this.zoomMax=this._zoomMax??this.zoomMax,this.on("destroy",this.destroy,this)}set element(e){this._element=e;const t=this._camera;this.detach(),t&&this.attach(t)}get element(){return this._element}set focusPoint(e){this._camera?this.focus(e,this.entity.getPosition(),!1):e instanceof hi&&this._origin.copy(e)}get focusPoint(){return this._origin}set pitchRange(e){e instanceof di&&(this._pitchRange.copy(e),this._clampAngles(this._dir),this._smoothTransform(-1))}get pitchRange(){return this._pitchRange}set zoomMin(e){this._zoomMin=e??this._zoomMin,this._zoomDist=this._clampZoom(this._zoomDist),this._smoothZoom(-1)}get zoomMin(){return this._zoomMin}set zoomMax(e){this._zoomMax=e??this._zoomMax,this._zoomDist=this._clampZoom(this._zoomDist),this._smoothZoom(-1)}get zoomMax(){return this._zoomMax}_focusDir(e){return e.copy(this.entity.forward).mulScalar(this._zoomDist)}_clampAngles(e){const t=-360===this._pitchRange.x?-1/0:this._pitchRange.x,i=360===this._pitchRange.y?1/0:this._pitchRange.y;e.x=ti.clamp(e.x,t,i),this.fire(CameraControls.EVENT_CLAMP_ANGLES,e)}_clampPosition(e){this._flying?Rw.set(0,0,0):this._focusDir(Rw),e.sub(Rw),this.fire(CameraControls.EVENT_CLAMP_POSITION,e),e.add(Rw)}_clampZoom(e){const t=(this._camera?.nearClip??0)+this.zoomMin*this.sceneSize,i=this.zoomMax<=this.zoomMin?1/0:this.zoomMax*this.sceneSize;return ti.clamp(e,t,i)}_onContextMenu(e){e.preventDefault()}_isStartMousePan(e){return!!this.enablePan&&(!!e.shiftKey||(this.enableOrbit||this.enableFly?this.enableOrbit&&this.enableFly?1===e.button:1===e.button||2===e.button:0===e.button||1===e.button||2===e.button))}_isStartFly(e){return!!this.enableFly&&(this.enableOrbit||this.enablePan?this.enableOrbit?2===e.button:0===e.button:0===e.button||1===e.button||2===e.button)}_isStartOrbit(e){return!!this.enableOrbit&&(this.enableFly||this.enablePan?0===e.button:0===e.button||1===e.button||2===e.button)}_switchToOrbit(){return!!this.enableOrbit&&(this._flying&&(this._flying=!1,this._focusDir(Rw),this._origin.add(Rw),this._position.add(Rw)),this._orbiting=!0,!0)}_switchToFly(){return!!this.enableFly&&(this._orbiting&&(this._orbiting=!1,this._zoomDist=this._cameraDist,this._origin.copy(this.entity.getPosition()),this._position.copy(this._origin),this._cameraTransform.setTranslate(0,0,0)),this._flying=!0,!0)}_onPointerDown(e){if(!this._camera)return;this._element.setPointerCapture(e.pointerId),this._pointerEvents.set(e.pointerId,e);const t=this.enablePan&&2===this._pointerEvents.size,i=this._isStartMousePan(e),s=this._isStartFly(e),r=this._isStartOrbit(e);this._focusing&&(this._cancelSmoothTransform(),this._focusing=!1),t&&(this._lastPinchDist=this._getPinchDist(),this._getMidPoint(this._lastPosition),this._panning=!0),i&&(this._lastPosition.set(e.clientX,e.clientY),this._panning=!0,this._dragging=!0),s&&(this._switchToFly(),this._dragging=!0),r&&(this._switchToOrbit(),this._dragging=!0)}_onPointerMove(e){if(0!==this._pointerEvents.size)if(this._pointerEvents.set(e.pointerId,e),this._focusing&&(this._cancelSmoothTransform(),this._focusing=!1),1!==this._pointerEvents.size){if(2===this._pointerEvents.size){this._panning&&this._pan(this._getMidPoint(Iw));const e=this._getPinchDist();this._lastPinchDist>0&&this._zoom((this._lastPinchDist-e)*this.zoomPinchSens),this._lastPinchDist=e}}else this._panning?this._pan(Iw.set(e.clientX,e.clientY)):(this._orbiting||this._flying)&&this._look(e)}_onPointerUp(e){this._element.releasePointerCapture(e.pointerId),this._pointerEvents.delete(e.pointerId),this._pointerEvents.size<2&&(this._lastPinchDist=-1,this._panning=!1),this._panning&&(this._panning=!1),this._dragging&&(this._dragging=!1)}_onWheel(e){e.preventDefault(),this._zoom(e.deltaY)}_onKeyDown(e){switch(e.stopPropagation(),e.key.toLowerCase()){case"w":case"arrowup":this._key.forward=!0;break;case"s":case"arrowdown":this._key.backward=!0;break;case"a":case"arrowleft":this._key.left=!0;break;case"d":case"arrowright":this._key.right=!0;break;case"q":this._key.up=!0;break;case"e":this._key.down=!0;break;case"shift":this._key.sprint=!0;break;case"control":this._key.crouch=!0}}_onKeyUp(e){switch(e.stopPropagation(),e.key.toLowerCase()){case"w":case"arrowup":this._key.forward=!1;break;case"s":case"arrowdown":this._key.backward=!1;break;case"a":case"arrowleft":this._key.left=!1;break;case"d":case"arrowright":this._key.right=!1;break;case"q":this._key.up=!1;break;case"e":this._key.down=!1;break;case"shift":this._key.sprint=!1;break;case"control":this._key.crouch=!1}}_look(e){if(e.target!==this.app.graphicsDevice.canvas)return;const t=e.movementX||0,i=e.movementY||0;this._dir.x-=i*this.rotateSpeed,this._dir.y-=t*this.rotateSpeed,this._clampAngles(this._dir)}_move(e){if(!this.enableFly)return;Rw.set(0,0,0),this._key.forward&&Rw.add(this.entity.forward),this._key.backward&&Rw.sub(this.entity.forward),this._key.left&&Rw.sub(this.entity.right),this._key.right&&Rw.add(this.entity.right),this._key.up&&Rw.add(this.entity.up),this._key.down&&Rw.sub(this.entity.up),Rw.normalize(),this._moving=Rw.length()>0;const t=this._key.crouch?this.moveSlowSpeed:this._key.sprint?this.moveFastSpeed:this.moveSpeed;Rw.mulScalar(this.sceneSize*t*e),this._origin.add(Rw),this._moving&&(this._focusing&&(this._cancelSmoothTransform(),this._focusing=!1),this._clampPosition(this._origin))}_getMidPoint(e){const[t,i]=this._pointerEvents.values(),s=t.clientX-i.clientX,r=t.clientY-i.clientY;return e.set(i.clientX+.5*s,i.clientY+.5*r)}_getPinchDist(){const[e,t]=this._pointerEvents.values(),i=e.clientX-t.clientX,s=e.clientY-t.clientY;return Math.sqrt(i*i+s*s)}_screenToWorldPan(e,t){if(!this._camera)return;const i=this._camera.screenToWorld(e.x,e.y,1),s=this.entity.getPosition(),r=this._focusDir(Rw),n=kw.add2(s,r),a=r.mulScalar(-1).normalize(),o=Nw.setFromPointNormal(n,a),l=Bw.set(s,i.sub(s).normalize());o.intersectsRay(l,t)}_pan(e){if(!this.enablePan)return;const t=new hi,i=new hi;this._screenToWorldPan(this._lastPosition,t),this._screenToWorldPan(e,i),Rw.sub2(t,i),this._origin.add(Rw),this._lastPosition.copy(e)}_zoom(e){if(!this.enableOrbit&&!this.enablePan)return;if(this._flying){if(this._dragging)return;if(!this._switchToOrbit())return}if(!this._camera)return;const t=this._zoomDist/(10*this.sceneSize),i=ti.clamp(t,this.zoomScaleMin,1);this._zoomDist+=e*this.zoomSpeed*this.sceneSize*i,this._zoomDist=this._clampZoom(this._zoomDist)}_smoothZoom(e){const t=-1===e?1:Uw(this.zoomDamping,e);this._cameraDist=ti.lerp(this._cameraDist,this._zoomDist,t),this._cameraTransform.setTranslate(0,0,this._cameraDist)}_smoothTransform(e){const t=-1===e?1:Uw(this._focusing?this.focusDamping:this.rotateDamping,e),i=-1===e?1:Uw(this._focusing?this.focusDamping:this.moveDamping,e);this._angles.x=ti.lerpAngle(this._angles.x%360,this._dir.x%360,t),this._angles.y=ti.lerpAngle(this._angles.y%360,this._dir.y%360,t),this._position.lerp(this._position,this._origin,i),this._baseTransform.setTRS(this._position,Fw.setFromEulerAngles(this._angles),hi.ONE);const s=this._position.distance(this._origin)+Math.abs(this._angles.x-this._dir.x)+Math.abs(this._angles.y-this._dir.y);this._focusing&&s<1e-4&&(this._focusing=!1)}_cancelSmoothZoom(){this._cameraDist=this._zoomDist}_cancelSmoothTransform(){this._origin.copy(this._position),this._dir.set(this._angles.x,this._angles.y)}_updateTransform(){Ow.copy(this._baseTransform).mul(this._cameraTransform),this.entity.setPosition(Ow.getTranslation()),this.entity.setEulerAngles(Ow.getEulerAngles())}focus(e,t,i=!0){if(this._camera){if(this._flying){if(this._dragging)return;if(!this._switchToOrbit())return}if(t){Rw.sub2(t,e);const s=Math.atan2(Rw.y,Math.sqrt(Rw.x*Rw.x+Rw.z*Rw.z))*ti.RAD_TO_DEG,r=Math.atan2(Rw.x,Rw.z)*ti.RAD_TO_DEG;this._clampAngles(this._dir.set(-s,r)),this._origin.copy(e),this._cameraTransform.setTranslate(0,0,0);const n=this.entity.getPosition(),a=this.entity.getRotation();this._baseTransform.setTRS(n,a,hi.ONE),this._zoomDist=this._clampZoom(Rw.length()),i||(this._smoothZoom(-1),this._smoothTransform(-1)),this._updateTransform()}else this._origin.copy(e),i||this._position.copy(e);i&&(this._focusing=!0)}}resetZoom(e=0,t=!0){this._zoomDist=e,t||(this._cameraDist=e)}refocus(e,t,i,s=!0){"number"==typeof i&&this.resetZoom(i,s),this.focus(e,t,s)}attach(e){this._camera!==e&&(this._camera=e,this._element.addEventListener("wheel",this._onWheel,zw),this._element.addEventListener("pointerdown",this._onPointerDown),this._element.addEventListener("pointermove",this._onPointerMove),this._element.addEventListener("pointerup",this._onPointerUp),this._element.addEventListener("contextmenu",this._onContextMenu),window.addEventListener("keydown",this._onKeyDown,!1),window.addEventListener("keyup",this._onKeyUp,!1))}detach(){this._camera&&(this._element.removeEventListener("wheel",this._onWheel,zw),this._element.removeEventListener("pointermove",this._onPointerMove),this._element.removeEventListener("pointerdown",this._onPointerDown),this._element.removeEventListener("pointerup",this._onPointerUp),this._element.removeEventListener("contextmenu",this._onContextMenu),window.removeEventListener("keydown",this._onKeyDown,!1),window.removeEventListener("keyup",this._onKeyUp,!1),this._camera=null,this._cancelSmoothZoom(),this._cancelSmoothTransform(),this._pointerEvents.clear(),this._lastPinchDist=-1,this._panning=!1,this._key={forward:!1,backward:!1,left:!1,right:!1,up:!1,down:!1,sprint:!1,crouch:!1})}update(e){this.app.xr?.active||this._camera&&(this._move(e),this._flying||this._smoothZoom(e),this._smoothTransform(e),this._updateTransform())}destroy(){this.detach()}}class Vw extends Om{constructor(e,t){super(e);const i=new Nm;i.graphicsDevice=t.graphicsDevice,this.addComponentSystems(i),this.addResourceHandles(i),i.elementInput=t.elementInput,i.keyboard=t.keyboard,i.mouse=t.mouse,i.touch=t.touch,i.gamepads=t.gamepads,i.scriptPrefix=t.scriptPrefix,i.assetPrefix=t.assetPrefix,i.scriptsOrder=t.scriptsOrder,i.lightmapper=Ym,i.xr=rx,this.init(i)}addComponentSystems(e){e.componentSystems=[Gg,ov,Av,Iv,Zv,Kv]}addResourceHandles(e){e.resourceHandlers=[r_,tb,ib,uy,ob,sb,ab,Ob]}}let Hw=null,Gw=null;const Ww=new hi,jw=new hi,qw=new hi,Xw=new hi(0,1,0),Kw=new _i,Yw=[[[0,0,0],[-.5,0,.3]],[[0,0,0],[.5,0,.3]],[[0,0,0],[0,-.5,.3]],[[0,0,0],[0,.5,.3]],[[0,0,1],[-.5,0,.3]],[[0,0,1],[.5,0,.3]],[[0,0,1],[0,-.5,.3]],[[0,0,1],[0,.5,.3]],[[0,-.5,.3],[.5,0,.3]],[[.5,0,.3],[0,.5,.3]],[[0,.5,.3],[-.5,0,.3]],[[-.5,0,.3],[0,-.5,.3]]];class Qw{app;mesh;meshInstances;vertexFormat;vertexCursor;vertexData;colorData;depthState=new Cr;constructor(e,t,i=!0){const s=e.graphicsDevice;if(!Hw){Gw=new yu({enabled:!0,name:"Debug Layer Behind",opaqueSortMode:0,transparentSortMode:0,passThrough:!0,overrideClear:!0}),Hw=new yu({enabled:!0,name:"Debug Layer",opaqueSortMode:0,transparentSortMode:0,passThrough:!0,overrideClear:!0});const i=e.scene.layers,s=i.getLayerByName("World"),r=i.getTransparentIndex(s);i.insert(Gw,r),i.insert(Hw,r+1),t.camera.layers=t.camera.layers.concat([Gw.id,Hw.id])}const r=new Nr(s,[{semantic:Ji,components:3,type:6},{semantic:is,components:4,type:1,normalize:!0}]),n=new Gh(s);n.vertexBuffer=new Ir(s,r,8192,{usage:1}),n.primitive[0].type=1,n.primitive[0].base=0,n.primitive[0].indexed=!1,n.primitive[0].count=0;const a={uniqueName:"debug-lines",attributes:{vertex_position:Ji,vertex_color:is},vertexCode:"\nattribute vec3 vertex_position;\nattribute vec4 vertex_color;\n\nvarying vec2 zw;\nvarying vec4 vColor;\n\nuniform mat4 matrix_model;\nuniform mat4 matrix_viewProjection;\n\nvoid main(void) {\n    vColor = vertex_color;\n\n    gl_Position = matrix_viewProjection * matrix_model * vec4(vertex_position, 1.0);\n\n    // store z/w for later use in fragment shader\n    zw = gl_Position.zw;\n\n    // disable depth clipping\n    gl_Position.z = 0.0;\n}",fragmentCode:"\nprecision highp float;\n\nvarying vec2 zw;\nvarying vec4 vColor;\nuniform vec4 uColor;\n\nvoid main(void) {\n    gl_FragColor = vColor * uColor;\n\n    // clamp depth in Z to [0, 1] range\n    gl_FragDepth = max(0.0, min(1.0, (zw.x / zw.y + 1.0) * 0.5));\n}"},o=new Hu(a);o.setParameter("uColor",[1,1,1,.7]),o.blendType=2,o.update();const l=new tc(n,o,new Lc);if(l.cull=!1,l.visible=!1,Hw.addMeshInstances([l],!0),this.meshInstances=[l],i){const e=new Hu(a);e.setParameter("uColor",[.5,.5,.5,.5]),e.blendType=2,e.depthState.func=4,e.depthState.write=!1,e.update();const t=new tc(n,e,new Lc);t.cull=!1,t.visible=!1,Gw.addMeshInstances([t],!0),this.meshInstances.push(t)}this.app=e,this.mesh=n,this.vertexFormat=r,this.vertexCursor=0,this.vertexData=new Float32Array(this.mesh.vertexBuffer.lock()),this.colorData=new Uint32Array(this.mesh.vertexBuffer.lock())}static matrixMad(e,t,i){if(i>0)for(let s=0;s<16;++s)e.data[s]+=t.data[s]*i}clear(){this.vertexCursor=0}box(e,t){this.line(new hi(e.x,e.y,e.z),new hi(t.x,e.y,e.z)),this.line(new hi(t.x,e.y,e.z),new hi(t.x,e.y,t.z)),this.line(new hi(t.x,e.y,t.z),new hi(e.x,e.y,t.z)),this.line(new hi(e.x,e.y,t.z),new hi(e.x,e.y,e.z)),this.line(new hi(e.x,t.y,e.z),new hi(t.x,t.y,e.z)),this.line(new hi(t.x,t.y,e.z),new hi(t.x,t.y,t.z)),this.line(new hi(t.x,t.y,t.z),new hi(e.x,t.y,t.z)),this.line(new hi(e.x,t.y,t.z),new hi(e.x,t.y,e.z)),this.line(new hi(e.x,e.y,e.z),new hi(e.x,t.y,e.z)),this.line(new hi(t.x,e.y,e.z),new hi(t.x,t.y,e.z)),this.line(new hi(t.x,e.y,t.z),new hi(t.x,t.y,t.z)),this.line(new hi(e.x,e.y,t.z),new hi(e.x,t.y,t.z))}line(e,t,i=4294967295){if(this.vertexCursor>=this.vertexData.length/8){const e=this.mesh.vertexBuffer,t=2*e.lock().byteLength,i=new ArrayBuffer(t);this.mesh.vertexBuffer=new Ir(this.app.graphicsDevice,e.getFormat(),2*e.getNumVertices(),{usage:1,data:i}),this.vertexData=new Float32Array(i),this.colorData=new Uint32Array(i),this.colorData.set(new Uint32Array(e.lock()))}const s=this.vertexCursor,r=this.vertexData,n=this.colorData;r[8*s+0]=e.x,r[8*s+1]=e.y,r[8*s+2]=e.z,n[8*s+3]=i,r[8*s+4]=t.x,r[8*s+5]=t.y,r[8*s+6]=t.z,n[8*s+7]=i,this.vertexCursor++}generateNormals(e,t,i,s){const r=new Go(e),n=r.element[Ji],a=r.element[$i],o=r.element[ts],l=r.element[es];if(!n||!a)return;const h=e.getNumVertices(),c=new hi,d=new hi,u=new _i;for(let e=0;e<h;++e){if(c.set(n.get(0),n.get(1),n.get(2)),d.set(a.get(0),a.get(1),a.get(2)),o&&l&&s){u.copy(_i.ZERO);for(let e=0;e<4;++e)Qw.matrixMad(u,s[o.get(e)],l.get(e));u.mul2(t,u),u.transformPoint(c,c),u.transformVector(d,d)}else t.transformPoint(c,c),t.transformVector(d,d);d.normalize().mulScalar(i).add(c),this.line(c,d),r.next()}}bone(e,t,i=4294967295){Kw.setLookAt(e,t,Xw),Ww.sub2(t,e);const s=Ww.length(),r=(e,t)=>{Ww.set(t[0]*s*.3,t[1]*s*.3,t[2]*-s),Kw.transformPoint(Ww,e)};Yw.forEach((e=>{r(jw,e[0]),r(qw,e[1]),this.line(jw,qw,i)}))}axis(e,t=1){e.getTranslation(Ww),e.getScale(qw),qw.set(t/qw.x,t/qw.y,t/qw.z),e.getX(jw).mul(qw).add(Ww),this.line(Ww,jw,4278190335),e.getY(jw).mul(qw).add(Ww),this.line(Ww,jw,4278255360),e.getZ(jw).mul(qw).add(Ww),this.line(Ww,jw,4294901760)}generateSkeleton(e,t,i,s){const r=(n,a)=>{if(n.enabled){a||=n===s;for(let e=0;e<n.children.length;++e){const i=n.children[e];t&&this.bone(n.getPosition(),i.getPosition(),a?4294967040:4294967295),r(i,a)}if(i){const t=e.parent;t&&(Ww.sub2(n.getPosition(),t.getPosition()),this.axis(n.getWorldTransform(),.05*Ww.length()))}}};r(e,!1)}update(){0===this.vertexCursor?this.meshInstances.forEach((e=>{e.visible=!1})):(this.meshInstances.forEach((e=>{e.visible=!0})),this.mesh.vertexBuffer.unlock(),this.mesh.primitive[0].count=2*this.vertexCursor,this.vertexCursor=0)}}const Jw=e=>{const t=[],i=[];return e.forEach((e=>{e.isFile?i.push(e):e.isDirectory&&t.push(new Promise((t=>{const i=e.createReader(),s=[],r=()=>{i.readEntries((e=>{e.length>0?(s.push(Jw(e)),r()):Promise.all(s).then((e=>{t(e.flat())}))}))};r()})))})),Promise.all(t).then((e=>i.concat(...e)))},$w=(e,t)=>{e.addEventListener("dragstart",(e=>{e.preventDefault(),e.stopPropagation(),e.dataTransfer.effectAllowed="all"}),!1),e.addEventListener("dragover",(e=>{e.preventDefault(),e.stopPropagation(),e.dataTransfer.effectAllowed="all"}),!1),e.addEventListener("drop",(e=>{e.preventDefault();const i=Array.from(e.dataTransfer.items).map((e=>e.webkitGetAsEntry()));Jw(i).then((e=>Promise.all(e.map((e=>new Promise((t=>{e.file((i=>{t({url:URL.createObjectURL(i),filename:e.fullPath.substring(1)})}))}))))))).then((i=>{i.length>1&&(e=>{const t=e=>{const t=e.split(kt.delimiter);return[t[0],t.slice(1).join(kt.delimiter)]};for(;;){const i=t(e[0].filename);if(0===i[1].length)return;for(let s=1;s<e.length;++s){const r=t(e[s].filename);if(i[0]!==r[0])return}for(let i=0;i<e.length;++i)e[i].filename=t(e[i].filename)[1]}})(i),t(i,!e.shiftKey)}))}),!1)},Zw=(e,t)=>1/(Math.sqrt(2*Math.PI)*t)*Math.exp(-e*e/(2*t*t)),eT=new Sr(!0,0,11,12),tT=new Sr(!1);class iT{device;camera;textureBias;shader=null;pixelFormat;texcoordModUniform=null;multiframeTexUniform=null;powerUniform=null;textureBiasUniform=null;accumTexture=null;accumRenderTarget=null;sampleArray=[];sampleId=0;sampleAccum=0;enabled=!0;blend=1;constructor(e,t,i){this.device=e,this.camera=t,this.samples=i||iT.generateSamples(5,!1,2,0),this.camera.system.app.scene.on(mh,(e=>{if(e!==this.camera)return;const t=this.camera.camera,i=t.projectionMatrix;if(this.enabled&&this.accumTexture){const e=this.sampleArray[this.sampleId];i.data[8]=e.x/this.accumTexture.width,i.data[9]=e.y/this.accumTexture.height,this.textureBiasUniform.setValue(0===this.sampleId?0:this.textureBias)}else i.data[8]=0,i.data[9]=0,this.textureBiasUniform.setValue(0);t._viewProjMatDirty=!0})),this.camera.system.app.scene.on(gh,(e=>{if(e!==this.camera)return;const i=t.projectionMatrix;i.data[8]=0,i.data[9]=0})),this.shader=Eh(e,"\nattribute vec2 vertex_position;\nvarying vec2 texcoord;\nuniform vec4 texcoordMod;\nvoid main(void) {\n    gl_Position = vec4(vertex_position, 0.5, 1.0);\n    texcoord = (vertex_position.xy * 0.5 + 0.5) * texcoordMod.xy + texcoordMod.zw;\n}\n","\nvarying vec2 texcoord;\nuniform sampler2D multiframeTex;\nuniform float power;\nvoid main(void) {\n    vec4 t = texture2D(multiframeTex, texcoord);\n    gl_FragColor = pow(t, vec4(power));\n}\n","multiframe",{vertex_position:Ji}),this.pixelFormat=(e=>(e=>e.textureHalfFloatRenderable)(e)?Ri:(e=>e.textureFloatRenderable)(e)?ki:7)(e),this.texcoordModUniform=e.scope.resolve("texcoordMod"),this.multiframeTexUniform=e.scope.resolve("multiframeTex"),this.powerUniform=e.scope.resolve("power"),this.textureBiasUniform=e.scope.resolve("textureBias");const s=()=>{this.destroy()};e.once("destroy",s),e.on("devicelost",s)}set samples(e){this.sampleArray=e,this.textureBias=-Math.log2(Math.sqrt(e.length)),this.sampleId=0}get samples(){return this.sampleArray}static generateSamples(e,t=!1,i=1,s=0){const r=[],n=Math.ceil(3*s)+1,a=.5*i;let o,l,h,c=0;for(let i=0;i<e;++i)for(let d=0;d<e;++d)t?(o=(i+Math.random())/e*2-1,l=(d+Math.random())/e*2-1):(o=i/(e-1)*2-1,l=d/(e-1)*2-1),h=s<=0?1:Zw(o*n,s)*Zw(l*n,s),c+=h,r.push(new hi(o*a,l*a,h));return r.forEach((e=>{e.z/=c})),r.sort(((e,t)=>{const i=e.length(),s=t.length();return i<s?-1:s<i?1:0})),r}destroy(){this.accumRenderTarget&&(this.accumRenderTarget.destroy(),this.accumRenderTarget=null),this.accumTexture&&(this.accumTexture.destroy(),this.accumTexture=null)}create(){const e=this.camera.renderTarget.colorBuffer;this.accumTexture=new ur(this.device,{name:"multiframe-texture",width:e.width,height:e.height,format:this.pixelFormat,mipmaps:!1,minFilter:0,magFilter:0}),this.accumRenderTarget=new Wr({name:"multiframe-target",colorBuffer:this.accumTexture,depth:!1})}activateBackbuffer(){const e=this.device;if(!e.isWebGPU){const t=e;t.setRenderTarget(null),t.updateBegin(),t.setViewport(0,0,e.width,e.height),t.setScissor(0,0,e.width,e.height)}}moved(){this.sampleId=0,this.sampleAccum=0}update(){const e=this.device,t=this.sampleArray.length,i=this.camera.renderTarget.colorBuffer;if(!this.enabled)return this.copyFinal(),!1;if(!this.accumTexture||this.accumTexture.width===i.width&&this.accumTexture.height===i.height||this.destroy(),this.accumTexture||this.create(),this.sampleId<t){const t=this.sampleArray[this.sampleId].z,s=t/(this.sampleAccum+t);e.setBlendState(eT),e.setBlendColor(s,s,s,s),this.texcoordModUniform.setValue([1,1,0,0]),this.multiframeTexUniform.setValue(i),this.powerUniform.setValue(2.2),Fh(e,this.accumRenderTarget,this.shader,null,null),this.sampleAccum+=t}return this.copyFinal(),this.sampleId<t&&this.sampleId++,this.sampleId<t}copyFinal(){const e=this.device;1!==this.blend?(e.setBlendState(eT),e.setBlendColor(this.blend,this.blend,this.blend,this.blend)):e.setBlendState(tT),this.texcoordModUniform.setValue(e.isWebGPU?[1,-1,0,1]:[1,1,0,0]),this.enabled&&0!==this.sampleId?(this.multiframeTexUniform.setValue(this.accumTexture),this.powerUniform.setValue(1/2.2)):(this.multiframeTexUniform.setValue(this.camera.renderTarget.colorBuffer),this.powerUniform.setValue(1)),Fh(e,null,this.shader),this.activateBackbuffer()}}const sT=new Float32Array(1),rT=new Uint8Array(sT.buffer),nT=new ui(2,2,2,1),aT=new ui(1,1,1,0);class oT{app;camera;picker;constructor(e,t){this.app=e,this.camera=t,this.picker=null}async pick(e,t){const{app:i,camera:s}=this,{graphicsDevice:r}=i,{canvas:n}=r,a=n.clientWidth,o=n.clientHeight;t=o-t-1,this.picker||(this.picker=new cx(this.app,a,o));const{picker:l}=this;l.resize(a,o),l.prepare(s.camera,i.scene,[i.scene.layers.getLayerByName("World")]);const h=await l.renderTarget.colorBuffer.read(e,r.isWebGL2?o-t-1:t,1,1,{renderTarget:l.renderTarget,immediate:!0});for(let e=0;e<4;++e)rT[e]=h[e];const c=sT[0];if(!isFinite(c))return null;const d=new ui(e/a,t/o,c,1).mul(nT).sub(aT);s.camera.projectionMatrix.clone().invert().transformVec4(d,d),d.mulScalar(1/d.w);const u=new hi(d.x,d.y,d.z);return s.getWorldTransform().transformPoint(u,u),u}}class lT{static WORKER_STR=function(e){(async()=>{const t=await new Promise((t=>{self.importScripts(`${e}static/lib/lodepng/lodepng.js`),t(self.lodepng({locateFile:()=>`${e}static/lib/lodepng/lodepng.wasm`}))}));self.onmessage=e=>{const i=e.data,s=((e,t,i,s)=>{const r=e._malloc(4),n=e._malloc(4),a=e._malloc(i*s*4);for(let r=0;r<s;++r){let n=r*i,o=a/4+(s-1-r)*i;for(let s=0;s<i;++s)e.HEAPU32[o++]=t[n++]}e._lodepng_encode32(r,n,a,i,s);const o=e.HEAPU8.slice(e.HEAPU32[r/4],e.HEAPU32[r/4]+e.HEAPU32[n/4]);return e._free(r),e._free(n),e._free(a),o})(t,i.words,i.width,i.height);self.postMessage({result:s},void 0,[s.buffer])}})()}.toString();worker;receiveCallback;constructor(){let e=null;const t=new Blob([`(${lT.WORKER_STR})('${window.location.href.split("?")[0]}')\n\n`],{type:"application/javascript"});this.worker=new Worker(URL.createObjectURL(t)),this.worker.addEventListener("message",(t=>{e(t)})),this.receiveCallback=t=>{e=i=>{t(i.data.result),e=null}}}_downloadFile(e,t){const i=new Blob([t],{type:"octet/stream"}),s=window.URL.createObjectURL(i),r=document.createElement("a");r.download=e,r.href=s,r.click(),window.URL.revokeObjectURL(s)}async export(e,t,i,s){this.worker.postMessage({words:t,width:i,height:s},[t.buffer]),this._downloadFile(e,await new Promise(this.receiveCallback))}}class hT{layer;material;plane;light;sceneRoot;camera;constructor(e,t,i,s){this.layer=new yu({name:"Shadow Layer"});const r=e.scene.layers,n=r.getLayerByName("World"),a=r.getTransparentIndex(n);r.insert(this.layer,a+1),this.material=new sp,this.material.useSkybox=!1,this.material.blendType=2,this.material.depthWrite=!1,this.material.diffuse.set(0,0,0),this.material.specular.set(0,0,0),this.material.chunks={APIVersion:tr,endPS:"\n    litArgs_opacity = mix(light0_shadowIntensity, 0.0, shadow0);\n    gl_FragColor.rgb = vec3(0.0);\n"},this.material.update(),this.plane=new Lm("ShadowPlane"),this.plane.addComponent("render",{type:"plane",castShadows:!1,material:this.material}),this.light=new Lm("ShadowLight"),this.light.addComponent("light",{type:"directional",castShadows:!0,normalOffsetBias:0,shadowBias:0,shadowResolution:1024,shadowType:2,shadowUpdateMode:2,vsmBlurSize:64,enabled:!0,shadowIntensity:.4}),i.addChild(this.plane),i.addChild(this.light),this.plane.render.layers=[this.layer.id],this.light.light.layers=[this.layer.id],t.layers=t.layers.concat([this.layer.id]),this.sceneRoot=s,this.camera=t}onEntityAdded(e){e.findComponents("render").forEach((e=>{this.layer.shadowCasters=this.layer.shadowCasters.concat(e.meshInstances)}))}onEntityRemoved(e){e.findComponents("render").forEach((e=>{this.layer.shadowCasters=this.layer.shadowCasters.filter((t=>-1===e.meshInstances.indexOf(t)))}))}onUpdate(e){const t=e,i=t.center,s=Math.sqrt(t.halfExtents.x*t.halfExtents.x+t.halfExtents.z*t.halfExtents.z);this.plane.setLocalScale(4*s,1,4*s),this.plane.setPosition(i.x,t.getMin().y,i.z),this.light.light.shadowDistance=this.camera.camera._farClip}set enabled(e){this.layer.enabled=e,this.light.enabled=e}get enabled(){return this.layer.enabled}set intensity(e){this.light.light.shadowIntensity=e}get intensity(){return this.light.light.shadowIntensity}}var cT=new Image;cT.src="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' xmlns:svg='http://www.w3.org/2000/svg' width='1010' height='1000' version='1.1' style='background-color:rgba(32%2c32%2c32%2c.4)'%3e%3cg class='layer'%3e%3cpath id='svg_1' fill='white' d='m363%2c300l126%2c126l-58%2c58l-126%2c-126l-126%2c126l-58%2c-58l126%2c-126l-126%2c-126l58%2c-58l126%2c126l126%2c-126l58%2c58l-126%2c126z' transform='translate(205%2c 200)'/%3e%3c/g%3e%3c/svg%3e";var dT=new Image;dT.src="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' xmlns:svg='http://www.w3.org/2000/svg' width='1010' height='1000' version='1.1' style='background-color:rgba(32%2c32%2c32%2c.4)'%3e%3cg class='layer'%3e%3cpath id='svg_1' fill='white' d='m402.87%2c60.55l-15.2%2c28.51l-83.62%2c-47.51l-81.72%2c47.51l-15.2%2c-28.51l96.92%2c-58.91l98.82%2c58.91zm-239.45%2c62.71l-64.61%2c38.01l58.91%2c34.21l-19%2c26.61l-57.01%2c-30.41l0%2c72.21l-34.21%2c0l0%2c-110.22l98.82%2c-58.91l17.1%2c28.51zm399.08%2c140.63l-34.21%2c0l0%2c-72.21l-55.11%2c30.41l-19%2c-26.61l58.91%2c-34.21l-66.51%2c-38.01l17.1%2c-28.51l98.82%2c58.91l0%2c110.22zm-271.75%2c43.71l-72.21%2c-41.81l13.3%2c-26.61l74.11%2c41.81l74.11%2c-41.81l15.2%2c26.61l-72.21%2c41.81l0%2c81.72l-32.31%2c0l0%2c-81.72zm-127.32%2c171.03l-17.1%2c28.51l-98.82%2c-58.91l0%2c-112.12l34.21%2c0l0%2c93.12l81.72%2c49.41zm399.08%2c-142.53l0%2c112.12l-98.82%2c58.91l-17.1%2c-28.51l81.72%2c-49.41l0%2c-93.12l34.21%2c0zm-159.63%2c203.34l-98.82%2c58.91l-96.92%2c-58.91l15.2%2c-28.51l68.41%2c39.91l0%2c-70.31l32.31%2c0l0%2c68.41l64.61%2c-38.01l15.2%2c28.51z' transform='translate(205%2c 200)'/%3e%3c/g%3e%3c/svg%3e";const uT=new hi,fT=new hi,pT=new hi,mT=new hi,gT=new _i,vT=(e,t)=>(e%t+t)%t;class _T{value;source;target;timer=0;transitionTime=0;constructor(e){this.value=e,this.source={...e},this.target={...e}}goto(e,t=.25){0===t&&_T.copy(this.value,e),_T.copy(this.source,this.value),_T.copy(this.target,e),this.timer=0,this.transitionTime=t}update(e){this.timer<this.transitionTime?(this.timer=Math.min(this.timer+e,this.transitionTime),_T.lerp(this.value,this.source,this.target,_T.quintic(this.timer/this.transitionTime))):_T.copy(this.value,this.target)}static quintic(e){return Math.pow(e-1,5)+1}static copy(e,t){Object.keys(e).forEach((i=>{e[i]=t[i]}))}static lerp(e,t,i,s){Object.keys(e).forEach((r=>{e[r]=t[r]+s*(i[r]-t[r])}))}}class bT{options;dom;events=new Ht;active=!1;rotating=!1;constructor(e){this.options=e;const t=e.xr;t.domOverlay.root=this._createRotateInput(),this.options.showUI&&this._createUI(),this._createModelHandler();t.on(`available: ${fy}`,(e=>{this.events.fire("xr:available",e)})),t.on("start",(()=>{var e;this.active=!0,this.events.fire("xr:started"),e=e=>{this.events.fire("xr:initial-place",e),navigator?.vibrate(10),t.hitTest.start({profile:"generic-touchscreen",entityTypes:[my,gy,vy],callback:(e,t)=>{e?console.log(e):t.on("result",(e=>{this.rotating||this.events.fire("xr:place",e)}))}})},t.hitTest.start({spaceType:py,entityTypes:[my,gy,vy],callback:(t,i)=>{t?console.log(t):i.on("result",(t=>{e(t),i.remove()}))}})})),t.on("end",(()=>{this.active=!1,this.events.fire("xr:ended")}))}get available(){return this.options.xr.isAvailable(fy)}_createRotateInput(){const e=new Map;let t=0,i=0;const s=e=>{e.preventDefault(),e.stopPropagation()},r=t=>{s(t),e.set(t.pointerId,{start:{x:t.clientX,y:t.clientY},previous:{x:t.clientX,y:t.clientY},current:{x:t.clientX,y:t.clientY}}),this.rotating?1===e.size&&(this.rotating=!1):this.rotating=e.size>1},n=r=>{s(r);const n=e.get(r.pointerId);if(n&&(n.previous.x=n.current.x,n.previous.y=n.current.y,n.current.x=r.clientX,n.current.y=r.clientY),2===e.size){const s=Array.from(e.keys()),r=e.get(s[0]),n=e.get(s[1]),a=Math.atan2(n.start.y-r.start.y,n.start.x-r.start.x),o=Math.atan2(n.current.y-r.current.y,n.current.x-r.current.x);i=o-a,this.events.fire("xr:rotate",-180*(t+i)/Math.PI)}},a=r=>{s(r),2===e.size&&(t+=i),e.delete(r.pointerId)},o=document.createElement("div");return o.style.position="fixed",o.style.top="0",o.style.left="0",o.style.width="100%",o.style.height="100%",o.style.touchAction="none",o.style.display="none",document.body.appendChild(o),this.events.on("xr:started",(()=>{o.style.display="block",o.addEventListener("pointerdown",r),o.addEventListener("pointermove",n),o.addEventListener("pointerup",a)})),this.events.on("xr:ended",(()=>{o.style.display="none",o.removeEventListener("pointerdown",r),o.removeEventListener("pointermove",n),o.removeEventListener("pointerup",a)})),o}_createUI(){const e=document.createElement("img");e.src=this.options.startArImgSrc,e.style.position="fixed",e.style.right="20px",e.style.top="20px",e.style.width="36px",e.style.height="36px",e.style.opacity="100%",e.style.display="none",document.body.appendChild(e);let t=!0;this.events.on("xr:available",(t=>{e.style.display=t?"block":"none"})),this.events.on("xr:started",(()=>{t=!0,e.src=this.options.stopArImgSrc,this.options.xr.domOverlay.root.appendChild(e)})),this.events.on("xr:ended",(()=>{t=!0,e.src=this.options.startArImgSrc,document.body.appendChild(e)})),e.addEventListener("click",(()=>{t&&(t=!1,this.active?this.end():this.start())}))}_createModelHandler(){const e=this.options.xr,t=this.events,i=new _T({x:0,y:0,z:0}),s=new _T({x:0,y:0,z:0}),r=new _T({scale:1}),n=.25;let a=!0;const o=new hi,l=new Ci;let h;const c=()=>{if(h.length){l.copy(h[0].aabb);for(let e=1;e<h.length;++e)l.add(h[e].aabb)}};t.on("xr:start",(()=>{a=!0,h=this.options.content.findComponents("render").map((e=>e.meshInstances)).flat().concat(this.options.content.findComponents("gsplat").map((e=>e.instance.meshInstance))),c();const e=l.halfExtents;o.set(0,-e.y,4*-e.length())})),t.on("xr:initial-place",(t=>{gT.copy(e.camera.camera.viewMatrix).invert(),gT.transformPoint(o,uT),gT.getEulerAngles(fT),i.goto({x:uT.x,y:uT.y,z:uT.z},0),s.goto({x:fT.x,y:fT.y,z:fT.z},0),r.goto({scale:.55},0),s.goto({x:0,y:0,z:0},n),i.goto({x:t.x,y:t.y,z:t.z},n),a=!1})),t.on("xr:place",(e=>{i.goto({x:e.x,y:e.y,z:e.z},n)})),t.on("xr:rotate",(e=>{e=vT(e,360),s.goto({x:0,y:e,z:0},n),s.source.y=e-180+vT(s.source.y-e+180,360)})),t.on("xr:ended",(()=>{this.options.content.setLocalPosition(0,0,0),this.options.content.setLocalEulerAngles(0,0,0)})),e.app.on("frameupdate",(e=>{const t=e/1e3;i.update(t),s.update(t),r.update(t)})),e.on("update",(()=>{const e=this.options.xr;if(!e.views.list.length)return;gT.copy(e.camera.camera.viewMatrix).invert();const t=this.options.content;a?(gT.transformPoint(o,uT),gT.getEulerAngles(fT),t.setLocalPosition(uT.x,uT.y,uT.z),t.setLocalEulerAngles(fT.x,fT.y,fT.z),t.setLocalScale(1,1,1)):(t.setLocalPosition(i.value.x,i.value.y,i.value.z),t.setLocalEulerAngles(s.value.x,s.value.y,s.value.z),t.setLocalScale(r.value.scale,r.value.scale,r.value.scale)),c();const n=l.center,h=l.halfExtents.length();gT.getZ(mT),gT.getTranslation(pT),uT.sub2(n,pT);const d=-uT.dot(mT),u=d+h,f=Math.max(1e-4,d<h?u/1024:d-h);e._setClipPlanes(f/1.5,1.5*u),this.events.fire("xr:update")}))}start(){this.available&&!this.active&&(this.events.fire("xr:start"),this.options.xr.start(this.options.camera.camera,fy,"local",{callback:e=>{e&&console.log(e)}}))}end(){this.options.xr.end()}}var yT=function(){var e=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]),t=new Uint8Array([32,0,65,2,1,106,34,33,3,128,11,4,13,64,6,253,10,7,15,116,127,5,8,12,40,16,19,54,20,9,27,255,113,17,42,67,24,23,146,148,18,14,22,45,70,69,56,114,101,21,25,63,75,136,108,28,118,29,73,115]);if("object"!=typeof WebAssembly)return{supported:!1};var i,s=WebAssembly.validate(e)?"b9H79TebbbeKl9Gbb9Gvuuuuueu9Giuuub9Geueuikqbbebeedddilve9Weeeviebeoweuec:q;Aekr;leDo9TW9T9VV95dbH9F9F939H79T9F9J9H229F9Jt9VV7bb8A9TW79O9V9Wt9F9KW9J9V9KW9wWVtW949c919M9MWVbdY9TW79O9V9Wt9F9KW9J9V9KW69U9KW949c919M9MWVblE9TW79O9V9Wt9F9KW9J9V9KW69U9KW949tWG91W9U9JWbvL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9p9JtboK9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9r919HtbrL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWVT949Wbwl79IV9RbDq;t9tqlbzik9:evu8Jjjjjbcz9Rhbcbheincbhdcbhiinabcwfadfaicjuaead4ceGglE86bbaialfhiadcefgdcw9hmbkaec:q:yjjbfai86bbaecitc:q1jjbfab8Piw83ibaecefgecjd9hmbkk;h8JlHud97euo978Jjjjjbcj;kb9Rgv8Kjjjjbc9:hodnadcefal0mbcuhoaiRbbc:Ge9hmbavaialfgrad9Rad;8qbbcj;abad9UhoaicefhldnadTmbaoc;WFbGgocjdaocjd6EhwcbhDinaDae9pmeawaeaD9RaDawfae6Egqcsfgoc9WGgkci2hxakcethmaocl4cifcd4hPabaDad2fhscbhzdnincehHalhOcbhAdninaraO9RaP6miavcj;cbfaAak2fhCaOaPfhlcbhidnakc;ab6mbaral9Rc;Gb6mbcbhoinaCaofhidndndndndnaOaoco4fRbbgXciGPlbedibkaipxbbbbbbbbbbbbbbbbpklbxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklbalczfhlkdndndndndnaXcd4ciGPlbedibkaipxbbbbbbbbbbbbbbbbpklzxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklzalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklzalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklzalczfhlkdndndndndnaXcl4ciGPlbedibkaipxbbbbbbbbbbbbbbbbpklaxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklaalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklaalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklaalczfhlkdndndndndnaXco4Plbedibkaipxbbbbbbbbbbbbbbbbpkl8WxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibaXc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spkl8WalclfaYpQbfaXc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibaXc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spkl8WalcwfaYpQbfaXc:q:yjjbfRbbfhlxekaialpbbbpkl8Walczfhlkaoc;abfhiaocjefak0meaihoaral9Rc;Fb0mbkkdndnaiak9pmbaici4hoinaral9RcK6mdaCaifhXdndndndndnaOaico4fRbbaocoG4ciGPlbedibkaXpxbbbbbbbbbbbbbbbbpklbxikaXalpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaXalpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaXalpbbbpklbalczfhlkaocdfhoaiczfgiak6mbkkalTmbaAci6hHalhOaAcefgohAaoclSmdxekkcbhlaHceGmdkdnakTmbavcjdfazfhiavazfpbdbhYcbhXinaiavcj;cbfaXfgopblbgLcep9TaLpxeeeeeeeeeeeeeeeegQp9op9Hp9rgLaoakfpblbg8Acep9Ta8AaQp9op9Hp9rg8ApmbzeHdOiAlCvXoQrLgEaoamfpblbg3cep9Ta3aQp9op9Hp9rg3aoaxfpblbg5cep9Ta5aQp9op9Hp9rg5pmbzeHdOiAlCvXoQrLg8EpmbezHdiOAlvCXorQLgQaQpmbedibedibedibediaYp9UgYp9AdbbaiadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaEa8EpmwDKYqk8AExm35Ps8E8FgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaLa8ApmwKDYq8AkEx3m5P8Es8FgLa3a5pmwKDYq8AkEx3m5P8Es8Fg8ApmbezHdiOAlvCXorQLgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaLa8ApmwDKYqk8AExm35Ps8E8FgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfhiaXczfgXak6mbkkazclfgzad6mbkasavcjdfaqad2;8qbbavavcjdfaqcufad2fad;8qbbaqaDfhDc9:hoalmexikkc9:hoxekcbc99aral9Radcaadca0ESEhokavcj;kbf8Kjjjjbaokwbz:bjjjbk;uzeHu8Jjjjjbc;ae9Rgv8Kjjjjbc9:hodnaeci9UgrcHfal0mbcuhoaiRbbgwc;WeGc;Ge9hmbawcsGgDce0mbavc;abfcFecje;8kbavcUf9cu83ibavc8Wf9cu83ibavcyf9cu83ibavcaf9cu83ibavcKf9cu83ibavczf9cu83ibav9cu83iwav9cu83ibaialfc9WfhqaicefgwarfhodnaeTmbcmcsaDceSEhkcbhxcbhmcbhDcbhicbhlindnaoaq9nmbc9:hoxikdndnawRbbgrc;Ve0mbavc;abfalarcl4cu7fcsGcitfgPydlhsaPydbhzdnarcsGgPak9pmbavaiarcu7fcsGcdtfydbaxaPEhraPThPdndnadcd9hmbabaDcetfgHaz87ebaHcdfas87ebaHclfar87ebxekabaDcdtfgHazBdbaHclfasBdbaHcwfarBdbkaxaPfhxavc;abfalcitfgHarBdbaHasBdlavaicdtfarBdbavc;abfalcefcsGglcitfgHazBdbaHarBdlaiaPfhialcefhlxdkdndnaPcsSmbamaPfaPc987fcefhmxekaocefhrao8SbbgPcFeGhHdndnaPcu9mmbarhoxekaocvfhoaHcFbGhHcrhPdninar8SbbgOcFbGaPtaHVhHaOcu9kmearcefhraPcrfgPc8J9hmbxdkkarcefhokaHce4cbaHceG9R7amfhmkdndnadcd9hmbabaDcetfgraz87ebarcdfas87ebarclfam87ebxekabaDcdtfgrazBdbarclfasBdbarcwfamBdbkavc;abfalcitfgramBdbarasBdlavaicdtfamBdbavc;abfalcefcsGglcitfgrazBdbaramBdlaicefhialcefhlxekdnarcpe0mbaxcefgOavaiaqarcsGfRbbgPcl49RcsGcdtfydbaPcz6gHEhravaiaP9RcsGcdtfydbaOaHfgsaPcsGgOEhPaOThOdndnadcd9hmbabaDcetfgzax87ebazcdfar87ebazclfaP87ebxekabaDcdtfgzaxBdbazclfarBdbazcwfaPBdbkavaicdtfaxBdbavc;abfalcitfgzarBdbazaxBdlavaicefgicsGcdtfarBdbavc;abfalcefcsGcitfgzaPBdbazarBdlavaiaHfcsGgicdtfaPBdbavc;abfalcdfcsGglcitfgraxBdbaraPBdlalcefhlaiaOfhiasaOfhxxekaxcbaoRbbgzEgAarc;:eSgrfhsazcsGhCazcl4hXdndnazcs0mbascefhOxekashOavaiaX9RcsGcdtfydbhskdndnaCmbaOcefhxxekaOhxavaiaz9RcsGcdtfydbhOkdndnarTmbaocefhrxekaocdfhrao8SbegHcFeGhPdnaHcu9kmbaocofhAaPcFbGhPcrhodninar8SbbgHcFbGaotaPVhPaHcu9kmearcefhraocrfgoc8J9hmbkaAhrxekarcefhrkaPce4cbaPceG9R7amfgmhAkdndnaXcsSmbarhPxekarcefhPar8SbbgocFeGhHdnaocu9kmbarcvfhsaHcFbGhHcrhodninaP8SbbgrcFbGaotaHVhHarcu9kmeaPcefhPaocrfgoc8J9hmbkashPxekaPcefhPkaHce4cbaHceG9R7amfgmhskdndnaCcsSmbaPhoxekaPcefhoaP8SbbgrcFeGhHdnarcu9kmbaPcvfhOaHcFbGhHcrhrdninao8SbbgPcFbGartaHVhHaPcu9kmeaocefhoarcrfgrc8J9hmbkaOhoxekaocefhokaHce4cbaHceG9R7amfgmhOkdndnadcd9hmbabaDcetfgraA87ebarcdfas87ebarclfaO87ebxekabaDcdtfgraABdbarclfasBdbarcwfaOBdbkavc;abfalcitfgrasBdbaraABdlavaicdtfaABdbavc;abfalcefcsGcitfgraOBdbarasBdlavaicefgicsGcdtfasBdbavc;abfalcdfcsGcitfgraABdbaraOBdlavaiazcz6aXcsSVfgicsGcdtfaOBdbaiaCTaCcsSVfhialcifhlkawcefhwalcsGhlaicsGhiaDcifgDae6mbkkcbc99aoaqSEhokavc;aef8Kjjjjbaok:llevu8Jjjjjbcz9Rhvc9:hodnaecvfal0mbcuhoaiRbbc;:eGc;qe9hmbav9cb83iwaicefhraialfc98fhwdnaeTmbdnadcdSmbcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcdtfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfglBdbaoalBdbaDcefgDae9hmbxdkkcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcetfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfgl87ebaoalBdbaDcefgDae9hmbkkcbc99arawSEhokaok:EPliuo97eue978Jjjjjbca9Rhidndnadcl9hmbdnaec98GglTmbcbhvabhdinadadpbbbgocKp:RecKp:Sep;6egraocwp:RecKp:Sep;6earp;Geaoczp:RecKp:Sep;6egwp;Gep;Kep;LegDpxbbbbbbbbbbbbbbbbp:2egqarpxbbbjbbbjbbbjbbbjgkp9op9rp;Kegrpxbb;:9cbb;:9cbb;:9cbb;:9cararp;MeaDaDp;Meawaqawakp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFbbbFbbbFbbbFbbbp9oaopxbbbFbbbFbbbFbbbFp9op9qarawp;Meaqp;Kecwp:RepxbFbbbFbbbFbbbFbbp9op9qaDawp;Meaqp;Keczp:RepxbbFbbbFbbbFbbbFbp9op9qpkbbadczfhdavclfgval6mbkkalae9pmeaiaeciGgvcdtgdVcbczad9R;8kbaiabalcdtfglad;8qbbdnavTmbaiaipblbgocKp:RecKp:Sep;6egraocwp:RecKp:Sep;6earp;Geaoczp:RecKp:Sep;6egwp;Gep;Kep;LegDpxbbbbbbbbbbbbbbbbp:2egqarpxbbbjbbbjbbbjbbbjgkp9op9rp;Kegrpxbb;:9cbb;:9cbb;:9cbb;:9cararp;MeaDaDp;Meawaqawakp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFbbbFbbbFbbbFbbbp9oaopxbbbFbbbFbbbFbbbFp9op9qarawp;Meaqp;Kecwp:RepxbFbbbFbbbFbbbFbbp9op9qaDawp;Meaqp;Keczp:RepxbbFbbbFbbbFbbbFbp9op9qpklbkalaiad;8qbbskdnaec98GgxTmbcbhvabhdinadczfglalpbbbgopxbbbbbbFFbbbbbbFFgkp9oadpbbbgDaopmlvorxmPsCXQL358E8FpxFubbFubbFubbFubbp9op;6eaDaopmbediwDqkzHOAKY8AEgoczp:Sep;6egrp;Geaoczp:Reczp:Sep;6egwp;Gep;Kep;Legopxb;:FSb;:FSb;:FSb;:FSawaopxbbbbbbbbbbbbbbbbp:2egqawpxbbbjbbbjbbbjbbbjgmp9op9rp;Kegwawp;Meaoaop;Mearaqaramp9op9rp;Kegoaop;Mep;Kep;Kep;Jep;Negrp;Mepxbbn0bbn0bbn0bbn0gqp;Keczp:Reawarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9op9qgwaoarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9ogopmwDKYqk8AExm35Ps8E8Fp9qpkbbadaDakp9oawaopmbezHdiOAlvCXorQLp9qpkbbadcafhdavclfgvax6mbkkaxae9pmbaiaeciGgvcitgdfcbcaad9R;8kbaiabaxcitfglad;8qbbdnavTmbaiaipblzgopxbbbbbbFFbbbbbbFFgkp9oaipblbgDaopmlvorxmPsCXQL358E8FpxFubbFubbFubbFubbp9op;6eaDaopmbediwDqkzHOAKY8AEgoczp:Sep;6egrp;Geaoczp:Reczp:Sep;6egwp;Gep;Kep;Legopxb;:FSb;:FSb;:FSb;:FSawaopxbbbbbbbbbbbbbbbbp:2egqawpxbbbjbbbjbbbjbbbjgmp9op9rp;Kegwawp;Meaoaop;Mearaqaramp9op9rp;Kegoaop;Mep;Kep;Kep;Jep;Negrp;Mepxbbn0bbn0bbn0bbn0gqp;Keczp:Reawarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9op9qgwaoarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9ogopmwDKYqk8AExm35Ps8E8Fp9qpklzaiaDakp9oawaopmbezHdiOAlvCXorQLp9qpklbkalaiad;8qbbkk;4wllue97euv978Jjjjjbc8W9Rhidnaec98GglTmbcbhvabhoinaiaopbbbgraoczfgwpbbbgDpmlvorxmPsCXQL358E8Fgqczp:Segkclp:RepklbaopxbbjZbbjZbbjZbbjZpx;Zl81Z;Zl81Z;Zl81Z;Zl81Zakpxibbbibbbibbbibbbp9qp;6ep;NegkaraDpmbediwDqkzHOAKY8AEgrczp:Reczp:Sep;6ep;MegDaDp;Meakarczp:Sep;6ep;Megxaxp;Meakaqczp:Reczp:Sep;6ep;Megqaqp;Mep;Kep;Kep;Lepxbbbbbbbbbbbbbbbbp:4ep;Jepxb;:FSb;:FSb;:FSb;:FSgkp;Mepxbbn0bbn0bbn0bbn0grp;KepxFFbbFFbbFFbbFFbbgmp9oaxakp;Mearp;Keczp:Rep9qgxaqakp;Mearp;Keczp:ReaDakp;Mearp;Keamp9op9qgkpmbezHdiOAlvCXorQLgrp5baipblbpEb:T:j83ibaocwfarp5eaipblbpEe:T:j83ibawaxakpmwDKYqk8AExm35Ps8E8Fgkp5baipblbpEd:T:j83ibaocKfakp5eaipblbpEi:T:j83ibaocafhoavclfgval6mbkkdnalae9pmbaiaeciGgvcitgofcbcaao9R;8kbaiabalcitfgwao;8qbbdnavTmbaiaipblbgraipblzgDpmlvorxmPsCXQL358E8Fgqczp:Segkclp:RepklaaipxbbjZbbjZbbjZbbjZpx;Zl81Z;Zl81Z;Zl81Z;Zl81Zakpxibbbibbbibbbibbbp9qp;6ep;NegkaraDpmbediwDqkzHOAKY8AEgrczp:Reczp:Sep;6ep;MegDaDp;Meakarczp:Sep;6ep;Megxaxp;Meakaqczp:Reczp:Sep;6ep;Megqaqp;Mep;Kep;Kep;Lepxbbbbbbbbbbbbbbbbp:4ep;Jepxb;:FSb;:FSb;:FSb;:FSgkp;Mepxbbn0bbn0bbn0bbn0grp;KepxFFbbFFbbFFbbFFbbgmp9oaxakp;Mearp;Keczp:Rep9qgxaqakp;Mearp;Keczp:ReaDakp;Mearp;Keamp9op9qgkpmbezHdiOAlvCXorQLgrp5baipblapEb:T:j83ibaiarp5eaipblapEe:T:j83iwaiaxakpmwDKYqk8AExm35Ps8E8Fgkp5baipblapEd:T:j83izaiakp5eaipblapEi:T:j83iKkawaiao;8qbbkk:Pddiue978Jjjjjbc;ab9Rhidnadcd4ae2glc98GgvTmbcbhdabheinaeaepbbbgocwp:Recwp:Sep;6eaocep:SepxbbjZbbjZbbjZbbjZp:UepxbbjFbbjFbbjFbbjFp9op;Mepkbbaeczfheadclfgdav6mbkkdnaval9pmbaialciGgdcdtgeVcbc;abae9R;8kbaiabavcdtfgvae;8qbbdnadTmbaiaipblbgocwp:Recwp:Sep;6eaocep:SepxbbjZbbjZbbjZbbjZp:UepxbbjFbbjFbbjFbbjFp9op;Mepklbkavaiae;8qbbkk9teiucbcbydj1jjbgeabcifc98GfgbBdj1jjbdndnabZbcztgd9nmbcuhiabad9RcFFifcz4nbcuSmekaehikaikkkebcjwklz9Tbb":"b9H79Tebbbe8Fv9Gbb9Gvuuuuueu9Giuuub9Geueu9Giuuueuikqbeeedddillviebeoweuec:q;iekr;leDo9TW9T9VV95dbH9F9F939H79T9F9J9H229F9Jt9VV7bb8A9TW79O9V9Wt9F9KW9J9V9KW9wWVtW949c919M9MWVbeY9TW79O9V9Wt9F9KW9J9V9KW69U9KW949c919M9MWVbdE9TW79O9V9Wt9F9KW9J9V9KW69U9KW949tWG91W9U9JWbiL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9p9JtblK9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9r919HtbvL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWVT949Wbol79IV9Rbrq:P8Yqdbk;3sezu8Jjjjjbcj;eb9Rgv8Kjjjjbc9:hodnadcefal0mbcuhoaiRbbc:Ge9hmbavaialfgrad9Radz1jjjbhwcj;abad9UhoaicefhldnadTmbaoc;WFbGgocjdaocjd6EhDcbhqinaqae9pmeaDaeaq9RaqaDfae6Egkcsfgocl4cifcd4hxdndndndnaoc9WGgmTmbcbhPcehsawcjdfhzalhHinaraH9Rax6midnaraHaxfgl9RcK6mbczhoinawcj;cbfaogifgoc9WfhOdndndndndnaHaic9WfgAco4fRbbaAci4coG4ciGPlbedibkaO9cb83ibaOcwf9cb83ibxikaOalRblalRbbgAco4gCaCciSgCE86bbaocGfalclfaCfgORbbaAcl4ciGgCaCciSgCE86bbaocVfaOaCfgORbbaAcd4ciGgCaCciSgCE86bbaoc7faOaCfgORbbaAciGgAaAciSgAE86bbaoctfaOaAfgARbbalRbegOco4gCaCciSgCE86bbaoc91faAaCfgARbbaOcl4ciGgCaCciSgCE86bbaoc4faAaCfgARbbaOcd4ciGgCaCciSgCE86bbaoc93faAaCfgARbbaOciGgOaOciSgOE86bbaoc94faAaOfgARbbalRbdgOco4gCaCciSgCE86bbaoc95faAaCfgARbbaOcl4ciGgCaCciSgCE86bbaoc96faAaCfgARbbaOcd4ciGgCaCciSgCE86bbaoc97faAaCfgARbbaOciGgOaOciSgOE86bbaoc98faAaOfgORbbalRbiglco4gAaAciSgAE86bbaoc99faOaAfgORbbalcl4ciGgAaAciSgAE86bbaoc9:faOaAfgORbbalcd4ciGgAaAciSgAE86bbaocufaOaAfgoRbbalciGglalciSglE86bbaoalfhlxdkaOalRbwalRbbgAcl4gCaCcsSgCE86bbaocGfalcwfaCfgORbbaAcsGgAaAcsSgAE86bbaocVfaOaAfgORbbalRbegAcl4gCaCcsSgCE86bbaoc7faOaCfgORbbaAcsGgAaAcsSgAE86bbaoctfaOaAfgORbbalRbdgAcl4gCaCcsSgCE86bbaoc91faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc4faOaAfgORbbalRbigAcl4gCaCcsSgCE86bbaoc93faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc94faOaAfgORbbalRblgAcl4gCaCcsSgCE86bbaoc95faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc96faOaAfgORbbalRbvgAcl4gCaCcsSgCE86bbaoc97faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc98faOaAfgORbbalRbogAcl4gCaCcsSgCE86bbaoc99faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc9:faOaAfgORbbalRbrglcl4gAaAcsSgAE86bbaocufaOaAfgoRbbalcsGglalcsSglE86bbaoalfhlxekaOal8Pbb83bbaOcwfalcwf8Pbb83bbalczfhlkdnaiam9pmbaiczfhoaral9RcL0mekkaiam6mialTmidnakTmbawaPfRbbhOcbhoazhiinaiawcj;cbfaofRbbgAce4cbaAceG9R7aOfgO86bbaiadfhiaocefgoak9hmbkkazcefhzaPcefgPad6hsalhHaPad9hmexvkkcbhlasceGmdxikalaxad2fhCdnakTmbcbhHcehsawcjdfhminaral9Rax6mialTmdalaxfhlawaHfRbbhOcbhoamhiinaiawcj;cbfaofRbbgAce4cbaAceG9R7aOfgO86bbaiadfhiaocefgoak9hmbkamcefhmaHcefgHad6hsaHad9hmbkaChlxikcbhocehsinaral9Rax6mdalTmealaxfhlaocefgoad6hsadao9hmbkaChlxdkcbhlasceGTmekc9:hoxikabaqad2fawcjdfakad2z1jjjb8Aawawcjdfakcufad2fadz1jjjb8Aakaqfhqalmbkc9:hoxekcbc99aral9Radcaadca0ESEhokavcj;ebf8Kjjjjbaok;yzeHu8Jjjjjbc;ae9Rgv8Kjjjjbc9:hodnaeci9UgrcHfal0mbcuhoaiRbbgwc;WeGc;Ge9hmbawcsGgDce0mbavc;abfcFecjez:jjjjb8AavcUf9cu83ibavc8Wf9cu83ibavcyf9cu83ibavcaf9cu83ibavcKf9cu83ibavczf9cu83ibav9cu83iwav9cu83ibaialfc9WfhqaicefgwarfhodnaeTmbcmcsaDceSEhkcbhxcbhmcbhDcbhicbhlindnaoaq9nmbc9:hoxikdndnawRbbgrc;Ve0mbavc;abfalarcl4cu7fcsGcitfgPydlhsaPydbhzdnarcsGgPak9pmbavaiarcu7fcsGcdtfydbaxaPEhraPThPdndnadcd9hmbabaDcetfgHaz87ebaHcdfas87ebaHclfar87ebxekabaDcdtfgHazBdbaHclfasBdbaHcwfarBdbkaxaPfhxavc;abfalcitfgHarBdbaHasBdlavaicdtfarBdbavc;abfalcefcsGglcitfgHazBdbaHarBdlaiaPfhialcefhlxdkdndnaPcsSmbamaPfaPc987fcefhmxekaocefhrao8SbbgPcFeGhHdndnaPcu9mmbarhoxekaocvfhoaHcFbGhHcrhPdninar8SbbgOcFbGaPtaHVhHaOcu9kmearcefhraPcrfgPc8J9hmbxdkkarcefhokaHce4cbaHceG9R7amfhmkdndnadcd9hmbabaDcetfgraz87ebarcdfas87ebarclfam87ebxekabaDcdtfgrazBdbarclfasBdbarcwfamBdbkavc;abfalcitfgramBdbarasBdlavaicdtfamBdbavc;abfalcefcsGglcitfgrazBdbaramBdlaicefhialcefhlxekdnarcpe0mbaxcefgOavaiaqarcsGfRbbgPcl49RcsGcdtfydbaPcz6gHEhravaiaP9RcsGcdtfydbaOaHfgsaPcsGgOEhPaOThOdndnadcd9hmbabaDcetfgzax87ebazcdfar87ebazclfaP87ebxekabaDcdtfgzaxBdbazclfarBdbazcwfaPBdbkavaicdtfaxBdbavc;abfalcitfgzarBdbazaxBdlavaicefgicsGcdtfarBdbavc;abfalcefcsGcitfgzaPBdbazarBdlavaiaHfcsGgicdtfaPBdbavc;abfalcdfcsGglcitfgraxBdbaraPBdlalcefhlaiaOfhiasaOfhxxekaxcbaoRbbgzEgAarc;:eSgrfhsazcsGhCazcl4hXdndnazcs0mbascefhOxekashOavaiaX9RcsGcdtfydbhskdndnaCmbaOcefhxxekaOhxavaiaz9RcsGcdtfydbhOkdndnarTmbaocefhrxekaocdfhrao8SbegHcFeGhPdnaHcu9kmbaocofhAaPcFbGhPcrhodninar8SbbgHcFbGaotaPVhPaHcu9kmearcefhraocrfgoc8J9hmbkaAhrxekarcefhrkaPce4cbaPceG9R7amfgmhAkdndnaXcsSmbarhPxekarcefhPar8SbbgocFeGhHdnaocu9kmbarcvfhsaHcFbGhHcrhodninaP8SbbgrcFbGaotaHVhHarcu9kmeaPcefhPaocrfgoc8J9hmbkashPxekaPcefhPkaHce4cbaHceG9R7amfgmhskdndnaCcsSmbaPhoxekaPcefhoaP8SbbgrcFeGhHdnarcu9kmbaPcvfhOaHcFbGhHcrhrdninao8SbbgPcFbGartaHVhHaPcu9kmeaocefhoarcrfgrc8J9hmbkaOhoxekaocefhokaHce4cbaHceG9R7amfgmhOkdndnadcd9hmbabaDcetfgraA87ebarcdfas87ebarclfaO87ebxekabaDcdtfgraABdbarclfasBdbarcwfaOBdbkavc;abfalcitfgrasBdbaraABdlavaicdtfaABdbavc;abfalcefcsGcitfgraOBdbarasBdlavaicefgicsGcdtfasBdbavc;abfalcdfcsGcitfgraABdbaraOBdlavaiazcz6aXcsSVfgicsGcdtfaOBdbaiaCTaCcsSVfhialcifhlkawcefhwalcsGhlaicsGhiaDcifgDae6mbkkcbc99aoaqSEhokavc;aef8Kjjjjbaok:llevu8Jjjjjbcz9Rhvc9:hodnaecvfal0mbcuhoaiRbbc;:eGc;qe9hmbav9cb83iwaicefhraialfc98fhwdnaeTmbdnadcdSmbcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcdtfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfglBdbaoalBdbaDcefgDae9hmbxdkkcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcetfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfgl87ebaoalBdbaDcefgDae9hmbkkcbc99arawSEhokaok:Lvoeue99dud99eud99dndnadcl9hmbaeTmeindndnabcdfgd8Sbb:Yab8Sbbgi:Ygl:l:tabcefgv8Sbbgo:Ygr:l:tgwJbb;:9cawawNJbbbbawawJbbbb9GgDEgq:mgkaqaicb9iEalMgwawNakaqaocb9iEarMgqaqNMM:r:vglNJbbbZJbbb:;aDEMgr:lJbbb9p9DTmbar:Ohixekcjjjj94hikadai86bbdndnaqalNJbbbZJbbb:;aqJbbbb9GEMgq:lJbbb9p9DTmbaq:Ohdxekcjjjj94hdkavad86bbdndnawalNJbbbZJbbb:;awJbbbb9GEMgw:lJbbb9p9DTmbaw:Ohdxekcjjjj94hdkabad86bbabclfhbaecufgembxdkkaeTmbindndnabclfgd8Ueb:Yab8Uebgi:Ygl:l:tabcdfgv8Uebgo:Ygr:l:tgwJb;:FSawawNJbbbbawawJbbbb9GgDEgq:mgkaqaicb9iEalMgwawNakaqaocb9iEarMgqaqNMM:r:vglNJbbbZJbbb:;aDEMgr:lJbbb9p9DTmbar:Ohixekcjjjj94hikadai87ebdndnaqalNJbbbZJbbb:;aqJbbbb9GEMgq:lJbbb9p9DTmbaq:Ohdxekcjjjj94hdkavad87ebdndnawalNJbbbZJbbb:;awJbbbb9GEMgw:lJbbb9p9DTmbaw:Ohdxekcjjjj94hdkabad87ebabcwfhbaecufgembkkk;siliui99iue99dnaeTmbcbhiabhlindndnJ;Zl81Zalcof8UebgvciV:Y:vgoal8Ueb:YNgrJb;:FSNJbbbZJbbb:;arJbbbb9GEMgw:lJbbb9p9DTmbaw:OhDxekcjjjj94hDkalclf8Uebhqalcdf8UebhkabavcefciGaiVcetfaD87ebdndnaoak:YNgwJb;:FSNJbbbZJbbb:;awJbbbb9GEMgx:lJbbb9p9DTmbax:Ohkxekcjjjj94hkkabavcdfciGaiVcetfak87ebdndnaoaq:YNgoJb;:FSNJbbbZJbbb:;aoJbbbb9GEMgx:lJbbb9p9DTmbax:Ohqxekcjjjj94hqkabavcufciGaiVcetfaq87ebdndnJbbjZararN:tawawN:taoaoN:tgrJbbbbarJbbbb9GE:rJb;:FSNJbbbZMgr:lJbbb9p9DTmbar:Ohqxekcjjjj94hqkabavciGaiVcetfaq87ebalcwfhlaiclfhiaecufgembkkk9mbdnadcd4ae2geTmbinababydbgdcwtcw91:Yadce91cjjj;8ifcjjj98G::NUdbabclfhbaecufgembkkk9teiucbcbydj1jjbgeabcifc98GfgbBdj1jjbdndnabZbcztgd9nmbcuhiabad9RcFFifcz4nbcuSmekaehikaik;LeeeudndnaeabVciGTmbabhixekdndnadcz9pmbabhixekabhiinaiaeydbBdbaiclfaeclfydbBdbaicwfaecwfydbBdbaicxfaecxfydbBdbaiczfhiaeczfheadc9Wfgdcs0mbkkadcl6mbinaiaeydbBdbaeclfheaiclfhiadc98fgdci0mbkkdnadTmbinaiaeRbb86bbaicefhiaecefheadcufgdmbkkabk;aeedudndnabciGTmbabhixekaecFeGc:b:c:ew2hldndnadcz9pmbabhixekabhiinaialBdbaicxfalBdbaicwfalBdbaiclfalBdbaiczfhiadc9Wfgdcs0mbkkadcl6mbinaialBdbaiclfhiadc98fgdci0mbkkdnadTmbinaiae86bbaicefhiadcufgdmbkkabkkkebcjwklz9Kbb",r=WebAssembly.instantiate(n(s),{}).then((function(e){(i=e.instance).exports.__wasm_call_ctors()}));function n(e){for(var i=new Uint8Array(e.length),s=0;s<e.length;++s){var r=e.charCodeAt(s);i[s]=r>96?r-97:r>64?r-39:r+4}var n=0;for(s=0;s<e.length;++s)i[n++]=i[s]<60?t[i[s]]:64*(i[s]-60)+i[++s];return i.buffer.slice(0,n)}function a(e,t,s,r,n,a){var o=i.exports.sbrk,l=s+3&-4,h=o(l*r),c=o(n.length),d=new Uint8Array(i.exports.memory.buffer);d.set(n,c);var u=e(h,s,r,c,n.length);if(0==u&&a&&a(h,l,r),t.set(d.subarray(h,h+s*r)),o(h-o(0)),0!=u)throw new Error("Malformed buffer data: "+u)}var o={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},l={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"},h=[],c=0;function d(e){var t={object:new Worker(e),pending:0,requests:{}};return t.object.onmessage=function(e){var i=e.data;t.pending-=i.count,t.requests[i.id][i.action](i.value),delete t.requests[i.id]},t}function u(e){for(var t="var instance; var ready = WebAssembly.instantiate(new Uint8Array(["+new Uint8Array(n(s))+"]), {}).then(function(result) { instance = result.instance; instance.exports.__wasm_call_ctors(); });self.onmessage = workerProcess;"+a.toString()+f.toString(),i=new Blob([t],{type:"text/javascript"}),r=URL.createObjectURL(i),o=0;o<e;++o)h[o]=d(r);URL.revokeObjectURL(r)}function f(e){r.then((function(){var t=e.data;try{var s=new Uint8Array(t.count*t.size);a(i.exports[t.mode],s,t.count,t.size,t.source,i.exports[t.filter]),self.postMessage({id:t.id,count:t.count,action:"resolve",value:s},[s.buffer])}catch(e){self.postMessage({id:t.id,count:t.count,action:"reject",value:e})}}))}return{ready:r,supported:!0,useWorkers:function(e){u(e)},decodeVertexBuffer:function(e,t,s,r,n){a(i.exports.meshopt_decodeVertexBuffer,e,t,s,r,i.exports[o[n]])},decodeIndexBuffer:function(e,t,s,r){a(i.exports.meshopt_decodeIndexBuffer,e,t,s,r)},decodeIndexSequence:function(e,t,s,r){a(i.exports.meshopt_decodeIndexSequence,e,t,s,r)},decodeGltfBuffer:function(e,t,s,r,n,h){a(i.exports[l[n]],e,t,s,r,i.exports[o[h]])},decodeGltfBufferAsync:function(e,t,s,n,d){return h.length>0?function(e,t,i,s,r){for(var n=h[0],a=1;a<h.length;++a)h[a].pending<n.pending&&(n=h[a]);return new Promise((function(a,o){var l=new Uint8Array(i),h=c++;n.pending+=e,n.requests[h]={resolve:a,reject:o},n.object.postMessage({id:h,count:e,size:t,source:l,mode:s,filter:r},[l.buffer])}))}(e,t,s,l[n],o[d]):r.then((function(){var r=new Uint8Array(e*t);return a(i.exports[l[n]],r,e,t,s,i.exports[o[d]]),r}))}}}();const xT=["gltf","glb","vox"],ST=new Ci(new hi(0,1,0),new hi(1,1,1)),wT=new hi,TT=new Ci;class CT{canvas;app;skyboxUrls;controlEventKeys=null;pngExporter=null;prevCameraMat;camera;initialCameraPosition;initialCameraFocus;light;sceneRoot;debugRoot;entities;entityAssets;assets;meshInstances;wireframeMeshInstances;wireframeMaterial;animTracks;animationMap;firstFrame;skyboxLoaded;animSpeed;animTransition;animLoops;showWireframe;showBounds;showSkeleton;showAxes;showGrid;normalLength;dirtyWireframe;dirtyBounds;dirtySkeleton;dirtyGrid;dirtyNormals;sceneBounds;dynamicSceneBounds;debugBounds;debugSkeleton;debugGrid;debugNormals;miniStats;observer;suppressAnimationProgressUpdate;selectedNode;multiframe;multiframeBusy=!1;picker=null;cursorWorld=new hi;loadTimestamp=null;shadowCatcher=null;xrMode;canvasResize=!0;cameraControls;constructor(e,t,i,s){this.canvas=e;const r=new Vw(e,{mouse:new Jo(e),touch:new el(e),keyboard:new Ko(window),graphicsDevice:t});this.app=r,this.skyboxUrls=s,_h.pickPS="\nvec4 packFloat(float depth) {\n    uvec4 u = (uvec4(floatBitsToUint(depth)) >> uvec4(0u, 8u, 16u, 24u)) & 0xffu;\n    return vec4(u) / 255.0;\n}\nvec4 getPickOutput() {\n    return packFloat(gl_FragCoord.z);\n}\n",this.app.scene.clusteredLightingEnabled=!1;const n=r.mouse._moveHandler;r.mouse.detach(),r.mouse._moveHandler=t=>{t.target===e&&n(t)},r.mouse.attach(e);const a=r.touch._moveHandler;r.touch.detach(),r.touch._moveHandler=t=>{t.target===e&&a(t)},r.touch.attach(e);const o=r.graphicsDevice.maxSamples>1;i.set("camera.multisampleSupported",o),i.set("camera.multisample",o&&i.get("camera.multisample")),this.pngExporter=new lT,$w(document.getElementById("app"),((e,t)=>{this.loadFiles(e,t)})),new ResizeObserver((()=>{this.xrMode&&!this.xrMode.active&&(this.canvasResize=!0,this.renderNextFrame())})).observe(window.document.getElementById("canvas-wrapper"));const l=r.scene.layers.getLayerById(1);r.scene.layers.remove(l),r.scene.layers.insertOpaque(l,2);const h=new Lm("Camera");h.setPosition(0,1,10),this.app.root.addChild(h),h.addComponent("camera",{fov:75,frustumCulling:!0,clearColor:new ii(0,0,0,0)}),h.addComponent("script"),h.script.create(CameraControls,{properties:{zoomMin:.001,zoomMax:10,pitchRange:new di(-180,180)}}),this.cameraControls=h.script.cameraControls,h.camera.requestSceneColorMap(!0),r.keyboard.on("keydown",(e=>{switch(e.key){case 70:this.focusSelection(!1),this.cameraControls.resetZoom(this.getZoomDist());break;case 82:this.cameraControls.focus(hi.ZERO,new hi(2,2,2))}}));const c=new Lm;c.addComponent("light",{type:"directional",shadowBias:.2,shadowResolution:2048}),r.root.addChild(c),r.autoRender=!1,this.prevCameraMat=new _i,r.on("update",this.update,this),r.on("framerender",this.onFrameRender,this),r.on("prerender",this.onPrerender,this),r.on("postrender",this.onPostrender,this),r.on("frameend",this.onFrameend,this);const d=new Lm("sceneRoot",r);r.root.addChild(d);const u=new Lm("debugRoot",r);r.root.addChild(u),this.camera=h,this.initialCameraPosition=null,this.initialCameraFocus=null,this.light=c,this.sceneRoot=d,this.debugRoot=u,this.entities=[],this.entityAssets=[],this.assets=[],this.meshInstances=[],this.wireframeMeshInstances=[];const f=new sp;f.blendState=new Sr(!0,0,1,0,0,0,1),f.useLighting=!1,f.useSkybox=!1,f.ambient=new ii(0,0,0),f.diffuse=new ii(0,0,0),f.specular=new ii(0,0,0),f.emissive=new ii(1,1,1),f.update(),this.wireframeMaterial=f,this.animTracks=[],this.animationMap={},this.firstFrame=!1,this.skyboxLoaded=!1,this.animSpeed=i.get("animation.speed"),this.animTransition=i.get("animation.transition"),this.animLoops=i.get("animation.loops"),this.showWireframe=i.get("debug.wireframe"),this.showBounds=i.get("debug.bounds"),this.showSkeleton=i.get("debug.skeleton"),this.showAxes=i.get("debug.axes"),this.normalLength=i.get("debug.normals"),this.setTonemapping(i.get("camera.tonemapping")),this.setBackgroundColor(i.get("skybox.backgroundColor")),this.setLightColor(i.get("light.color")),this.setWireframeColor(i.get("debug.wireframeColor")),this.dirtyWireframe=!1,this.dirtyBounds=!1,this.dirtySkeleton=!1,this.dirtyGrid=!1,this.dirtyNormals=!1,this.sceneBounds=new Ci,this.dynamicSceneBounds=new Ci,this.debugBounds=new Qw(r,h),this.debugSkeleton=new Qw(r,h),this.debugGrid=new Qw(r,h,!1),this.debugNormals=new Qw(r,h,!1),this.miniStats=new Ex(r),this.miniStats.enabled=i.get("debug.stats"),this.observer=i;const p=this.app.graphicsDevice;p.on("devicerestored",(()=>{this.renderNextFrame()})),this.multiframe=new iT(p,this.camera.camera),this.shadowCatcher=new hT(r,this.camera.camera,this.debugRoot,this.sceneRoot),this.initXrMode(),this.bindControlEvents(),this.reloadSettings(),this.picker=new oT(r,h),this.cursorWorld=new hi,e.addEventListener("dblclick",(async e=>{const t=await this.picker.pick(e.offsetX,e.offsetY);t&&this.cameraControls.focus(t,this.camera.getPosition())})),this.app.scene.layers.getLayerByName("World").transparentSortMode=3,r.start()}initXrMode(){const e=this.app.xr;this.xrMode=new bT({xr:e,camera:this.camera,content:this.sceneRoot,showUI:!0,startArImgSrc:dT.src,stopArImgSrc:cT.src});const t=this.xrMode.events;t.on("xr:started",(()=>{this.setShadowCatcherEnabled(!0),this.setShadowCatcherIntensity(.4),this.setDebugGrid(!1),this.setDebugBounds(!1),this.setLightEnabled(!0),this.setLightShadow(!0),this.setLightFollow(!1),this.setCenterScene(!0),this.setSkyboxBackground("None"),this.setSkyboxExposure(0),this.setBackgroundColor(ii.BLACK),this.app.scene.layers.getLayerById(2).enabled=!1,this.multiframe.blend=.5,this.cameraControls.detach()})),t.on("xr:initial-place",(()=>{this.multiframe.blend=1})),t.on("xr:ended",(()=>{this.reloadSettings(),this.setBackgroundColor(this.observer.get("skybox.backgroundColor")),this.cameraControls.attach(this.camera.camera),this.multiframe.blend=1}))}getSelectedMeshInstances(){return this.selectedNode?this.collectMeshInstances(this.selectedNode):this.meshInstances}collectMeshInstances(e){const t=[];if(e){const i=e.findComponents("render");for(let e=0;e<i.length;e++){const s=i[e];if(s.meshInstances)for(let e=0;e<s.meshInstances.length;e++){const i=s.meshInstances[e];t.push(i)}}const s=e.findComponents("gsplat");for(let e=0;e<s.length;e++){const i=s[e];i.instance&&t.push(i.instance.meshInstance)}}return t}static calcMeshBoundingBox(e,t){if(t.length>0){e.copy(t[0].aabb);for(let i=1;i<t.length;++i)e.add(t[i].aabb)}}static calcHierBoundingBox(e,t){const i=t.getPosition();let s=i.x,r=i.y,n=i.z,a=i.x,o=i.y,l=i.z;const h=e=>{const t=e.getPosition();s=Math.min(s,t.x),r=Math.min(r,t.y),n=Math.min(n,t.z),a=Math.max(a,t.x),o=Math.max(o,t.y),l=Math.max(l,t.z);for(let t=0;t<e.children.length;++t)h(e.children[t])};h(t),e.setMinMax(new hi(s,r,n),new hi(a,o,l))}bindControlEvents(){const e={"camera.fov":this.setFov.bind(this),"camera.tonemapping":this.setTonemapping.bind(this),"camera.pixelScale":()=>{this.canvasResize=!0,this.renderNextFrame()},"camera.multisample":()=>{this.destroyRenderTargets(),this.renderNextFrame()},"camera.hq":e=>{this.multiframe.enabled=!this.app.graphicsDevice.isWebGPU&&e,this.renderNextFrame()},"skybox.value":e=>{if(this.skyboxUrls.has(e)){const t=this.skyboxUrls.get(e);this.loadFiles([{url:t,filename:t}])}else"None"===e?this.clearSkybox():this.loadFiles([{url:e,filename:e}])},"skybox.blur":this.setSkyboxBlur.bind(this),"skybox.exposure":this.setSkyboxExposure.bind(this),"skybox.rotation":this.setSkyboxRotation.bind(this),"skybox.background":this.setSkyboxBackground.bind(this),"skybox.backgroundColor":this.setBackgroundColor.bind(this),"skybox.domeProjection.domeRadius":this.setSkyboxDomeRadius.bind(this),"skybox.domeProjection.tripodOffset":this.setSkyboxTripodOffset.bind(this),"light.enabled":this.setLightEnabled.bind(this),"light.intensity":this.setLightIntensity.bind(this),"light.color":this.setLightColor.bind(this),"light.follow":this.setLightFollow.bind(this),"light.shadow":this.setLightShadow.bind(this),"shadowCatcher.enabled":this.setShadowCatcherEnabled.bind(this),"shadowCatcher.intensity":this.setShadowCatcherIntensity.bind(this),"debug.stats":this.setDebugStats.bind(this),"debug.wireframe":this.setDebugWireframe.bind(this),"debug.wireframeColor":this.setWireframeColor.bind(this),"debug.bounds":this.setDebugBounds.bind(this),"debug.skeleton":this.setDebugSkeleton.bind(this),"debug.axes":this.setDebugAxes.bind(this),"debug.grid":this.setDebugGrid.bind(this),"debug.normals":this.setNormalLength.bind(this),"debug.renderMode":this.setRenderMode.bind(this),"animation.playing":e=>{e?this.play():this.stop()},"animation.selectedTrack":this.setSelectedTrack.bind(this),"animation.speed":this.setSpeed.bind(this),"animation.transition":this.setTransition.bind(this),"animation.loops":this.setLoops.bind(this),"animation.progress":this.setAnimationProgress.bind(this),"scene.selectedNode.path":this.setSelectedNode.bind(this),"scene.variant.selected":this.setSelectedVariant.bind(this),centerScene:this.setCenterScene.bind(this)};this.controlEventKeys=Object.keys(e),this.controlEventKeys.forEach((t=>{this.observer.on(`${t}:set`,e[t])}))}reloadSettings(){this.controlEventKeys.forEach((e=>{this.observer.set(e,this.observer.get(e),!1,!1,!0)}))}clearSkybox(){this.app.scene.envAtlas=null,this.app.scene.setSkybox(null),this.renderNextFrame(),this.skyboxLoaded=!1}initSkybox(e){const t=Df.generateSkyboxCubemap(e),i=Df.generateLightingSource(e),s=Df.generateAtlas(i,{});i.destroy(),this.app.scene.envAtlas=s,this.app.scene.skybox=t,this.renderNextFrame()}loadSkybox(e){const t=this.app;if(6!==e.length){const i=new fm("skybox_equi","texture",{url:e[0].url,filename:e[0].filename});i.ready((()=>{const e=i.resource;e.type===_s&&7===e.format&&(e.type=bs),this.initSkybox(e)})),t.assets.add(i),t.assets.load(i)}else{const i=[["posx","negx","posy","negy","posz","negz"],["px","nx","py","ny","pz","nz"],["right","left","up","down","front","back"],["right","left","top","bottom","forward","backward"],["0","1","2","3","4","5"]],s=e=>{const t=e.toLowerCase();for(let e=0;e<i.length;++e){const s=i[e];for(let e=0;e<s.length;++e)if(-1!==t.indexOf(`${s[e]}.`))return e}return 0},r=(e,t)=>{const i=s(e.filename),r=s(t.filename);return i<r?-1:r<i?1:0};e.sort(r);const n=e.map(((e,i)=>{const s=new fm(`skybox_face${i}`,"texture",e);return t.assets.add(s),t.assets.load(s),s})),a=new fm("skybox_cubemap","cubemap",null,{textures:n.map((e=>e.id))});a.loadFaces=!0,a.on("load",(()=>{this.initSkybox(a.resource)})),t.assets.add(a),t.assets.load(a)}this.skyboxLoaded=!0}getCanvasSize(){const e=this.canvas.getBoundingClientRect();return{width:e.width,height:e.height}}getFocusPosition(e){const t=new hi;if(this.initialCameraFocus)t.copy(this.initialCameraFocus),this.initialCameraFocus=null;else{const i=this.entityAssets[0],s=i?.asset?.resource?.splatData;s?(s.calcFocalPoint(t,(()=>!0)),i.entity.getWorldTransform().transformPoint(t,t)):t.copy(e.center)}return t}getZoomDist(){const e=this.camera.camera;return Math.tan(37.5*ti.DEG_TO_RAD)/Math.tan(.5*e.fov*ti.DEG_TO_RAD)*(1/e.aspectRatio)*this.cameraControls.sceneSize+this.cameraControls.sceneSize}focusSelection(e=!0){this.calcSceneBounds(TT,this.selectedNode),this.cameraControls.sceneSize=TT.halfExtents.length();const t=this.getFocusPosition(TT);let i=null;e&&(i=new hi,this.initialCameraPosition?(i.copy(this.initialCameraPosition),this.initialCameraPosition=null):(i.copy(t),i.z+=this.getZoomDist()),this.camera.setPosition(i),this.fitCameraClipPlanes()),this.cameraControls.focus(t,i)}destroyRenderTargets(){const e=this.camera.camera.renderTarget;e&&(e.colorBuffer?.destroy(),e.depthBuffer?.destroy(),e.destroy(),this.camera.camera.renderTarget=null)}rebuildRenderTargets(){const e=this.app.graphicsDevice,t=e.width,i=e.height,s=this.camera.camera.renderTarget;if(s&&s.width===t&&s.height===i)return;this.destroyRenderTargets();const r=(t,i,s)=>new ur(e,{name:"viewer-rt-texture",width:t,height:i,format:s,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1}),n=e.maxSamples,a=r(t,i,7),o=r(t,i,Fi),l=new Wr({name:"viewer-rt",colorBuffer:a,depthBuffer:o,flipY:!1,samples:this.observer.get("camera.multisample")?n:1,autoResolve:!1});this.camera.camera.renderTarget=l}resetScene(){const e=this.app;this.entities.forEach((e=>{this.sceneRoot.removeChild(e),this.shadowCatcher.onEntityRemoved(e),e.destroy()})),this.entities=[],this.entityAssets=[],this.assets.forEach((t=>{e.assets.remove(t),t.unload()})),this.assets=[],this.meshInstances=[],this.resetWireframeMeshes(),this.animTracks=[],this.animationMap={}}updateSceneStats(){let e=0,t=0,i=0,s=0,r=0,n=0,a=0,o=[];this.assets.forEach((l=>{if(l.resource.splatData){const n=l.resource;e++,r++,s+=n.splatData.numSplats,i+=4*n.splatData.numSplats,t+=64*n.splatData.numSplats}else{const h=l.resource;o=o.concat(h.getMaterialVariants()??[]),h.renders.forEach((r=>{const n=r.resource;e+=n.meshes.length,n.meshes.forEach((e=>{i+=e.vertexBuffer.getNumVertices();const r=e.primitive[0];switch(r.type){case 0:case 2:s+=r.count;break;case 1:s+=r.count/2;break;case 3:s+=r.count-1;break;case 4:s+=r.count/3;break;case 5:case 6:s+=r.count-2}t+=e.vertexBuffer.numBytes+(e.indexBuffer?.[0]?.numBytes??0)}))})),r+=h.materials.length??0,n+=h.textures.length??0,(h.textures??[]).forEach((e=>{a+=e.resource.gpuSize}))}}));const l=function(e){return e.children.map((e=>({name:e.name,path:e.path,children:l(e)})))},h=this.entities.map((e=>({name:e.name,path:e.path,children:l(e)})));this.observer.set("scene.nodes",JSON.stringify(h)),this.observer.set("scene.meshCount",e),this.observer.set("scene.materialCount",r),this.observer.set("scene.textureCount",n),this.observer.set("scene.vertexCount",i),this.observer.set("scene.primitiveCount",s),this.observer.set("scene.textureVRAM",a),this.observer.set("scene.meshVRAM",t),this.observer.set("scene.variants.list",JSON.stringify(o)),this.observer.set("scene.variant.selected",o[0])}downloadPngScreenshot(){const e=this.camera.camera.renderTarget.colorBuffer;e.read(0,0,e.width,e.height).then((t=>{this.pngExporter.export("model-viewer.png",new Uint32Array(t.buffer.slice(0)),e.width,e.height)}))}fitCameraClipPlanes(){if(this.xrMode?.active)return;const e=this.camera.getWorldTransform(),t=e.getTranslation(),i=e.getZ(),s=this.dynamicSceneBounds,r=s.center,n=2*s.halfExtents.length();wT.sub2(r,t);const a=-wT.dot(i),o=a+n,l=Math.max(.001,a<n?o/1024:a-n);this.camera.camera.nearClip=l,this.camera.camera.farClip=o,this.light.light.shadowDistance=o,this.light.light.normalOffsetBias=o/1024}loadGltf(e,t){return new Promise(((i,s)=>{const r=new fm(e.filename,"container",e,null,{bufferView:{processAsync:function(e,t,i){if(e.extensions&&e.extensions.EXT_meshopt_compression){const s=e.extensions.EXT_meshopt_compression;Promise.all([yT.ready,t[s.buffer]]).then((e=>{const t=e[1],r=s.byteOffset||0,n=s.byteLength||0,a=s.count,o=s.byteStride,l=new Uint8Array(a*o),h=new Uint8Array(t.buffer,t.byteOffset+r,n);yT.decodeGltfBuffer(l,a,o,h,s.mode,s.filter),i(null,l)}))}else i(null,null)}.bind(this)},image:{processAsync:function(e,i){const s=t.find((t=>t.filename===decodeURIComponent(kt.normalize(e.uri||""))));if(s){const e=new fm(s.filename,"texture",{url:s.url,filename:s.filename});e.on("load",(()=>{i(null,e)})),this.app.assets.add(e),this.app.assets.load(e)}else i(null,null)}.bind(this),postprocess:(e,t)=>{t.resource.anisotropy=this.app.graphicsDevice.maxAnisotropy}},buffer:{processAsync:function(e,i){const s=t.find((t=>t.filename===decodeURIComponent(kt.normalize(e.uri||""))));if(s){const e=new fm(s.filename,"binary",{url:s.url,filename:s.filename});e.on("load",(()=>{i(null,new Uint8Array(e.resource))})),this.app.assets.add(e),this.app.assets.load(e)}else i(null,null)}.bind(this)}});r.on("load",(()=>i(r))),r.on("error",(e=>s(e))),this.app.assets.add(r),this.app.assets.load(r)}))}loadPly(e,t){const i={};return t.forEach((e=>{i[e.filename]=e.url})),new Promise(((t,s)=>{const r=new fm(e.filename,"gsplat",e,null,{mapUrl:e=>i[e]});r.on("load",(()=>t(r))),r.on("error",(e=>s(e))),this.app.assets.add(r),this.app.assets.load(r)}))}isModelFilename(e){const t=e.split("?")[0].split("/").pop().split(".");return 1===t.length||xT.includes(t.pop().toLowerCase())}isGSplatFilename(e){const t=e.split("?")[0].split("/").pop().split(".");return t.length>0&&["ply","json"].includes(t.pop().toLowerCase())}loadFiles(e,t=!1){Array.isArray(e)||(e=[e]);const i=e.reduce(((e,t)=>e||this.isModelFilename(t.filename)||this.isGSplatFilename(t.filename)),!1);if(i){t&&this.resetScene();const i=Date.now();this.observer.set("ui.spinner",!0),this.observer.set("ui.error",null),this.clearCta();const s=e.map((t=>this.isModelFilename(t.filename)?this.loadGltf(t,e):this.isGSplatFilename(t.filename)?this.loadPly(t,e):null));Promise.all(s).then((s=>{this.loadTimestamp=i,s.forEach((e=>{e&&this.addToScene(e)})),this.postSceneLoad();const r=e.map((e=>e.url)),n=e.map((e=>e.filename.split("/").pop()));t?(this.observer.set("scene.urls",r),this.observer.set("scene.filenames",n)):(this.observer.set("scene.urls",this.observer.get("scene.urls").concat(r)),this.observer.set("scene.filenames",this.observer.get("scene.filenames").concat(n)))})).catch((e=>{console.log(e),this.observer.set("ui.error",e?.toString()||e)})).finally((()=>{this.observer.set("ui.spinner",!1)}))}else this.loadSkybox(e);return i}setSelectedTrack(e){if("ALL_TRACKS"!==e){const t=this.animationMap[e];this.entities.forEach((e=>{e.anim?.baseLayer?.transition(t)}))}}play(){this.entities.forEach((e=>{e.anim&&(e.anim.playing=!0,e.anim.baseLayer?.play())}))}stop(){this.entities.forEach((e=>{e.anim&&(e.anim.playing=!1,e.anim.baseLayer?.pause())}))}setSpeed(e){this.animSpeed=e,this.entities.forEach((t=>{const i=t.anim;i&&(i.speed=e)}))}setTransition(e){this.animTransition=e,this.animTracks.length>0&&this.rebuildAnimTracks()}setLoops(e){this.animLoops=e,this.animTracks.length>0&&this.rebuildAnimTracks()}setAnimationProgress(e){this.suppressAnimationProgressUpdate||(this.entities.forEach((t=>{const i=t.anim,s=i?.baseLayer;s&&(this.play(),s.activeStateCurrentTime=s.activeStateDuration*e,i.update(0),i.playing=!1)})),this.renderNextFrame())}setSelectedNode(e){const t=this.app.root.findByPath(e);t&&this.observer.set("scene.selectedNode",{name:t.name,path:e,position:t.getLocalPosition().toString(),rotation:t.getLocalEulerAngles().toString(),scale:t.getLocalScale().toString()}),this.selectedNode=t,this.dirtyWireframe=!0,this.dirtyBounds=!0,this.dirtySkeleton=!0,this.renderNextFrame()}setSelectedVariant(e){e&&(this.entityAssets.forEach((t=>{const i=t.asset.resource;-1!==i.getMaterialVariants().indexOf(e)&&i.applyMaterialVariant(t.entity,e)})),this.renderNextFrame())}setCenterScene(e){this.sceneRoot.setLocalPosition(0,0,0),this.calcSceneBounds(this.sceneBounds),e&&this.sceneRoot.setLocalPosition(-this.sceneBounds.center.x,-this.sceneBounds.getMin().y,-this.sceneBounds.center.z),this.dirtyBounds=!0,this.renderNextFrame()}setDebugStats(e){this.miniStats.enabled=e,this.renderNextFrame()}setDebugWireframe(e){this.showWireframe=e,this.dirtyWireframe=!0,this.renderNextFrame()}setWireframeColor(e){this.wireframeMaterial.emissive=new ii(e.r,e.g,e.b),this.wireframeMaterial.update(),this.renderNextFrame()}setDebugBounds(e){this.showBounds=e,this.dirtyBounds=!0,this.renderNextFrame()}setDebugSkeleton(e){this.showSkeleton=e,this.dirtySkeleton=!0,this.renderNextFrame()}setDebugAxes(e){this.showAxes=e,this.dirtySkeleton=!0,this.renderNextFrame()}setDebugGrid(e){this.showGrid=e,this.dirtyGrid=!0,this.renderNextFrame()}setNormalLength(e){this.normalLength=e,this.dirtyNormals=!0,this.renderNextFrame()}setFov(e){this.camera.camera.fov=e,this.renderNextFrame()}setRenderMode(e){this.camera.camera.setShaderPass("default"!==e?`debug_${e}`:"forward"),this.renderNextFrame()}setLightEnabled(e){this.light.enabled=e,this.renderNextFrame()}setLightIntensity(e){this.light.light.intensity=e,this.renderNextFrame()}setLightColor(e){this.light.light.color=new ii(e.r,e.g,e.b),this.renderNextFrame()}setLightFollow(e){this.light.reparent(e?this.camera:this.app.root),e?this.light.setLocalEulerAngles(90,0,0):this.light.setLocalEulerAngles(45,30,0),this.renderNextFrame()}setLightShadow(e){this.light.light.castShadows=e,this.renderNextFrame()}setShadowCatcherEnabled(e){this.shadowCatcher.enabled=e,this.renderNextFrame()}setShadowCatcherIntensity(e){this.shadowCatcher.intensity=e,this.renderNextFrame()}setSkyboxExposure(e){this.app.scene.skyboxIntensity=Math.pow(2,e),this.renderNextFrame()}setSkyboxRotation(e){const t=new bi;t.setFromEulerAngles(0,e,0),this.app.scene.skyboxRotation=t,this.renderNextFrame()}setSkyboxBackground(e){const{scene:t}=this.app;switch(this.app.scene.layers.getLayerById(2).enabled="Solid Color"!==e,e){case"Solid Color":break;case"Infinite Sphere":t.sky.type=lh;break;case"Projective Dome":t.sky.type=hh;break;case"Projective Box":t.sky.type="box"}this.app.scene.skyboxMip="Infinite Sphere"===e?this.observer.get("skybox.blur"):0,this.renderNextFrame()}setSkyboxBlur(e){this.app.scene.skyboxMip="Infinite Sphere"===this.observer.get("skybox.background")?e:0,this.renderNextFrame()}setSkyboxDomeRadius(e){const t=(this.sceneBounds?.halfExtents.length()??1)*e;this.app.scene.sky.node.setLocalScale(t,t,t),this.renderNextFrame()}setSkyboxTripodOffset(e){this.app.scene.sky.center=new hi(0,e,0),this.renderNextFrame()}setTonemapping(e){const t={None:6,Linear:0,Neutral:5,Filmic:1,Hejl:2,ACES:3,ACES2:4};this.camera.camera.toneMapping=t.hasOwnProperty(e)?t[e]:3,this.renderNextFrame()}setBackgroundColor(e){const t=e=>Math.max(0,Math.min(255,Math.floor(255*e)));document.getElementById("canvas-wrapper").style.backgroundColor=`rgb(${t(e.r)}, ${t(e.g)}, ${t(e.b)})`}operationTimer=0;operationInterval=1/30;currentEntityIndex=0;update(e){if(!this.xrMode?.active){const t=this.cameraControls._zoomDist/this.cameraControls.sceneSize;this.cameraControls.moveSpeed=t,this.cameraControls.moveFastSpeed=4*t,this.cameraControls.moveSlowSpeed=.25*t,this.cameraControls.update(e)}const t=this.camera.getWorldTransform();((e,t)=>{let i=0;for(let s=0;s<16;++s)i=Math.max(i,Math.abs(e.data[s]-t.data[s]));return i})(t,this.prevCameraMat)>1e-4&&(this.prevCameraMat.copy(t),this.renderNextFrame()),this.xrMode?.active&&this.renderNextFrame();let i=!1;for(let e=0;e<this.entities.length;++e){const t=this.entities[e].anim;if(t&&t.baseLayer&&t.baseLayer.playing){i=!0;break}}if(i&&(this.dirtyBounds=!0,this.dirtySkeleton=!0,this.dirtyNormals=!0,this.renderNextFrame(),this.observer.emit("animationUpdate")),this.operationTimer+=e,this.entities.length>0&&this.operationTimer>=this.operationInterval){this.operationTimer=0;for(let e=0;e<this.entities.length;e++){this.entities[e].enabled=e===this.currentEntityIndex;const t=this.entities[e]?.gsplat?.instance?.sorter;if(t.enabled=!1,e===this.currentEntityIndex){const e=this.camera.getPosition().clone(),i=this.camera.forward.clone();e.x=-e.x,e.y=-e.y,i.z=-i.z,t.forceSortSync(e,i)}}this.currentEntityIndex=(this.currentEntityIndex+1)%this.entities.length}this.renderNextFrame()}renderNextFrame(){this.app.renderNextFrame=!0,this.multiframe&&this.multiframe.moved()}clearCta(){document.querySelector("#panel-left").classList.add("no-cta"),document.querySelector("#application-canvas").classList.add("no-cta"),document.querySelector(".load-button-panel").classList.add("hide")}addToScene(e){const t=e.resource,i=t.renders&&t.renders.length>0,s=t.animations&&t.animations.length>0,r=0===this.entities.length?null:this.entities[this.entities.length-1];let n;!i&&r&&r.findComponent("render")?n=r:(n="container"===e.type?t.instantiateRenderEntity():t.instantiate(),this.entities.push(n),this.entityAssets.push({entity:n,asset:e}),this.sceneRoot.addChild(n),n.enabled=!0,this.shadowCatcher.onEntityAdded(n)),s&&t.animations.forEach((e=>{this.animTracks.push(e.resource)})),this.assets.push(e)}postSceneLoad(){this.meshInstances=this.entities.map((e=>this.collectMeshInstances(e))).flat(),0===this.meshInstances.length&&this.observer.set("debug.skeleton",!0),this.updateSceneStats(),this.animTracks.length>0&&this.rebuildAnimTracks();const e={},t={};this.meshInstances.forEach(((i,s)=>{if(i.morphInstance){const r=i.morphInstance;t[s]=r;const n=i&&i.node&&i.node.name||`Mesh ${s}`;e[s]={name:n,targets:{}},r.morph.targets.forEach(((i,r)=>{e[s].targets[r]={name:i.name,targetIndex:r},this.observer.on(`morphs.${s}.targets.${r}.weight:set`,(e=>{t[s].setWeight(r,e),this.dirtyNormals=!0,this.renderNextFrame()}))}))}})),this.observer.suspendEvents=!0,this.observer.set("morphs",e),this.observer.suspendEvents=!1;const i=this.observer;i.on("animationUpdate",(()=>{for(let e=0;e<this.entities.length;++e){const t=this.entities[e];if(t&&t.anim){const e=t.anim.baseLayer,s=e.activeStateCurrentTime/e.activeStateDuration;this.suppressAnimationProgressUpdate=!0,i.set("animation.progress",1===s?s:s%1),this.suppressAnimationProgressUpdate=!1;break}}})),this.dirtyWireframe=this.dirtyBounds=this.dirtySkeleton=this.dirtyGrid=this.dirtyNormals=!0,this.renderNextFrame(),this.firstFrame=!0}initSceneBounds(){this.setCenterScene(this.observer.get("centerScene")),this.setSkyboxDomeRadius(this.observer.get("skybox.domeProjection.domeRadius")),this.focusSelection()}rebuildAnimTracks(){this.entities.forEach((e=>{e.anim?e.anim.removeStateGraph():(e.addComponent("anim",{activate:!0,speed:this.animSpeed}),e.anim.rootBone=e),this.animTracks.forEach(((t,i)=>{t.events=new gg([{name:"transition",time:t.duration,nextTrack:`track_${i===this.animTracks.length-1?0:i+1}`}]);const s=`track_${i}`;e.anim.assignAnimation(s,t),this.animationMap[t.name]=s})),e.anim.on("transition",(t=>{"ALL_TRACKS"===this.observer.get("animation.selectedTrack")&&e.anim.baseLayer.activeStateProgress>=this.animLoops&&e.anim.baseLayer.transition(t.nextTrack,this.animTransition)}))}));const e=this.observer.get("animation"),t=Object.keys(this.animationMap);e.list=JSON.stringify(t),e.selectedTrack=t[0],e.playing=!0,this.observer.set("animation",e)}calcSceneBounds(e,t=null){const i=t?this.collectMeshInstances(t):this.meshInstances;i.length?CT.calcMeshBoundingBox(e,i):(t=t??this.sceneRoot).children.length?CT.calcHierBoundingBox(e,t):e.copy(ST)}resetWireframeMeshes(){this.app.scene.layers.getLayerByName("World").removeMeshInstances(this.wireframeMeshInstances),this.wireframeMeshInstances.forEach((e=>{e.clearShaders()})),this.wireframeMeshInstances=[]}buildWireframeMeshes(){this.wireframeMeshInstances=this.getSelectedMeshInstances().map((e=>{const t=new tc(e.mesh,this.wireframeMaterial,e.node);return t.renderStyle=1,t.skinInstance=e.skinInstance,t.morphInstance=e.morphInstance,t})),this.app.scene.layers.getLayerByName("World").addMeshInstances(this.wireframeMeshInstances)}onFrameRender(){if(this.canvasResize){const{width:e,height:t}=this.getCanvasSize(),i=this.observer.get("camera.pixelScale"),s=Math.floor(e*window.devicePixelRatio/i),r=Math.floor(t*window.devicePixelRatio/i);this.app.graphicsDevice.setResolution(s,r),this.observer.set("runtime.viewportWidth",s),this.observer.set("runtime.viewportHeight",r),this.canvasResize=!1}this.rebuildRenderTargets()}onPrerender(){if(!this.firstFrame){if(this.dirtyWireframe&&(this.dirtyWireframe=!1,this.resetWireframeMeshes(),this.showWireframe&&this.buildWireframeMeshes(),this.getSelectedMeshInstances().forEach((e=>{e.material.depthBias=this.showWireframe?-1:0,e.material.slopeDepthBias=this.showWireframe?1:0}))),this.dirtyBounds||this.xrMode?.active){this.dirtyBounds=!1,this.calcSceneBounds(this.dynamicSceneBounds),this.debugBounds.clear(),this.showBounds&&(this.calcSceneBounds(TT,this.selectedNode),this.debugBounds.box(TT.getMin(),TT.getMax())),this.debugBounds.update();const e=new hi(2*this.dynamicSceneBounds.halfExtents.x,2*this.dynamicSceneBounds.halfExtents.y,2*this.dynamicSceneBounds.halfExtents.z);this.observer.set("scene.bounds",e.toString())}if(this.dirtyNormals){if(this.dirtyNormals=!1,this.debugNormals.clear(),this.normalLength>0)for(let e=0;e<this.meshInstances.length;++e){const t=this.meshInstances[e],i=t.morphInstance?t.morphInstance._vertexBuffer:t.mesh.vertexBuffer;if(i){const e=t.skinInstance?t.skinInstance.matrices:null;e&&t.skinInstance.updateMatrices(t.node),this.debugNormals.generateNormals(i,t.node.getWorldTransform(),this.normalLength,e)}}this.debugNormals.update()}if(this.dirtySkeleton&&(this.dirtySkeleton=!1,this.debugSkeleton.clear(),(this.showSkeleton||this.showAxes)&&this.entities.forEach((e=>{(0===this.meshInstances.length||e.findComponent("render"))&&this.debugSkeleton.generateSkeleton(e,this.showSkeleton,this.showAxes,this.selectedNode)})),this.debugSkeleton.update()),this.sceneBounds&&this.dirtyGrid){if(this.dirtyGrid=!1,this.debugGrid.clear(),this.showGrid){const e=Math.pow(10,Math.floor(Math.log10(this.sceneBounds.halfExtents.length()))),t=new hi(0,0,0),i=new hi(0,0,0),s=0,r=10,n=r*e;for(let a=-10;a<r+1;++a){const r=a*e;t.set(-n,s,r),i.set(n,s,r),this.debugGrid.line(t,i,0===r?2147483648:2164260863),t.set(r,s,-n),i.set(r,s,n),this.debugGrid.line(t,i,0===r?2147483648:2164260863)}}this.debugGrid.update()}this.fitCameraClipPlanes(),this.shadowCatcher.onUpdate(this.dynamicSceneBounds)}}onPostrender(){this.firstFrame&&(this.firstFrame=!1,this.initSceneBounds());const e=this.camera.camera.renderTarget;!this.app.graphicsDevice.isWebGPU&&e.samples>1&&e.resolve(),this.multiframeBusy=this.multiframe.update()}onFrameend(){null!==this.loadTimestamp&&(this.observer.set("scene.loadTime",Date.now()-this.loadTimestamp+"ms"),this.loadTimestamp=null),this.multiframeBusy&&(this.app.renderNextFrame=!0)}}class ET{constructor(e){if(e.graphicsDevice.isWebGPU)return void console.log("WebGPU is already created, skipping dummy WebGPU creation");if(!navigator.gpu)return void console.log("WebGPU is not supported, skipping dummy WebGPU creation");const t=document.createElement("canvas");t.width=20,t.height=20,t.style.position="absolute",t.style.top="20px",t.style.left="20px",document.body.appendChild(t),(async()=>{const i=await navigator.gpu.requestAdapter(),s=await i.requestDevice();console.log("Created WebGPU device used for profiling");const r=t.getContext("webgpu");r.configure({device:s,format:"bgra8unorm"}),e.on("frameend",(()=>{const e=r.getCurrentTexture().createView(),t=s.createCommandEncoder(),i={colorAttachments:[{view:e,clearValue:{r:1,g:0,b:0,a:1},loadOp:"clear",storeOp:"store"}]};t.beginRenderPass(i).end(),s.queue.submit([t.finish()])}))})()}}const AT=[{label:"Abandoned Tank Farm",url:"./skybox/abandoned_tank_farm_01_2k.hdr"},{label:"Adam's Place Bridge",url:"./skybox/adams_place_bridge_2k.hdr"},{label:"Artist Workshop",url:"./skybox/artist_workshop_2k.hdr"},{label:"Ballroom",url:"./skybox/ballroom_2k.hdr"},{label:"Circus Arena",url:"./skybox/circus_arena_2k.hdr"},{label:"Colorful Studio",url:"./skybox/colorful_studio.hdr"},{label:"Golf Course Sunrise",url:"./skybox/golf_course_sunrise_2k.hdr"},{label:"Helipad",url:"./skybox/Helipad_equi.png"},{label:"Kloppenheim",url:"./skybox/kloppenheim_02_2k.hdr"},{label:"Lebombo",url:"./skybox/lebombo_2k.hdr"},{label:"Outdoor Umbrellas",url:"./skybox/outdoor_umbrellas_2k.hdr"},{label:"Paul Lobe Haus",url:"./skybox/paul_lobe_haus_2k.hdr"},{label:"Reinforced Concrete",url:"./skybox/reinforced_concrete_01_2k.hdr"},{label:"Rural Asphalt Road",url:"./skybox/rural_asphalt_road_2k.hdr"},{label:"Spruit Sunrise",url:"./skybox/spruit_sunrise_2k.hdr"},{label:"Studio Small",url:"./skybox/studio_small_03_2k.hdr"},{label:"Venice Sunset",url:"./skybox/venice_sunset_1k.hdr"},{label:"Vignaioli Night",url:"./skybox/vignaioli_night_2k.hdr"},{label:"Wooden Motel",url:"./skybox/wooden_motel_2k.hdr"}],PT={ui:{fullscreen:!1,active:null,spinner:!1,error:null},camera:{fov:40,tonemapping:"Linear",pixelScale:1,multisampleSupported:!0,multisample:!0,hq:!0},skybox:{value:"Paul Lobe Haus",options:JSON.stringify(["None"].concat(AT.map((e=>e.label))).map((e=>({v:e,t:e})))),exposure:0,rotation:0,background:"Infinite Sphere",backgroundColor:{r:.4,g:.45,b:.5},blur:1,domeProjection:{domeRadius:20,tripodOffset:.1}},light:{enabled:!1,color:{r:1,g:1,b:1},intensity:1,follow:!1,shadow:!1},shadowCatcher:{enabled:!1,intensity:.4},debug:{renderMode:"default",stats:!1,wireframe:!1,wireframeColor:{r:0,g:0,b:0},bounds:!1,skeleton:!1,axes:!1,grid:!0,normals:0},animation:{playing:!1,speed:1,transition:.1,loops:1,list:"[]",progress:0,selectedTrack:"ALL_TRACKS"},scene:{urls:[],filenames:[],nodes:"[]",selectedNode:{path:"",name:null,position:{0:0,1:0,2:0},rotation:{0:0,1:0,2:0,3:0},scale:{0:0,1:0,2:0}},meshCount:null,materialCount:null,textureCount:null,vertexCount:null,primitiveCount:null,textureVRAM:null,meshVRAM:null,bounds:null,variant:{selected:0},variants:{list:"[]"},loadTime:null},runtime:{activeDeviceType:"",viewportWidth:0,viewportHeight:0,xrSupported:!1,xrActive:!1},morphs:null,enableWebGPU:!1,centerScene:!1};console.log(`Model Viewer v${dw} | PCUI v5.2.0 (f03db26) | PlayCanvas Engine v${Lt} (${Mt})`);(()=>{const e=new s(PT),t=new URL(window.location.href);CS(),Wb({glueUrl:"static/lib/basis/basis.wasm.js",wasmUrl:"static/lib/basis/basis.wasm.wasm",fallbackUrl:"static/lib/basis/basis.js",lazyInit:!0}),Xt.setConfig("DracoDecoderModule",{glueUrl:"static/lib/draco/draco.wasm.js",wasmUrl:"static/lib/draco/draco.wasm.wasm",fallbackUrl:"static/lib/draco/draco.js"});const i=new Map(AT.map((e=>[e.label,`static/${e.url}`])));e.on("ui.spinner:set",(e=>{const t=document.getElementById("spinner");e?t.classList.remove("pcui-hidden"):t.classList.add("pcui-hidden")})),t.searchParams.has("default")||(((e,t,i)=>{const s=["skybox.options","debug.renderMode"],r=(t,n)=>{-1===s.indexOf(t)&&("object"==typeof n?Object.keys(n).forEach((e=>{r(t?`${t}.${e}`:e,n[e])})):("skybox.value"!==t||"None"===n||i.has(n))&&e.set(t,n))},n=window.localStorage.getItem(`model-viewer-${t}`);if(n)try{r("",JSON.parse(n))}catch{}})(e,"uistate",i),e.on("*:set",(()=>{((e,t)=>{const i=e.json();window.localStorage.setItem(`model-viewer-${t}`,JSON.stringify({camera:i.camera,skybox:i.skybox,light:i.light,debug:i.debug,shadowCatcher:i.shadowCatcher,enableWebGPU:i.enableWebGPU}))})(e,"uistate")}))),(e=>{NS.render(u.createElement(Mw,{observer:e}),document.getElementById("app"))})(e);const r=document.getElementById("application-canvas"),n=e=>new URL(e,document.baseURI).toString();(function(e,t){var i;void 0===t&&(t={});var s,r=null!=(i=t.deviceTypes)?i:[];r.includes(Gs)||r.push(Gs),r.includes(js)||r.push(js),Ut.browser&&navigator.xr&&(null!=(s=t).xrCompatible||(s.xrCompatible=!0));for(var n=[],a=0;a<r.length;a++){var o,l,h=r[a];h===Ws&&(null==(l=window)||null==(o=l.navigator)?void 0:o.gpu)&&n.push((()=>new Za(e,t).initWebGpu(t.glslangUrl,t.twgslUrl))),h===Gs&&n.push((()=>new _o(e,t))),h===js&&n.push((()=>new To(e,t)))}return new Promise(((e,t)=>{var i=0,s=()=>{i>=n.length?t(new Error("Failed to create a graphics device")):Promise.resolve(n[i++]()).then((t=>{t?e(t):s()})).catch((e=>{console.log(e),s()}))};s()}))})(r,{deviceTypes:t.searchParams.has("webgpu")||e.get("enableWebGPU")?["webgpu"]:[],glslangUrl:n("static/lib/glslang/glslang.js"),twgslUrl:n("static/lib/twgsl/twgsl.js"),antialias:!1,depth:!1,stencil:!1,xrCompatible:!0,powerPreference:"high-performance"}).then((async s=>{e.set("runtime.activeDeviceType",s.deviceType);const n=new CT(r,s,e,i);window.viewer=n;const a=[],o=[];"launchQueue"in window&&window.launchQueue.setConsumer((e=>{for(const t of e.files)o.push(t.getFile().then((e=>{a.push({url:URL.createObjectURL(e),filename:e.name})})))}));for(const[i,s]of t.searchParams)switch(i){case"load":case"assetUrl":{const e=decodeURIComponent(s);a.push({url:e,filename:e});break}case"cameraPosition":{const e=s.split(",").map(Number);3===e.length&&(n.initialCameraPosition=new hi(e));break}case"cameraFocus":{const e=s.split(",").map(Number);3===e.length&&(n.initialCameraFocus=new hi(e));break}case"dummyWebGPU":new ET(n.app);break;default:if(e.has(i))switch(typeof e.get(i)){case"boolean":e.set(i,"true"===s.toLowerCase());break;case"number":e.set(i,Number(s));break;default:e.set(i,decodeURIComponent(s))}}window.loadPLYSequence=()=>async function(e,t){const i=[];t.set("ui.spinner",!0);const s=document.getElementById("load-controls");s&&(s.style.display="none");const r=document.getElementById("loader-progress");r&&(r.style.display="block");for(let e=0;e<100;e++){const t=`Frame${e.toString().padStart(6,"0")}.ply`,s=`./static/ply/001c/${t}`;try{r&&(r.innerText=`正在加载：${t} (${e+1}/100)`),console.log(`Loading file: ${s}`);const n=await fetch(s);if(!n.ok)throw new Error(`HTTP ${n.status}`);const a=await n.blob(),o=new File([a],t,{type:"application/octet-stream"});i.push({url:URL.createObjectURL(o),filename:t})}catch(e){console.warn(`[跳过] 无法加载 ${t}`,e)}}i.length>0&&(e.loadFiles(i),console.log("Files loaded from URL:",i)),r&&(r.innerText="加载完成",setTimeout((()=>{r.style.display="none"}),1e3)),t.set("ui.spinner",!1)}(n,e)}))})();
//# sourceMappingURL=index.js.map
